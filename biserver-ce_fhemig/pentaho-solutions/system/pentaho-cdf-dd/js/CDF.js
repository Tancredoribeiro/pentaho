;(function($,window,document,undefined){"use strict";if($.ui.fancytree&&$.ui.fancytree.version){$.ui.fancytree.warn("Fancytree: ignored duplicate include");return;}
function _raiseNotImplemented(msg){msg=msg||"";$.error("Not implemented: "+msg);}
function _assert(cond,msg){if(!cond){msg=msg?": "+msg:"";$.error("Assertion failed"+msg);}}
function consoleApply(method,args){var i,s,fn=window.console?window.console[method]:null;if(fn){if(fn.apply){fn.apply(window.console,args);}else{s="";for(i=0;i<args.length;i++){s+=args[i];}
fn(s);}}}
function _isNode(x){return!!(x.tree&&x.statusNodeType!==undefined);}
function isVersionAtLeast(dottedVersion,major,minor,patch){var i,v,t,verParts=$.map($.trim(dottedVersion).split("."),function(e){return parseInt(e,10);}),testParts=$.map(Array.prototype.slice.call(arguments,1),function(e){return parseInt(e,10);});for(i=0;i<testParts.length;i++){v=verParts[i]||0;t=testParts[i]||0;if(v!==t){return(v>t);}}
return true;}
function _makeVirtualFunction(methodName,tree,base,extension,extName){var proxy=(function(){var prevFunc=tree[methodName],baseFunc=extension[methodName],_local=tree.ext[extName],_super=function(){return prevFunc.apply(tree,arguments);};return function(){var prevLocal=tree._local,prevSuper=tree._super;try{tree._local=_local;tree._super=_super;return baseFunc.apply(tree,arguments);}finally{tree._local=prevLocal;tree._super=prevSuper;}};})();return proxy;}
function _subclassObject(tree,base,extension,extName){for(var attrName in extension){if(typeof extension[attrName]==="function"){if(typeof tree[attrName]==="function"){tree[attrName]=_makeVirtualFunction(attrName,tree,base,extension,extName);}else if(attrName.charAt(0)==="_"){tree.ext[extName][attrName]=_makeVirtualFunction(attrName,tree,base,extension,extName);}else{$.error("Could not override tree."+attrName+". Use prefix '_' to create tree."+extName+"._"+attrName);}}else{if(attrName!=="options"){tree.ext[extName][attrName]=extension[attrName];}}}}
function _getResolvedPromise(context,argArray){if(context===undefined){return $.Deferred(function(){this.resolve();}).promise();}else{return $.Deferred(function(){this.resolveWith(context,argArray);}).promise();}}
function _getRejectedPromise(context,argArray){if(context===undefined){return $.Deferred(function(){this.reject();}).promise();}else{return $.Deferred(function(){this.rejectWith(context,argArray);}).promise();}}
function _makeResolveFunc(deferred,context){return function(){deferred.resolveWith(context);};}
function _getElementDataAsDict($el){var d=$.extend({},$el.data()),json=d.json;delete d.fancytree;if(json){delete d.json;d=$.extend(d,json);}
return d;}
function _makeNodeTitleMatcher(s){s=s.toLowerCase();return function(node){return node.title.toLowerCase().indexOf(s)>=0;};}
var i,FT=null,ENTITY_MAP={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;"},CLASS_ATTRS="active expanded focus folder hideCheckbox lazy selected unselectable".split(" "),CLASS_ATTR_MAP={},NODE_ATTRS="expanded extraClasses folder hideCheckbox key lazy refKey selected title tooltip unselectable".split(" "),NODE_ATTR_MAP={},NONE_NODE_DATA_MAP={"active":true,"children":true,"data":true,"focus":true};for(i=0;i<CLASS_ATTRS.length;i++){CLASS_ATTR_MAP[CLASS_ATTRS[i]]=true;}
for(i=0;i<NODE_ATTRS.length;i++){NODE_ATTR_MAP[NODE_ATTRS[i]]=true;}
function FancytreeNode(parent,obj){var i,l,name,cl;this.parent=parent;this.tree=parent.tree;this.ul=null;this.li=null;this.statusNodeType=null;this._isLoading=false;this._error=null;this.data={};for(i=0,l=NODE_ATTRS.length;i<l;i++){name=NODE_ATTRS[i];this[name]=obj[name];}
if(obj.data){$.extend(this.data,obj.data);}
for(name in obj){if(!NODE_ATTR_MAP[name]&&!$.isFunction(obj[name])&&!NONE_NODE_DATA_MAP[name]){this.data[name]=obj[name];}}
if(this.key==null){if(this.tree.options.defaultKey){this.key=this.tree.options.defaultKey(this);_assert(this.key,"defaultKey() must return a unique key");}else{this.key="_"+(FT._nextNodeKey++);}}else{this.key=""+this.key;}
if(obj.active){_assert(this.tree.activeNode===null,"only one active node allowed");this.tree.activeNode=this;}
if(obj.selected){this.tree.lastSelectedNode=this;}
this.children=null;cl=obj.children;if(cl&&cl.length){this._setChildren(cl);}
this.tree._callHook("treeRegisterNode",this.tree,true,this);}
FancytreeNode.prototype={_findDirectChild:function(ptr){var i,l,cl=this.children;if(cl){if(typeof ptr==="string"){for(i=0,l=cl.length;i<l;i++){if(cl[i].key===ptr){return cl[i];}}}else if(typeof ptr==="number"){return this.children[ptr];}else if(ptr.parent===this){return ptr;}}
return null;},_setChildren:function(children){_assert(children&&(!this.children||this.children.length===0),"only init supported");this.children=[];for(var i=0,l=children.length;i<l;i++){this.children.push(new FancytreeNode(this,children[i]));}},addChildren:function(children,insertBefore){var i,l,pos,firstNode=null,nodeList=[];if($.isPlainObject(children)){children=[children];}
if(!this.children){this.children=[];}
for(i=0,l=children.length;i<l;i++){nodeList.push(new FancytreeNode(this,children[i]));}
firstNode=nodeList[0];if(insertBefore==null){this.children=this.children.concat(nodeList);}else{insertBefore=this._findDirectChild(insertBefore);pos=$.inArray(insertBefore,this.children);_assert(pos>=0,"insertBefore must be an existing child");this.children.splice.apply(this.children,[pos,0].concat(nodeList));}
if(!this.parent||this.parent.ul||this.tr){this.render();}
if(this.tree.options.selectMode===3){this.fixSelection3FromEndNodes();}
return firstNode;},addNode:function(node,mode){if(mode===undefined||mode==="over"){mode="child";}
switch(mode){case"after":return this.getParent().addChildren(node,this.getNextSibling());case"before":return this.getParent().addChildren(node,this);case"child":case"over":return this.addChildren(node);}
_assert(false,"Invalid mode: "+mode);},appendSibling:function(node){return this.addNode(node,"after");},applyPatch:function(patch){if(patch===null){this.remove();return _getResolvedPromise(this);}
var name,promise,v,IGNORE_MAP={children:true,expanded:true,parent:true};for(name in patch){v=patch[name];if(!IGNORE_MAP[name]&&!$.isFunction(v)){if(NODE_ATTR_MAP[name]){this[name]=v;}else{this.data[name]=v;}}}
if(patch.hasOwnProperty("children")){this.removeChildren();if(patch.children){this._setChildren(patch.children);}}
if(this.isVisible()){this.renderTitle();this.renderStatus();}
if(patch.hasOwnProperty("expanded")){promise=this.setExpanded(patch.expanded);}else{promise=_getResolvedPromise(this);}
return promise;},collapseSiblings:function(){return this.tree._callHook("nodeCollapseSiblings",this);},copyTo:function(node,mode,map){return node.addNode(this.toDict(true,map),mode);},countChildren:function(deep){var cl=this.children,i,l,n;if(!cl){return 0;}
n=cl.length;if(deep!==false){for(i=0,l=n;i<l;i++){n+=cl[i].countChildren();}}
return n;},debug:function(msg){if(this.tree.options.debugLevel>=2){Array.prototype.unshift.call(arguments,this.toString());consoleApply("debug",arguments);}},discard:function(){this.warn("FancytreeNode.discard() is deprecated since 2014-02-16. Use .resetLazy() instead.");return this.resetLazy();},findAll:function(match){match=$.isFunction(match)?match:_makeNodeTitleMatcher(match);var res=[];this.visit(function(n){if(match(n)){res.push(n);}});return res;},findFirst:function(match){match=$.isFunction(match)?match:_makeNodeTitleMatcher(match);var res=null;this.visit(function(n){if(match(n)){res=n;return false;}});return res;},_changeSelectStatusAttrs:function(state){var changed=false;switch(state){case false:changed=(this.selected||this.partsel);this.selected=false;this.partsel=false;break;case true:changed=(!this.selected||!this.partsel);this.selected=true;this.partsel=true;break;case undefined:changed=(this.selected||!this.partsel);this.selected=false;this.partsel=true;break;default:_assert(false,"invalid state: "+state);}
if(changed){this.renderStatus();}
return changed;},fixSelection3AfterClick:function(){var flag=this.isSelected();this.visit(function(node){node._changeSelectStatusAttrs(flag);});this.fixSelection3FromEndNodes();},fixSelection3FromEndNodes:function(){_assert(this.tree.options.selectMode===3,"expected selectMode 3");function _walk(node){var i,l,child,s,state,allSelected,someSelected,children=node.children;if(children&&children.length){allSelected=true;someSelected=false;for(i=0,l=children.length;i<l;i++){child=children[i];s=_walk(child);if(s!==false){someSelected=true;}
if(s!==true){allSelected=false;}}
state=allSelected?true:(someSelected?undefined:false);}else{state=!!node.selected;}
node._changeSelectStatusAttrs(state);return state;}
_walk(this);this.visitParents(function(node){var i,l,child,state,children=node.children,allSelected=true,someSelected=false;for(i=0,l=children.length;i<l;i++){child=children[i];if(child.selected||child.partsel){someSelected=true;}
if(!child.unselectable&&!child.selected){allSelected=false;}}
state=allSelected?true:(someSelected?undefined:false);node._changeSelectStatusAttrs(state);});},fromDict:function(dict){for(var name in dict){if(NODE_ATTR_MAP[name]){this[name]=dict[name];}else if(name==="data"){$.extend(this.data,dict.data);}else if(!$.isFunction(dict[name])&&!NONE_NODE_DATA_MAP[name]){this.data[name]=dict[name];}}
if(dict.children){this.removeChildren();this.addChildren(dict.children);}
this.renderTitle();},getChildren:function(){if(this.hasChildren()===undefined){return undefined;}
return this.children;},getFirstChild:function(){return this.children?this.children[0]:null;},getIndex:function(){return $.inArray(this,this.parent.children);},getIndexHier:function(separator){separator=separator||".";var res=[];$.each(this.getParentList(false,true),function(i,o){res.push(o.getIndex()+1);});return res.join(separator);},getKeyPath:function(excludeSelf){var path=[],sep=this.tree.options.keyPathSeparator;this.visitParents(function(n){if(n.parent){path.unshift(n.key);}},!excludeSelf);return sep+path.join(sep);},getLastChild:function(){return this.children?this.children[this.children.length-1]:null;},getLevel:function(){var level=0,dtn=this.parent;while(dtn){level++;dtn=dtn.parent;}
return level;},getNextSibling:function(){if(this.parent){var i,l,ac=this.parent.children;for(i=0,l=ac.length-1;i<l;i++){if(ac[i]===this){return ac[i+1];}}}
return null;},getParent:function(){return this.parent;},getParentList:function(includeRoot,includeSelf){var l=[],dtn=includeSelf?this:this.parent;while(dtn){if(includeRoot||dtn.parent){l.unshift(dtn);}
dtn=dtn.parent;}
return l;},getPrevSibling:function(){if(this.parent){var i,l,ac=this.parent.children;for(i=1,l=ac.length;i<l;i++){if(ac[i]===this){return ac[i-1];}}}
return null;},hasChildren:function(){if(this.lazy){if(this.children==null){return undefined;}else if(this.children.length===0){return false;}else if(this.children.length===1&&this.children[0].isStatusNode()){return undefined;}
return true;}
return!!this.children;},hasFocus:function(){return(this.tree.hasFocus()&&this.tree.focusNode===this);},info:function(msg){if(this.tree.options.debugLevel>=1){Array.prototype.unshift.call(arguments,this.toString());consoleApply("info",arguments);}},isActive:function(){return(this.tree.activeNode===this);},isChildOf:function(otherNode){return(this.parent&&this.parent===otherNode);},isDescendantOf:function(otherNode){if(!otherNode||otherNode.tree!==this.tree){return false;}
var p=this.parent;while(p){if(p===otherNode){return true;}
p=p.parent;}
return false;},isExpanded:function(){return!!this.expanded;},isFirstSibling:function(){var p=this.parent;return!p||p.children[0]===this;},isFolder:function(){return!!this.folder;},isLastSibling:function(){var p=this.parent;return!p||p.children[p.children.length-1]===this;},isLazy:function(){return!!this.lazy;},isLoaded:function(){return!this.lazy||this.hasChildren()!==undefined;},isLoading:function(){return!!this._isLoading;},isRoot:function(){return(this.tree.rootNode===this);},isSelected:function(){return!!this.selected;},isStatusNode:function(){return!!this.statusNodeType;},isUndefined:function(){return this.hasChildren()===undefined;},isVisible:function(){var i,l,parents=this.getParentList(false,false);for(i=0,l=parents.length;i<l;i++){if(!parents[i].expanded){return false;}}
return true;},lazyLoad:function(discard){this.warn("FancytreeNode.lazyLoad() is deprecated since 2014-02-16. Use .load() instead.");return this.load(discard);},load:function(forceReload){var res,source,that=this;_assert(this.isLazy(),"load() requires a lazy node");_assert(forceReload||this.isUndefined(),"Pass forceReload=true to re-load a lazy node");if(this.isLoaded()){this.resetLazy();}
source=this.tree._triggerNodeEvent("lazyLoad",this);if(source===false){return _getResolvedPromise(this);}
_assert(typeof source!=="boolean","lazyLoad event must return source in data.result");res=this.tree._callHook("nodeLoadChildren",this,source);if(this.expanded){res.always(function(){that.render();});}
return res;},makeVisible:function(opts){var i,that=this,deferreds=[],dfd=new $.Deferred(),parents=this.getParentList(false,false),len=parents.length,effects=!(opts&&opts.noAnimation===true),scroll=!(opts&&opts.scrollIntoView===false);for(i=len-1;i>=0;i--){deferreds.push(parents[i].setExpanded(true,opts));}
$.when.apply($,deferreds).done(function(){if(scroll){that.scrollIntoView(effects).done(function(){dfd.resolve();});}else{dfd.resolve();}});return dfd.promise();},moveTo:function(targetNode,mode,map){if(mode===undefined||mode==="over"){mode="child";}
var pos,prevParent=this.parent,targetParent=(mode==="child")?targetNode:targetNode.parent;if(this===targetNode){return;}else if(!this.parent){throw"Cannot move system root";}else if(targetParent.isDescendantOf(this)){throw"Cannot move a node to its own descendant";}
if(this.parent.children.length===1){if(this.parent===targetParent){return;}
this.parent.children=this.parent.lazy?[]:null;this.parent.expanded=false;}else{pos=$.inArray(this,this.parent.children);_assert(pos>=0);this.parent.children.splice(pos,1);}
this.parent=targetParent;if(targetParent.hasChildren()){switch(mode){case"child":targetParent.children.push(this);break;case"before":pos=$.inArray(targetNode,targetParent.children);_assert(pos>=0);targetParent.children.splice(pos,0,this);break;case"after":pos=$.inArray(targetNode,targetParent.children);_assert(pos>=0);targetParent.children.splice(pos+1,0,this);break;default:throw"Invalid mode "+mode;}}else{targetParent.children=[this];}
if(map){targetNode.visit(map,true);}
if(this.tree!==targetNode.tree){this.warn("Cross-tree moveTo is experimantal!");this.visit(function(n){n.tree=targetNode.tree;},true);}
if(!prevParent.isDescendantOf(targetParent)){prevParent.render();}
if(!targetParent.isDescendantOf(prevParent)&&targetParent!==prevParent){targetParent.render();}},navigate:function(where,activate){var i,parents,handled=true,KC=$.ui.keyCode,sib=null;function _goto(n){if(n){try{n.makeVisible();}catch(e){}
if(!$(n.span).is(":visible")){n.debug("Navigate: skipping hidden node");n.navigate(where,activate);return;}
return activate===false?n.setFocus():n.setActive();}}
switch(where){case KC.BACKSPACE:if(this.parent&&this.parent.parent){_goto(this.parent);}
break;case KC.LEFT:if(this.expanded){this.setExpanded(false);_goto(this);}else if(this.parent&&this.parent.parent){_goto(this.parent);}
break;case KC.RIGHT:if(!this.expanded&&(this.children||this.lazy)){this.setExpanded();_goto(this);}else if(this.children&&this.children.length){_goto(this.children[0]);}
break;case KC.UP:sib=this.getPrevSibling();while(sib&&sib.expanded&&sib.children&&sib.children.length){sib=sib.children[sib.children.length-1];}
if(!sib&&this.parent&&this.parent.parent){sib=this.parent;}
_goto(sib);break;case KC.DOWN:if(this.expanded&&this.children&&this.children.length){sib=this.children[0];}else{parents=this.getParentList(false,true);for(i=parents.length-1;i>=0;i--){sib=parents[i].getNextSibling();if(sib){break;}}}
_goto(sib);break;default:handled=false;}},remove:function(){return this.parent.removeChild(this);},removeChild:function(childNode){return this.tree._callHook("nodeRemoveChild",this,childNode);},removeChildren:function(){return this.tree._callHook("nodeRemoveChildren",this);},render:function(force,deep){return this.tree._callHook("nodeRender",this,force,deep);},renderTitle:function(){return this.tree._callHook("nodeRenderTitle",this);},renderStatus:function(){return this.tree._callHook("nodeRenderStatus",this);},resetLazy:function(){this.removeChildren();this.expanded=false;this.lazy=true;this.children=undefined;this.renderStatus();},scheduleAction:function(mode,ms){if(this.tree.timer){clearTimeout(this.tree.timer);}
this.tree.timer=null;var self=this;switch(mode){case"cancel":break;case"expand":this.tree.timer=setTimeout(function(){self.tree.debug("setTimeout: trigger expand");self.setExpanded(true);},ms);break;case"activate":this.tree.timer=setTimeout(function(){self.tree.debug("setTimeout: trigger activate");self.setActive(true);},ms);break;default:throw"Invalid mode "+mode;}},scrollIntoView:function(effects,options){if(options!==undefined&&_isNode(options)){this.warn("scrollIntoView() with 'topNode' option is deprecated since 2014-05-08. Use 'options.topNode' instead.");options={topNode:options};}
var topNodeY,nodeY,horzScrollbarHeight,containerOffsetTop,opts=$.extend({effects:(effects===true)?{duration:200,queue:false}:effects,scrollOfs:this.tree.options.scrollOfs,scrollParent:this.tree.options.scrollParent||this.tree.$container,topNode:null},options),dfd=new $.Deferred(),that=this,nodeHeight=$(this.span).height(),$container=$(opts.scrollParent),topOfs=opts.scrollOfs.top||0,bottomOfs=opts.scrollOfs.bottom||0,containerHeight=$container.height(),scrollTop=$container.scrollTop(),$animateTarget=$container,isParentWindow=$container[0]===window,topNode=opts.topNode||null,newScrollTop=null;_assert($(this.span).is(":visible"),"scrollIntoView node is invisible");if(isParentWindow){nodeY=$(this.span).offset().top;topNodeY=topNode?$(topNode.span).offset().top:0;$animateTarget=$("html,body");}else{_assert($container[0]!==document&&$container[0]!==document.body,"scrollParent should be an simple element or `window`, not document or body.");containerOffsetTop=$container.offset().top,nodeY=$(this.span).offset().top-containerOffsetTop+scrollTop;topNodeY=topNode?$(topNode.span).offset().top-containerOffsetTop+scrollTop:0;horzScrollbarHeight=Math.max(0,($container.innerHeight()-$container[0].clientHeight));containerHeight-=horzScrollbarHeight;}
if(nodeY<(scrollTop+topOfs)){newScrollTop=nodeY-topOfs;}else if((nodeY+nodeHeight)>(scrollTop+containerHeight-bottomOfs)){newScrollTop=nodeY+nodeHeight-containerHeight+bottomOfs;if(topNode){_assert($(topNode.span).is(":visible"));if(topNodeY<newScrollTop){newScrollTop=topNodeY-topOfs;}}}
if(newScrollTop!==null){if(opts.effects){opts.effects.complete=function(){dfd.resolveWith(that);};$animateTarget.stop(true).animate({scrollTop:newScrollTop},opts.effects);}else{$animateTarget[0].scrollTop=newScrollTop;dfd.resolveWith(this);}}else{dfd.resolveWith(this);}
return dfd.promise();},setActive:function(flag,opts){return this.tree._callHook("nodeSetActive",this,flag,opts);},setExpanded:function(flag,opts){return this.tree._callHook("nodeSetExpanded",this,flag,opts);},setFocus:function(flag){return this.tree._callHook("nodeSetFocus",this,flag);},setSelected:function(flag){return this.tree._callHook("nodeSetSelected",this,flag);},setStatus:function(status,message,details){return this.tree._callHook("nodeSetStatus",this,status,message,details);},setTitle:function(title){this.title=title;this.renderTitle();},sortChildren:function(cmp,deep){var i,l,cl=this.children;if(!cl){return;}
cmp=cmp||function(a,b){var x=a.title.toLowerCase(),y=b.title.toLowerCase();return x===y?0:x>y?1:-1;};cl.sort(cmp);if(deep){for(i=0,l=cl.length;i<l;i++){if(cl[i].children){cl[i].sortChildren(cmp,"$norender$");}}}
if(deep!=="$norender$"){this.render();}},toDict:function(recursive,callback){var i,l,node,dict={},self=this;$.each(NODE_ATTRS,function(i,a){if(self[a]||self[a]===false){dict[a]=self[a];}});if(!$.isEmptyObject(this.data)){dict.data=$.extend({},this.data);if($.isEmptyObject(dict.data)){delete dict.data;}}
if(callback){callback(dict);}
if(recursive){if(this.hasChildren()){dict.children=[];for(i=0,l=this.children.length;i<l;i++){node=this.children[i];if(!node.isStatusNode()){dict.children.push(node.toDict(true,callback));}}}else{}}
return dict;},toggleExpanded:function(){return this.tree._callHook("nodeToggleExpanded",this);},toggleSelected:function(){return this.tree._callHook("nodeToggleSelected",this);},toString:function(){return"<FancytreeNode(#"+this.key+", '"+this.title+"')>";},visit:function(fn,includeSelf){var i,l,res=true,children=this.children;if(includeSelf===true){res=fn(this);if(res===false||res==="skip"){return res;}}
if(children){for(i=0,l=children.length;i<l;i++){res=children[i].visit(fn,true);if(res===false){break;}}}
return res;},visitParents:function(fn,includeSelf){if(includeSelf&&fn(this)===false){return false;}
var p=this.parent;while(p){if(fn(p)===false){return false;}
p=p.parent;}
return true;},warn:function(msg){Array.prototype.unshift.call(arguments,this.toString());consoleApply("warn",arguments);}};function Fancytree(widget){this.widget=widget;this.$div=widget.element;this.options=widget.options;if(this.options&&$.isFunction(this.options.lazyload)){if(!$.isFunction(this.options.lazyLoad)){this.options.lazyLoad=function(){FT.warn("The 'lazyload' event is deprecated since 2014-02-25. Use 'lazyLoad' (with uppercase L) instead.");widget.options.lazyload.apply(this,arguments);};}}
if(this.options&&$.isFunction(this.options.loaderror)){$.error("The 'loaderror' event was renamed since 2014-07-03. Use 'loadError' (with uppercase E) instead.");}
this.ext={};this.data=_getElementDataAsDict(this.$div);this._id=$.ui.fancytree._nextId++;this._ns=".fancytree-"+this._id;this.activeNode=null;this.focusNode=null;this._hasFocus=null;this.lastSelectedNode=null;this.systemFocusElement=null;this.statusClassPropName="span";this.ariaPropName="li";this.nodeContainerAttrName="li";this.$div.find(">ul.fancytree-container").remove();var fakeParent={tree:this},$ul;this.rootNode=new FancytreeNode(fakeParent,{title:"root",key:"root_"+this._id,children:null,expanded:true});this.rootNode.parent=null;$ul=$("<ul>",{"class":"ui-fancytree fancytree-container"}).appendTo(this.$div);this.$container=$ul;this.rootNode.ul=$ul[0];if(this.options.debugLevel==null){this.options.debugLevel=FT.debugLevel;}
this.$container.attr("tabindex",this.options.tabbable?"0":"-1");if(this.options.aria){this.$container.attr("role","tree").attr("aria-multiselectable",true);}}
Fancytree.prototype={_makeHookContext:function(obj,originalEvent,extra){var ctx,tree;if(obj.node!==undefined){if(originalEvent&&obj.originalEvent!==originalEvent){$.error("invalid args");}
ctx=obj;}else if(obj.tree){tree=obj.tree;ctx={node:obj,tree:tree,widget:tree.widget,options:tree.widget.options,originalEvent:originalEvent};}else if(obj.widget){ctx={node:null,tree:obj,widget:obj.widget,options:obj.widget.options,originalEvent:originalEvent};}else{$.error("invalid args");}
if(extra){$.extend(ctx,extra);}
return ctx;},_callHook:function(funcName,contextObject,_extraArgs){var ctx=this._makeHookContext(contextObject),fn=this[funcName],args=Array.prototype.slice.call(arguments,2);if(!$.isFunction(fn)){$.error("_callHook('"+funcName+"') is not a function");}
args.unshift(ctx);return fn.apply(this,args);},_requireExtension:function(name,required,before,message){before=!!before;var thisName=this._local.name,extList=this.options.extensions,isBefore=$.inArray(name,extList)<$.inArray(thisName,extList),isMissing=required&&this.ext[name]==null,badOrder=!isMissing&&before!=null&&(before!==isBefore);_assert(thisName&&thisName!==name);if(isMissing||badOrder){if(!message){if(isMissing||required){message="'"+thisName+"' extension requires '"+name+"'";if(badOrder){message+=" to be registered "+(before?"before":"after")+" itself";}}else{message="If used together, `"+name+"` must be registered "+(before?"before":"after")+" `"+thisName+"`";}}
$.error(message);return false;}
return true;},activateKey:function(key){var node=this.getNodeByKey(key);if(node){node.setActive();}else if(this.activeNode){this.activeNode.setActive(false);}
return node;},applyPatch:function(patchList){var dfd,i,p2,key,patch,node,patchCount=patchList.length,deferredList=[];for(i=0;i<patchCount;i++){p2=patchList[i];_assert(p2.length===2,"patchList must be an array of length-2-arrays");key=p2[0];patch=p2[1];node=(key===null)?this.rootNode:this.getNodeByKey(key);if(node){dfd=new $.Deferred();deferredList.push(dfd);node.applyPatch(patch).always(_makeResolveFunc(dfd,node));}else{this.warn("could not find node with key '"+key+"'");}}
return $.when.apply($,deferredList).promise();},count:function(){return this.rootNode.countChildren();},debug:function(msg){if(this.options.debugLevel>=2){Array.prototype.unshift.call(arguments,this.toString());consoleApply("debug",arguments);}},generateFormElements:function(selected,active){var nodeList,selectedName=(selected!==false)?"ft_"+this._id+"[]":selected,activeName=(active!==false)?"ft_"+this._id+"_active":active,id="fancytree_result_"+this._id,$result=$("#"+id);if($result.length){$result.empty();}else{$result=$("<div>",{id:id}).hide().insertAfter(this.$container);}
if(selectedName){nodeList=this.getSelectedNodes(this.options.selectMode===3);$.each(nodeList,function(idx,node){$result.append($("<input>",{type:"checkbox",name:selectedName,value:node.key,checked:true}));});}
if(activeName&&this.activeNode){$result.append($("<input>",{type:"radio",name:activeName,value:this.activeNode.key,checked:true}));}},getActiveNode:function(){return this.activeNode;},getFirstChild:function(){return this.rootNode.getFirstChild();},getFocusNode:function(ifTreeHasFocus){return this.focusNode;},getNodeByKey:function(key,searchRoot){var el,match;if(!searchRoot){el=document.getElementById(this.options.idPrefix+key);if(el){return el.ftnode?el.ftnode:null;}}
searchRoot=searchRoot||this.rootNode;match=null;searchRoot.visit(function(node){if(node.key===key){match=node;return false;}},true);return match;},getRootNode:function(){return this.rootNode;},getSelectedNodes:function(stopOnParents){var nodeList=[];this.rootNode.visit(function(node){if(node.selected){nodeList.push(node);if(stopOnParents===true){return"skip";}}});return nodeList;},hasFocus:function(){return!!this._hasFocus;},info:function(msg){if(this.options.debugLevel>=1){Array.prototype.unshift.call(arguments,this.toString());consoleApply("info",arguments);}},loadKeyPath:function(keyPathList,callback,_rootNode){var deferredList,dfd,i,path,key,loadMap,node,segList,root=_rootNode||this.rootNode,sep=this.options.keyPathSeparator,self=this;if(!$.isArray(keyPathList)){keyPathList=[keyPathList];}
loadMap={};for(i=0;i<keyPathList.length;i++){path=keyPathList[i];if(path.charAt(0)===sep){path=path.substr(1);}
segList=path.split(sep);while(segList.length){key=segList.shift();node=root._findDirectChild(key);if(!node){this.warn("loadKeyPath: key not found: "+key+" (parent: "+root+")");callback.call(this,key,"error");break;}else if(segList.length===0){callback.call(this,node,"ok");break;}else if(!node.lazy||(node.hasChildren()!==undefined)){callback.call(this,node,"loaded");root=node;}else{callback.call(this,node,"loaded");if(loadMap[key]){loadMap[key].push(segList.join(sep));}else{loadMap[key]=[segList.join(sep)];}
break;}}}
deferredList=[];function __lazyload(key,node,dfd){callback.call(self,node,"loading");node.load().done(function(){self.loadKeyPath.call(self,loadMap[key],callback,node).always(_makeResolveFunc(dfd,self));}).fail(function(errMsg){self.warn("loadKeyPath: error loading: "+key+" (parent: "+root+")");callback.call(self,node,"error");dfd.reject();});}
for(key in loadMap){node=root._findDirectChild(key);dfd=new $.Deferred();deferredList.push(dfd);__lazyload(key,node,dfd);}
return $.when.apply($,deferredList).promise();},reactivate:function(setFocus){var node=this.activeNode;if(node){this.activeNode=null;node.setActive();if(setFocus){node.setFocus();}}},reload:function(source){this._callHook("treeClear",this);return this._callHook("treeLoad",this,source);},render:function(force,deep){return this.rootNode.render(force,deep);},setFocus:function(flag){return this._callHook("treeSetFocus",this,flag);},toDict:function(includeRoot,callback){var res=this.rootNode.toDict(true,callback);return includeRoot?res:res.children;},toString:function(){return"<Fancytree(#"+this._id+")>";},_triggerNodeEvent:function(type,node,originalEvent,extra){var ctx=this._makeHookContext(node,originalEvent,extra),res=this.widget._trigger(type,originalEvent,ctx);if(res!==false&&ctx.result!==undefined){return ctx.result;}
return res;},_triggerTreeEvent:function(type,originalEvent){var ctx=this._makeHookContext(this,originalEvent),res=this.widget._trigger(type,originalEvent,ctx);if(res!==false&&ctx.result!==undefined){return ctx.result;}
return res;},visit:function(fn){return this.rootNode.visit(fn,false);},warn:function(msg){Array.prototype.unshift.call(arguments,this.toString());consoleApply("warn",arguments);}};$.extend(Fancytree.prototype,{nodeClick:function(ctx){var activate,expand,event=ctx.originalEvent,targetType=ctx.targetType,node=ctx.node;if(targetType==="expander"){this._callHook("nodeToggleExpanded",ctx);}else if(targetType==="checkbox"){this._callHook("nodeToggleSelected",ctx);this._callHook("nodeSetFocus",ctx,true);}else{expand=false;activate=true;if(node.folder){switch(ctx.options.clickFolderMode){case 2:expand=true;activate=false;break;case 3:activate=true;expand=true;break;}}
if(activate){this.nodeSetFocus(ctx);this._callHook("nodeSetActive",ctx,true);}
if(expand){if(!activate){}
this._callHook("nodeToggleExpanded",ctx);}}
if(event.target.localName==="a"&&event.target.className==="fancytree-title"){event.preventDefault();}},nodeCollapseSiblings:function(ctx,callOpts){var ac,i,l,node=ctx.node;if(node.parent){ac=node.parent.children;for(i=0,l=ac.length;i<l;i++){if(ac[i]!==node&&ac[i].expanded){this._callHook("nodeSetExpanded",ac[i],false,callOpts);}}}},nodeDblclick:function(ctx){if(ctx.targetType==="title"&&ctx.options.clickFolderMode===4){this._callHook("nodeToggleExpanded",ctx);}
if(ctx.targetType==="title"){ctx.originalEvent.preventDefault();}},nodeKeydown:function(ctx){var res,event=ctx.originalEvent,node=ctx.node,tree=ctx.tree,opts=ctx.options,handled=true,activate=!(event.ctrlKey||!opts.autoActivate),KC=$.ui.keyCode;if(!node){this.rootNode.getFirstChild().setFocus();node=ctx.node=this.focusNode;node.debug("Keydown force focus on first node");}
switch(event.which){case KC.NUMPAD_ADD:case 187:tree.nodeSetExpanded(ctx,true);break;case KC.NUMPAD_SUBTRACT:case 189:tree.nodeSetExpanded(ctx,false);break;case KC.SPACE:if(opts.checkbox){tree.nodeToggleSelected(ctx);}else{tree.nodeSetActive(ctx,true);}
break;case KC.ENTER:tree.nodeSetActive(ctx,true);break;case KC.BACKSPACE:case KC.LEFT:case KC.RIGHT:case KC.UP:case KC.DOWN:res=node.navigate(event.which,activate);break;default:handled=false;}
if(handled){event.preventDefault();}},nodeLoadChildren:function(ctx,source){var ajax,delay,dfd,tree=ctx.tree,node=ctx.node;if($.isFunction(source)){source=source();}
if(source.url){ajax=$.extend({},ctx.options.ajax,source);if(ajax.debugDelay){delay=ajax.debugDelay;if($.isArray(delay)){delay=delay[0]+Math.random()*(delay[1]-delay[0]);}
node.debug("nodeLoadChildren waiting debug delay "+Math.round(delay)+"ms");ajax.debugDelay=false;dfd=$.Deferred(function(dfd){setTimeout(function(){$.ajax(ajax).done(function(){dfd.resolveWith(this,arguments);}).fail(function(){dfd.rejectWith(this,arguments);});},delay);});}else{dfd=$.ajax(ajax);}
source=new $.Deferred();dfd.done(function(data,textStatus,jqXHR){var errorObj,res;if(typeof data==="string"){$.error("Ajax request returned a string (did you get the JSON dataType wrong?).");}
if(ctx.options.postProcess){res=tree._triggerNodeEvent("postProcess",ctx,ctx.originalEvent,{response:data,error:null,dataType:this.dataType});if(res.error){errorObj=$.isPlainObject(res.error)?res.error:{message:res.error};errorObj=tree._makeHookContext(node,null,errorObj);source.rejectWith(this,[errorObj]);return;}
data=$.isArray(res)?res:data;}else if(data&&data.hasOwnProperty("d")&&ctx.options.enableAspx){data=(typeof data.d==="string")?$.parseJSON(data.d):data.d;}
source.resolveWith(this,[data]);}).fail(function(jqXHR,textStatus,errorThrown){var errorObj=tree._makeHookContext(node,null,{error:jqXHR,args:Array.prototype.slice.call(arguments),message:errorThrown,details:jqXHR.status+": "+errorThrown});source.rejectWith(this,[errorObj]);});}
if($.isFunction(source.promise)){_assert(!node.isLoading());tree.nodeSetStatus(ctx,"loading");source.done(function(children){tree.nodeSetStatus(ctx,"ok");}).fail(function(error){var ctxErr;if(error.node&&error.error&&error.message){ctxErr=error;}else{ctxErr=tree._makeHookContext(node,null,{error:error,args:Array.prototype.slice.call(arguments),message:error?(error.message||error.toString()):""});}
if(tree._triggerNodeEvent("loadError",ctxErr,null)!==false){tree.nodeSetStatus(ctx,"error",ctxErr.message,ctxErr.details);}});}
return $.when(source).done(function(children){var metaData;if($.isPlainObject(children)){_assert($.isArray(children.children),"source must contain (or be) an array of children");_assert(node.isRoot(),"source may only be an object for root nodes");metaData=children;children=children.children;delete metaData.children;$.extend(tree.data,metaData);}
_assert($.isArray(children),"expected array of children");node._setChildren(children);tree._triggerNodeEvent("loadChildren",node);});},nodeLoadKeyPath:function(ctx,keyPathList){},nodeRemoveChild:function(ctx,childNode){var idx,node=ctx.node,opts=ctx.options,subCtx=$.extend({},ctx,{node:childNode}),children=node.children;if(children.length===1){_assert(childNode===children[0]);return this.nodeRemoveChildren(ctx);}
if(this.activeNode&&(childNode===this.activeNode||this.activeNode.isDescendantOf(childNode))){this.activeNode.setActive(false);}
if(this.focusNode&&(childNode===this.focusNode||this.focusNode.isDescendantOf(childNode))){this.focusNode=null;}
this.nodeRemoveMarkup(subCtx);this.nodeRemoveChildren(subCtx);idx=$.inArray(childNode,children);_assert(idx>=0);childNode.visit(function(n){n.parent=null;},true);this._callHook("treeRegisterNode",this,false,childNode);if(opts.removeNode){opts.removeNode.call(ctx.tree,{type:"removeNode"},subCtx);}
children.splice(idx,1);},nodeRemoveChildMarkup:function(ctx){var node=ctx.node;if(node.ul){if(node.isRoot()){$(node.ul).empty();}else{$(node.ul).remove();node.ul=null;}
node.visit(function(n){n.li=n.ul=null;});}},nodeRemoveChildren:function(ctx){var subCtx,tree=ctx.tree,node=ctx.node,children=node.children,opts=ctx.options;if(!children){return;}
if(this.activeNode&&this.activeNode.isDescendantOf(node)){this.activeNode.setActive(false);}
if(this.focusNode&&this.focusNode.isDescendantOf(node)){this.focusNode=null;}
this.nodeRemoveChildMarkup(ctx);subCtx=$.extend({},ctx);node.visit(function(n){n.parent=null;tree._callHook("treeRegisterNode",tree,false,n);if(opts.removeNode){subCtx.node=n;opts.removeNode.call(ctx.tree,{type:"removeNode"},subCtx);}});if(node.lazy){node.children=[];}else{node.children=null;}
this.nodeRenderStatus(ctx);},nodeRemoveMarkup:function(ctx){var node=ctx.node;if(node.li){$(node.li).remove();node.li=null;}
this.nodeRemoveChildMarkup(ctx);},nodeRender:function(ctx,force,deep,collapsed,_recursive){var childLI,childNode1,childNode2,i,l,next,subCtx,node=ctx.node,tree=ctx.tree,opts=ctx.options,aria=opts.aria,firstTime=false,parent=node.parent,isRootNode=!parent,children=node.children;if(!isRootNode&&!parent.ul){return;}
_assert(isRootNode||parent.ul,"parent UL must exist");if(!isRootNode){if(node.li&&(force||(node.li.parentNode!==node.parent.ul))){if(node.li.parentNode!==node.parent.ul){this.warn("unlink "+node+" (must be child of "+node.parent+")");}
this.nodeRemoveMarkup(ctx);}
if(!node.li){firstTime=true;node.li=document.createElement("li");node.li.ftnode=node;if(aria){}
if(node.key&&opts.generateIds){node.li.id=opts.idPrefix+node.key;}
node.span=document.createElement("span");node.span.className="fancytree-node";if(aria){$(node.span).attr("aria-labelledby","ftal_"+node.key);}
node.li.appendChild(node.span);this.nodeRenderTitle(ctx);if(opts.createNode){opts.createNode.call(tree,{type:"createNode"},ctx);}}else{this.nodeRenderStatus(ctx);}
if(opts.renderNode){opts.renderNode.call(tree,{type:"renderNode"},ctx);}}
if(children){if(isRootNode||node.expanded||deep===true){if(!node.ul){node.ul=document.createElement("ul");if((collapsed===true&&!_recursive)||!node.expanded){node.ul.style.display="none";}
if(aria){$(node.ul).attr("role","group");}
if(node.li){node.li.appendChild(node.ul);}else{node.tree.$div.append(node.ul);}}
for(i=0,l=children.length;i<l;i++){subCtx=$.extend({},ctx,{node:children[i]});this.nodeRender(subCtx,force,deep,false,true);}
childLI=node.ul.firstChild;while(childLI){childNode2=childLI.ftnode;if(childNode2&&childNode2.parent!==node){node.debug("_fixParent: remove missing "+childNode2,childLI);next=childLI.nextSibling;childLI.parentNode.removeChild(childLI);childLI=next;}else{childLI=childLI.nextSibling;}}
childLI=node.ul.firstChild;for(i=0,l=children.length-1;i<l;i++){childNode1=children[i];childNode2=childLI.ftnode;if(childNode1!==childNode2){node.ul.insertBefore(childNode1.li,childNode2.li);}else{childLI=childLI.nextSibling;}}}}else{if(node.ul){this.warn("remove child markup for "+node);this.nodeRemoveChildMarkup(ctx);}}
if(!isRootNode){if(firstTime){parent.ul.appendChild(node.li);}}},nodeRenderTitle:function(ctx,title){var id,imageSrc,nodeTitle,role,tabindex,tooltip,node=ctx.node,tree=ctx.tree,opts=ctx.options,aria=opts.aria,level=node.getLevel(),ares=[],icon=node.data.icon;if(title!==undefined){node.title=title;}
if(!node.span){return;}
if(level<opts.minExpandLevel){if(level>1){if(aria){ares.push("<span role='button' class='fancytree-expander'></span>");}else{ares.push("<span class='fancytree-expander'></span>");}}}else{if(aria){ares.push("<span role='button' class='fancytree-expander'></span>");}else{ares.push("<span class='fancytree-expander'></span>");}}
if(opts.checkbox&&node.hideCheckbox!==true&&!node.isStatusNode()){if(aria){ares.push("<span role='checkbox' class='fancytree-checkbox'></span>");}else{ares.push("<span class='fancytree-checkbox'></span>");}}
role=aria?" role='img'":"";if(icon&&typeof icon==="string"){imageSrc=(icon.charAt(0)==="/")?icon:((opts.imagePath||"")+icon);ares.push("<img src='"+imageSrc+"' class='fancytree-icon' alt='' />");}else if(node.data.iconclass){ares.push("<span "+role+" class='fancytree-custom-icon"+" "+node.data.iconclass+"'></span>");}else if(icon===true||(icon!==false&&opts.icons!==false)){ares.push("<span "+role+" class='fancytree-icon'></span>");}
nodeTitle="";if(opts.renderTitle){nodeTitle=opts.renderTitle.call(tree,{type:"renderTitle"},ctx)||"";}
if(!nodeTitle){tooltip=node.tooltip?" title='"+FT.escapeHtml(node.tooltip)+"'":"";id=aria?" id='ftal_"+node.key+"'":"";role=aria?" role='treeitem'":"";tabindex=opts.titlesTabbable?" tabindex='0'":"";nodeTitle="<span "+role+" class='fancytree-title'"+id+tooltip+tabindex+">"+node.title+"</span>";}
ares.push(nodeTitle);node.span.innerHTML=ares.join("");this.nodeRenderStatus(ctx);},nodeRenderStatus:function(ctx){var node=ctx.node,tree=ctx.tree,opts=ctx.options,hasChildren=node.hasChildren(),isLastSib=node.isLastSibling(),aria=opts.aria,$ariaElem=$(node.span).find(".fancytree-title"),cn=opts._classNames,cnList=[],statusElem=node[tree.statusClassPropName];if(!statusElem){return;}
cnList.push(cn.node);if(tree.activeNode===node){cnList.push(cn.active);}
if(tree.focusNode===node){cnList.push(cn.focused);if(aria){$ariaElem.attr("aria-activedescendant",true);}}else if(aria){$ariaElem.removeAttr("aria-activedescendant");}
if(node.expanded){cnList.push(cn.expanded);if(aria){$ariaElem.attr("aria-expanded",true);}}else if(aria){$ariaElem.removeAttr("aria-expanded");}
if(node.folder){cnList.push(cn.folder);}
if(hasChildren!==false){cnList.push(cn.hasChildren);}
if(isLastSib){cnList.push(cn.lastsib);}
if(node.lazy&&node.children==null){cnList.push(cn.lazy);}
if(node.partsel){cnList.push(cn.partsel);}
if(node._isLoading){cnList.push(cn.loading);}
if(node._error){cnList.push(cn.error);}
if(node.selected){cnList.push(cn.selected);if(aria){$ariaElem.attr("aria-selected",true);}}else if(aria){$ariaElem.attr("aria-selected",false);}
if(node.extraClasses){cnList.push(node.extraClasses);}
if(hasChildren===false){cnList.push(cn.combinedExpanderPrefix+"n"+
(isLastSib?"l":""));}else{cnList.push(cn.combinedExpanderPrefix+
(node.expanded?"e":"c")+
(node.lazy&&node.children==null?"d":"")+
(isLastSib?"l":""));}
cnList.push(cn.combinedIconPrefix+
(node.expanded?"e":"c")+
(node.folder?"f":""));statusElem.className=cnList.join(" ");if(node.li){node.li.className=isLastSib?cn.lastsib:"";}},nodeSetActive:function(ctx,flag,callOpts){callOpts=callOpts||{};var subCtx,node=ctx.node,tree=ctx.tree,opts=ctx.options,noEvents=(callOpts.noEvents===true),isActive=(node===tree.activeNode);flag=(flag!==false);if(isActive===flag){return _getResolvedPromise(node);}else if(flag&&!noEvents&&this._triggerNodeEvent("beforeActivate",node,ctx.originalEvent)===false){return _getRejectedPromise(node,["rejected"]);}
if(flag){if(tree.activeNode){_assert(tree.activeNode!==node,"node was active (inconsistency)");subCtx=$.extend({},ctx,{node:tree.activeNode});tree.nodeSetActive(subCtx,false);_assert(tree.activeNode===null,"deactivate was out of sync?");}
if(opts.activeVisible){node.makeVisible({scrollIntoView:false});}
tree.activeNode=node;tree.nodeRenderStatus(ctx);tree.nodeSetFocus(ctx);if(!noEvents){tree._triggerNodeEvent("activate",node,ctx.originalEvent);}}else{_assert(tree.activeNode===node,"node was not active (inconsistency)");tree.activeNode=null;this.nodeRenderStatus(ctx);if(!noEvents){ctx.tree._triggerNodeEvent("deactivate",node,ctx.originalEvent);}}},nodeSetExpanded:function(ctx,flag,callOpts){callOpts=callOpts||{};var _afterLoad,dfd,i,l,parents,prevAC,node=ctx.node,tree=ctx.tree,opts=ctx.options,noAnimation=(callOpts.noAnimation===true),noEvents=(callOpts.noEvents===true);flag=(flag!==false);if((node.expanded&&flag)||(!node.expanded&&!flag)){return _getResolvedPromise(node);}else if(flag&&!node.lazy&&!node.hasChildren()){return _getResolvedPromise(node);}else if(!flag&&node.getLevel()<opts.minExpandLevel){return _getRejectedPromise(node,["locked"]);}else if(!noEvents&&this._triggerNodeEvent("beforeExpand",node,ctx.originalEvent)===false){return _getRejectedPromise(node,["rejected"]);}
if(!noAnimation&&!node.isVisible()){noAnimation=callOpts.noAnimation=true;}
dfd=new $.Deferred();if(flag&&!node.expanded&&opts.autoCollapse){parents=node.getParentList(false,true);prevAC=opts.autoCollapse;try{opts.autoCollapse=false;for(i=0,l=parents.length;i<l;i++){this._callHook("nodeCollapseSiblings",parents[i],callOpts);}}finally{opts.autoCollapse=prevAC;}}
dfd.done(function(){if(flag&&opts.autoScroll&&!noAnimation){node.getLastChild().scrollIntoView(true,{topNode:node}).always(function(){if(!noEvents){ctx.tree._triggerNodeEvent(flag?"expand":"collapse",ctx);}});}else{if(!noEvents){ctx.tree._triggerNodeEvent(flag?"expand":"collapse",ctx);}}});_afterLoad=function(callback){var duration,easing,isVisible,isExpanded;node.expanded=flag;tree._callHook("nodeRender",ctx,false,false,true);if(node.ul){isVisible=(node.ul.style.display!=="none");isExpanded=!!node.expanded;if(isVisible===isExpanded){node.warn("nodeSetExpanded: UL.style.display already set");}else if(!opts.fx||noAnimation){node.ul.style.display=(node.expanded||!parent)?"":"none";}else{duration=opts.fx.duration||200;easing=opts.fx.easing;$(node.ul).animate(opts.fx,duration,easing,function(){callback();});return;}}
callback();};if(flag&&node.lazy&&node.hasChildren()===undefined){node.load().done(function(){if(dfd.notifyWith){dfd.notifyWith(node,["loaded"]);}
_afterLoad(function(){dfd.resolveWith(node);});}).fail(function(errMsg){_afterLoad(function(){dfd.rejectWith(node,["load failed ("+errMsg+")"]);});});}else{_afterLoad(function(){dfd.resolveWith(node);});}
return dfd.promise();},nodeSetFocus:function(ctx,flag){var ctx2,tree=ctx.tree,node=ctx.node;flag=(flag!==false);if(tree.focusNode){if(tree.focusNode===node&&flag){return;}
ctx2=$.extend({},ctx,{node:tree.focusNode});tree.focusNode=null;this._triggerNodeEvent("blur",ctx2);this._callHook("nodeRenderStatus",ctx2);}
if(flag){if(!this.hasFocus()){node.debug("nodeSetFocus: forcing container focus");this._callHook("treeSetFocus",ctx,true,true);}
node.makeVisible({scrollIntoView:false});tree.focusNode=node;this._triggerNodeEvent("focus",ctx);if(ctx.options.autoScroll){node.scrollIntoView();}
this._callHook("nodeRenderStatus",ctx);}},nodeSetSelected:function(ctx,flag){var node=ctx.node,tree=ctx.tree,opts=ctx.options;flag=(flag!==false);node.debug("nodeSetSelected("+flag+")",ctx);if(node.unselectable){return;}
if((node.selected&&flag)||(!node.selected&&!flag)){return!!node.selected;}else if(this._triggerNodeEvent("beforeSelect",node,ctx.originalEvent)===false){return!!node.selected;}
if(flag&&opts.selectMode===1){if(tree.lastSelectedNode){tree.lastSelectedNode.setSelected(false);}}else if(opts.selectMode===3){node.selected=flag;node.fixSelection3AfterClick();}
node.selected=flag;this.nodeRenderStatus(ctx);tree.lastSelectedNode=flag?node:null;tree._triggerNodeEvent("select",ctx);},nodeSetStatus:function(ctx,status,message,details){var node=ctx.node,tree=ctx.tree;function _clearStatusNode(){var firstChild=(node.children?node.children[0]:null);if(firstChild&&firstChild.isStatusNode()){try{if(node.ul){node.ul.removeChild(firstChild.li);firstChild.li=null;}}catch(e){}
if(node.children.length===1){node.children=[];}else{node.children.shift();}}}
function _setStatusNode(data,type){var firstChild=(node.children?node.children[0]:null);if(firstChild&&firstChild.isStatusNode()){$.extend(firstChild,data);tree._callHook("nodeRender",firstChild);}else{data.key="_statusNode";node._setChildren([data]);node.children[0].statusNodeType=type;tree.render();}
return node.children[0];}
switch(status){case"ok":_clearStatusNode();node._isLoading=false;node._error=null;node.renderStatus();break;case"loading":if(!node.parent){_setStatusNode({title:tree.options.strings.loading+(message?" ("+message+") ":""),tooltip:details,extraClasses:"fancytree-statusnode-wait"},status);}
node._isLoading=true;node._error=null;node.renderStatus();break;case"error":_setStatusNode({title:tree.options.strings.loadError+(message?" ("+message+") ":""),tooltip:details,extraClasses:"fancytree-statusnode-error"},status);node._isLoading=false;node._error={message:message,details:details};node.renderStatus();break;default:$.error("invalid node status "+status);}},nodeToggleExpanded:function(ctx){return this.nodeSetExpanded(ctx,!ctx.node.expanded);},nodeToggleSelected:function(ctx){return this.nodeSetSelected(ctx,!ctx.node.selected);},treeClear:function(ctx){var tree=ctx.tree;tree.activeNode=null;tree.focusNode=null;tree.$div.find(">ul.fancytree-container").empty();tree.rootNode.children=null;},treeCreate:function(ctx){},treeDestroy:function(ctx){},treeInit:function(ctx){this.treeLoad(ctx);},treeLoad:function(ctx,source){var type,$ul,tree=ctx.tree,$container=ctx.widget.element,dfd,rootCtx=$.extend({},ctx,{node:this.rootNode});if(tree.rootNode.children){this.treeClear(ctx);}
source=source||this.options.source;if(!source){type=$container.data("type")||"html";switch(type){case"html":$ul=$container.find(">ul:first");$ul.addClass("ui-fancytree-source ui-helper-hidden");source=$.ui.fancytree.parseHtml($ul);this.data=$.extend(this.data,_getElementDataAsDict($ul));break;case"json":source=$.parseJSON($container.text());if(source.children){if(source.title){tree.title=source.title;}
source=source.children;}
break;default:$.error("Invalid data-type: "+type);}}else if(typeof source==="string"){_raiseNotImplemented();}
dfd=this.nodeLoadChildren(rootCtx,source).done(function(){tree.render();if(ctx.options.selectMode===3){tree.rootNode.fixSelection3FromEndNodes();}
tree._triggerTreeEvent("init",true);}).fail(function(){tree.render();tree._triggerTreeEvent("init",false);});return dfd;},treeRegisterNode:function(ctx,add,node){},treeSetFocus:function(ctx,flag,_calledByNodeSetFocus){flag=(flag!==false);if(flag!==this.hasFocus()){this._hasFocus=flag;this.$container.toggleClass("fancytree-treefocus",flag);this._triggerTreeEvent(flag?"focusTree":"blurTree");}}});$.widget("ui.fancytree",{options:{activeVisible:true,ajax:{type:"GET",cache:false,dataType:"json"},aria:false,autoActivate:true,autoCollapse:false,autoScroll:false,checkbox:false,clickFolderMode:4,debugLevel:null,disabled:false,enableAspx:true,extensions:[],fx:{height:"toggle",duration:200},generateIds:false,icons:true,idPrefix:"ft_",keyboard:true,keyPathSeparator:"/",minExpandLevel:1,scrollOfs:{top:0,bottom:0},scrollParent:null,selectMode:2,strings:{loading:"Loading&#8230;",loadError:"Load error!"},tabbable:true,titlesTabbable:false,_classNames:{node:"fancytree-node",folder:"fancytree-folder",combinedExpanderPrefix:"fancytree-exp-",combinedIconPrefix:"fancytree-ico-",hasChildren:"fancytree-has-children",active:"fancytree-active",selected:"fancytree-selected",expanded:"fancytree-expanded",lazy:"fancytree-lazy",focused:"fancytree-focused",partsel:"fancytree-partsel",lastsib:"fancytree-lastsib",loading:"fancytree-loading",error:"fancytree-error"},lazyLoad:null,postProcess:null},_create:function(){this.tree=new Fancytree(this);this.$source=this.source||this.element.data("type")==="json"?this.element:this.element.find(">ul:first");var extension,extName,i,extensions=this.options.extensions,base=this.tree;for(i=0;i<extensions.length;i++){extName=extensions[i];extension=$.ui.fancytree._extensions[extName];if(!extension){$.error("Could not apply extension '"+extName+"' (it is not registered, did you forget to include it?)");}
this.tree.options[extName]=$.extend(true,{},extension.options,this.tree.options[extName]);_assert(this.tree.ext[extName]===undefined,"Extension name must not exist as Fancytree.ext attribute: '"+extName+"'");this.tree.ext[extName]={};_subclassObject(this.tree,base,extension,extName);base=extension;}
this.tree._callHook("treeCreate",this.tree);},_init:function(){this.tree._callHook("treeInit",this.tree);this._bind();},_setOption:function(key,value){var callDefault=true,rerender=false;switch(key){case"aria":case"checkbox":case"icons":case"minExpandLevel":case"tabbable":this.tree._callHook("treeCreate",this.tree);rerender=true;break;case"source":callDefault=false;this.tree._callHook("treeLoad",this.tree,value);break;}
this.tree.debug("set option "+key+"="+value+" <"+typeof(value)+">");if(callDefault){$.Widget.prototype._setOption.apply(this,arguments);}
if(rerender){this.tree.render(true,false);}},destroy:function(){this._unbind();this.tree._callHook("treeDestroy",this.tree);this.tree.$div.find(">ul.fancytree-container").remove();this.$source&&this.$source.removeClass("ui-helper-hidden");$.Widget.prototype.destroy.call(this);},_unbind:function(){var ns=this.tree._ns;this.element.unbind(ns);this.tree.$container.unbind(ns);$(document).unbind(ns);},_bind:function(){var that=this,opts=this.options,tree=this.tree,ns=tree._ns;this._unbind();tree.$container.on("focusin"+ns+" focusout"+ns,function(event){var node=FT.getNode(event),flag=(event.type==="focusin");if(node){tree._callHook("nodeSetFocus",node,flag);}else{tree._callHook("treeSetFocus",tree,flag);}}).on("selectstart"+ns,"span.fancytree-title",function(event){event.preventDefault();}).on("keydown"+ns,function(event){if(opts.disabled||opts.keyboard===false){return true;}
var res,node=tree.focusNode,ctx=tree._makeHookContext(node||tree,event),prevPhase=tree.phase;try{tree.phase="userEvent";if(node){res=tree._triggerNodeEvent("keydown",node,event);}else{res=tree._triggerTreeEvent("keydown",event);}
if(res==="preventNav"){res=true;}else if(res!==false){res=tree._callHook("nodeKeydown",ctx);}
return res;}finally{tree.phase=prevPhase;}}).on("click"+ns+" dblclick"+ns,function(event){if(opts.disabled){return true;}
var ctx,et=FT.getEventTarget(event),node=et.node,tree=that.tree,prevPhase=tree.phase;if(!node){return true;}
ctx=tree._makeHookContext(node,event);try{tree.phase="userEvent";switch(event.type){case"click":ctx.targetType=et.type;return(tree._triggerNodeEvent("click",ctx,event)===false)?false:tree._callHook("nodeClick",ctx);case"dblclick":ctx.targetType=et.type;return(tree._triggerNodeEvent("dblclick",ctx,event)===false)?false:tree._callHook("nodeDblclick",ctx);}}finally{tree.phase=prevPhase;}});},getActiveNode:function(){return this.tree.activeNode;},getNodeByKey:function(key){return this.tree.getNodeByKey(key);},getRootNode:function(){return this.tree.rootNode;},getTree:function(){return this.tree;}});FT=$.ui.fancytree;$.extend($.ui.fancytree,{version:"2.3.0",buildType:"production",debugLevel:1,_nextId:1,_nextNodeKey:1,_extensions:{},_FancytreeClass:Fancytree,_FancytreeNodeClass:FancytreeNode,jquerySupports:{positionMyOfs:isVersionAtLeast($.ui.version,1,9)},assert:function(cond,msg){return _assert(cond,msg);},debounce:function(timeout,fn,invokeAsap,ctx){var timer;if(arguments.length===3&&typeof invokeAsap!=="boolean"){ctx=invokeAsap;invokeAsap=false;}
return function(){var args=arguments;ctx=ctx||this;invokeAsap&&!timer&&fn.apply(ctx,args);clearTimeout(timer);timer=setTimeout(function(){invokeAsap||fn.apply(ctx,args);timer=null;},timeout);};},debug:function(msg){($.ui.fancytree.debugLevel>=2)&&consoleApply("log",arguments);},error:function(msg){consoleApply("error",arguments);},escapeHtml:function(s){return(""+s).replace(/[&<>"'\/]/g,function(s){return ENTITY_MAP[s];});},unescapeHtml:function(s){var e=document.createElement("div");e.innerHTML=s;return e.childNodes.length===0?"":e.childNodes[0].nodeValue;},getEventTargetType:function(event){return this.getEventTarget(event).type;},getEventTarget:function(event){var tcn=event&&event.target?event.target.className:"",res={node:this.getNode(event.target),type:undefined};if(/\bfancytree-title\b/.test(tcn)){res.type="title";}else if(/\bfancytree-expander\b/.test(tcn)){res.type=(res.node.hasChildren()===false?"prefix":"expander");}else if(/\bfancytree-checkbox\b/.test(tcn)||/\bfancytree-radio\b/.test(tcn)){res.type="checkbox";}else if(/\bfancytree-icon\b/.test(tcn)){res.type="icon";}else if(/\bfancytree-node\b/.test(tcn)){res.type="title";}else if(event&&event.target&&$(event.target).closest(".fancytree-title").length){res.type="title";}
return res;},getNode:function(el){if(el instanceof FancytreeNode){return el;}else if(el.selector!==undefined){el=el[0];}else if(el.originalEvent!==undefined){el=el.target;}
while(el){if(el.ftnode){return el.ftnode;}
el=el.parentNode;}
return null;},info:function(msg){($.ui.fancytree.debugLevel>=1)&&consoleApply("info",arguments);},parseHtml:function($ul){var extraClasses,i,l,iPos,tmp,tmp2,classes,className,$children=$ul.find(">li"),children=[];$children.each(function(){var allData,$li=$(this),$liSpan=$li.find(">span:first",this),$liA=$liSpan.length?null:$li.find(">a:first"),d={tooltip:null,data:{}};if($liSpan.length){d.title=$liSpan.html();}else if($liA&&$liA.length){d.title=$liA.html();d.data.href=$liA.attr("href");d.data.target=$liA.attr("target");d.tooltip=$liA.attr("title");}else{d.title=$li.html();iPos=d.title.search(/<ul/i);if(iPos>=0){d.title=d.title.substring(0,iPos);}}
d.title=$.trim(d.title);for(i=0,l=CLASS_ATTRS.length;i<l;i++){d[CLASS_ATTRS[i]]=undefined;}
classes=this.className.split(" ");extraClasses=[];for(i=0,l=classes.length;i<l;i++){className=classes[i];if(CLASS_ATTR_MAP[className]){d[className]=true;}else{extraClasses.push(className);}}
d.extraClasses=extraClasses.join(" ");tmp=$li.attr("title");if(tmp){d.tooltip=tmp;}
tmp=$li.attr("id");if(tmp){d.key=tmp;}
allData=_getElementDataAsDict($li);if(allData&&!$.isEmptyObject(allData)){for(i=0,l=NODE_ATTRS.length;i<l;i++){tmp=NODE_ATTRS[i];tmp2=allData[tmp];if(tmp2!=null){delete allData[tmp];d[tmp]=tmp2;}}
$.extend(d.data,allData);}
$ul=$li.find(">ul:first");if($ul.length){d.children=$.ui.fancytree.parseHtml($ul);}else{d.children=d.lazy?undefined:null;}
children.push(d);});return children;},registerExtension:function(definition){_assert(definition.name!=null,"extensions must have a `name` property.");_assert(definition.version!=null,"extensions must have a `version` property.");$.ui.fancytree._extensions[definition.name]=definition;},warn:function(msg){consoleApply("warn",arguments);}});}(jQuery,window,document));;(function($,window,document,undefined){"use strict";$.ui.fancytree.registerExtension({name:"themeroller",version:"0.0.1",options:{activeClass:"ui-state-active",foccusClass:"ui-state-focus",hoverClass:"ui-state-hover",selectedClass:"ui-state-highlight"},treeInit:function(ctx){this._super(ctx);var $el=ctx.widget.element;if($el[0].nodeName==="TABLE"){$el.addClass("ui-widget ui-corner-all");$el.find(">thead tr").addClass("ui-widget-header");$el.find(">tbody").addClass("ui-widget-conent");}else{$el.addClass("ui-widget ui-widget-content ui-corner-all");}
$el.delegate(".fancytree-node","mouseenter mouseleave",function(event){var node=$.ui.fancytree.getNode(event.target),flag=(event.type==="mouseenter");node.debug("hover: "+flag);$(node.span).toggleClass("ui-state-hover ui-corner-all",flag);});},treeDestroy:function(ctx){this._super(ctx);ctx.widget.element.removeClass("ui-widget ui-widget-content ui-corner-all");},nodeRenderStatus:function(ctx){var node=ctx.node,$el=$(node.span);this._super(ctx);$el.toggleClass("ui-state-active",node.isActive());$el.toggleClass("ui-state-focus",node.hasFocus());$el.toggleClass("ui-state-highlight",node.isSelected());}});}(jQuery,window,document));
var ContentListTreeComponent=NavigatorBaseComponent.extend({update:function(){var myself=this;var urlFolder=this.urlFolder==undefined?"":this.urlFolder;var extensions=this.extensions;$.getJSON(wd.cdf.endpoints.getJSONSolution()+"?mode=solutionTree&path="+urlFolder,function(json){myself.processNavigatorResponse(json);});},processNavigatorResponse:function(json){NavigatorBaseComponent.navigatorResponse=json;var files=this.includeSolutions?json.solution.folders[0].folders:NavigatorBaseComponent.getSolutionJSON(NavigatorBaseComponent.solution);var ret=this.generateMenuFromArray(files,0);$("#"+this.htmlObject).html(ret);$(function(){});$("#"+this.htmlObject).fancytree({minExpandLevel:1,postinit:function(isReloading,isError){this.reactivate();},focus:function(event,data){data.node.scheduleAction("activate",2000);},activate:function(event,data){var executePrptComponent=function(path,action){var parameters={paginate:true,showParameters:true,autoSubmit:true,"dashboard-mode":false,renderMode:'REPORT',htmlProportionalWidth:false};parameters["output-target"]="table/html;page-mode=page";parameters['accept-page']=0;var path=path;var reposURI="/api/repos/";var idxReposUri=path.indexOf(reposURI);var idx=idxReposUri+reposURI.length;var pathPreparado=path.substring(idx);$.extend(parameters,{ts:new Date().getTime()});window.top.mantle_openRepositoryFile(path,"RUN");};getReport=function(path,callvar,parameters){return Encoder.encode(wd.cdf.endpoints.getWebapp()+"/api/repos/{0}/"+callvar,Encoder.encodeRepositoryPath(path),parameters);};var executeComponent=function(path){window.top.mantle_openRepositoryFile(path,"RUN");};var node=data.node;if(node.data.href&&node.data.extension){window.top.mantle_openRepositoryFile(node.data.pathrelativo,"RUN");}},classNames:{focused:"",},renderNode:function(event,data){var node=data.node;var $span=$(node.span);var $span_icon=$span.find("span.fancytree-icon");var classIcon='';if(node.isFolder()){classIcon='icon-file-folder';}
else{switch(node.data.extension){case'cda':classIcon='icon-file-cda';break;case'wcdf':classIcon='icon-file-wcdf';break;case'xcdf':classIcon='icon-file-xcdf';break;case'xaction':classIcon='icon-file-xaction';break;case'prpt':classIcon='icon-file-prpt';break;default:classIcon='icon-file-generic';}}
$span_icon.addClass(classIcon);$span_icon.removeClass("fancytree-icon");}});},generateMenuFromArray:function(files,depth){var s="";if(files==undefined){return s;}
for(var i=0;i<files.length;i++){var file=files[i];if($.isEmptyObject(this.extensions)){s+=this.generateMenuFromFile(file,depth+1);}else{if($.inArray(file.type,this.extensions)>-1||file.type=="FOLDER"){s+=this.generateMenuFromFile(file,depth+1);}}}
if(s.length>0){var className;s="<ul >"+s+"</ul>";}
return s;},generateMenuFromFile:function(file,depth){var s="";if(file.visible==true){var classString=NavigatorBaseComponent.isAncestor(file.solution,file.path)?"class=\"ancestor\"":"";var _path="";if(file.path.length>0){_path="path="+file.path;}
var _template=NavigatorBaseComponent.template!=undefined&&NavigatorBaseComponent.template.length!=undefined&&NavigatorBaseComponent.template.length>0?"&amp;template="+NavigatorBaseComponent.template:"";if(file.link!=undefined){if(file.type=='FOLDER'){s+="<li class='folder' > "+file.title;}else{s+="<li data-extension='"+file.type+"'  data-action='"+file.name+"' data-pathRelativo='"+file.path+"' ><a "+classString+" title=\""+file.name+"\"  href=\""+webAppPath+file.link+"\">"+file.title+"</a>";}}else{if(file.type=='FOLDER'){s+="<li class='folder'  > "+file.title;}
else{s+="<li data-extension='"+file.type+"' ><a "+classString+" title=\""+file.name+"\" onClick=\"return false;\" href=\""+wd.cdf.endpoints.getRenderHTML()+"?solution="+file.solution+"&amp;"+_path+_template+"\">"+file.title+"</a>";}}
var files=file.folders||[];var childFiles=file.files||[];childFiles.sort(function(a,b){return a.name>b.name});var inner=this.generateMenuFromArray(files.concat(childFiles));if(inner.length>0){inner=" &raquo;"+inner;}
s+=inner+"</li>";}
return s;}});
(function(glob){var version="0.2.4",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b;},current_event,events={n:{}},eve=function(name,scope){var e=events,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},errors=[];current_event=name;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i];}}
indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];if(l.apply(scope,args)===f){return f;}}
for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){if(l.apply(scope,args)===f){return f;}
do{z++;l=queue[indexed[z]];if(l&&l.apply(scope,args)===f){return f;}}while(l)}else{queue[l.zIndex]=l;}}else{if(l.apply(scope,args)===f){return f;}}}};eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[]);}}}
es=nes;}
return out;};eve.on=function(name,f){var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;!e[names[i]]&&(e[names[i]]={n:{}});e=e[names[i]];}
e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun;}
e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex;}};};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event);}
return current_event;};eve.unbind=function(name,f){var names=name.split(separator),e,key,splice,cur=[events];for(var i=0,ii=names.length;i<ii;i++){for(var j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]]);}}else{for(key in e)if(e[has](key)){splice.push(e[key]);}}
cur.splice.apply(cur,splice);}}
for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){e.f.splice(i,1);break;}!e.f.length&&delete e.f;}
for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(i=0,ii=funcs.length;i<ii;i++)if(funcs[i]==f){funcs.splice(i,1);break;}!funcs.length&&delete e.n[key].f;}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f;}}
e=e.n;}}};eve.version=version;eve.toString=function(){return"You are running Eve "+version;};(typeof module!="undefined"&&module.exports)?(module.exports=eve):(glob.eve=eve);})(this);
(function(glob){var version="0.4.2",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b;},current_event,stop,events={n:{}},eve=function(name,scope){name=String(name);var e=events,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},out=[],ce=current_event,errors=[];current_event=name;stop=0;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i];}}
indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];out.push(l.apply(scope,args));if(stop){stop=oldstop;return out;}}
for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){out.push(l.apply(scope,args));if(stop){break;}
do{z++;l=queue[indexed[z]];l&&out.push(l.apply(scope,args));if(stop){break;}}while(l)}else{queue[l.zIndex]=l;}}else{out.push(l.apply(scope,args));if(stop){break;}}}
stop=oldstop;current_event=ce;return out.length?out:null;};eve._events=events;eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[]);}}}
es=nes;}
return out;};eve.on=function(name,f){name=String(name);if(typeof f!="function"){return function(){};}
var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;e=e.hasOwnProperty(names[i])&&e[names[i]]||(e[names[i]]={n:{}});}
e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun;}
e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex;}};};eve.f=function(event){var attrs=[].slice.call(arguments,1);return function(){eve.apply(null,[event,null].concat(attrs).concat([].slice.call(arguments,0)));};};eve.stop=function(){stop=1;};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event);}
return current_event;};eve.nts=function(){return current_event.split(separator);};eve.off=eve.unbind=function(name,f){if(!name){eve._events=events={n:{}};return;}
var names=name.split(separator),e,key,splice,i,ii,j,jj,cur=[events];for(i=0,ii=names.length;i<ii;i++){for(j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]]);}}else{for(key in e)if(e[has](key)){splice.push(e[key]);}}
cur.splice.apply(cur,splice);}}
for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(j=0,jj=e.f.length;j<jj;j++)if(e.f[j]==f){e.f.splice(j,1);break;}!e.f.length&&delete e.f;}
for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(j=0,jj=funcs.length;j<jj;j++)if(funcs[j]==f){funcs.splice(j,1);break;}!funcs.length&&delete e.n[key].f;}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f;}}
e=e.n;}}};eve.once=function(name,f){var f2=function(){eve.unbind(name,f2);return f.apply(this,arguments);};return eve.on(name,f2);};eve.version=version;eve.toString=function(){return"You are running Eve "+version;};(typeof module!="undefined"&&module.exports)?(module.exports=eve):(typeof define!="undefined"?(define("eve",[],function(){return eve;})):(glob.eve=eve));})(window||this);(function(glob,factory){if(typeof define==="function"&&define.amd){define(["eve"],function(eve){return factory(glob,eve);});}else{factory(glob,glob.eve);}}(this,function(window,eve){function R(first){if(R.is(first,"function")){return loaded?first():eve.on("raphael.DOMload",first);}else if(R.is(first,array)){return R._engine.create[apply](R,first.splice(0,3+R.is(first[0],nu))).add(first);}else{var args=Array.prototype.slice.call(arguments,0);if(R.is(args[args.length-1],"function")){var f=args.pop();return loaded?f.call(R._engine.create[apply](R,args)):eve.on("raphael.DOMload",function(){f.call(R._engine.create[apply](R,args));});}else{return R._engine.create[apply](R,arguments);}}}
R.version="2.1.2";R.eve=eve;var loaded,separator=/[, ]+/,elements={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},formatrg=/\{(\d+)\}/g,proto="prototype",has="hasOwnProperty",g={doc:document,win:window},oldRaphael={was:Object.prototype[has].call(g.win,"Raphael"),is:g.win.Raphael},Paper=function(){this.ca=this.customAttributes={};},paperproto,appendChild="appendChild",apply="apply",concat="concat",supportsTouch=('ontouchstart'in g.win)||g.win.DocumentTouch&&g.doc instanceof DocumentTouch,E="",S=" ",Str=String,split="split",events="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[split](S),touchMap={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},lowerCase=Str.prototype.toLowerCase,math=Math,mmax=math.max,mmin=math.min,abs=math.abs,pow=math.pow,PI=math.PI,nu="number",string="string",array="array",toString="toString",fillString="fill",objectToString=Object.prototype.toString,paper={},push="push",ISURL=R._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,colourRegExp=/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,isnan={"NaN":1,"Infinity":1,"-Infinity":1},bezierrg=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,round=math.round,setAttribute="setAttribute",toFloat=parseFloat,toInt=parseInt,upperCase=Str.prototype.toUpperCase,availableAttrs=R._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},availableAnimAttrs=R._availableAnimAttrs={blur:nu,"clip-rect":"csv",cx:nu,cy:nu,fill:"colour","fill-opacity":nu,"font-size":nu,height:nu,opacity:nu,path:"path",r:nu,rx:nu,ry:nu,stroke:"colour","stroke-opacity":nu,"stroke-width":nu,transform:"transform",width:nu,x:nu,y:nu},whitespace=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]/g,commaSpaces=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,hsrg={hs:1,rg:1},p2s=/,?([achlmqrstvxz]),?/gi,pathCommand=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,tCommand=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/ig,radial_gradient=R._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,eldata={},sortByKey=function(a,b){return a.key-b.key;},sortByNumber=function(a,b){return toFloat(a)-toFloat(b);},fun=function(){},pipe=function(x){return x;},rectPath=R._rectPath=function(x,y,w,h,r){if(r){return[["M",x+r,y],["l",w-r*2,0],["a",r,r,0,0,1,r,r],["l",0,h-r*2],["a",r,r,0,0,1,-r,r],["l",r*2-w,0],["a",r,r,0,0,1,-r,-r],["l",0,r*2-h],["a",r,r,0,0,1,r,-r],["z"]];}
return[["M",x,y],["l",w,0],["l",0,h],["l",-w,0],["z"]];},ellipsePath=function(x,y,rx,ry){if(ry==null){ry=rx;}
return[["M",x,y],["m",0,-ry],["a",rx,ry,0,1,1,0,2*ry],["a",rx,ry,0,1,1,0,-2*ry],["z"]];},getPath=R._getPath={path:function(el){return el.attr("path");},circle:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.r);},ellipse:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.rx,a.ry);},rect:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height,a.r);},image:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height);},text:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height);},set:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height);}},mapPath=R.mapPath=function(path,matrix){if(!matrix){return path;}
var x,y,i,j,ii,jj,pathi;path=path2curve(path);for(i=0,ii=path.length;i<ii;i++){pathi=path[i];for(j=1,jj=pathi.length;j<jj;j+=2){x=matrix.x(pathi[j],pathi[j+1]);y=matrix.y(pathi[j],pathi[j+1]);pathi[j]=x;pathi[j+1]=y;}}
return path;};R._g=g;R.type=(g.win.SVGAngle||g.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML");if(R.type=="VML"){var d=g.doc.createElement("div"),b;d.innerHTML='<v:shape adj="1"/>';b=d.firstChild;b.style.behavior="url(#default#VML)";if(!(b&&typeof b.adj=="object")){return(R.type=E);}
d=null;}
R.svg=!(R.vml=R.type=="VML");R._Paper=Paper;R.fn=paperproto=Paper.prototype=R.prototype;R._id=0;R._oid=0;R.is=function(o,type){type=lowerCase.call(type);if(type=="finite"){return!isnan[has](+o);}
if(type=="array"){return o instanceof Array;}
return(type=="null"&&o===null)||(type==typeof o&&o!==null)||(type=="object"&&o===Object(o))||(type=="array"&&Array.isArray&&Array.isArray(o))||objectToString.call(o).slice(8,-1).toLowerCase()==type;};function clone(obj){if(typeof obj=="function"||Object(obj)!==obj){return obj;}
var res=new obj.constructor;for(var key in obj)if(obj[has](key)){res[key]=clone(obj[key]);}
return res;}
R.angle=function(x1,y1,x2,y2,x3,y3){if(x3==null){var x=x1-x2,y=y1-y2;if(!x&&!y){return 0;}
return(180+math.atan2(-y,-x)*180/PI+360)%360;}else{return R.angle(x1,y1,x3,y3)-R.angle(x2,y2,x3,y3);}};R.rad=function(deg){return deg%360*PI/180;};R.deg=function(rad){return rad*180/PI%360;};R.snapTo=function(values,value,tolerance){tolerance=R.is(tolerance,"finite")?tolerance:10;if(R.is(values,array)){var i=values.length;while(i--)if(abs(values[i]-value)<=tolerance){return values[i];}}else{values=+values;var rem=value%values;if(rem<tolerance){return value-rem;}
if(rem>values-tolerance){return value-rem+values;}}
return value;};var createUUID=R.createUUID=(function(uuidRegEx,uuidReplacer){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uuidRegEx,uuidReplacer).toUpperCase();};})(/[xy]/g,function(c){var r=math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16);});R.setWindow=function(newwin){eve("raphael.setWindow",R,g.win,newwin);g.win=newwin;g.doc=g.win.document;if(R._engine.initWin){R._engine.initWin(g.win);}};var toHex=function(color){if(R.vml){var trim=/^\s+|\s+$/g;var bod;try{var docum=new ActiveXObject("htmlfile");docum.write("<body>");docum.close();bod=docum.body;}catch(e){bod=createPopup().document.body;}
var range=bod.createTextRange();toHex=cacher(function(color){try{bod.style.color=Str(color).replace(trim,E);var value=range.queryCommandValue("ForeColor");value=((value&255)<<16)|(value&65280)|((value&16711680)>>>16);return"#"+("000000"+value.toString(16)).slice(-6);}catch(e){return"none";}});}else{var i=g.doc.createElement("i");i.title="Rapha\xebl Colour Picker";i.style.display="none";g.doc.body.appendChild(i);toHex=cacher(function(color){i.style.color=color;return g.doc.defaultView.getComputedStyle(i,E).getPropertyValue("color");});}
return toHex(color);},hsbtoString=function(){return"hsb("+[this.h,this.s,this.b]+")";},hsltoString=function(){return"hsl("+[this.h,this.s,this.l]+")";},rgbtoString=function(){return this.hex;},prepareRGB=function(r,g,b){if(g==null&&R.is(r,"object")&&"r"in r&&"g"in r&&"b"in r){b=r.b;g=r.g;r=r.r;}
if(g==null&&R.is(r,string)){var clr=R.getRGB(r);r=clr.r;g=clr.g;b=clr.b;}
if(r>1||g>1||b>1){r/=255;g/=255;b/=255;}
return[r,g,b];},packageRGB=function(r,g,b,o){r*=255;g*=255;b*=255;var rgb={r:r,g:g,b:b,hex:R.rgb(r,g,b),toString:rgbtoString};R.is(o,"finite")&&(rgb.opacity=o);return rgb;};R.color=function(clr){var rgb;if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"b"in clr){rgb=R.hsb2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"l"in clr){rgb=R.hsl2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else{if(R.is(clr,"string")){clr=R.getRGB(clr);}
if(R.is(clr,"object")&&"r"in clr&&"g"in clr&&"b"in clr){rgb=R.rgb2hsl(clr);clr.h=rgb.h;clr.s=rgb.s;clr.l=rgb.l;rgb=R.rgb2hsb(clr);clr.v=rgb.b;}else{clr={hex:"none"};clr.r=clr.g=clr.b=clr.h=clr.s=clr.v=clr.l=-1;}}
clr.toString=rgbtoString;return clr;};R.hsb2rgb=function(h,s,v,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"b"in h){v=h.b;s=h.s;h=h.h;o=h.o;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=v*s;X=C*(1-abs(h%2-1));R=G=B=v-C;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.hsl2rgb=function(h,s,l,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"l"in h){l=h.l;s=h.s;h=h.h;}
if(h>1||s>1||l>1){h/=360;s/=100;l/=100;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=2*s*(l<.5?l:1-l);X=C*(1-abs(h%2-1));R=G=B=l-C/2;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.rgb2hsb=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,V,C;V=mmax(r,g,b);C=V-mmin(r,g,b);H=(C==0?null:V==r?(g-b)/C:V==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;S=C==0?0:C/V;return{h:H,s:S,b:V,toString:hsbtoString};};R.rgb2hsl=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,L,M,m,C;M=mmax(r,g,b);m=mmin(r,g,b);C=M-m;H=(C==0?null:M==r?(g-b)/C:M==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;L=(M+m)/2;S=(C==0?0:L<.5?C/(2*L):C/(2-2*L));return{h:H,s:S,l:L,toString:hsltoString};};R._path2string=function(){return this.join(",").replace(p2s,"$1");};function repush(array,item){for(var i=0,ii=array.length;i<ii;i++)if(array[i]===item){return array.push(array.splice(i,1)[0]);}}
function cacher(f,scope,postprocessor){function newf(){var arg=Array.prototype.slice.call(arguments,0),args=arg.join("\u2400"),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];if(cache[has](args)){repush(count,args);return postprocessor?postprocessor(cache[args]):cache[args];}
count.length>=1e3&&delete cache[count.shift()];count.push(args);cache[args]=f[apply](scope,arg);return postprocessor?postprocessor(cache[args]):cache[args];}
return newf;}
var preload=R._preload=function(src,f){var img=g.doc.createElement("img");img.style.cssText="position:absolute;left:-9999em;top:-9999em";img.onload=function(){f.call(this);this.onload=null;g.doc.body.removeChild(this);};img.onerror=function(){g.doc.body.removeChild(this);};g.doc.body.appendChild(img);img.src=src;};function clrToString(){return this.hex;}
R.getRGB=cacher(function(colour){if(!colour||!!((colour=Str(colour)).indexOf("-")+1)){return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};}
if(colour=="none"){return{r:-1,g:-1,b:-1,hex:"none",toString:clrToString};}!(hsrg[has](colour.toLowerCase().substring(0,2))||colour.charAt()=="#")&&(colour=toHex(colour));var res,red,green,blue,opacity,t,values,rgb=colour.match(colourRegExp);if(rgb){if(rgb[2]){blue=toInt(rgb[2].substring(5),16);green=toInt(rgb[2].substring(3,5),16);red=toInt(rgb[2].substring(1,3),16);}
if(rgb[3]){blue=toInt((t=rgb[3].charAt(3))+t,16);green=toInt((t=rgb[3].charAt(2))+t,16);red=toInt((t=rgb[3].charAt(1))+t,16);}
if(rgb[4]){values=rgb[4][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);rgb[1].toLowerCase().slice(0,4)=="rgba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);}
if(rgb[5]){values=rgb[5][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsb2rgb(red,green,blue,opacity);}
if(rgb[6]){values=rgb[6][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsla"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsl2rgb(red,green,blue,opacity);}
rgb={r:red,g:green,b:blue,toString:clrToString};rgb.hex="#"+(16777216|blue|(green<<8)|(red<<16)).toString(16).slice(1);R.is(opacity,"finite")&&(rgb.opacity=opacity);return rgb;}
return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};},R);R.hsb=cacher(function(h,s,b){return R.hsb2rgb(h,s,b).hex;});R.hsl=cacher(function(h,s,l){return R.hsl2rgb(h,s,l).hex;});R.rgb=cacher(function(r,g,b){return"#"+(16777216|b|(g<<8)|(r<<16)).toString(16).slice(1);});R.getColor=function(value){var start=this.getColor.start=this.getColor.start||{h:0,s:1,b:value||.75},rgb=this.hsb2rgb(start.h,start.s,start.b);start.h+=.075;if(start.h>1){start.h=0;start.s-=.2;start.s<=0&&(this.getColor.start={h:0,s:1,b:start.b});}
return rgb.hex;};R.getColor.reset=function(){delete this.start;};function catmullRom2bezier(crp,z){var d=[];for(var i=0,iLen=crp.length;iLen-2*!z>i;i+=2){var p=[{x:+crp[i-2],y:+crp[i-1]},{x:+crp[i],y:+crp[i+1]},{x:+crp[i+2],y:+crp[i+3]},{x:+crp[i+4],y:+crp[i+5]}];if(z){if(!i){p[0]={x:+crp[iLen-2],y:+crp[iLen-1]};}else if(iLen-4==i){p[3]={x:+crp[0],y:+crp[1]};}else if(iLen-2==i){p[2]={x:+crp[0],y:+crp[1]};p[3]={x:+crp[2],y:+crp[3]};}}else{if(iLen-4==i){p[3]=p[2];}else if(!i){p[0]={x:+crp[i],y:+crp[i+1]};}}
d.push(["C",(-p[0].x+6*p[1].x+p[2].x)/6,(-p[0].y+6*p[1].y+p[2].y)/6,(p[1].x+6*p[2].x-p[3].x)/6,(p[1].y+6*p[2].y-p[3].y)/6,p[2].x,p[2].y]);}
return d;}
R.parsePathString=function(pathString){if(!pathString){return null;}
var pth=paths(pathString);if(pth.arr){return pathClone(pth.arr);}
var paramCounts={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},data=[];if(R.is(pathString,array)&&R.is(pathString[0],array)){data=pathClone(pathString);}
if(!data.length){Str(pathString).replace(pathCommand,function(a,b,c){var params=[],name=b.toLowerCase();c.replace(pathValues,function(a,b){b&&params.push(+b);});if(name=="m"&&params.length>2){data.push([b][concat](params.splice(0,2)));name="l";b=b=="m"?"l":"L";}
if(name=="r"){data.push([b][concat](params));}else while(params.length>=paramCounts[name]){data.push([b][concat](params.splice(0,paramCounts[name])));if(!paramCounts[name]){break;}}});}
data.toString=R._path2string;pth.arr=pathClone(data);return data;};R.parseTransformString=cacher(function(TString){if(!TString){return null;}
var paramCounts={r:3,s:4,t:2,m:6},data=[];if(R.is(TString,array)&&R.is(TString[0],array)){data=pathClone(TString);}
if(!data.length){Str(TString).replace(tCommand,function(a,b,c){var params=[],name=lowerCase.call(b);c.replace(pathValues,function(a,b){b&&params.push(+b);});data.push([b][concat](params));});}
data.toString=R._path2string;return data;});var paths=function(ps){var p=paths.ps=paths.ps||{};if(p[ps]){p[ps].sleep=100;}else{p[ps]={sleep:100};}
setTimeout(function(){for(var key in p)if(p[has](key)&&key!=ps){p[key].sleep--;!p[key].sleep&&delete p[key];}});return p[ps];};R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t,t13=pow(t1,3),t12=pow(t1,2),t2=t*t,t3=t2*t,x=t13*p1x+t12*3*t*c1x+t1*3*t*t*c2x+t3*p2x,y=t13*p1y+t12*3*t*c1y+t1*3*t*t*c2y+t3*p2y,mx=p1x+2*t*(c1x-p1x)+t2*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t2*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t2*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t2*(p2y-2*c2y+c1y),ax=t1*p1x+t*c1x,ay=t1*p1y+t*c1y,cx=t1*c2x+t*p2x,cy=t1*c2y+t*p2y,alpha=(90-math.atan2(mx-nx,my-ny)*180/PI);(mx>nx||my<ny)&&(alpha+=180);return{x:x,y:y,m:{x:mx,y:my},n:{x:nx,y:ny},start:{x:ax,y:ay},end:{x:cx,y:cy},alpha:alpha};};R.bezierBBox=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){if(!R.is(p1x,"array")){p1x=[p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y];}
var bbox=curveDim.apply(null,p1x);return{x:bbox.min.x,y:bbox.min.y,x2:bbox.max.x,y2:bbox.max.y,width:bbox.max.x-bbox.min.x,height:bbox.max.y-bbox.min.y};};R.isPointInsideBBox=function(bbox,x,y){return x>=bbox.x&&x<=bbox.x2&&y>=bbox.y&&y<=bbox.y2;};R.isBBoxIntersect=function(bbox1,bbox2){var i=R.isPointInsideBBox;return i(bbox2,bbox1.x,bbox1.y)||i(bbox2,bbox1.x2,bbox1.y)||i(bbox2,bbox1.x,bbox1.y2)||i(bbox2,bbox1.x2,bbox1.y2)||i(bbox1,bbox2.x,bbox2.y)||i(bbox1,bbox2.x2,bbox2.y)||i(bbox1,bbox2.x,bbox2.y2)||i(bbox1,bbox2.x2,bbox2.y2)||(bbox1.x<bbox2.x2&&bbox1.x>bbox2.x||bbox2.x<bbox1.x2&&bbox2.x>bbox1.x)&&(bbox1.y<bbox2.y2&&bbox1.y>bbox2.y||bbox2.y<bbox1.y2&&bbox2.y>bbox1.y);};function base3(t,p1,p2,p3,p4){var t1=-3*p1+9*p2-9*p3+3*p4,t2=t*t1+6*p1-12*p2+6*p3;return t*t2-3*p1+3*p2;}
function bezlen(x1,y1,x2,y2,x3,y3,x4,y4,z){if(z==null){z=1;}
z=z>1?1:z<0?0:z;var z2=z/2,n=12,Tvalues=[-0.1252,0.1252,-0.3678,0.3678,-0.5873,0.5873,-0.7699,0.7699,-0.9041,0.9041,-0.9816,0.9816],Cvalues=[0.2491,0.2491,0.2335,0.2335,0.2032,0.2032,0.1601,0.1601,0.1069,0.1069,0.0472,0.0472],sum=0;for(var i=0;i<n;i++){var ct=z2*Tvalues[i]+z2,xbase=base3(ct,x1,x2,x3,x4),ybase=base3(ct,y1,y2,y3,y4),comb=xbase*xbase+ybase*ybase;sum+=Cvalues[i]*math.sqrt(comb);}
return z2*sum;}
function getTatLen(x1,y1,x2,y2,x3,y3,x4,y4,ll){if(ll<0||bezlen(x1,y1,x2,y2,x3,y3,x4,y4)<ll){return;}
var t=1,step=t/2,t2=t-step,l,e=.01;l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2);while(abs(l-ll)>e){step/=2;t2+=(l<ll?1:-1)*step;l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2);}
return t2;}
function intersect(x1,y1,x2,y2,x3,y3,x4,y4){if(mmax(x1,x2)<mmin(x3,x4)||mmin(x1,x2)>mmax(x3,x4)||mmax(y1,y2)<mmin(y3,y4)||mmin(y1,y2)>mmax(y3,y4)){return;}
var nx=(x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4),ny=(x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4),denominator=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);if(!denominator){return;}
var px=nx/denominator,py=ny/denominator,px2=+px.toFixed(2),py2=+py.toFixed(2);if(px2<+mmin(x1,x2).toFixed(2)||px2>+mmax(x1,x2).toFixed(2)||px2<+mmin(x3,x4).toFixed(2)||px2>+mmax(x3,x4).toFixed(2)||py2<+mmin(y1,y2).toFixed(2)||py2>+mmax(y1,y2).toFixed(2)||py2<+mmin(y3,y4).toFixed(2)||py2>+mmax(y3,y4).toFixed(2)){return;}
return{x:px,y:py};}
function inter(bez1,bez2){return interHelper(bez1,bez2);}
function interCount(bez1,bez2){return interHelper(bez1,bez2,1);}
function interHelper(bez1,bez2,justCount){var bbox1=R.bezierBBox(bez1),bbox2=R.bezierBBox(bez2);if(!R.isBBoxIntersect(bbox1,bbox2)){return justCount?0:[];}
var l1=bezlen.apply(0,bez1),l2=bezlen.apply(0,bez2),n1=mmax(~~(l1/5),1),n2=mmax(~~(l2/5),1),dots1=[],dots2=[],xy={},res=justCount?0:[];for(var i=0;i<n1+1;i++){var p=R.findDotsAtSegment.apply(R,bez1.concat(i/n1));dots1.push({x:p.x,y:p.y,t:i/n1});}
for(i=0;i<n2+1;i++){p=R.findDotsAtSegment.apply(R,bez2.concat(i/n2));dots2.push({x:p.x,y:p.y,t:i/n2});}
for(i=0;i<n1;i++){for(var j=0;j<n2;j++){var di=dots1[i],di1=dots1[i+1],dj=dots2[j],dj1=dots2[j+1],ci=abs(di1.x-di.x)<.001?"y":"x",cj=abs(dj1.x-dj.x)<.001?"y":"x",is=intersect(di.x,di.y,di1.x,di1.y,dj.x,dj.y,dj1.x,dj1.y);if(is){if(xy[is.x.toFixed(4)]==is.y.toFixed(4)){continue;}
xy[is.x.toFixed(4)]=is.y.toFixed(4);var t1=di.t+abs((is[ci]-di[ci])/(di1[ci]-di[ci]))*(di1.t-di.t),t2=dj.t+abs((is[cj]-dj[cj])/(dj1[cj]-dj[cj]))*(dj1.t-dj.t);if(t1>=0&&t1<=1.001&&t2>=0&&t2<=1.001){if(justCount){res++;}else{res.push({x:is.x,y:is.y,t1:mmin(t1,1),t2:mmin(t2,1)});}}}}}
return res;}
R.pathIntersection=function(path1,path2){return interPathHelper(path1,path2);};R.pathIntersectionNumber=function(path1,path2){return interPathHelper(path1,path2,1);};function interPathHelper(path1,path2,justCount){path1=R._path2curve(path1);path2=R._path2curve(path2);var x1,y1,x2,y2,x1m,y1m,x2m,y2m,bez1,bez2,res=justCount?0:[];for(var i=0,ii=path1.length;i<ii;i++){var pi=path1[i];if(pi[0]=="M"){x1=x1m=pi[1];y1=y1m=pi[2];}else{if(pi[0]=="C"){bez1=[x1,y1].concat(pi.slice(1));x1=bez1[6];y1=bez1[7];}else{bez1=[x1,y1,x1,y1,x1m,y1m,x1m,y1m];x1=x1m;y1=y1m;}
for(var j=0,jj=path2.length;j<jj;j++){var pj=path2[j];if(pj[0]=="M"){x2=x2m=pj[1];y2=y2m=pj[2];}else{if(pj[0]=="C"){bez2=[x2,y2].concat(pj.slice(1));x2=bez2[6];y2=bez2[7];}else{bez2=[x2,y2,x2,y2,x2m,y2m,x2m,y2m];x2=x2m;y2=y2m;}
var intr=interHelper(bez1,bez2,justCount);if(justCount){res+=intr;}else{for(var k=0,kk=intr.length;k<kk;k++){intr[k].segment1=i;intr[k].segment2=j;intr[k].bez1=bez1;intr[k].bez2=bez2;}
res=res.concat(intr);}}}}}
return res;}
R.isPointInsidePath=function(path,x,y){var bbox=R.pathBBox(path);return R.isPointInsideBBox(bbox,x,y)&&interPathHelper(path,[["M",x,y],["H",bbox.x2+10]],1)%2==1;};R._removedFactory=function(methodname){return function(){eve("raphael.log",null,"Rapha\xebl: you are calling to method \u201c"+methodname+"\u201d of removed object",methodname);};};var pathDimensions=R.pathBBox=function(path){var pth=paths(path);if(pth.bbox){return clone(pth.bbox);}
if(!path){return{x:0,y:0,width:0,height:0,x2:0,y2:0};}
path=path2curve(path);var x=0,y=0,X=[],Y=[],p;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=p[1];y=p[2];X.push(x);Y.push(y);}else{var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);X=X[concat](dim.min.x,dim.max.x);Y=Y[concat](dim.min.y,dim.max.y);x=p[5];y=p[6];}}
var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y),xmax=mmax[apply](0,X),ymax=mmax[apply](0,Y),width=xmax-xmin,height=ymax-ymin,bb={x:xmin,y:ymin,x2:xmax,y2:ymax,width:width,height:height,cx:xmin+width/2,cy:ymin+height/2};pth.bbox=clone(bb);return bb;},pathClone=function(pathArray){var res=clone(pathArray);res.toString=R._path2string;return res;},pathToRelative=R._pathToRelative=function(pathArray){var pth=paths(pathArray);if(pth.rel){return pathClone(pth.rel);}
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=pathArray[0][1];y=pathArray[0][2];mx=x;my=y;start++;res.push(["M",x,y]);}
for(var i=start,ii=pathArray.length;i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=lowerCase.call(pa[0])){r[0]=lowerCase.call(pa[0]);switch(r[0]){case"a":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]-x).toFixed(3);r[7]=+(pa[7]-y).toFixed(3);break;case"v":r[1]=+(pa[1]-y).toFixed(3);break;case"m":mx=pa[1];my=pa[2];default:for(var j=1,jj=pa.length;j<jj;j++){r[j]=+(pa[j]-((j%2)?x:y)).toFixed(3);}}}else{r=res[i]=[];if(pa[0]=="m"){mx=pa[1]+x;my=pa[2]+y;}
for(var k=0,kk=pa.length;k<kk;k++){res[i][k]=pa[k];}}
var len=res[i].length;switch(res[i][0]){case"z":x=mx;y=my;break;case"h":x+=+res[i][len-1];break;case"v":y+=+res[i][len-1];break;default:x+=+res[i][len-2];y+=+res[i][len-1];}}
res.toString=R._path2string;pth.rel=pathClone(res);return res;},pathToAbsolute=R._pathToAbsolute=function(pathArray){var pth=paths(pathArray);if(pth.abs){return pathClone(pth.abs);}
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
if(!pathArray||!pathArray.length){return[["M",0,0]];}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=+pathArray[0][1];y=+pathArray[0][2];mx=x;my=y;start++;res[0]=["M",x,y];}
var crz=pathArray.length==3&&pathArray[0][0]=="M"&&pathArray[1][0].toUpperCase()=="R"&&pathArray[2][0].toUpperCase()=="Z";for(var r,pa,i=start,ii=pathArray.length;i<ii;i++){res.push(r=[]);pa=pathArray[i];if(pa[0]!=upperCase.call(pa[0])){r[0]=upperCase.call(pa[0]);switch(r[0]){case"A":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]+x);r[7]=+(pa[7]+y);break;case"V":r[1]=+pa[1]+y;break;case"H":r[1]=+pa[1]+x;break;case"R":var dots=[x,y][concat](pa.slice(1));for(var j=2,jj=dots.length;j<jj;j++){dots[j]=+dots[j]+x;dots[++j]=+dots[j]+y;}
res.pop();res=res[concat](catmullRom2bezier(dots,crz));break;case"M":mx=+pa[1]+x;my=+pa[2]+y;default:for(j=1,jj=pa.length;j<jj;j++){r[j]=+pa[j]+((j%2)?x:y);}}}else if(pa[0]=="R"){dots=[x,y][concat](pa.slice(1));res.pop();res=res[concat](catmullRom2bezier(dots,crz));r=["R"][concat](pa.slice(-2));}else{for(var k=0,kk=pa.length;k<kk;k++){r[k]=pa[k];}}
switch(r[0]){case"Z":x=mx;y=my;break;case"H":x=r[1];break;case"V":y=r[1];break;case"M":mx=r[r.length-2];my=r[r.length-1];default:x=r[r.length-2];y=r[r.length-1];}}
res.toString=R._path2string;pth.abs=pathClone(res);return res;},l2c=function(x1,y1,x2,y2){return[x1,y1,x2,y2,x2,y2];},q2c=function(x1,y1,ax,ay,x2,y2){var _13=1/3,_23=2/3;return[_13*x1+_23*ax,_13*y1+_23*ay,_13*x2+_23*ax,_13*y2+_23*ay,x2,y2];},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){var _120=PI*120/180,rad=PI/180*(+angle||0),res=[],xy,rotate=cacher(function(x,y,rad){var X=x*math.cos(rad)-y*math.sin(rad),Y=x*math.sin(rad)+y*math.cos(rad);return{x:X,y:Y};});if(!recursive){xy=rotate(x1,y1,-rad);x1=xy.x;y1=xy.y;xy=rotate(x2,y2,-rad);x2=xy.x;y2=xy.y;var cos=math.cos(PI/180*angle),sin=math.sin(PI/180*angle),x=(x1-x2)/2,y=(y1-y2)/2;var h=(x*x)/(rx*rx)+(y*y)/(ry*ry);if(h>1){h=math.sqrt(h);rx=h*rx;ry=h*ry;}
var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(9)),f2=math.asin(((y2-cy)/ry).toFixed(9));f1=x1<cx?PI-f1:f1;f2=x2<cx?PI-f2:f2;f1<0&&(f1=PI*2+f1);f2<0&&(f2=PI*2+f2);if(sweep_flag&&f1>f2){f1=f1-PI*2;}
if(!sweep_flag&&f2>f1){f2=f2-PI*2;}}else{f1=recursive[0];f2=recursive[1];cx=recursive[2];cy=recursive[3];}
var df=f2-f1;if(abs(df)>_120){var f2old=f2,x2old=x2,y2old=y2;f2=f1+_120*(sweep_flag&&f2>f1?1:-1);x2=cx+rx*math.cos(f2);y2=cy+ry*math.sin(f2);res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[f2,f2old,cx,cy]);}
df=f2-f1;var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[x1,y1],m2=[x1+hx*s1,y1-hy*c1],m3=[x2+hx*s2,y2-hy*c2],m4=[x2,y2];m2[0]=2*m1[0]-m2[0];m2[1]=2*m1[1]-m2[1];if(recursive){return[m2,m3,m4][concat](res);}else{res=[m2,m3,m4][concat](res).join()[split](",");var newres=[];for(var i=0,ii=res.length;i<ii;i++){newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x;}
return newres;}},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t;return{x:pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,y:pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y};},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var a=(c2x-2*c1x+p1x)-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[p1y,p2y],x=[p1x,p2x],dot;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
a=(c2y-2*c1y+p1y)-(p2y-2*c2y+c1y);b=2*(c1y-p1y)-2*(c2y-c1y);c=p1y-c1y;t1=(-b+math.sqrt(b*b-4*a*c))/2/a;t2=(-b-math.sqrt(b*b-4*a*c))/2/a;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
return{min:{x:mmin[apply](0,x),y:mmin[apply](0,y)},max:{x:mmax[apply](0,x),y:mmax[apply](0,y)}};}),path2curve=R._path2curve=cacher(function(path,path2){var pth=!path2&&paths(path);if(!path2&&pth.curve){return pathClone(pth.curve);}
var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},attrs2={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},processPath=function(path,d,pcom){var nx,ny,tq={T:1,Q:1};if(!path){return["C",d.x,d.y,d.x,d.y,d.x,d.y];}!(path[0]in tq)&&(d.qx=d.qy=null);switch(path[0]){case"M":d.X=path[1];d.Y=path[2];break;case"A":path=["C"][concat](a2c[apply](0,[d.x,d.y][concat](path.slice(1))));break;case"S":if(pcom=="C"||pcom=="S"){nx=d.x*2-d.bx;ny=d.y*2-d.by;}
else{nx=d.x;ny=d.y;}
path=["C",nx,ny][concat](path.slice(1));break;case"T":if(pcom=="Q"||pcom=="T"){d.qx=d.x*2-d.qx;d.qy=d.y*2-d.qy;}
else{d.qx=d.x;d.qy=d.y;}
path=["C"][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));break;case"Q":d.qx=path[1];d.qy=path[2];path=["C"][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));break;case"L":path=["C"][concat](l2c(d.x,d.y,path[1],path[2]));break;case"H":path=["C"][concat](l2c(d.x,d.y,path[1],d.y));break;case"V":path=["C"][concat](l2c(d.x,d.y,d.x,path[1]));break;case"Z":path=["C"][concat](l2c(d.x,d.y,d.X,d.Y));break;}
return path;},fixArc=function(pp,i){if(pp[i].length>7){pp[i].shift();var pi=pp[i];while(pi.length){pp.splice(i++,0,["C"][concat](pi.splice(0,6)));}
pp.splice(i,1);ii=mmax(p.length,p2&&p2.length||0);}},fixM=function(path1,path2,a1,a2,i){if(path1&&path2&&path1[i][0]=="M"&&path2[i][0]!="M"){path2.splice(i,0,["M",a2.x,a2.y]);a1.bx=0;a1.by=0;a1.x=path1[i][1];a1.y=path1[i][2];ii=mmax(p.length,p2&&p2.length||0);}};for(var i=0,ii=mmax(p.length,p2&&p2.length||0);i<ii;i++){p[i]=processPath(p[i],attrs);fixArc(p,i);p2&&(p2[i]=processPath(p2[i],attrs2));p2&&fixArc(p2,i);fixM(p,p2,attrs,attrs2,i);fixM(p2,p,attrs2,attrs,i);var seg=p[i],seg2=p2&&p2[i],seglen=seg.length,seg2len=p2&&seg2.length;attrs.x=seg[seglen-2];attrs.y=seg[seglen-1];attrs.bx=toFloat(seg[seglen-4])||attrs.x;attrs.by=toFloat(seg[seglen-3])||attrs.y;attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x);attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y);attrs2.x=p2&&seg2[seg2len-2];attrs2.y=p2&&seg2[seg2len-1];}
if(!p2){pth.curve=pathClone(p);}
return p2?[p,p2]:p;},null,pathClone),parseDots=R._parseDots=cacher(function(gradient){var dots=[];for(var i=0,ii=gradient.length;i<ii;i++){var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);dot.color=R.getRGB(par[1]);if(dot.color.error){return null;}
dot.color=dot.color.hex;par[2]&&(dot.offset=par[2]+"%");dots.push(dot);}
for(i=1,ii=dots.length-1;i<ii;i++){if(!dots[i].offset){var start=toFloat(dots[i-1].offset||0),end=0;for(var j=i+1;j<ii;j++){if(dots[j].offset){end=dots[j].offset;break;}}
if(!end){end=100;j=ii;}
end=toFloat(end);var d=(end-start)/(j-i+1);for(;i<j;i++){start+=d;dots[i].offset=start+"%";}}}
return dots;}),tear=R._tear=function(el,paper){el==paper.top&&(paper.top=el.prev);el==paper.bottom&&(paper.bottom=el.next);el.next&&(el.next.prev=el.prev);el.prev&&(el.prev.next=el.next);},tofront=R._tofront=function(el,paper){if(paper.top===el){return;}
tear(el,paper);el.next=null;el.prev=paper.top;paper.top.next=el;paper.top=el;},toback=R._toback=function(el,paper){if(paper.bottom===el){return;}
tear(el,paper);el.next=paper.bottom;el.prev=null;paper.bottom.prev=el;paper.bottom=el;},insertafter=R._insertafter=function(el,el2,paper){tear(el,paper);el2==paper.top&&(paper.top=el);el2.next&&(el2.next.prev=el);el.next=el2.next;el.prev=el2;el2.next=el;},insertbefore=R._insertbefore=function(el,el2,paper){tear(el,paper);el2==paper.bottom&&(paper.bottom=el);el2.prev&&(el2.prev.next=el);el.prev=el2.prev;el2.prev=el;el.next=el2;},toMatrix=R.toMatrix=function(path,transform){var bb=pathDimensions(path),el={_:{transform:E},getBBox:function(){return bb;}};extractTransform(el,transform);return el.matrix;},transformPath=R.transformPath=function(path,transform){return mapPath(path,toMatrix(path,transform));},extractTransform=R._extractTransform=function(el,tstr){if(tstr==null){return el._.transform;}
tstr=Str(tstr).replace(/\.{3}|\u2026/g,el._.transform||E);var tdata=R.parseTransformString(tstr),deg=0,dx=0,dy=0,sx=1,sy=1,_=el._,m=new Matrix;_.transform=tdata||[];if(tdata){for(var i=0,ii=tdata.length;i<ii;i++){var t=tdata[i],tlen=t.length,command=Str(t[0]).toLowerCase(),absolute=t[0]!=command,inver=absolute?m.invert():0,x1,y1,x2,y2,bb;if(command=="t"&&tlen==3){if(absolute){x1=inver.x(0,0);y1=inver.y(0,0);x2=inver.x(t[1],t[2]);y2=inver.y(t[1],t[2]);m.translate(x2-x1,y2-y1);}else{m.translate(t[1],t[2]);}}else if(command=="r"){if(tlen==2){bb=bb||el.getBBox(1);m.rotate(t[1],bb.x+bb.width/2,bb.y+bb.height/2);deg+=t[1];}else if(tlen==4){if(absolute){x2=inver.x(t[2],t[3]);y2=inver.y(t[2],t[3]);m.rotate(t[1],x2,y2);}else{m.rotate(t[1],t[2],t[3]);}
deg+=t[1];}}else if(command=="s"){if(tlen==2||tlen==3){bb=bb||el.getBBox(1);m.scale(t[1],t[tlen-1],bb.x+bb.width/2,bb.y+bb.height/2);sx*=t[1];sy*=t[tlen-1];}else if(tlen==5){if(absolute){x2=inver.x(t[3],t[4]);y2=inver.y(t[3],t[4]);m.scale(t[1],t[2],x2,y2);}else{m.scale(t[1],t[2],t[3],t[4]);}
sx*=t[1];sy*=t[2];}}else if(command=="m"&&tlen==7){m.add(t[1],t[2],t[3],t[4],t[5],t[6]);}
_.dirtyT=1;el.matrix=m;}}
el.matrix=m;_.sx=sx;_.sy=sy;_.deg=deg;_.dx=dx=m.e;_.dy=dy=m.f;if(sx==1&&sy==1&&!deg&&_.bbox){_.bbox.x+=+dx;_.bbox.y+=+dy;}else{_.dirtyT=1;}},getEmpty=function(item){var l=item[0];switch(l.toLowerCase()){case"t":return[l,0,0];case"m":return[l,1,0,0,1,0,0];case"r":if(item.length==4){return[l,0,item[2],item[3]];}else{return[l,0];}
case"s":if(item.length==5){return[l,1,1,item[3],item[4]];}else if(item.length==3){return[l,1,1];}else{return[l,1];}}},equaliseTransform=R._equaliseTransform=function(t1,t2){t2=Str(t2).replace(/\.{3}|\u2026/g,t1);t1=R.parseTransformString(t1)||[];t2=R.parseTransformString(t2)||[];var maxlength=mmax(t1.length,t2.length),from=[],to=[],i=0,j,jj,tt1,tt2;for(;i<maxlength;i++){tt1=t1[i]||getEmpty(t2[i]);tt2=t2[i]||getEmpty(tt1);if((tt1[0]!=tt2[0])||(tt1[0].toLowerCase()=="r"&&(tt1[2]!=tt2[2]||tt1[3]!=tt2[3]))||(tt1[0].toLowerCase()=="s"&&(tt1[3]!=tt2[3]||tt1[4]!=tt2[4]))){return;}
from[i]=[];to[i]=[];for(j=0,jj=mmax(tt1.length,tt2.length);j<jj;j++){j in tt1&&(from[i][j]=tt1[j]);j in tt2&&(to[i][j]=tt2[j]);}}
return{from:from,to:to};};R._getContainer=function(x,y,w,h){var container;container=h==null&&!R.is(x,"object")?g.doc.getElementById(x):x;if(container==null){return;}
if(container.tagName){if(y==null){return{container:container,width:container.style.pixelWidth||container.offsetWidth,height:container.style.pixelHeight||container.offsetHeight};}else{return{container:container,width:y,height:w};}}
return{container:1,x:x,y:y,width:w,height:h};};R.pathToRelative=pathToRelative;R._engine={};R.path2curve=path2curve;R.matrix=function(a,b,c,d,e,f){return new Matrix(a,b,c,d,e,f);};function Matrix(a,b,c,d,e,f){if(a!=null){this.a=+a;this.b=+b;this.c=+c;this.d=+d;this.e=+e;this.f=+f;}else{this.a=1;this.b=0;this.c=0;this.d=1;this.e=0;this.f=0;}}
(function(matrixproto){matrixproto.add=function(a,b,c,d,e,f){var out=[[],[],[]],m=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],matrix=[[a,c,e],[b,d,f],[0,0,1]],x,y,z,res;if(a&&a instanceof Matrix){matrix=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]];}
for(x=0;x<3;x++){for(y=0;y<3;y++){res=0;for(z=0;z<3;z++){res+=m[x][z]*matrix[z][y];}
out[x][y]=res;}}
this.a=out[0][0];this.b=out[1][0];this.c=out[0][1];this.d=out[1][1];this.e=out[0][2];this.f=out[1][2];};matrixproto.invert=function(){var me=this,x=me.a*me.d-me.b*me.c;return new Matrix(me.d/x,-me.b/x,-me.c/x,me.a/x,(me.c*me.f-me.d*me.e)/x,(me.b*me.e-me.a*me.f)/x);};matrixproto.clone=function(){return new Matrix(this.a,this.b,this.c,this.d,this.e,this.f);};matrixproto.translate=function(x,y){this.add(1,0,0,1,x,y);};matrixproto.scale=function(x,y,cx,cy){y==null&&(y=x);(cx||cy)&&this.add(1,0,0,1,cx,cy);this.add(x,0,0,y,0,0);(cx||cy)&&this.add(1,0,0,1,-cx,-cy);};matrixproto.rotate=function(a,x,y){a=R.rad(a);x=x||0;y=y||0;var cos=+math.cos(a).toFixed(9),sin=+math.sin(a).toFixed(9);this.add(cos,sin,-sin,cos,x,y);this.add(1,0,0,1,-x,-y);};matrixproto.x=function(x,y){return x*this.a+y*this.c+this.e;};matrixproto.y=function(x,y){return x*this.b+y*this.d+this.f;};matrixproto.get=function(i){return+this[Str.fromCharCode(97+i)].toFixed(4);};matrixproto.toString=function(){return R.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join();};matrixproto.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')";};matrixproto.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)];};function norm(a){return a[0]*a[0]+a[1]*a[1];}
function normalize(a){var mag=math.sqrt(norm(a));a[0]&&(a[0]/=mag);a[1]&&(a[1]/=mag);}
matrixproto.split=function(){var out={};out.dx=this.e;out.dy=this.f;var row=[[this.a,this.c],[this.b,this.d]];out.scalex=math.sqrt(norm(row[0]));normalize(row[0]);out.shear=row[0][0]*row[1][0]+row[0][1]*row[1][1];row[1]=[row[1][0]-row[0][0]*out.shear,row[1][1]-row[0][1]*out.shear];out.scaley=math.sqrt(norm(row[1]));normalize(row[1]);out.shear/=out.scaley;var sin=-row[0][1],cos=row[1][1];if(cos<0){out.rotate=R.deg(math.acos(cos));if(sin<0){out.rotate=360-out.rotate;}}else{out.rotate=R.deg(math.asin(sin));}
out.isSimple=!+out.shear.toFixed(9)&&(out.scalex.toFixed(9)==out.scaley.toFixed(9)||!out.rotate);out.isSuperSimple=!+out.shear.toFixed(9)&&out.scalex.toFixed(9)==out.scaley.toFixed(9)&&!out.rotate;out.noRotation=!+out.shear.toFixed(9)&&!out.rotate;return out;};matrixproto.toTransformString=function(shorter){var s=shorter||this[split]();if(s.isSimple){s.scalex=+s.scalex.toFixed(4);s.scaley=+s.scaley.toFixed(4);s.rotate=+s.rotate.toFixed(4);return(s.dx||s.dy?"t"+[s.dx,s.dy]:E)+
(s.scalex!=1||s.scaley!=1?"s"+[s.scalex,s.scaley,0,0]:E)+
(s.rotate?"r"+[s.rotate,0,0]:E);}else{return"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)];}};})(Matrix.prototype);var version=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);if((navigator.vendor=="Apple Computer, Inc.")&&(version&&version[1]<4||navigator.platform.slice(0,2)=="iP")||(navigator.vendor=="Google Inc."&&version&&version[1]<8)){paperproto.safari=function(){var rect=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){rect.remove();});};}else{paperproto.safari=fun;}
var preventDefault=function(){this.returnValue=false;},preventTouch=function(){return this.originalEvent.preventDefault();},stopPropagation=function(){this.cancelBubble=true;},stopTouch=function(){return this.originalEvent.stopPropagation();},getEventPosition=function(e){var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;return{x:e.clientX+scrollX,y:e.clientY+scrollY};},addEvent=(function(){if(g.doc.addEventListener){return function(obj,type,fn,element){var f=function(e){var pos=getEventPosition(e);return fn.call(element,e,pos.x,pos.y);};obj.addEventListener(type,f,false);if(supportsTouch&&touchMap[type]){var _f=function(e){var pos=getEventPosition(e),olde=e;for(var i=0,ii=e.targetTouches&&e.targetTouches.length;i<ii;i++){if(e.targetTouches[i].target==obj){e=e.targetTouches[i];e.originalEvent=olde;e.preventDefault=preventTouch;e.stopPropagation=stopTouch;break;}}
return fn.call(element,e,pos.x,pos.y);};obj.addEventListener(touchMap[type],_f,false);}
return function(){obj.removeEventListener(type,f,false);if(supportsTouch&&touchMap[type])
obj.removeEventListener(touchMap[type],f,false);return true;};};}else if(g.doc.attachEvent){return function(obj,type,fn,element){var f=function(e){e=e||g.win.event;var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;e.preventDefault=e.preventDefault||preventDefault;e.stopPropagation=e.stopPropagation||stopPropagation;return fn.call(element,e,x,y);};obj.attachEvent("on"+type,f);var detacher=function(){obj.detachEvent("on"+type,f);return true;};return detacher;};}})(),drag=[],dragMove=function(e){var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,dragi,j=drag.length;while(j--){dragi=drag[j];if(supportsTouch&&e.touches){var i=e.touches.length,touch;while(i--){touch=e.touches[i];if(touch.identifier==dragi.el._drag.id){x=touch.clientX;y=touch.clientY;(e.originalEvent?e.originalEvent:e).preventDefault();break;}}}else{e.preventDefault();}
var node=dragi.el.node,o,next=node.nextSibling,parent=node.parentNode,display=node.style.display;g.win.opera&&parent.removeChild(node);node.style.display="none";o=dragi.el.paper.getElementByPoint(x,y);node.style.display=display;g.win.opera&&(next?parent.insertBefore(node,next):parent.appendChild(node));o&&eve("raphael.drag.over."+dragi.el.id,dragi.el,o);x+=scrollX;y+=scrollY;eve("raphael.drag.move."+dragi.el.id,dragi.move_scope||dragi.el,x-dragi.el._drag.x,y-dragi.el._drag.y,x,y,e);}},dragUp=function(e){R.unmousemove(dragMove).unmouseup(dragUp);var i=drag.length,dragi;while(i--){dragi=drag[i];dragi.el._drag={};eve("raphael.drag.end."+dragi.el.id,dragi.end_scope||dragi.start_scope||dragi.move_scope||dragi.el,e);}
drag=[];},elproto=R.el={};for(var i=events.length;i--;){(function(eventName){R[eventName]=elproto[eventName]=function(fn,scope){if(R.is(fn,"function")){this.events=this.events||[];this.events.push({name:eventName,f:fn,unbind:addEvent(this.shape||this.node||g.doc,eventName,fn,scope||this)});}
return this;};R["un"+eventName]=elproto["un"+eventName]=function(fn){var events=this.events||[],l=events.length;while(l--){if(events[l].name==eventName&&(R.is(fn,"undefined")||events[l].f==fn)){events[l].unbind();events.splice(l,1);!events.length&&delete this.events;}}
return this;};})(events[i]);}
elproto.data=function(key,value){var data=eldata[this.id]=eldata[this.id]||{};if(arguments.length==0){return data;}
if(arguments.length==1){if(R.is(key,"object")){for(var i in key)if(key[has](i)){this.data(i,key[i]);}
return this;}
eve("raphael.data.get."+this.id,this,data[key],key);return data[key];}
data[key]=value;eve("raphael.data.set."+this.id,this,value,key);return this;};elproto.removeData=function(key){if(key==null){eldata[this.id]={};}else{eldata[this.id]&&delete eldata[this.id][key];}
return this;};elproto.getData=function(){return clone(eldata[this.id]||{});};elproto.hover=function(f_in,f_out,scope_in,scope_out){return this.mouseover(f_in,scope_in).mouseout(f_out,scope_out||scope_in);};elproto.unhover=function(f_in,f_out){return this.unmouseover(f_in).unmouseout(f_out);};var draggable=[];elproto.drag=function(onmove,onstart,onend,move_scope,start_scope,end_scope){function start(e){(e.originalEvent||e).preventDefault();var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;this._drag.id=e.identifier;if(supportsTouch&&e.touches){var i=e.touches.length,touch;while(i--){touch=e.touches[i];this._drag.id=touch.identifier;if(touch.identifier==this._drag.id){x=touch.clientX;y=touch.clientY;break;}}}
this._drag.x=x+scrollX;this._drag.y=y+scrollY;!drag.length&&R.mousemove(dragMove).mouseup(dragUp);drag.push({el:this,move_scope:move_scope,start_scope:start_scope,end_scope:end_scope});onstart&&eve.on("raphael.drag.start."+this.id,onstart);onmove&&eve.on("raphael.drag.move."+this.id,onmove);onend&&eve.on("raphael.drag.end."+this.id,onend);eve("raphael.drag.start."+this.id,start_scope||move_scope||this,e.clientX+scrollX,e.clientY+scrollY,e);}
this._drag={};draggable.push({el:this,start:start});this.mousedown(start);return this;};elproto.onDragOver=function(f){f?eve.on("raphael.drag.over."+this.id,f):eve.unbind("raphael.drag.over."+this.id);};elproto.undrag=function(){var i=draggable.length;while(i--)if(draggable[i].el==this){this.unmousedown(draggable[i].start);draggable.splice(i,1);eve.unbind("raphael.drag.*."+this.id);}!draggable.length&&R.unmousemove(dragMove).unmouseup(dragUp);drag=[];};paperproto.circle=function(x,y,r){var out=R._engine.circle(this,x||0,y||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.rect=function(x,y,w,h,r){var out=R._engine.rect(this,x||0,y||0,w||0,h||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.ellipse=function(x,y,rx,ry){var out=R._engine.ellipse(this,x||0,y||0,rx||0,ry||0);this.__set__&&this.__set__.push(out);return out;};paperproto.path=function(pathString){pathString&&!R.is(pathString,string)&&!R.is(pathString[0],array)&&(pathString+=E);var out=R._engine.path(R.format[apply](R,arguments),this);this.__set__&&this.__set__.push(out);return out;};paperproto.image=function(src,x,y,w,h){var out=R._engine.image(this,src||"about:blank",x||0,y||0,w||0,h||0);this.__set__&&this.__set__.push(out);return out;};paperproto.text=function(x,y,text){var out=R._engine.text(this,x||0,y||0,Str(text));this.__set__&&this.__set__.push(out);return out;};paperproto.set=function(itemsArray){!R.is(itemsArray,"array")&&(itemsArray=Array.prototype.splice.call(arguments,0,arguments.length));var out=new Set(itemsArray);this.__set__&&this.__set__.push(out);out["paper"]=this;out["type"]="set";return out;};paperproto.setStart=function(set){this.__set__=set||this.set();};paperproto.setFinish=function(set){var out=this.__set__;delete this.__set__;return out;};paperproto.setSize=function(width,height){return R._engine.setSize.call(this,width,height);};paperproto.setViewBox=function(x,y,w,h,fit){return R._engine.setViewBox.call(this,x,y,w,h,fit);};paperproto.top=paperproto.bottom=null;paperproto.raphael=R;var getOffset=function(elem){var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,body=doc.body,docElem=doc.documentElement,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+(g.win.pageYOffset||docElem.scrollTop||body.scrollTop)-clientTop,left=box.left+(g.win.pageXOffset||docElem.scrollLeft||body.scrollLeft)-clientLeft;return{y:top,x:left};};paperproto.getElementByPoint=function(x,y){var paper=this,svg=paper.canvas,target=g.doc.elementFromPoint(x,y);if(g.win.opera&&target.tagName=="svg"){var so=getOffset(svg),sr=svg.createSVGRect();sr.x=x-so.x;sr.y=y-so.y;sr.width=sr.height=1;var hits=svg.getIntersectionList(sr,null);if(hits.length){target=hits[hits.length-1];}}
if(!target){return null;}
while(target.parentNode&&target!=svg.parentNode&&!target.raphael){target=target.parentNode;}
target==paper.canvas.parentNode&&(target=svg);target=target&&target.raphael?paper.getById(target.raphaelid):null;return target;};paperproto.getElementsByBBox=function(bbox){var set=this.set();this.forEach(function(el){if(R.isBBoxIntersect(el.getBBox(),bbox)){set.push(el);}});return set;};paperproto.getById=function(id){var bot=this.bottom;while(bot){if(bot.id==id){return bot;}
bot=bot.next;}
return null;};paperproto.forEach=function(callback,thisArg){var bot=this.bottom;while(bot){if(callback.call(thisArg,bot)===false){return this;}
bot=bot.next;}
return this;};paperproto.getElementsByPoint=function(x,y){var set=this.set();this.forEach(function(el){if(el.isPointInside(x,y)){set.push(el);}});return set;};function x_y(){return this.x+S+this.y;}
function x_y_w_h(){return this.x+S+this.y+S+this.width+" \xd7 "+this.height;}
elproto.isPointInside=function(x,y){var rp=this.realPath=getPath[this.type](this);if(this.attr('transform')&&this.attr('transform').length){rp=R.transformPath(rp,this.attr('transform'));}
return R.isPointInsidePath(rp,x,y);};elproto.getBBox=function(isWithoutTransform){if(this.removed){return{};}
var _=this._;if(isWithoutTransform){if(_.dirty||!_.bboxwt){this.realPath=getPath[this.type](this);_.bboxwt=pathDimensions(this.realPath);_.bboxwt.toString=x_y_w_h;_.dirty=0;}
return _.bboxwt;}
if(_.dirty||_.dirtyT||!_.bbox){if(_.dirty||!this.realPath){_.bboxwt=0;this.realPath=getPath[this.type](this);}
_.bbox=pathDimensions(mapPath(this.realPath,this.matrix));_.bbox.toString=x_y_w_h;_.dirty=_.dirtyT=0;}
return _.bbox;};elproto.clone=function(){if(this.removed){return null;}
var out=this.paper[this.type]().attr(this.attr());this.__set__&&this.__set__.push(out);return out;};elproto.glow=function(glow){if(this.type=="text"){return null;}
glow=glow||{};var s={width:(glow.width||10)+(+this.attr("stroke-width")||1),fill:glow.fill||false,opacity:glow.opacity||.5,offsetx:glow.offsetx||0,offsety:glow.offsety||0,color:glow.color||"#000"},c=s.width/2,r=this.paper,out=r.set(),path=this.realPath||getPath[this.type](this);path=this.matrix?mapPath(path,this.matrix):path;for(var i=1;i<c+1;i++){out.push(r.path(path).attr({stroke:s.color,fill:s.fill?s.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(s.width/c*i).toFixed(3),opacity:+(s.opacity/c).toFixed(3)}));}
return out.insertBefore(this).translate(s.offsetx,s.offsety);};var curveslengths={},getPointAtSegmentLength=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length){if(length==null){return bezlen(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y);}else{return R.findDotsAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,getTatLen(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length));}},getLengthFactory=function(istotal,subpath){return function(path,length,onlystart){path=path2curve(path);var x,y,p,l,sp="",subpaths={},point,len=0;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=+p[1];y=+p[2];}else{l=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);if(len+l>length){if(subpath&&!subpaths.start){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);sp+=["C"+point.start.x,point.start.y,point.m.x,point.m.y,point.x,point.y];if(onlystart){return sp;}
subpaths.start=sp;sp=["M"+point.x,point.y+"C"+point.n.x,point.n.y,point.end.x,point.end.y,p[5],p[6]].join();len+=l;x=+p[5];y=+p[6];continue;}
if(!istotal&&!subpath){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);return{x:point.x,y:point.y,alpha:point.alpha};}}
len+=l;x=+p[5];y=+p[6];}
sp+=p.shift()+p;}
subpaths.end=sp;point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[0],p[1],p[2],p[3],p[4],p[5],1);point.alpha&&(point={x:point.x,y:point.y,alpha:point.alpha});return point;};};var getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);R.getTotalLength=getTotalLength;R.getPointAtLength=getPointAtLength;R.getSubpath=function(path,from,to){if(this.getTotalLength(path)-to<1e-6){return getSubpathsAtLength(path,from).end;}
var a=getSubpathsAtLength(path,to,1);return from?getSubpathsAtLength(a,from).end:a;};elproto.getTotalLength=function(){var path=this.getPath();if(!path){return;}
if(this.node.getTotalLength){return this.node.getTotalLength();}
return getTotalLength(path);};elproto.getPointAtLength=function(length){var path=this.getPath();if(!path){return;}
return getPointAtLength(path,length);};elproto.getPath=function(){var path,getPath=R._getPath[this.type];if(this.type=="text"||this.type=="set"){return;}
if(getPath){path=getPath(this);}
return path;};elproto.getSubpath=function(from,to){var path=this.getPath();if(!path){return;}
return R.getSubpath(path,from,to);};var ef=R.easing_formulas={linear:function(n){return n;},"<":function(n){return pow(n,1.7);},">":function(n){return pow(n,.48);},"<>":function(n){var q=.48-n/1.04,Q=math.sqrt(.1734+q*q),x=Q-q,X=pow(abs(x),1/3)*(x<0?-1:1),y=-Q-q,Y=pow(abs(y),1/3)*(y<0?-1:1),t=X+Y+.5;return(1-t)*3*t*t+t*t*t;},backIn:function(n){var s=1.70158;return n*n*((s+1)*n-s);},backOut:function(n){n=n-1;var s=1.70158;return n*n*((s+1)*n+s)+1;},elastic:function(n){if(n==!!n){return n;}
return pow(2,-10*n)*math.sin((n-.075)*(2*PI)/.3)+1;},bounce:function(n){var s=7.5625,p=2.75,l;if(n<(1/p)){l=s*n*n;}else{if(n<(2/p)){n-=(1.5/p);l=s*n*n+.75;}else{if(n<(2.5/p)){n-=(2.25/p);l=s*n*n+.9375;}else{n-=(2.625/p);l=s*n*n+.984375;}}}
return l;}};ef.easeIn=ef["ease-in"]=ef["<"];ef.easeOut=ef["ease-out"]=ef[">"];ef.easeInOut=ef["ease-in-out"]=ef["<>"];ef["back-in"]=ef.backIn;ef["back-out"]=ef.backOut;var animationElements=[],requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(callback,16);},animation=function(){var Now=+new Date,l=0;for(;l<animationElements.length;l++){var e=animationElements[l];if(e.el.removed||e.paused){continue;}
var time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,t=e.t,that=e.el,set={},now,init={},key;if(e.initstatus){time=(e.initstatus*e.anim.top-e.prev)/(e.percent-e.prev)*ms;e.status=e.initstatus;delete e.initstatus;e.stop&&animationElements.splice(l--,1);}else{e.status=(e.prev+(e.percent-e.prev)*(time/ms))/e.anim.top;}
if(time<0){continue;}
if(time<ms){var pos=easing(time/ms);for(var attr in from)if(from[has](attr)){switch(availableAnimAttrs[attr]){case nu:now=+from[attr]+pos*ms*diff[attr];break;case"colour":now="rgb("+[upto255(round(from[attr].r+pos*ms*diff[attr].r)),upto255(round(from[attr].g+pos*ms*diff[attr].g)),upto255(round(from[attr].b+pos*ms*diff[attr].b))].join(",")+")";break;case"path":now=[];for(var i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(var j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j];}
now[i]=now[i].join(S);}
now=now.join(S);break;case"transform":if(diff[attr].real){now=[];for(i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=from[attr][i][j]+pos*ms*diff[attr][i][j];}}}else{var get=function(i){return+from[attr][i]+pos*ms*diff[attr][i];};now=[["m",get(0),get(1),get(2),get(3),get(4),get(5)]];}
break;case"csv":if(attr=="clip-rect"){now=[];i=4;while(i--){now[i]=+from[attr][i]+pos*ms*diff[attr][i];}}
break;default:var from2=[][concat](from[attr]);now=[];i=that.paper.customAttributes[attr].length;while(i--){now[i]=+from2[i]+pos*ms*diff[attr][i];}
break;}
set[attr]=now;}
that.attr(set);(function(id,that,anim){setTimeout(function(){eve("raphael.anim.frame."+id,that,anim);});})(that.id,that,e.anim);}else{(function(f,el,a){setTimeout(function(){eve("raphael.anim.frame."+el.id,el,a);eve("raphael.anim.finish."+el.id,el,a);R.is(f,"function")&&f.call(el);});})(e.callback,that,e.anim);that.attr(to);animationElements.splice(l--,1);if(e.repeat>1&&!e.next){for(key in to)if(to[has](key)){init[key]=e.totalOrigin[key];}
e.el.attr(init);runAnimation(e.anim,e.el,e.anim.percents[0],null,e.totalOrigin,e.repeat-1);}
if(e.next&&!e.stop){runAnimation(e.anim,e.el,e.next,null,e.totalOrigin,e.repeat);}}}
R.svg&&that&&that.paper&&that.paper.safari();animationElements.length&&requestAnimFrame(animation);},upto255=function(color){return color>255?255:color<0?0:color;};elproto.animateWith=function(el,anim,params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var a=params instanceof Animation?params:R.animation(params,ms,easing,callback),x,y;runAnimation(a,element,a.percents[0],null,element.attr());for(var i=0,ii=animationElements.length;i<ii;i++){if(animationElements[i].anim==anim&&animationElements[i].el==el){animationElements[ii-1].start=animationElements[i].start;break;}}
return element;};function CubicBezierAtTime(t,p1x,p1y,p2x,p2y,duration){var cx=3*p1x,bx=3*(p2x-p1x)-cx,ax=1-cx-bx,cy=3*p1y,by=3*(p2y-p1y)-cy,ay=1-cy-by;function sampleCurveX(t){return((ax*t+bx)*t+cx)*t;}
function solve(x,epsilon){var t=solveCurveX(x,epsilon);return((ay*t+by)*t+cy)*t;}
function solveCurveX(x,epsilon){var t0,t1,t2,x2,d2,i;for(t2=x,i=0;i<8;i++){x2=sampleCurveX(t2)-x;if(abs(x2)<epsilon){return t2;}
d2=(3*ax*t2+2*bx)*t2+cx;if(abs(d2)<1e-6){break;}
t2=t2-x2/d2;}
t0=0;t1=1;t2=x;if(t2<t0){return t0;}
if(t2>t1){return t1;}
while(t0<t1){x2=sampleCurveX(t2);if(abs(x2-x)<epsilon){return t2;}
if(x>x2){t0=t2;}else{t1=t2;}
t2=(t1-t0)/2+t0;}
return t2;}
return solve(t,1/(200*duration));}
elproto.onAnimation=function(f){f?eve.on("raphael.anim.frame."+this.id,f):eve.unbind("raphael.anim.frame."+this.id);return this;};function Animation(anim,ms){var percents=[],newAnim={};this.ms=ms;this.times=1;if(anim){for(var attr in anim)if(anim[has](attr)){newAnim[toFloat(attr)]=anim[attr];percents.push(toFloat(attr));}
percents.sort(sortByNumber);}
this.anim=newAnim;this.top=percents[percents.length-1];this.percents=percents;}
Animation.prototype.delay=function(delay){var a=new Animation(this.anim,this.ms);a.times=this.times;a.del=+delay||0;return a;};Animation.prototype.repeat=function(times){var a=new Animation(this.anim,this.ms);a.del=this.del;a.times=math.floor(mmax(times,0))||1;return a;};function runAnimation(anim,element,percent,status,totalOrigin,times){percent=toFloat(percent);var params,isInAnim,isInAnimSet,percents=[],next,prev,timestamp,ms=anim.ms,from={},to={},diff={};if(status){for(i=0,ii=animationElements.length;i<ii;i++){var e=animationElements[i];if(e.el.id==element.id&&e.anim==anim){if(e.percent!=percent){animationElements.splice(i,1);isInAnimSet=1;}else{isInAnim=e;}
element.attr(e.totalOrigin);break;}}}else{status=+to;}
for(var i=0,ii=anim.percents.length;i<ii;i++){if(anim.percents[i]==percent||anim.percents[i]>status*anim.top){percent=anim.percents[i];prev=anim.percents[i-1]||0;ms=ms/anim.top*(percent-prev);next=anim.percents[i+1];params=anim.anim[percent];break;}else if(status){element.attr(anim.anim[anim.percents[i]]);}}
if(!params){return;}
if(!isInAnim){for(var attr in params)if(params[has](attr)){if(availableAnimAttrs[has](attr)||element.paper.customAttributes[has](attr)){from[attr]=element.attr(attr);(from[attr]==null)&&(from[attr]=availableAttrs[attr]);to[attr]=params[attr];switch(availableAnimAttrs[attr]){case nu:diff[attr]=(to[attr]-from[attr])/ms;break;case"colour":from[attr]=R.getRGB(from[attr]);var toColour=R.getRGB(to[attr]);diff[attr]={r:(toColour.r-from[attr].r)/ms,g:(toColour.g-from[attr].g)/ms,b:(toColour.b-from[attr].b)/ms};break;case"path":var pathes=path2curve(from[attr],to[attr]),toPath=pathes[1];from[attr]=pathes[0];diff[attr]=[];for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[0];for(var j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms;}}
break;case"transform":var _=element._,eq=equaliseTransform(_[attr],to[attr]);if(eq){from[attr]=eq.from;to[attr]=eq.to;diff[attr]=[];diff[attr].real=true;for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(to[attr][i][j]-from[attr][i][j])/ms;}}}else{var m=(element.matrix||new Matrix),to2={_:{transform:_.transform},getBBox:function(){return element.getBBox(1);}};from[attr]=[m.a,m.b,m.c,m.d,m.e,m.f];extractTransform(to2,to[attr]);to[attr]=to2._.transform;diff[attr]=[(to2.matrix.a-m.a)/ms,(to2.matrix.b-m.b)/ms,(to2.matrix.c-m.c)/ms,(to2.matrix.d-m.d)/ms,(to2.matrix.e-m.e)/ms,(to2.matrix.f-m.f)/ms];}
break;case"csv":var values=Str(params[attr])[split](separator),from2=Str(from[attr])[split](separator);if(attr=="clip-rect"){from[attr]=from2;diff[attr]=[];i=from2.length;while(i--){diff[attr][i]=(values[i]-from[attr][i])/ms;}}
to[attr]=values;break;default:values=[][concat](params[attr]);from2=[][concat](from[attr]);diff[attr]=[];i=element.paper.customAttributes[attr].length;while(i--){diff[attr][i]=((values[i]||0)-(from2[i]||0))/ms;}
break;}}}
var easing=params.easing,easyeasy=R.easing_formulas[easing];if(!easyeasy){easyeasy=Str(easing).match(bezierrg);if(easyeasy&&easyeasy.length==5){var curve=easyeasy;easyeasy=function(t){return CubicBezierAtTime(t,+curve[1],+curve[2],+curve[3],+curve[4],ms);};}else{easyeasy=pipe;}}
timestamp=params.start||anim.start||+new Date;e={anim:anim,percent:percent,timestamp:timestamp,start:timestamp+(anim.del||0),status:0,initstatus:status||0,stop:false,ms:ms,easing:easyeasy,from:from,diff:diff,to:to,el:element,callback:params.callback,prev:prev,next:next,repeat:times||anim.times,origin:element.attr(),totalOrigin:totalOrigin};animationElements.push(e);if(status&&!isInAnim&&!isInAnimSet){e.stop=true;e.start=new Date-ms*status;if(animationElements.length==1){return animation();}}
if(isInAnimSet){e.start=new Date-e.ms*status;}
animationElements.length==1&&requestAnimFrame(animation);}else{isInAnim.initstatus=status;isInAnim.start=new Date-isInAnim.ms*status;}
eve("raphael.anim.start."+element.id,element,anim);}
R.animation=function(params,ms,easing,callback){if(params instanceof Animation){return params;}
if(R.is(easing,"function")||!easing){callback=callback||easing||null;easing=null;}
params=Object(params);ms=+ms||0;var p={},json,attr;for(attr in params)if(params[has](attr)&&toFloat(attr)!=attr&&toFloat(attr)+"%"!=attr){json=true;p[attr]=params[attr];}
if(!json){return new Animation(params,ms);}else{easing&&(p.easing=easing);callback&&(p.callback=callback);return new Animation({100:p},ms);}};elproto.animate=function(params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var anim=params instanceof Animation?params:R.animation(params,ms,easing,callback);runAnimation(anim,element,anim.percents[0],null,element.attr());return element;};elproto.setTime=function(anim,value){if(anim&&value!=null){this.status(anim,mmin(value,anim.ms)/anim.ms);}
return this;};elproto.status=function(anim,value){var out=[],i=0,len,e;if(value!=null){runAnimation(anim,this,-1,mmin(value,1));return this;}else{len=animationElements.length;for(;i<len;i++){e=animationElements[i];if(e.el.id==this.id&&(!anim||e.anim==anim)){if(anim){return e.status;}
out.push({anim:e.anim,status:e.status});}}
if(anim){return 0;}
return out;}};elproto.pause=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("raphael.anim.pause."+this.id,this,animationElements[i].anim)!==false){animationElements[i].paused=true;}}
return this;};elproto.resume=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){var e=animationElements[i];if(eve("raphael.anim.resume."+this.id,this,e.anim)!==false){delete e.paused;this.status(e.anim,e.status);}}
return this;};elproto.stop=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("raphael.anim.stop."+this.id,this,animationElements[i].anim)!==false){animationElements.splice(i--,1);}}
return this;};function stopAnimation(paper){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.paper==paper){animationElements.splice(i--,1);}}
eve.on("raphael.remove",stopAnimation);eve.on("raphael.clear",stopAnimation);elproto.toString=function(){return"Rapha\xebl\u2019s object";};var Set=function(items){this.items=[];this.length=0;this.type="set";if(items){for(var i=0,ii=items.length;i<ii;i++){if(items[i]&&(items[i].constructor==elproto.constructor||items[i].constructor==Set)){this[this.items.length]=this.items[this.items.length]=items[i];this.length++;}}}},setproto=Set.prototype;setproto.push=function(){var item,len;for(var i=0,ii=arguments.length;i<ii;i++){item=arguments[i];if(item&&(item.constructor==elproto.constructor||item.constructor==Set)){len=this.items.length;this[len]=this.items[len]=item;this.length++;}}
return this;};setproto.pop=function(){this.length&&delete this[this.length--];return this.items.pop();};setproto.forEach=function(callback,thisArg){for(var i=0,ii=this.items.length;i<ii;i++){if(callback.call(thisArg,this.items[i],i)===false){return this;}}
return this;};for(var method in elproto)if(elproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname][apply](el,arg);});};})(method);}
setproto.attr=function(name,value){if(name&&R.is(name,array)&&R.is(name[0],"object")){for(var j=0,jj=name.length;j<jj;j++){this.items[j].attr(name[j]);}}else{for(var i=0,ii=this.items.length;i<ii;i++){this.items[i].attr(name,value);}}
return this;};setproto.clear=function(){while(this.length){this.pop();}};setproto.splice=function(index,count,insertion){index=index<0?mmax(this.length+index,0):index;count=mmax(0,mmin(this.length-index,count));var tail=[],todel=[],args=[],i;for(i=2;i<arguments.length;i++){args.push(arguments[i]);}
for(i=0;i<count;i++){todel.push(this[index+i]);}
for(;i<this.length-index;i++){tail.push(this[index+i]);}
var arglen=args.length;for(i=0;i<arglen+tail.length;i++){this.items[index+i]=this[index+i]=i<arglen?args[i]:tail[i-arglen];}
i=this.items.length=this.length-=count-arglen;while(this[i]){delete this[i++];}
return new Set(todel);};setproto.exclude=function(el){for(var i=0,ii=this.length;i<ii;i++)if(this[i]==el){this.splice(i,1);return true;}};setproto.animate=function(params,ms,easing,callback){(R.is(easing,"function")||!easing)&&(callback=easing||null);var len=this.items.length,i=len,item,set=this,collector;if(!len){return this;}
callback&&(collector=function(){!--len&&callback.call(set);});easing=R.is(easing,string)?easing:collector;var anim=R.animation(params,ms,easing,collector);item=this.items[--i].animate(anim);while(i--){this.items[i]&&!this.items[i].removed&&this.items[i].animateWith(item,anim,anim);(this.items[i]&&!this.items[i].removed)||len--;}
return this;};setproto.insertAfter=function(el){var i=this.items.length;while(i--){this.items[i].insertAfter(el);}
return this;};setproto.getBBox=function(){var x=[],y=[],x2=[],y2=[];for(var i=this.items.length;i--;)if(!this.items[i].removed){var box=this.items[i].getBBox();x.push(box.x);y.push(box.y);x2.push(box.x+box.width);y2.push(box.y+box.height);}
x=mmin[apply](0,x);y=mmin[apply](0,y);x2=mmax[apply](0,x2);y2=mmax[apply](0,y2);return{x:x,y:y,x2:x2,y2:y2,width:x2-x,height:y2-y};};setproto.clone=function(s){s=this.paper.set();for(var i=0,ii=this.items.length;i<ii;i++){s.push(this.items[i].clone());}
return s;};setproto.toString=function(){return"Rapha\xebl\u2018s set";};setproto.glow=function(glowConfig){var ret=this.paper.set();this.forEach(function(shape,index){var g=shape.glow(glowConfig);if(g!=null){g.forEach(function(shape2,index2){ret.push(shape2);});}});return ret;};setproto.isPointInside=function(x,y){var isPointInside=false;this.forEach(function(el){if(el.isPointInside(x,y)){isPointInside=true;return false;}});return isPointInside;};R.registerFont=function(font){if(!font.face){return font;}
this.fonts=this.fonts||{};var fontcopy={w:font.w,face:{},glyphs:{}},family=font.face["font-family"];for(var prop in font.face)if(font.face[has](prop)){fontcopy.face[prop]=font.face[prop];}
if(this.fonts[family]){this.fonts[family].push(fontcopy);}else{this.fonts[family]=[fontcopy];}
if(!font.svg){fontcopy.face["units-per-em"]=toInt(font.face["units-per-em"],10);for(var glyph in font.glyphs)if(font.glyphs[has](glyph)){var path=font.glyphs[glyph];fontcopy.glyphs[glyph]={w:path.w,k:{},d:path.d&&"M"+path.d.replace(/[mlcxtrv]/g,function(command){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[command]||"M";})+"z"};if(path.k){for(var k in path.k)if(path[has](k)){fontcopy.glyphs[glyph].k[k]=path.k[k];}}}}
return font;};paperproto.getFont=function(family,weight,style,stretch){stretch=stretch||"normal";style=style||"normal";weight=+weight||{normal:400,bold:700,lighter:300,bolder:800}[weight]||400;if(!R.fonts){return;}
var font=R.fonts[family];if(!font){var name=new RegExp("(^|\\s)"+family.replace(/[^\w\d\s+!~.:_-]/g,E)+"(\\s|$)","i");for(var fontName in R.fonts)if(R.fonts[has](fontName)){if(name.test(fontName)){font=R.fonts[fontName];break;}}}
var thefont;if(font){for(var i=0,ii=font.length;i<ii;i++){thefont=font[i];if(thefont.face["font-weight"]==weight&&(thefont.face["font-style"]==style||!thefont.face["font-style"])&&thefont.face["font-stretch"]==stretch){break;}}}
return thefont;};paperproto.print=function(x,y,string,font,size,origin,letter_spacing,line_spacing){origin=origin||"middle";letter_spacing=mmax(mmin(letter_spacing||0,1),-1);line_spacing=mmax(mmin(line_spacing||1,3),1);var letters=Str(string)[split](E),shift=0,notfirst=0,path=E,scale;R.is(font,"string")&&(font=this.getFont(font));if(font){scale=(size||16)/font.face["units-per-em"];var bb=font.face.bbox[split](separator),top=+bb[0],lineHeight=bb[3]-bb[1],shifty=0,height=+bb[1]+(origin=="baseline"?lineHeight+(+font.face.descent):lineHeight/2);for(var i=0,ii=letters.length;i<ii;i++){if(letters[i]=="\n"){shift=0;curr=0;notfirst=0;shifty+=lineHeight*line_spacing;}else{var prev=notfirst&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];shift+=notfirst?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0)+(font.w*letter_spacing):0;notfirst=1;}
if(curr&&curr.d){path+=R.transformPath(curr.d,["t",shift*scale,shifty*scale,"s",scale,scale,top,height,"t",(x-top)/scale,(y-height)/scale]);}}}
return this.path(path).attr({fill:"#000",stroke:"none"});};paperproto.add=function(json){if(R.is(json,"array")){var res=this.set(),i=0,ii=json.length,j;for(;i<ii;i++){j=json[i]||{};elements[has](j.type)&&res.push(this[j.type]().attr(j));}}
return res;};R.format=function(token,params){var args=R.is(params,array)?[0][concat](params):arguments;token&&R.is(token,string)&&args.length-1&&(token=token.replace(formatrg,function(str,i){return args[++i]==null?E:args[i];}));return token||E;};R.fullfill=(function(){var tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,replacer=function(all,key,obj){var res=obj;key.replace(objNotationRegex,function(all,name,quote,quotedName,isFunc){name=name||quotedName;if(res){if(name in res){res=res[name];}
typeof res=="function"&&isFunc&&(res=res());}});res=(res==null||res==obj?all:res)+"";return res;};return function(str,obj){return String(str).replace(tokenRegex,function(all,key){return replacer(all,key,obj);});};})();R.ninja=function(){oldRaphael.was?(g.win.Raphael=oldRaphael.is):delete Raphael;return R;};R.st=setproto;(function(doc,loaded,f){if(doc.readyState==null&&doc.addEventListener){doc.addEventListener(loaded,f=function(){doc.removeEventListener(loaded,f,false);doc.readyState="complete";},false);doc.readyState="loading";}
function isLoaded(){(/in/).test(doc.readyState)?setTimeout(isLoaded,9):R.eve("raphael.DOMload");}
isLoaded();})(document,"DOMContentLoaded");eve.on("raphael.DOMload",function(){loaded=true;});(function(){if(!R.svg){return;}
var has="hasOwnProperty",Str=String,toFloat=parseFloat,toInt=parseInt,math=Math,mmax=math.max,abs=math.abs,pow=math.pow,separator=/[, ]+/,eve=R.eve,E="",S=" ";var xlink="http://www.w3.org/1999/xlink",markers={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},markerCounter={};R.toString=function(){return"Your browser supports SVG.\nYou are running Rapha\xebl "+this.version;};var $=function(el,attr){if(attr){if(typeof el=="string"){el=$(el);}
for(var key in attr)if(attr[has](key)){if(key.substring(0,6)=="xlink:"){el.setAttributeNS(xlink,key.substring(6),Str(attr[key]));}else{el.setAttribute(key,Str(attr[key]));}}}else{el=R._g.doc.createElementNS("http://www.w3.org/2000/svg",el);el.style&&(el.style.webkitTapHighlightColor="rgba(0,0,0,0)");}
return el;},addGradientFill=function(element,gradient){var type="linear",id=element.id+gradient,fx=.5,fy=.5,o=element.node,SVG=element.paper,s=o.style,el=R._g.doc.getElementById(id);if(!el){gradient=Str(gradient).replace(R._radial_gradient,function(all,_fx,_fy){type="radial";if(_fx&&_fy){fx=toFloat(_fx);fy=toFloat(_fy);var dir=((fy>.5)*2-1);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*dir+.5)&&fy!=.5&&(fy=fy.toFixed(5)-1e-5*dir);}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}
var vector=[0,0,math.cos(R.rad(angle)),math.sin(R.rad(angle))],max=1/(mmax(abs(vector[2]),abs(vector[3]))||1);vector[2]*=max;vector[3]*=max;if(vector[2]<0){vector[0]=-vector[2];vector[2]=0;}
if(vector[3]<0){vector[1]=-vector[3];vector[3]=0;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
id=id.replace(/[\(\)\s,\xb0#]/g,"_");if(element.gradient&&id!=element.gradient.id){SVG.defs.removeChild(element.gradient);delete element.gradient;}
if(!element.gradient){el=$(type+"Gradient",{id:id});element.gradient=el;$(el,type=="radial"?{fx:fx,fy:fy}:{x1:vector[0],y1:vector[1],x2:vector[2],y2:vector[3],gradientTransform:element.matrix.invert()});SVG.defs.appendChild(el);for(var i=0,ii=dots.length;i<ii;i++){el.appendChild($("stop",{offset:dots[i].offset?dots[i].offset:i?"100%":"0%","stop-color":dots[i].color||"#fff"}));}}}
$(o,{fill:"url(#"+id+")",opacity:1,"fill-opacity":1});s.fill=E;s.opacity=1;s.fillOpacity=1;return 1;},updatePosition=function(o){var bbox=o.getBBox(1);$(o.pattern,{patternTransform:o.matrix.invert()+" translate("+bbox.x+","+bbox.y+")"});},addArrow=function(o,value,isEnd){if(o.type=="path"){var values=Str(value).toLowerCase().split("-"),p=o.paper,se=isEnd?"end":"start",node=o.node,attrs=o.attrs,stroke=attrs["stroke-width"],i=values.length,type="classic",from,to,dx,refX,attr,w=3,h=3,t=5;while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":h=5;break;case"narrow":h=2;break;case"long":w=5;break;case"short":w=2;break;}}
if(type=="open"){w+=2;h+=2;t+=2;dx=1;refX=isEnd?4:1;attr={fill:"none",stroke:attrs.stroke};}else{refX=dx=w/2;attr={fill:attrs.stroke,stroke:"none"};}
if(o._.arrows){if(isEnd){o._.arrows.endPath&&markerCounter[o._.arrows.endPath]--;o._.arrows.endMarker&&markerCounter[o._.arrows.endMarker]--;}else{o._.arrows.startPath&&markerCounter[o._.arrows.startPath]--;o._.arrows.startMarker&&markerCounter[o._.arrows.startMarker]--;}}else{o._.arrows={};}
if(type!="none"){var pathId="raphael-marker-"+type,markerId="raphael-marker-"+se+type+w+h;if(!R._g.doc.getElementById(pathId)){p.defs.appendChild($($("path"),{"stroke-linecap":"round",d:markers[type],id:pathId}));markerCounter[pathId]=1;}else{markerCounter[pathId]++;}
var marker=R._g.doc.getElementById(markerId),use;if(!marker){marker=$($("marker"),{id:markerId,markerHeight:h,markerWidth:w,orient:"auto",refX:refX,refY:h/2});use=$($("use"),{"xlink:href":"#"+pathId,transform:(isEnd?"rotate(180 "+w/2+" "+h/2+") ":E)+"scale("+w/t+","+h/t+")","stroke-width":(1/((w/t+h/t)/2)).toFixed(4)});marker.appendChild(use);p.defs.appendChild(marker);markerCounter[markerId]=1;}else{markerCounter[markerId]++;use=marker.getElementsByTagName("use")[0];}
$(use,attr);var delta=dx*(type!="diamond"&&type!="oval");if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-delta*stroke;}else{from=delta*stroke;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
attr={};attr["marker-"+se]="url(#"+markerId+")";if(to||from){attr.d=R.getSubpath(attrs.path,from,to);}
$(node,attr);o._.arrows[se+"Path"]=pathId;o._.arrows[se+"Marker"]=markerId;o._.arrows[se+"dx"]=delta;o._.arrows[se+"Type"]=type;o._.arrows[se+"String"]=value;}else{if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-from;}else{from=0;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
o._.arrows[se+"Path"]&&$(node,{d:R.getSubpath(attrs.path,from,to)});delete o._.arrows[se+"Path"];delete o._.arrows[se+"Marker"];delete o._.arrows[se+"dx"];delete o._.arrows[se+"Type"];delete o._.arrows[se+"String"];}
for(attr in markerCounter)if(markerCounter[has](attr)&&!markerCounter[attr]){var item=R._g.doc.getElementById(attr);item&&item.parentNode.removeChild(item);}}},dasharray={"":[0],"none":[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},addDashes=function(o,value,params){value=dasharray[Str(value).toLowerCase()];if(value){var width=o.attrs["stroke-width"]||"1",butt={round:width,square:width,butt:0}[o.attrs["stroke-linecap"]||params["stroke-linecap"]]||0,dashes=[],i=value.length;while(i--){dashes[i]=value[i]*width+((i%2)?1:-1)*butt;}
$(o.node,{"stroke-dasharray":dashes.join(",")});}},setFillAndStroke=function(o,params){var node=o.node,attrs=o.attrs,vis=node.style.visibility;node.style.visibility="hidden";for(var att in params){if(params[has](att)){if(!R._availableAttrs[has](att)){continue;}
var value=params[att];attrs[att]=value;switch(att){case"blur":o.blur(value);break;case"title":var title=node.getElementsByTagName("title");if(title.length&&(title=title[0])){title.firstChild.nodeValue=value;}else{title=$("title");var val=R._g.doc.createTextNode(value);title.appendChild(val);node.appendChild(title);}
break;case"href":case"target":var pn=node.parentNode;if(pn.tagName.toLowerCase()!="a"){var hl=$("a");pn.insertBefore(hl,node);hl.appendChild(node);pn=hl;}
if(att=="target"){pn.setAttributeNS(xlink,"show",value=="blank"?"new":value);}else{pn.setAttributeNS(xlink,att,value);}
break;case"cursor":node.style.cursor=value;break;case"transform":o.transform(value);break;case"arrow-start":addArrow(o,value);break;case"arrow-end":addArrow(o,value,1);break;case"clip-rect":var rect=Str(value).split(separator);if(rect.length==4){o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);var el=$("clipPath"),rc=$("rect");el.id=R.createUUID();$(rc,{x:rect[0],y:rect[1],width:rect[2],height:rect[3]});el.appendChild(rc);o.paper.defs.appendChild(el);$(node,{"clip-path":"url(#"+el.id+")"});o.clip=rc;}
if(!value){var path=node.getAttribute("clip-path");if(path){var clip=R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g,E));clip&&clip.parentNode.removeChild(clip);$(node,{"clip-path":E});delete o.clip;}}
break;case"path":if(o.type=="path"){$(node,{d:value?attrs.path=R._pathToAbsolute(value):"M0,0"});o._.dirty=1;if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}}
break;case"width":node.setAttribute(att,value);o._.dirty=1;if(attrs.fx){att="x";value=attrs.x;}else{break;}
case"x":if(attrs.fx){value=-attrs.x-(attrs.width||0);}
case"rx":if(att=="rx"&&o.type=="rect"){break;}
case"cx":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"height":node.setAttribute(att,value);o._.dirty=1;if(attrs.fy){att="y";value=attrs.y;}else{break;}
case"y":if(attrs.fy){value=-attrs.y-(attrs.height||0);}
case"ry":if(att=="ry"&&o.type=="rect"){break;}
case"cy":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"r":if(o.type=="rect"){$(node,{rx:value,ry:value});}else{node.setAttribute(att,value);}
o._.dirty=1;break;case"src":if(o.type=="image"){node.setAttributeNS(xlink,"href",value);}
break;case"stroke-width":if(o._.sx!=1||o._.sy!=1){value/=mmax(abs(o._.sx),abs(o._.sy))||1;}
if(o.paper._vbSize){value*=o.paper._vbSize;}
node.setAttribute(att,value);if(attrs["stroke-dasharray"]){addDashes(o,attrs["stroke-dasharray"],params);}
if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"stroke-dasharray":addDashes(o,value,params);break;case"fill":var isURL=Str(value).match(R._ISURL);if(isURL){el=$("pattern");var ig=$("image");el.id=R.createUUID();$(el,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1});$(ig,{x:0,y:0,"xlink:href":isURL[1]});el.appendChild(ig);(function(el){R._preload(isURL[1],function(){var w=this.offsetWidth,h=this.offsetHeight;$(el,{width:w,height:h});$(ig,{width:w,height:h});o.paper.safari();});})(el);o.paper.defs.appendChild(el);$(node,{fill:"url(#"+el.id+")"});o.pattern=el;o.pattern&&updatePosition(o);break;}
var clr=R.getRGB(value);if(!clr.error){delete params.gradient;delete attrs.gradient;!R.is(attrs.opacity,"undefined")&&R.is(params.opacity,"undefined")&&$(node,{opacity:attrs.opacity});!R.is(attrs["fill-opacity"],"undefined")&&R.is(params["fill-opacity"],"undefined")&&$(node,{"fill-opacity":attrs["fill-opacity"]});}else if((o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value)){if("opacity"in attrs||"fill-opacity"in attrs){var gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){var stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":("opacity"in attrs?attrs.opacity:1)*("fill-opacity"in attrs?attrs["fill-opacity"]:1)});}}
attrs.gradient=value;attrs.fill="none";break;}
clr[has]("opacity")&&$(node,{"fill-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});case"stroke":clr=R.getRGB(value);node.setAttribute(att,clr.hex);att=="stroke"&&clr[has]("opacity")&&$(node,{"stroke-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});if(att=="stroke"&&o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"gradient":(o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value);break;case"opacity":if(attrs.gradient&&!attrs[has]("stroke-opacity")){$(node,{"stroke-opacity":value>1?value/100:value});}
case"fill-opacity":if(attrs.gradient){gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":value});}
break;}
default:att=="font-size"&&(value=toInt(value,10)+"px");var cssrule=att.replace(/(\-.)/g,function(w){return w.substring(1).toUpperCase();});node.style[cssrule]=value;o._.dirty=1;node.setAttribute(att,value);break;}}}
tuneText(o,params);node.style.visibility=vis;},leading=1.2,tuneText=function(el,params){if(el.type!="text"||!(params[has]("text")||params[has]("font")||params[has]("font-size")||params[has]("x")||params[has]("y"))){return;}
var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue("font-size"),10):10;if(params[has]("text")){a.text=params.text;while(node.firstChild){node.removeChild(node.firstChild);}
var texts=Str(params.text).split("\n"),tspans=[],tspan;for(var i=0,ii=texts.length;i<ii;i++){tspan=$("tspan");i&&$(tspan,{dy:fontSize*leading,x:a.x});tspan.appendChild(R._g.doc.createTextNode(texts[i]));node.appendChild(tspan);tspans[i]=tspan;}}else{tspans=node.getElementsByTagName("tspan");for(i=0,ii=tspans.length;i<ii;i++)if(i){$(tspans[i],{dy:fontSize*leading,x:a.x});}else{$(tspans[0],{dy:0});}}
$(node,{x:a.x,y:a.y});el._.dirty=1;var bb=el._getBBox(),dif=a.y-(bb.y+bb.height/2);dif&&R.is(dif,"finite")&&$(tspans[0],{dy:dif});},Element=function(node,svg){var X=0,Y=0;this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.matrix=R.matrix();this.realPath=null;this.paper=svg;this.attrs=this.attrs||{};this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1};!svg.bottom&&(svg.bottom=this);this.prev=svg.top;svg.top&&(svg.top.next=this);svg.top=this;this.next=null;},elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;R._engine.path=function(pathString,SVG){var el=$("path");SVG.canvas&&SVG.canvas.appendChild(el);var p=new Element(el,SVG);p.type="path";setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString});return p;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.transform=function(tstr){var _=this._;if(tstr==null){return _.transform;}
R._extractTransform(this,tstr);this.clip&&$(this.clip,{transform:this.matrix.invert()});this.pattern&&updatePosition(this);this.node&&$(this.node,{transform:this.matrix});if(_.sx!=1||_.sy!=1){var sw=this.attrs[has]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":sw});}
return this;};elproto.hide=function(){!this.removed&&this.paper.safari(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&this.paper.safari(this.node.style.display="");return this;};elproto.remove=function(){if(this.removed||!this.node.parentNode){return;}
var paper=this.paper;paper.__set__&&paper.__set__.exclude(this);eve.unbind("raphael.*.*."+this.id);if(this.gradient){paper.defs.removeChild(this.gradient);}
R._tear(this,paper);if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.removeChild(this.node.parentNode);}else{this.node.parentNode.removeChild(this.node);}
for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto._getBBox=function(){if(this.node.style.display=="none"){this.show();var hide=true;}
var bbox={};try{bbox=this.node.getBBox();}catch(e){}finally{bbox=bbox||{};}
hide&&this.hide();return bbox;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name=="fill"&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
if(name=="transform"){return this._.transform;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
if(value!=null){var params={};params[name]=value;}else if(name!=null&&R.is(name,"object")){params=name;}
for(var key in params){eve("raphael.attr."+key+"."+this.id,this,params[key]);}
for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
setFillAndStroke(this,params);return this;};elproto.toFront=function(){if(this.removed){return this;}
if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.appendChild(this.node.parentNode);}else{this.node.parentNode.appendChild(this.node);}
var svg=this.paper;svg.top!=this&&R._tofront(this,svg);return this;};elproto.toBack=function(){if(this.removed){return this;}
var parent=this.node.parentNode;if(parent.tagName.toLowerCase()=="a"){parent.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild);}else if(parent.firstChild!=this.node){parent.insertBefore(this.node,this.node.parentNode.firstChild);}
R._toback(this,this.paper);var svg=this.paper;return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
var node=element.node||element[element.length-1].node;if(node.nextSibling){node.parentNode.insertBefore(this.node,node.nextSibling);}else{node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
var node=element.node||element[0].node;node.parentNode.insertBefore(this.node,node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var t=this;if(+size!==0){var fltr=$("filter"),blur=$("feGaussianBlur");t.attrs.blur=size;fltr.id=R.createUUID();$(blur,{stdDeviation:+size||1.5});fltr.appendChild(blur);t.paper.defs.appendChild(fltr);t._blur=fltr;$(t.node,{filter:"url(#"+fltr.id+")"});}else{if(t._blur){t._blur.parentNode.removeChild(t._blur);delete t._blur;delete t.attrs.blur;}
t.node.removeAttribute("filter");}
return t;};R._engine.circle=function(svg,x,y,r){var el=$("circle");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,r:r,fill:"none",stroke:"#000"};res.type="circle";$(el,res.attrs);return res;};R._engine.rect=function(svg,x,y,w,h,r){var el=$("rect");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,r:r||0,rx:r||0,ry:r||0,fill:"none",stroke:"#000"};res.type="rect";$(el,res.attrs);return res;};R._engine.ellipse=function(svg,x,y,rx,ry){var el=$("ellipse");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,rx:rx,ry:ry,fill:"none",stroke:"#000"};res.type="ellipse";$(el,res.attrs);return res;};R._engine.image=function(svg,src,x,y,w,h){var el=$("image");$(el,{x:x,y:y,width:w,height:h,preserveAspectRatio:"none"});el.setAttributeNS(xlink,"href",src);svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,src:src};res.type="image";return res;};R._engine.text=function(svg,x,y,text){var el=$("text");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,"text-anchor":"middle",text:text,font:R._availableAttrs.font,stroke:"none",fill:"#000"};res.type="text";setFillAndStroke(res,res.attrs);return res;};R._engine.setSize=function(width,height){this.width=width||this.width;this.height=height||this.height;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height);if(this._viewBox){this.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;if(!container){throw new Error("SVG container not found.");}
var cnvs=$("svg"),css="overflow:hidden;",isFloating;x=x||0;y=y||0;width=width||512;height=height||342;$(cnvs,{height:height,version:1.1,width:width,xmlns:"http://www.w3.org/2000/svg"});if(container==1){cnvs.style.cssText=css+"position:absolute;left:"+x+"px;top:"+y+"px";R._g.doc.body.appendChild(cnvs);isFloating=1;}else{cnvs.style.cssText=css+"position:relative";if(container.firstChild){container.insertBefore(cnvs,container.firstChild);}else{container.appendChild(cnvs);}}
container=new R._Paper;container.width=width;container.height=height;container.canvas=cnvs;container.clear();container._left=container._top=0;isFloating&&(container.renderfix=function(){});container.renderfix();return container;};R._engine.setViewBox=function(x,y,w,h,fit){eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var size=mmax(w/this.width,h/this.height),top=this.top,aspectRatio=fit?"meet":"xMinYMin",vb,sw;if(x==null){if(this._vbSize){size=1;}
delete this._vbSize;vb="0 0 "+this.width+S+this.height;}else{this._vbSize=size;vb=x+S+y+S+w+S+h;}
$(this.canvas,{viewBox:vb,preserveAspectRatio:aspectRatio});while(size&&top){sw="stroke-width"in top.attrs?top.attrs["stroke-width"]:1;top.attr({"stroke-width":sw});top._.dirty=1;top._.dirtyT=1;top=top.prev;}
this._viewBox=[x,y,w,h,!!fit];return this;};R.prototype.renderfix=function(){var cnvs=this.canvas,s=cnvs.style,pos;try{pos=cnvs.getScreenCTM()||cnvs.createSVGMatrix();}catch(e){pos=cnvs.createSVGMatrix();}
var left=-pos.e%1,top=-pos.f%1;if(left||top){if(left){this._left=(this._left+left)%1;s.left=this._left+"px";}
if(top){this._top=(this._top+top)%1;s.top=this._top+"px";}}};R.prototype.clear=function(){R.eve("raphael.clear",this);var c=this.canvas;while(c.firstChild){c.removeChild(c.firstChild);}
this.bottom=this.top=null;(this.desc=$("desc")).appendChild(R._g.doc.createTextNode("Created with Rapha\xebl "+R.version));c.appendChild(this.desc);c.appendChild(this.defs=$("defs"));};R.prototype.remove=function(){eve("raphael.remove",this);this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}})();(function(){if(!R.vml){return;}
var has="hasOwnProperty",Str=String,toFloat=parseFloat,math=Math,round=math.round,mmax=math.max,mmin=math.min,abs=math.abs,fillString="fill",separator=/[, ]+/,eve=R.eve,ms=" progid:DXImageTransform.Microsoft",S=" ",E="",map={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},bites=/([clmz]),?([^clmz]*)/gi,blurregexp=/ progid:\S+Blur\([^\)]+\)/g,val=/-?[^,\s-]+/g,cssDot="position:absolute;left:0;top:0;width:1px;height:1px",zoom=21600,pathTypes={path:1,rect:1,image:1},ovalTypes={circle:1,ellipse:1},path2vml=function(path){var total=/[ahqstv]/ig,command=R._pathToAbsolute;Str(path).match(total)&&(command=R._path2curve);total=/[clmz]/g;if(command==R._pathToAbsolute&&!Str(path).match(total)){var res=Str(path).replace(bites,function(all,command,args){var vals=[],isMove=command.toLowerCase()=="m",res=map[command];args.replace(val,function(value){if(isMove&&vals.length==2){res+=vals+map[command=="m"?"l":"L"];vals=[];}
vals.push(round(value*zoom));});return res+vals;});return res;}
var pa=command(path),p,r;res=[];for(var i=0,ii=pa.length;i<ii;i++){p=pa[i];r=pa[i][0].toLowerCase();r=="z"&&(r="x");for(var j=1,jj=p.length;j<jj;j++){r+=round(p[j]*zoom)+(j!=jj-1?",":E);}
res.push(r);}
return res.join(S);},compensation=function(deg,dx,dy){var m=R.matrix();m.rotate(-deg,.5,.5);return{dx:m.x(dx,dy),dy:m.y(dx,dy)};},setCoords=function(p,sx,sy,dx,dy,deg){var _=p._,m=p.matrix,fillpos=_.fillpos,o=p.node,s=o.style,y=1,flip="",dxdy,kx=zoom/sx,ky=zoom/sy;s.visibility="hidden";if(!sx||!sy){return;}
o.coordsize=abs(kx)+S+abs(ky);s.rotation=deg*(sx*sy<0?-1:1);if(deg){var c=compensation(deg,dx,dy);dx=c.dx;dy=c.dy;}
sx<0&&(flip+="x");sy<0&&(flip+=" y")&&(y=-1);s.flip=flip;o.coordorigin=(dx*-kx)+S+(dy*-ky);if(fillpos||_.fillsize){var fill=o.getElementsByTagName(fillString);fill=fill&&fill[0];o.removeChild(fill);if(fillpos){c=compensation(deg,m.x(fillpos[0],fillpos[1]),m.y(fillpos[0],fillpos[1]));fill.position=c.dx*y+S+c.dy*y;}
if(_.fillsize){fill.size=_.fillsize[0]*abs(sx)+S+_.fillsize[1]*abs(sy);}
o.appendChild(fill);}
s.visibility="visible";};R.toString=function(){return"Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl "+this.version;};var addArrow=function(o,value,isEnd){var values=Str(value).toLowerCase().split("-"),se=isEnd?"end":"start",i=values.length,type="classic",w="medium",h="medium";while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":case"narrow":h=values[i];break;case"long":case"short":w=values[i];break;}}
var stroke=o.node.getElementsByTagName("stroke")[0];stroke[se+"arrow"]=type;stroke[se+"arrowlength"]=w;stroke[se+"arrowwidth"]=h;},setFillAndStroke=function(o,params){o.attrs=o.attrs||{};var node=o.node,a=o.attrs,s=node.style,xy,newpath=pathTypes[o.type]&&(params.x!=a.x||params.y!=a.y||params.width!=a.width||params.height!=a.height||params.cx!=a.cx||params.cy!=a.cy||params.rx!=a.rx||params.ry!=a.ry||params.r!=a.r),isOval=ovalTypes[o.type]&&(a.cx!=params.cx||a.cy!=params.cy||a.r!=params.r||a.rx!=params.rx||a.ry!=params.ry),res=o;for(var par in params)if(params[has](par)){a[par]=params[par];}
if(newpath){a.path=R._getPath[o.type](o);o._.dirty=1;}
params.href&&(node.href=params.href);params.title&&(node.title=params.title);params.target&&(node.target=params.target);params.cursor&&(s.cursor=params.cursor);"blur"in params&&o.blur(params.blur);if(params.path&&o.type=="path"||newpath){node.path=path2vml(~Str(a.path).toLowerCase().indexOf("r")?R._pathToAbsolute(a.path):a.path);if(o.type=="image"){o._.fillpos=[a.x,a.y];o._.fillsize=[a.width,a.height];setCoords(o,1,1,0,0,0);}}"transform"in params&&o.transform(params.transform);if(isOval){var cx=+a.cx,cy=+a.cy,rx=+a.rx||+a.r||0,ry=+a.ry||+a.r||0;node.path=R.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",round((cx-rx)*zoom),round((cy-ry)*zoom),round((cx+rx)*zoom),round((cy+ry)*zoom),round(cx*zoom));o._.dirty=1;}
if("clip-rect"in params){var rect=Str(params["clip-rect"]).split(separator);if(rect.length==4){rect[2]=+rect[2]+(+rect[0]);rect[3]=+rect[3]+(+rect[1]);var div=node.clipRect||R._g.doc.createElement("div"),dstyle=div.style;dstyle.clip=R.format("rect({1}px {2}px {3}px {0}px)",rect);if(!node.clipRect){dstyle.position="absolute";dstyle.top=0;dstyle.left=0;dstyle.width=o.paper.width+"px";dstyle.height=o.paper.height+"px";node.parentNode.insertBefore(div,node);div.appendChild(node);node.clipRect=div;}}
if(!params["clip-rect"]){node.clipRect&&(node.clipRect.style.clip="auto");}}
if(o.textpath){var textpathStyle=o.textpath.style;params.font&&(textpathStyle.font=params.font);params["font-family"]&&(textpathStyle.fontFamily='"'+params["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,E)+'"');params["font-size"]&&(textpathStyle.fontSize=params["font-size"]);params["font-weight"]&&(textpathStyle.fontWeight=params["font-weight"]);params["font-style"]&&(textpathStyle.fontStyle=params["font-style"]);}
if("arrow-start"in params){addArrow(res,params["arrow-start"]);}
if("arrow-end"in params){addArrow(res,params["arrow-end"],1);}
if(params.opacity!=null||params["stroke-width"]!=null||params.fill!=null||params.src!=null||params.stroke!=null||params["stroke-width"]!=null||params["stroke-opacity"]!=null||params["fill-opacity"]!=null||params["stroke-dasharray"]!=null||params["stroke-miterlimit"]!=null||params["stroke-linejoin"]!=null||params["stroke-linecap"]!=null){var fill=node.getElementsByTagName(fillString),newfill=false;fill=fill&&fill[0];!fill&&(newfill=fill=createNode(fillString));if(o.type=="image"&&params.src){fill.src=params.src;}
params.fill&&(fill.on=true);if(fill.on==null||params.fill=="none"||params.fill===null){fill.on=false;}
if(fill.on&&params.fill){var isURL=Str(params.fill).match(R._ISURL);if(isURL){fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=isURL[1];fill.type="tile";var bbox=o.getBBox(1);fill.position=bbox.x+S+bbox.y;o._.fillpos=[bbox.x,bbox.y];R._preload(isURL[1],function(){o._.fillsize=[this.offsetWidth,this.offsetHeight];});}else{fill.color=R.getRGB(params.fill).hex;fill.src=E;fill.type="solid";if(R.getRGB(params.fill).error&&(res.type in{circle:1,ellipse:1}||Str(params.fill).charAt()!="r")&&addGradientFill(res,params.fill,fill)){a.fill="none";a.gradient=params.fill;fill.rotate=false;}}}
if("fill-opacity"in params||"opacity"in params){var opacity=((+a["fill-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+R.getRGB(params.fill).o+1||2)-1);opacity=mmin(mmax(opacity,0),1);fill.opacity=opacity;if(fill.src){fill.color="none";}}
node.appendChild(fill);var stroke=(node.getElementsByTagName("stroke")&&node.getElementsByTagName("stroke")[0]),newstroke=false;!stroke&&(newstroke=stroke=createNode("stroke"));if((params.stroke&&params.stroke!="none")||params["stroke-width"]||params["stroke-opacity"]!=null||params["stroke-dasharray"]||params["stroke-miterlimit"]||params["stroke-linejoin"]||params["stroke-linecap"]){stroke.on=true;}
(params.stroke=="none"||params.stroke===null||stroke.on==null||params.stroke==0||params["stroke-width"]==0)&&(stroke.on=false);var strokeColor=R.getRGB(params.stroke);stroke.on&&params.stroke&&(stroke.color=strokeColor.hex);opacity=((+a["stroke-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+strokeColor.o+1||2)-1);var width=(toFloat(params["stroke-width"])||1)*.75;opacity=mmin(mmax(opacity,0),1);params["stroke-width"]==null&&(width=a["stroke-width"]);params["stroke-width"]&&(stroke.weight=width);width&&width<1&&(opacity*=width)&&(stroke.weight=1);stroke.opacity=opacity;params["stroke-linejoin"]&&(stroke.joinstyle=params["stroke-linejoin"]||"miter");stroke.miterlimit=params["stroke-miterlimit"]||8;params["stroke-linecap"]&&(stroke.endcap=params["stroke-linecap"]=="butt"?"flat":params["stroke-linecap"]=="square"?"square":"round");if("stroke-dasharray"in params){var dasharray={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};stroke.dashstyle=dasharray[has](params["stroke-dasharray"])?dasharray[params["stroke-dasharray"]]:E;}
newstroke&&node.appendChild(stroke);}
if(res.type=="text"){res.paper.canvas.style.display=E;var span=res.paper.span,m=100,fontSize=a.font&&a.font.match(/\d+(?:\.\d*)?(?=px)/);s=span.style;a.font&&(s.font=a.font);a["font-family"]&&(s.fontFamily=a["font-family"]);a["font-weight"]&&(s.fontWeight=a["font-weight"]);a["font-style"]&&(s.fontStyle=a["font-style"]);fontSize=toFloat(a["font-size"]||fontSize&&fontSize[0])||10;s.fontSize=fontSize*m+"px";res.textpath.string&&(span.innerHTML=Str(res.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var brect=span.getBoundingClientRect();res.W=a.w=(brect.right-brect.left)/m;res.H=a.h=(brect.bottom-brect.top)/m;res.X=a.x;res.Y=a.y+res.H/2;("x"in params||"y"in params)&&(res.path.v=R.format("m{0},{1}l{2},{1}",round(a.x*zoom),round(a.y*zoom),round(a.x*zoom)+1));var dirtyattrs=["x","y","text","font","font-family","font-weight","font-style","font-size"];for(var d=0,dd=dirtyattrs.length;d<dd;d++)if(dirtyattrs[d]in params){res._.dirty=1;break;}
switch(a["text-anchor"]){case"start":res.textpath.style["v-text-align"]="left";res.bbx=res.W/2;break;case"end":res.textpath.style["v-text-align"]="right";res.bbx=-res.W/2;break;default:res.textpath.style["v-text-align"]="center";res.bbx=0;break;}
res.textpath.style["v-text-kern"]=true;}},addGradientFill=function(o,gradient,fill){o.attrs=o.attrs||{};var attrs=o.attrs,pow=Math.pow,opacity,oindex,type="linear",fxfy=".5 .5";o.attrs.gradient=gradient;gradient=Str(gradient).replace(R._radial_gradient,function(all,fx,fy){type="radial";if(fx&&fy){fx=toFloat(fx);fy=toFloat(fy);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*((fy>.5)*2-1)+.5);fxfy=fx+S+fy;}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
o=o.shape||o.node;if(dots.length){o.removeChild(fill);fill.on=true;fill.method="none";fill.color=dots[0].color;fill.color2=dots[dots.length-1].color;var clrs=[];for(var i=0,ii=dots.length;i<ii;i++){dots[i].offset&&clrs.push(dots[i].offset+S+dots[i].color);}
fill.colors=clrs.length?clrs.join():"0% "+fill.color;if(type=="radial"){fill.type="gradientTitle";fill.focus="100%";fill.focussize="0 0";fill.focusposition=fxfy;fill.angle=0;}else{fill.type="gradient";fill.angle=(270-angle)%360;}
o.appendChild(fill);}
return 1;},Element=function(node,vml){this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.X=0;this.Y=0;this.attrs={};this.paper=vml;this.matrix=R.matrix();this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1};!vml.bottom&&(vml.bottom=this);this.prev=vml.top;vml.top&&(vml.top.next=this);vml.top=this;this.next=null;};var elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;elproto.transform=function(tstr){if(tstr==null){return this._.transform;}
var vbs=this.paper._viewBoxShift,vbt=vbs?"s"+[vbs.scale,vbs.scale]+"-1-1t"+[vbs.dx,vbs.dy]:E,oldt;if(vbs){oldt=tstr=Str(tstr).replace(/\.{3}|\u2026/g,this._.transform||E);}
R._extractTransform(this,vbt+tstr);var matrix=this.matrix.clone(),skew=this.skew,o=this.node,split,isGrad=~Str(this.attrs.fill).indexOf("-"),isPatt=!Str(this.attrs.fill).indexOf("url(");matrix.translate(1,1);if(isPatt||isGrad||this.type=="image"){skew.matrix="1 0 0 1";skew.offset="0 0";split=matrix.split();if((isGrad&&split.noRotation)||!split.isSimple){o.style.filter=matrix.toFilter();var bb=this.getBBox(),bbt=this.getBBox(1),dx=bb.x-bbt.x,dy=bb.y-bbt.y;o.coordorigin=(dx*-zoom)+S+(dy*-zoom);setCoords(this,1,1,dx,dy,0);}else{o.style.filter=E;setCoords(this,split.scalex,split.scaley,split.dx,split.dy,split.rotate);}}else{o.style.filter=E;skew.matrix=Str(matrix);skew.offset=matrix.offset();}
oldt&&(this._.transform=oldt);return this;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
if(deg==null){return;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this._.dirtyT=1;this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;if(this._.bbox){this._.bbox.x+=dx;this._.bbox.y+=dy;}
this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);isNaN(cx)&&(cx=null);isNaN(cy)&&(cy=null);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));this._.dirtyT=1;return this;};elproto.hide=function(){!this.removed&&(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&(this.node.style.display=E);return this;};elproto._getBBox=function(){if(this.removed){return{};}
return{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H};};elproto.remove=function(){if(this.removed||!this.node.parentNode){return;}
this.paper.__set__&&this.paper.__set__.exclude(this);R.eve.unbind("raphael.*.*."+this.id);R._tear(this,this.paper);this.node.parentNode.removeChild(this.node);this.shape&&this.shape.parentNode.removeChild(this.shape);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name==fillString&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(this.attrs&&value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
var params;if(value!=null){params={};params[name]=value;}
value==null&&R.is(name,"object")&&(params=name);for(var key in params){eve("raphael.attr."+key+"."+this.id,this,params[key]);}
if(params){for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
if(params.text&&this.type=="text"){this.textpath.string=params.text;}
setFillAndStroke(this,params);}
return this;};elproto.toFront=function(){!this.removed&&this.node.parentNode.appendChild(this.node);this.paper&&this.paper.top!=this&&R._tofront(this,this.paper);return this;};elproto.toBack=function(){if(this.removed){return this;}
if(this.node.parentNode.firstChild!=this.node){this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild);R._toback(this,this.paper);}
return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[element.length-1];}
if(element.node.nextSibling){element.node.parentNode.insertBefore(this.node,element.node.nextSibling);}else{element.node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[0];}
element.node.parentNode.insertBefore(this.node,element.node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var s=this.node.runtimeStyle,f=s.filter;f=f.replace(blurregexp,E);if(+size!==0){this.attrs.blur=size;s.filter=f+S+ms+".Blur(pixelradius="+(+size||1.5)+")";s.margin=R.format("-{0}px 0 0 -{0}px",round(+size||1.5));}else{s.filter=f;s.margin=0;delete this.attrs.blur;}
return this;};R._engine.path=function(pathString,vml){var el=createNode("shape");el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin=vml.coordorigin;var p=new Element(el,vml),attr={fill:"none",stroke:"#000"};pathString&&(attr.path=pathString);p.type="path";p.path=[];p.Path=E;setFillAndStroke(p,attr);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.rect=function(vml,x,y,w,h,r){var path=R._rectPath(x,y,w,h,r),res=vml.path(path),a=res.attrs;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.r=r;a.path=path;res.type="rect";return res;};R._engine.ellipse=function(vml,x,y,rx,ry){var res=vml.path(),a=res.attrs;res.X=x-rx;res.Y=y-ry;res.W=rx*2;res.H=ry*2;res.type="ellipse";setFillAndStroke(res,{cx:x,cy:y,rx:rx,ry:ry});return res;};R._engine.circle=function(vml,x,y,r){var res=vml.path(),a=res.attrs;res.X=x-r;res.Y=y-r;res.W=res.H=r*2;res.type="circle";setFillAndStroke(res,{cx:x,cy:y,r:r});return res;};R._engine.image=function(vml,src,x,y,w,h){var path=R._rectPath(x,y,w,h),res=vml.path(path).attr({stroke:"none"}),a=res.attrs,node=res.node,fill=node.getElementsByTagName(fillString)[0];a.src=src;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.path=path;res.type="image";fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=src;fill.type="tile";res._.fillpos=[x,y];res._.fillsize=[w,h];node.appendChild(fill);setCoords(res,1,1,0,0,0);return res;};R._engine.text=function(vml,x,y,text){var el=createNode("shape"),path=createNode("path"),o=createNode("textpath");x=x||0;y=y||0;text=text||"";path.v=R.format("m{0},{1}l{2},{1}",round(x*zoom),round(y*zoom),round(x*zoom)+1);path.textpathok=true;o.string=Str(text);o.on=true;el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin="0 0";var p=new Element(el,vml),attr={fill:"#000",stroke:"none",font:R._availableAttrs.font,text:text};p.shape=el;p.path=path;p.textpath=o;p.type="text";p.attrs.text=Str(text);p.attrs.x=x;p.attrs.y=y;p.attrs.w=1;p.attrs.h=1;setFillAndStroke(p,attr);el.appendChild(o);el.appendChild(path);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.setSize=function(width,height){var cs=this.canvas.style;this.width=width;this.height=height;width==+width&&(width+="px");height==+height&&(height+="px");cs.width=width;cs.height=height;cs.clip="rect(0 "+width+" "+height+" 0)";if(this._viewBox){R._engine.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.setViewBox=function(x,y,w,h,fit){R.eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var width=this.width,height=this.height,size=1/mmax(w/width,h/height),H,W;if(fit){H=height/h;W=width/w;if(w*H<width){x-=(width-w*H)/2/H;}
if(h*W<height){y-=(height-h*W)/2/W;}}
this._viewBox=[x,y,w,h,!!fit];this._viewBoxShift={dx:-x,dy:-y,scale:size};this.forEach(function(el){el.transform("...");});return this;};var createNode;R._engine.initWin=function(win){var doc=win.document;doc.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!doc.namespaces.rvml&&doc.namespaces.add("rvml","urn:schemas-microsoft-com:vml");createNode=function(tagName){return doc.createElement('<rvml:'+tagName+' class="rvml">');};}catch(e){createNode=function(tagName){return doc.createElement('<'+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');};}};R._engine.initWin(R._g.win);R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con.container,height=con.height,s,width=con.width,x=con.x,y=con.y;if(!container){throw new Error("VML container not found.");}
var res=new R._Paper,c=res.canvas=R._g.doc.createElement("div"),cs=c.style;x=x||0;y=y||0;width=width||512;height=height||342;res.width=width;res.height=height;width==+width&&(width+="px");height==+height&&(height+="px");res.coordsize=zoom*1e3+S+zoom*1e3;res.coordorigin="0 0";res.span=R._g.doc.createElement("span");res.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;";c.appendChild(res.span);cs.cssText=R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",width,height);if(container==1){R._g.doc.body.appendChild(c);cs.left=x+"px";cs.top=y+"px";cs.position="absolute";}else{if(container.firstChild){container.insertBefore(c,container.firstChild);}else{container.appendChild(c);}}
res.renderfix=function(){};return res;};R.prototype.clear=function(){R.eve("raphael.clear",this);this.canvas.innerHTML=E;this.span=R._g.doc.createElement("span");this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";this.canvas.appendChild(this.span);this.bottom=this.top=null;};R.prototype.remove=function(){R.eve("raphael.remove",this);this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
return true;};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}})();oldRaphael.was?(g.win.Raphael=R):(Raphael=R);return R;}));
var RaphaelComponent=BaseComponent.extend({update:function(){var myself=this;this.customfunction.apply(myself,this.parameters?this.parameters:[]);}});
var RelatedContentComponent=BaseComponent.extend({update:function(){if(typeof(this.relatedContent)!="undefined"){var placeHolder=$("#"+this.htmlObject);placeHolder.empty();var contentString='<div id="relatedContentMainDiv"><p>Related content</p><ul>';for(key in this.relatedContent){if(this.relatedContent.hasOwnProperty(key)&&key!=null&&key!=undefined){contentString=contentString+'<li><a href=\''+this.relatedContent[key][1]+'\'">'+this.relatedContent[key][0]+'</a></li>';}}
contentString=contentString+'</ul></div>';placeHolder.append(contentString);}}});
var ExportButtonComponent=BaseComponent.extend({ph:undefined,tc:undefined,queryObjectNames:{queryState:null,query:null},update:function(){var myself=this;$.extend(this.options,this);myself.ph=$("#"+myself.htmlObject);myself.ph.empty();var bar=$('<span class="exportButton"></span>').appendTo(myself.ph);var componentName=(myself.componentName.indexOf("render_")==0?"":"render_")+myself.componentName;var comp=Dashboards.getComponentByName(componentName);var overrideParameters=Dashboards.propertiesArrayToObject(myself.parameters);bar.text(myself.label).click(function(){var foundQuery=false;for(n in myself.queryObjectNames){if(comp[n]){comp[n].exportData(myself.outputType,overrideParameters,myself.getFilterSettings(comp));foundQuery=true;break;}}
if(!foundQuery){Dashboards.log(myself.name+": could not find a query object on "+myself.compName);}});},getFilterSettings:function(component){var extraSettings={};if(component.type=="Table"){var dtOptions=component.ph.dataTableSettings[0];if(dtOptions.oFeatures.bFilter){var searchInput=component.ph.find('input');if(searchInput){extraSettings.dtFilter=searchInput.val();if(dtOptions.aoColumns){var idxs=[];for(var i=0;i<dtOptions.aoColumns.length;i++){if(dtOptions.aoColumns[i].bSearchable){idxs.push(i);}}
extraSettings.dtSearchableColumns=idxs.join(',');}}}}
return extraSettings;}});
var loadGoogleMapsOverlay=(function($){var now=$.now(),promise;return function(){if(promise){return promise;}
var deferred=$.Deferred(),resolve=function(){deferred.resolve(window.google&&google.maps?google.maps:false);},callbackName="loadGoogleMapsOverlay_"+(now++),params;if(window.google&&google.maps){resolve();}else if(window.google&&google.load){google.load("maps","3.exp",{"other_params":"sensor=false&libraries=places","callback":resolve});}else{params={'v':'3.exp','sensor':false,'libraries':'places','callback':callbackName};window[callbackName]=function(){resolve();setTimeout(function(){try{delete window[callbackName];}catch(e){}},20);};$.ajax({dataType:'script',data:params,url:'http://maps.googleapis.com/maps/api/js'});}
promise=deferred.promise();return promise;};}(jQuery));
function submitGeocode(input){return function(e){var keyCode;if(window.event){keyCode=window.event.keyCode;}
if(keyCode==13){geocoder.geocode({address:input.value},function(results,status){if(status==google.maps.GeocoderStatus.OK){map.fitBounds(results[0].geometry.viewport);}else{alert("The location entered could not be found");}});}}}
var gMapsOverlayComponent=UnmanagedComponent.extend({mapEngineOpts:undefined,colormap:[[0,102,0,255],[255,255,0,255],[255,0,0,255]],getColorLegend:function(value,legendRanges){var qtd=Object.keys(legendRanges.ranges).length;for(var j=0;j<qtd;j++){if((isNaN(legendRanges.ranges[j].min)&&value<=legendRanges.ranges[j].max)||(isNaN(legendRanges.ranges[j].max)&&value>=legendRanges.ranges[j].min)||(value>=legendRanges.ranges[j].min&&value<=legendRanges.ranges[j].max)){return legendRanges.ranges[j].color;}}},getColorMap:function(){var interpolate=function(a,b,n){var c=[],d=[];var k,kk,step;for(k=0;k<a.length;k++){c[k]=[];for(kk=0,step=(b[k]-a[k])/n;kk<n;kk++){c[k][kk]=a[k]+kk*step;}}
for(k=0;k<c[0].length;k++){d[k]=[];for(kk=0;kk<c.length;kk++){d[k][kk]=Math.round(c[kk][k]);}}
return d;};var cmap=[];for(k=1;k<this.colormap.length;k++)
{cmap=cmap.concat(interpolate(this.colormap[k-1],this.colormap[k],512));}
return _.map(cmap,function(v){return'rgba('+v.join(',')+')';});},_getMapDefinition:function(myself,callback){if(!!myself.mapName&!myself.mapDefinition){$.getJSON(wd.helpers.repository.getRsourceUrl()+wd.helpers.repository.getBaseSolutionPluginRoot()+"cde/components/gmapsoverlay/map-def/"+myself.mapName+".js",function(json,callback){if(json){myself.mapDefinition=json;}});}
callback(myself);},postProcessData:function(values,myself){var defaultFillOpacity=0.6;var defaultStrokeWeight=0.5;myself.queryResult={};myself.isContinuousMapColor=$.isEmptyObject(myself.legend);var nrCols=values.metadata.length;for(i in values.resultset){var item=values.resultset[i];var value;if(nrCols<3)
{value=parseFloat(item[1]);color="";myself.isColorDefinedInDS=false;}
else
{value=item[1];color=item[2];myself.isColorDefinedInDS=true;}
myself.queryResult[item[0]]={'value':value,'color':color};if(item.length>2){myself.queryResult[item[0]].payload=item.slice(2);}}
myself._parseLegend(myself.isContinuousMapColor);if(myself.isContinuousMapColor)
{var colormap=myself.getColorMap();var qvalues=_.map(myself.queryResult,function(q){return q.value;});var minValue=_.min(qvalues),maxValue=_.max(qvalues);var n=colormap.length;_.each(myself.queryResult,function(v,key){var level=(v.value-minValue)/(maxValue-minValue);myself.queryResult[key]=_.extend({level:level,fillColor:colormap[Math.floor(level*(n-1))],fillOpacity:defaultFillOpacity,strokeWeight:defaultStrokeWeight},myself.queryResult[key]);});}
else
{_.each(myself.queryResult,function(v,key){var color;if(myself.isColorDefinedInDS){color=v.color;}
else
{color=myself.getColorLegend(v.value,myself.legendRanges);}
myself.queryResult[key]=_.extend({fillColor:color,fillOpacity:defaultFillOpacity,strokeWeight:defaultStrokeWeight},myself.queryResult[key]);});}},_parseLegend:function(isContinuousMapColor){this.legendRanges=new Object;this.legendRanges.ranges=new Object;this.legendRanges.text=((!this.legendText)?"":this.legendText);this.legendRanges.source=((!this.sourceText)?" ":this.sourceText);if(!isContinuousMapColor){for(var i=0;i<this.legend.length;i++){var opts=this.legend[i][1].split(";");this.legendRanges.ranges[i]=new Object;this.legendRanges.ranges[i].min=parseFloat(opts[0]);this.legendRanges.ranges[i].max=parseFloat(opts[1]);this.legendRanges.ranges[i].color=opts[2];this.legendRanges.ranges[i].desc=this.legend[i][0];}}},update:function(){myself=this;if($.isEmptyObject(myself.queryDefinition)){Dashboards.error("GMaps - Datasource not defined.");return}
if(!myself.mapName){Dashboards.error("GMaps - Map Name not defined.");return}
if(!myself.mapHeight||!myself.mapWidth){Dashboards.error("GMaps - Map Height and/or Width not defined.");return}
myself._getMapDefinition(myself,function(myself){myself.triggerQuery(myself.queryDefinition,function(values){myself.postProcessData(values,myself);myself._initialize();});});},_initialize:function(){this.mapEngine=new GMapEngine();this.mapEngine.opts=$.extend(true,this.mapEngine.opts,this.mapEngineOpts);if(this.clickCallback){this.mapEngine.clickCallback=this.clickCallback;}
this.mapEngine.init(this);},draw:function(){var myself=this;this.ph=$("#"+this.htmlObject);this.ph.empty();this.mapEngine.createMap(this.ph[0],this.centerLongitude,this.centerLatitude,this.defaultZoomLevel,this.mapHeight,this.mapWidth);this.mapEngine.renderMap(this.mapDefinition,this.queryResult,((!this.defaultColor)?"#EAEAEA":this.defaultColor),myself.legendRanges);this.mapEngine.resetButton(this.ph[0].id,this.defaultZoomLevel,this.centerLongitude,this.centerLatitude);if(this.search==true){this.mapEngine.searchBox(this.ph[0].id);}
this.mapEngine.renderLegend(this.ph[0].id,this.mapDefinition,this.queryResult,this.getColorMap(),[0,0.5,1],myself.legendRanges,myself.isContinuousMapColor,myself.isColorDefinedInDS);}});var GMapEngine=Base.extend({map:undefined,opts:{mapOptions:{styles:[{featureType:"administrative",stylers:[{"visibility":"off"}]}],disableDefaultUI:false,mapTypeControl:false,streetViewControl:false}},opened_info:undefined,centered:false,overlays:[],init:function(mapComponent){$.when(loadGoogleMapsOverlay()).then(function(status){mapComponent.draw();});},createMap:function(target,centerLongitude,centerLatitude,defaultZoomLevel,mapHeight,mapWidth){var mapOptions=$.extend(true,{zoom:parseInt(defaultZoomLevel),center:new google.maps.LatLng(centerLatitude,centerLongitude),mapTypeId:google.maps.MapTypeId.TERRAIN},this.opts.mapOptions);this.map=new google.maps.Map(target,mapOptions);this.opened_info=new google.maps.InfoWindow();$(target).css("height",mapHeight+"px");$(target).css("width",mapWidth+"px");},renderMap:function(mapDefinition,queryResult,defaultColor,legend){if(!mapDefinition){return;}
var myself=this;for(var c in mapDefinition){var coods=mapDefinition[c],polyPath=[];for(var k=0;k<coods.length;k++){polyPath.push(new google.maps.LatLng(coods[k][0],coods[k][1]));}
var shapeinfo={fillColor:!!queryResult[c]?queryResult[c].fillColor:defaultColor,fillOpacity:!!queryResult[c]?queryResult[c].fillOpacity:0,strokeWeight:!!queryResult[c]?queryResult[c].strokeWeight:0,strokeColor:'#8c8c8c'};var shape=new google.maps.Polygon(_.extend({paths:polyPath},shapeinfo));var shapeValue=queryResult[c]?queryResult[c].value:null;shape.infowindow=new google.maps.InfoWindow({content:myself.tooltipMessage(c,shapeValue),pixelOffset:{width:0,height:-3}});shape.infowindow.dataPayload=_.extend({name:c,value:shapeValue,level:queryResult[c]?queryResult[c].level:0},shapeinfo);if(!!queryResult[c]){queryResult[c].shape=shape;}
shape.setMap(myself.map);google.maps.event.addListener(shape,'click',function(event){myself.clickCallback(this.infowindow,event);myself.displayCoordinates(event.latLng);});google.maps.event.addListener(shape,'click',function(event){this.fillOpacity=1;this.strokeColor="#000000";this.setVisible(false);this.setVisible(true);this.infowindow.setOptions({maxWidth:500});this.infowindow.setPosition(event.latLng);if(!this.infowindow.getMap())
this.infowindow.open(myself.map);myself.opened_info=this.infowindow;});google.maps.event.addListener(shape,'mouseout',function(event){myself.opened_info.close();this.fillOpacity=0.6;this.strokeColor="#8c8c8c";this.setVisible(false);this.setVisible(true);});}},tooltipMessage:function(shapeName,shapeValue){var message=shapeName+"</br>"+(shapeValue?shapeValue:'-');return'<div class="gmapsoverlay-tooltip">'+message+'</div>';},clickCallback:function(shape,event){Dashboards.log(shape.dataPayload.name+':'+shape.dataPayload.value+':'+shape.dataPayload.level*100+'%');},displayCoordinates:function(pnt){var lat=pnt.lat();lat=lat.toFixed(4);var lng=pnt.lng();lng=lng.toFixed(4);Dashboards.log("Lat: "+lat+"  Lng: "+lng);},showInfo:function(event,mapEngine,infowindow){mapEngine.opened_info.close();infowindow.setPosition(event.latLng);infowindow.open(mapEngine.map);mapEngine.opened_info=infowindow;},resetButton:function(id,zoom,centerLongitude,centerLatitude){var myself=this;var controlReset=document.createElement('div');var linkReset=document.createElement('a');controlReset.appendChild(linkReset);controlReset.setAttribute('id','controlReset_'+id);linkReset.setAttribute('id','linkReset_'+id);linkReset.href="javascript:void(0)";linkReset.className='gmapsoverlay-button';linkReset.onclick=(function(){myself.map.setZoom(zoom);myself.map.setCenter(new google.maps.LatLng(centerLatitude,centerLongitude));});linkReset.innerHTML='Reset';myself.map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlReset);},searchBox:function(id){var myself=this;var control=document.createElement('div');var input=document.createElement('input');control.appendChild(input);control.setAttribute('id','locationField_'+id);input.style.width='250px';input.style.height='100%';input.style.margin='0px';input.style.border='1px solid #A9BBDF';input.style.borderRadius='2px';input.setAttribute('id','locationInput_'+id);myself.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(control);var ac=new google.maps.places.Autocomplete(input,{types:['geocode']});google.maps.event.addListener(ac,'place_changed',function(){var place=ac.getPlace();if(place.geometry.viewport){myself.map.fitBounds(place.geometry.viewport);}else{myself.map.setCenter(place.geometry.location);myself.map.setZoom(17);}});google.maps.event.addListener(myself.map,'bounds_changed',function(){input.blur();input.value='';});input.onkeyup=submitGeocode(input);},renderLegend:function(id,mapDefinition,queryResult,colormap,ticks,legendRanges,isContinuousMapColor,isColorDefinedInDS){if(isContinuousMapColor)
{var sigFigs=function(num,sig){if(num==0)
return 0;if(Math.round(num)==num)
return num;var digits=Math.round((-Math.log(Math.abs(num))/Math.LN10)+(sig||2));if(digits<0)
digits=0;return num.toFixed(digits);};if(queryResult&&mapDefinition){var values=_.map(queryResult,function(q){return q.value;});var minValue=_.min(values),maxValue=_.max(values);var n=colormap.length;var rounding=1;if(maxValue<-5){rounding=((maxValue-minValue)/5).toString().split('.');rounding=rounding.length>1?Math.pow(10,Math.max(rounding[1].length,3)):1;}
var legend=_.map(ticks,function(level){var value=(minValue+level*(maxValue-minValue)*rounding)/rounding;return{value:sigFigs(value,1),level:level,fillColor:colormap[Math.floor(level*n-1)]};});}
this.legend=legend;}
var controlDiv=document.createElement('DIV');controlDiv.style.padding='5px';controlDiv.setAttribute('id','legendDiv_'+id);var controlUI=document.createElement('DIV');controlUI.setAttribute('id','legendUI_'+id);controlUI.title='Legend';controlDiv.appendChild(controlUI);var controlText=document.createElement('DIV');controlText.setAttribute('id','legendText_'+id);controlText.style.fontFamily='Arial,sans-serif';controlText.style.fontSize='12px';controlText.style.paddingLeft='4px';controlText.style.paddingRight='4px';if(isContinuousMapColor)
{var legendTable='';_.each(legend,function(el){var left=(el.level!=0)?el.level*100+'%':'-1px';legendTable+="<div class='gmapsoverlay-legend-label' style='left:"+left+";position:absolute;'><div>"+el.value+"</div></div>";});controlText.innerHTML=""+"<div class='gmapsoverlay-legend'>"+"  <div class='gmapsoverlay-legend-title'>"+legendRanges.text+"</div>"+"  <div class='gmapsoverlay-legend-scale'>"+"    <div class='gmapsoverlay-legend-labels'>"+
legendTable+"    </div>"+"  </div>"+"<div class='gmapsoverlay-legend-source'>"+legendRanges.source+"</div>"+"</div>";}
else
{var legendTable="";var qtd=Object.keys(legendRanges.ranges).length;for(var j=0;j<qtd;j++){if(isColorDefinedInDS)
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'></span>"+legendRanges.ranges[j].desc+"</li>";}
else if(isNaN(legendRanges.ranges[j].min))
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'><= "+legendRanges.ranges[j].max+"</span>"+legendRanges.ranges[j].desc+"</li>";}
else if(isNaN(legendRanges.ranges[j].max))
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'>>= "+legendRanges.ranges[j].min+"</span>"+legendRanges.ranges[j].desc+"</li>";}
else
{legendTable+="<li><span style='background:"+legendRanges.ranges[j].color+";'>"+legendRanges.ranges[j].max+"</span>"+legendRanges.ranges[j].desc+"</li>";}}
controlText.innerHTML=""+"<div class='gmapsoverlay-legend' style='width: auto'>"+"<div class='gmapsoverlay-legend-title'>"+legendRanges.text+"</div>"+"<div class='gmapsoverlay-legend-scale-range'>"+"  <ul class='gmapsoverlay-legend-labels-range'>"+
legendTable+"  </ul>"+"</div>"+"<div class='gmapsoverlay-legend-source'>"+legendRanges.source+"</div>"+"</div>";}
controlUI.appendChild(controlText);this.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(controlDiv);},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var overlay=new OurMapOverlay(mapElement.getPosition(),popupWidth,popupHeight,contents,popupContentDiv,this.map,borderColor);$(this.overlays).each(function(i,elt){elt.setMap(null);});this.overlays.push(overlay);}});
var CurrentVersionComponent=BaseComponent.extend({ph:null,update:function(){var self=this;this.ph=$('#'+this.htmlObject).empty();$.get(this.versionUrl,function(result){var msgHolder=$('<div/>').html(result);self.ph.append(msgHolder);});}});var VersionCheckComponent=BaseComponent.extend({ph:null,versionInfo:null,getMsgUpdate:function(url){return'You are currently running an outdated version. Please update to the new version <a href="'+url+'">here</a>.';},getMsgLatest:function(){return'Your version is up to date.';},getMsgInconclusive:function(msg,url){return'Only ctools branches support version checking '+(msg?'('+msg+') .':'.')+' You can install lastest version <a href="'+url+'">here</a>';},getMsgError:function(errorMsg){return'There was an error checking for newer versions: '+errorMsg;},update:function(){var self=this;this.ph=$("#"+this.htmlObject).empty();$.get(this.versionCheckUrl,function(result){if(!result){return;}
try{result=JSON.parse(result);console.log("[VERSION CHECK COMPONENT] ### json parsed with no errors ###");}catch(e){alert(e.message);}
self.versionInfo=result;var msg='';switch(result.result){case'update':msg=self.getMsgUpdate(result.downloadUrl);break;case'latest':msg=self.getMsgLatest();break;case'error':msg=self.getMsgError(result.msg);break;case'inconclusive':msg=self.getMsgInconclusive(result.msg,result.downloadUrl);break;}
var msgHolder=$('<div/>').html(msg);self.ph.append(msgHolder);});}});
var CurrentVersionComponent=BaseComponent.extend({ph:null,update:function(){var self=this;this.ph=$('#'+this.htmlObject).empty();$.get(this.versionUrl,function(result){var msgHolder=$('<div/>').html(result);self.ph.append(msgHolder);});}});var VersionCheckComponent=BaseComponent.extend({ph:null,versionInfo:null,getMsgUpdate:function(url){return'You are currently running an outdated version. Please update to the new version <a href="'+url+'">here</a>.';},getMsgLatest:function(){return'Your version is up to date.';},getMsgInconclusive:function(msg,url){return'Only ctools branches support version checking '+(msg?'('+msg+') .':'.')+' You can install lastest version <a href="'+url+'">here</a>';},getMsgError:function(errorMsg){return'There was an error checking for newer versions: '+errorMsg;},update:function(){var self=this;this.ph=$("#"+this.htmlObject).empty();$.get(this.versionCheckUrl,function(result){if(!result){return;}
try{result=JSON.parse(result);console.log("[VERSION CHECK COMPONENT] ### json parsed with no errors ###");}catch(e){alert(e.message);}
self.versionInfo=result;var msg='';switch(result.result){case'update':msg=self.getMsgUpdate(result.downloadUrl);break;case'latest':msg=self.getMsgLatest();break;case'error':msg=self.getMsgError(result.msg);break;case'inconclusive':msg=self.getMsgInconclusive(result.msg,result.downloadUrl);break;}
var msgHolder=$('<div/>').html(msg);self.ph.append(msgHolder);});}});
var AjaxRequestComponent=BaseComponent.extend({visible:false,update:function(){this.executeRequest(this);},parseXML:function(sText){if(!sText){return null;}
var xmlDoc;try{parser=new DOMParser();xmlDoc=parser.parseFromString(sText,"text/xml");return xmlDoc;}catch(e){try{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(sText);return xmlDoc;}catch(e){}}
alert('XML is invalid or no XML parser found');return null;},executeRequest:function(object){var myself=this;var url=object.url;var ajaxRequestType=object.ajaxRequestType;var params=object.parameters;var asyncCall=object.asyncCall;if(url==undefined){Dashboards.log("Fatal - No url passed","error");return;}
if(ajaxRequestType==undefined){ajaxRequestType="json";}
if(params!=undefined){var containsTime=false;for(var i=0;i<params.length;i++){var value;if(params[i][0]=='time'){value=new Date().getTime();containsTime=true;}
else value=Dashboards.getParameterValue(params[i][0]);params[i][1]=value;}
containsTime?params.push(['time',new Date().getTime()]):0;params=Dashboards.propertiesArrayToObject(params);}else{params={};}
if(asyncCall==undefined)asyncCall=true;$.ajax({url:url,type:"GET",dataType:ajaxRequestType,async:asyncCall,data:params,complete:function(XMLHttpRequest,textStatus){var values=XMLHttpRequest.responseText;var changedValues=undefined;if(values==undefined){Dashboards.log("Found error: Empty Data");return;}
if(this.dataType=="xml"||this.dataType=="html"){var xmlDoc;try{parser=new DOMParser();xmlDoc=parser.parseFromString(values,"text/xml");}catch(e){try{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(values);values=xmlDoc;}catch(e){Dashboards.log('XML is invalid or no XML parser found');}}
values=xmlDoc;var nodeList=values.getElementsByTagName('return');if(nodeList.length>0&&nodeList[0].firstChild){values=nodeList[0].firstChild.nodeValue;}
else return;values=$.parseJSON(values);}else if(this.dataType=="json"){values=$.parseJSON(values);}else if(this.dataType!="script"&&this.dataType!="text"){Dashboards.log("Found error: Unknown returned format");return;}
if((typeof(object.postFetch)=='function')){changedValues=object.postFetch(values);}
if(changedValues!=undefined){values=changedValues;}
if(object.resultvar!=undefined){Dashboards.setParameter(object.resultvar,values);}},error:function(XMLHttpRequest,textStatus,errorThrown){Dashboards.log("Found error: "+XMLHttpRequest+" - "+textStatus+", Error: "+errorThrown,"error");}});}});
var loadGoogleMaps=(function($){var now=$.now(),promise;return function(version,apiKey){if(promise){return promise;}
var deferred=$.Deferred(),resolve=function(){deferred.resolve(window.google&&google.maps?google.maps:false);},callbackName="loadGoogleMaps_"+(now++),params;if(window.google&&google.maps){resolve();}else if(window.google&&google.load){google.load("maps",version||3,{"other_params":"sensor=false","callback":resolve});}else{params=$.extend({'v':version||3,'sensor':false,'callback':callbackName},apiKey?{"key":apiKey}:{});window[callbackName]=function(){resolve();setTimeout(function(){try{delete window[callbackName];}catch(e){}},20);};$.ajax({dataType:'script',data:params,url:'http://maps.googleapis.com/maps/api/js'});}
promise=deferred.promise();return promise;};}(jQuery));
(function(){var geonames={name:"geonames",label:"GeoNames",defaults:{username:''},implementation:function(tgt,st,opt){var location;var name=st.address;var featureClass;if(!name){if(st.city){name=st.city;featureClass='P';}else if(st.county){name=st.county;featureClass='A';}else if(st.region){name=st.region;featureClass='A';}else if(st.state){name=st.state;featureClass='A';}else if(st.country){name=st.country;featureClass='A';}}
var url='http://ws.geonames.org/searchJSON';var data={q:name.replace(/&/g,","),maxRows:1,dataType:"json",username:opt.username,featureClass:featureClass};if(featureClass){data.featureClass=featureClass;}
var success=function(result){if(result.geonames&&result.geonames.length>0){location=[parseFloat(result.geonames[0].lng),parseFloat(result.geonames[0].lat)];st.continuationFunction(location);}};$.getJSON(url,data,success);}};Dashboards.registerAddIn("NewMapComponent","LocationResolver",new AddIn(geonames));var nominatim={name:"openstreetmap",label:"OpenStreetMap",defaults:{},implementation:function(tgt,st,opt){var name=st.address;var keyword='q';if(!name){if(st.city){name=st.city;keyword='city';}else if(st.county){name=st.county;keyword='county';}else if(st.region){name=st.region;keyword='q';}else if(st.state){name=st.state;keyword='state=';}else if(st.country){name=st.country;keyword='country';}}
var url='http://nominatim.openstreetmap.org/search';var data={format:'json',limit:'1'};data[keyword]=name;var success=function(result){if(result&&result.length>0){var location=[parseFloat(result[0].lon),parseFloat(result[0].lat)];st.continuationFunction(location);}};$.getJSON(url,data,success);}};Dashboards.registerAddIn("NewMapComponent","LocationResolver",new AddIn(nominatim));var componentPath=Dashboards.getWebAppPath()+'/content/pentaho-cdf-dd/resources/custom/components/NewMapComponent';var urlMarker={name:"urlMarker",label:"Url Marker",defaults:{defaultUrl:componentPath+'/images/marker_grey.png'},implementation:function(tgt,st,opt){if(st.url)
return st.url;if(st.position){switch(st.position%5){case 0:return componentPath+'/images/marker_grey.png';case 1:return componentPath+'/images/marker_blue.png';case 2:return componentPath+'/images/marker_grey02.png';case 3:return componentPath+'/images/marker_orange.png';case 4:return componentPath+'/images/marker_purple.png';}}
return opt.defaultUrl;}};Dashboards.registerAddIn("NewMapComponent","MarkerImage",new AddIn(urlMarker));var cggMarker={name:"cggMarker",label:"CGG Marker",defaults:{},implementation:function(tgt,st,opt){var url=wd.helpers.cggHelper.getCggDrawUrl()+'?script='+st.cggGraphName;var width=st.width;var height=st.height;var cggParameters={};if(st.width)cggParameters.width=st.width;if(st.height)cggParameters.height=st.height;cggParameters.noChartBg=true;for(parameter in st.parameters){cggParameters[parameter]=st.parameters[parameter];}
var level=Dashboards.debug;if(level>1){cggParameters.debug=true;cggParameters.debugLevel=level;}
for(parameter in cggParameters){if(cggParameters[parameter]!==undefined){url+="&param"+parameter+"="+encodeURIComponent(cggParameters[parameter]);}}
return url;}};Dashboards.registerAddIn("NewMapComponent","MarkerImage",new AddIn(cggMarker));})();
var MapEngine=Base.extend({tileServices:undefined,tileServicesOptions:undefined,tileLayer:function(name){},renderMap:function(){},setMarker:function(){},showPopup:function(){},setShape:function(polygonArray,shapeStyle,data){},postSetShapes:function(){},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'visible':case'zIndex':case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':case'strokeWidth':}});return validStyle;},wrapEvent:function(event,featureType){return{latitude:undefined,longitude:undefined,data:undefined,feature:undefined,featureType:featureType,style:undefined,mapEngineType:'abstract',draw:function(style){},raw:undefined};},_selectUrl:function(paramString,urls){var product=1;var URL_HASH_FACTOR=(Math.sqrt(5)-1)/2;for(var i=0,len=paramString.length;i<len;i++){product*=paramString.charCodeAt(i)*URL_HASH_FACTOR;product-=Math.floor(product);}
return urls[Math.floor(product*urls.length)];},_switchUrl:function(url){var list=url.match(/(http[s]?:\/\/[0-9a-z.]*?)\{switch:([a-z0-9,]+)\}(.*)/);if(!list||list.length==0){return url;}
var servers=list[2].split(",");var url_list=[];for(var i=0;i<servers.length;i++){url_list.push(list[1]+servers[i]+list[3]);}
return url_list;},_getTileServiceURL:function(name){var urlTemplate=this.tileServices[name];if(!urlTemplate){if(name.length>0&&name.contains('{')){urlTemplate=name;}}
return urlTemplate;}});
function OurMapOverlay(startPoint,width,height,htmlContent,popupContentDiv,map,borderColor){this.startPoint_=startPoint;this.width_=width;this.height_=height;this.map_=map;this.htmlContent_=htmlContent;this.popupContentDiv_=popupContentDiv;this.borderColor_=borderColor;this.div_=null;this.setMap(map);}
var GoogleMapEngine=MapEngine.extend({map:undefined,centered:false,overlays:[],API_KEY:false,init:function(mapComponent,tilesets){this.tilesets=tilesets;this.mapComponent=mapComponent;$.when(loadGoogleMaps('3',this.API_KEY)).then(function(status){OurMapOverlay.prototype=new google.maps.OverlayView();OurMapOverlay.prototype.onAdd=function(){var div=document.createElement('DIV');div.id='MapOverlay';div.style.position="absolute";if(this.borderColor_){div.style.border='3px solid '+this.borderColor_;}else{div.style.border="none";}
if(this.popupContentDiv_&&this.popupContentDiv_.length>0){$(div).append($('#'+this.popupContentDiv_));}else
div.innerHTML=this.htmlContent_;this.div_=div;var panes=this.getPanes();panes.overlayLayer.appendChild(div);};OurMapOverlay.prototype.draw=function(){var overlayProjection=this.getProjection();var sp=overlayProjection.fromLatLngToDivPixel(this.startPoint_);var div=this.div_;div.style.left=sp.x+'px';div.style.top=(sp.y+30)+'px';div.style.width=this.width_+'px';div.style.height=this.height_+'px';};OurMapOverlay.prototype.onRemove=function(){if(this.popupContentDiv_){}
this.div_.style.display='none';};mapComponent.initCallBack();});},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'strokeWidth':validStyle['strokeWeight']=value;break;case'zIndex':case'visible':case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':validStyle[key]=value;}});return validStyle;},wrapEvent:function(event,feature,featureType,featureStyle,data,marker){var myself=this;return{latitude:event.latLng.lat(),longitude:event.latLng.lng(),data:data,feature:feature,featureType:featureType,style:_.clone(featureStyle),marker:feature.marker,mapEngineType:'google3',draw:function(style){var validStyle=myself.toNativeStyle(style);feature.setOptions(validStyle);feature.setVisible(false);feature.setVisible(_.has(style,'visible')?!!style.visible:true);},raw:event};},setShape:function(multiPolygon,shapeStyle,data){var myself=this;var shapes=[];_.each(multiPolygon,function(polygon){var polygonGM=_.map(polygon,function(ring){return _.map(ring,function(latlong){return new google.maps.LatLng(latlong[0],latlong[1]);});});var shape=new google.maps.Polygon(_.extend({paths:polygonGM},myself.toNativeStyle(shapeStyle)));shape.setMap(myself.map);shapes.push(shape);google.maps.event.addListener(shape,'click',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:click',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});google.maps.event.addListener(shape,'mousemove',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:mouseover',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});google.maps.event.addListener(shape,'mouseout',function(event){_.each(shapes,function(s){myself.mapComponent.trigger('shape:mouseout',myself.wrapEvent(event,s,'shape',shapeStyle,data));});});});},postSetShapes:function(){},setMarker:function(lon,lat,icon,description,data,markerWidth,markerHeight,markerInfo){var myLatLng=new google.maps.LatLng(lat,lon);var image=new google.maps.MarkerImage(icon,new google.maps.Size(markerWidth,markerHeight),new google.maps.Point(0,0),new google.maps.Point(0,0));var marker=new google.maps.Marker({marker:markerInfo,position:myLatLng,map:this.map,icon:image,title:description});var myself=this;google.maps.event.addListener(marker,'click',function(e){myself.mapComponent.trigger('marker:click',myself.wrapEvent(e,marker,'marker',markerInfo,data));});if(!this.centered)
this.map.setCenter(myLatLng);},renderMap:function(target,centerLongitude,centerLatitude,zoomLevel){var myself=this;var latlng;if(centerLatitude&&centerLatitude!=''&&centerLongitude&&centerLongitude!=''){latlng=new google.maps.LatLng(centerLatitude,centerLongitude);this.centered=true;}else
latlng=new google.maps.LatLng(38.471,-9.15);if(!zoomLevel)zoomLevel=2;var myOptions={zoom:zoomLevel,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};var layers=[],layerIds=[],layerOptions=[];for(var k=0;k<this.tilesets.length;k++){var thisTileset=this.tilesets[k].slice(0),tileset=thisTileset.slice(0).split('-')[0],variant=thisTileset.slice(0).split('-').slice(1).join('-')||'default';layerIds.push(thisTileset);layerOptions.push(_.extend(myOptions,{mapTypeId:thisTileset}));if(this.tileServices[thisTileset]){layers.push(this.tileLayer(thisTileset));}else{layers.push('');}}
this.map=new google.maps.Map(target,{mapTypeControlOptions:{mapTypeIds:layerIds.concat(_.values(google.maps.MapTypeId))}});for(k=0;k<layers.length;k++){if(!_.isEmpty(layers[k])){this.map.mapTypes.set(layerIds[k],layers[k]);this.map.setMapTypeId(layerIds[k]);this.map.setOptions(layerOptions[k]);}}},tileLayer:function(name){var options=_.extend({tileSize:new google.maps.Size(256,256),minZoom:1,maxZoom:19},this.tileServicesOptions[name]||{});var urlList=this._switchUrl(this._getTileServiceURL(name));var myself=this;return new google.maps.ImageMapType(_.defaults({name:name.indexOf('/')>=0?'custom':name,getTileUrl:function(coord,zoom){var limit=Math.pow(2,zoom);if(coord.y<0||coord.y>=limit){return'404.png';}else{coord.x=((coord.x%limit)+limit)%limit;var url;if(_.isArray(urlList)){url=urlList[(coord.x+coord.y+zoom)%urlList.length];var s=_.template('${z}/${x}/${y}',{x:coord.x,y:coord.y,z:zoom},{interpolate:/\$\{(.+?)\}/g});url=myself._selectUrl(s,urlList);}else{url=urlList;}
return _.template(url,{x:coord.x,y:coord.y,z:zoom},{interpolate:/\$\{(.+?)\}/g});}}},options));},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var overlay=new OurMapOverlay(mapElement.getPosition(),popupWidth,popupHeight,contents,popupContentDiv,this.map,borderColor);$(this.overlays).each(function(i,elt){elt.setMap(null);});this.overlays.push(overlay);}});
var OpenLayersEngine=MapEngine.extend({map:undefined,markers:undefined,centered:false,useMercator:true,API_KEY:0,init:function(mapComponent,tilesets){this.tilesets=tilesets;this.mapComponent=mapComponent;Dashboards.log('Requested tilesets:'+JSON.stringify(tilesets),'debug');var contains=function(v){return _.some(tilesets,function(tileset){return tileset.search(v)>=0;});};if(contains('googleXXX')){$.when(loadGoogleMaps('3',this.API_KEY)).then(mapComponent.initCallBack);}else{mapComponent.initCallBack();}},setShape:function(multiPolygon,shapeStyle,data){var myself=this;var proj=new OpenLayers.Projection("EPSG:4326"),mapProj=this.map.getProjectionObject();var multiPolygonOL=_.map(multiPolygon,function(polygon){var polygonOL=_.map(polygon,function(ring){var linearRingOL=_.map(ring,function(latlong){var point=new OpenLayers.LonLat(latlong[1],latlong[0]).transform(proj,mapProj);return new OpenLayers.Geometry.Point(point.lon,point.lat);});return new OpenLayers.Geometry.LinearRing(linearRingOL);});return new OpenLayers.Geometry.Polygon(polygonOL);});var shape=new OpenLayers.Geometry.MultiPolygon(multiPolygonOL);var feature=new OpenLayers.Feature.Vector(shape,{data:data,style:shapeStyle},myself.toNativeStyle(shapeStyle));myself.shapes.addFeatures([feature]);},postSetShapes:function(){},toNativeStyle:function(foreignStyle){var validStyle={};_.each(foreignStyle,function(value,key){switch(key){case'visible':validStyle['display']=value?true:'none';break;case'zIndex':validStyle['graphicZIndex']=value;break;case'fillColor':case'fillOpacity':case'strokeColor':case'strokeOpacity':case'strokeWidth':validStyle[key]=value;}});return validStyle;},wrapEvent:function(event,featureType){var coords=this.map.getLonLatFromPixel(this.map.getControlsByClass("OpenLayers.Control.MousePosition")[0].lastXy).transform(this.map.getProjectionObject(),new OpenLayers.Projection('EPSG:4326'));var feature=event.feature.layer.getFeatureById(event.feature.id);var myself=this;return{latitude:coords.lat,longitude:coords.lon,data:event.feature.attributes.data,feature:feature,featureType:featureType,style:event.feature.attributes.style,marker:event.feature.attributes.marker,mapEngineType:'openlayers2',draw:function(style){var validStyle=myself.toNativeStyle(style);event.feature.layer.drawFeature(feature,validStyle);},raw:event};},setMarker:function(lon,lat,icon,description,data,markerWidth,markerHeight,markerInfo){var size=new OpenLayers.Size(markerWidth,markerHeight);var offset=new OpenLayers.Pixel(-(size.w/2),-size.h);var iconObj=new OpenLayers.Icon(icon,size,offset);var proj=new OpenLayers.Projection("EPSG:4326"),mapProj=this.map.getProjectionObject();var point=new OpenLayers.LonLat(lon,lat).transform(proj,mapProj);var marker=new OpenLayers.Geometry.Point(point.lon,point.lat);var style;var feature=new OpenLayers.Feature.Vector(marker,{data:data,style:style,marker:markerInfo},{externalGraphic:icon,graphicWidth:markerWidth,graphicHeight:markerHeight,fillOpacity:1});this.markers.addFeatures([feature]);if(!this.centered)
this.map.setCenter(point);},showPopup:function(data,mapElement,popupHeight,popupWidth,contents,popupContentDiv,borderColor){var feature=mapElement;if(popupContentDiv&&popupContentDiv.length>0){var div=$('<div>');div.append($('#'+popupContentDiv));contents=div.html();}
var name="featurePopup";if(borderColor!=undefined){name=name+borderColor.substring(1);}
var p=mapElement.geometry.getCentroid();feature.lonlat=new OpenLayers.LonLat(p.x,p.y);var popup=new OpenLayers.Popup.Anchored(name,feature.lonlat,new OpenLayers.Size(popupWidth,popupHeight),contents,null,true,null);feature.popup=popup;popup.feature=feature;$(this.map.popups).each(function(i,elt){elt.hide();});this.map.addPopup(popup,true);},renderMap:function(target,centerLongitude,centerLatitude,zoomLevel){Dashboards.log('Entered renderMap','debug');var myself=this;var useLayerControl=false;var customMap=false;var centerPoint;if(centerLongitude&&centerLongitude!=''&&centerLatitude&&centerLatitude!=''){if(this.useMercator){centerPoint=lonLatToMercator(new OpenLayers.LonLat(centerLongitude,centerLatitude));}else{centerPoint=new OpenLayers.LonLat(centerLongitude,centerLatitude);}}
this.map=new OpenLayers.Map(target,{maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),numZoomLevels:18,maxResolution:156543,units:'m',zoomDuration:10,displayProjection:new OpenLayers.Projection("EPSG:4326"),projection:"EPSG:900913",controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.DragPan(),new OpenLayers.Control.PinchZoom(),new OpenLayers.Control.LayerSwitcher({'ascending':false}),new OpenLayers.Control.ScaleLine(),new OpenLayers.Control.KeyboardDefaults(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.Attribution(),new OpenLayers.Control.TouchNavigation()]});var myOptions={type:'png',transparent:'true',transitionEffect:'resize',displayOutsideMaxExtent:true};var layer;for(var k=0,m=this.tilesets.length;k<m;k++){var thisTileset=this.tilesets[k],tileset=this.tilesets[k].slice(0).split('-')[0],variant=this.tilesets[k].slice(0).split('-').slice(1).join('-')||'default';Dashboards.log('Tilesets: '+JSON.stringify(this.tilesets)+', handling now :'+thisTileset+', ie tileset '+tileset+', variant '+variant);switch(tileset){case'googleXXX':layer=new OpenLayers.Layer.Google("Google Streets",{visibility:true,version:'3'});break;case'opengeo':layer=new OpenLayers.Layer.WMS(thisTileset,"http://maps.opengeo.org/geowebcache/service/wms",{layers:variant,bgcolor:'#A1BDC4'},{wrapDateLine:true,transitionEffect:'resize'});break;default:layer=this.tileLayer(thisTileset);break;}
this.map.addLayer(layer);}
this.shapes=new OpenLayers.Layer.Vector('Shapes',{rendererOptions:{zIndexing:true}});this.shapes.styleMap=new OpenLayers.StyleMap({'default':{graphicZIndex:0},'select':{graphicZIndex:1}});this.markers=new OpenLayers.Layer.Vector("Markers");this.map.addLayers([this.shapes,this.markers]);this.setCallbacks();if(centerPoint){this.map.setCenter(centerPoint);this.centered=true;}else{this.map.setCenter(lonLatToMercator(new OpenLayers.LonLat(-9.15,38.46)));}
if(zoomLevel!='')
this.map.zoomTo(zoomLevel);Dashboards.log('NewMapComponent: exited renderMap','debug');this.postRenderMap();},postRenderMap:function(){},setCallbacks:function(){var myself=this;function event_relay(e){var prefix;if(e.feature.layer.name=="Shapes"){prefix='shape';}else{prefix='marker';}
var events={'featurehighlighted':'mouseover','featureunhighlighted':'mouseout','featureselected':'click'};if(events[e.type]){myself.mapComponent.trigger(prefix+':'+events[e.type],myself.wrapEvent(e));}}
var hoverCtrl=new OpenLayers.Control.SelectFeature([this.markers,this.shapes],{hover:true,highlightOnly:true,renderIntent:"temporary",eventListeners:{featurehighlighted:event_relay,featureunhighlighted:event_relay,featureselected:event_relay}});this.map.addControl(hoverCtrl);hoverCtrl.activate();var clickCtrl=new OpenLayers.Control.SelectFeature([this.markers,this.shapes],{clickout:false});this.map.addControl(clickCtrl);clickCtrl.activate();this.markers.events.on({featurehighlighted:function(e){myself.mapComponent.trigger('marker:mouseover',myself.wrapEvent(e));},featureunhighlighted:function(e){myself.mapComponent.trigger('marker:mouseout',myself.wrapEvent(e));},featureselected:function(e){myself.mapComponent.trigger('marker:click',myself.wrapEvent(e));clickCtrl.unselectAll();}});this.shapes.events.on({featurehighlighted:function(e){myself.mapComponent.trigger('shape:mouseover',myself.wrapEvent(e));},featureunhighlighted:function(e){myself.mapComponent.trigger('shape:mouseout',myself.wrapEvent(e));},featureselected:function(e){myself.mapComponent.trigger('shape:click',myself.wrapEvent(e));}});},tileLayer:function(name){var urlTemplate=this.tileServices[name];var options=_.extend({"transitionEffect":"resize"},this.tileServicesOptions[name]||{});if(!urlTemplate){if(name.length>0&&name.contains('{')){urlTemplate=name;name='custom';}}
return new OpenLayers.Layer.XYZ(name,this._switchUrl(urlTemplate),_.defaults({},options));}});
var NewMapComponent=(function(){var ShapeConversionMixin={parseShapeKey:undefined,getShapeFromKML:function(rawData){var myself=this,mymap={};var result=$(rawData).find('Placemark').each(function(idx,y){var key;if(_.isFunction(myself.parseShapeKey)){try{key=myself.parseShapeKey(y);}catch(e){key=$(y).find('name').text();}}else{key=$(y).find('name').text();}
var polygonArray=_.map($(y).find('Polygon'),function(yy){var polygon=[];_.each(['outerBoundaryIs','innerBoundaryIs'],function(b){var polygonObj=$(yy).find(b+' LinearRing coordinates');_.each(polygonObj,function(v){var s=$(v).text().trim();if(s.length>0){var p=_.map(s.split(' '),function(el){return _.map(el.split(',').slice(0,2),parseFloat).reverse();});polygon.push(p);}});});return polygon;});if(_.isEmpty(polygonArray)){return;}
if(!mymap[key]){mymap[key]=polygonArray;}});return mymap;},reducePoints:function(points,precision_m){if(precision_m<0){return points;}
function properRDP(points,epsilon){var firstPoint=points[0];var lastPoint=points[points.length-1];if(points.length<3){return points;}
var index=-1;var dist=0;for(var i=1;i<points.length-1;i++){var cDist=findPerpendicularDistance(points[i],firstPoint,lastPoint);if(cDist>dist){dist=cDist;index=i;}}
if(dist>epsilon){var l1=points.slice(0,index+1);var l2=points.slice(index);var r1=properRDP(l1,epsilon);var r2=properRDP(l2,epsilon);var rs=r1.slice(0,r1.length-1).concat(r2);return rs;}else{return[firstPoint,lastPoint];}}
function findPerpendicularDistance(p,p1,p2){var result;var slope;var intercept;if(p1[0]==p2[0]){result=Math.abs(p[0]-p1[0]);}else{slope=(p2[1]-p1[1])/(p2[0]-p1[0]);intercept=p1[1]-(slope*p1[0]);result=Math.abs(slope*p[0]-p[1]+intercept)/Math.sqrt(Math.pow(slope,2)+1);}
return result;}
return properRDP(points,precision_m/6.3e6);},exportShapeDefinition:function(){if(this.shapeDefinition){window.open("data:text/json;charset=utf-8,"+escape(JSON.stringify(this.shapeDefinition)));}}};var ColorMapMixin={colormap:[[0,102,0,255],[255,255,0,255],[255,0,0,255]],colormaps:{'jet':[],'gray':[[0,0,0,255],[255,255,255,255]],'french-flag':[[255,0,0,255],[255,254,255,255],[0,0,255,255]]},getColorMap:function(){var interpolate=function(a,b,n){var c=[],d=[];var k,kk,step;for(k=0;k<a.length;k++){c[k]=[];for(kk=0,step=(b[k]-a[k])/n;kk<n;kk++){c[k][kk]=a[k]+kk*step;}}
for(k=0;k<c[0].length;k++){d[k]=[];for(kk=0;kk<c.length;kk++){d[k][kk]=Math.round(c[kk][k]);}}
return d;};var cmap=[];for(k=1;k<this.colormap.length;k++)
{cmap=cmap.concat(interpolate(this.colormap[k-1],this.colormap[k],32));}
return _.map(cmap,function(v){return'rgba('+v.join(',')+')';});},mapColor:function(value,minValue,maxValue,colormap){var n=colormap.length;var level=(value-minValue)/(maxValue-minValue);return colormap[Math.floor(level*(n-1))];}};var MyClass=UnmanagedComponent.extend(ShapeConversionMixin).extend(ColorMapMixin).extend({ph:undefined,mapEngine:undefined,values:undefined,API_KEY:false,tileServices:{'default':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'apple':"http://gsp2.apple.com/tile?api=1&style=slideshow&layers=default&lang=en_US&z=${z}&x=${x}&y=${y}&v=9",'google':"http://mt{switch:0,1,2,3}.googleapis.com/vt?x=${x}&y=${y}&z=${z}",'mapquest':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'mapquest-normal':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png",'mapquest-hybrid':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/hyb/${z}/${x}/${y}.png",'mapquest-sat':"http://otile{switch:1,2,3,4}.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg",'mapbox-world-light':"https://{switch:a,b,c,d}.tiles.mapbox.com/v3/mapbox.world-light/${z}/${x}/${y}.jpg",'mapbox-world-dark':"https://{switch:a,b,c,d}.tiles.mapbox.com/v3/mapbox.world-dark/${z}/${x}/${y}.jpg",'mapbox-terrain':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.map-9ijuk24y/${z}/${x}/${y}.jpg','mapbox-satellite':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.map-qfyrx5r8/${z}/${x}/${y}.png','mapbox-example':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.c7d2024a/${z}/${x}/${y}.png','mapbox-example2':'https://{switch:a,b,c,d}.tiles.mapbox.com/v3/examples.bc17bb2a/${z}/${x}/${y}.png','openstreetmaps':"http://{switch:a,b,c}.tile.openstreetmap.org/${z}/${x}/${y}.png",'openmapsurfer':'http://129.206.74.245:8001/tms_r.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-roads':'http://129.206.74.245:8001/tms_r.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-semitransparent':'http://129.206.74.245:8003/tms_h.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-hillshade':'http://129.206.74.245:8004/tms_hs.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-contour':'http://129.206.74.245:8006/tms_b.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-administrative':'http://129.206.74.245:8007/tms_b.ashx?x=${x}&y=${y}&z=${z}','openmapsurfer-roads-grayscale':'http://129.206.74.245:8008/tms_rg.ashx?x=${x}&y=${y}&z=${z}','stamen':"http://{switch:a,b,c,d}.tile.stamen.com/terrain/${z}/${x}/${y}.jpg",'stamen-terrain':"http://{switch:a,b,c,d}.tile.stamen.com/terrain/${z}/${x}/${y}.jpg",'stamen-terrain-background':"http://{switch:a,b,c,d}.tile.stamen.com/terrain-background/${z}/${x}/${y}.jpg",'stamen-terrain-labels':"http://{switch:a,b,c,d}.tile.stamen.com/terrain-labels/${z}/${x}/${y}.jpg",'stamen-toner':"http://{switch:a,b,c,d}.tile.stamen.com/toner/${z}/${x}/${y}.png",'stamen-toner-lite':"http://{switch:a,b,c,d}.tile.stamen.com/toner-lite/${z}/${x}/${y}.png",'stamen-toner-background':"http://{switch:a,b,c,d}.tile.stamen.com/toner-background/${z}/${x}/${y}.png",'stamen-toner-hybrid':"http://{switch:a,b,c,d}.tile.stamen.com/toner-hybrid/${z}/${x}/${y}.png",'stamen-toner-labels':"http://{switch:a,b,c,d}.tile.stamen.com/toner-labels/${z}/${x}/${y}.png",'stamen-toner-lines':"http://{switch:a,b,c,d}.tile.stamen.com/toner-lines/${z}/${x}/${y}.png",'stamen-toner-2010':"http://{switch:a,b,c,d}.tile.stamen.com/toner-2010/${z}/${x}/${y}.png",'stamen-toner-2011':"http://{switch:a,b,c,d}.tile.stamen.com/toner-2011/${z}/${x}/${y}.png",'stamen-watercolor':"http://{switch:a,b,c,d}.tile.stamen.com/watercolor/${z}/${x}/${y}.jpg",'nokia-normal':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day/${z}/${x}/${y}/256/png8','nokia-normal-grey':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day.grey/${z}/${x}/${y}/256/png8','nokia-normal-transit':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/normal.day.transit/${z}/${x}/${y}/256/png8','nokia-satellite':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/satellite.day/${z}/${x}/${y}/256/png8','nokia-terrain':'http://maptile.maps.svc.ovi.com/maptiler/maptile/newest/terrain.day/${z}/${x}/${y}/256/png8','arcgis-street':'http://services.arcgisonline.com/ArcGIS/rest/services/World_street_Map/MapServer/tile/${z}/${y}/${x}','arcgis-topographic':'http://services.arcgisonline.com/ArcGIS/rest/services/World_street_Topo/MapServer/tile/${z}/${y}/${x}','arcgis-natgeo':'http://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/${z}/${y}/${x}','arcgis-world':'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${z}/${y}/${x}','arcgis-lightgray':'http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/${z}/${y}/${x}','arcgis-delorme':'http://services.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer/tile/${z}/${y}/${x}'},otherTileServices:[],tileServicesOptions:{'apple':{minZoom:3,maxZoom:14}},update:function(){this.registerEvents();if(_.isString(this.tilesets)){this.tilesets=[this.tilesets];}
if(this.testData){this.render(this.testData);return;}
Dashboards.log('Starting clock of '+this.htmlObject,'debug');this.clock=(new Date());if(this.queryDefinition&&!$.isEmptyObject(this.queryDefinition)){if((this.mapMode=="shapes")&&(!_.isEmpty(this.shapeSource))){this.load_deferred();}else{this.triggerQuery(this.queryDefinition,_.bind(this.render,this));}}else{this.synchronous(_.bind(this.render,this),{});}},dataRequest:function(url,callback){return $.ajax(url,{async:true,type:'GET',processData:url.endsWith('json')}).then(callback);},load_deferred_hack:function(){var myself=this;var deferredQuery=function(){var _deferredQuery=$.Deferred(),myself=this;this.triggerQuery(this.queryDefinition,function(data){_deferredQuery.resolve(data);});return _deferredQuery.promise();};return $.when(this.dataRequest(this.shapeSource),deferredQuery()).done(function(shapes,resultset){myself.processShapeDefinition(shapes,function(){});myself.render(resultset);});},load_deferred:function(){var myself=this;if(!this.preExec()){return null;}
var deferreds=[this.dataRequest(myself.shapeSource,_.bind(this.processShapeDefinition,this))];if(this.mapEngine=='google'){deferreds.push(loadGoogleMaps('3',this.API_KEY));}
return this.deferredTriggerQuery(this.queryDefinition,deferreds,function(resultset){myself.render(resultset);});},deferredTriggerQuery:function(queryDef,deferreds,callback,userQueryOptions){var silent=this.isSilent();if(!silent){this.block();};userQueryOptions=userQueryOptions||{};var success=_.bind(function(data){return data;},this);var always=_.bind(function(){if(!silent){this.unblock();}},this);this.getDeferredSuccessHandler=function(success){var counter=this.callCounter();return _.bind(function(data){var newData,result;if(counter>=this.runCounter){try{if(typeof this.postFetch=="function"){newData=this.postFetch(data);this.trigger('cdf cdf:postFetch',this,data);data=typeof newData=="undefined"?data:newData;}
result=success(data);}catch(e){this.error(Dashboards.getErrorObj('COMPONENT_ERROR').msg,e);this.dashboard.log(e,"error");}}
return result;},this);};var querySuccess=this.getDeferredSuccessHandler(success);var queryError=this.getErrorHandler();var query=this.queryState=this.query=Dashboards.getQuery(queryDef);var ajaxOptions={async:true};if(userQueryOptions.ajax){_.extend(ajaxOptions,userQueryOptions.ajax);}
query.setAjaxOptions(ajaxOptions);if(userQueryOptions.pageSize){query.setPageSize(userQueryOptions.pageSize);}
var myself=this;var launchQuery=function(){var _deferredQuery=$.Deferred();query.fetchData(myself.parameters,function(){var data=querySuccess.apply(myself,arguments);var processedArgs=_.extend([],arguments);processedArgs[0]=data;_deferredQuery.resolve.apply(myself,processedArgs);},function(){queryError.apply(myself,arguments);_deferredQuery.reject();});return _deferredQuery.promise().done(always);};var deferredSuccess=function(datasets){if(_.isFunction(callback)){callback(datasets);}
myself.postExec();};deferreds=deferreds||[];deferreds.unshift(launchQuery());return $.when.apply(null,deferreds).then(deferredSuccess);},triggerQuery:function(queryDef,callback,userQueryOptions){var myself=this;if(!this.preExec()){return;}
this.deferredTriggerQuery(this.queryDefinition,null,function(resultset){if(_.isFunction(callback)){callback(resultset);}});},load_sequential:function(){var myself=this;this.triggerQuery(this.queryDefinition,function(resultset){myself.getShapeDefinition(function(){myself.render(resultset);});});},getShapeDefinition:function(callback){Dashboards.log('NewMapComponent.getShapeDefinition: entered with arguments '+JSON.stringify(arguments),'debug');var myself=this;if(this.shapeSource&&!_.isEmpty(this.shapeSource)&&!this.shapeDefinition){var filetype=this.shapeSource.split('.').reverse()[0].toLowerCase();$.ajax(this.shapeSource,{async:true,type:'GET',processData:this.shapeSource.endsWith('json'),success:function(data){myself.processShapeDefinition(data,callback);}});}},processShapeDefinition:function(data,callback){var filetype=this.shapeSource.split('.').reverse()[0].toLowerCase();if(data){switch(filetype){case'kml':Dashboards.log('parsing shapes','debug');this.shapeDefinition=this.getShapeFromKML(data,this.parseShapeKey);break;case'json':this.shapeDefinition=data;break;}
if(_.isFunction(this.postProcessShape)){this.shapeDefinition=this.postProcessShape(this.shapeDefinition);}}
if(_.isFunction(callback)){Dashboards.log('NewMapComponent.processShapeDefinition: callback is a function','debug');callback(data);}},postProcessShape:function(shapeDefinition){return shapeDefinition;},render:function(values){Dashboards.log('Stopping clock at render in '+this.htmlObject+': took '+(new Date()-this.clock)+' ms','debug');if(this.shapeDefinition){Dashboards.log('Loaded '+_.keys(this.shapeDefinition).length+' shapes','debug');}
if(this.mapEngineType=='google'){this.mapEngine=new GoogleMapEngine();}else{this.mapEngine=new OpenLayersEngine();}
this.values=values;this.mapEngine.API_KEY=this.API_KEY||window.API_KEY;this.mapEngine.tileServices=this.tileServices;this.mapEngine.tileServicesOptions=this.tileServicesOptions;this.mapEngine.init(this,this.tilesets);},initCallBack:function(){this.ph=$('#'+this.htmlObject);var $popupDivHolder=$("#"+this.popupContentsDiv).clone();this.ph.empty();if(this.popupContentsDiv&&$("#"+this.popupContentsDiv).length!=1){this.ph.append($popupDivHolder.html("None"));}
this.mapEngine.renderMap(this.ph[0],this.centerLongitude,this.centerLatitude,this.defaultZoomLevel);switch(this.mapMode){case'shapes':this.setupShapes(this.values);break;case'markers':this.setupMarkers(this.values);break;}
Dashboards.log('Stopping clock: update cycle of '+this.htmlObject+' took '+(new Date()-this.clock)+' ms','debug');},registerEvents:function(){var myself=this;this.on('marker:click',function(event){var result;if(_.isFunction(this.markerClickFunction)){result=this.markerClickFunction(event);}
if(result!==false){this.markerClickCallback(event);}});this.on('shape:mouseover',function(event){if(_.isFunction(myself.shapeMouseOver)){var result=myself.shapeMouseOver(event);if(result){event.draw(_.defaults(result,{'zIndex':1},event.style));}}});this.on('shape:mouseout',function(event){if(_.isFunction(myself.shapeMouseOut)){var result=myself.shapeMouseOut(event);if(result){event.draw(_.defaults(result,event.style));}else{event.draw(event.style);}}else if(myself.shapeMouseOver){event.draw(event.style);}});this.on('shape:click',function(event){if(_.isFunction(myself.shapeMouseClick)){var result=myself.shapeMouseClick(event);if(result){event.draw(_.defaults(result,event.style));}}});},setupShapes:function(values){if(!this.shapeDefinition){return;}
if(!values||!values.resultset){return;}
var myself=this;var idxKey=0,idxValue=1;var shapeSettings=_.defaults(this.shapeSettings||{},{strokeWidth:2,strokeColor:'white',zIndex:0});var colormap=this.getColorMap();var qvalues=_.map(values.resultset,function(row){return row[idxValue];});var minValue=_.min(qvalues),maxValue=_.max(qvalues);$(values.resultset).each(function(i,elt){var fillColor=myself.mapColor(elt[idxValue],minValue,maxValue,colormap);myself.renderShape(myself.shapeDefinition[elt[idxKey]],_.defaults({fillColor:fillColor},shapeSettings),{rawData:elt,key:elt[idxKey],value:elt[idxValue],minValue:minValue,maxValue:maxValue});});this.mapEngine.postSetShapes(this);},renderShape:function(shapeDefinition,shapeSettings,data){this.mapEngine.setShape(shapeDefinition,shapeSettings,data);},setupMarkers:function(values){if(!values||!values.resultset)
return;var mapping=this.getMapping(values);var myself=this;$(values.resultset).each(function(i,elt){var location;if(mapping.addressType!='coordinates'){location=myself.getAddressLocation((mapping.address!=undefined?elt[mapping.address]:undefined),mapping.addressType,elt,mapping,i);}else{location=[elt[mapping.longitude],elt[mapping.latitude]];myself.renderMarker(location,elt,mapping,i);}});},renderMarker:function(location,elt,mapping,position){var myself=this;if(location===undefined){Dashboards.log('Unable to get location for address '+elt[mapping.address]+'. Ignoring element.','debug');return true;}
var markerIcon;var description;var markerWidth=myself.markerWidth;if(mapping.markerWidth){markerWidth=elt[mapping.markerWidth];}
var markerHeight=myself.markerHeight;if(mapping.markerHeight){markerHeight=elt[mapping.markerHeight];}
var defaultMarkers=false;if(mapping.marker){markerIcon=elt[mapping.marker];}
if(markerIcon==undefined){var st={data:elt,position:position};var addinName=this.markerImageGetter;if(this.markerCggGraph){st.cggGraphName=this.markerCggGraph;st.width=markerWidth;st.height=markerHeight;st.parameters={};$(this.cggGraphParameters).each(function(i,parameter){st.parameters[parameter[0]]=elt[mapping[parameter[1]]];});addinName='cggMarker';}else{st.url=myself.marker;defaultMarkers=(myself.marker==undefined);addinName='urlMarker';}
if(!addinName){addinName='urlMarker';}
var addIn=this.getAddIn("MarkerImage",addinName);markerIcon=addIn.call(this.ph,st,this.getAddInOptions("MarkerImage",addIn.name));}
if(mapping.description)description=elt[mapping.description];Dashboards.log('About to render '+location[0]+' / '+location[1]+' with marker '+marker+' sized '+markerHeight+' / '+markerWidth+'and description '+description,'debug');var markerInfo={longitude:location[0],latitude:location[1],defaultMarkers:defaultMarkers,position:position,mapping:mapping};myself.mapEngine.setMarker(location[0],location[1],markerIcon,description,elt,markerWidth,markerHeight,markerInfo);},markerClickCallback:function(event){var myself=this;var elt=event.data;var defaultMarkers=event.marker.defaultMarkers;var mapping=event.marker.mapping;var position=event.marker.position;$(this.popupParameters).each(function(i,eltA){Dashboards.fireChange(eltA[1],event.data[mapping[eltA[0].toLowerCase()]]);});if(this.popupContentsDiv||mapping.popupContents){var contents;if(mapping.popupContents)contents=elt[mapping.popupContents];var height=mapping.popupContentsHeight?elt[mapping.popupContentsHeight]:undefined;if(!height)height=this.popupHeight;var width=mapping.popupContentsWidth?elt[mapping.popupContentsWidth]:undefined;if(!width)width=this.popupWidth;var borderColor=undefined;if(defaultMarkers){var borderColors=["#394246","#11b4eb","#7a879a","#e35c15","#674f73"];borderColor=borderColors[position%5];}
this.mapEngine.showPopup(event.data,event.feature,height,width,contents,this.popupContentsDiv,borderColor);}},getAddressLocation:function(address,addressType,data,mapping,position){var addinName=this.locationResolver;if(!addinName)addinName='openstreetmap';var addIn=this.getAddIn("LocationResolver",addinName);var target=this.ph;var state={address:address,addressType:addressType,position:position};if(mapping.country!=undefined)state.country=data[mapping.country];if(mapping.city!=undefined)state.city=data[mapping.city];if(mapping.county!=undefined)state.county=data[mapping.county];if(mapping.region!=undefined)state.region=data[mapping.region];if(mapping.state!=undefined)state.state=data[mapping.state];var myself=this;state.continuationFunction=function(location){myself.renderMarker(location,data,mapping,position);};addIn.call(target,state,this.getAddInOptions("LocationResolver",addIn.name));},getMapping:function(values){var map={};if(!values.metadata||values.metadata.length==0)
return map;$(values.metadata).each(function(i,elt){switch(elt.colName.toLowerCase()){case'latitude':map.addressType='coordinates';map.latitude=i;break;case'longitude':map.addressType='coordinates';map.longitude=i;break;case'description':map.description=i;break;case'marker':map.marker=i;break;case'markerwidth':map.markerWidth=i;break;case'markerheight':map.markerHeight=i;break;case'popupcontents':map.popupContents=i;break;case'popupwidth':map.popupWidth=i;break;case'popupheight':map.popupHeight=i;break;case'address':if(!map.addressType){map.address=i;map.addressType='address';}
break;default:map[elt.colName.toLowerCase()]=i;break;}});return map;}});return MyClass;})();
var TextEditorComponent=BaseComponent.extend({$ph:undefined,$rightPanel:undefined,isRightPanelShown:false,isInitialized:false,externalEditor:undefined,defaultButtons:[{clazz:"save",label:"Save",callback:function(){this.save();if(typeof this.saveCallback==="function"){this.saveCallback();}}}],template:function(){return"<div class='textEditorComponent'><div class='textEditorControls'>"+"<div class='textEditorFile'><span class='fileLabel'>File: </span>{{file}}</div>"+"<div class='textEditorButtons'>{{#buttons}}<button class='{{clazz}}'>{{label}}</button>{{/buttons}}</div>"+"</div><div class='textEditorNotification'><span class='textEditorNotificationMsg'>Test</span></div>"+"<div class='textEditorRightPanel'></div>"+"<div class='textEditorIframeContainer'><div class='textEditorIframe'><iframe seamless='true' marginheight='0'></iframe></div>"+"</div>"},initialize:function(){Dashboards.log("Initializing TextEditorComponent")
this.isInitialized=true;if(this.htmlObject){this.$ph=$("#"+this.htmlObject);}
else{this.$ph=$("<div id='textEditorDefautlId'></div>").appendTo("body");}},update:function(){var myself=this;if(this.parameter){this.setFile(Dashboards.getParameterValue(this.parameter));}
if(!this.isInitialized){myself.initialize();}
this.isRightPanelShown=false;var buttons=this.getButtons();this.$ph.html(Mustache.render(this.template(),{file:this.file||"Unknown file",buttons:buttons}));this.$ph.find(".textEditorControls").on("click","button",function(){var $this=$(this);var idx=$this.prevAll("button").length;buttons[idx].callback(arguments);})
if(this.file){this.loadFile();}},getButtons:function(){var myself=this;var _extraButtons=this.extraButtons||[];_.chain(this.defaultButtons).each(function(b){b.callback=_.bind(b.callback,myself);})
return this.defaultButtons.concat(_extraButtons);},setFile:function(_file){this.file=_file;},getFile:function(){return this.file;},loadFile:function(){var myself=this;$('button.save',this.$ph).attr('disabled',true);this.externalEditor=$('iframe',this.$ph);var headerHeight=$('.textEditorControls',this.$ph).height()+$('.textEditorNotification',this.$ph).height();var editorHeight=this.$ph.height()-headerHeight-5;this.externalEditor.height(editorHeight);this.externalEditor.load(function()
{var editorEnv=myself.getEditorWindow();editorEnv.listeners.onStatusUpdate=myself.setDirty;editorEnv.listeners.notify=function(msg,type){myself.notify(msg);}
$('#notifications').hide();});this.externalEditor.attr('src',"/pentaho"+wd.helpers.editor.getUrl()+'path='+this.file+'&theme=ace/theme/eclipse&editorOnly=true');},notify:function(msg,level){var $notifications=this.$ph.find(".textEditorNotificationMsg");$notifications.text(msg);$notifications.show().delay(4000).fadeOut('slow');},setDirty:function(isDirty){$('button.save',this.$ph).attr('disabled',!isDirty);},getEditorWindow:function(){return this.externalEditor[0].contentWindow;},save:function(){this.getEditorWindow().save();},getRightPanel:function(){return this.$ph.find(".textEditorRightPanel");},toggleRightPanel:function(){this.getRightPanel().toggle();this.isRightPanelShown=!this.isRightPanelShown;this.getEditorWindow().editor.getEditor().resize();return this.isRightPanelShown;}});var PopupTextEditorComponent=BaseComponent.extend({$ph:undefined,isInitialized:false,textEditor:undefined,textEditorPopupId:"popupTextEditorId",isQueryPreviewShown:false,testPromptPopup:undefined,$testPromptPopupObj:undefined,defaultButtons:[{clazz:"run",label:"Preview Test",callback:function(){this.runTest();}},{clazz:"previewQuery",label:"Query results",callback:function(){this.toggleQueryResults();}},{clazz:"close",label:"Close",callback:function(){this.hide();}}],initialize:function(){Dashboards.log("Initializing PopupTextEditorComponent")
this.isInitialized=true;this.$ph=$("#"+this.textEditorPopupId);if(this.$ph.length>0){Dashboards.log("[PopupTextEditorComponent] Unexpected - Found an element with id "+this.popupTextEditorDefautlId)}
else{this.$ph=$("<div id='"+this.textEditorPopupId+"'></div>").appendTo("body");}
this.textEditor={name:"popupInnerTextEditorComponent",type:"textEditor",file:undefined,htmlObject:this.textEditorPopupId,extraButtons:this.getButtons(),saveCallback:this.saveCallback};Dashboards.addComponents([this.textEditor]);},update:function(){var myself=this;this.isQueryPreviewShown=false;if(!this.isInitialized){myself.initialize();}
this.textEditor.update();},show:function(){this.$ph.find(">div.textEditorComponent").height($(window).height());this.$ph.slideDown();},hide:function(){this.$ph.slideUp();},runTest:function(){var env=this.setupEnvironment();if(env){var test=this.getTestToOperate(env,this.runTestCallback,$("button.previewQuery",this.$ph));}},runTestCallback:function(env,test){var myself=this;this.textEditor.notify("Running test...");env.cdv.runTest(test,{callback:function(result){myself.textEditor.notify(result.getTestResultDescription());}});},toggleQueryResults:function(){if(this.isQueryPreviewShown){this.isQueryPreviewShown=this.textEditor.toggleRightPanel();return;}
var env=this.setupEnvironment();if(env){var test=this.getTestToOperate(env,this.toggleQueryResultsCallback,$("button.run",this.$ph));}},toggleQueryResultsCallback:function(env,test){var myself=this;this.textEditor.notify("Running query...");env.cdv.executeQuery(test,null,function(test,opts,queryResult){myself.textEditor.notify("Queries ran in "+queryResult.duration+"ms");myself.textEditor.getRightPanel().html("<pre>"+JSON.stringify(queryResult.resultset,undefined,2)+"</pre>");myself.isQueryPreviewShown=myself.textEditor.toggleRightPanel();wd.log("Toggling!");});},getButtons:function(){var myself=this;var _extraButtons=this.extraButtons||[];_.chain(this.defaultButtons).each(function(b){b.callback=_.bind(b.callback,myself);})
return this.defaultButtons.concat(_extraButtons);},setFile:function(_file){this.file=_file;this.textEditor.setFile(_file);},setupEnvironment:function(){var src=this.textEditor.getEditorWindow().editor.getContents();var mask={cdv:wd.cdv.cdv({isServerSide:false})};for(p in this)
mask[p]=undefined;try{(new Function("with(this) { "+src+"}")).call(mask);}
catch(err){alert(err);return null;}
return mask;},getTestToOperate:function(env,operationCallback,target){var myself=this;var flattenedTests=env.cdv.listTestsFlatten().sort(function(a,b){return(a.group+a.name)>=(b.group+b.name)});if(flattenedTests.length==1){operationCallback.call(myself,env,env.cdv.getTest(flattenedTests[0].group,flattenedTests[0].name));return;}
if(!this.testPromptPopup){this.testPromptPopup={name:"testPromptPopup",type:"popup",htmlObject:'testPromptPopupObj',gravity:"S",draggable:false,closeOnClickOutside:true}
this.$testPromptPopupObj=$("<div id='testPromptPopupObj'></div>").appendTo("body");Dashboards.addComponents([this.testPromptPopup]);this.testPromptPopup.update();this.$testPromptPopupObj.parent("div.popupComponent").addClass("testPromptPopup");}
var template='<div class="testChooserWrapper"><div class="title">Multiple tests found. Choose the one you want:</div>'+'<div class="testChooserButtons">{{#tests}}<button> {{group}} - {{name}}</button>{{/tests}}</div></div>'
this.$testPromptPopupObj.html(Mustache.render(template,{tests:flattenedTests}));this.$testPromptPopupObj.off("click","button");this.$testPromptPopupObj.on("click","button",function(evt){var idx=$(this).prevAll("button").length;operationCallback.call(myself,env,env.cdv.getTest(flattenedTests[idx].group,flattenedTests[idx].name));myself.testPromptPopup.hide();})
this.testPromptPopup.popup(target);return;}});
var BogusComponent=BaseComponent.extend({update:function(){if(this.parameters==undefined){this.parameters=[];}
$("#"+this.htmlObject).empty();var myself=this;this.customfunction(this.parameters);}});
var wd=wd||{};wd.components=wd.components||{};wd.components.olapSelector=wd.components.olapSelector||{};var OlapSelectorModel=Backbone.Model.extend({defaults:{"title":"","search":true,"multiselect":true,"multilevelselect":true,"deselectDescendants":false,"searchterm":"","collapsed":true,"values":null,"level":"","paginate":true,"pageStart":0,"pageSize":42,"morePages":false,"totalRecords":0,"mode":"level",olapUtils:null,"levels":null,"breadcrumb":[],"preselected":[],"parameters":[]},initialize:function(){var values=new Backbone.Collection();this.set("values",values);values.comparator=function(left,right){var leftLevel=left.get("level"),rightLevel=right.get("level"),leftMember=left.get("name"),rightMember=right.get("name"),cmpLevel=leftLevel.localeCompare(rightLevel),cmpMember=leftMember.localeCompare(rightMember);return cmpLevel!=0?cmpLevel/Math.abs(cmpLevel):cmpMember!=0?cmpMember/Math.abs(cmpMember):0;};values.model=OptionModel;this.updateValues();this.set("levels",new Backbone.Collection());var levels=this.get("levels");levels.model=LevelModel;this.updateLevels();this.processLevelSelection();levels.on("change:selected",this.processLevelSelection,this);this.setupEvents();this.preSelectValues();},preSelectValues:function(){var myself=this,olapUtils=this.get("olapUtils"),defaultSelect=myself.get("preselected"),levelsArray=myself.get("levels");for(var i=0;i<levelsArray.length;i++){options={pageSize:this.get("pageSize"),pageStart:this.get("pageStart"),searchTerm:this.get("searchterm"),level:levelsArray.at(i).get("name")};olapUtils.getPaginatedLevelMembers(options,function(v){var toChange=myself.processPreSelectValues(v.members,defaultSelect);myself.addPreSelectValues(toChange,myself);});}},processPreSelectValues:function(members,defaultVals){var values=[],selectedLevelDepth=this.getSelectedLevels().at(0).get("depth"),memberDepth;if(!defaultVals.length){return members;}
for(var c=0;c<members.length;c++){level=members[c];memberDepth=(level.qualifiedName.split(".").length-1);for(var p=0;p<defaultVals.length;p++){if(level.qualifiedName===defaultVals[p]){level.selected=true;values.push(level);break;}else if(selectedLevelDepth===memberDepth){values.push(level);break;}}}
return values;},addPreSelectValues:function(toChange,myself){var newValue,values=myself.get("values");for(c=0;c<toChange.length;c++){var newValue=toChange[c],depth;depth=(newValue.qualifiedName.split(".").length-2);newValue.level=myself.get("levels").at(depth).id;values.add(newValue,{silent:true});}
values.trigger("add");},updateLevels:function(){var olapUtils=this.get("olapUtils"),h=olapUtils.getHierarchy();if(h.hasAll){var allMember={name:h.defaultMember,qualifiedName:h.defaultMemberQualifiedName,allMember:true}
this.get("levels").add(allMember);}
this.get("levels").add(olapUtils.getLevels(),{silent:true});},processLevelSelection:function(evt){if(this.getSelectedLevels().length==0){if(evt==null){this.get("levels").at(0).set({"selected":true});}
else{evt.set({selected:true});}
return;}
if(this.getSelectedLevels().size()>1){_(this.getSelectedLevels().without(evt)).each(function(f){f.set({selected:false})});this.set("pageStart",0);return;}},getSelectedLevels:function(){return new Backbone.Collection(this.get("levels").where({selected:true}));},setupEvents:function(){var values=this.get("values");values.on("change:selected",this.updateSelection,this);values.on("change:drill",this.drillDown,this);this.on("page",this.fetchValues,this,this);this.on("change:collapsed",this.handleCollapse,this);this.on("change:searchterm",this.updateSearch,this);this.on("drillUp",this.drillUp,this);this.get("levels").on("select",this.changeLevel,this);},handleCollapse:function(m,isCollapsed){if(isCollapsed){return;}
var oldValues=this.get("values").where({selected:true}).map(function(e){return e.get("qualifiedName");});this.set("oldValues",oldValues);},apply:function(){this.toggleCollapsed();},cancel:function(){var oldValues=this.get("oldValues");this.get("values").each(function(e){e.set("selected",oldValues.indexOf(e.get("qualifiedName"))>-1);});this.get("values").trigger("select");this.toggleCollapsed();},drillDown:function(m,drill){this.get("breadcrumb").push(m);var levels=this.get("levels"),olapUtils=this.get("olapUtils"),defaultQualified=olapUtils.getHierarchy().defaultMemberQualifiedName,atTopLevel,selectedLevel=levels.where({selected:true})[0],qualifiedName=selectedLevel.get("qualifiedName"),idx=levels.indexOf(selectedLevel);selectedLevel.set("selected",false);atTopLevel=qualifiedName==defaultQualified;if(atTopLevel){levels.at(idx+2).set("selected",true);}else{levels.at(idx+1).set("selected",true);}
this.set("pageStart",0,{silent:true});this.trigger("drill");this.fetchValues();},drillUp:function(){var crumbtrail=this.get("breadcrumb");if(crumbtrail.length){crumbtrail.pop();var levels=this.get("levels"),selectedLevel=levels.where({selected:true})[0],idx=levels.indexOf(selectedLevel);selectedLevel.set("selected",false);this.set("pageStart",0,{silent:true});levels.at(idx-1).set("selected",true);this.trigger("drill");this.fetchValues();}},changeLevel:function(m,value){if(m&&value===false){return;}
this.set("breadcrumb",[]);this.trigger("drill");this.set("pageStart",0);this.fetchValues();},fetchValues:function(m,value){var selectedLevel=this.get("levels").where({selected:true})[0],olapUtils=this.get("olapUtils"),options={pageSize:this.get("pageSize"),pageStart:this.get("pageStart"),searchTerm:this.get("searchterm")},breadcrumb=this.get("breadcrumb"),level;if(breadcrumb&&breadcrumb.length){var l=breadcrumb.length-1;options.startMember=breadcrumb[l].get("qualifiedName");}
level=selectedLevel?selectedLevel.get("name"):"";if(!level||level==olapUtils.getHierarchy().defaultMember){options.level=olapUtils.getLevels()[0].name;}else{options.level=level;}
paramArray=this.get("parameters");if(paramArray.length>0){var nameArray=_.keys(paramArray);for(pos=0;pos<paramArray.length;pos++){options[nameArray[pos]]=paramArray[nameArray[pos]];}}
var myself=this;this.get("olapUtils").getPaginatedLevelMembers(options,function(v){myself.set("morePages",v.more);myself.addPage(v.members);});},addPage:function(newValues){var v,newValue,idx=this.get("pageStart");values=this.get("values");for(v=0;v<newValues.length;v++){var newValue=newValues[v],found;newValue.level=this.getSelectedLevels().at(0).get("qualifiedName");found=values.detect(function(model){return model.get("level")==newValue.level&&model.get("qualifiedName")==newValue.qualifiedName;});if(!found){values.add(newValue,{silent:true});}}
values.trigger("add");},nextPage:function(){if(!this.get("morePages")){return;}
var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",start+size);this.trigger("page");},prevPage:function(){if(this.get("pageStart")==0){return;}
var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",Math.max(0,start-size));this.trigger("page");},firstPage:function(){if(this.get("pageStart")==0){return;}
this.set("pageStart",0);this.trigger("page");},lastPage:function(){var total=this.get("totalRecords"),size=this.get("pageSize");this.set("pageStart",total-total%size);this.trigger("page");},goToPage:function(page){var size=this.get("pageSize");this.set("pageStart",page*size);this.trigger("page");},updateValues:function(values){this.get("values").reset(values);},updateSelection:function(m,selected){if(!selected){return}
var isMultiselect=this.get("multiselect"),deselectDescendants=this.get("deselectDescendants"),isMultilevel=this.get("multilevelselect"),selectedLevel=this.getSelectedLevels().at(0).get("qualifiedName"),memberName=m.get("qualifiedName");_(this.get("values").without(m)).each(function(other){if(!isMultiselect){other.set("selected",false);}
if(deselectDescendants&&other.get("qualifiedName").indexOf(memberName)>-1){other.set("selected",false);}
if(!isMultilevel&&selectedLevel!=other.get("level")){other.set("selected",false);}});},clearSelection:function(){this.get("values").each(function(m){m.set("selected",false);})},toggleCollapsed:function(predicate){this.set("collapsed",(_.isBoolean(predicate))?predicate:!this.get("collapsed"));},selectedValues:function(){return _(this.get("values").where({selected:true})).map(function(m){return m.get("value")});},updateSearch:function(){var term=this.get("searchterm");this.set("pageStart",0,{silent:true});this.fetchValues();},notifyUpdate:function(){this.trigger('notify',this);}});var OptionModel=Backbone.Model.extend({defaults:{"idx":0,"name":"","value":null,"level":null,"drill":false,"selected":false},toggleSelected:function(){this.set("selected",!this.get("selected"));}});var LevelModel=OptionModel.extend({defaults:{},initialize:function(o){this.on("change:qualifiedName change:name",function(o){wd.log("Detected changes");this.set("id",o.get("qualifiedName"));this.set("label",o.get("name"));});this.set("id",this.get("qualifiedName"));this.set("label",this.get("name"));}});var OlapSelectorView=Backbone.View.extend({events:{"click .title":"toggleCollapsed","click .first":"firstPage","click .prev":"prevPage","click .next":"nextPage","click .last":"lastPage","click .pages span":"goToPage","change .search input":"updateSearch","click .validate":"apply","click .cancel":"cancel","click .breadcrumb .name":"drillUp"},levelViews:[],renderLevels:function(){var levelContainer=this.$el.find(".levels").empty();_(this.levelViews).each(function(v){levelContainer.append(v.render().el);});},initialize:function(){this.initializeOptions();this.configureListeners();this.levelViews=[];this.model.get("levels").each(function(m){this.levelViews.push(new LevelView({model:m}));},this);},configureListeners:function(){this.model.on("change",this.render,this);this.model.on("drill",this.renderCrumbtrail,this);this.model.on("change:collapsed",this.updateCollapsed,this);this.model.on("page",this.renderPages,this);var values=this.model.get("values");values.on("add remove reset",this.updateOptions,this)
values.on("select",this.updateOptions,this);values.on("notify",this.notifyUpdate,this);},initializeOptions:function(){this._selectedViews=[];this._selectedViewsOut=[];this._optionViews=[];this.model.get("values").each(function(m){this._optionViews.push(new OptionView({model:m}));if(m.get("selected")){this._selectedViews.push(new SelectionView({model:m}));this._selectedViewsOut.push(new SelectionViewOut({model:m}));}},this);},updateSearch:function(evt){this.model.set("searchterm",evt.target.value);},render:function(){this.$el.html(templates.olapSelector.main(this.model.toJSON()));this.renderLevels();this.updateCollapsed();this.renderLevels();this.renderOptions();this.renderPages();this.renderCrumbtrail();this.delegateEvents();},renderCrumbtrail:function(){var currentLevelName=this.model.get("levels").where({selected:true})[0].get("name"),crumbtrail=this.model.get("breadcrumb");if(crumbtrail.length>0){var breadcrumb=crumbtrail[crumbtrail.length-1];this.$el.find(".breadcrumb").html(templates.olapSelector.crumbtrail({level:currentLevelName,name:breadcrumb.get("name")}));}else{this.$el.find(".breadcrumb").empty();}},renderPages:function(){var m=this.model;this.$el.find(".pagination .next").toggleClass("disabled",!m.get("morePages"));this.$el.find(".pagination .prev").toggleClass("disabled",!m.get("pageStart"));this.$el.find(".pagination .first").toggleClass("disabled",!m.get("pageStart"));},renderOptions:function(){var optionContainer=this.$el.find(".rightArea .options").empty(),selectionContainer=this.$el.find(".leftArea .selection").empty(),selectionContainerOut=this.$el.find(".outsideArea .selection").empty(),myself=this,minIdx=this.model.get('pageStart'),maxIdx=this.model.get('pageStart')+this.model.get('pageSize');_(this._optionViews).chain().filter(this.isVisible,this).slice(minIdx,maxIdx).each(function(v){optionContainer.append(v.render().el);},this);_(this._selectedViewsOut).each(function(v){selectionContainerOut.append(v.render().el);});_(this._selectedViews).each(function(v){selectionContainer.append(v.render().el);});},updateOptions:function(){this.initializeOptions();this.renderOptions();this.highlightParents();},notifyUpdate:function(){this.model.toggleCollapsed(false);this.model.toggleCollapsed(true);},isVisible:function(view){var parentModel=this.model,model=view.model,levelVisible=parentModel.getSelectedLevels().at(0).get("id")==model.get("level"),searchTerm=parentModel.get("searchterm"),searchVisible=searchTerm==null||RegExp(searchTerm,"i").test(model.get("name")),drillTerm=_.last(parentModel.get("breadcrumb")),drillVisible=drillTerm==null||model.get("qualifiedName").indexOf(drillTerm.get("qualifiedName"))>-1;return levelVisible&&searchVisible&&drillVisible;},highlightParents:function(){var parentModel=this.model,selectedMembers=parentModel.get("values").where({selected:true}).map(function(m){return m.get("qualifiedName");});_(this._optionViews).each(function(v){var name=v.model.get("qualifiedName");var childrenSelected=_(selectedMembers).chain().without(v.model.get("qualifiedName")).filter(function(m){return m.indexOf(name)>-1;}).value();v.$el.toggleClass("highlight",childrenSelected.length>0);if(childrenSelected.length>0){v.$el.find(".drill-down .label").text(childrenSelected.length);}else{v.$el.find(".drill-down .label").html("&nbsp;");}},this);},toggleSelected:function(m,selected){var vInner,vOuter,v;if(selected){vInner=new SelectionView({model:m});this.$el.find(".leftArea .selection").append(vInner.render().el);this._selectedViews.push(vInner);vOuter=new SelectionViewOut({model:m});this.$el.find(".outsideArea .selection").append(vOuter.render().el);this._selectedViews.push(vOuter);}else{v=_(this._selectedViews).filter(function(v){return v.model===m});var myself=this;_.each(v,function(e){e.remove();myself._selectedViews=_(myself._selectedViews).without(e);});v=_(this._selectedViewsOut).filter(function(v){return v.model===m});var myself=this;_.each(v,function(e){e.remove();myself._selectedViewsOut=_(myself._selectedViewsOut).without(e);});}},drillUp:function(){this.model.trigger("drillUp");},cancel:function(){this.model.cancel();},apply:function(){this.model.apply();},toggleCollapsed:function(){this.model.toggleCollapsed();},updateCollapsed:function(){$('.olapSelectorComponent').addClass('collapsed').removeClass('expanded');if(this.model.get("collapsed")){this.$el.find('.olapSelectorComponent').addClass('collapsed').removeClass('expanded');}else{this.$el.find('.olapSelectorComponent').removeClass('collapsed').addClass('expanded');var optionList=this.$el.find(".optionList"),minimumMargin=10,topEdge=optionList.offset().top,bottomEdge=topEdge+optionList.outerHeight(),topLimit=$(window).scrollTop(),bottomLimit=topLimit+$(window).height(),offset=bottomEdge<=bottomLimit?0:bottomLimit-bottomEdge-minimumMargin;offset=topEdge-offset>=topLimit?offset:topLimit-topEdge+minimumMargin;console.log("Offset is "+offset+" after correction");optionList.css("top",(optionList.position().top+offset)+"px");}},nextPage:function(){this.model.nextPage();},prevPage:function(){this.model.prevPage();},firstPage:function(){this.model.firstPage();},lastPage:function(){this.model.lastPage();},goToPage:function(evt){var page=$(evt.target).attr("data-page");this.model.goToPage(page);}});var OptionView=Backbone.View.extend({tagName:"span",template:null,events:{"click .target":"toggleSelection","click .drill-down":"drillDown"},initialize:function(){this.setTemplate();this.model.on("change:selected",this.updateSelectionDisplay,this);},setTemplate:function(){this.template=templates.olapSelector.option},drillDown:function(){var val=this.model.get("drill");this.model.set("drill",!val);},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.addClass('item');this.updateSelectionDisplay();this.delegateEvents();return this;},toggleSelection:function(){this.model.toggleSelected();this.model.trigger("select");},updateSelectionDisplay:function(){if(this.model.get('selected')){this.$el.addClass('selected');}else{this.$el.removeClass('selected');}}});var LevelView=OptionView.extend({tagName:"span",template:null,setTemplate:function(){this.template=templates.olapSelector.level;}});var SelectionView=Backbone.View.extend({tagName:"li",events:{"click .remove":"unselect"},render:function(){this.$el.html(templates.olapSelector.picked(this.model.toJSON()));this.delegateEvents();return this;},unselect:function(){this.model.set("selected",false);this.model.trigger("select");}});var SelectionViewOut=SelectionView.extend({unselect:function(){this.model.set("selected",false);this.model.trigger("select");this.model.trigger("notify");}});var templates=templates||{};templates.olapSelector={};templates.olapSelector.main=Mustache.compile("<div class='olapSelectorComponent'>"+" <div class='pulldown'>"+"   <div class='title'>{{title}}</div>"+"     <div class='optionList'>"+"       <div class='leftArea'>"+"         <div class='header'>Select Level</div>"+"         <div class='levels'></div>"+"         <div class='selectionPanel'>"+"           <div class='label'>Selected Filters</div>"+"           <ul class='selection'></ul>"+"         </div>"+"       </div>"+"       <div class='rightArea {{#paginate}}paginate{{/paginate}}'>"+"         <div class='header'>"+"<div class='breadcrumb'>Breadcrumb &#x21FE; Content</div>"+"<div class='search'>"+"             <input type='text' placeholder='Search...' value='{{searchterm}}'/>"+"             <div class='cancel'>&nbsp;</div>"+"           </div>"+"         </div>"+"         <div class='options'></div>"+"         <div class='paginationContainer'>"+"           <div class='pagination'>"+"             <div class='prev paginateButton'>Previous Page<div class='arrow'>&nbsp;</div></div>"+"             <div class='next paginateButton'>Next Page<div class='arrow'>&nbsp;</div></div>"+"           </div>"+"         </div>"+"         <div class='footer'>"+"           <div class='button cancel'>Cancel</div>"+"           <div class='button validate'>Apply</div>"+"         </div>"+"       </div>"+"     </div>"+" </div>"+" <div class='outsideArea'>"+"   <ul class='selection'></ul>"+" </div>"+"</div>");templates.olapSelector.option=Mustache.compile("<div class='target'>"+" <span class='name' title='{{name}}'>{{name}}</span>"+" <span class='check'>&nbsp;</span>"+"</div>"+"<div class='drill-down'><span class='label'>&nbsp;</span></div>");templates.olapSelector.picked=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{name}}'>{{name}}</span>"+"  <div class='remove'>&nbsp;</div>"+"</div>");templates.olapSelector.levels=Mustache.compile("<div class='levelTitle'>Levels</div>"+"<div class='levels options'></div>");templates.olapSelector.level=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"</div>");templates.olapSelector.crumbtrail=Mustache.compile("<span class='level'>{{level}}</span>"+"<span class='separator'>&nbsp;</span>"+"<span class='name'>{{name}}</span>")
if(typeof console==="undefined"){console={};console.log=function(){return;}}
wd=wd||{};wd.utils=wd.utils||{};wd.utils.OlapUtils=function(spec){var defaults={url:wd.helpers.olap.getServiceUrl(),extraParams:{}};var myself={};myself.options=$.extend({},defaults,spec);var isInitialized=false;var catalog=myself.options.catalog;var cube=myself.options.cube;var allSelectedObjects=[];var catalogs=[];var cubeStructureCache={};var olapOperations={GET_OLAP_CUBES:wd.helpers.olap.getCubesUrl(),GET_CUBE_STRUCTURE:wd.helpers.olap.getCubeStructureUrl(),GET_PAGINATED_LEVEL_MEMBERS:wd.helpers.olap.getPaginatedLevelMembersUrl(),GET_MEMBER_STRUCTURE:wd.helpers.olap.getLevelMembersStructureUrl()};myself.initialize=function(){if(!isInitialized){myself.initCatalogs();isInitialized=true;}}
myself.setOptions=function(_args){myself.options=$.extend(myself.options,_args);}
myself.setCatalog=function(catalog){myself.catalog=catalog;myself.options.catalog=catalog;}
myself.initCatalogs=function(){wd.debug("Getting info from cube");var res=myself.callOlapUtilsSync({operation:olapOperations.GET_OLAP_CUBES});catalogs=res.catalogs;wd.info("[OlapUtils] Successfully got catalog information");}
myself.resetCubeStructure=function(_args){var catalog=myself.getSelectedCatalogName(_args);var cube=myself.getSelectedCubeName(_args);var cacheKey=catalog+"::"+cube;if(cacheKey){delete cubeStructureCache[cacheKey];}
else{cubeStructureCache={};}
return true;}
myself.getCatalogs=function(){return catalogs;}
myself.getCubes=function(_args){var catalog=myself.getSelectedCatalogName(_args);var entry=_.find(catalogs,function(c){return c.schema.indexOf(catalog)>=0;});return entry?entry.cubes:null;}
myself.getCubeStructure=function(_args){var catalog=myself.getSelectedCatalogName(_args);var cube=myself.getSelectedCubeName(_args);var cacheKey=catalog+"::"+cube;if(!catalog||!cube){wd.error("Catalog or Cube not specified");return null;}
if(cubeStructureCache[cacheKey]){return cubeStructureCache[cacheKey];}
var params={operation:olapOperations.GET_CUBE_STRUCTURE,catalog:catalog,cube:cube};var result=myself.callOlapUtilsSync(params);cubeStructureCache[cacheKey]=result;return result;}
myself.getCube=function(_args){return myself.getCubeStructure(_args);}
myself.getDimensions=function(_args){var cubeStructure=myself.getCubeStructure(_args);return cubeStructure!=null?cubeStructure.dimensions:null;}
myself.getDimension=function(_args){var dimension=myself.getSelectedDimensionName(_args);var cubeStructure=myself.getCubeStructure(_args);var d=_.find(cubeStructure.dimensions,function(d){return d.name==dimension});return d;}
myself.getHierarchies=function(_args){var d=myself.getDimension(_args);return d!=null?d.hierarchies:null;}
myself.getHierarchy=function(_args){var hierarchyName=myself.getSelectedHierarchyName(_args);var h=_.find(myself.getHierarchies(_args),function(hier){return hier.name==hierarchyName});return h;}
myself.getLevels=function(_args){var h=myself.getHierarchy(_args);return h!=null?h.levels:null;}
myself.getLevel=function(_args){var levelName=myself.getSelectedLevelName(_args);var l=_.find(myself.getLevels(_args),function(level){return level.name==levelName});return l;}
myself.getPaginatedLevelMembers=function(_args,callback){var defaults={operation:olapOperations.GET_PAGINATED_LEVEL_MEMBERS,startMember:"",pageStart:0,pageSize:100,searchTerm:"",context:""}
var params=$.extend({},defaults,_args);params.catalog=myself.getSelectedCatalogName(_args);params.cube=myself.getSelectedCubeName(_args);var l=myself.getLevel(_args);params.level=l.qualifiedName;myself.callOlapUtils(params,function(json){var members=json.members;wd.debug("Got results for paginatedLevelMembers: "+_(members).pluck("name").join(", "));if(callback){callback(json);}});};myself.getOlapUtilsUrl=function(){return myself.options.url};myself.getSelectedCatalogName=function(_args){var catalog=$.extend({},myself.options,_args).catalog;return catalog;};myself.getSelectedCubeName=function(_args){return $.extend({},myself.options,_args).cube;};myself.getSelectedDimensionName=function(_args){return $.extend({},myself.options,_args).dimension;};myself.getSelectedHierarchyName=function(_args){var h=$.extend({},myself.options,_args).hierarchy;if(h==null){h=myself.getHierarchies(_args)[0].name;myself.options.hierarchy=h;wd.info("No hierarchy explicitly selected - setting the default one to '"+h+"'");}
return h;};myself.getSelectedLevelName=function(_args){return $.extend({},myself.options,_args).level;};myself.callOlapUtilsSync=function(params){return myself.callOlapUtils(params,undefined,undefined,true);}
myself.callOlapUtils=function(params,callback,errorCallback,sync){var myself=this;var ret;$.ajax({type:"GET",url:myself.getOlapUtilsUrl()+params.operation,data:$.extend({},myself.options.extraParams,params),dataType:"json",success:function(json){if(json&&json.status=="true"&&json.result){if(sync){ret=json.result}
else{callback(json.result);}}
else{if(typeof(errorCallback)!='function')errorCallback=alert;return errorCallback(json);}},async:!sync});return ret;};myself.initialize();wd.info("OlapUtils initialized!");return myself;}
if(!Array.prototype.map)
{Array.prototype.map=function(fun)
{var len=this.length;if(typeof fun!="function")
throw new TypeError();var res=new Array(len);var thisp=arguments[1];for(var i=0;i<len;i++)
{if(i in this)
res[i]=fun.call(thisp,this[i],i,this);}
return res;};}
if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement){"use strict";if(this==null){throw new TypeError();}
var t=Object(this);var len=t.length>>>0;if(len===0){return-1;}
var n=0;if(arguments.length>0){n=Number(arguments[1]);if(n!=n){n=0;}else if(n!=0&&n!=Infinity&&n!=-Infinity){n=(n>0||-1)*Math.floor(Math.abs(n));}}
if(n>=len){return-1;}
var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++){if(k in t&&t[k]===searchElement){return k;}}
return-1;}}
Function.prototype.method=Function.prototype.method||function(name,func){this.prototype[name]=func;return this;};var wd=wd||{};wd.loglevels=['debug','info','warn','error','exception'];wd.loglevel='debug';wd.log=function(m,type){type=type||"info";if(wd.loglevels.indexOf(type)<wd.loglevels.indexOf(wd.loglevel)){return;}
if(typeof console!=="undefined"){if(type&&console[type]){console[type]("["+type+"] WD: "+m);}else if(type==='exception'&&!console.exception){console.error("["+type+"] WD: "+(m.stack||m));}
else{console.log("WD: "+m);}}}
wd.warn=function(m){return wd.log(m,"warn");}
wd.error=function(m){return wd.log(m,"error");}
wd.info=function(m){return wd.log(m,"info");}
wd.debug=function(m){return wd.log(m,"debug");}
var OlapSelectorComponent=BaseComponent.extend({init:function(){var olapUtilsInstance=new wd.utils.OlapUtils({url:Dashboards.getWebAppPath()+wd.helpers.olap.getServiceUrl(),catalog:this.catalog,cube:this.cube,dimension:this.dimensionName});var cToFind=this.catalog;var entry=_.find(olapUtilsInstance.getCatalogs(),function(c){return(c.schema.indexOf(cToFind)>=0);});if(entry!==false){olapUtilsInstance.setCatalog(entry.name);}
this.model=new OlapSelectorModel({olapUtils:olapUtilsInstance,title:this.title,multiselect:this.multiSelect,parameters:this.getParamValues(this.parameters),preselected:this.getPreSelValue(this.parameter)});this.view=new OlapSelectorView({model:this.model,el:$("#"+this.htmlObject).get(0)})},update:function(){if(!this.isInitialized){this.init();this.isInitialized=true;}
var myself=this;this.model.on("change:collapsed",function(m,v){if(v){Dashboards.processChange(myself.name);}})
this.view.render();myself.parameters=myself.getParamValues(myself.parameters);myself.model.set("parameters",myself.parameters);},getValue:function(){return _(this.model.get("values").where({selected:true})).map(function(m){return m.get("qualifiedName");});},getParamValues:function(overrides){params=(overrides instanceof Array)?Dashboards.propertiesArrayToObject(overrides):(overrides||{});paramValues={};_.each(params,function(value,name){value=Dashboards.getParameterValue(value);if(_.isObject(value)){value=JSON.stringify(value);}
if(typeof value=='function'){value=value();}
paramValues[name]=value;paramValues.length=overrides.length;});return paramValues;},getPreSelValue:function(param){var paramValue=Dashboards.getParameterValue(param),values=[];if(typeof paramValue!=='undefined'){values=JSON.parse(paramValue);if(!this.multiSelect){values=new Array(values[0]);}}
return values}});
var wd=wd||{}
wd.cdf=wd.cdf||{};wd.cdf.views=wd.cdf.views||{};var templates=templates||{};templates.dashboardViews=templates.dashboardViews||{};wd.cdf.views.getUrl=function(){return wd.helpers.views.getUrl(this.solution,this.path,this.file,this.name);};wd.cdf.views.DashboardView=Backbone.Model.extend({defaults:{"id":"","name":"","description":"","key":null,"params":{},"unbound":[],"user":"","solution":"","path":"","file":"","url":wd.cdf.views.getUrl,"timestamp":0},isSynced:function(){var modelParams=this.get("parameters"),dashboardParams=Dashboards.getViewParameters();if(Object.keys(modelParams).length!==Object.keys(dashboardParams).length){return false;}
for(p in modelParams)if(modelParams.hasOwnProperty(p)){if(!dashboardParams.hasOwnProperty(p)||dashboardParams[p]!==modelParams[p]){return false;}}
return true;},syncWithDashboard:function(){this.set("parameters",Dashboards.getViewParameters());}});wd.cdf.views.Report=Backbone.Model.extend({defaults:{"name":"","label":"","dashboardView":null,"params":{},"user":"","timestamp":0}});wd.cdf.views.newDashboardView=function(name,description){var m={id:name,name:name,description:description,params:Dashboards.getViewParameters(),unbound:Dashboards.getUnboundParameters(),user:Dashboards.context.user,solution:Dashboards.context.solution,path:Dashboards.context.path,file:Dashboards.context.file,timestamp:(new Date()).getTime()};return new wd.cdf.views.DashboardView(m);};wd.cdf.views.ViewManager=Backbone.Model.extend({defaults:{"currentView":"Unsaved View","views":null,"viewCount":0},initViews:function(views){if(Dashboards.view){this.set("currentView",Dashboards.view.name,{silent:true});}
var viewCollection=new Backbone.Collection();viewCollection.model=wd.cdf.views.DashboardView;viewCollection.reset(views);this.set("views",viewCollection,{silent:true});this.set("viewCount",viewCollection.size(),{silent:true});this.change();}});wd.cdf.views.ViewManagerView=Backbone.View.extend({events:{'click .tab':"clickTab",'click .manage-views, .save-panel .cancel':"toggleViewManager",'click .view-item .delete':"deleteView",'click .save-panel .save':"save"},tabs:[{label:"List",selector:".list-panel",template:"viewListPanel"},{label:"Save",selector:".save-panel",template:"viewSavePanel"}],initialize:function(){this.configureListeners();},clickTab:function(evt){var $tgt=$(evt.target),selector=$tgt.data('target');this.$(".tab").removeClass("selected");$tgt.addClass("selected");this.$('.panel').hide();this.$(selector).show();},configureListeners:function(){this.model.on("change",this.render,this);},renderTabs:function(){var tabs=this.$(".tabs").empty(),tabContents=this.$(".tab-contents").empty();_(this.tabs).each(function(t){tabs.append(templates.viewManagerTab(t));tabContents.append(templates[t.template](this.model.toJSON()));},this);tabs.children().slice(0,1).addClass('selected');tabContents.children().slice(1).hide();},renderViewList:function(){var $views=this.$(".list-panel .views").empty();this.model.get("views").each(function(e){var $view=$(templates.viewListItem(e.toJSON()));$view.data("model",e);$views.append($view);});},toggleViewManager:function(){this.$('.manage-views').toggleClass("active");this.$('.view-manager').toggle();},render:function(){this.$el.html(templates.viewManager(this.model.toJSON()));this.renderTabs();this.renderViewList();this.$(".view-manager").hide();},save:function(){var name=this.$(".save-properties .name").val(),desc=this.$(".save-properties .description").val(),view=wd.cdf.views.newDashboardView(name,desc).toJSON(),args;view.params=Base64.encode(JSON.stringify(view.params)),old=this.model.get("views").filter(function(m){return m.get("name")==name})[0];if(old){view.key=old.get("key");}
args={view:JSON.stringify(view)};var myself=this;$.post(webAppPath+wd.helpers.views.getSaveViewsEndpoint(),$.param(args),function(){Dashboards.view=view;myself.model.set("currentView",name);myself.model.trigger("update");});},deleteView:function(evt){var view=$(evt.target).parent().data("model"),args={name:view.get("name")};var myself=this;$.post(webAppPath+wd.helpers.views.getDeleteViewsEndpoint(),$.param(args),function(){myself.model.get("views").remove(view);myself.model.trigger("update");});}});templates.viewManager=Mustache.compile("<div class='view-manager-component'>"+" <div class='current-view'>"+"   <span class='label'>Current View: </span>"+"   <span class='value'>{{currentView}}</span>"+" </div>"+" <div class='big-button manage-views'>Manage Views</div>"+" <div class='view-manager'>"+"   <div class='tabs'></div>"+"   <div class='tab-contents'></div>"+" </div>"+"</div>");templates.viewManagerTab=Mustache.compile("<div class='tab' data-target='{{selector}}'>"+"{{label}}"+"</div>");templates.viewListPanel=Mustache.compile("<div class='list-panel panel'>"+" <div class='total-views'>"+"   <span class='label'>Total Views: </span>"+"   <span class='value'>{{viewCount}}</span>"+" </div>"+" <div class='views'></div>"+" <div class='view-all'>"+"   <span class='label'>View All</span>"+"   <span class='description'>(go to View Manager)</span>"+" </div>"+"</div>");templates.viewListItem=Mustache.compile("<div class='view-item'>"+" <a class='name' href='{{url}}'>{{name}}</a>"+" <span class='delete'></span>"+"</div>");templates.viewSubscriptionPanel=Mustache.compile("<div class='subscrition-panel panel'>"+" <div class='current-view'>"+"   <span class='label'>Current View:</span>"+"   <span class='value'></span>"+" </div>"+" <div class='unsaved'>"+"   <div>Your current view is not saved. To subscribe,"+"     you must first save it. Do you wish to proceed?"+"   </div>"+"   <div class='button save'>Save</div>"+"   <div class='button cancel'>Cancel</div>"+" </div>"+" <div class='subscription-properties'>"+"   <span class='label'></span>"+"   <input type='radio'>"+" </div>"+"</div>");templates.viewSavePanel=Mustache.compile("<div class='save-panel panel'>"+" <div class='current-view'>"+"   <span class='label'>Current View:</span>"+"   <span class='value'>{{currentView}}</span>"+" </div>"+" <div class='save-properties'>"+"   <div><span class='label'>Title</span><input type='text' class='name' value='{{currentView}}'></div>"+"   <div><span class='label'>Description</span><textarea class='description' placeholder='Enter a description'>{{description}}</textarea></div>"+" </div>"+" <div class='save-actions'>"+"   <div class='big-button active save'>Save</div>"+"   <div class='big-button cancel'>Cancel</div>"+" </div>"+"</div>");
var viewManagerComponent=BaseComponent.extend({update:function(){function fetchData(){$.ajax({url:webAppPath+wd.helpers.views.getListViewsEndpoint(),dataType:'json',success:function(response){myself.model.initViews(response.views);myself.view.render();},cache:false});};this.ph=$("#"+this.htmlObject);this.model=new wd.cdf.views.ViewManager();this.view=new wd.cdf.views.ViewManagerView({el:this.ph.get(0),model:this.model});var myself=this;fetchData();this.model.on("update",fetchData,this);}});
var MobileNavComponent=BaseComponent.extend({update:function(){}});
var SiteMapComponent=BaseComponent.extend({ph:undefined,selected:"UNUSEDPARAM!@#$",templates:{list:Mustache.compile("<ul class='siteMap siteMapLevel{{level}}' ></ul>"),item:Mustache.compile("<li class='siteMapItem {{classes}}''>"+"  <a {{#link}}href='{{link}}'{{/link}}>{{name}}</a>"+"</li>")},update:function(){var items=[],myself=this;if(typeof this.siteMapSelectedParameter!=="undefined"&&this.siteMapSelectedParameter!=""){this.selected=Dashboards.getParameterValue(this.siteMapSelectedParameter)}
this.ph=$("#"+this.htmlObject).empty();if(this.ajaxUrl){var opts={url:this.ajaxUrl}
if(_.isEmpty(this.parameters)){opts.data=Dashboards.propertiesArrayToObject(this.ajaxData);}
myself.fetchItems(opts,function(items){myself.renderList(myself.ph,items,0);});}else if(this.siteMapParameter){this.renderList(this.ph,Dashboards.getParameterValue(this.siteMapParameter),0);}
this.ph.find(".siteMapItem.siteMapSelected").parents(".siteMapItem").addClass("siteMapSelected");this.ph.find(".siteMapItem.siteMapInitial").parents(".siteMapItem").addClass("siteMapInitial");},fetchItems:function(overrides,callback){var myself=this;overrides=overrides||{};var ajaxOpts={type:'GET',success:function(json){callback(json);},dataType:'json',async:true};ajaxOpts=_.extend({},ajaxOpts,overrides);$.ajax(ajaxOpts);},renderList:function(ph,arr,level){var myself=this;var list=$(myself.templates.list({level:level}));$.each(arr,function(n,l){var item=$(myself.templates.item({name:l.name||l.id||"",link:l.link,classes:l.classes||""}));if(!l.link&&typeof l.action==="function"){item.find('a').click(function(){l.action(item);myself.ph.find(".siteMapItem.siteMapSelected").removeClass("siteMapSelected");$(this).parents(".siteMapItem").addClass("siteMapSelected");Dashboards.fireChange(myself.siteMapSelectedParameter,typeof l.id!=="undefined"?l.id:l.name);});}
if(typeof(l.id)!=="undefined"?l.id==myself.selected:l.name==myself.selected){item.addClass("siteMapSelected siteMapInitial");}
if(l.sublinks&&l.sublinks.length>0)
myself.renderList(item,l.sublinks,level+1);item.appendTo(list);});list.appendTo(ph);}});
var PopupComponent=BaseComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,$overlay:undefined,update:function(){var myself=this;this.content=$("#"+this.htmlObject).detach();this.ph=this.ph?this.ph.empty():$('<div>').appendTo($('body'));this.content.appendTo(this.ph);this.ph.hide();this.ph.addClass('popupComponent');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);this.content.removeClass('hidePopup');},clone:function(params,comps,html){var that=this.base(params,comps,html);that.ph=this.ph.clone();that.ph.insertAfter(this.ph);that.ph.hide();that.ph.find("[id]").each(function(i,e){$e=$(e);var id=$e.attr("id");if(id&&id in html){$e.attr("id",html[id]);}else{$e.attr("id",id+'_'+Dashboards.duplicateIndex);}});return that;},popup:function(target,gravity){var pos=target.offset(),css={'top':'auto','bottom':'auto','left':'auto','right':'auto'},minimumDistance=20,vertexOffset=18-6,vertexSize=45,targetOffset,phHeight=this.ph.outerHeight(),phWidth=this.ph.outerWidth();gravity=gravity||this.gravity;var draggable=typeof this.draggable==="undefined"?true:this.draggable;if(this.horizontalScroll){$("#"+this.htmlObject).css("overflow-x","scroll");}
if(this.verticalScroll){$("#"+this.htmlObject).css("overflow-y","scroll");}
var closeOnClickOutside=typeof this.closeOnClickOutside==="undefined"?false:this.closeOnClickOutside;this.arrow.css({top:"",left:"",bottom:"",right:""});this.arrow.show();this.ph.removeClass('north south east west');var minWidth=minimumDistance,maxWidth=$(document).width()-minimumDistance,minHeight=minimumDistance,maxHeight=$(document).height()-minimumDistance,targetWidth,targetHeight,paddingNear,paddingFar;switch(gravity){case'N':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'near');this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'S':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'far');targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'W':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(target.width(),phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'near');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;case'E':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(targetWidth,phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'far');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;}
this.ph.css(css);this.ph.show();var escHandler,myself=this;escHandler=function(e){if(e.which==27){myself.ph.hide();$(document).unbind('keydown',escHandler);}};$(document).keydown(escHandler);var dragHandler;dragHandler=function(){myself.arrow.hide();}
this.ph.bind('drag',dragHandler);if(draggable){this.ph.draggable({cancel:"#"+this.htmlObject});}
var basePos,dragPos;this.ph.bind('touchstart',function(e){basePos=myself.ph.offset();dragPos={left:e.originalEvent.touches[0].pageX,top:e.originalEvent.touches[0].pageY};});this.ph.bind('touchmove',function(e){var finalPos={top:basePos.top+e.originalEvent.touches[0].pageY-dragPos.top,left:basePos.left+e.originalEvent.touches[0].pageX-dragPos.left};myself.ph.offset(finalPos);myself.arrow.hide();e.preventDefault();});if(closeOnClickOutside){if(!this.$overlay){this.$overlay=$('<div id="popupComponentOverlay"></div>');}
this.$overlay.appendTo("body").click(function(event){event.stopPropagation();myself.hide();})}},hide:function(){this.ph.hide();if(this.$overlay){this.$overlay.unbind('click');this.$overlay.detach();}},center:function(targetSize,phSize,offset,min,max){var candidate=offset+targetSize/2-phSize/2;return candidate+phSize>max?max-phSize:candidate<min?min:candidate;},offset:function(targetSize,phSize,offset,gap,min,max,range){var near=offset-phSize-gap,far=offset+targetSize+gap,nearAdmissible=near>min,farAdmissible=far+phSize<max;return range=='near'?(nearAdmissible||!farAdmissible?near:far):range=='far'?(farAdmissible||!nearAdmissible?far:near):near;}});var ExportPopupComponent=PopupComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,dataComponent:undefined,chartComponent:undefined,baseSize:200,scalingFactor:1.5,clone:function(parameterRemap,componentRemap,htmlRemap){var dataComponent=this.dataComponent,chartComponent=this.chartComponent;delete this.dataComponent;delete this.chartComponent;var that=this.base(parameterRemap,componentRemap,htmlRemap);if(dataComponent){this.dataComponent=dataComponent;that.dataComponent=componentRemap[dataComponent.name]||dataComponent;}
if(chartComponent){this.chartComponent=chartComponent;var truncated=/render_(.*)/.test(chartComponent.name)?chartComponent.name.match(/render_(.*)/)[1]:null;if(componentRemap[chartComponent.name]){that.chartComponent=Dashboards.getComponentByName(componentRemap[chartComponent.name]);that.chartExportComponent=componentRemap[chartComponent.name];}else if(truncated&&componentRemap[truncated]){that.chartComponent=Dashboards.getComponentByName("render_"+componentRemap[truncated]);that.chartExportComponent=componentRemap[truncated];}else{that.chartComponent=chartComponent;}
that.chartComponent=componentRemap[chartComponent.name]||chartComponent;}
return that;},update:function(){var myself=this;if(this.ph){this.ph.remove();}
this.chartComponent=window["render_"+this.chartExportComponent];this.dataComponent=window["render_"+this.dataExportComponent];this.ph=$('<div>');$("#"+this.htmlObject).empty();var link=$('<div class="popupTitle">');link.text(this.title||'Export');link.click(function(e){myself.popup(link);e.stopPropagation();})
$("#"+this.htmlObject).append(link);if(this.chartComponent){var realChartExportLabel="Export Chart";if(this.chartExportLabel&&this.chartExportLabel.length>0)
realChartExportLabel=this.chartExportLabel;var chartExportElt=$('<div class="exportElement">');chartExportElt.text(realChartExportLabel);chartExportElt.click(function(){myself.exportChart();});chartExportElt.appendTo(myself.ph);}
if(this.dataComponent){var realTableExportLabel="Export Data";if(this.dataExportLabel&&this.dataExportLabel.length>0)
realTableExportLabel=this.dataExportLabel;var dataExportElt=$('<div class="exportElement">');dataExportElt.text(realTableExportLabel);dataExportElt.click(function(){myself.exportData();});dataExportElt.appendTo(myself.ph);}
$(this.contentLinks).each(function(i,elt){var popupElt=$('<div class="exportElement">');popupElt.text(elt[0]);popupElt.click(elt[1]);popupElt.appendTo(myself.ph);});this.ph.hide().appendTo($('body'));this.ph.addClass('popupComponent');this.ph.addClass('exportOptions');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);},popup:function(target,gravity){this.base(target,gravity);var myself=this;var docClick=function(e){var x=e.pageX;var y=e.pageY;var linkPos=$("#"+myself.htmlObject).position();if((x<linkPos.left||x>linkPos.left+$("#"+myself.htmlObject).width())||(y<linkPos.top||y>linkPos.top+$("#"+myself.htmlObject).height())){myself.hide();$(document).unbind('click',docClick);}};$(document).click(docClick);},exportData:function(det){var effectiveExportType=det==undefined?this.dataExportType:det;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.dataComponent.parameters.slice();for(var i=0;i<parameters.length;i++){if(parameters[i][0]==='metadata'){parameters[i]=parameters[i].slice();parameters[i][1]='false';break;}}
var cd=this.dataComponent.chartDefinition||this.dataComponent.queryDefinition;var query=Dashboards.getQuery(cd);query.exportData(effectiveExportType,parameters,{filename:this.dataExportAttachmentName+"."+effectiveExportType});},exportChart:function(cet){var effectiveExportType=cet==undefined?this.chartExportType:cet;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.chartComponent.parameters;var dataAccess=this.chartComponent.chartDefinition.dataAccessId;var path=this.chartComponent.chartDefinition.path;var loc=(Dashboards.context.fullPath)?Dashboards.context.fullPath.replace(/[^\/]+$/,""):Dashboards.context.path.replace(/[^\/]+$/,"");var url=wd.helpers.cggHelper.getCggDrawUrl()+"?script="+loc+this.chartExportComponent+".js&outputType="+effectiveExportType;var param;for(var i=0;i<parameters.length;i++){param=Dashboards.ev(Dashboards.getParameterValue(parameters[i][1]));if(param!==undefined){url+="&param"+parameters[i][0]+"="+(parameters[i][0]!='metadata'?encodeURIComponent(param):'false');}}
var level=Dashboards.debug;if(level>1){url+="&paramdebug=true";url+="&paramdebugLevel="+level;}
var myself=this;var masterDiv=$('<div class="exportChartMasterDiv">');var totalWidth=Math.max(700,this.chartComponent.chartDefinition.width);var popupButtonsDiv=$("<div class='exportChartPopupButtons' style='width:"+totalWidth+"px'>");masterDiv.append(popupButtonsDiv);var titleDiv=$("<div class='exportChartTitle'>Export Options</div>");popupButtonsDiv.append(titleDiv);var smallButton=$("<div class='exportChartPopupButton exportChartButtonNotLast'>Small</div>");smallButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);$('#width').val(myself.baseSize);$('#height').val(myself.baseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(smallButton);var mediumButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Medium</div>");mediumButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});mediumButton.getComponentData=function(){return[(myself.chartComponent.chartDefinition.width),(myself.chartComponent.chartDefinition.height)];}
popupButtonsDiv.append(mediumButton);var largeButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Large</div>");largeButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(largeButton);var customButton=$("<div class='exportChartPopupButton exportChartButtonMiddle'>Custom</div>");customButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').removeAttr('disabled');$('#height').removeAttr('disabled');$('#width').val(myself.chartComponent.chartDefinition.width);$('#height').val(myself.chartComponent.chartDefinition.height);});popupButtonsDiv.append(customButton);var inputsWidthDiv=$("<div class='exportChartInput'>&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;Width:&nbsp;<input id='width'  disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.width+"' onChange='javascript:$(\"#height\").val($(\"#width\").val() * "+(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)+");' type='text'></div>");popupButtonsDiv.append(inputsWidthDiv);var inputsHeightDiv=$("<div class='exportChartInput'>Height:&nbsp;</span><input id='height' disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.height+"' type='text'></div>");popupButtonsDiv.append(inputsHeightDiv);var okButton=$("<div class='exportChartPopupButton exportChartOkButton'>Export</div>");okButton.click(function(){var dimensions,size;switch($('.exportChartPopupButtonClicked').text()){case"Small":dimensions=[myself.baseSize,myself.BaseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Medium":size=myself.baseSize*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Large":size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Custom":default:dimensions=[$('#width').val(),$('#height').val()];break;}
var _exportIframe=$('<iframe style="display:none">');_exportIframe.detach();_exportIframe[0].src=url+"&attachmentName="+myself.dataExportAttachmentName+"."+effectiveExportType+"&paramwidth="+dimensions[0]+'&paramheight='+dimensions[1];_exportIframe.appendTo($('body'));});popupButtonsDiv.append(okButton);var img=$("<img src='"+url+"&paramwidth="+this.chartComponent.chartDefinition.width+"&paramheight="+this.chartComponent.chartDefinition.height+"'/>");var imgDiv=$("<div class='exportChartImageDiv'>");imgDiv.append(img);imgDiv.append("&nbsp;");masterDiv.append(imgDiv);$.fancybox({type:"html",content:masterDiv,width:totalWidth,height:this.chartComponent.chartDefinition.height+60});}});
var PopupComponent=BaseComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,$overlay:undefined,update:function(){var myself=this;this.content=$("#"+this.htmlObject).detach();this.ph=this.ph?this.ph.empty():$('<div>').appendTo($('body'));this.content.appendTo(this.ph);this.ph.hide();this.ph.addClass('popupComponent');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);this.content.removeClass('hidePopup');},clone:function(params,comps,html){var that=this.base(params,comps,html);that.ph=this.ph.clone();that.ph.insertAfter(this.ph);that.ph.hide();that.ph.find("[id]").each(function(i,e){$e=$(e);var id=$e.attr("id");if(id&&id in html){$e.attr("id",html[id]);}else{$e.attr("id",id+'_'+Dashboards.duplicateIndex);}});return that;},popup:function(target,gravity){var pos=target.offset(),css={'top':'auto','bottom':'auto','left':'auto','right':'auto'},minimumDistance=20,vertexOffset=18-6,vertexSize=45,targetOffset,phHeight=this.ph.outerHeight(),phWidth=this.ph.outerWidth();gravity=gravity||this.gravity;var draggable=typeof this.draggable==="undefined"?true:this.draggable;if(this.horizontalScroll){$("#"+this.htmlObject).css("overflow-x","scroll");}
if(this.verticalScroll){$("#"+this.htmlObject).css("overflow-y","scroll");}
var closeOnClickOutside=typeof this.closeOnClickOutside==="undefined"?false:this.closeOnClickOutside;this.arrow.css({top:"",left:"",bottom:"",right:""});this.arrow.show();this.ph.removeClass('north south east west');var minWidth=minimumDistance,maxWidth=$(document).width()-minimumDistance,minHeight=minimumDistance,maxHeight=$(document).height()-minimumDistance,targetWidth,targetHeight,paddingNear,paddingFar;switch(gravity){case'N':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'near');this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'S':paddingNear=parseInt(target.css('padding-top').replace(/(.*)px/,"$1"),10);targetHeight="ownerSVGElement"in target[0]?(target.attr("height")?target.attr("height")-0:0):target.height();css.left=this.center(target.outerWidth(),phWidth,pos.left,minWidth,maxWidth);css.top=this.offset(targetHeight,phHeight,pos.top+paddingNear,vertexOffset,minHeight,maxHeight,'far');targetOffset=pos.left-css.left-this.ph.css('border-top-width').replace(/(.*)px/,"$1");this.arrow.css('left',this.center(target.outerWidth(),vertexSize,targetOffset,0,phWidth));this.ph.addClass(css.top<pos.top?'north':'south');break;case'W':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(target.width(),phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'near');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;case'E':paddingNear=parseInt(target.css('padding-left').replace(/(.*)px/,"$1"),10);css.top=this.center(target.outerHeight(),phHeight,pos.top,minHeight,maxHeight);targetWidth="ownerSVGElement"in target[0]?(target.attr("width")?target.attr("width")-0:0):target.width();css.left=this.offset(targetWidth,phWidth,pos.left+paddingNear,vertexOffset,minWidth,maxWidth,'far');targetOffset=pos.top-css.top-this.ph.css('border-left-width').replace(/(.*)px/,"$1");this.arrow.css('top',this.center(target.outerHeight(),vertexSize,targetOffset,0,phHeight));this.ph.addClass(css.left<pos.left?'west':'east');break;}
this.ph.css(css);this.ph.show();var escHandler,myself=this;escHandler=function(e){if(e.which==27){myself.ph.hide();$(document).unbind('keydown',escHandler);}};$(document).keydown(escHandler);var dragHandler;dragHandler=function(){myself.arrow.hide();}
this.ph.bind('drag',dragHandler);if(draggable){this.ph.draggable({cancel:"#"+this.htmlObject});}
var basePos,dragPos;this.ph.bind('touchstart',function(e){basePos=myself.ph.offset();dragPos={left:e.originalEvent.touches[0].pageX,top:e.originalEvent.touches[0].pageY};});this.ph.bind('touchmove',function(e){var finalPos={top:basePos.top+e.originalEvent.touches[0].pageY-dragPos.top,left:basePos.left+e.originalEvent.touches[0].pageX-dragPos.left};myself.ph.offset(finalPos);myself.arrow.hide();e.preventDefault();});if(closeOnClickOutside){if(!this.$overlay){this.$overlay=$('<div id="popupComponentOverlay"></div>');}
this.$overlay.appendTo("body").click(function(event){event.stopPropagation();myself.hide();})}},hide:function(){this.ph.hide();if(this.$overlay){this.$overlay.unbind('click');this.$overlay.detach();}},center:function(targetSize,phSize,offset,min,max){var candidate=offset+targetSize/2-phSize/2;return candidate+phSize>max?max-phSize:candidate<min?min:candidate;},offset:function(targetSize,phSize,offset,gap,min,max,range){var near=offset-phSize-gap,far=offset+targetSize+gap,nearAdmissible=near>min,farAdmissible=far+phSize<max;return range=='near'?(nearAdmissible||!farAdmissible?near:far):range=='far'?(farAdmissible||!nearAdmissible?far:near):near;}});var ExportPopupComponent=PopupComponent.extend({ph:undefined,arrow:undefined,content:undefined,cancel:undefined,dataComponent:undefined,chartComponent:undefined,baseSize:200,scalingFactor:1.5,clone:function(parameterRemap,componentRemap,htmlRemap){var dataComponent=this.dataComponent,chartComponent=this.chartComponent;delete this.dataComponent;delete this.chartComponent;var that=this.base(parameterRemap,componentRemap,htmlRemap);if(dataComponent){this.dataComponent=dataComponent;that.dataComponent=componentRemap[dataComponent.name]||dataComponent;}
if(chartComponent){this.chartComponent=chartComponent;var truncated=/render_(.*)/.test(chartComponent.name)?chartComponent.name.match(/render_(.*)/)[1]:null;if(componentRemap[chartComponent.name]){that.chartComponent=Dashboards.getComponentByName(componentRemap[chartComponent.name]);that.chartExportComponent=componentRemap[chartComponent.name];}else if(truncated&&componentRemap[truncated]){that.chartComponent=Dashboards.getComponentByName("render_"+componentRemap[truncated]);that.chartExportComponent=componentRemap[truncated];}else{that.chartComponent=chartComponent;}
that.chartComponent=componentRemap[chartComponent.name]||chartComponent;}
return that;},update:function(){var myself=this;if(this.ph){this.ph.remove();}
this.chartComponent=window["render_"+this.chartExportComponent];this.dataComponent=window["render_"+this.dataExportComponent];this.ph=$('<div>');$("#"+this.htmlObject).empty();var link=$('<div class="popupTitle">');link.text(this.title||'Export');link.click(function(e){myself.popup(link);e.stopPropagation();})
$("#"+this.htmlObject).append(link);if(this.chartComponent){var realChartExportLabel="Export Chart";if(this.chartExportLabel&&this.chartExportLabel.length>0)
realChartExportLabel=this.chartExportLabel;var chartExportElt=$('<div class="exportElement">');chartExportElt.text(realChartExportLabel);chartExportElt.click(function(){myself.exportChart();});chartExportElt.appendTo(myself.ph);}
if(this.dataComponent){var realTableExportLabel="Export Data";if(this.dataExportLabel&&this.dataExportLabel.length>0)
realTableExportLabel=this.dataExportLabel;var dataExportElt=$('<div class="exportElement">');dataExportElt.text(realTableExportLabel);dataExportElt.click(function(){myself.exportData();});dataExportElt.appendTo(myself.ph);}
$(this.contentLinks).each(function(i,elt){var popupElt=$('<div class="exportElement">');popupElt.text(elt[0]);popupElt.click(elt[1]);popupElt.appendTo(myself.ph);});this.ph.hide().appendTo($('body'));this.ph.addClass('popupComponent');this.ph.addClass('exportOptions');this.cancel=$("<a>&nbsp;</a>");this.cancel.addClass("close").click(function(){myself.hide();});this.cancel.appendTo(this.ph);this.arrow=$("<div class='arrow'>").appendTo(this.ph);},popup:function(target,gravity){this.base(target,gravity);var myself=this;var docClick=function(e){var x=e.pageX;var y=e.pageY;var linkPos=$("#"+myself.htmlObject).position();if((x<linkPos.left||x>linkPos.left+$("#"+myself.htmlObject).width())||(y<linkPos.top||y>linkPos.top+$("#"+myself.htmlObject).height())){myself.hide();$(document).unbind('click',docClick);}};$(document).click(docClick);},exportData:function(det){var effectiveExportType=det==undefined?this.dataExportType:det;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.dataComponent.parameters.slice();for(var i=0;i<parameters.length;i++){if(parameters[i][0]==='metadata'){parameters[i]=parameters[i].slice();parameters[i][1]='false';break;}}
var cd=this.dataComponent.chartDefinition||this.dataComponent.queryDefinition;var query=Dashboards.getQuery(cd);query.exportData(effectiveExportType,parameters,{filename:this.dataExportAttachmentName+"."+effectiveExportType});},exportChart:function(cet){var effectiveExportType=cet==undefined?this.chartExportType:cet;Dashboards.log("Exporting to "+effectiveExportType);var parameters=this.chartComponent.parameters;var dataAccess=this.chartComponent.chartDefinition.dataAccessId;var path=this.chartComponent.chartDefinition.path;var loc=(Dashboards.context.fullPath)?Dashboards.context.fullPath.replace(/[^\/]+$/,""):Dashboards.context.path.replace(/[^\/]+$/,"");var url=wd.helpers.cggHelper.getCggDrawUrl()+"?script="+loc+this.chartExportComponent+".js&outputType="+effectiveExportType;var param;for(var i=0;i<parameters.length;i++){param=Dashboards.ev(Dashboards.getParameterValue(parameters[i][1]));if(param!==undefined){url+="&param"+parameters[i][0]+"="+(parameters[i][0]!='metadata'?encodeURIComponent(param):'false');}}
var level=Dashboards.debug;if(level>1){url+="&paramdebug=true";url+="&paramdebugLevel="+level;}
var myself=this;var masterDiv=$('<div class="exportChartMasterDiv">');var totalWidth=Math.max(700,this.chartComponent.chartDefinition.width);var popupButtonsDiv=$("<div class='exportChartPopupButtons' style='width:"+totalWidth+"px'>");masterDiv.append(popupButtonsDiv);var titleDiv=$("<div class='exportChartTitle'>Export Options</div>");popupButtonsDiv.append(titleDiv);var smallButton=$("<div class='exportChartPopupButton exportChartButtonNotLast'>Small</div>");smallButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);$('#width').val(myself.baseSize);$('#height').val(myself.baseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(smallButton);var mediumButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Medium</div>");mediumButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});mediumButton.getComponentData=function(){return[(myself.chartComponent.chartDefinition.width),(myself.chartComponent.chartDefinition.height)];}
popupButtonsDiv.append(mediumButton);var largeButton=$("<div class='exportChartPopupButton exportChartButtonNotLast exportChartButtonMiddle'>Large</div>");largeButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').attr('disabled',true);$('#height').attr('disabled',true);var size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;$('#width').val(size);$('#height').val(size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width));});popupButtonsDiv.append(largeButton);var customButton=$("<div class='exportChartPopupButton exportChartButtonMiddle'>Custom</div>");customButton.click(function(){$('.exportChartPopupButtonClicked').each(function(i,elt){$(elt).removeClass('exportChartPopupButtonClicked')})
$(this).addClass('exportChartPopupButtonClicked');$('#width').removeAttr('disabled');$('#height').removeAttr('disabled');$('#width').val(myself.chartComponent.chartDefinition.width);$('#height').val(myself.chartComponent.chartDefinition.height);});popupButtonsDiv.append(customButton);var inputsWidthDiv=$("<div class='exportChartInput'>&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;Width:&nbsp;<input id='width'  disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.width+"' onChange='javascript:$(\"#height\").val($(\"#width\").val() * "+(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)+");' type='text'></div>");popupButtonsDiv.append(inputsWidthDiv);var inputsHeightDiv=$("<div class='exportChartInput'>Height:&nbsp;</span><input id='height' disabled='true' style='width:50px' value='"+this.chartComponent.chartDefinition.height+"' type='text'></div>");popupButtonsDiv.append(inputsHeightDiv);var okButton=$("<div class='exportChartPopupButton exportChartOkButton'>Export</div>");okButton.click(function(){var dimensions,size;switch($('.exportChartPopupButtonClicked').text()){case"Small":dimensions=[myself.baseSize,myself.BaseSize*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Medium":size=myself.baseSize*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Large":size=myself.baseSize*myself.scalingFactor*myself.scalingFactor;dimensions=[size,size*(myself.chartComponent.chartDefinition.height/myself.chartComponent.chartDefinition.width)];break;case"Custom":default:dimensions=[$('#width').val(),$('#height').val()];break;}
var _exportIframe=$('<iframe style="display:none">');_exportIframe.detach();_exportIframe[0].src=url+"&attachmentName="+myself.dataExportAttachmentName+"."+effectiveExportType+"&paramwidth="+dimensions[0]+'&paramheight='+dimensions[1];_exportIframe.appendTo($('body'));});popupButtonsDiv.append(okButton);var img=$("<img src='"+url+"&paramwidth="+this.chartComponent.chartDefinition.width+"&paramheight="+this.chartComponent.chartDefinition.height+"'/>");var imgDiv=$("<div class='exportChartImageDiv'>");imgDiv.append(img);imgDiv.append("&nbsp;");masterDiv.append(imgDiv);$.fancybox({type:"html",content:masterDiv,width:totalWidth,height:this.chartComponent.chartDefinition.height+60});}});
var DuplicateComponent=BaseComponent.extend({update:function(){var ph=$("#"+this.htmlObject).empty(),myself=this,link=$("<a href='javascript:;'>Duplicate</a>");link.click(function(){myself.duplicate();});link.appendTo(ph);},duplicate:function(parameterValues){var cdePrefix="render_";parameterValues=parameterValues||{};if(!Dashboards.duplicateIndex){Dashboards.duplicateIndex=0;}
Dashboards.duplicateIndex+=1;var dIdx=Dashboards.duplicateIndex,suffix="_"+dIdx;var params={}
$.each(this.parameters,function(i,p){var param=p+suffix;Dashboards.setBookmarkable(param,Dashboards.isBookmarkable(p));Dashboards.setParameter(param,parameterValues[p]||Dashboards.getParameterValue(p));params[p]=param;});var comps={}
$.each(this.components,function(i,c){var comp=c+suffix;comps[c]=comp;});var htmlRemap={};htmlRemap[this.targetHtmlObject]=(this.targetHtmlObject+suffix).replace(/([^\\])\$/g,'$1\\$');var newPh=$("#"+this.targetHtmlObject).clone();newPh.attr("id",newPh.attr("id")+suffix);newPh.find("[id]").each(function(i,e){$e=$(e);$e.attr("id",$e.attr("id")+suffix);});if(this.targetContainer){newPh.appendTo('#'+this.targetContainer);}else{newPh.insertAfter("#"+this.targetHtmlObject);}
for(c in this.components){var cName=this.components[c];cName=RegExp("^"+cdePrefix).test(cName)?cName:cdePrefix+cName;var component=Dashboards.getComponent(cName);if(component){htmlRemap[component.htmlObject]=(component.htmlObject+suffix).replace(/([^\\])\$/g,'$1\\$');var clone=component.clone(params,comps,htmlRemap);clone.name=clone.name+suffix;window[clone.name]=clone;Dashboards.addComponents([clone]);Dashboards.update(clone);}}},clone:function(parameterRemap,componentRemap,htmlRemap){var that=this.base(parameterRemap,componentRemap,htmlRemap);that.targetHtmlObject=htmlRemap[that.targetHtmlObject];if(that.parameters){that.parameters=that.parameters.map(function(param){if(param in parameterRemap){return parameterRemap[param];}else{return param;}});}
return that;}});
(function($){$.ga={};$.ga.load=function(uid,callback){jQuery.ajax({type:'GET',url:(document.location.protocol=="https:"?"https://ssl":"http://www")+'.google-analytics.com/ga.js',cache:true,success:function(){if(typeof _gat==undefined){throw"_gat has not been defined";}t=_gat._createTracker(uid);bind();if($.isFunction(callback)){callback(t)}t._trackPageview()},dataType:'script',data:null})};var t;var bind=function(){if(noT()){throw"pageTracker has not been defined";}for(var $1 in t){if($1.charAt(0)!='_')continue;$.ga[$1.substr(1)]=t[$1]}};var noT=function(){return t==undefined}})(jQuery);
var googleAnalyticsComponent=BaseComponent.extend({update:function(){jQuery.globalEval('$(document).ready( function() { $.ga.load("'+this.gaTrackingId+'"); } );');}});
if(typeof pv=='undefined'||typeof pv.listenForPageLoad=='undefined'){window.pv={};pv.renderer=function(){return(typeof window.svgweb==="undefined")?"nativesvg":"svgweb";};pv.listenForPageLoad=function(listener){if(document.readyState==="complete"){listener();}
if(pv.renderer()=="svgweb"){window.addEventListener("SVGLoad",listener,false);}else{if(document.addEventListener){window.addEventListener("load",listener,false);}else if(document.attachEvent){window.attachEvent("onload",listener);}}};}
var CggComponent=BaseComponent.extend({ph:null,relComp:null,getScriptUrl:function(){return this.resourceFile;},getOutputType:function(){return'svg';},update:function(){var url=wd.helpers.cggHelper.getCggDrawUrl(),data=this.processParams(),script=this.getScriptUrl(),myself=this,ph=$('#'+myself.htmlObject);pv.listenForPageLoad(function(){$.ajax({url:url,data:data,type:'get',success:function(xmlData){ph.empty();try{ph[0].appendChild(document.importNode(xmlData.lastChild,true));ph.find("svg").width(myself.width).height(myself.height);}catch(e){var obj=myself.createObj(url,script,data,myself.width,myself.height);ph[0].innerHTML=arguments[2].responseText;ph.find("svg").width(myself.width).height(myself.height);}},error:function(){ph.empty();if(pv.renderer()==="svgweb"){var obj=myself.createObj(url,script,data,myself.width,myself.height,true);svgweb.appendChild(obj,ph[0]);}}});});},processParams:function(){var data={};this._processParametersCore(data);var level=this.dashboard.debug;if(level>1){data.paramdebug=true;data.paramdebugLevel=level;}
data.script=escape(this.getScriptUrl());data.outputType=this.getOutputType()||'svg';return data;},_processParametersCore:function(params){var dash=this.dashboard;var params=this.parameters;for(var i=0,L=params.length;i<L;i++){var param=params[i];var value=dash.getParameterValue(param[1]);if($.isArray(value)&&value.length==1&&(''+value[0]).indexOf(';')>=0){value=doCsvQuoting(value[0],';');}
data["param"+param[0]]=value;}},objectUrl:function(baseUrl,script,params){var objUrl=baseUrl+'?',pArray=[];for(var p in params){if(params.hasOwnProperty(p)){pArray.push(escape(p)+'='+escape(params[p]));}}
objUrl+='&'+pArray.join('&');return objUrl;},createObj:function(url,script,data,width,height,svgweb){var obj=(svgweb?document.createElement('object',true):document.createElement('object'));obj.setAttribute('type','image/svg+xml');obj.setAttribute('data',this.objectUrl(url,script,data));obj.setAttribute('width',width);obj.setAttribute('height',height);return obj;}});var CggDialComponent=CggComponent.extend({script:"system/pentaho-cdf-dd/resources/custom/components/cgg/charts/dial.js",getScriptUrl:function(){return this.script;},getOutputType:function(){return'svg';},_processParametersCore:function(data){data.paramvalue=this.dashboard.getParameterValue(this.parameter);data.paramcolors=this.colors;data.paramscale=this.intervals;}});
if(typeof pv=='undefined'||typeof pv.listenForPageLoad=='undefined'){window.pv={};pv.renderer=function(){return(typeof window.svgweb==="undefined")?"nativesvg":"svgweb";};pv.listenForPageLoad=function(listener){if(document.readyState==="complete"){listener();}
if(pv.renderer()=="svgweb"){window.addEventListener("SVGLoad",listener,false);}else{if(document.addEventListener){window.addEventListener("load",listener,false);}else if(document.attachEvent){window.attachEvent("onload",listener);}}};}
var CggComponent=BaseComponent.extend({ph:null,relComp:null,getScriptUrl:function(){return this.resourceFile;},getOutputType:function(){return'svg';},update:function(){var url=wd.helpers.cggHelper.getCggDrawUrl(),data=this.processParams(),script=this.getScriptUrl(),myself=this,ph=$('#'+myself.htmlObject);pv.listenForPageLoad(function(){$.ajax({url:url,data:data,type:'get',success:function(xmlData){ph.empty();try{ph[0].appendChild(document.importNode(xmlData.lastChild,true));ph.find("svg").width(myself.width).height(myself.height);}catch(e){var obj=myself.createObj(url,script,data,myself.width,myself.height);ph[0].innerHTML=arguments[2].responseText;ph.find("svg").width(myself.width).height(myself.height);}},error:function(){ph.empty();if(pv.renderer()==="svgweb"){var obj=myself.createObj(url,script,data,myself.width,myself.height,true);svgweb.appendChild(obj,ph[0]);}}});});},processParams:function(){var data={};this._processParametersCore(data);var level=this.dashboard.debug;if(level>1){data.paramdebug=true;data.paramdebugLevel=level;}
data.script=escape(this.getScriptUrl());data.outputType=this.getOutputType()||'svg';return data;},_processParametersCore:function(params){var dash=this.dashboard;var params=this.parameters;for(var i=0,L=params.length;i<L;i++){var param=params[i];var value=dash.getParameterValue(param[1]);if($.isArray(value)&&value.length==1&&(''+value[0]).indexOf(';')>=0){value=doCsvQuoting(value[0],';');}
data["param"+param[0]]=value;}},objectUrl:function(baseUrl,script,params){var objUrl=baseUrl+'?',pArray=[];for(var p in params){if(params.hasOwnProperty(p)){pArray.push(escape(p)+'='+escape(params[p]));}}
objUrl+='&'+pArray.join('&');return objUrl;},createObj:function(url,script,data,width,height,svgweb){var obj=(svgweb?document.createElement('object',true):document.createElement('object'));obj.setAttribute('type','image/svg+xml');obj.setAttribute('data',this.objectUrl(url,script,data));obj.setAttribute('width',width);obj.setAttribute('height',height);return obj;}});var CggDialComponent=CggComponent.extend({script:"system/pentaho-cdf-dd/resources/custom/components/cgg/charts/dial.js",getScriptUrl:function(){return this.script;},getOutputType:function(){return'svg';},_processParametersCore:function(data){data.paramvalue=this.dashboard.getParameterValue(this.parameter);data.paramcolors=this.colors;data.paramscale=this.intervals;}});
var views=views||{};views.pagingSelector={};var models=models||{};models.pagingSelector={};models.pagingSelector.SelectorModel=Backbone.Model.extend({defaults:{"title":"","search":true,"advancedSearch":false,"multiselect":true,"searchterm":"","collapsed":true,"values":null,"pageStart":0,"pageSize":Infinity,"totalRecords":0},initialize:function(values){this.set("values",new Backbone.Collection());var values=this.get("values");values.comparator=function(val){return val.get("idx");};values.model=models.pagingSelector.OptionModel;values.on("change:selected",this.updateSelection,this);this.on("change:searchterm",this.updateSearch,this);this.updateValues(values);},addPage:function(newValues){var v,newValue,values=this.get("values");for(v=0;v<newValues.length;v++){var newValue=newValues[v],found=values.detect(function(model){return model.get("idx")==newValue.idx;});if(!found){values.add(newValues[v],{silent:true});}}
values.trigger("add");},nextPage:function(){var start=this.get("pageStart"),size=this.get("pageSize"),total=this.get("totalRecords"),requestedPage=start+size,lastPage=total-total%size;this.set("pageStart",Math.min(requestedPage,lastPage));},prevPage:function(){var start=this.get("pageStart"),size=this.get("pageSize");this.set("pageStart",Math.max(0,start-size));},firstPage:function(){this.set("pageStart",0);},lastPage:function(){var total=this.get("totalRecords"),size=this.get("pageSize");this.set("pageStart",total-total%size);},goToPage:function(page){var total=this.get("totalRecords"),size=this.get("pageSize"),requestedPage=page*size,lastPage=total-total%size;this.set("pageStart",Math.min(requestedPage,lastPage));},updateValues:function(values){this.get("values").reset(values);},updateSelection:function(m,selected){if(selected&&!this.get("multiselect")){_(this.get("values").without(m)).each(function(other){other.set("selected",false);});}},clearSelection:function(){this.get("values").each(function(m){m.set("selected",false);})},toggleCollapsed:function(){this.set("collapsed",!this.get("collapsed"));},selectedValues:function(){return _(this.get("values").where({selected:true})).map(function(m){return m.get("value")});},updateSearch:function(){var term=this.get("searchterm");var pattern=new RegExp(term);this.get("values").each(function(m){var match=pattern.test(m.get('label'))||(this.get("advancedSearch")&&pattern.test(m.get("value")));m.set("visible",match);},this);}});models.pagingSelector.OptionModel=Backbone.Model.extend({defaults:{"idx":0,"label":"","value":null,"visible":true,"selected":false,"new":false},toggleSelected:function(){this.set("selected",!this.get("selected"));}});views.pagingSelector.SelectorView=Backbone.View.extend({events:{"click .title":"toggleCollapsed","click .first":"firstPage","click .prev":"prevPage","click .next":"nextPage","click .last":"lastPage","click .pages span":"goToPage","change .search input":"updateSearch","keydown .search input":"testChange","click .validate":"toggleCollapsed"},initialize:function(){this.initializeOptions();this.configureListeners();},configureListeners:function(){this.model.on("change",this.render,this);this.model.on("change:collapsed",this.updateCollapsed,this);this.model.on("change:pageStart",this.renderPages,this);var values=this.model.get("values");values.on("change:selected",this.toggleSelected,this);values.on("add remove reset",this.updateOptions,this)},initializeOptions:function(){this._selectedViews=[];this._optionViews=[];this.model.get("values").each(function(m){this._optionViews.push(new views.pagingSelector.OptionView({model:m}));if(m.get("selected")){this._selectedViews.push(new views.pagingSelector.SelectionView({model:m}));}},this);},updateSearch:function(evt){this.model.set("searchterm",evt.target.value);evt.stopPropagation();},testChange:function(evt){if(evt.which==13){this.updateSearch(evt);}},render:function(){this.$el.html(templates.pagingSelector.main(this.model.toJSON()));this.updateCollapsed();this.renderOptions();this.renderPages();},renderPages:function(){var m=this.model,currPage=Math.ceil(m.get("pageStart")/m.get("pageSize")),maxPages=Math.ceil(m.get("totalRecords")/m.get("pageSize")),$pages=this.$el.find(".pages"),i,preSkip=false,postSkip=false;$pages.empty();for(i=0;i<maxPages;i++){if(i<5||maxPages-i<5||Math.abs(currPage-i)<2){$pages.append($("<span class='page'>"+(i+1)+"</span>").attr("data-page",i).addClass(i==currPage?"current":""));}else{if(!preSkip&&i<currPage){$pages.append("&hellip;");preSkip=true;}else if(!postSkip&&i>currPage){$pages.append("&hellip;");postSkip=true;}}}},renderOptions:function(){var optionContainer=this.$el.find(".options").empty(),selectionContainer=this.$el.find(".selection").empty(),minIdx=this.model.get('pageStart'),maxIdx=this.model.get('pageStart')+this.model.get('pageSize');_(this._optionViews).each(function(v){var idx=v.model.get("idx");if(idx<maxIdx&&idx>=minIdx){optionContainer.append(v.render().el);}});_(this._selectedViews).each(function(v){selectionContainer.append(v.render().el);});},updateOptions:function(){this.initializeOptions();this.renderOptions();},toggleSelected:function(m,selected){var v;if(selected){v=new views.pagingSelector.SelectionView({model:m});this.$el.find(".selection").append(v.render().el);this._selectedViews.push(v);}else{v=_(this._selectedViews).find(function(v){return v.model===m});v.remove();this._selectedViews=_(this._selectedViews).without(v);}},toggleCollapsed:function(){this.model.toggleCollapsed();},updateCollapsed:function(){$('.selectorComponent').addClass('collapsed').removeClass('expanded');if(this.model.get("collapsed")){this.$el.find('.selectorComponent').addClass('collapsed').removeClass('expanded');}else{$(".datepicker-title").removeClass("datepicker-title-visible");$(".datepicker-outerbox").hide();$(".manage-views.active").click();this.$el.find('.selectorComponent').removeClass('collapsed').addClass('expanded');var optionList=this.$el.find(".optionList"),minimumMargin=10,topEdge=optionList.offset().top,bottomEdge=topEdge+optionList.outerHeight(),topLimit=$(window).scrollTop(),bottomLimit=topLimit+$(window).height(),offset=bottomEdge<=bottomLimit?0:bottomLimit-bottomEdge-minimumMargin;offset=topEdge-offset>=topLimit?offset:topLimit-topEdge+minimumMargin;optionList.css("top",(optionList.position().top+offset)+"px");}},nextPage:function(){this.model.nextPage();},prevPage:function(){this.model.prevPage();},firstPage:function(){this.model.firstPage();},lastPage:function(){this.model.lastPage();},goToPage:function(evt){var page=$(evt.target).attr("data-page");this.model.goToPage(page);}});views.pagingSelector.OptionView=Backbone.View.extend({tagName:"span",events:{"click .target":"toggleSelection"},initialize:function(){this.model.on("change:selected",this.updateSelectionDisplay,this);this.model.on("change:visible",this.updateVisibility,this);},render:function(){this.$el.html(templates.pagingSelector.option(this.model.toJSON()));this.$el.addClass('item');this.updateSelectionDisplay();this.updateVisibility();this.delegateEvents();return this;},toggleSelection:function(){this.model.toggleSelected();},updateVisibility:function(){if(this.model.get('visible')){this.$el.show();}else{this.$el.hide();}},updateSelectionDisplay:function(){if(this.model.get('selected')){this.$el.addClass('selected');}else{this.$el.removeClass('selected');}}});views.pagingSelector.SelectionView=Backbone.View.extend({tagName:"li",events:{"click .remove":"unselect"},render:function(){this.$el.html(templates.pagingSelector.picked(this.model.toJSON()));this.$el.addClass('item');this.delegateEvents();return this;},unselect:function(){this.model.set("selected",false);}});var templates=templates||{};templates.pagingSelector={};templates.pagingSelector.main=Mustache.compile("<div class='selectorComponent'>"+"  <div class='pulldown'>"+"    <div class='title'>{{title}}</div>"+"      <div class='optionList'>"+"        <div class='search'>"+"          <input type='text' placeholder='Search...' value='{{searchterm}}'/>"+"          <div class='cancel'>&nbsp;</div>"+"        </div>"+"        <div class='options'></div>"+"        <div class='paginationContainer'>"+"          <div class='pagination'>"+"            <div class='first paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='prev paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='pages'></div>"+"            <div class='next paginateButton'><div class='arrow'>&nbsp;</div></div>"+"            <div class='last paginateButton'><div class='arrow'>&nbsp;</div></div>"+"          </div>"+"          <div class='validate'><div class='image'>&nbsp;</div></div>"+"        </div>"+"      </div>"+"  </div>"+"  <div class='selection'></div>"+"</div>");templates.pagingSelector.option=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"  <span class='check'>&nbsp;</span>"+"  {{#new}}<span class='new'>&nbsp;</span>{{/new}}"+"</div>");templates.pagingSelector.picked=Mustache.compile("<div class='target'>"+"  <span class='name' title='{{label}}'>{{label}}</span>"+"  <div class='remove'>&nbsp;</div>"+"</div>");
var NewSelectorComponent=UnmanagedComponent.extend({pageStart:0,pageSize:54,update:function(){$.extend(this.options,this);this.ph=$("#"+this.htmlObject).empty();var redraw=_.bind(this.redraw,this);if(typeof this.valuesArray!="undefined"&&this.valuesArray.length>0){this.synchronous(redraw,this.valuesArray);}else{var params=Dashboards.propertiesArrayToObject(this.parameters);var pattern=(this.selectorModel)?this.selectorModel.get("searchterm"):"";params[this.searchParam]="'"+pattern+"'";this.parameters=Dashboards.objectToPropertiesArray(params);this.triggerQuery(this.chartDefinition,redraw,{pageSize:this.pageSize});}},values:function(results){var data=results.resultset,idx=(results.queryInfo)?results.queryInfo.pageStart:0,currentValues=Dashboards.getParameterValue(this.parameter),vid=this.chartDefinition.valueAsId,values=[];if(!_.isArray(currentValues))currentValues=[currentValues];_.each(data,function(row){var value=row[vid?1:0],v={idx:idx++,value:value,label:row[1],selected:!!(1+currentValues.indexOf(value)),"new":!!row[2]};values.push(v);},this);return values;},redraw:function(data){var values=this.values(data),modelOptions={title:this.title,pageSize:this.pageSize,pageStart:this.pageStart,totalRecords:(data.queryInfo)?data.queryInfo.totalRows:0,multiselect:this.multiselect},v,p;v=_.pluck(values,"value"),p=Dashboards.getParameterValue(this.parameter);p=_.filter(p,function(val){return _.include(v,val);});Dashboards.setParameter(this.parameter,p);if(!this.selectorModel){this.selectorModel=new models.pagingSelector.SelectorModel(modelOptions);}else{this.selectorModel.set(modelOptions);}
this.selectorModel.updateValues(values);if(!this.selectorView){this.selectorView=new views.pagingSelector.SelectorView({model:this.selectorModel,el:this.ph.get(0)});}
this.selectorView.render();this.selectorModel.off('change:searchterm',this.update);this.selectorModel.on('change:searchterm',this.update,this);this.selectorModel.off('change:pageSize',this.pagingHandler);this.selectorModel.on('change:pageSize',this.pagingHandler,this);this.selectorModel.off('change:pageStart',this.pagingHandler);this.selectorModel.on('change:pageStart',this.pagingHandler,this);this.selectorModel.off("change:collapsed",this.handleCollapse);this.selectorModel.on("change:collapsed",this.handleCollapse,this);this.timeout=0;var values=this.selectorModel.get("values");values.off("change:selected",this.handleSelectionChange);values.on("change:selected",this.handleSelectionChange,this);},handleCollapse:function(evt){if(evt.changed.collapsed)Dashboards.processChange(this.name);},handleSelectionChange:function(evt){if(!evt.changed.selected&&this.selectorModel.get("collapsed")){if(this.timeout!==0){clearTimeout(this.timetimeout);};var myself=this;this.timeout=setTimeout(function(){Dashboards.processChange(myself.name);timeout=0;},1500);}},pagingHandler:function(){var redraw=this.getSuccessHandler(_.bind(function(data){var values=this.values(data);this.selectorModel.addPage(values);},this));this.queryState.pageStartingAt(this.selectorModel.get("pageStart"),redraw);},getValue:function(){return this.selectorModel.selectedValues();}});
(function(jQuery){if(window.XDomainRequest){jQuery.ajaxTransport(function(s){if(s.crossDomain&&s.async){if(s.timeout){s.xdrTimeout=s.timeout;delete s.timeout;}
var xdr;return{send:function(_,complete){function callback(status,statusText,responses,responseHeaders){xdr.onload=xdr.onerror=xdr.ontimeout=jQuery.noop;xdr=undefined;complete(status,statusText,responses,responseHeaders);}
xdr=new window.XDomainRequest();xdr.onload=function(){callback(200,"OK",{text:xdr.responseText},"Content-Type: "+xdr.contentType);};xdr.onerror=function(){callback(404,"Not Found");};xdr.onprogress=function(){};if(s.xdrTimeout){xdr.ontimeout=function(){callback(0,"timeout");};xdr.timeout=s.xdrTimeout;}
xdr.open(s.type,s.url,true);xdr.send((s.hasContent&&s.data)||null);},abort:function(){if(xdr){xdr.onerror=jQuery.noop();xdr.abort();}}};}});}})(jQuery);
if(!jQuery.support.cors&&jQuery.ajaxTransport&&window.XDomainRequest){var httpRegEx=/^https?:\/\//i;var getOrPostRegEx=/^get|post$/i;var sameSchemeRegEx=new RegExp('^'+location.protocol,'i');var htmlRegEx=/text\/html/i;var jsonRegEx=/\/json/i;var xmlRegEx=/\/xml/i;jQuery.ajaxTransport('text html xml json',function(options,userOptions,jqXHR){if(options.crossDomain&&options.async&&getOrPostRegEx.test(options.type)&&httpRegEx.test(options.url)&&sameSchemeRegEx.test(options.url)){var xdr=null;var userType=(userOptions.dataType||'').toLowerCase();return{send:function(headers,complete){xdr=new XDomainRequest();if(/^\d+$/.test(userOptions.timeout)){xdr.timeout=userOptions.timeout;}
xdr.ontimeout=function(){complete(500,'timeout');};xdr.onload=function(){var allResponseHeaders='Content-Length: '+xdr.responseText.length+'\r\nContent-Type: '+xdr.contentType;var status={code:200,message:'success'};var responses={text:xdr.responseText};try{if(userType==='html'||htmlRegEx.test(xdr.contentType)){responses.html=xdr.responseText;}else if(userType==='json'||(userType!=='text'&&jsonRegEx.test(xdr.contentType))){try{responses.json=jQuery.parseJSON(xdr.responseText);}catch(e){status.code=500;status.message='parseerror';}}else if(userType==='xml'||(userType!=='text'&&xmlRegEx.test(xdr.contentType))){var doc=new ActiveXObject('Microsoft.XMLDOM');doc.async=false;try{doc.loadXML(xdr.responseText);}catch(e){doc=undefined;}
if(!doc||!doc.documentElement||doc.getElementsByTagName('parsererror').length){status.code=500;status.message='parseerror';throw'Invalid XML: '+xdr.responseText;}
responses.xml=doc;}}catch(parseMessage){throw parseMessage;}finally{complete(status.code,status.message,responses,allResponseHeaders);}};xdr.onprogress=function(){};xdr.onerror=function(){complete(500,'error',{text:xdr.responseText});};var postData='';if(userOptions.data){postData=(jQuery.type(userOptions.data)==='string')?userOptions.data:jQuery.param(userOptions.data);}
xdr.open(options.type,options.url);xdr.send(postData);},abort:function(){if(xdr){xdr.abort();}}};}});};(function($){"use strict";var feature={};feature.fileapi=$("<input type='file'/>").get(0).files!==undefined;feature.formdata=window.FormData!==undefined;var hasProp=!!$.fn.prop;$.fn.attr2=function(){if(!hasProp)
return this.attr.apply(this,arguments);var val=this.prop.apply(this,arguments);if((val&&val.jquery)||typeof val==='string')
return val;return this.attr.apply(this,arguments);};$.fn.ajaxSubmit=function(options){if(!this.length){log('ajaxSubmit: skipping submit process - no element selected');return this;}
var method,action,url,$form=this;if(typeof options=='function'){options={success:options};}
else if(options===undefined){options={};}
method=options.type||this.attr2('method');action=options.url||this.attr2('action');url=(typeof action==='string')?$.trim(action):'';url=url||window.location.href||'';if(url){url=(url.match(/^([^#]+)/)||[])[1];}
options=$.extend(true,{url:url,success:$.ajaxSettings.success,type:method||$.ajaxSettings.type,iframeSrc:/^https/i.test(window.location.href||'')?'javascript:false':'about:blank'},options);var veto={};this.trigger('form-pre-serialize',[this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');return this;}
if(options.beforeSerialize&&options.beforeSerialize(this,options)===false){log('ajaxSubmit: submit aborted via beforeSerialize callback');return this;}
var traditional=options.traditional;if(traditional===undefined){traditional=$.ajaxSettings.traditional;}
var elements=[];var qx,a=this.formToArray(options.semantic,elements);if(options.data){options.extraData=options.data;qx=$.param(options.data,traditional);}
if(options.beforeSubmit&&options.beforeSubmit(a,this,options)===false){log('ajaxSubmit: submit aborted via beforeSubmit callback');return this;}
this.trigger('form-submit-validate',[a,this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-submit-validate trigger');return this;}
var q=$.param(a,traditional);if(qx){q=(q?(q+'&'+qx):qx);}
if(options.type.toUpperCase()=='GET'){options.url+=(options.url.indexOf('?')>=0?'&':'?')+q;options.data=null;}
else{options.data=q;}
var callbacks=[];if(options.resetForm){callbacks.push(function(){$form.resetForm();});}
if(options.clearForm){callbacks.push(function(){$form.clearForm(options.includeHidden);});}
if(!options.dataType&&options.target){var oldSuccess=options.success||function(){};callbacks.push(function(data){var fn=options.replaceTarget?'replaceWith':'html';$(options.target)[fn](data).each(oldSuccess,arguments);});}
else if(options.success){callbacks.push(options.success);}
options.success=function(data,status,xhr){var context=options.context||this;for(var i=0,max=callbacks.length;i<max;i++){callbacks[i].apply(context,[data,status,xhr||$form,$form]);}};if(options.error){var oldError=options.error;options.error=function(xhr,status,error){var context=options.context||this;oldError.apply(context,[xhr,status,error,$form]);};}
if(options.complete){var oldComplete=options.complete;options.complete=function(xhr,status){var context=options.context||this;oldComplete.apply(context,[xhr,status,$form]);};}
var fileInputs=$('input[type=file]:enabled:not([value=""])',this);var hasFileInputs=fileInputs.length>0;var mp='multipart/form-data';var multipart=($form.attr('enctype')==mp||$form.attr('encoding')==mp);var fileAPI=feature.fileapi&&feature.formdata;log("fileAPI :"+fileAPI);var shouldUseFrame=(hasFileInputs||multipart)&&!fileAPI;var jqxhr;if(options.iframe!==false&&(options.iframe||shouldUseFrame)){if(options.closeKeepAlive){$.get(options.closeKeepAlive,function(){jqxhr=fileUploadIframe(a);});}
else{jqxhr=fileUploadIframe(a);}}
else if((hasFileInputs||multipart)&&fileAPI){jqxhr=fileUploadXhr(a);}
else{jqxhr=$.ajax(options);}
$form.removeData('jqxhr').data('jqxhr',jqxhr);for(var k=0;k<elements.length;k++)
elements[k]=null;this.trigger('form-submit-notify',[this,options]);return this;function deepSerialize(extraData){var serialized=$.param(extraData,options.traditional).split('&');var len=serialized.length;var result=[];var i,part;for(i=0;i<len;i++){serialized[i]=serialized[i].replace(/\+/g,' ');part=serialized[i].split('=');result.push([decodeURIComponent(part[0]),decodeURIComponent(part[1])]);}
return result;}
function fileUploadXhr(a){var formdata=new FormData();for(var i=0;i<a.length;i++){formdata.append(a[i].name,a[i].value);}
if(options.extraData){var serializedData=deepSerialize(options.extraData);for(i=0;i<serializedData.length;i++)
if(serializedData[i])
formdata.append(serializedData[i][0],serializedData[i][1]);}
options.data=null;var s=$.extend(true,{},$.ajaxSettings,options,{contentType:false,processData:false,cache:false,type:method||'POST'});if(options.uploadProgress){s.xhr=function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(event){var percent=0;var position=event.loaded||event.position;var total=event.total;if(event.lengthComputable){percent=Math.ceil(position/total*100);}
options.uploadProgress(event,position,total,percent);},false);}
return xhr;};}
s.data=null;var beforeSend=s.beforeSend;s.beforeSend=function(xhr,o){o.data=formdata;if(beforeSend)
beforeSend.call(this,xhr,o);};return $.ajax(s);}
function fileUploadIframe(a){var form=$form[0],el,i,s,g,id,$io,io,xhr,sub,n,timedOut,timeoutHandle;var deferred=$.Deferred();deferred.abort=function(status){xhr.abort(status);};if(a){for(i=0;i<elements.length;i++){el=$(elements[i]);if(hasProp)
el.prop('disabled',false);else
el.removeAttr('disabled');}}
s=$.extend(true,{},$.ajaxSettings,options);s.context=s.context||s;id='jqFormIO'+(new Date().getTime());if(s.iframeTarget){$io=$(s.iframeTarget);n=$io.attr2('name');if(!n)
$io.attr2('name',id);else
id=n;}
else{$io=$('<iframe name="'+id+'" src="'+s.iframeSrc+'" />');$io.css({position:'absolute',top:'-1000px',left:'-1000px'});}
io=$io[0];xhr={aborted:0,responseText:null,responseXML:null,status:0,statusText:'n/a',getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(status){var e=(status==='timeout'?'timeout':'aborted');log('aborting upload... '+e);this.aborted=1;try{if(io.contentWindow.document.execCommand){io.contentWindow.document.execCommand('Stop');}}
catch(ignore){}
$io.attr('src',s.iframeSrc);xhr.error=e;if(s.error)
s.error.call(s.context,xhr,e,status);if(g)
$.event.trigger("ajaxError",[xhr,s,e]);if(s.complete)
s.complete.call(s.context,xhr,e);}};g=s.global;if(g&&0===$.active++){$.event.trigger("ajaxStart");}
if(g){$.event.trigger("ajaxSend",[xhr,s]);}
if(s.beforeSend&&s.beforeSend.call(s.context,xhr,s)===false){if(s.global){$.active--;}
deferred.reject();return deferred;}
if(xhr.aborted){deferred.reject();return deferred;}
sub=form.clk;if(sub){n=sub.name;if(n&&!sub.disabled){s.extraData=s.extraData||{};s.extraData[n]=sub.value;if(sub.type=="image"){s.extraData[n+'.x']=form.clk_x;s.extraData[n+'.y']=form.clk_y;}}}
var CLIENT_TIMEOUT_ABORT=1;var SERVER_ABORT=2;function getDoc(frame){var doc=null;try{if(frame.contentWindow){doc=frame.contentWindow.document;}}catch(err){log('cannot get iframe.contentWindow document: '+err);}
if(doc){return doc;}
try{doc=frame.contentDocument?frame.contentDocument:frame.document;}catch(err){log('cannot get iframe.contentDocument: '+err);doc=frame.document;}
return doc;}
var csrf_token=$('meta[name=csrf-token]').attr('content');var csrf_param=$('meta[name=csrf-param]').attr('content');if(csrf_param&&csrf_token){s.extraData=s.extraData||{};s.extraData[csrf_param]=csrf_token;}
function doSubmit(){var t=$form.attr2('target'),a=$form.attr2('action');form.setAttribute('target',id);if(!method){form.setAttribute('method','POST');}
if(a!=s.url){form.setAttribute('action',s.url);}
if(!s.skipEncodingOverride&&(!method||/post/i.test(method))){$form.attr({encoding:'multipart/form-data',enctype:'multipart/form-data'});}
if(s.timeout){timeoutHandle=setTimeout(function(){timedOut=true;cb(CLIENT_TIMEOUT_ABORT);},s.timeout);}
function checkState(){try{var state=getDoc(io).readyState;log('state = '+state);if(state&&state.toLowerCase()=='uninitialized')
setTimeout(checkState,50);}
catch(e){log('Server abort: ',e,' (',e.name,')');cb(SERVER_ABORT);if(timeoutHandle)
clearTimeout(timeoutHandle);timeoutHandle=undefined;}}
var extraInputs=[];try{if(s.extraData){for(var n in s.extraData){if(s.extraData.hasOwnProperty(n)){if($.isPlainObject(s.extraData[n])&&s.extraData[n].hasOwnProperty('name')&&s.extraData[n].hasOwnProperty('value')){extraInputs.push($('<input type="hidden" name="'+s.extraData[n].name+'">').val(s.extraData[n].value).appendTo(form)[0]);}else{extraInputs.push($('<input type="hidden" name="'+n+'">').val(s.extraData[n]).appendTo(form)[0]);}}}}
if(!s.iframeTarget){$io.appendTo('body');if(io.attachEvent)
io.attachEvent('onload',cb);else
io.addEventListener('load',cb,false);}
setTimeout(checkState,15);try{form.submit();}catch(err){var submitFn=document.createElement('form').submit;submitFn.apply(form);}}
finally{form.setAttribute('action',a);if(t){form.setAttribute('target',t);}else{$form.removeAttr('target');}
$(extraInputs).remove();}}
if(s.forceSync){doSubmit();}
else{setTimeout(doSubmit,10);}
var data,doc,domCheckCount=50,callbackProcessed;function cb(e){if(xhr.aborted||callbackProcessed){return;}
doc=getDoc(io);if(!doc){log('cannot access response document');e=SERVER_ABORT;}
if(e===CLIENT_TIMEOUT_ABORT&&xhr){xhr.abort('timeout');deferred.reject(xhr,'timeout');return;}
else if(e==SERVER_ABORT&&xhr){xhr.abort('server abort');deferred.reject(xhr,'error','server abort');return;}
if(!doc||doc.location.href==s.iframeSrc){if(!timedOut)
return;}
if(io.detachEvent)
io.detachEvent('onload',cb);else
io.removeEventListener('load',cb,false);var status='success',errMsg;try{if(timedOut){throw'timeout';}
var isXml=s.dataType=='xml'||doc.XMLDocument||$.isXMLDoc(doc);log('isXml='+isXml);if(!isXml&&window.opera&&(doc.body===null||!doc.body.innerHTML)){if(--domCheckCount){log('requeing onLoad callback, DOM not available');setTimeout(cb,250);return;}}
var docRoot=doc.body?doc.body:doc.documentElement;xhr.responseText=docRoot?docRoot.innerHTML:null;xhr.responseXML=doc.XMLDocument?doc.XMLDocument:doc;if(isXml)
s.dataType='xml';xhr.getResponseHeader=function(header){var headers={'content-type':s.dataType};return headers[header.toLowerCase()];};if(docRoot){xhr.status=Number(docRoot.getAttribute('status'))||xhr.status;xhr.statusText=docRoot.getAttribute('statusText')||xhr.statusText;}
var dt=(s.dataType||'').toLowerCase();var scr=/(json|script|text)/.test(dt);if(scr||s.textarea){var ta=doc.getElementsByTagName('textarea')[0];if(ta){xhr.responseText=ta.value;xhr.status=Number(ta.getAttribute('status'))||xhr.status;xhr.statusText=ta.getAttribute('statusText')||xhr.statusText;}
else if(scr){var pre=doc.getElementsByTagName('pre')[0];var b=doc.getElementsByTagName('body')[0];if(pre){xhr.responseText=pre.textContent?pre.textContent:pre.innerText;}
else if(b){xhr.responseText=b.textContent?b.textContent:b.innerText;}}}
else if(dt=='xml'&&!xhr.responseXML&&xhr.responseText){xhr.responseXML=toXml(xhr.responseText);}
try{data=httpData(xhr,dt,s);}
catch(err){status='parsererror';xhr.error=errMsg=(err||status);}}
catch(err){log('error caught: ',err);status='error';xhr.error=errMsg=(err||status);}
if(xhr.aborted){log('upload aborted');status=null;}
if(xhr.status){status=(xhr.status>=200&&xhr.status<300||xhr.status===304)?'success':'error';}
if(status==='success'){if(s.success)
s.success.call(s.context,data,'success',xhr);deferred.resolve(xhr.responseText,'success',xhr);if(g)
$.event.trigger("ajaxSuccess",[xhr,s]);}
else if(status){if(errMsg===undefined)
errMsg=xhr.statusText;if(s.error)
s.error.call(s.context,xhr,status,errMsg);deferred.reject(xhr,'error',errMsg);if(g)
$.event.trigger("ajaxError",[xhr,s,errMsg]);}
if(g)
$.event.trigger("ajaxComplete",[xhr,s]);if(g&&!--$.active){$.event.trigger("ajaxStop");}
if(s.complete)
s.complete.call(s.context,xhr,status);callbackProcessed=true;if(s.timeout)
clearTimeout(timeoutHandle);setTimeout(function(){if(!s.iframeTarget)
$io.remove();xhr.responseXML=null;},100);}
var toXml=$.parseXML||function(s,doc){if(window.ActiveXObject){doc=new ActiveXObject('Microsoft.XMLDOM');doc.async='false';doc.loadXML(s);}
else{doc=(new DOMParser()).parseFromString(s,'text/xml');}
return(doc&&doc.documentElement&&doc.documentElement.nodeName!='parsererror')?doc:null;};var parseJSON=$.parseJSON||function(s){return window['eval']('('+s+')');};var httpData=function(xhr,type,s){var ct=xhr.getResponseHeader('content-type')||'',xml=type==='xml'||!type&&ct.indexOf('xml')>=0,data=xml?xhr.responseXML:xhr.responseText;if(xml&&data.documentElement.nodeName==='parsererror'){if($.error)
$.error('parsererror');}
if(s&&s.dataFilter){data=s.dataFilter(data,type);}
if(typeof data==='string'){if(type==='json'||!type&&ct.indexOf('json')>=0){data=parseJSON(data);}else if(type==="script"||!type&&ct.indexOf("javascript")>=0){$.globalEval(data);}}
return data;};return deferred;}};$.fn.ajaxForm=function(options){options=options||{};options.delegation=options.delegation&&$.isFunction($.fn.on);if(!options.delegation&&this.length===0){var o={s:this.selector,c:this.context};if(!$.isReady&&o.s){log('DOM not ready, queuing ajaxForm');$(function(){$(o.s,o.c).ajaxForm(options);});return this;}
log('terminating; zero elements found by selector'+($.isReady?'':' (DOM not ready)'));return this;}
if(options.delegation){$(document).off('submit.form-plugin',this.selector,doAjaxSubmit).off('click.form-plugin',this.selector,captureSubmittingElement).on('submit.form-plugin',this.selector,options,doAjaxSubmit).on('click.form-plugin',this.selector,options,captureSubmittingElement);return this;}
return this.ajaxFormUnbind().bind('submit.form-plugin',options,doAjaxSubmit).bind('click.form-plugin',options,captureSubmittingElement);};function doAjaxSubmit(e){var options=e.data;if(!e.isDefaultPrevented()){e.preventDefault();$(this).ajaxSubmit(options);}}
function captureSubmittingElement(e){var target=e.target;var $el=$(target);if(!($el.is("[type=submit],[type=image]"))){var t=$el.closest('[type=submit]');if(t.length===0){return;}
target=t[0];}
var form=this;form.clk=target;if(target.type=='image'){if(e.offsetX!==undefined){form.clk_x=e.offsetX;form.clk_y=e.offsetY;}else if(typeof $.fn.offset=='function'){var offset=$el.offset();form.clk_x=e.pageX-offset.left;form.clk_y=e.pageY-offset.top;}else{form.clk_x=e.pageX-target.offsetLeft;form.clk_y=e.pageY-target.offsetTop;}}
setTimeout(function(){form.clk=form.clk_x=form.clk_y=null;},100);}
$.fn.ajaxFormUnbind=function(){return this.unbind('submit.form-plugin click.form-plugin');};$.fn.formToArray=function(semantic,elements){var a=[];if(this.length===0){return a;}
var form=this[0];var els=semantic?form.getElementsByTagName('*'):form.elements;if(!els){return a;}
var i,j,n,v,el,max,jmax;for(i=0,max=els.length;i<max;i++){el=els[i];n=el.name;if(!n||el.disabled){continue;}
if(semantic&&form.clk&&el.type=="image"){if(form.clk==el){a.push({name:n,value:$(el).val(),type:el.type});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}
continue;}
v=$.fieldValue(el,true);if(v&&v.constructor==Array){if(elements)
elements.push(el);for(j=0,jmax=v.length;j<jmax;j++){a.push({name:n,value:v[j]});}}
else if(feature.fileapi&&el.type=='file'){if(elements)
elements.push(el);var files=el.files;if(files.length){for(j=0;j<files.length;j++){a.push({name:n,value:files[j],type:el.type});}}
else{a.push({name:n,value:'',type:el.type});}}
else if(v!==null&&typeof v!='undefined'){if(elements)
elements.push(el);a.push({name:n,value:v,type:el.type,required:el.required});}}
if(!semantic&&form.clk){var $input=$(form.clk),input=$input[0];n=input.name;if(n&&!input.disabled&&input.type=='image'){a.push({name:n,value:$input.val()});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}}
return a;};$.fn.formSerialize=function(semantic){return $.param(this.formToArray(semantic));};$.fn.fieldSerialize=function(successful){var a=[];this.each(function(){var n=this.name;if(!n){return;}
var v=$.fieldValue(this,successful);if(v&&v.constructor==Array){for(var i=0,max=v.length;i<max;i++){a.push({name:n,value:v[i]});}}
else if(v!==null&&typeof v!='undefined'){a.push({name:this.name,value:v});}});return $.param(a);};$.fn.fieldValue=function(successful){for(var val=[],i=0,max=this.length;i<max;i++){var el=this[i];var v=$.fieldValue(el,successful);if(v===null||typeof v=='undefined'||(v.constructor==Array&&!v.length)){continue;}
if(v.constructor==Array)
$.merge(val,v);else
val.push(v);}
return val;};$.fieldValue=function(el,successful){var n=el.name,t=el.type,tag=el.tagName.toLowerCase();if(successful===undefined){successful=true;}
if(successful&&(!n||el.disabled||t=='reset'||t=='button'||(t=='checkbox'||t=='radio')&&!el.checked||(t=='submit'||t=='image')&&el.form&&el.form.clk!=el||tag=='select'&&el.selectedIndex==-1)){return null;}
if(tag=='select'){var index=el.selectedIndex;if(index<0){return null;}
var a=[],ops=el.options;var one=(t=='select-one');var max=(one?index+1:ops.length);for(var i=(one?index:0);i<max;i++){var op=ops[i];if(op.selected){var v=op.value;if(!v){v=(op.attributes&&op.attributes['value']&&!(op.attributes['value'].specified))?op.text:op.value;}
if(one){return v;}
a.push(v);}}
return a;}
return $(el).val();};$.fn.clearForm=function(includeHidden){return this.each(function(){$('input,select,textarea',this).clearFields(includeHidden);});};$.fn.clearFields=$.fn.clearInputs=function(includeHidden){var re=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;return this.each(function(){var t=this.type,tag=this.tagName.toLowerCase();if(re.test(t)||tag=='textarea'){this.value='';}
else if(t=='checkbox'||t=='radio'){this.checked=false;}
else if(tag=='select'){this.selectedIndex=-1;}
else if(t=="file"){if(/MSIE/.test(navigator.userAgent)){$(this).replaceWith($(this).clone(true));}else{$(this).val('');}}
else if(includeHidden){if((includeHidden===true&&/hidden/.test(t))||(typeof includeHidden=='string'&&$(this).is(includeHidden)))
this.value='';}});};$.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=='function'||(typeof this.reset=='object'&&!this.reset.nodeType)){this.reset();}});};$.fn.enable=function(b){if(b===undefined){b=true;}
return this.each(function(){this.disabled=!b;});};$.fn.selected=function(select){if(select===undefined){select=true;}
return this.each(function(){var t=this.type;if(t=='checkbox'||t=='radio'){this.checked=select;}
else if(this.tagName.toLowerCase()=='option'){var $sel=$(this).parent('select');if(select&&$sel[0]&&$sel[0].type=='select-one'){$sel.find('option').selected(false);}
this.selected=select;}});};$.fn.ajaxSubmit.debug=false;function log(){if(!$.fn.ajaxSubmit.debug)
return;var msg='[jquery.form] '+Array.prototype.join.call(arguments,'');if(window.console&&window.console.log){window.console.log(msg);}
else if(window.opera&&window.opera.postError){window.opera.postError(msg);}}})((typeof(jQuery)!='undefined')?jQuery:window.Zepto);
if(!jQuery)throw new Error("Bootstrap requires jQuery");+function(a){"use strict";function b(){var a=document.createElement("bootstrap"),b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var c in b)if(void 0!==a.style[c])return{end:b[c]}}a.fn.emulateTransitionEnd=function(b){var c=!1,d=this;a(this).one(a.support.transition.end,function(){c=!0});var e=function(){c||a(d).trigger(a.support.transition.end)};return setTimeout(e,b),this},a(function(){a.support.transition=b()})}(window.jQuery),+function(a){"use strict";var b='[data-dismiss="alert"]',c=function(c){a(c).on("click",b,this.close)};c.prototype.close=function(b){function c(){f.trigger("closed.bs.alert").remove()}var d=a(this),e=d.attr("data-target");e||(e=d.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,""));var f=a(e);b&&b.preventDefault(),f.length||(f=d.hasClass("alert")?d:d.parent()),f.trigger(b=a.Event("close.bs.alert")),b.isDefaultPrevented()||(f.removeClass("in"),a.support.transition&&f.hasClass("fade")?f.one(a.support.transition.end,c).emulateTransitionEnd(150):c())};var d=a.fn.alert;a.fn.alert=function(b){return this.each(function(){var d=a(this),e=d.data("bs.alert");e||d.data("bs.alert",e=new c(this)),"string"==typeof b&&e[b].call(d)})},a.fn.alert.Constructor=c,a.fn.alert.noConflict=function(){return a.fn.alert=d,this},a(document).on("click.bs.alert.data-api",b,c.prototype.close)}(window.jQuery),+function(a){"use strict";var b=function(c,d){this.$element=a(c),this.options=a.extend({},b.DEFAULTS,d)};b.DEFAULTS={loadingText:"loading..."},b.prototype.setState=function(a){var b="disabled",c=this.$element,d=c.is("input")?"val":"html",e=c.data();a+="Text",e.resetText||c.data("resetText",c[d]()),c[d](e[a]||this.options[a]),setTimeout(function(){"loadingText"==a?c.addClass(b).attr(b,b):c.removeClass(b).removeAttr(b)},0)},b.prototype.toggle=function(){var a=this.$element.closest('[data-toggle="buttons"]');if(a.length){var b=this.$element.find("input").prop("checked",!this.$element.hasClass("active")).trigger("change");"radio"===b.prop("type")&&a.find(".active").removeClass("active")}this.$element.toggleClass("active")};var c=a.fn.button;a.fn.button=function(c){return this.each(function(){var d=a(this),e=d.data("bs.button"),f="object"==typeof c&&c;e||d.data("bs.button",e=new b(this,f)),"toggle"==c?e.toggle():c&&e.setState(c)})},a.fn.button.Constructor=b,a.fn.button.noConflict=function(){return a.fn.button=c,this},a(document).on("click.bs.button.data-api","[data-toggle^=button]",function(b){var c=a(b.target);c.hasClass("btn")||(c=c.closest(".btn")),c.button("toggle"),b.preventDefault()})}(window.jQuery),+function(a){"use strict";var b=function(b,c){this.$element=a(b),this.$indicators=this.$element.find(".carousel-indicators"),this.options=c,this.paused=this.sliding=this.interval=this.$active=this.$items=null,"hover"==this.options.pause&&this.$element.on("mouseenter",a.proxy(this.pause,this)).on("mouseleave",a.proxy(this.cycle,this))};b.DEFAULTS={interval:5e3,pause:"hover",wrap:!0},b.prototype.cycle=function(b){return b||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(a.proxy(this.next,this),this.options.interval)),this},b.prototype.getActiveIndex=function(){return this.$active=this.$element.find(".item.active"),this.$items=this.$active.parent().children(),this.$items.index(this.$active)},b.prototype.to=function(b){var c=this,d=this.getActiveIndex();return b>this.$items.length-1||0>b?void 0:this.sliding?this.$element.one("slid",function(){c.to(b)}):d==b?this.pause().cycle():this.slide(b>d?"next":"prev",a(this.$items[b]))},b.prototype.pause=function(b){return b||(this.paused=!0),this.$element.find(".next, .prev").length&&a.support.transition.end&&(this.$element.trigger(a.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},b.prototype.next=function(){return this.sliding?void 0:this.slide("next")},b.prototype.prev=function(){return this.sliding?void 0:this.slide("prev")},b.prototype.slide=function(b,c){var d=this.$element.find(".item.active"),e=c||d[b](),f=this.interval,g="next"==b?"left":"right",h="next"==b?"first":"last",i=this;if(!e.length){if(!this.options.wrap)return;e=this.$element.find(".item")[h]()}this.sliding=!0,f&&this.pause();var j=a.Event("slide.bs.carousel",{relatedTarget:e[0],direction:g});if(!e.hasClass("active")){if(this.$indicators.length&&(this.$indicators.find(".active").removeClass("active"),this.$element.one("slid",function(){var b=a(i.$indicators.children()[i.getActiveIndex()]);b&&b.addClass("active")})),a.support.transition&&this.$element.hasClass("slide")){if(this.$element.trigger(j),j.isDefaultPrevented())return;e.addClass(b),e[0].offsetWidth,d.addClass(g),e.addClass(g),d.one(a.support.transition.end,function(){e.removeClass([b,g].join(" ")).addClass("active"),d.removeClass(["active",g].join(" ")),i.sliding=!1,setTimeout(function(){i.$element.trigger("slid")},0)}).emulateTransitionEnd(600)}else{if(this.$element.trigger(j),j.isDefaultPrevented())return;d.removeClass("active"),e.addClass("active"),this.sliding=!1,this.$element.trigger("slid")}return f&&this.cycle(),this}};var c=a.fn.carousel;a.fn.carousel=function(c){return this.each(function(){var d=a(this),e=d.data("bs.carousel"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c),g="string"==typeof c?c:f.slide;e||d.data("bs.carousel",e=new b(this,f)),"number"==typeof c?e.to(c):g?e[g]():f.interval&&e.pause().cycle()})},a.fn.carousel.Constructor=b,a.fn.carousel.noConflict=function(){return a.fn.carousel=c,this},a(document).on("click.bs.carousel.data-api","[data-slide], [data-slide-to]",function(b){var c,d=a(this),e=a(d.attr("data-target")||(c=d.attr("href"))&&c.replace(/.*(?=#[^\s]+$)/,"")),f=a.extend({},e.data(),d.data()),g=d.attr("data-slide-to");g&&(f.interval=!1),e.carousel(f),(g=d.attr("data-slide-to"))&&e.data("bs.carousel").to(g),b.preventDefault()}),a(window).on("load",function(){a('[data-ride="carousel"]').each(function(){var b=a(this);b.carousel(b.data())})})}(window.jQuery),+function(a){"use strict";var b=function(c,d){this.$element=a(c),this.options=a.extend({},b.DEFAULTS,d),this.transitioning=null,this.options.parent&&(this.$parent=a(this.options.parent)),this.options.toggle&&this.toggle()};b.DEFAULTS={toggle:!0},b.prototype.dimension=function(){var a=this.$element.hasClass("width");return a?"width":"height"},b.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var b=a.Event("show.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.$parent&&this.$parent.find("> .panel > .in");if(c&&c.length){var d=c.data("bs.collapse");if(d&&d.transitioning)return;c.collapse("hide"),d||c.data("bs.collapse",null)}var e=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[e](0),this.transitioning=1;var f=function(){this.$element.removeClass("collapsing").addClass("in")[e]("auto"),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!a.support.transition)return f.call(this);var g=a.camelCase(["scroll",e].join("-"));this.$element.one(a.support.transition.end,a.proxy(f,this)).emulateTransitionEnd(350)[e](this.$element[0][g])}}},b.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var b=a.Event("hide.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.dimension();this.$element[c](this.$element[c]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var d=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};return a.support.transition?(this.$element[c](0).one(a.support.transition.end,a.proxy(d,this)).emulateTransitionEnd(350),void 0):d.call(this)}}},b.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var c=a.fn.collapse;a.fn.collapse=function(c){return this.each(function(){var d=a(this),e=d.data("bs.collapse"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c);e||d.data("bs.collapse",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.collapse.Constructor=b,a.fn.collapse.noConflict=function(){return a.fn.collapse=c,this},a(document).on("click.bs.collapse.data-api","[data-toggle=collapse]",function(b){var c,d=a(this),e=d.attr("data-target")||b.preventDefault()||(c=d.attr("href"))&&c.replace(/.*(?=#[^\s]+$)/,""),f=a(e),g=f.data("bs.collapse"),h=g?"toggle":d.data(),i=d.attr("data-parent"),j=i&&a(i);g&&g.transitioning||(j&&j.find('[data-toggle=collapse][data-parent="'+i+'"]').not(d).addClass("collapsed"),d[f.hasClass("in")?"addClass":"removeClass"]("collapsed")),f.collapse(h)})}(window.jQuery),+function(a){"use strict";function b(){a(d).remove(),a(e).each(function(b){var d=c(a(this));d.hasClass("open")&&(d.trigger(b=a.Event("hide.bs.dropdown")),b.isDefaultPrevented()||d.removeClass("open").trigger("hidden.bs.dropdown"))})}function c(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}var d=".dropdown-backdrop",e="[data-toggle=dropdown]",f=function(b){a(b).on("click.bs.dropdown",this.toggle)};f.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=c(e),g=f.hasClass("open");if(b(),!g){if("ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a('<div class="dropdown-backdrop"/>').insertAfter(a(this)).on("click",b),f.trigger(d=a.Event("show.bs.dropdown")),d.isDefaultPrevented())return;f.toggleClass("open").trigger("shown.bs.dropdown"),e.focus()}return!1}},f.prototype.keydown=function(b){if(/(38|40|27)/.test(b.keyCode)){var d=a(this);if(b.preventDefault(),b.stopPropagation(),!d.is(".disabled, :disabled")){var f=c(d),g=f.hasClass("open");if(!g||g&&27==b.keyCode)return 27==b.which&&f.find(e).focus(),d.click();var h=a("[role=menu] li:not(.divider):visible a",f);if(h.length){var i=h.index(h.filter(":focus"));38==b.keyCode&&i>0&&i--,40==b.keyCode&&i<h.length-1&&i++,~i||(i=0),h.eq(i).focus()}}}};var g=a.fn.dropdown;a.fn.dropdown=function(b){return this.each(function(){var c=a(this),d=c.data("dropdown");d||c.data("dropdown",d=new f(this)),"string"==typeof b&&d[b].call(c)})},a.fn.dropdown.Constructor=f,a.fn.dropdown.noConflict=function(){return a.fn.dropdown=g,this},a(document).on("click.bs.dropdown.data-api",b).on("click.bs.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.bs.dropdown.data-api",e,f.prototype.toggle).on("keydown.bs.dropdown.data-api",e+", [role=menu]",f.prototype.keydown)}(window.jQuery),+function(a){"use strict";var b=function(b,c){this.options=c,this.$element=a(b),this.$backdrop=this.isShown=null,this.options.remote&&this.$element.load(this.options.remote)};b.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},b.prototype.toggle=function(a){return this[this.isShown?"hide":"show"](a)},b.prototype.show=function(b){var c=this,d=a.Event("show.bs.modal",{relatedTarget:b});this.$element.trigger(d),this.isShown||d.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.$element.on("click.dismiss.modal",'[data-dismiss="modal"]',a.proxy(this.hide,this)),this.backdrop(function(){var d=a.support.transition&&c.$element.hasClass("fade");c.$element.parent().length||c.$element.appendTo(document.body),c.$element.show(),d&&c.$element[0].offsetWidth,c.$element.addClass("in").attr("aria-hidden",!1),c.enforceFocus();var e=a.Event("shown.bs.modal",{relatedTarget:b});d?c.$element.find(".modal-dialog").one(a.support.transition.end,function(){c.$element.focus().trigger(e)}).emulateTransitionEnd(300):c.$element.focus().trigger(e)}))},b.prototype.hide=function(b){b&&b.preventDefault(),b=a.Event("hide.bs.modal"),this.$element.trigger(b),this.isShown&&!b.isDefaultPrevented()&&(this.isShown=!1,this.escape(),a(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.modal"),a.support.transition&&this.$element.hasClass("fade")?this.$element.one(a.support.transition.end,a.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},b.prototype.enforceFocus=function(){a(document).off("focusin.bs.modal").on("focusin.bs.modal",a.proxy(function(a){this.$element[0]===a.target||this.$element.has(a.target).length||this.$element.focus()},this))},b.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",a.proxy(function(a){27==a.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},b.prototype.hideModal=function(){var a=this;this.$element.hide(),this.backdrop(function(){a.removeBackdrop(),a.$element.trigger("hidden.bs.modal")})},b.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},b.prototype.backdrop=function(b){var c=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var d=a.support.transition&&c;if(this.$backdrop=a('<div class="modal-backdrop '+c+'" />').appendTo(document.body),this.$element.on("click.dismiss.modal",a.proxy(function(a){a.target===a.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),d&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!b)return;d?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),a.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()):b&&b()};var c=a.fn.modal;a.fn.modal=function(c,d){return this.each(function(){var e=a(this),f=e.data("bs.modal"),g=a.extend({},b.DEFAULTS,e.data(),"object"==typeof c&&c);f||e.data("bs.modal",f=new b(this,g)),"string"==typeof c?f[c](d):g.show&&f.show(d)})},a.fn.modal.Constructor=b,a.fn.modal.noConflict=function(){return a.fn.modal=c,this},a(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(b){var c=a(this),d=c.attr("href"),e=a(c.attr("data-target")||d&&d.replace(/.*(?=#[^\s]+$)/,"")),f=e.data("modal")?"toggle":a.extend({remote:!/#/.test(d)&&d},e.data(),c.data());b.preventDefault(),e.modal(f,this).one("hide",function(){c.is(":visible")&&c.focus()})}),a(document).on("show.bs.modal",".modal",function(){a(document.body).addClass("modal-open")}).on("hidden.bs.modal",".modal",function(){a(document.body).removeClass("modal-open")})}(window.jQuery),+function(a){"use strict";var b=function(a,b){this.type=this.options=this.enabled=this.timeout=this.hoverState=this.$element=null,this.init("tooltip",a,b)};b.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1},b.prototype.init=function(b,c,d){this.enabled=!0,this.type=b,this.$element=a(c),this.options=this.getOptions(d);for(var e=this.options.trigger.split(" "),f=e.length;f--;){var g=e[f];if("click"==g)this.$element.on("click."+this.type,this.options.selector,a.proxy(this.toggle,this));else if("manual"!=g){var h="hover"==g?"mouseenter":"focus",i="hover"==g?"mouseleave":"blur";this.$element.on(h+"."+this.type,this.options.selector,a.proxy(this.enter,this)),this.$element.on(i+"."+this.type,this.options.selector,a.proxy(this.leave,this))}}this.options.selector?this._options=a.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},b.prototype.getDefaults=function(){return b.DEFAULTS},b.prototype.getOptions=function(b){return b=a.extend({},this.getDefaults(),this.$element.data(),b),b.delay&&"number"==typeof b.delay&&(b.delay={show:b.delay,hide:b.delay}),b},b.prototype.getDelegateOptions=function(){var b={},c=this.getDefaults();return this._options&&a.each(this._options,function(a,d){c[a]!=d&&(b[a]=d)}),b},b.prototype.enter=function(b){var c=b instanceof this.constructor?b:a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs."+this.type);return clearTimeout(c.timeout),c.hoverState="in",c.options.delay&&c.options.delay.show?(c.timeout=setTimeout(function(){"in"==c.hoverState&&c.show()},c.options.delay.show),void 0):c.show()},b.prototype.leave=function(b){var c=b instanceof this.constructor?b:a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs."+this.type);return clearTimeout(c.timeout),c.hoverState="out",c.options.delay&&c.options.delay.hide?(c.timeout=setTimeout(function(){"out"==c.hoverState&&c.hide()},c.options.delay.hide),void 0):c.hide()},b.prototype.show=function(){var b=a.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){if(this.$element.trigger(b),b.isDefaultPrevented())return;var c=this.tip();this.setContent(),this.options.animation&&c.addClass("fade");var d="function"==typeof this.options.placement?this.options.placement.call(this,c[0],this.$element[0]):this.options.placement,e=/\s?auto?\s?/i,f=e.test(d);f&&(d=d.replace(e,"")||"top"),c.detach().css({top:0,left:0,display:"block"}).addClass(d),this.options.container?c.appendTo(this.options.container):c.insertAfter(this.$element);var g=this.getPosition(),h=c[0].offsetWidth,i=c[0].offsetHeight;if(f){var j=this.$element.parent(),k=d,l=document.documentElement.scrollTop||document.body.scrollTop,m="body"==this.options.container?window.innerWidth:j.outerWidth(),n="body"==this.options.container?window.innerHeight:j.outerHeight(),o="body"==this.options.container?0:j.offset().left;d="bottom"==d&&g.top+g.height+i-l>n?"top":"top"==d&&g.top-l-i<0?"bottom":"right"==d&&g.right+h>m?"left":"left"==d&&g.left-h<o?"right":d,c.removeClass(k).addClass(d)}var p=this.getCalculatedOffset(d,g,h,i);this.applyPlacement(p,d),this.$element.trigger("shown.bs."+this.type)}},b.prototype.applyPlacement=function(a,b){var c,d=this.tip(),e=d[0].offsetWidth,f=d[0].offsetHeight,g=parseInt(d.css("margin-top"),10),h=parseInt(d.css("margin-left"),10);isNaN(g)&&(g=0),isNaN(h)&&(h=0),a.top=a.top+g,a.left=a.left+h,d.offset(a).addClass("in");var i=d[0].offsetWidth,j=d[0].offsetHeight;if("top"==b&&j!=f&&(c=!0,a.top=a.top+f-j),/bottom|top/.test(b)){var k=0;a.left<0&&(k=-2*a.left,a.left=0,d.offset(a),i=d[0].offsetWidth,j=d[0].offsetHeight),this.replaceArrow(k-e+i,i,"left")}else this.replaceArrow(j-f,j,"top");c&&d.offset(a)},b.prototype.replaceArrow=function(a,b,c){this.arrow().css(c,a?50*(1-a/b)+"%":"")},b.prototype.setContent=function(){var a=this.tip(),b=this.getTitle();a.find(".tooltip-inner")[this.options.html?"html":"text"](b),a.removeClass("fade in top bottom left right")},b.prototype.hide=function(){function b(){"in"!=c.hoverState&&d.detach()}var c=this,d=this.tip(),e=a.Event("hide.bs."+this.type);return this.$element.trigger(e),e.isDefaultPrevented()?void 0:(d.removeClass("in"),a.support.transition&&this.$tip.hasClass("fade")?d.one(a.support.transition.end,b).emulateTransitionEnd(150):b(),this.$element.trigger("hidden.bs."+this.type),this)},b.prototype.fixTitle=function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("data-original-title"))&&a.attr("data-original-title",a.attr("title")||"").attr("title","")},b.prototype.hasContent=function(){return this.getTitle()},b.prototype.getPosition=function(){var b=this.$element[0];return a.extend({},"function"==typeof b.getBoundingClientRect?b.getBoundingClientRect():{width:b.offsetWidth,height:b.offsetHeight},this.$element.offset())},b.prototype.getCalculatedOffset=function(a,b,c,d){return"bottom"==a?{top:b.top+b.height,left:b.left+b.width/2-c/2}:"top"==a?{top:b.top-d,left:b.left+b.width/2-c/2}:"left"==a?{top:b.top+b.height/2-d/2,left:b.left-c}:{top:b.top+b.height/2-d/2,left:b.left+b.width}},b.prototype.getTitle=function(){var a,b=this.$element,c=this.options;return a=b.attr("data-original-title")||("function"==typeof c.title?c.title.call(b[0]):c.title)},b.prototype.tip=function(){return this.$tip=this.$tip||a(this.options.template)},b.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},b.prototype.validate=function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},b.prototype.enable=function(){this.enabled=!0},b.prototype.disable=function(){this.enabled=!1},b.prototype.toggleEnabled=function(){this.enabled=!this.enabled},b.prototype.toggle=function(b){var c=b?a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs."+this.type):this;c.tip().hasClass("in")?c.leave(c):c.enter(c)},b.prototype.destroy=function(){this.hide().$element.off("."+this.type).removeData("bs."+this.type)};var c=a.fn.tooltip;a.fn.tooltip=function(c){return this.each(function(){var d=a(this),e=d.data("bs.tooltip"),f="object"==typeof c&&c;e||d.data("bs.tooltip",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.tooltip.Constructor=b,a.fn.tooltip.noConflict=function(){return a.fn.tooltip=c,this}}(window.jQuery),+function(a){"use strict";var b=function(a,b){this.init("popover",a,b)};if(!a.fn.tooltip)throw new Error("Popover requires tooltip.js");b.DEFAULTS=a.extend({},a.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),b.prototype=a.extend({},a.fn.tooltip.Constructor.prototype),b.prototype.constructor=b,b.prototype.getDefaults=function(){return b.DEFAULTS},b.prototype.setContent=function(){var a=this.tip(),b=this.getTitle(),c=this.getContent();a.find(".popover-title")[this.options.html?"html":"text"](b),a.find(".popover-content")[this.options.html?"html":"text"](c),a.removeClass("fade top bottom left right in"),a.find(".popover-title").html()||a.find(".popover-title").hide()},b.prototype.hasContent=function(){return this.getTitle()||this.getContent()},b.prototype.getContent=function(){var a=this.$element,b=this.options;return a.attr("data-content")||("function"==typeof b.content?b.content.call(a[0]):b.content)},b.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")},b.prototype.tip=function(){return this.$tip||(this.$tip=a(this.options.template)),this.$tip};var c=a.fn.popover;a.fn.popover=function(c){return this.each(function(){var d=a(this),e=d.data("bs.popover"),f="object"==typeof c&&c;e||d.data("bs.popover",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.popover.Constructor=b,a.fn.popover.noConflict=function(){return a.fn.popover=c,this}}(window.jQuery),+function(a){"use strict";function b(c,d){var e,f=a.proxy(this.process,this);this.$element=a(c).is("body")?a(window):a(c),this.$body=a("body"),this.$scrollElement=this.$element.on("scroll.bs.scroll-spy.data-api",f),this.options=a.extend({},b.DEFAULTS,d),this.selector=(this.options.target||(e=a(c).attr("href"))&&e.replace(/.*(?=#[^\s]+$)/,"")||"")+" .nav li > a",this.offsets=a([]),this.targets=a([]),this.activeTarget=null,this.refresh(),this.process()}b.DEFAULTS={offset:10},b.prototype.refresh=function(){var b=this.$element[0]==window?"offset":"position";this.offsets=a([]),this.targets=a([]);var c=this;this.$body.find(this.selector).map(function(){var d=a(this),e=d.data("target")||d.attr("href"),f=/^#\w/.test(e)&&a(e);return f&&f.length&&[[f[b]().top+(!a.isWindow(c.$scrollElement.get(0))&&c.$scrollElement.scrollTop()),e]]||null}).sort(function(a,b){return a[0]-b[0]}).each(function(){c.offsets.push(this[0]),c.targets.push(this[1])})},b.prototype.process=function(){var a,b=this.$scrollElement.scrollTop()+this.options.offset,c=this.$scrollElement[0].scrollHeight||this.$body[0].scrollHeight,d=c-this.$scrollElement.height(),e=this.offsets,f=this.targets,g=this.activeTarget;if(b>=d)return g!=(a=f.last()[0])&&this.activate(a);for(a=e.length;a--;)g!=f[a]&&b>=e[a]&&(!e[a+1]||b<=e[a+1])&&this.activate(f[a])},b.prototype.activate=function(b){this.activeTarget=b,a(this.selector).parents(".active").removeClass("active");var c=this.selector+'[data-target="'+b+'"],'+this.selector+'[href="'+b+'"]',d=a(c).parents("li").addClass("active");d.parent(".dropdown-menu").length&&(d=d.closest("li.dropdown").addClass("active")),d.trigger("activate")};var c=a.fn.scrollspy;a.fn.scrollspy=function(c){return this.each(function(){var d=a(this),e=d.data("bs.scrollspy"),f="object"==typeof c&&c;e||d.data("bs.scrollspy",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.scrollspy.Constructor=b,a.fn.scrollspy.noConflict=function(){return a.fn.scrollspy=c,this},a(window).on("load",function(){a('[data-spy="scroll"]').each(function(){var b=a(this);b.scrollspy(b.data())})})}(window.jQuery),+function(a){"use strict";var b=function(b){this.element=a(b)};b.prototype.show=function(){var b=this.element,c=b.closest("ul:not(.dropdown-menu)"),d=b.attr("data-target");if(d||(d=b.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,"")),!b.parent("li").hasClass("active")){var e=c.find(".active:last a")[0],f=a.Event("show.bs.tab",{relatedTarget:e});if(b.trigger(f),!f.isDefaultPrevented()){var g=a(d);this.activate(b.parent("li"),c),this.activate(g,g.parent(),function(){b.trigger({type:"shown.bs.tab",relatedTarget:e})})}}},b.prototype.activate=function(b,c,d){function e(){f.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),b.addClass("active"),g?(b[0].offsetWidth,b.addClass("in")):b.removeClass("fade"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active"),d&&d()}var f=c.find("> .active"),g=d&&a.support.transition&&f.hasClass("fade");g?f.one(a.support.transition.end,e).emulateTransitionEnd(150):e(),f.removeClass("in")};var c=a.fn.tab;a.fn.tab=function(c){return this.each(function(){var d=a(this),e=d.data("bs.tab");e||d.data("bs.tab",e=new b(this)),"string"==typeof c&&e[c]()})},a.fn.tab.Constructor=b,a.fn.tab.noConflict=function(){return a.fn.tab=c,this},a(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(b){b.preventDefault(),a(this).tab("show")})}(window.jQuery),+function(a){"use strict";var b=function(c,d){this.options=a.extend({},b.DEFAULTS,d),this.$window=a(window).on("scroll.bs.affix.data-api",a.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",a.proxy(this.checkPositionWithEventLoop,this)),this.$element=a(c),this.affixed=this.unpin=null,this.checkPosition()};b.RESET="affix affix-top affix-bottom",b.DEFAULTS={offset:0},b.prototype.checkPositionWithEventLoop=function(){setTimeout(a.proxy(this.checkPosition,this),1)},b.prototype.checkPosition=function(){if(this.$element.is(":visible")){var c=a(document).height(),d=this.$window.scrollTop(),e=this.$element.offset(),f=this.options.offset,g=f.top,h=f.bottom;"object"!=typeof f&&(h=g=f),"function"==typeof g&&(g=f.top()),"function"==typeof h&&(h=f.bottom());var i=null!=this.unpin&&d+this.unpin<=e.top?!1:null!=h&&e.top+this.$element.height()>=c-h?"bottom":null!=g&&g>=d?"top":!1;this.affixed!==i&&(this.unpin&&this.$element.css("top",""),this.affixed=i,this.unpin="bottom"==i?e.top-d:null,this.$element.removeClass(b.RESET).addClass("affix"+(i?"-"+i:"")),"bottom"==i&&this.$element.offset({top:document.body.offsetHeight-h-this.$element.height()}))}};var c=a.fn.affix;a.fn.affix=function(c){return this.each(function(){var d=a(this),e=d.data("bs.affix"),f="object"==typeof c&&c;e||d.data("bs.affix",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.affix.Constructor=b,a.fn.affix.noConflict=function(){return a.fn.affix=c,this},a(window).on("load",function(){a('[data-spy="affix"]').each(function(){var b=a(this),c=b.data();c.offset=c.offset||{},c.offsetBottom&&(c.offset.bottom=c.offsetBottom),c.offsetTop&&(c.offset.top=c.offsetTop),b.affix(c)})})}(window.jQuery);
var Endpoints={getWebappBasePath:function(){return webAppPath;},getListFiles:function(){return this.getWebappBasePath()+"/plugin/cfr/api/listFiles";},getStore:function(){return this.getWebappBasePath()+"/plugin/cfr/api/store";}};'use strict';var FileUploaderComponent=BaseComponent.extend({update:function(){var myself=this,$ph=$("#"+this.htmlObject),root=this.rootFolder.charAt(this.rootFolder.length-1)==="/"?this.rootFolder.substring(0,this.rootFolder.length-1):this.rootFolder;var $fileSelect=$('<div>').addClass('fileSelect');$ph.empty();$ph.addClass('uploadRow');$ph.append($fileSelect);var $selectFile=$('<div>').addClass('uploadButton');var $fileObj=$('<div>').addClass('hide').addClass('fileTextRow');var $cancelButtonDiv=$('<div>').addClass('cancelButton');var $uploadDialogContainer=$('<div>').addClass('modal-content');var $uploadDialogParent=$('<div>').addClass('modal fade').append($('<div>').addClass('modal-dialog').append($uploadDialogContainer));var $uploadDialogHeader=$('<div>').addClass('modal-header');var $uploadDialogBody=$('<div>').addClass('modal-body');var $uploadDialogFooter=$('<div>').addClass('modal-footer');$uploadDialogHeader.append($('<button data-dismiss="modal" aria-hidden="true" class="close">&times;</button>'));var $uploadDialogHeaderTitle=$('<h4>Uploading File</h4>');$uploadDialogHeader.append($uploadDialogHeaderTitle);$uploadDialogContainer.append($uploadDialogHeader);var $uploadProgressBarContainer=$('<div>').addClass('progress progress-striped active');var $uploadProgressBar=$('<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>');$uploadProgressBarContainer.append($uploadProgressBar);$uploadDialogBody.append($uploadProgressBarContainer);var $uploadAlerts=$('<div class="hide" ></div>');$uploadDialogBody.append($uploadAlerts);$uploadDialogContainer.append($uploadDialogBody);var $uploadDialogCancelButton=$('<button class="btn btn-warning"></button>');$uploadDialogCancelButton.click(function(e){});var $uploadDialogDismissButton=$('<button type="button" class="btn btn-default" data-dismiss="modal" disabled>OK</button>');$uploadDialogFooter.append($uploadDialogDismissButton);$uploadDialogContainer.append($uploadDialogFooter);$ph.append($uploadDialogParent);$fileSelect.append($selectFile).append($fileObj).append($cancelButtonDiv);var $fileSelectTitle=$('<div>').text('Select File').addClass('select');var $uploadForm=$('<form action="'+Endpoints.getStore()+'" method="post" enctype="multipart/form-data">');var resetUploadForm=function(){$cancelButton.click();};var fileUploadedCallback=function(response){if(response.result){fileUploadProgressCallback(null,0,0,100);$uploadAlerts.attr('class','alert alert-success').text('File successfully uploaded');$uploadDialogDismissButton.enable();fireUploaded();resetUploadForm();}else{fileUploadErrorCallback()}};var fileUploadErrorCallback=function(){$uploadAlerts.attr('class','alert alert-danger').text('Error uploading file');$uploadDialogDismissButton.enable();};var fileUploadProgressCallback=function(event,position,total,percent){$uploadProgressBar.attr('aria-valuenow',percent);$uploadProgressBar.attr('style','width:'+percent+'%;');};var fileUploadBeforeSubmitCallback=function(arr,form,options){fileUploadProgressCallback(null,0,0,0);$uploadAlerts.attr('class','hide').text('');$uploadDialogParent.modal();};var fireUploaded=function(filename){Dashboards.fireChange('uploadedFileParam','');};$uploadForm.ajaxForm({dataType:'json',beforeSubmit:fileUploadBeforeSubmitCallback,success:fileUploadedCallback,error:fileUploadErrorCallback,uploadProgress:fileUploadProgressCallback});$selectFile.append($fileSelectTitle);$selectFile.append($uploadForm);var $label=$('<label>').addClass('cabinet'),$fileInput=$('<input type="file" class="file" name="file"/>'),$pathInput=$('<input type="hidden" name="path" value="'+root+'"/>'),$submitInput=$('<button type="submit">').addClass('submitBtn').addClass('hide').text('Upload File');$fileSelectTitle.click(function(){$fileInput.click();});$uploadForm.append($label).append($pathInput).append($submitInput);$label.append($fileInput);$fileInput.attr("id",this.htmlObject+"_file");$fileInput.change(function(){if($fileInput.val()!==""){$selectFile.addClass('zeroHeight');$label.addClass('hide');$fileSelectTitle.addClass('hide');$fileObj.removeClass('hide');$submitInput.removeClass('hide');$cancelButton.removeClass('hide');var a=$fileInput.val();if(a.slice(3,11)=="fakepath")a=a.slice(12,a.length);$fileObj.html(a);}});var $cancelButton=$('<button>').text('Cancel');$cancelButton.click(function(){$selectFile.removeClass('zeroHeight');$label.removeClass('hide');$fileSelectTitle.removeClass('hide');$fileObj.addClass('hide');$fileObj.html('');$submitInput.addClass('hide');$fileInput.val('');$cancelButton.addClass('hide');});$cancelButtonDiv.append($cancelButton);$cancelButton.addClass('hide');}});
if(jQuery)(function($){$.extend($.fn,{fileTree:function(o,h){if(!o)var o={};if(o.root==undefined)o.root='/';if(o.script==undefined)o.script='jqueryFileTree.php';if(o.folderEvent==undefined)o.folderEvent='click';if(o.expandSpeed==undefined)o.expandSpeed=500;if(o.collapseSpeed==undefined)o.collapseSpeed=500;if(o.expandEasing==undefined)o.expandEasing=null;if(o.collapseEasing==undefined)o.collapseEasing=null;if(o.multiFolder==undefined)o.multiFolder=true;if(o.loadMessage==undefined)o.loadMessage='Loading...';if(o.htmlTreeModifier==undefined)o.htmlTreeModifier=undefined;$(this).each(function(){function showTree(c,t){$(c).addClass('wait');$(".jqueryFileTree.start").remove();$.post(o.script,{dir:t},function(data){$(c).find('.start').html('');$(c).removeClass('wait').append(data);if(o.root==t)$(c).find('UL:hidden').show();else $(c).find('UL:hidden').slideDown({duration:o.expandSpeed,easing:o.expandEasing});if(o.htmlTreeModifier!=undefined)c=o.htmlTreeModifier(c);bindTree(c);});}
function bindTree(t){$(t).find('LI > *').bind(o.folderEvent,function(){if($(this).parent().hasClass('directory')){if($(this).parent().hasClass('collapsed')){if(!o.multiFolder){$(this).parent().parent().find('UL').slideUp({duration:o.collapseSpeed,easing:o.collapseEasing});$(this).parent().parent().find('LI.directory').removeClass('expanded').addClass('collapsed');}
$(this).parent().find('UL').remove();showTree($(this).parent(),escape($(this).attr('rel').match(/.*\//)));$(this).parent().removeClass('collapsed').addClass('expanded');}else{$(this).parent().find('UL').slideUp({duration:o.collapseSpeed,easing:o.collapseEasing});$(this).parent().removeClass('expanded').addClass('collapsed');}}else{h($(this).attr('rel'));}
return false;});if(o.folderEvent.toLowerCase!='click')$(t).find('LI A').bind('click',function(){return false;});}
$(this).html('<ul class="jqueryFileTree start"><li class="wait">'+o.loadMessage+'<li></ul>');showTree($(this),escape(o.root));});}});})(jQuery);
var FileBrowserComponent=BaseComponent.extend({CfrDataUrl:Endpoints.getListFiles(),update:function(){var myself=this,$ph=$("#"+this.htmlObject),root=this.rootFolder.charAt(this.rootFolder.length-1)=="/"?this.rootFolder:this.rootFolder+"/",$content;if(!this.fileExtensions)
this.fileExtensions="";$ph.addClass('fileBrowser');if(this.chartDefinition.height!=undefined){$ph.css('height',this.chartDefinition.height+'px');}
if(this.chartDefinition.width!=undefined){$ph.css('width',this.chartDefinition.width+'px');}
$ph.css('overflow','auto');$ph.fileTree({root:root,script:myself.buildTreeURL(),expandSpeed:1,collapseSpeed:1,multiFolder:true,htmlTreeModifier:function(content){return myself.modifyTree(content);}},function(){});},getValue:function(){},buildTreeURL:function(){return this.CfrDataUrl+"?"+"fileExtensions="+this.fileExtensions;},buildGetURL:function(rel){return this.CfrDataUrl.replace('listFiles','getFile')+"?fileName="+rel;},modifyTree:function(content){var myself=this;var $content=content;if(!$content.hasClass('directory'))
$content.find('ul').addClass("treeview filetree");$content.find('li:last').addClass("last");$.each($content.find('li.directory'),function(){var rel=$(this).find('a').attr('rel');$("<div/>").addClass("hitarea expandable-hitarea").attr('rel',rel).prependTo($(this));});$.each($content.find('li.directory a'),function(){$(this).addClass('folder');});$.each($content.find('li.file'),function(){$("<div/>").addClass("file").prependTo($(this));});$.each($content.find('li.file a'),function(){var rel=$(this).attr('rel');$(this).click(function(){window.open(myself.buildGetURL(rel),'_blank');});});return $content;},downloadDataURI:function(options){if(!options){return;}
$.isPlainObject(options)||(options={data:options});if(!$.browser.webkit){location.href=options.data;}
options.filename||(options.filename="download."+options.data.split(",")[0].split(";")[0].substring(5).split("/")[1]);$('<form method="post" action="'+options.url+'" style="display:none"><input type="hidden" name="filename" value="'+options.filename+'"/><input type="hidden" name="data" value="'+options.data+'"/></form>').submit().remove();}});
var HelpMixin=Base.extend({_docstring:function(){return"Mixin that provides documentation for the developer";},help:function(fun){var h0=h='';switch(typeof fun){case"string":if(fun){h0=(this.name+'.'+fun+': ');fun=this[fun];}else{return this.help();}
break;case"function":h0=fun.name?(this.name+'.'+fun.name+': '):'';break;default:h0=(this.name+': '+this._docstring()+'\n')||"";fun=this._docstring;}
var sf=new String(fun);var matches=(sf.slice(0).split('/**',2)[1]||"").split('*/',1)[0];if(matches){h=_.map(matches.split('\n'),function(s){return s.trim();}).join('\n').trim();}
h=(h.length>0)?h:"No help available";return Dashboards.log(h0+h);if(!(fun instanceof Function)){if(fun.help){return Dashboards.log(fun.help);}
return Dashboards.log("I can not help you with that topic.");}
return Dashboards.log("I can not help you with that function.");}});var ActionComponent=ActionComponent||UnmanagedComponent.extend(new HelpMixin()).extend({_docstring:function(){return"Abstract class for components triggering a query on demand";},update:function(){var render=_.bind(this.render,this);if(typeof this.manageCallee=="undefined"||this.manageCallee){this.synchronous(render);}else{render();}},render:function(){},triggerAction:function(){var ad=this.actionDefinition,params=Dashboards.propertiesArrayToObject(this.actionParameters);var failureCallback=(this.failureCallback)?(this.failureCallback):function(){},successCallback=this.successCallback?(this.successCallback):function(){};return Dashboards.getQuery(ad).fetchData(params,_.bind(successCallback,this),_.bind(failureCallback,this));if(Dashboards.debug){Dashboards.log('ActionComponent.triggerAction('+ad.pluginId+', '+ad.endpoint+') was called','debug');}},hasAction:function(){if(!this.actionDefinition){return false;}
if(Dashboards.detectQueryType){return!!Dashboards.detectQueryType(this.actionDefinition);}else{return!!this.actionDefinition.queryType&&Dashboards.hasQuery(this.actionDefinition.queryType);}}});
var MixinButtonAPI=Base.extend({initButtonAPI:function(bool){bool=(bool==undefined)?true:bool;this._isJquery=bool;},disable:function(){if(this._isJquery){$('#'+this.htmlObject+' button').attr('disabled','disabled');}},enable:function(){if(this._isJquery){$('#'+this.htmlObject+' button').removeAttr('disabled');}},setLabel:function(label){if(this._isJquery){$('#'+this.htmlObject+' button').text(label.toString());}}});var ActionButtonComponent=ActionComponent.extend(new MixinButtonAPI()).extend({_docstring:function(){return"Button Component that triggers a server action when clicked";},render:function(){var myself=this,ad=this.actionDefinition;var b=$("<button type='button'/>").text(this.label).unbind("click").bind("click",function(){if(_.isFunction(myself.expression)){myself.expression.apply(myself,arguments);}
if(myself.hasAction()){return myself.triggerAction.apply(myself);}});if(typeof this.buttonStyle==="undefined"||this.buttonStyle==="themeroller"){b.button();this.initButtonAPI(true);}else{this.initButtonAPI(false);}
b.appendTo($("#"+this.htmlObject).empty());}});
var SaikuRendererOptions={mode:null,dataMode:null,htmlObject:null,width:null,height:null};var SaikuRenderer=function(data,options){this._options=_.extend(SaikuRendererOptions,options);this._hasProcessed=false;if(typeof Backbone!=="undefined"){_.extend(this,Backbone.Events);}
if(data){this._data=data;this.processData(data,options);this._hasProcessed=true;}};SaikuRenderer.prototype.render=function(data,options){var r=null;if(typeof Backbone!=="undefined"){this.trigger('render:start',this);}
if(!this.hasProcessedData()){this.processData(data,options);}
r=this._render(data,options);if(typeof Backbone!=="undefined"){this.trigger('render:end',this);}
return r;};SaikuRenderer.prototype.processData=function(data,options){if(typeof Backbone!=="undefined"){this.trigger('processData:start',this);}
this._processData(data,options);if(typeof Backbone!=="undefined"){this.trigger('processData:end',this);}};SaikuRenderer.prototype.hasProcessedData=function(){return this._hasProcessed;};SaikuRenderer.prototype._render=function(data,options){};SaikuRenderer.prototype._processData=function(data,options){};
var SaikuTableRenderer=_.extend(SaikuRenderer,{key:"table"});SaikuTableRenderer.prototype._render=function(data,options){var self=this;if(data){this._data=data;}
if(options){this._options=_.extend({},SaikuRendererOptions,options);}
if(typeof this._data=="undefined"){return;}
if(this._data!=null&&this._data.error!=null){return;}
if(this._data==null||(this._data.cellset&&this._data.cellset.length===0)){return;}
if(this._options.htmlObject){if(self._options.hasOwnProperty('batch')){$(self._options.htmlObject).parent().parent().unbind('scroll');}
_.defer(function(that){if(self._options.hasOwnProperty('batch')&&!self._options.hasOwnProperty('batchSize')){self._options['batchSize']=1000;}
var html=self.internalRender(self._data,self._options);$(self._options.htmlObject).html(html);_.defer(function(that){if(self._options.hasOwnProperty('batch')&&self._options.hasBatchResult){var batchRow=0;var batchIsRunning=false;var batchIntervalSize=self._options.hasOwnProperty('batchIntervalSize')?self._options.batchIntervalSize:20;var batchIntervalTime=self._options.hasOwnProperty('batchIntervalTime')?self._options.batchIntervalTime:20;var len=self._options.batchResult.length;var batchInsert=function(){if(!batchIsRunning&&len>0&&batchRow<len){batchIsRunning=true;var batchContent="";var startb=batchRow;for(var i=0;batchRow<len&&i<batchIntervalSize;i++,batchRow++){batchContent+=self._options.batchResult[batchRow];}
if(batchRow>startb){$(self._options.htmlObject).append($(batchContent));}
batchIsRunning=false;}
if(batchRow>=len){$(self._options.htmlObject).parent().parent().unbind('scroll');}};var lazyBatchInsert=_.debounce(batchInsert,batchIntervalTime);$(self._options.htmlObject).parent().parent().scroll(function(){lazyBatchInsert();});}});return html;});}else{var html=this.internalRender(this._data,self._options);return html;}};SaikuTableRenderer.prototype.clear=function(data,options){var self=this;if(this._options.htmlObject&&this._options.hasOwnProperty('batch')){$(self._options.htmlObject).parent().parent().unbind('scroll');}};SaikuTableRenderer.prototype._processData=function(data,options){this._hasProcessed=true;};function genTotalDataCells(currentIndex,cellIndex,scanSums,scanIndexes,lists){var contents='';var lists=lists[ROWS];for(var i=scanSums.length-1;i>=0;i--){if(currentIndex==scanSums[i]){var currentListNode=lists[i][scanIndexes[i]];for(var m=0;m<currentListNode.cells.length;m++)
contents+='<td class="data total">'+currentListNode.cells[m][cellIndex].value+'</td>';scanIndexes[i]++;if(scanIndexes[i]<lists[i].length)
scanSums[i]+=lists[i][scanIndexes[i]].width;}}
return contents;}
function genTotalHeaderCells(currentIndex,bottom,scanSums,scanIndexes,lists,wrapContent){var contents='';for(var i=bottom;i>=0;i--){if(currentIndex==scanSums[i]){var currentListNode=lists[i][scanIndexes[i]];var cssClass;if(i==0&&bottom==1)
cssClass="col";else if(i==bottom)
cssClass="col_total_corner";else if(i==bottom-1&&currentListNode.captions)
cssClass="col_total_first";else cssClass="col_null";for(var m=0;m<currentListNode.cells.length;m++){var text='&nbsp;';if(bottom==lists.length-1){if(currentListNode.captions){text=lists[i][scanIndexes[i]].captions[m];}
if(i==0&&scanIndexes[i]==0){if(currentListNode.captions)
text+="&nbsp;";else text="";text+=(wrapContent?"<span class='i18n'>Grand Total</span>":"Grand Total");}}
contents+='<th class="'+cssClass+'">'
+(wrapContent?'<div>'+text+'</div>':text)+'</th>';}
scanIndexes[i]++;if(scanIndexes[i]<lists[i].length)
scanSums[i]+=lists[i][scanIndexes[i]].width;}}
return contents;}
function totalIntersectionCells(currentIndex,bottom,scanSums,scanIndexes,lists){var contents='';for(var i=bottom;i>=0;i--){if(currentIndex==scanSums[i]){var currentListNode=lists[i][scanIndexes[i]];var cssClass="data total";for(var m=0;m<currentListNode.cells.length;m++){var text='&nbsp;';contents+='<td class="'+cssClass+'">'+text+'</td>';}
scanIndexes[i]++;if(scanIndexes[i]<lists[i].length)
scanSums[i]+=lists[i][scanIndexes[i]].width;}}
return contents;}
function genTotalHeaderRowCells(currentIndex,scanSums,scanIndexes,totalsLists,wrapContent){var colLists=totalsLists[COLUMNS];var colScanSums=scanSums[COLUMNS];var colScanIndexes=scanIndexes[COLUMNS];var bottom=colLists.length-2;var contents='';for(var i=bottom;i>=0;i--){if(currentIndex==colScanSums[i]){for(var m=0;m<colLists[i][colScanIndexes[i]].cells.length;m++){contents+='<tr>';for(var j=0;j<=bottom;j++){var cssClass;var text='&nbsp;';if(i==0&&j==0)
cssClass='row';else if(i==j+1)
cssClass='row_total_corner';else if(i==j&&colLists[i][colScanIndexes[i]].captions){cssClass='row_total_first';}else if(i<j+1)
cssClass='row_total';else
cssClass='row_null';if(j==bottom){if(colLists[i][colScanIndexes[i]].captions){text=colLists[i][colScanIndexes[i]].captions[m];}
if(i==0&&colScanIndexes[i]==0){if(colLists[i][colScanIndexes[i]].captions)
text+="&nbsp;";else text="";text+=(wrapContent?"<span class='i18n'>Grand Total</span>":"Grand Total");}}
contents+='<th class="'+cssClass+'">'
+(wrapContent?'<div>'+text+'</div>':text)+'</th>';}
var scanIndexes={};var scanSums={};for(var z=0;z<totalsLists[ROWS].length;z++){scanIndexes[z]=0;scanSums[z]=totalsLists[ROWS][z][scanIndexes[z]].width;}
for(var k=0;k<colLists[i][colScanIndexes[i]].cells[m].length;k++){contents+='<td class="data total">'+colLists[i][colScanIndexes[i]].cells[m][k].value+'</td>';contents+=totalIntersectionCells(k+1,totalsLists[ROWS].length-1,scanSums,scanIndexes,totalsLists[ROWS]);}
contents+='</tr>';}
colScanIndexes[i]++;if(colScanIndexes[i]<colLists[i].length)
colScanSums[i]+=colLists[i][colScanIndexes[i]].width;}}
return contents;}
var ROWS="ROWS";var COLUMNS="COLUMNS";function nextParentsDiffer(data,row,col){while(row-->0){if(data[row][col].properties.uniquename!=data[row][col+1].properties.uniquename)
return true;}
return false;}
function topParentsDiffer(data,row,col){while(col-->0)
if(data[row][col].properties.uniquename!=data[row-1][col].properties.uniquename)
return true;return false;}
SaikuTableRenderer.prototype.internalRender=function(allData,options){var tableContent="";var rowContent="";var data=allData.cellset;var table=data?data:[];var colSpan;var colValue;var isHeaderLowestLvl;var isBody=false;var firstColumn;var isLastColumn,isLastRow;var nextHeader;var processedRowHeader=false;var lowestRowLvl=0;var rowGroups=[];var batchSize=null;var batchStarted=false;var isColHeader=false,isColHeaderDone=false;var resultRows=[];var wrapContent=true;if(options){batchSize=options.hasOwnProperty('batchSize')?options.batchSize:null;wrapContent=options.hasOwnProperty('wrapContent')?options.wrapContent:true;}
var totalsLists={};totalsLists[COLUMNS]=allData.rowTotalsLists;totalsLists[ROWS]=allData.colTotalsLists;var scanSums={};var scanIndexes={};var dirs=[ROWS,COLUMNS];for(var i=0;i<dirs.length;i++){scanSums[dirs[i]]=new Array();scanIndexes[dirs[i]]=new Array();}
if(totalsLists[COLUMNS])
for(var i=0;i<totalsLists[COLUMNS].length;i++){scanIndexes[COLUMNS][i]=0;scanSums[COLUMNS][i]=totalsLists[COLUMNS][i][scanIndexes[COLUMNS][i]].width;}
for(var row=0,rowLen=table.length;row<rowLen;row++){var rowShifted=row-allData.topOffset;colSpan=1;colValue="";isHeaderLowestLvl=false;isLastColumn=false;isLastRow=false;isColHeader=false;var headerSame=false;if(totalsLists[ROWS])
for(var i=0;i<totalsLists[ROWS].length;i++){scanIndexes[ROWS][i]=0;scanSums[ROWS][i]=totalsLists[ROWS][i][scanIndexes[ROWS][i]].width;}
rowContent="<tr>";if(row===0){rowContent="<thead>"+rowContent;}
for(var col=0,colLen=table[row].length;col<colLen;col++){var colShifted=col-allData.leftOffset;var header=data[row][col];if(header.type==="COLUMN_HEADER"){isColHeader=true;}
if(header.type==="COLUMN_HEADER"&&header.value==="null"&&(firstColumn==null||col<firstColumn)){rowContent+='<th class="all_null">&nbsp;</th>';}
else if(header.type==="COLUMN_HEADER"){if(firstColumn==null){firstColumn=col;}
if(table[row].length==col+1)
isLastColumn=true;else
nextHeader=data[row][col+1];if(isLastColumn){if(header.value=="null"){rowContent+='<th class="col_null">&nbsp;</th>';}else{if(totalsLists[ROWS])
colSpan=totalsLists[ROWS][row+1][scanIndexes[ROWS][row+1]].span;rowContent+='<th class="col" style="text-align: center;" colspan="'+colSpan+'" title="'+header.value+'">'
+(wrapContent?'<div rel="'+row+":"+col+'">'+header.value+'</div>':header.value)
+'</th>';}}else{var groupChange=(col>1&&row>1&&!isHeaderLowestLvl&&col>firstColumn)?data[row-1][col+1].value!=data[row-1][col].value||data[row-1][col+1].properties.uniquename!=data[row-1][col].properties.uniquename:false;var maxColspan=colSpan>999?true:false;if(header.value!=nextHeader.value||nextParentsDiffer(data,row,col)||isHeaderLowestLvl||groupChange||maxColspan){if(header.value=="null"){rowContent+='<th class="col_null" colspan="'+colSpan+'">&nbsp;</th>';}else{if(totalsLists[ROWS])
colSpan=totalsLists[ROWS][row+1][scanIndexes[ROWS][row+1]].span;rowContent+='<th class="col" style="text-align: center;" colspan="'+(colSpan==0?1:colSpan)+'" title="'+header.value+'">'
+(wrapContent?'<div rel="'+row+":"+col+'">'+header.value+'</div>':header.value)
+'</th>';}
colSpan=1;}else{colSpan++;}}
if(totalsLists[ROWS])
rowContent+=genTotalHeaderCells(col-allData.leftOffset+1,row+1,scanSums[ROWS],scanIndexes[ROWS],totalsLists[ROWS],wrapContent);}
else if(header.type==="ROW_HEADER"&&header.value==="null"){rowContent+='<th class="row_null">&nbsp;</th>';}
else if(header.type==="ROW_HEADER"){if(lowestRowLvl==col)
isHeaderLowestLvl=true;else
nextHeader=data[row][col+1];var previousRow=data[row-1];var same=!headerSame&&!isHeaderLowestLvl&&(col==0||!topParentsDiffer(data,row,col))&&header.value===previousRow[col].value;headerSame=!same;var value=(same?"<div>&nbsp;</div>":'<div rel="'+row+":"+col+'">'+header.value+'</div>');if(!wrapContent){value=(same?"&nbsp;":header.value);}
var tipsy="";var cssclass=(same?"row_null":"row");var colspan=0;if(!isHeaderLowestLvl&&(typeof nextHeader=="undefined"||nextHeader.value==="null")){colspan=1;var group=header.properties.dimension;var level=header.properties.level;var groupWidth=(group in rowGroups?rowGroups[group].length-rowGroups[group].indexOf(level):1);for(var k=col+1;colspan<groupWidth&&k<=(lowestRowLvl+1)&&data[row][k]!=="null";k++){colspan=k-col;}
col=col+colspan-1;}
rowContent+='<th class="'+cssclass+'" '+(colspan>0?' colspan="'+colspan+'"':"")+tipsy+'>'+value+'</th>';}
else if(header.type==="ROW_HEADER_HEADER"){rowContent+='<th class="row_header">'+(wrapContent?'<div>'+header.value+'</div>':header.value)+'</th>';isHeaderLowestLvl=true;processedRowHeader=true;lowestRowLvl=col;if(header.properties.hasOwnProperty("dimension")){var group=header.properties.dimension;if(!(group in rowGroups)){rowGroups[group]=[];}
rowGroups[group].push(header.properties.level);}}
else if(header.type==="DATA_CELL"){batchStarted=true;var color="";var val=header.value;var arrow="";if(header.properties.hasOwnProperty('image')){var img_height=header.properties.hasOwnProperty('image_height')?" height='"+header.properties.image_height+"'":"";var img_width=header.properties.hasOwnProperty('image_width')?" width='"+header.properties.image_width+"'":"";val="<img "+img_height+" "+img_width+" style='padding-left: 5px' src='"+header.properties.image+"' border='0'>";}
if(header.properties.hasOwnProperty('style')){color=" style='background-color: "+header.properties.style+"' ";}
if(header.properties.hasOwnProperty('link')){val="<a target='__blank' href='"+header.properties.link+"'>"+val+"</a>";}
if(header.properties.hasOwnProperty('arrow')){arrow="<img height='10' width='10' style='padding-left: 5px' src='./images/arrow-"+header.properties.arrow+".gif' border='0'>";}
rowContent+='<td class="data" '+color+'>'
+(wrapContent?'<div class="datadiv" alt="'+header.properties.raw+'" rel="'+header.properties.position+'">':"")
+val+arrow
+(wrapContent?'</div>':'')+'</td>';if(totalsLists[ROWS])
rowContent+=genTotalDataCells(colShifted+1,rowShifted,scanSums[ROWS],scanIndexes[ROWS],totalsLists,wrapContent);}}
rowContent+="</tr>";var totals="";if(totalsLists[COLUMNS]&&rowShifted>=0){totals+=genTotalHeaderRowCells(rowShifted+1,scanSums,scanIndexes,totalsLists,wrapContent);}
if(batchStarted&&batchSize){if(row<=batchSize){if(!isColHeader&&!isColHeaderDone){tableContent+="</thead><tbody>";isColHeaderDone=true;}
tableContent+=rowContent;if(totals.length>0){tableContent+=totals;}}else{resultRows.push(rowContent);if(totals.length>0){resultRows.push(totals);}}}else{if(!isColHeader&&!isColHeaderDone){tableContent+="</thead><tbody>";isColHeaderDone=true;}
tableContent+=rowContent;if(totals.length>0){tableContent+=totals;}}}
if(options){options['batchResult']=resultRows;options['hasBatchResult']=resultRows.length>0;}
return"<table>"+tableContent+"</tbody></table>";}
var SaikuChartRenderer=function(data,options){this.rawdata=data;this.cccOptions={};this.data=null,this.hasProcessed=false;this.hasRendered=false;if(!options&&!options.hasOwnProperty('htmlObject')){throw("You need to supply a html object in the options for the SaikuChartRenderer!");}
this.el=$(options.htmlObject);this.id=_.uniqueId("chart_");$(this.el).html('<div class="canvas_wrapper" style="display:none;"><div id="canvas_'+this.id+'"></div></div>');this.zoom=options.zoom;if(options.zoom){var self=this;var btns="<span style='float:left;' class='zoombuttons'><a href='#' class='button rerender' title='Re-render chart'></a><a href='#' class='button zoomout' style='display:none;' title='Zoom back out'></a></span>";$(btns).prependTo($(this.el).find('.canvas_wrapper'));$(this.el).find('.zoomout').on('click',function(event){event.preventDefault();self.zoomout();});$(this.el).find('.zoomin').on('click',function(event){event.preventDefault();self.zoomin();});$(this.el).find('.rerender').on('click',function(event){event.preventDefault();$(self.el).find('.zoomout').hide();self.switch_chart(self.type);});}
if(options.chartDefinition){this.chartDefinition=options.chartDefinition;}
this.cccOptions.canvas='canvas_'+this.id;this.data=null;this.adjustSizeTo=null;if(options.adjustSizeTo){this.adjustSizeTo=options.adjustSizeTo;}else{this.adjustSizeTo=options.htmlObject;}
if(this.rawdata){if(this.type=="sunburst"){this.process_data_tree({data:this.rawdata});}else{this.process_data_tree({data:this.rawdata},true,true);}}
if(options.mode){this.switch_chart(options.mode);}else{this.switch_chart("stackedBar");}
this.adjust();};SaikuChartRenderer.prototype.adjust=function(){var self=this;var calculateLayout=function(){if(self.hasRendered&&$(self.el).is(':visible')){self.switch_chart(self.type);}}
var lazyLayout=_.debounce(calculateLayout,300);$(window).resize(function(){$(self.el).find('.canvas_wrapper').fadeOut(150);lazyLayout();});};SaikuChartRenderer.prototype.zoomin=function(){$(this.el).find('.canvas_wrapper').hide();var chart=this.chart.root;var data=chart.data;data.datums(null,{selected:false}).each(function(datum){datum.setVisible(false);});data.clearSelected();chart.render(true,true,false);this.render_chart_element();},SaikuChartRenderer.prototype.zoomout=function(){var chart=this.chart.root;var data=chart.data;var kData=chart.keptVisibleDatumSet;if(kData==null||kData.length==0){$(this.el).find('.zoomout').hide();}
else if(kData.length==1){$(this.el).find('.zoomout').hide();chart.keptVisibleDatumSet=[];pvc.data.Data.setVisible(data.datums(null,{visible:false}),true);}else if(kData.length>1){chart.keptVisibleDatumSet.splice(kData.length-1,1);var nonVisible=data.datums(null,{visible:false}).array();var back=chart.keptVisibleDatumSet[kData.length-1];_.intersection(back,nonVisible).forEach(function(datum){datum.setVisible(true);});}
chart.render(true,true,false);};SaikuChartRenderer.prototype.render=function(){_.delay(this.render_chart_element,0,this);};SaikuChartRenderer.prototype.switch_chart=function(key){var keyOptions={"stackedBar":{type:"BarChart",stacked:true},"bar":{type:"BarChart"},"multiplebar":{type:"BarChart",multiChartIndexes:[1],dataMeasuresInColumns:true,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150},"line":{type:"LineChart"},"pie":{type:"PieChart",multiChartIndexes:[0]},"heatgrid":{type:"HeatGridChart"},"stackedBar100":{type:"NormalizedBarChart"},"area":{type:"StackedAreaChart"},"dot":{type:"DotChart"},"waterfall":{type:"WaterfallChart"},"treemap":{type:"TreemapChart"},"sunburst":{type:"SunburstChart"}};if(key=="suanburst"){$(this.el).find('.zoombuttons a').hide();this.type=key;this.sunburst();if(this.hasProcessed){this.render();}}else if(keyOptions.hasOwnProperty(key)){$(this.el).find('.zoombuttons a').hide();this.type=key;var o=keyOptions[key];this.cccOptions=this.getQuickOptions(o);this.define_chart();if(this.hasProcessed){this.render();}}else{alert("Do not support chart type: '"+key+"'");}};SaikuChartRenderer.prototype.sunburst=function(){this.type="sunburst";var data=this.process_data_tree({data:this.rawdata});var options=this.getQuickOptions({});function title(d){return d.parentNode?(title(d.parentNode)+"."+d.nodeName):d.nodeName;}
var re="",nodes=pv.dom(data).nodes();var tipOptions={delayIn:200,delayOut:80,offset:2,html:true,gravity:"nw",fade:false,followMouse:true,corners:true,arrow:false,opacity:1};var color=pv.colors(options.colors).by(function(d){return d.parentNode&&d.parentNode.nodeName;});var vis=new pv.Panel().width(options.width).height(options.height).canvas(options.canvas);var partition=vis.add(pv.Layout.Partition.Fill).nodes(nodes).size(function(d){return d.nodeValue;}).order("descending").orient("radial");partition.node.add(pv.Wedge).fillStyle(pv.colors(options.colors).by(function(d){return d.parentNode&&d.parentNode.nodeName})).visible(function(d){return d.depth>0;}).strokeStyle("#000").lineWidth(0.5).text(function(d){var v="";if(typeof d.nodeValue!="undefined"){v=" : "+d.nodeValue;}
return(d.nodeName+v);}).cursor('pointer').events("all").event('mousemove',pv.Behavior.tipsy(tipOptions));partition.label.add(pv.Label).visible(function(d){return d.angle*d.outerRadius>=6;});this.chart=vis;};SaikuChartRenderer.prototype.cccOptionsDefault={Base:{animate:false,selectable:true,valuesVisible:false,legend:true,legendPosition:"top",legendAlign:"right",compatVersion:2,legendSizeMax:"30%",axisSizeMax:"40%",plotFrameVisible:false,orthoAxisMinorTicks:false,colors:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},HeatGridChart:{orientation:"horizontal",useShapes:true,shape:"circle",nullShape:"cross",colorNormByCategory:false,sizeRole:"value",legendPosition:"right",legend:true,hoverable:true,axisComposite:true,colors:["red","yellow","lightgreen","darkgreen"],yAxisSize:"20%"},WaterfallChart:{orientation:"horizontal"},PieChart:{multiChartColumnsMax:3,multiChartMax:30,smallTitleFont:"bold 14px sans-serif",valuesVisible:true,valuesMask:"{value.percent}",explodedSliceRadius:"10%",extensionPoints:{slice_innerRadiusEx:'40%',slice_offsetRadius:function(scene){return scene.isSelected()?'10%':0;}},clickable:true},LineChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},StackedAreaChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},TreemapChart:{legendPosition:"right",multiChartIndexes:0,extensionPoints:{leaf_lineWidth:2},layoutMode:"slice-and-dice",valuesVisible:true},SunburstChart:{valuesVisible:false,hoverable:false,selectable:true,clickable:false,multiChartIndexes:[0],multiChartMax:30}};SaikuChartRenderer.prototype.getQuickOptions=function(baseOptions){var chartType=(baseOptions&&baseOptions.type)||"BarChart";var options=_.extend({type:chartType,canvas:'canvas_'+this.id},this.cccOptionsDefault.Base,this.cccOptionsDefault[chartType],baseOptions);if(this.adjustSizeTo){var al=$(this.adjustSizeTo);if(al&&al.length>0){var runtimeWidth=al.width()-40;var runtimeHeight=al.height()-40;if(runtimeWidth>0){options.width=runtimeWidth;}
if(runtimeHeight>0){options.height=runtimeHeight;}}}
if(this.data!=null&&this.data.resultset.length>5){if(options.type==="HeatGridChart"){}else if(options.orientation!=="horizontal"){options.extensionPoints=_.extend(Object.create(options.extensionPoints||{}),{xAxisLabel_textAngle:-Math.PI/2,xAxisLabel_textAlign:"right",xAxisLabel_textBaseline:"middle"});}}
return options;};SaikuChartRenderer.prototype.define_chart=function(displayOptions){if(!this.hasProcessed){this.process_data_tree({data:this.rawdata},true,true);}
var self=this;var workspaceResults=(this.adjustSizeTo?$(this.adjustSizeTo):$(this.el));var isSmall=(this.data!=null&&this.data.height<80&&this.data.width<80);var isMedium=(this.data!=null&&this.data.height<300&&this.data.width<300);var isBig=(!isSmall&&!isMedium);var animate=false;var hoverable=isSmall;var runtimeWidth=workspaceResults.width()-40;var runtimeHeight=workspaceResults.height()-40;var runtimeChartDefinition=_.clone(this.cccOptions);if(displayOptions&&displayOptions.width){runtimeWidth=displayOptions.width;}
if(displayOptions&&displayOptions.height){runtimeHeight=displayOptions.height;}
if(runtimeWidth>0){runtimeChartDefinition.width=runtimeWidth;}
if(runtimeHeight>0){runtimeChartDefinition.height=runtimeHeight;}
if(isBig){if(runtimeChartDefinition.hasOwnProperty('extensionPoints')&&runtimeChartDefinition.extensionPoints.hasOwnProperty('line_interpolate'))
delete runtimeChartDefinition.extensionPoints.line_interpolate;if(runtimeChartDefinition.hasOwnProperty('extensionPoints')&&runtimeChartDefinition.extensionPoints.hasOwnProperty('area_interpolate'))
delete runtimeChartDefinition.extensionPoints.area_interpolate;}
var zoomDefinition={legend:{scenes:{item:{execute:function(){var chart=this.chart();if(!chart.hasOwnProperty('keptVisibleDatumSet')){chart.keptVisibleDatumSet=[];}
var keptSet=chart.keptVisibleDatumSet.length>0?chart.keptVisibleDatumSet[chart.keptVisibleDatumSet.length-1]:[];var zoomedIn=keptSet.length>0;if(zoomedIn){_.intersection(this.datums().array(),keptSet).forEach(function(datum){datum.toggleVisible();});}else{pvc.data.Data.toggleVisible(this.datums());}
this.chart().render(true,true,false);}}}},userSelectionAction:function(selectingDatums){if(selectingDatums.length==0){return[];}
var chart=self.chart.root;var data=chart.data;var selfChart=this.chart;if(!selfChart.hasOwnProperty('keptVisibleDatumSet')){selfChart.keptVisibleDatumSet=[];}
if(data.datums().count()>1500){pvc.data.Data.setSelected(selectingDatums,true);}else if(data.datums(null,{visible:true}).count()==data.datums().count()){$(self.el).find('.zoomout, .rerender').show();var all=data.datums().array();_.each(_.difference(all,selectingDatums),function(datum){datum.setVisible(false);});selfChart.keptVisibleDatumSet=[];selfChart.keptVisibleDatumSet.push(selectingDatums);}else{var kept=selfChart.keptVisibleDatumSet.length>0?selfChart.keptVisibleDatumSet[selfChart.keptVisibleDatumSet.length-1]:[];var visibleOnes=data.datums(null,{visible:true}).array();var baseSet=kept;if(visibleOnes.length<kept.length){baseSet=visibleOnes;selfChart.keptVisibleDatumSet.push(visibleOnes);}
var newSelection=[];_.each(_.difference(visibleOnes,selectingDatums),function(datum){datum.setVisible(false);});_.each(_.intersection(visibleOnes,selectingDatums),function(datum){newSelection.push(datum);});if(newSelection.length>0){selfChart.keptVisibleDatumSet.push(newSelection);}}
chart.render(true,true,false);return[];}};runtimeChartDefinition=_.extend(runtimeChartDefinition,{hoverable:hoverable,animate:animate},this.chartDefinition);if(self.zoom){runtimeChartDefinition=_.extend(runtimeChartDefinition,zoomDefinition);}
if(runtimeChartDefinition.type=="TreemapChart"){runtimeChartDefinition.legend.scenes.item.labelText=function(){var indent="";var group=this.group;if(group){var depth=group.depth;switch(depth){case 0:return"";case 1:break;case 2:indent=" └ ";break;default:indent=new Array(2*(depth-2)+1).join(" ")+" └ ";}}
return indent+this.base();};}
this.chart=new pvc[runtimeChartDefinition.type](runtimeChartDefinition);this.chart.setData(this.data,{crosstabMode:true,seriesInRows:false});};SaikuChartRenderer.prototype.render_chart_element=function(context){var self=context||this;var isSmall=(self.data!=null&&self.data.height<80&&self.data.width<80);var isMedium=(self.data!=null&&self.data.height<300&&self.data.width<300);var isBig=(!isSmall&&!isMedium);var animate=false;if(self.chart.options&&self.chart.options.animate){animate=true;}
if(!animate||$(self.el).find('.canvas_wrapper').is(':visible')){$(self.el).find('.canvas_wrapper').hide();}
try{if(animate){$(self.el).find('.canvas_wrapper').show();}
self.chart.render();self.hasRendered=true;}catch(e){$('#'+'canvas_'+self.id).text("Could not render chart"+e);}
if(self.chart.options&&self.chart.options.animate){return false;}
if(isIE||isBig){$(self.el).find('.canvas_wrapper').show();}else{$(self.el).find('.canvas_wrapper').fadeIn(400);}
return false;};SaikuChartRenderer.prototype.process_data_tree=function(args,flat,setdata){var self=this;var data={};if(flat){data.resultset=[];data.metadata=[];data.height=0;data.width=0;}
var currentDataPos=data;if(typeof args=="undefined"||typeof args.data=="undefined"){return;}
if(args.data!=null&&args.data.error!=null){return;}
if(args.data==null||(args.data.cellset&&args.data.cellset.length===0)){return;}
var cellset=args.data.cellset;if(cellset&&cellset.length>0){var lowest_level=0;var data_start=0;var hasStart=false;for(var row=0,rowLen=cellset.length;data_start==0&&row<rowLen;row++){for(var field=0,fieldLen=cellset[row].length;field<fieldLen;field++){if(!hasStart){while(cellset[row][field].type=="COLUMN_HEADER"&&cellset[row][field].value=="null"){row++;}}
hasStart=true;if(cellset[row][field].type=="ROW_HEADER_HEADER"){while(cellset[row][field].type=="ROW_HEADER_HEADER"){if(flat){data.metadata.push({colIndex:field,colType:"String",colName:cellset[row][field].value});}
field++;}
lowest_level=field-1;}
if(cellset[row][field].type=="COLUMN_HEADER"){var lowest_col_header=0;var colheader=[];while(lowest_col_header<=row){if(cellset[lowest_col_header][field].value!=="null"){colheader.push(cellset[lowest_col_header][field].value);}
lowest_col_header++;}
if(flat){data.metadata.push({colIndex:field,colType:"Numeric",colName:colheader.join(' ~ ')});}
data_start=row+1;}}}
var labelsSet={};var rowlabels=[];for(var labelCol=0;labelCol<=lowest_level;labelCol++){rowlabels.push(null);}
for(var row=data_start,rowLen=cellset.length;row<rowLen;row++){if(cellset[row][0].value!==""){var record=[];var flatrecord=[];var parent=null;var rv=null;for(var labelCol=0;labelCol<=lowest_level;labelCol++){if(cellset[row]&&cellset[row][labelCol].value==='null'){currentDataPos=data;var prevLabel=0;for(;prevLabel<lowest_level&&cellset[row][prevLabel].value==='null';prevLabel++){currentDataPos=currentDataPos[rowlabels[prevLabel]];}
if(prevLabel>labelCol){labelCol=prevLabel;}}
if(cellset[row]&&cellset[row][labelCol].value!=='null'){if(labelCol==0){for(var xx=0;xx<=lowest_level;xx++){rowlabels[xx]=null;}}
if(typeof currentDataPos=="number"){parent[rv]={};currentDataPos=parent[rv];}
rv=cellset[row][labelCol].value;rowlabels[labelCol]=rv;if(!currentDataPos.hasOwnProperty(rv)){currentDataPos[rv]={};}
parent=currentDataPos;currentDataPos=currentDataPos[rv];}}
flatrecord=_.clone(rowlabels);for(var col=lowest_level+1,colLen=cellset[row].length;col<colLen;col++){var cell=cellset[row][col];var value=cell.value||0;var maybePercentage=(value!=0);var raw=cell.properties.raw;if(raw&&raw!=="null"){value=parseFloat(raw);}else if(typeof(cell.value)!=="number"&&parseFloat(cell.value.replace(/[^a-zA-Z 0-9.]+/g,''))){value=parseFloat(cell.value.replace(/[^a-zA-Z 0-9.]+/g,''));maybePercentage=false;}
if(value>0&&maybePercentage){value=cell.value&&cell.value.indexOf('%')>=0?value*100:value;}
record.push(value);flatrecord.push({f:cell.value,v:value});}
if(flat)data.resultset.push(flatrecord);var sum=_.reduce(record,function(memo,num){return memo+num;},0);rv=(rv==null?"null":rv);parent[rv]=sum;currentDataPos=data;}}
if(setdata){self.rawdata=args.data;self.data=data;self.hasProcessed=true;self.data.height=self.data.resultset.length;}
return data;}else{$(self.el).find('.canvas_wrapper').text("No results").show();}};;(function(window){var
characters='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=',fromCharCode=String.fromCharCode,INVALID_CHARACTER_ERR=(function(){try{document.createElement('$');}
catch(error){return error;}}());window.Base64||(window.Base64={encode:function(string){var
a,b,b1,b2,b3,b4,c,i=0,len=string.length,max=Math.max,result='';while(i<len){a=string.charCodeAt(i++)||0;b=string.charCodeAt(i++)||0;c=string.charCodeAt(i++)||0;if(max(a,b,c)>0xFF){throw INVALID_CHARACTER_ERR;}
b1=(a>>2)&0x3F;b2=((a&0x3)<<4)|((b>>4)&0xF);b3=((b&0xF)<<2)|((c>>6)&0x3);b4=c&0x3F;if(!b){b3=b4=64;}else if(!c){b4=64;}
result+=characters.charAt(b1)+characters.charAt(b2)+characters.charAt(b3)+characters.charAt(b4);}
return result;}});}(this));var isIE=(function(){var undef,v=3;var dav=navigator.appVersion;if(dav.indexOf('MSIE')!=-1){v=parseFloat(dav.split('MSIE ')[1]);return v>4?v:false;}
return false;}());if($.blockUI&&!Dashboards){$.blockUI.defaults.css={"font-size":"14px"};$.blockUI.defaults.overlayCSS={};$.blockUI.defaults.blockMsgClass='processing';$.blockUI.defaults.fadeOut=0;$.blockUI.defaults.fadeIn=0;$.blockUI.defaults.ignoreIfBlocked=false;}
var SaikuConfig={server:null,path:null,user:null,password:null};var SaikuCall={file:null,render:'table',mode:'null',formatter:'flattened',htmlObject:"saiku",params:{}}
var SaikuRenderer={"table":SaikuTableRenderer,"chart":SaikuChartRenderer};var SaikuClient=function(config){this.config=_.extend(SaikuConfig,config);};SaikuClient.prototype.error=function(jqXHR,textStatus,errorThrown){if(typeof console!="undefined"&&console){console.error(textStatus);console.error(jqXHR);console.error(errorThrown);}};SaikuClient.prototype.execute=function(usercall){var self=this;var call=_.extend({},SaikuCall,usercall);if(typeof console!="undefined"&&console){console.log(call);}
var client=this.config;var parameters={};if(call.params){for(key in call.params){parameters['param'+key]=call.params[key];}}
parameters=_.extend(parameters,{"formatter":call.formatter},{"file":call.file});if($.blockUI&&!Dashboards){$(call.htmlObject).block({message:'<span class="saiku_logo" style="float:left">&nbsp;&nbsp;</span> Executing....'});}
var params={url:client.server+(client.path?client.path:"")+"/export/saiku/json",type:'GET',cache:false,data:parameters,contentType:'application/x-www-form-urlencoded',dataType:"json",success:function(data,textStatus,jqXHR){if(call.render in SaikuRenderer){var r=new SaikuRenderer[call.render](data,call);r.render();if($.blockUI){$(call.htmlObject).unblock();}}else{alert('Render type '+call.render+" not found!");}
if($.blockUI){$(call.htmlObject).unblock();}},error:function(jqXHR,textStatus,errorThrown){if($.blockUI){$(call.htmlObject).unblock();}
$(call.htmlObject).text("Error: "+textStatus);self.error(jqXHR,textStatus,errorThrown);},crossDomain:true,async:true,beforeSend:function(request){if(client&&client.user&&client.password){var auth="Basic "+Base64.encode(client.user+":"+client.password);request.setRequestHeader('Authorization',auth);return true;}}};$.ajax(params);};
var saikuWidgetComponent=BaseComponent.extend({update:function(){var myself=this;var htmlId="#"+myself.htmlObject;if(myself.saikuFilePath.substr(0,1)!="/"){myself.saikuFilePath="/"+myself.saikuFilePath;}
var parameters={};if(myself.parameters){_.each(myself.parameters,function(parameter){var k=parameter[0];var v=parameter[1];if(window.hasOwnProperty(v)){v=window[v];}
parameters[k]=v;});}
if(myself.width){$(htmlId).width(myself.width);}
if(myself.width){$(htmlId).height(myself.height);}
if("table"==myself.renderMode){$(htmlId).addClass('workspace_results');var t=$("<div></div>");$(htmlId).html(t);htmlId=t;}
var myClient=new SaikuClient({server:"../../../plugin/saiku/api",path:"/cde-component"});myClient.execute({file:myself.saikuFilePath,htmlObject:htmlId,render:myself.renderMode,mode:myself.renderType,zoom:true,params:parameters});}});
var bt=bt||{};bt.ext=bt.ext||{};bt.ext.olapCubesCache={};bt.ext.getOlapCube=function(catalog,cube,jndi){var cubeStructure=null;$.ajax({type:"GET",url:bt.helpers.olap.getServiceUrl()+bt.helpers.olap.getCubeStructureUrl(),data:{catalog:bt.helpers.olap.getNormalizedCatalog(catalog),cube:cube,jndi:jndi},dataType:"json",success:function(json){if(json&&json.status=="true"&&json.result){if(json.result.dimensions&&json.result.measures)
cubeStructure=json.result;}},async:false});return cubeStructure;};bt.ext.openBTable=function(spec){var def={catalog:"",jndi:"",cube:"",dimensions:[],measures:[],pivotDimensions:[],filters:[],measuresOnColumns:true,nonEmptyRows:true,nonEmptyColumns:true,grandTotal:false,subTotals:false,pivotGrandTotal:false,pivotSubTotals:false,totalsPosition:"bottom",hideSpans:false,drillTarget:"SELF"};var prop=$.extend({},def,spec);var url=bt.helpers.general.getRenderServiceUrl()+"?";url+="btdef="+encodeURIComponent(JSON.stringify(prop));if(typeof top.mantle_openTab!=="undefined")
top.mantle_openTab("BTable","BTable",url);else
window.open(url,"_blank");};bt.ext.openBTableFile=function(path,title){var url=bt.helpers.general.getRenderServiceUrl()+"?btfile="+path;title=title===undefined?"BTable":title;if(typeof top.mantle_openTab!=="undefined")
top.mantle_openTab(title,title,url);else
window.open(url,"_blank");};bt.ext.drillWithBTable=function(btable,prompt){if(prompt){var clickHandler=function(){btable.dimensions=[[$(this).data("qn"),""]];$("#BTableDrillPopup").hide();bt.ext.openBTable(btable);}
var contentHtml="";if(prompt.options&&prompt.options.length>0){contentHtml+="<ul>";$.each(prompt.options,function(i,v){contentHtml+="<li data-qn='"+v[1]+"'>"+v[0]+"</li>";});contentHtml+="</ul>";}else{if(bt.ext.olapCubesCache[btable.catalog+"::"+btable.cube]===undefined){bt.ext.olapCubesCache[btable.catalog+"::"+btable.cube]=bt.ext.getOlapCube(btable.catalog,btable.cube,btable.jndi);}
var cube=bt.ext.olapCubesCache[btable.catalog+"::"+btable.cube];var pivotHierarchies=$.map(btable.pivotDimensions,function(e){return(e[0].split("].[")[0]+"]").replace("]]","]")});$.each(_.sortBy(cube.dimensions,function(e){return e.caption;}),function(i,dimension){var dimensionName=dimension.caption;$.each(_.sortBy(dimension.hierarchies,function(e){return e.caption;}),function(j,hierarchy){if(pivotHierarchies.indexOf(hierarchy.qualifiedName)<0){var hierarchyName=hierarchy.caption.indexOf(dimensionName+".")===0?hierarchy.caption.replace(dimensionName+".",""):hierarchy.caption;var showHierarchy=!(hierarchy.levels.length==1&&hierarchy.levels[0].caption==dimensionName);if(showHierarchy)
contentHtml+="<p class='hierarchy'>"+dimensionName+(dimensionName==hierarchyName?"":" :: "+hierarchyName)+"</p>";contentHtml+="<ul"+(showHierarchy?" class='hierarchy'":"")+">";$.each(hierarchy.levels,function(k,level){contentHtml+="<li data-qn='"+level.qualifiedName+"'>"+level.caption+"</li>";});contentHtml+="</ul>";}});});}
var $popup=$("#BTableDrillPopup");if($popup.length){$popup.find(".header .title").html(prompt.title?prompt.title:"BTable Drill");$popup.find(".content").html(contentHtml);$("#BTableDrillPopup li").click(clickHandler);$popup.css("left",prompt.x).css("top",prompt.y).show();}else{var popupHtml="<div id='BTableDrillPopup' class='btDrillPopup' style='position:absolute; left:"+prompt.x+"px; top:"+prompt.y+"px; z-index:100'>"+"  <div class='header'><div class='title'>"+(prompt.title?prompt.title:"BTable Drill")+"</div><div class='closeButton'>X</div></div>"+"  <div class='content'>"+contentHtml+"</div>"+"</div>";$(popupHtml).appendTo("body");$("#BTableDrillPopup .closeButton").click(function(){$("#BTableDrillPopup").hide();});$("#BTableDrillPopup li").click(clickHandler);}}else{bt.ext.openBTable(btable);}};
var bt=bt||{};bt.components=bt.components||{};bt.components.BTable=function(spec){var defaults={componentName:"BTable",componentHtmlObject:"",catalog:"",jndi:"",cube:"",dimensions:[],measures:[],pivotDimensions:[],filters:[],measuresOnColumns:true,orderBy:[],nonEmptyRows:true,nonEmptyColumns:true,grandTotal:false,subTotals:false,pivotGrandTotal:false,pivotSubTotals:false,totalsPosition:"bottom",hideSpans:false,showFilters:true,exportStyle:{},fixedHeader:true,drillTarget:"NEW_TAB",renderDashboard:false};var myself={};myself.properties=$.extend({},defaults,spec);myself.properties.filtersPanelHtmlObject=myself.properties.componentHtmlObject+"FiltersPanel";myself.olapCube=new bt.olap.OlapCube({catalog:myself.properties.catalog,cube:myself.properties.cube,jndi:myself.properties.jndi});myself.query=new bt.Query({cube:myself.properties.cube,dimensions:myself.properties.dimensions,measures:myself.properties.measures,pivotDimensions:myself.properties.pivotDimensions,filters:myself.properties.filters,measuresOnColumns:myself.properties.measuresOnColumns,nonEmpty:{columns:myself.properties.nonEmptyColumns,rows:myself.properties.nonEmptyRows},summary:{grandTotal:myself.properties.grandTotal,subTotals:myself.properties.subTotals,pivotGrandTotal:myself.properties.pivotGrandTotal,pivotSubTotals:myself.properties.pivotSubTotals,position:myself.properties.totalsPosition},orders:myself.properties.orderBy},myself.olapCube);var normalizedCdaResult={};myself.normalizeCdaJson=function(json){var normalizedJson=json;var hasMoC=myself.query.hasMeasuresOnColumns();var dimensionQualifiedNames=myself.query.getDimensionQualifiedNames();var pivotDimensionQualifiedNames=myself.query.getPivotDimensionQualifiedNames();var measureQualifiedNames=myself.query.getMeasureQualifiedNames();var unwantedColumns=[];normalizedJson.metadata=$.grep(json.metadata,function(i){var colName=i.colName;var remove=colName.endsWith("[(All)]")||(colName.indexOf("]/[")<0&&((hasMoC&&$.inArray(colName,dimensionQualifiedNames)<0&&$.inArray(colName,measureQualifiedNames)<0)||(!hasMoC&&colName!="[Measures].[MeasuresLevel]"&&$.inArray(colName,pivotDimensionQualifiedNames)<0&&$.inArray(colName.split("].[")[0],$.map(dimensionQualifiedNames,function(e){return e.split("].[")[0];}))<0&&$.inArray("["+colName.split("].[")[1],$.map(dimensionQualifiedNames,function(e){return e.split("].[")[0];}))<0)));if(remove)unwantedColumns.push(i.colIndex);return!remove;});$.each(json.resultset,function(i,v){normalizedJson.resultset[i]=$.grep(v,function(o,j){return $.inArray(j,unwantedColumns)<0;});});$.each(normalizedJson.metadata,function(i,v){var colName=v.colName;if(colName.indexOf("]/[")>0||$.inArray(colName,measureQualifiedNames)>=0){v.colType="numeric";}else{if(colName!="[Measures].[MeasuresLevel]"&&$.inArray(colName,dimensionQualifiedNames)<0&&$.inArray(colName,pivotDimensionQualifiedNames)<0)
v.colType="numeric";else
v.colType="string";}});if(!hasMoC){var measuresLevelColIdx=-1;$.each(normalizedJson.metadata,function(i,v){if(v.colName=="[Measures].[MeasuresLevel]"){measuresLevelColIdx=i;}});if(measuresLevelColIdx>-1){$.each(normalizedJson.resultset,function(i,v){var measureName=normalizedJson.resultset[i][measuresLevelColIdx];var measureCaption=myself.olapCube.getCaption("[Measures].["+measureName+"]");normalizedJson.resultset[i][measuresLevelColIdx]=measureCaption;});}}
normalizedCdaResult=normalizedJson;return normalizedJson;}
var headers=[];var oldHeaders=[]
myself.getHeaders=function(){return headers;}
myself.setHeaders=function(cdaHeaders){headers=[];var getCaption=function(qualifiedName,value){var caption="";if(value=="[Measures].[MeasuresLevel]")
caption=$.i18n.prop("table_measures");else if(value=="BT_TOTAL")
caption=$.i18n.prop("table_total");else if(value.indexOf("].[")>-1)
caption=myself.olapCube.getCaption(value);else{if(qualifiedName=="[Measures].[]")
caption=myself.olapCube.getCaption("[Measures].["+value+"]");else
caption=value;}
return caption;}
var getLevel=function(qualifiedName,memberName){var level="";if(memberName.indexOf("].[")>-1)
level=memberName;else{if(qualifiedName=="[Measures].[]")
level="[Measures].["+memberName+"]";else
level=qualifiedName;}
return level;}
var getHeaderRow=function(qualifiedName,uncompressedMembersList,isLastRow,rowSpans){var compressedMembersList=[];if(isLastRow||myself.properties.hideSpans){$.each(uncompressedMembersList,function(i,value){compressedMembersList.push({level:getLevel(qualifiedName,value),member:value,caption:getCaption(qualifiedName,value),colspan:1,rowspan:myself.properties.hideSpans?1:rowSpans[i]});});}else{var count=0;var previousValue="";var previousRowSpan=0;$.each(uncompressedMembersList,function(i,value){if((value!=previousValue&&previousValue!="")||(value==previousValue&&rowSpans[i]!=previousRowSpan)){compressedMembersList.push({level:getLevel(qualifiedName,previousValue),member:previousValue,caption:getCaption(qualifiedName,previousValue),colspan:count,rowspan:previousRowSpan});count=0;}
previousValue=value;previousRowSpan=rowSpans[i];count++;});compressedMembersList.push({level:getLevel(qualifiedName,previousValue),member:previousValue,caption:getCaption(qualifiedName,previousValue),colspan:count,rowspan:previousRowSpan});}
compressedMembersList=$.grep(compressedMembersList,function(e,i){return e.rowspan>0;});return compressedMembersList;}
var querySetting=myself.query.getSettings();if(!querySetting.measuresOnColumns){var splittedCdaHeaders=[];$.each(cdaHeaders,function(i,v){var splittedHeader=v.split("]/[");var length=splittedHeader.length;if(length>1){splittedHeader[0]+="]";for(j=1;j<length-1;j++){splittedHeader[j]="["+splittedHeader[j]+"]";}
splittedHeader[length-1]="["+splittedHeader[length-1];}
splittedCdaHeaders.push(splittedHeader);});var lastElementIndex=splittedCdaHeaders.length-1;var dimensionQualifiedNames=myself.query.getDimensionQualifiedNames();var pivotDimensionQualifiedNames=myself.query.getPivotDimensionQualifiedNames();var hh=new Array();var levelQualifiedNames=dimensionQualifiedNames.slice().reverse();var previousHierarchy="";var maxLevelDepth=1;for(i=0;i<levelQualifiedNames.length;i++){var levelQualifiedName=levelQualifiedNames[i];var hierarchy=levelQualifiedName.split("].[")[0].substring(1);if(levelQualifiedName.indexOf("].[")<0)
hierarchy=hierarchy.substring(0,hierarchy.length-1);var index=-1;$.each(splittedCdaHeaders[lastElementIndex],function(j,w){if(w.indexOf("["+hierarchy+"]")>-1||w.indexOf("["+hierarchy+"."+hierarchy+"]")>-1){index=j;return;}});hh[levelQualifiedName]=[];if(index>=0){for(j=0;j<splittedCdaHeaders.length;j++){var member=splittedCdaHeaders[j][0];if(splittedCdaHeaders[j].length>1||(member!="[Measures].[MeasuresLevel]"&&$.inArray(member,pivotDimensionQualifiedNames)<0)){var memberUniqueNameParts=splittedCdaHeaders[j][index].split("].[").reverse();member=memberUniqueNameParts[0];member=member.substring(0,member.length-1);if(hierarchy==previousHierarchy&&member!="BT_TOTAL"){member=memberUniqueNameParts[maxLevelDepth-myself.olapCube.getLevelDepth(levelQualifiedName)];}}
hh[levelQualifiedName].push(member);}
if(hierarchy!=previousHierarchy){previousHierarchy=hierarchy;maxLevelDepth=myself.olapCube.getLevelDepth(levelQualifiedName);}}}
var ohh=new Array();$.each(dimensionQualifiedNames,function(i,v){if(hh[v].length>0)
ohh.push(hh[v]);});var ors=new Array(ohh.length);for(i=0;i<ohh.length;i++){ors[i]=new Array(ohh[i].length);}
$.each(ohh,function(i,row){$.each(row,function(j,v){if(ors[i][j]!=0){ors[i][j]=1;count=1;var stop=false;for(k=i+1;k<ohh.length&&!stop;k++){if(ohh[k][j]==v){count++;ors[k][j]=0;}
else
stop=true;}
ors[i][j]=count;}});});var newIndex=-1;$.each(dimensionQualifiedNames,function(i,v){newIndex++;if(hh[v].length>0){headers.push(getHeaderRow(v,hh[v],newIndex==ohh.length-1,ors[newIndex]));}
else
newIndex--;});}
else{var splittedCdaHeaders=[];$.each(cdaHeaders,function(i,v){var splittedHeader=v.split("]/[");var length=splittedHeader.length;if(length>1){splittedHeader[0]+="]";for(j=1;j<length-1;j++){splittedHeader[j]="["+splittedHeader[j]+"]";}
splittedHeader[length-1]="["+splittedHeader[length-1];}
splittedCdaHeaders.push(splittedHeader);});var lastElementIndex=splittedCdaHeaders.length-1;var hh=new Array();var pivotDimensionQualifiedNames=myself.query.getPivotDimensionQualifiedNames();if($.inArray("MEASURES",pivotDimensionQualifiedNames)<0)
pivotDimensionQualifiedNames.push("[Measures].[]");else
pivotDimensionQualifiedNames=$.map(pivotDimensionQualifiedNames,function(qn){return qn=="MEASURES"?"[Measures].[]":qn;});var levelQualifiedNames=pivotDimensionQualifiedNames.slice().reverse();var previousHierarchy="";var maxLevelDepth=1;for(i=0;i<levelQualifiedNames.length;i++){var levelQualifiedName=levelQualifiedNames[i];var hierarchy=levelQualifiedName.split("].[")[0].substring(1);var index=-1;$.each(splittedCdaHeaders[lastElementIndex],function(j,w){if(w.indexOf("["+hierarchy+"]")>-1||w.indexOf("["+hierarchy+"."+hierarchy+"]")>-1){index=j;return;}});hh[levelQualifiedName]=[];if(index>=0){for(j=0;j<splittedCdaHeaders.length;j++){var member=splittedCdaHeaders[j][0];if(splittedCdaHeaders[j].length>1){var memberUniqueNameParts=splittedCdaHeaders[j][index].split("].[").reverse();member=memberUniqueNameParts[0];member=member.substring(0,member.length-1);if(hierarchy==previousHierarchy&&member!="BT_TOTAL"){member=memberUniqueNameParts[maxLevelDepth-myself.olapCube.getLevelDepth(levelQualifiedName)];}}
hh[levelQualifiedName].push(member);}
if(hierarchy!=previousHierarchy){previousHierarchy=hierarchy;maxLevelDepth=myself.olapCube.getLevelDepth(levelQualifiedName);}}}
var ohh=new Array();$.each(pivotDimensionQualifiedNames,function(i,v){if(hh[v].length>0)
ohh.push(hh[v]);});var ors=new Array(ohh.length);for(i=0;i<ohh.length;i++){ors[i]=new Array(ohh[i].length);}
$.each(ohh,function(i,row){$.each(row,function(j,v){if(ors[i][j]!=0){ors[i][j]=1;count=1;var stop=false;for(k=i+1;k<ohh.length&&!stop;k++){if(ohh[k][j]==v){count++;ors[k][j]=0;}
else
stop=true;}
ors[i][j]=count;}});});var newIndex=-1;$.each(pivotDimensionQualifiedNames,function(i,v){newIndex++;if(hh[v].length>0){headers.push(getHeaderRow(v,hh[v],newIndex==ohh.length-1,ors[newIndex]));}
else
newIndex--;});}}
myself.getElementType=function(qualifiedName){if(qualifiedName=="[Measures].[MeasuresLevel]")
return"MEASURES_LEVEL";var result=$.grep(myself.query.getDimensionQualifiedNames(),function(e,i){return e==qualifiedName});if(result.length>0)
return"DIMENSION";result=$.grep(myself.query.getPivotDimensionQualifiedNames(),function(e,i){return e==qualifiedName});if(result.length>0)
return"PIVOT_DIMENSION";result=$.grep(myself.query.getMeasureQualifiedNames(),function(e,i){return e==qualifiedName});if(result.length>0)
return"MEASURE";result=$.grep(myself.query.getFilterQualifiedNames(),function(e,i){return e==qualifiedName});if(result.length>0)
return"FILTER";if(myself.olapCube.getElementType(qualifiedName)!=undefined)
return"CALCULATED_MEMBER";return"";};myself.getMenuTitle=function(btRef){var title="";var level=btRef.level;var member=btRef.member;if(!myself.query.hasMeasuresOnColumns()){if(level.indexOf("[Measures].[")==0&&level!="[Measures].[MeasuresLevel]"){if(isNaN(parseFloat(member))){var qn=myself.olapCube.getQualifiedNameByCaption(member,"L");if(qn!=null){level=qn;member=level.substring(12,level.length-1);}}else{var qn=myself.olapCube.getQualifiedNameByCaption(level.substring(12,level.length-1),"L");if(qn!=null){level=qn;}}}}
var qualifiedName=level;if(level.indexOf("].[")<0)
qualifiedName+=".["+member+"]";if(qualifiedName=="[Measures].[MeasuresLevel]")
title=$.i18n.prop("table_measures");else{var fullNameParts=myself.olapCube.getFullCaption(qualifiedName).split(" -> ");if(fullNameParts[0]!=fullNameParts[1])
title+=(fullNameParts[0]=="Measures"?$.i18n.prop("table_measures"):fullNameParts[0])+" -> ";title+=fullNameParts[1];}
if(member!=level&&level.indexOf("].[")>-1&&(level.indexOf("[Measures]")<0||"[Measures].["+member+"]"!=level)){title+="<br />"+(member=="BT_TOTAL"?$.i18n.prop("table_total"):(member==null?"<i>NULL</i>":(!isNaN(parseFloat(member))&&member.toString().indexOf(" ")<0&&!btRef.colspan&&level.indexOf("[Measures].[")>-1?getLocalizedFormattedValue(myself.olapCube.getFormatStrings()[qualifiedName],member):member)));}
return title;};myself.getMeasures=function(){return myself.query.getMeasures();};myself.setMeasures=function(measures){myself.query.setMeasures(measures);};myself.enableGrandTotal=function(){myself.query.set({summary:{grandTotal:true}});};myself.disableGrandTotal=function(){myself.query.set({summary:{grandTotal:false}});};myself.hasMeasuresOnColumns=function(){return myself.query.hasMeasuresOnColumns();};myself.printFilters=function(){var dimensions=$.grep(myself.query.getDimensions(),function(e){return e[1]!=""&&e[0].indexOf("].[")>0;});var pivotDimensions=$.grep(myself.query.getPivotDimensions(),function(e){return e[1]!=""&&e[0].indexOf("].[")>0;});var filters=myself.query.getFilters();var html="";var previousHierarchy="";$.each(dimensions,function(i,v){var qualifiedName=v[0];var plainFilter=v[1];var hierarchy=qualifiedName.split("].[")[0].substring(1).replace("]","");var filterParts=plainFilter.split(":[");var filterMode=filterParts[0].replace("_un","");var prettyFilter=filterParts[1];prettyFilter=prettyFilter.substring(0,prettyFilter.length-1);if(prettyFilter.indexOf("].[")<0)
prettyFilter=prettyFilter.split("],[").join(" , ");else{prettyFilter=$.map(prettyFilter.split("],["),function(e){var parts=e.split("].[");parts=parts.slice(1);return"["+parts.join("].[");}).join(" , ");}
if(filterMode=="exclude")
prettyFilter=$.i18n.prop("filters_display_except",prettyFilter.split("SPLIT_TO_CONVERT_STRING_TO_ARRAY"));else if(filterMode=="between")
prettyFilter=$.i18n.prop("filters_display_between",prettyFilter.split(" , "));if(hierarchy!=previousHierarchy)
html+="&nbsp;&nbsp;<span class='hierarchy'>"+myself.olapCube.getCaption("["+hierarchy+"]")+"</span>";html+="<span class='separator'> "+$.i18n.prop("filters_display_separator")+" </span><a href='#' class='level' data-qn='"+qualifiedName+"'>"+myself.olapCube.getCaption(qualifiedName)+"</a>: <span class='filter'>"+prettyFilter+"</span>";previousHierarchy=hierarchy;});$.each(pivotDimensions,function(i,v){var qualifiedName=v[0];var plainFilter=v[1];var hierarchy=qualifiedName.split("].[")[0].substring(1).replace("]","");var filterParts=plainFilter.split(":[");var filterMode=filterParts[0].replace("_un","");var prettyFilter=filterParts[1];prettyFilter=prettyFilter.substring(0,prettyFilter.length-1);if(prettyFilter.indexOf("].[")<0)
prettyFilter=prettyFilter.split("],[").join(" , ");else{prettyFilter=$.map(prettyFilter.split("],["),function(e){var parts=e.split("].[");parts=parts.slice(1);return"["+parts.join("].[");}).join(" , ");}
if(filterMode=="exclude")
prettyFilter=$.i18n.prop("filters_display_except",prettyFilter.split("SPLIT_TO_CONVERT_STRING_TO_ARRAY"));else if(filterMode=="between")
prettyFilter=$.i18n.prop("filters_display_between",prettyFilter.split(" , "));if(hierarchy!=previousHierarchy)
html+="&nbsp;&nbsp;<span class='hierarchy'>"+myself.olapCube.getCaption("["+hierarchy+"]")+"</span>";html+="<span class='separator'> "+$.i18n.prop("filters_display_separator")+" </span><a href='#' class='level' data-qn='"+qualifiedName+"'>"+myself.olapCube.getCaption(qualifiedName)+"</a>: <span class='filter'>"+prettyFilter+"</span>";previousHierarchy=hierarchy;});$.each(filters,function(i,v){var qualifiedName=v[0];var plainFilter=v[1];var hierarchy=qualifiedName.split("].[")[0].substring(1).replace("]","");var filterParts=plainFilter.split(":[");var filterMode=filterParts[0].replace("_un","");var prettyFilter=filterParts[1];prettyFilter=prettyFilter.substring(0,prettyFilter.length-1);if(prettyFilter.indexOf("].[")<0)
prettyFilter=prettyFilter.split("],[").join(" , ");else{prettyFilter=$.map(prettyFilter.split("],["),function(e){var parts=e.split("].[");parts=parts.slice(1);return"["+parts.join("].[");}).join(" , ");}
if(filterMode=="exclude")
prettyFilter=$.i18n.prop("filters_display_except",prettyFilter.split("SPLIT_TO_CONVERT_STRING_TO_ARRAY"));else if(filterMode=="between")
prettyFilter=$.i18n.prop("filters_display_between",prettyFilter.split(" , "));if(hierarchy!=previousHierarchy)
html+="&nbsp;&nbsp;<span class='hierarchy'>"+myself.olapCube.getCaption("["+hierarchy+"]")+"</span>";html+="<span class='separator'> "+$.i18n.prop("filters_display_separator")+" </span><a href='#' class='level' data-qn='"+qualifiedName+"'>"+myself.olapCube.getCaption(qualifiedName)+"</a>: <span class='filter'>"+prettyFilter+"</span>";previousHierarchy=hierarchy;});if(html.length==0)
html="&nbsp;&nbsp;none";var prefix=myself.query.isSynchronizedByParameters()?"":"un";html="<a href='#' class='filtersTitle' data-qn=''>"+$.i18n.prop("filters_display_title")+"</a>:&nbsp;&nbsp;<img src='"+bt.helpers.general.getImgDirPath()+prefix+"locked.png' class='"+prefix+"lockedIcon' />"+html;var filtersPanelDiv=$("#"+myself.properties.filtersPanelHtmlObject);filtersPanelDiv.html(html);filtersPanelDiv.find("a").bind("click",function(){var qn=$(this).data("qn");myself.openFiltersSelectorPanel(qn);});var ordersMap=myself.query.getOrdersMap();var dimensionsAxisSorted=ordersMap.axes.hasOwnProperty("dimensions");var measuresAxisSorted=ordersMap.axes.hasOwnProperty("measures");if(dimensionsAxisSorted||measuresAxisSorted){var hasMoC=myself.query.hasMeasuresOnColumns();var columnsAxisName=(hasMoC&&measuresAxisSorted)?"measures":((!hasMoC&&dimensionsAxisSorted)?"dimensions":"");var rowsAxisName=(hasMoC&&dimensionsAxisSorted)?"dimensions":((!hasMoC&&measuresAxisSorted)?"measures":"");html="";if(columnsAxisName!=""){var columnsSort=ordersMap.axes[columnsAxisName];var by=columnsSort.by;var dir=columnsSort.dir;var axisLetter=columnsAxisName=="dimensions"?"D":"M";html+="<span class='hierarchy'>"+$.i18n.prop("sorts_display_columns_by")+"&nbsp;&nbsp;</span><span class='level'>"+myself.olapCube.getCaption(columnsSort.by)+"</span>&nbsp;&nbsp;<span class='filter'>"+$.i18n.prop("sorts_display_order_"+columnsSort.dir.toLowerCase())+"</span>";if(dir!="ASC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"asc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_asc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='ASC' />";if(dir!="BASC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"basc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_basc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='BASC' />";if(dir!="DESC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"desc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_desc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='DESC' />";if(dir!="BDESC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"bdesc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_bdesc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='BDESC' />";html+="<img src='"+bt.helpers.general.getImgDirPath()+"clear.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_clear")+"' data-target='"+axisLetter+"' data-by='' data-dir='' />";}
if(html!="")
html+="&nbsp;&nbsp;";if(rowsAxisName!=""){var rowsSort=ordersMap.axes[rowsAxisName];var by=rowsSort.by;var dir=rowsSort.dir;var axisLetter=rowsAxisName=="dimensions"?"D":"M";html+="<span class='hierarchy'>"+$.i18n.prop("sorts_display_rows_by")+"&nbsp;&nbsp;</span><span class='level'>"+myself.olapCube.getCaption(by)+"</span>&nbsp;&nbsp;<span class='filter'>"+$.i18n.prop("sorts_display_order_"+rowsSort.dir.toLowerCase())+"</span>";if(dir!="ASC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"asc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_asc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='ASC' />";if(dir!="BASC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"basc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_basc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='BASC' />";if(dir!="DESC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"desc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_desc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='DESC' />";if(dir!="BDESC")
html+="<img src='"+bt.helpers.general.getImgDirPath()+"bdesc.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_order_bdesc")+"' data-target='"+axisLetter+"' data-by='"+by+"' data-dir='BDESC' />";html+="<img src='"+bt.helpers.general.getImgDirPath()+"clear.png' class='sortIcon' title='"+$.i18n.prop("sorts_display_clear")+"' data-target='"+axisLetter+"' data-by='' data-dir='' />";}
html="<div style='margin-top:5px'><span class='filtersTitle'>"+$.i18n.prop("sorts_display_title")+"</span>: "+html+"</div>";filtersPanelDiv.append(html);filtersPanelDiv.find(".sortIcon").bind("click",function(){var target=$(this).data("target");var by=$(this).data("by");var direction=$(this).data("dir");myself.query.sort(target,by,direction);Dashboards.getComponent(myself.properties.componentName).update();});}};myself.openFiltersSelectorPanel=function(selectedLevel){var refreshTable=false;var filtersMap=myself.query.getFiltersMap();var html="<div id='filtersSelectorPanel'><div class='topBox'><div class='topBoxLeft'>";html+="<span class='btTitle'>"+$.i18n.prop("filters_manager_title")+"</span><button id='dashboardBindingButton'>"+(filtersMap.synchronizedByParameters?$.i18n.prop("filters_manager_unbind"):$.i18n.prop("filters_manager_bind"))+" </button>";html+="</div><div id='filterSelectorTitle' class='topBoxRight'>"+$.i18n.prop("filters_manager_tip");html+="</div></div><div class='centralBox'><div class='centralBoxLeft'>";var hierarchyQualifiedNames=[];for(key in filtersMap.hierarchies){hierarchyQualifiedNames.push(key);}
hierarchyQualifiedNames.sort();$.each(hierarchyQualifiedNames,function(i,key){var hierarchyName=myself.olapCube.getCaption(key);var hierarchy=filtersMap.hierarchies[key];var levels=hierarchy.levels;html+="<strong>"+hierarchyName+"</strong><ul>";$.each(hierarchy.order,function(i,v){var levelQualifiedName=v;var levelName=myself.olapCube.getCaption(levelQualifiedName);var level=levels[v];var filtered=level.filtered;var synchronizedByParameters=level.synchronizedByParameters;var filterMode=level.filterMode;var members=level.members;var selections=members.length;var firstMember=selections>0?members[0]:"";var isAllMember=(!filtersMap.synchronizedByParameters&&selections==0)||(selections>0&&(firstMember=="All"||firstMember.indexOf("All ")==0||firstMember.indexOf(".[All]")>0||firstMember.indexOf(".[All ")>0));var filterString="";if(filtered&&!isAllMember)
filterString=(synchronizedByParameters&&filtersMap.synchronizedByParameters)?$.i18n.prop("filters_manager_tag_parameter"):$.i18n.prop("filters_manager_tag_"+filterMode.toLowerCase(),selections.toString().split("SPLIT_TO_CONVERT_STRING_TO_ARRAY"));html+="<li><span class='list-item-level"+(levelQualifiedName==selectedLevel?" list-item-selected":"")+"' data-par='"+synchronizedByParameters+"' data-lbl='"+hierarchyName+" -> "+levelName+"' data-qn='"+levelQualifiedName+"'>"+levelName+"</span><span class='list-item-filterInfo'>"+filterString+"</span></li>";});html+="</ul>";});html+="</div><div id='filterSelectorStage' class='centralBoxRight'>";html+="</div></div></div>";$.fancybox(html,{'autoDimensions':true,'overlayShow':true,'hideOnOverlayClick':false,'hideOnContentClick':false,'enableEscapeButton':false,'showCloseButton':true,'onClosed':function(){if(refreshTable)Dashboards.getComponent(myself.properties.componentName).update();}});var multiselectDefaultProperties={header:true,minWidth:480,height:370,checkAllText:$.i18n.prop("filters_manager_form_selector_check_all"),uncheckAllText:$.i18n.prop("filters_manager_form_selector_uncheck_all"),noneSelectedText:$.i18n.prop("filters_manager_form_selector_placeholder"),selectedText:$.i18n.prop("filters_manager_form_selector_selected_text",["#","#"]),selectedList:50};var multiselectBetweenModeProperties={header:$.i18n.prop("filters_manager_form_selector_between_notice"),minWidth:480,height:370,noneSelectedText:$.i18n.prop("filters_manager_form_selector_placeholder"),selectedList:2,click:function(e){if($(this).multiselect("widget").find("input:checked").length>2){return false;}},beforeoptgrouptoggle:function(e,ui){return false;}};var multiselectfilterDefaultProperties={label:$.i18n.prop("filters_manager_form_selector_filter_label"),placeholder:$.i18n.prop("filters_manager_form_selector_filter_placeholder"),};var createSelectContent=function(levelQualifiedName,isCalculatedMember,level,boundToDashboard,uniqueNames){var html="";var members=isCalculatedMember?[]:myself.olapCube.getLevelMembers(levelQualifiedName).members;if(uniqueNames){var previousOptgroup="";$.each(members,function(i,v){var optgroup="";var memberQualifiedName=v.qualifiedName;var qnParts=memberQualifiedName.split("].[");if(qnParts.length>2){for(i=1;i<qnParts.length-1;i++)
optgroup+=".["+qnParts[i]+"]";optgroup=optgroup.substring(1);}
if(optgroup!=""&&optgroup!=previousOptgroup){if(previousOptgroup!="")
html+="</optgroup>";html+="<optgroup label='"+optgroup+"'>";previousOptgroup=optgroup;}
var memberName=v.name;var selectedMembers=[];if(boundToDashboard&&level.synchronizedByParameters){var parameterValue=Dashboards.getParameterValue(level.initialFilterExpression.replace(level.filterMode+"_un:",""));if($.isArray(parameterValue))
selectedMembers=parameterValue;else
selectedMembers.push(parameterValue);}else{selectedMembers=level.members;}
html+="<option value=\""+memberQualifiedName+"\""+($.inArray(memberQualifiedName,selectedMembers)<0?"":" selected")+">"+memberName+"</option>";});if(previousOptgroup!="")
html+="</optgroup>";}else{var memberNames=_.uniq($.map(members,function(e){return e.name;}).sort(),true);var selectedMembers=[];if(boundToDashboard&&level.synchronizedByParameters){var parameterValue=Dashboards.getParameterValue(level.initialFilterExpression.replace(level.filterMode+":",""));if($.isArray(parameterValue))
selectedMembers=parameterValue;else
selectedMembers.push(parameterValue);}else{selectedMembers=level.members;}
$.each(memberNames,function(i,memberName){html+="<option value=\""+memberName+"\""+($.inArray(memberName,selectedMembers)<0?"":" selected")+">"+memberName+"</option>";});}
return html;};var generateFilterSelector=function(levelQualifiedName,levelLabel){var qnParts=levelQualifiedName.split("].[");var hrcName=qnParts[0].substring(1);var level=qnParts.length>1?filtersMap.hierarchies["["+hrcName+"]"].levels[levelQualifiedName]:{};var uniqueNames=level.uniqueNames;var boundToDashboard=filtersMap.synchronizedByParameters;var title="";if(levelLabel)
title=levelLabel;else{var lvlName=qnParts.length>1?myself.olapCube.getElementName(qnParts[1].replace("]","")):"";title=hrcName+(lvlName==""?"":" -> "+lvlName);}
$("#filterSelectorTitle").html("<span class='btTitle'>"+title+"</span>");var html="<div class='filterModeBar'>";html+="<div><strong style='font-weight:bold'>"+$.i18n.prop("filters_manager_form_filter_mode")+"</strong> <input type='radio' name='filter-mode' value='in' "+(level.filterMode=="between"?"":"checked")+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+"/>"+$.i18n.prop("filters_manager_form_in");html+="<input type='radio' name='filter-mode' value='between' "+(level.filterMode=="between"?"checked":"")+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+"/>"+$.i18n.prop("filters_manager_form_between");html+="</div><div id='exceptBox'"+(level.filterMode=="between"?" style='display:none'":"")+"><strong>"+$.i18n.prop("filters_manager_form_except")+"</strong> <input type='checkbox' name='except' value='except' "+(level.filterMode=="exclude"?"checked":"")+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+"/>";html+="</div><div><strong style='font-weight:bold'>"+$.i18n.prop("filters_manager_form_unique_names")+"</strong> <input type='radio' name='uniquenames' value='yes' "+(uniqueNames?"checked":"")+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+"/>"+$.i18n.prop("filters_manager_form_unique_names_yes");html+="<input type='radio' name='uniquenames' value='no' "+(uniqueNames?"":"checked")+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+"/>"+$.i18n.prop("filters_manager_form_unique_names_no");html+="</div></div><select id='membersSelect' name='membersSelect' multiple='multiple'>";html+=createSelectContent(levelQualifiedName,qnParts.length<2,level,boundToDashboard,uniqueNames);html+="</select>";html+="<div class='updateFilterBar'><input id='update-filter' type='button' value='"+$.i18n.prop("filters_manager_form_update_filter")+"'"+(boundToDashboard&&level.synchronizedByParameters?" disabled":"")+" /></div>";$("#filterSelectorStage").html(html);var membersSelectObj=$("#membersSelect");membersSelectObj.multiselect(level.filterMode=="between"?multiselectBetweenModeProperties:multiselectDefaultProperties).multiselectfilter(multiselectfilterDefaultProperties);if(uniqueNames){membersSelectObj.multiselect({selectedText:function(numChecked,numTotal,checkedItems){var items=$.map(checkedItems,function(e){var parts=e.value.split("].[");parts=parts.slice(1);return"["+parts.join("].[");});return numChecked>50?(numChecked+' of '+numTotal):items.join(", ");}});}
membersSelectObj.multiselect(boundToDashboard&&level.synchronizedByParameters?'disable':'enable');$("input:radio[name='filter-mode']").change(function(){if($("input:radio[name='filter-mode']:checked").val()=='between'){$("#exceptBox").hide();membersSelectObj.multiselect("uncheckAll").multiselectfilter("destroy").multiselect("destroy").multiselect(multiselectBetweenModeProperties).multiselectfilter(multiselectfilterDefaultProperties);}
else{$("#exceptBox").show();membersSelectObj.multiselect("uncheckAll").multiselectfilter("destroy").multiselect("destroy").multiselect(multiselectDefaultProperties).multiselectfilter(multiselectfilterDefaultProperties);}});$("input:radio[name='uniquenames']").change(function(){var isBetweenMode=$("input:radio[name='filter-mode']:checked").val()=='between';var uniqueNames=false;if($("input:radio[name='uniquenames']:checked").val()=='yes')
uniqueNames=true;membersSelectObj.multiselect("uncheckAll").multiselectfilter("destroy").multiselect("destroy");membersSelectObj.empty().html(createSelectContent(levelQualifiedName,qnParts.length<2,level,boundToDashboard,uniqueNames));membersSelectObj.multiselect(isBetweenMode?multiselectBetweenModeProperties:multiselectDefaultProperties).multiselectfilter(multiselectfilterDefaultProperties);if(uniqueNames){membersSelectObj.multiselect({selectedText:function(numChecked,numTotal,checkedItems){var items=$.map(checkedItems,function(e){var parts=e.value.split("].[");parts=parts.slice(1);return"["+parts.join("].[");});return numChecked>50?$.i18n.prop("filters_manager_form_selector_selected_text",[numChecked.toString(),numTotal.toString()]):items.join(", ");}});}});$("#update-filter").click(function(){var mode=$("input:radio[name='filter-mode']:checked").val();var except=$("input:checkbox[name='except']:checked").length;var uniqueNames=$("input:radio[name='uniquenames']:checked").val();var members=membersSelectObj.val();var filterString="";var filterMode=mode=="in"?(except?"exclude":"include"):mode;level.filterMode=filterMode;level.uniqueNames=uniqueNames=="yes";if(members==null){level.members=[];level.filtered=false;}else{if(mode=="between"&&members.length==1)
members.push(members[0]);level.members=members;level.filtered=true;filterString=$.i18n.prop("filters_manager_tag_"+filterMode.toLowerCase(),members.length.toString().split("SPLIT_TO_CONVERT_STRING_TO_ARRAY"));}
$(".list-item-level[data-qn='"+levelQualifiedName+"']").closest("li").find(".list-item-filterInfo").text(filterString);myself.query.setFiltersMap("["+hrcName+"]",levelQualifiedName,level);refreshTable=true;});};if(selectedLevel!=""){generateFilterSelector(selectedLevel);}
$(".list-item-level").bind("click",function(){$(".list-item-selected").removeClass("list-item-selected");$(this).addClass("list-item-selected");var levelLabel=$(this).data("lbl");var levelQualifiedName=$(this).data("qn");generateFilterSelector(levelQualifiedName,levelLabel);});$("#dashboardBindingButton").bind("click",function(){var bound=!filtersMap.synchronizedByParameters;filtersMap.synchronizedByParameters=bound;myself.query.synchronizeFiltersWithParameters(bound);$(".list-item-level").each(function(){if($(this).data("par")){var lvlQn=$(this).data("qn");var hrcQn=lvlQn.split("].[")[0]+"]";var level=filtersMap.hierarchies[hrcQn].levels[lvlQn];var initialFilterExpression=level.initialFilterExpression;var filterInfoObj=$(this).closest("li").find(".list-item-filterInfo");var isSelected=$(this).hasClass("list-item-selected");if(bound){var filterMode=initialFilterExpression.split(":")[0];var uniqueNames=filterMode.indexOf("_un")>-1;filterMode=filterMode.replace("_un","");if(isSelected){$("input:radio[name='filter-mode'][value='"+(filterMode!="between"?"in":filterMode)+"']").attr('checked',true);$("input:checkbox[name='except']").attr('checked',filterMode=="exclude");if(filterMode=="between")$("#exceptBox").hide();else $("#exceptBox").show();$("input:radio[name='uniquenames'][value='"+(uniqueNames?"yes":"no")+"']").attr('checked',true);var membersSelectObj=$("#membersSelect");membersSelectObj.multiselect("uncheckAll").multiselectfilter("destroy").multiselect("destroy");membersSelectObj.empty().html(createSelectContent(lvlQn,lvlQn.indexOf("].[")<0,level,true,uniqueNames));membersSelectObj.multiselect(filterMode=="between"?multiselectBetweenModeProperties:multiselectDefaultProperties).multiselectfilter(multiselectfilterDefaultProperties);if(uniqueNames){membersSelectObj.multiselect({selectedText:function(numChecked,numTotal,checkedItems){var items=$.map(checkedItems,function(e){var parts=e.value.split("].[");parts=parts.slice(1);return"["+parts.join("].[");});return numChecked>50?$.i18n.prop("filters_manager_form_selector_selected_text",[numChecked.toString(),numTotal.toString()]):items.join(", ");}});}}
myself.query.setFiltersMap(hrcQn,lvlQn,{filterMode:filterMode,uniqueNames:uniqueNames,members:[],filtered:true});filterInfoObj.text($.i18n.prop("filters_manager_tag_parameter"));}
else{var filterMode=level.filterMode;var parameterValue=Dashboards.getParameterValue(initialFilterExpression.replace(filterMode+(level.uniqueNames?"_un":"")+":",""));var selectedMembers=[];if($.isArray(parameterValue))
selectedMembers=parameterValue;else
parameterValue==""?[]:selectedMembers.push(parameterValue);myself.query.setFiltersMap(hrcQn,lvlQn,{members:selectedMembers});var firstMember=selectedMembers.length>0?selectedMembers[0]:"All";var isAllMember=firstMember=="All"||firstMember.indexOf("All ")==0||firstMember.indexOf(".[All]")>0||firstMember.indexOf(".[All ")>0;if(isAllMember)
filterInfoObj.text("");else
filterInfoObj.text($.i18n.prop("filters_manager_tag_"+filterMode.toLowerCase(),selectedMembers.length.toString().split("SPLIT_TO_CONVERT_STRING_TO_ARRAY")));}
if(isSelected){$("input:radio[name='filter-mode']").prop("disabled",bound);$("input:checkbox[name='except']").prop("disabled",bound);$("input:radio[name='uniquenames']").prop("disabled",bound);$("input:button[id='update-filter']").prop("disabled",bound);$("#membersSelect").multiselect(bound?'disable':'enable');}}});$(this).text(bound?$.i18n.prop("filters_manager_unbind"):$.i18n.prop("filters_manager_bind"));refreshTable=true;});};myself.getPositionInHierarchyInAxis=function(newQualifiedName,axisQualifiedNames){var position={};var levels=myself.olapCube.getHierarchyLevels(newQualifiedName.split("].[")[0]+"]");levels=$.map(levels,function(e,i){return e.qualifiedName;});levels=$.grep(levels,function(e,i){return e==newQualifiedName||$.inArray(e,axisQualifiedNames)>-1;});var index=$.inArray(newQualifiedName,levels);position.level=index==0?levels[index+1]:levels[index-1];position.direction=index==0?-1:1;return position;};myself.getExtremeLevelsInHierarchyInAxis=function(targetQualifiedName,axisQualifiedNames){var extremeLevels=[];var levels=myself.olapCube.getHierarchyLevels(targetQualifiedName.split("].[")[0]+"]");levels=$.map(levels,function(e,i){return e.qualifiedName;});levels=$.grep(levels,function(e,i){return $.inArray(e,axisQualifiedNames)>-1;});extremeLevels.push(levels[0]);extremeLevels.push(levels[levels.length-1]);return extremeLevels;};myself.buildHeaderContextMenu=function(target){var hasMoC=myself.query.hasMeasuresOnColumns();var targetLevel=target.level;var targetMember=target.member;var targetCaption=target.caption;var targetHierarchy=targetLevel.split("].[")[0].substring(1);var qualifiedName=targetLevel;if(targetLevel.indexOf("].[")<0)
qualifiedName+=".["+targetMember+"]";var targetType=myself.getElementType(qualifiedName);var menu={};menu.title={name:"<strong>"+myself.getMenuTitle(target)+"</strong>",callback:function(key,options){}};menu.titlesep="---";if(targetType=="DIMENSION"||targetType=="PIVOT_DIMENSION"){var allLevels=myself.olapCube.getLevels();var queryDimensionLevels=myself.query.getDimensionQualifiedNames();var queryPivotLevels=myself.query.getPivotDimensionQualifiedNames();var queryLevels=queryDimensionLevels.concat(queryPivotLevels);var newLevels=$.grep(allLevels,function(e,i){return queryLevels.indexOf(e.qualifiedName)<0&&queryLevels.indexOf(e.qualifiedName.split("].[")[0]+"]")<0;});var otherAxisLevels=targetType=="DIMENSION"?queryPivotLevels:queryDimensionLevels;var invalidHierachies=_.uniq($.map(otherAxisLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));}));newLevels=$.grep(newLevels,function(e,i){return $.inArray(e.qualifiedName.split("].[")[0].substring(1),invalidHierachies)<0;});var newLevelsAsObjects=$.map(newLevels,function(e,i){var qn=e.qualifiedName;var qnParts=qn.split("].[");var h=qnParts[0].substring(1);var l=qnParts[1].substring(0,qnParts[1].length-1);var d=e.depth;return{hierarchy:h,level:l,qualifiedName:qn,depth:d};});var hierarchies=$.map(newLevelsAsObjects,function(e,i){return e.hierarchy;});hierarchies=_.uniq(hierarchies);hierarchies.sort(function(a,b){var aCaption=myself.olapCube.getCaption("["+a+"]");var bCaption=myself.olapCube.getCaption("["+b+"]");var comparison=0;if(aCaption<bCaption)
comparison=-1;else if(aCaption>bCaption)
comparison=1;return comparison;});var menuMatrix=[];$.each(newLevelsAsObjects,function(i,v){var h=v.hierarchy;var l=v.level;var qn=v.qualifiedName;var d=v.depth;if(menuMatrix[h]==undefined)
menuMatrix[h]=[];menuMatrix[h].push({name:l,qualifiedName:qn,depth:d});});var axisLevels=targetType=="DIMENSION"?myself.query.getDimensionQualifiedNames():myself.query.getPivotDimensionQualifiedNames();var axisHierarchies=$.map(axisLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));});var extremeHierarchyLevels=myself.getExtremeLevelsInHierarchyInAxis(targetLevel,axisLevels);menu.add={name:$.i18n.prop("menu_item_add"),items:{},disabled:newLevelsAsObjects.length==0};menu.change={name:$.i18n.prop("menu_item_change"),items:{},disabled:newLevelsAsObjects.length==0};menu.remove={name:$.i18n.prop("menu_item_remove"),disabled:!myself.query.isRemovable(targetLevel,targetType.substring(0,1)),callback:function(key,options){myself.query.remove(targetLevel,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();}};menu.filter={name:$.i18n.prop("menu_item_filter"),callback:function(key,options){myself.openFiltersSelectorPanel(targetLevel);}};var axisLetter=targetType=="DIMENSION"?"D":"M";var sortDirection=myself.query.getSortDirection(axisLetter,targetLevel);menu.sort={name:$.i18n.prop("menu_item_sort"),items:{asc:{name:$.i18n.prop("menu_item_sort_ascending"),items:{kasc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="ASC",callback:function(key,options){myself.query.sort(axisLetter,targetLevel,"ASC");Dashboards.getComponent(myself.properties.componentName).update();}},basc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BASC",callback:function(key,options){myself.query.sort(axisLetter,targetLevel,"BASC");Dashboards.getComponent(myself.properties.componentName).update();}}}},desc:{name:$.i18n.prop("menu_item_sort_descending"),items:{kdesc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="DESC",callback:function(key,options){myself.query.sort(axisLetter,targetLevel,"DESC");Dashboards.getComponent(myself.properties.componentName).update();}},bdesc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BDESC",callback:function(key,options){myself.query.sort(axisLetter,targetLevel,"BDESC");Dashboards.getComponent(myself.properties.componentName).update();}}}},clear:{name:$.i18n.prop("menu_item_sort_clear"),disabled:sortDirection=="",callback:function(key,options){myself.query.sort(axisLetter,"","");Dashboards.getComponent(myself.properties.componentName).update();}}}};$.each(hierarchies,function(i,hierarchy){var hierarchyCaption=myself.olapCube.getCaption("["+hierarchy+"]");menu.add.items["add-dim-"+i]={};menu.add.items["add-dim-"+i].name=hierarchyCaption;menu.add.items["add-dim-"+i].items={};menu.change.items["change-dim-"+i]={};menu.change.items["change-dim-"+i].name=hierarchyCaption;var levels=menuMatrix[hierarchy];if(levels.length==1&&myself.olapCube.getCaption(levels[0].qualifiedName)==hierarchyCaption&&levels[0].depth==1){var newLevel=levels[0].qualifiedName;if($.inArray(hierarchy,axisHierarchies)>-1){var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);menu.add.items["add-dim-"+i].callback=function(key,options){myself.query.add(newLevel,position.level,position.direction,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-dim-"+i].disabled=!myself.query.isReplaceable(newLevel,targetLevel,targetType.substring(0,1));menu.change.items["change-dim-"+i].callback=function(key,options){myself.query.replace(newLevel,targetLevel,position,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.add.items["add-dim-"+i].items["add-dim-"+i+"-before"]={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-before"].name=$.i18n.prop("menu_item_add_before");menu.add.items["add-dim-"+i].items["add-dim-"+i+"-before"].callback=function(key,options){myself.query.add(newLevel,extremeHierarchyLevels[0],-1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-after"]={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-after"].name=$.i18n.prop("menu_item_add_after");menu.add.items["add-dim-"+i].items["add-dim-"+i+"-after"].callback=function(key,options){myself.query.add(newLevel,extremeHierarchyLevels[1],1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-dim-"+i].disabled=!myself.query.isReplaceable(newLevel,targetLevel,targetType.substring(0,1));menu.change.items["change-dim-"+i].callback=function(key,options){myself.query.replace(newLevel,targetLevel,{level:extremeHierarchyLevels[1],direction:1},targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};}
if(targetHierarchy!=hierarchy&&$.inArray(targetLevel,extremeHierarchyLevels)<0)
menu.change.items["change-dim-"+i].disabled=true;}else{menu.change.items["change-dim-"+i].items={};$.each(levels,function(j,level){var newLevel=level.qualifiedName;var newLevelCaption=myself.olapCube.getCaption(newLevel);var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j]={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].name=newLevelCaption;menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j]={};menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j].name=newLevelCaption;if($.inArray(hierarchy,axisHierarchies)>-1){menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].callback=function(key,options){myself.query.add(newLevel,position.level,position.direction,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j].disabled=!myself.query.isReplaceable(newLevel,targetLevel,targetType.substring(0,1));menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j].callback=function(key,options){myself.query.replace(newLevel,targetLevel,position,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-before"]={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-before"].name=$.i18n.prop("menu_item_add_before");menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-before"].callback=function(key,options){myself.query.add(newLevel,extremeHierarchyLevels[0],-1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-after"]={};menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-after"].name=$.i18n.prop("menu_item_add_after");menu.add.items["add-dim-"+i].items["add-dim-"+i+"-"+j].items["add-dim-"+i+"-"+j+"-after"].callback=function(key,options){myself.query.add(newLevel,extremeHierarchyLevels[1],1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j].disabled=!myself.query.isReplaceable(newLevel,targetLevel,targetType.substring(0,1));menu.change.items["change-dim-"+i].items["change-dim-"+i+"-"+j].callback=function(key,options){myself.query.replace(newLevel,targetLevel,{level:extremeHierarchyLevels[1],direction:1},targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};}
if(targetHierarchy!=hierarchy&&$.inArray(targetLevel,extremeHierarchyLevels)<0)
menu.change.items["change-dim-"+i].disabled=true;});}});var countEnabled=0;if(menu.change.hasOwnProperty("items")){for(key in menu.change.items){if(!menu.change.items[key].disabled)
countEnabled++;}}
if(countEnabled==0)
menu.change.disabled=true;if(targetType=="DIMENSION"&&!hasMoC&&target.hasOwnProperty("index")){var items=myself.buildDrillMenu();var disabled=$.isEmptyObject(items)?true:false;menu.drillsep="---";menu.drill={name:$.i18n.prop("menu_item_drill_column"),items:items,disabled:disabled};}}
else if(targetType=="MEASURE"||targetType=="MEASURES_LEVEL"){if(targetType=="MEASURE"){var allMeasures=myself.olapCube.getStructure().measures;var queryMeasures=myself.query.getMeasureQualifiedNames();var newMeasures=$.grep(allMeasures,function(e,i){return queryMeasures.indexOf(e.qualifiedName)<0;});newMeasures.sort(function(a,b){var comparison=0;if(a.caption<b.caption)
comparison=-1;else if(a.caption>b.caption)
comparison=1;return comparison;});menu.add={name:$.i18n.prop("menu_item_add"),items:{},disabled:newMeasures.length==0};menu.change={name:$.i18n.prop("menu_item_change"),items:{},disabled:newMeasures.length==0};menu.remove={name:$.i18n.prop("menu_item_remove"),disabled:queryMeasures.length==1,callback:function(key,options){myself.query.remove(targetLevel,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();}};$.each(newMeasures,function(i,v){menu.add.items["add-kpi-"+i]={};menu.add.items["add-kpi-"+i].name=v.caption;menu.add.items["add-kpi-"+i].items={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"]={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"].name=$.i18n.prop("menu_item_add_before");menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"].callback=function(key,options){myself.query.add(v.qualifiedName,targetLevel,-1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"]={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"].name=$.i18n.prop("menu_item_add_after");menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"].callback=function(key,options){myself.query.add(v.qualifiedName,targetLevel,1,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-kpi-"+i]={};menu.change.items["change-kpi-"+i].name=v.caption;menu.change.items["change-kpi-"+i].callback=function(key,options){myself.query.replace(v.qualifiedName,targetLevel,null,targetType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};});var sortDirection=myself.query.getSortDirection("D",targetLevel);menu.sort={name:$.i18n.prop("menu_item_sort"),items:{asc:{name:$.i18n.prop("menu_item_sort_ascending"),items:{kasc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="ASC",callback:function(key,options){myself.query.sort("D",targetLevel,"ASC");Dashboards.getComponent(myself.properties.componentName).update();}},basc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BASC",callback:function(key,options){myself.query.sort("D",targetLevel,"BASC");Dashboards.getComponent(myself.properties.componentName).update();}}}},desc:{name:$.i18n.prop("menu_item_sort_descending"),items:{kdesc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="DESC",callback:function(key,options){myself.query.sort("D",targetLevel,"DESC");Dashboards.getComponent(myself.properties.componentName).update();}},bdesc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BDESC",callback:function(key,options){myself.query.sort("D",targetLevel,"BDESC");Dashboards.getComponent(myself.properties.componentName).update();}}}},clear:{name:$.i18n.prop("menu_item_sort_clear"),disabled:sortDirection=="",callback:function(key,options){myself.query.sort("D","","");Dashboards.getComponent(myself.properties.componentName).update();}}}};}
menu.pivot={name:$.i18n.prop("menu_item_pivot"),items:{}};var allLevels=myself.olapCube.getLevels();var queryDimensionLevels=myself.query.getDimensionQualifiedNames();var queryPivotLevels=myself.query.getPivotDimensionQualifiedNames();var queryLevels=queryDimensionLevels.concat(queryPivotLevels);var newLevels=$.grep(allLevels,function(e,i){return queryLevels.indexOf(e.qualifiedName)<0&&queryLevels.indexOf(e.qualifiedName.split("].[")[0]+"]")<0;});var invalidHierachies=_.uniq($.map(queryDimensionLevels,function(e,i){return e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1);}));newLevels=$.grep(newLevels,function(e,i){return $.inArray(e.qualifiedName.split("].[")[0].substring(1),invalidHierachies)<0;});var newLevelsAsObjects=$.map(newLevels,function(e,i){var qn=e.qualifiedName;var qnParts=qn.split("].[");var h=qnParts[0].substring(1);var l=qnParts[1].substring(0,qnParts[1].length-1);var d=e.depth;return{hierarchy:h,level:l,qualifiedName:qn,depth:d};});var hierarchies=$.map(newLevelsAsObjects,function(e,i){return e.hierarchy;});hierarchies=_.uniq(hierarchies);hierarchies.sort(function(a,b){var aCaption=myself.olapCube.getCaption("["+a+"]");var bCaption=myself.olapCube.getCaption("["+b+"]");var comparison=0;if(aCaption<bCaption)
comparison=-1;else if(aCaption>bCaption)
comparison=1;return comparison;});var menuMatrix=[];$.each(newLevelsAsObjects,function(i,v){var h=v.hierarchy;var l=v.level;var qn=v.qualifiedName;var d=v.depth;if(menuMatrix[h]==undefined)
menuMatrix[h]=[];menuMatrix[h].push({name:l,qualifiedName:qn,depth:d});});var axisLevels=myself.query.getPivotDimensionQualifiedNames();var axisHierarchies=$.map(axisLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));});$.each(hierarchies,function(i,hierarchy){var hierarchyCaption=myself.olapCube.getCaption("["+hierarchy+"]");menu.pivot.items["add-pivot-"+i]={};menu.pivot.items["add-pivot-"+i].name=hierarchyCaption;menu.pivot.items["add-pivot-"+i].items={};var levels=menuMatrix[hierarchy];if(levels.length==1&&myself.olapCube.getCaption(levels[0].qualifiedName)==hierarchyCaption&&levels[0].depth==1){var newLevel=levels[0].qualifiedName;if($.inArray(hierarchy,axisHierarchies)>-1){menu.pivot.items["add-pivot-"+i].callback=function(key,options){var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);myself.query.add(newLevel,position.level,position.direction,"P");Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"].name=$.i18n.prop("menu_item_add_before");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",-1,"P");Dashboards.getComponent(myself.properties.componentName).update();};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"].name=$.i18n.prop("menu_item_add_after");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",1,"P");Dashboards.getComponent(myself.properties.componentName).update();};}}else{$.each(levels,function(j,level){var newLevel=level.qualifiedName;var newLevelCaption=myself.olapCube.getCaption(newLevel);menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].name=newLevelCaption;if($.inArray(hierarchy,axisHierarchies)>-1){var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].callback=function(key,options){myself.query.add(newLevel,position.level,position.direction,"P");Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"].name=$.i18n.prop("menu_item_add_before");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",-1,"P");Dashboards.getComponent(myself.properties.componentName).update();};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"].name=$.i18n.prop("menu_item_add_after");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",1,"P");Dashboards.getComponent(myself.properties.componentName).update();};}});}});}
menu.filterssep="---";menu.filters={name:$.i18n.prop("menu_item_filters_manager"),callback:function(key,options){myself.openFiltersSelectorPanel("");}};menu.toggleFilters={name:myself.properties.showFilters?$.i18n.prop("menu_item_hide_filters_and_sorts"):$.i18n.prop("menu_item_show_filters_and_sorts"),callback:function(){myself.properties.showFilters=!myself.properties.showFilters;$("#"+myself.properties.filtersPanelHtmlObject).toggle();}};menu.settingssep="---";var settingsMenu=myself.buildSettingsMenu();menu.settings={name:$.i18n.prop("menu_item_table_settings"),items:settingsMenu.items};menu.mdx={name:$.i18n.prop("menu_item_show_mdx"),callback:function(key,options){var html="<div class='mdxPanel'>"+Dashboards.getParameterValue(myself.properties.componentName.replace("render_","")+"MdxQuery")+"</div>";$.fancybox(html,{'autoDimensions':true,'overlayShow':true,'hideOnOverlayClick':false,'hideOnContentClick':false,'enableEscapeButton':false,'showCloseButton':true,});}}
menu.reset={name:$.i18n.prop("menu_item_reset"),callback:function(){myself.query.reset();Dashboards.getComponent(myself.properties.componentName).update();}};menu.filesep="---";var openMenu=myself.buildOpenMenu();menu.open={name:$.i18n.prop("menu_item_open"),items:openMenu.items};var fileMenu=myself.buildFileMenu();menu.file={name:$.i18n.prop("menu_item_file"),items:fileMenu.items};menu.export2excel={name:$.i18n.prop("menu_item_export_to_excel"),callback:function(key,options){myself.exportToExcel();}};return{callback:function(key,options){if(targetType=="DIMENSION"&&!hasMoC&&target.hasOwnProperty("index")){var measures=myself.query.getMeasures();var pivotDimensions=myself.query.getPivotDimensions();var queryFilters=myself.query.getFilters();var dimensions=$.grep(queryFilters,function(f){var qn=f[0];return qn==key||qn.split("].[")[0]==key.split("].[")[0];});var filters=$.grep(queryFilters,function(f){return f[0].split("].[")[0]!=key.split("].[")[0];});var pivotDimensionQualifiedNames=myself.query.getPivotDimensionQualifiedNames();var count=pivotDimensionQualifiedNames.length;if($.inArray("MEASURES",pivotDimensionQualifiedNames)<0)
count++;var index=myself.properties.hideSpans?target.index:(target.index+count);if(headers.length==1){index=target.index;}
var cdaHeaderParts=normalizedCdaResult.metadata[index].colName.split("]/[");var length=cdaHeaderParts.length;if(length>1){cdaHeaderParts[0]+="]";for(i=1;i<length-1;i++){cdaHeaderParts[i]="["+cdaHeaderParts[i]+"]";}
cdaHeaderParts[length-1]="["+cdaHeaderParts[length-1];}
var dimensionQualifiedNames=myself.query.getDimensionQualifiedNames();var ht=new Array();var levelQualifiedNames=dimensionQualifiedNames.slice().reverse();var previousHierarchy="";var maxLevelDepth=1;for(i=0;i<levelQualifiedNames.length;i++){var levelQualifiedName=levelQualifiedNames[i];var hierarchy=levelQualifiedName.split("].[")[0].substring(1);if(levelQualifiedName.indexOf("].[")<0)
hierarchy=hierarchy.substring(0,hierarchy.length-1);var index=-1;$.each(cdaHeaderParts,function(j,w){if(w.indexOf("["+hierarchy+"]")>-1||w.indexOf("["+hierarchy+"."+hierarchy+"]")>-1){index=j;return;}});ht[levelQualifiedName]="";if(index>=0){var member=cdaHeaderParts[0];if(cdaHeaderParts.length>1||(member!="[Measures].[MeasuresLevel]"&&$.inArray(member,pivotDimensionQualifiedNames)<0)){var memberUniqueNameParts=cdaHeaderParts[index].split("].[").reverse();member=memberUniqueNameParts[0];member=member.substring(0,member.length-1);if(hierarchy==previousHierarchy&&member!="BT_TOTAL"){member=memberUniqueNameParts[maxLevelDepth-myself.olapCube.getLevelDepth(levelQualifiedName)];}}
ht[levelQualifiedName]=member;if(hierarchy!=previousHierarchy){previousHierarchy=hierarchy;maxLevelDepth=myself.olapCube.getLevelDepth(levelQualifiedName);}}}
if(dimensions.length==0){var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dimensionQualifiedNames,function(i,v){var el=[v,"include:["+ht[v]+"]"];if(v.split("].[")[0]!=key.split("].[")[0])
filters.push(el);else{if(myself.olapCube.getLevelDepth(v)<keyDepth)
leftArr.push(el);else
rightArr.push(el);}});dimensions=leftArr.concat([[key,""]],rightArr);}
else{$.each(dimensionQualifiedNames,function(i,v){filters.push([v,"include:["+ht[v]+"]"]);});var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dimensions,function(i,v){var qn=v[0];if(myself.olapCube.getLevelDepth(qn)<keyDepth)
leftArr.push(v);else
rightArr.push(v);});dimensions=leftArr.concat([[key,""]],rightArr);}
var currentDimensions=myself.query.getDimensions();$.each(dimensions,function(i,v){var qn=v[0];if(v[1].indexOf("BT_TOTAL")>-1||v[1].indexOf("undefined")>-1){var d=$.grep(currentDimensions,function(e){return e[0]==qn;});v[1]=d[0][1];}});$.each(filters,function(i,v){var qn=v[0];if(v[1].indexOf("BT_TOTAL")>-1||v[1].indexOf("undefined")>-1){var d=$.grep(currentDimensions,function(e){return e[0]==qn;});v[1]=d[0][1];}});var querySetting=myself.query.getSettings();var BTableDrillProp={};BTableDrillProp.catalog=myself.properties.catalog;BTableDrillProp.jndi=myself.properties.jndi;BTableDrillProp.cube=myself.query.getCube();BTableDrillProp.dimensions=dimensions;BTableDrillProp.measures=measures;BTableDrillProp.pivotDimensions=pivotDimensions;BTableDrillProp.filters=filters;BTableDrillProp.measuresOnColumns=querySetting.measuresOnColumns;BTableDrillProp.nonEmptyRows=querySetting.nonEmpty.rows;BTableDrillProp.nonEmptyColumns=querySetting.nonEmpty.columns;BTableDrillProp.grandTotal=querySetting.summary.grandTotal;BTableDrillProp.subTotals=querySetting.summary.subTotals;BTableDrillProp.pivotGrandTotal=querySetting.summary.pivotGrandTotal;BTableDrillProp.pivotSubTotals=querySetting.summary.pivotSubTotals;BTableDrillProp.totalsPosition=querySetting.summary.position;BTableDrillProp.hideSpans=myself.properties.hideSpans;BTableDrillProp.drillTarget=myself.properties.drillTarget;var urlQuery=getURLQuery();var url=bt.helpers.general.getRenderServiceUrl()+"?";url+="btdef="+encodeURIComponent(JSON.stringify(BTableDrillProp));url+=(urlQuery.hasOwnProperty("debug")&&urlQuery.debug=="true")?"&debug=true":"";if(myself.properties.drillTarget=="SELF")
window.open(url,"_self");else if(myself.properties.drillTarget=="NEW_TAB"&&typeof top.mantle_openTab!=="undefined")
top.mantle_openTab("BTable","BTable",url);else
window.open(url,"_blank");}else{Dashboards.getComponent(myself.properties.componentName).update();}},items:menu};};myself.buildSettingsMenu=function(){var menu={};var settings=myself.query.getSettings();menu.items={nonEmptyCol:{name:$.i18n.prop("menu_item_table_settings_non_empty_columns"),type:'checkbox',selected:settings.nonEmpty.columns,events:{click:function(e){myself.query.set({nonEmpty:{columns:!settings.nonEmpty.columns}});}}},nonEmptyRow:{name:$.i18n.prop("menu_item_table_settings_non_empty_rows"),type:'checkbox',selected:settings.nonEmpty.rows,events:{click:function(e){myself.query.set({nonEmpty:{rows:!settings.nonEmpty.rows}});}}},sep1:"---------",grandTotal:{name:$.i18n.prop("menu_item_table_settings_grand_total"),type:'checkbox',selected:settings.summary.grandTotal,events:{click:function(e){myself.query.set({summary:{grandTotal:!settings.summary.grandTotal}});}}},subtotals:{name:$.i18n.prop("menu_item_table_settings_subtotals"),type:'checkbox',selected:settings.summary.subTotals,events:{click:function(e){myself.query.set({summary:{subTotals:!settings.summary.subTotals}});}}},pivotGrandTotal:{name:$.i18n.prop("menu_item_table_settings_pivot_grand_total"),type:'checkbox',selected:settings.summary.pivotGrandTotal,events:{click:function(e){myself.query.set({summary:{pivotGrandTotal:!settings.summary.pivotGrandTotal}});}}},pivotSubtotals:{name:$.i18n.prop("menu_item_table_settings_pivot_subtotals"),type:'checkbox',selected:settings.summary.pivotSubTotals,events:{click:function(e){myself.query.set({summary:{pivotSubTotals:!settings.summary.pivotSubTotals}});}}},sep2:"---------",measuresOnColumns:{name:$.i18n.prop("menu_item_table_settings_measures_on_columns"),type:'radio',radio:'swap_axis',value:'true',selected:settings.measuresOnColumns,events:{click:function(e){myself.query.set({measuresOnColumns:true});}}},measuresOnRows:{name:$.i18n.prop("menu_item_table_settings_measures_on_rows"),type:'radio',radio:'swap_axis',value:'false',selected:!settings.measuresOnColumns,events:{click:function(e){myself.query.set({measuresOnColumns:false});}}},sep3:"---------",hideSpans:{name:$.i18n.prop("menu_item_table_settings_hide_spans"),type:'checkbox',selected:myself.properties.hideSpans,events:{click:function(e){myself.properties.hideSpans=!myself.properties.hideSpans;}}},fixedHeader:{name:$.i18n.prop("menu_item_table_settings_fixed_header"),type:'checkbox',selected:myself.properties.fixedHeader,events:{click:function(e){myself.properties.fixedHeader=!myself.properties.fixedHeader;}}},sep4:"---------",apply:{name:$.i18n.prop("menu_item_table_settings_apply_changes"),callback:function(){Dashboards.getComponent(myself.properties.componentName).update();}}};menu.items.sep5="---------";if(myself.properties.renderDashboard){menu.items.drillHere={name:$.i18n.prop("menu_item_table_settings_drill_here"),type:'radio',radio:'drill_target',value:'SELF',selected:myself.properties.drillTarget=="SELF",events:{click:function(e){myself.properties.drillTarget="SELF";}}};}
if(typeof top.mantle_openTab!=="undefined"){menu.items.drillInNewTab={name:$.i18n.prop("menu_item_table_settings_drill_in_new_tab"),type:'radio',radio:'drill_target',value:'NEW_TAB',selected:myself.properties.drillTarget=="NEW_TAB",events:{click:function(e){myself.properties.drillTarget="NEW_TAB";}}};}
menu.items.drillInNewWindow={name:$.i18n.prop("menu_item_table_settings_drill_in_new_window"),type:'radio',radio:'drill_target',value:'NEW_WINDOW',selected:myself.properties.drillTarget=="NEW_WINDOW",events:{click:function(e){myself.properties.drillTarget="NEW_WINDOW";}}};return menu;}
myself.buildBodyContextMenu=function(state){var hasMoC=myself.query.hasMeasuresOnColumns();var rawData=state.rawData;var tableData=state.tableData;var colIdx=state.colIdx;var rowIdx=state.rowIdx;var row=rawData.resultset[rowIdx];var column=rawData.metadata[colIdx].colName;var value=rawData.resultset[rowIdx][colIdx];var menu={};var menuType="";if(column.indexOf("[Measures]")<0){if($.inArray(column,myself.query.getPivotDimensionQualifiedNames())>-1)
menuType="MEMBER_MENU";else
menuType=hasMoC?"DRILL_ROW_MENU":"DRILL_CELL_MENU";}else{menuType=hasMoC?"DRILL_CELL_MENU":"MEASURE_MENU";}
var btRef={};if(menuType=="MEASURE_MENU"){btRef.level="[Measures].["+value+"]",btRef.member=value}
else if(menuType=="DRILL_ROW_MENU"||menuType=="MEMBER_MENU"){btRef.level=column,btRef.member=value}
else if(menuType=="DRILL_CELL_MENU"){var measureLevel="";if(hasMoC){var parts=column.split("]/[");$.each(parts,function(i,v){if(v.indexOf("Measures].[")>-1){measureLevel=("["+v+"]").replace("[[","[").replace("]]","]");return;}});}
else{var measuresIdx=$.inArray("[Measures].[MeasuresLevel]",$.map(rawData.metadata,function(e){return e.colName;}));measureLevel=myself.olapCube.getQualifiedNameByCaption(tableData[rowIdx][measuresIdx],"L");}
btRef.level=measureLevel,btRef.member=value}
if(value==null)
menuType="MEMBER_MENU";if(menuType=="DRILL_ROW_MENU"){var dimensions=myself.query.getDimensionQualifiedNames();if(btRef.level!=dimensions[dimensions.length-1])
menuType="MEMBER_MENU";}
var title=myself.getMenuTitle(btRef);menu.title={name:"<strong>"+title+"</strong>",callback:function(key,options){}};menu.titlesep="---";if(menuType=="MEASURE_MENU"){var allMeasures=myself.olapCube.getStructure().measures;var queryMeasures=myself.query.getMeasureQualifiedNames();var newMeasures=$.grep(allMeasures,function(e,i){return queryMeasures.indexOf(e.qualifiedName)<0;});newMeasures.sort(function(a,b){var comparison=0;if(a.caption<b.caption)
comparison=-1;else if(a.caption>b.caption)
comparison=1;return comparison;});menu.add={name:$.i18n.prop("menu_item_add"),items:{},disabled:newMeasures.length==0};menu.change={name:$.i18n.prop("menu_item_change"),items:{},disabled:newMeasures.length==0};menu.remove={name:$.i18n.prop("menu_item_remove"),disabled:queryMeasures.length==1,callback:function(key,options){myself.query.remove(btRef.level,menuType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();}};$.each(newMeasures,function(i,v){menu.add.items["add-kpi-"+i]={};menu.add.items["add-kpi-"+i].name=v.caption;menu.add.items["add-kpi-"+i].items={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"]={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"].name=$.i18n.prop("menu_item_add_before");menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-before"].callback=function(key,options){myself.query.add(v.qualifiedName,btRef.level,-1,menuType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"]={};menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"].name=$.i18n.prop("menu_item_add_after");menu.add.items["add-kpi-"+i].items["add-kpi-"+i+"-after"].callback=function(key,options){myself.query.add(v.qualifiedName,btRef.level,1,menuType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};menu.change.items["change-kpi-"+i]={};menu.change.items["change-kpi-"+i].name=v.caption;menu.change.items["change-kpi-"+i].callback=function(key,options){myself.query.replace(v.qualifiedName,btRef.level,null,menuType.substring(0,1));Dashboards.getComponent(myself.properties.componentName).update();};});var sortDirection=myself.query.getSortDirection("D",btRef.level);menu.sort={name:$.i18n.prop("menu_item_sort"),items:{asc:{name:$.i18n.prop("menu_item_sort_ascending"),items:{kasc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="ASC",callback:function(key,options){myself.query.sort("D",btRef.level,"ASC");Dashboards.getComponent(myself.properties.componentName).update();}},basc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BASC",callback:function(key,options){myself.query.sort("D",btRef.level,"BASC");Dashboards.getComponent(myself.properties.componentName).update();}}}},desc:{name:$.i18n.prop("menu_item_sort_descending"),items:{kdesc:{name:$.i18n.prop("menu_item_sort_keep_hierarchy"),disabled:sortDirection=="DESC",callback:function(key,options){myself.query.sort("D",btRef.level,"DESC");Dashboards.getComponent(myself.properties.componentName).update();}},bdesc:{name:$.i18n.prop("menu_item_sort_break_hierarchy"),disabled:sortDirection=="BDESC",callback:function(key,options){myself.query.sort("D",btRef.level,"BDESC");Dashboards.getComponent(myself.properties.componentName).update();}}}},clear:{name:$.i18n.prop("menu_item_sort_clear"),disabled:sortDirection=="",callback:function(key,options){myself.query.sort("D","","");Dashboards.getComponent(myself.properties.componentName).update();}}}};menu.pivot={name:$.i18n.prop("menu_item_pivot"),items:{}};var allLevels=myself.olapCube.getLevels();var queryDimensionLevels=myself.query.getDimensionQualifiedNames();var queryPivotLevels=myself.query.getPivotDimensionQualifiedNames();var queryLevels=queryDimensionLevels.concat(queryPivotLevels);var newLevels=$.grep(allLevels,function(e,i){return queryLevels.indexOf(e.qualifiedName)<0&&queryLevels.indexOf(e.qualifiedName.split("].[")[0]+"]")<0;});var invalidHierachies=_.uniq($.map(queryDimensionLevels,function(e,i){return e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1);}));newLevels=$.grep(newLevels,function(e,i){return $.inArray(e.qualifiedName.split("].[")[0].substring(1),invalidHierachies)<0;});var newLevelsAsObjects=$.map(newLevels,function(e,i){var qn=e.qualifiedName;var qnParts=qn.split("].[");var h=qnParts[0].substring(1);var l=qnParts[1].substring(0,qnParts[1].length-1);return{hierarchy:h,level:l,qualifiedName:qn};});var hierarchies=$.map(newLevelsAsObjects,function(e,i){return e.hierarchy;});hierarchies=_.uniq(hierarchies);hierarchies.sort(function(a,b){var aCaption=myself.olapCube.getCaption("["+a+"]");var bCaption=myself.olapCube.getCaption("["+b+"]");var comparison=0;if(aCaption<bCaption)
comparison=-1;else if(aCaption>bCaption)
comparison=1;return comparison;});var menuMatrix=[];$.each(newLevelsAsObjects,function(i,v){var h=v.hierarchy;var l=v.level;var qn=v.qualifiedName;if(menuMatrix[h]==undefined)
menuMatrix[h]=[];menuMatrix[h].push({name:l,qualifiedName:qn});});var axisLevels=myself.query.getPivotDimensionQualifiedNames();var axisHierarchies=$.map(axisLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));});$.each(hierarchies,function(i,hierarchy){var hierarchyCaption=myself.olapCube.getCaption("["+hierarchy+"]");menu.pivot.items["add-pivot-"+i]={};menu.pivot.items["add-pivot-"+i].name=hierarchyCaption;menu.pivot.items["add-pivot-"+i].items={};var levels=menuMatrix[hierarchy];if(levels.length==1&&myself.olapCube.getCaption(levels[0].qualifiedName)==hierarchyCaption){var newLevel=levels[0].qualifiedName;if($.inArray(hierarchy,axisHierarchies)>-1){menu.pivot.items["add-pivot-"+i].callback=function(key,options){var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);myself.query.add(newLevel,position.level,position.direction,"P");Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"].name=$.i18n.prop("menu_item_add_before");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-before"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",-1,"P");Dashboards.getComponent(myself.properties.componentName).update();};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"].name=$.i18n.prop("menu_item_add_after");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-after"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",1,"P");Dashboards.getComponent(myself.properties.componentName).update();};}}else{$.each(levels,function(j,level){var newLevel=level.qualifiedName;var newLevelCaption=myself.olapCube.getCaption(newLevel);menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].name=newLevelCaption;if($.inArray(hierarchy,axisHierarchies)>-1){menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].callback=function(key,options){var position=myself.getPositionInHierarchyInAxis(newLevel,axisLevels);myself.query.add(newLevel,position.level,position.direction,"P");Dashboards.getComponent(myself.properties.componentName).update();};}else{menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"].name=$.i18n.prop("menu_item_add_before");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-before"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",-1,"P");Dashboards.getComponent(myself.properties.componentName).update();};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"]={};menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"].name=$.i18n.prop("menu_item_add_after");menu.pivot.items["add-pivot-"+i].items["add-pivot-"+i+"-"+j].items["add-pivot-"+i+"-"+j+"-after"].callback=function(key,options){myself.query.add(newLevel,"MEASURES",1,"P");Dashboards.getComponent(myself.properties.componentName).update();};}});}});}
else if(menuType=="DRILL_ROW_MENU"){var items=myself.buildDrillMenu();var disabled=$.isEmptyObject(items)?true:false;menu.drill={name:$.i18n.prop("menu_item_drill_row"),items:items,disabled:disabled};}
else if(menuType=="DRILL_CELL_MENU"){var items=myself.buildDrillMenu();var disabled=$.isEmptyObject(items)?true:false;menu.drill={name:$.i18n.prop("menu_item_drill_cell"),items:items,disabled:disabled};}
if(menuType!="MEMBER_MENU")
menu.filterssep="---";menu.filters={name:$.i18n.prop("menu_item_filters_manager"),callback:function(key,options){myself.openFiltersSelectorPanel("");}};menu.toggleFilters={name:myself.properties.showFilters?$.i18n.prop("menu_item_hide_filters_and_sorts"):$.i18n.prop("menu_item_show_filters_and_sorts"),callback:function(){myself.properties.showFilters=!myself.properties.showFilters;$("#"+myself.properties.filtersPanelHtmlObject).toggle();}};menu.settingssep="---";var settingsMenu=myself.buildSettingsMenu();menu.settings={name:$.i18n.prop("menu_item_table_settings"),items:settingsMenu.items};menu.mdx={name:$.i18n.prop("menu_item_show_mdx"),callback:function(key,options){var html="<div class='mdxPanel'>"+Dashboards.getParameterValue(myself.properties.componentName.replace("render_","")+"MdxQuery")+"</div>";$.fancybox(html,{'autoDimensions':true,'overlayShow':true,'hideOnOverlayClick':false,'hideOnContentClick':false,'enableEscapeButton':false,'showCloseButton':true,});}}
menu.reset={name:$.i18n.prop("menu_item_reset"),callback:function(){myself.query.reset();Dashboards.getComponent(myself.properties.componentName).update();}};menu.filesep="---";var openMenu=myself.buildOpenMenu();menu.open={name:$.i18n.prop("menu_item_open"),items:openMenu.items};var fileMenu=myself.buildFileMenu();menu.file={name:$.i18n.prop("menu_item_file"),items:fileMenu.items};menu.export2excel={name:$.i18n.prop("menu_item_export_to_excel"),callback:function(key,options){myself.exportToExcel();}};return{callback:function(key,options){var drillCell=menuType=="DRILL_CELL_MENU";var measures=myself.query.getMeasures();if(drillCell){if(hasMoC){measures=$.grep(measures,function(m){return column.indexOf(m[0])>-1;});}else{var measuresLevelIdx=0;$.each(rawData.metadata,function(i,v){if(v.colName=="[Measures].[MeasuresLevel]"){measuresLevelIdx=i;return;}});measures=$.grep(measures,function(m){return m[0]==myself.olapCube.getQualifiedNameByCaption(row[measuresLevelIdx],"L");});}}
var pivotDimensions=[];if(drillCell){var pivotQualifiedNames=$.grep(myself.query.getPivotDimensionQualifiedNames(),function(e){return e!="MEASURES";});if(hasMoC){var cdaHeaderParts=column.split("]/[");var length=cdaHeaderParts.length;if(length>1){cdaHeaderParts[0]+="]";for(i=1;i<length-1;i++){cdaHeaderParts[i]="["+cdaHeaderParts[i]+"]";}
cdaHeaderParts[length-1]="["+cdaHeaderParts[length-1];}
var ht=new Array();var levelQualifiedNames=pivotQualifiedNames.slice().reverse();var previousHierarchy="";var maxLevelDepth=1;for(i=0;i<levelQualifiedNames.length;i++){var levelQualifiedName=levelQualifiedNames[i];var hierarchy=levelQualifiedName.split("].[")[0].substring(1);if(levelQualifiedName.indexOf("].[")<0)
hierarchy=hierarchy.substring(0,hierarchy.length-1);var index=-1;$.each(cdaHeaderParts,function(j,w){if(w.indexOf("["+hierarchy+"]")>-1||w.indexOf("["+hierarchy+"."+hierarchy+"]")>-1){index=j;return;}});ht[levelQualifiedName]="";if(index>=0){var member=cdaHeaderParts[0];if(cdaHeaderParts.length>1||(member!="[Measures].[MeasuresLevel]"&&$.inArray(member,pivotDimensionQualifiedNames)<0)){var memberUniqueNameParts=cdaHeaderParts[index].split("].[").reverse();member=memberUniqueNameParts[0];member=member.substring(0,member.length-1);if(hierarchy==previousHierarchy){member=memberUniqueNameParts[maxLevelDepth-myself.olapCube.getLevelDepth(levelQualifiedName)];}}
ht[levelQualifiedName]=member;if(hierarchy!=previousHierarchy){previousHierarchy=hierarchy;maxLevelDepth=myself.olapCube.getLevelDepth(levelQualifiedName);}}}
$.each(pivotQualifiedNames,function(i,v){pivotDimensions.push([v,"include:["+ht[v]+"]"]);});}else{$.each(pivotQualifiedNames,function(i,v){var idx=$.inArray(v,$.map(rawData.metadata,function(e){return e.colName}));pivotDimensions.push([v,"include:["+row[idx]+"]"]);});}
var pivotMeasuresIdx=myself.query.getPivotDimensionQualifiedNames().indexOf("MEASURES");if(pivotMeasuresIdx>=0)
pivotDimensions.splice(pivotMeasuresIdx,0,["MEASURES",""]);}else{pivotDimensions=myself.query.getPivotDimensions();}
var queryFilters=myself.query.getFilters();var dimensions=$.grep(queryFilters,function(f){var qn=f[0];return qn==key||qn.split("].[")[0]==key.split("].[")[0];});var filters=$.grep(queryFilters,function(f){return f[0].split("].[")[0]!=key.split("].[")[0];});if(hasMoC){var dims=myself.query.getDimensionQualifiedNames();if(dimensions.length==0){var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dims,function(i,v){var idx=-1;$.each($.map(rawData.metadata,function(e){return e.colName}),function(j,w){if(w.indexOf(v)>-1){idx=j;return;}});var el=[v,"include:["+row[idx]+"]"];if(v.split("].[")[0]!=key.split("].[")[0])
filters.push(el);else{if(myself.olapCube.getLevelDepth(v)<keyDepth)
leftArr.push(el);else
rightArr.push(el);}});dimensions=leftArr.concat([[key,""]],rightArr);}
else{$.each(dims,function(i,v){var idx=-1;$.each($.map(rawData.metadata,function(e){return e.colName}),function(j,w){if(w.indexOf(v)>-1){idx=j;return;}});var filter=[v,"include:["+row[idx]+"]"];filters.push(filter);});var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dimensions,function(i,v){var qn=v[0];if(myself.olapCube.getLevelDepth(qn)<keyDepth)
leftArr.push(v);else
rightArr.push(v);});dimensions=leftArr.concat([[key,""]],rightArr);}}else{var cdaHeaderParts=column.split("]/[");var length=cdaHeaderParts.length;if(length>1){cdaHeaderParts[0]+="]";for(i=1;i<length-1;i++){cdaHeaderParts[i]="["+cdaHeaderParts[i]+"]";}
cdaHeaderParts[length-1]="["+cdaHeaderParts[length-1];}
var dimensionQualifiedNames=myself.query.getDimensionQualifiedNames();var ht=new Array();var levelQualifiedNames=dimensionQualifiedNames.slice().reverse();var previousHierarchy="";var maxLevelDepth=1;for(i=0;i<levelQualifiedNames.length;i++){var levelQualifiedName=levelQualifiedNames[i];var hierarchy=levelQualifiedName.split("].[")[0].substring(1);if(levelQualifiedName.indexOf("].[")<0)
hierarchy=hierarchy.substring(0,hierarchy.length-1);var index=-1;$.each(cdaHeaderParts,function(j,w){if(w.indexOf("["+hierarchy+"]")>-1||w.indexOf("["+hierarchy+"."+hierarchy+"]")>-1){index=j;return;}});ht[levelQualifiedName]="";if(index>=0){var member=cdaHeaderParts[0];if(cdaHeaderParts.length>1||(member!="[Measures].[MeasuresLevel]"&&$.inArray(member,myself.query.getPivotDimensionQualifiedNames())<0)){var memberUniqueNameParts=cdaHeaderParts[index].split("].[").reverse();member=memberUniqueNameParts[0];member=member.substring(0,member.length-1);if(hierarchy==previousHierarchy&&member!="BT_TOTAL"){member=memberUniqueNameParts[maxLevelDepth-myself.olapCube.getLevelDepth(levelQualifiedName)];}}
ht[levelQualifiedName]=member;if(hierarchy!=previousHierarchy){previousHierarchy=hierarchy;maxLevelDepth=myself.olapCube.getLevelDepth(levelQualifiedName);}}}
if(dimensions.length==0){var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dimensionQualifiedNames,function(i,v){var el=[v,"include:["+ht[v]+"]"];if(v.split("].[")[0]!=key.split("].[")[0])
filters.push(el);else{if(myself.olapCube.getLevelDepth(v)<keyDepth)
leftArr.push(el);else
rightArr.push(el);}});dimensions=leftArr.concat([[key,""]],rightArr);}
else{$.each(dimensionQualifiedNames,function(i,v){filters.push([v,"include:["+ht[v]+"]"]);});var keyDepth=myself.olapCube.getLevelDepth(key);var leftArr=[];var rightArr=[];$.each(dimensions,function(i,v){var qn=v[0];if(myself.olapCube.getLevelDepth(qn)<keyDepth)
leftArr.push(v);else
rightArr.push(v);});dimensions=leftArr.concat([[key,""]],rightArr);}}
var currentDimensions=myself.query.getDimensions();$.each(dimensions,function(i,v){var qn=v[0];if(v[1].indexOf("BT_TOTAL")>-1||v[1].indexOf("undefined")>-1){var d=$.grep(currentDimensions,function(e){return e[0]==qn;});v[1]=d[0][1];}});var currentPivotDimensions=myself.query.getPivotDimensions();$.each(pivotDimensions,function(i,v){var qn=v[0];if(v[1].indexOf("BT_TOTAL")>-1||v[1].indexOf("undefined")>-1){var d=$.grep(currentPivotDimensions,function(e){return e[0]==qn;});v[1]=d[0][1];}});var currentAllDimensions=currentDimensions.concat(currentPivotDimensions);$.each(filters,function(i,v){var qn=v[0];if(v[1].indexOf("BT_TOTAL")>-1||v[1].indexOf("undefined")>-1){var d=$.grep(currentAllDimensions,function(e){return e[0]==qn;});v[1]=d[0][1];}});var querySetting=myself.query.getSettings();var BTableDrillProp={};BTableDrillProp.catalog=myself.properties.catalog;BTableDrillProp.jndi=myself.properties.jndi;BTableDrillProp.cube=myself.query.getCube();BTableDrillProp.dimensions=dimensions;BTableDrillProp.measures=measures;BTableDrillProp.pivotDimensions=pivotDimensions;BTableDrillProp.filters=filters;BTableDrillProp.measuresOnColumns=querySetting.measuresOnColumns;BTableDrillProp.nonEmptyRows=querySetting.nonEmpty.rows;BTableDrillProp.nonEmptyColumns=querySetting.nonEmpty.columns;BTableDrillProp.grandTotal=querySetting.summary.grandTotal;BTableDrillProp.subTotals=querySetting.summary.subTotals;BTableDrillProp.pivotGrandTotal=querySetting.summary.pivotGrandTotal;BTableDrillProp.pivotSubTotals=querySetting.summary.pivotSubTotals;BTableDrillProp.totalsPosition=querySetting.summary.position;BTableDrillProp.hideSpans=myself.properties.hideSpans;BTableDrillProp.drillTarget=myself.properties.drillTarget;var urlQuery=getURLQuery();var url=bt.helpers.general.getRenderServiceUrl()+"?";url+="btdef="+encodeURIComponent(JSON.stringify(BTableDrillProp));url+=(urlQuery.hasOwnProperty("debug")&&urlQuery.debug=="true")?"&debug=true":"";if(myself.properties.drillTarget=="SELF")
window.open(url,"_self");else if(myself.properties.drillTarget=="NEW_TAB"&&typeof top.mantle_openTab!=="undefined")
top.mantle_openTab("BTable","BTable",url);else
window.open(url,"_blank");},items:menu}};myself.buildDrillMenu=function(){var allLevels=myself.olapCube.getLevels();var queryDimensionLevels=myself.query.getDimensionQualifiedNames();var queryPivotLevels=myself.query.getPivotDimensionQualifiedNames();var queryLevels=queryDimensionLevels.concat(queryPivotLevels);var newLevels=$.grep(allLevels,function(e,i){return queryLevels.indexOf(e.qualifiedName)<0&&queryLevels.indexOf(e.qualifiedName.split("].[")[0]+"]")<0;});var invalidHierachies=_.uniq($.map(queryPivotLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));}));newLevels=$.grep(newLevels,function(e,i){return $.inArray(e.qualifiedName.split("].[")[0].substring(1),invalidHierachies)<0;});var newLevelsAsObjects=$.map(newLevels,function(e,i){var qn=e.qualifiedName;var qnParts=qn.split("].[");var h=qnParts[0].substring(1);var l=qnParts[1].substring(0,qnParts[1].length-1);return{hierarchy:h,level:l,qualifiedName:qn};});var hierarchies=$.map(newLevelsAsObjects,function(e,i){return e.hierarchy;});hierarchies=_.uniq(hierarchies);hierarchies.sort(function(a,b){var aCaption=myself.olapCube.getCaption("["+a+"]");var bCaption=myself.olapCube.getCaption("["+b+"]");var comparison=0;if(aCaption<bCaption)
comparison=-1;else if(aCaption>bCaption)
comparison=1;return comparison;});var menuMatrix=[];$.each(newLevelsAsObjects,function(i,v){var h=v.hierarchy;var l=v.level;var qn=v.qualifiedName;if(menuMatrix[h]==undefined)
menuMatrix[h]=[];menuMatrix[h].push({name:l,qualifiedName:qn});});var axisLevels=myself.query.getDimensionQualifiedNames();var axisHierarchies=$.map(axisLevels,function(e,i){return e=="MEASURES"?e:(e.indexOf("].[")<0?e.substring(1,e.length-1):e.split("].[")[0].substring(1));});var menu={};$.each(hierarchies,function(i,hierarchy){var hierarchyCaption=myself.olapCube.getCaption("["+hierarchy+"]");var levels=menuMatrix[hierarchy];if(levels.length==1&&myself.olapCube.getCaption(levels[0].qualifiedName)==hierarchyCaption){var newLevel=levels[0].qualifiedName;menu[newLevel]={};menu[newLevel].name=hierarchyCaption;}else{menu[hierarchy]={};menu[hierarchy].name=hierarchyCaption;menu[hierarchy].items={};$.each(levels,function(j,level){var newLevel=level.qualifiedName;menu[hierarchy].items[newLevel]={};menu[hierarchy].items[newLevel].name=myself.olapCube.getCaption(newLevel);});}});return menu;}
myself.buildNoDataContextMenu=function(target){var menu={};menu.title={name:"<strong>"+$.i18n.prop("menu_no_data")+"</strong>",callback:function(key,options){}};menu.titlesep="---";menu.filters={name:$.i18n.prop("menu_item_filters_manager"),callback:function(key,options){myself.openFiltersSelectorPanel("");}};menu.toggleFilters={name:myself.properties.showFilters?$.i18n.prop("menu_item_hide_filters_and_sorts"):$.i18n.prop("menu_item_show_filters_and_sorts"),callback:function(){myself.properties.showFilters=!myself.properties.showFilters;$("#"+myself.properties.filtersPanelHtmlObject).toggle();}};menu.settingssep="---";var settingsMenu=myself.buildSettingsMenu();menu.settings={name:$.i18n.prop("menu_item_table_settings"),items:settingsMenu.items};menu.mdx={name:$.i18n.prop("menu_item_show_mdx"),callback:function(key,options){var html="<div class='mdxPanel'>"+Dashboards.getParameterValue(myself.properties.componentName.replace("render_","")+"MdxQuery")+"</div>";$.fancybox(html,{'autoDimensions':true,'overlayShow':true,'hideOnOverlayClick':false,'hideOnContentClick':false,'enableEscapeButton':false,'showCloseButton':true,});}}
menu.reset={name:$.i18n.prop("menu_item_reset"),callback:function(){myself.query.reset();Dashboards.getComponent(myself.properties.componentName).update();}};menu.filesep="---";var openMenu=myself.buildOpenMenu();menu.open={name:$.i18n.prop("menu_item_open"),items:openMenu.items};var fileMenu=myself.buildFileMenu();menu.file={name:$.i18n.prop("menu_item_file"),items:fileMenu.items};menu.export2excel={name:$.i18n.prop("menu_item_export_to_excel"),callback:function(key,options){myself.exportToExcel();}};return{callback:function(key,options){},items:menu};};myself.getBodyRowspans=function(){var metadata=normalizedCdaResult.metadata;var resultset=normalizedCdaResult.resultset;var querySettings=myself.query.getSettings();var hasMoC=querySettings.measuresOnColumns;var hasGrandTotal=querySettings.summary.grandTotal;var hasSubTotals=querySettings.summary.subTotals;var totalsAtTop=querySettings.summary.position=="top";var zippedRows=[];if(!myself.properties.hideSpans){var colNames=$.map(metadata,function(m){return m.colName;});var maxIdx=-1;if(hasMoC){var dimQns=myself.query.getDimensionQualifiedNames();$.each(colNames,function(i,cn){if($.inArray(cn,dimQns)>-1)
maxIdx=i;});}else{var pivotQns=myself.query.getPivotDimensionQualifiedNames();$.each(colNames,function(i,cn){if($.inArray(cn,pivotQns)>-1||cn=="[Measures].[MeasuresLevel]")
maxIdx=i;});}
for(i=0;i<maxIdx;i++){zippedRows[i]=[];var len=resultset.length;var count=1;var prevValue=len>0?resultset[0][i]:"";var start=1;if(totalsAtTop&&hasGrandTotal&&prevValue!=""){zippedRows[i].push({value:prevValue,rowspan:1});prevValue=resultset[1][i];start=2;}
for(j=start;j<len;j++){var value=resultset[j][i];if(value!=prevValue){zippedRows[i].push({value:prevValue,rowspan:count});count=0;}
count++;prevValue=value;}
if(prevValue!=""){if(!totalsAtTop&&hasGrandTotal&&prevValue=="BT_TOTAL"&&count==2){zippedRows[i].push({value:prevValue,rowspan:1});zippedRows[i].push({value:prevValue,rowspan:1});}
else
zippedRows[i].push({value:prevValue,rowspan:count});}}}
return zippedRows;}
var setExportStyle=function(exportStyle){var defaultStyle={rules:[{selector:"table",properties:[{name:"border-collapse",value:"collapse"}]},{selector:"th",properties:[{name:"border",value:"1px solid #000"},{name:"background-color",value:"#C3D9FF"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:"td",properties:[{name:"border",value:"1px solid #000"}]},{selector:"tbody tr.odd td",properties:[{name:"background-color",value:"#E2E4FF"}]},{selector:"tbody tr.even td",properties:[{name:"background-color",value:"#FFFFFF"}]},{selector:"td.string",properties:[{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:"td.numeric",properties:[{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:"td.subtotal",properties:[{name:"font-weight",value:"bold"}]},{selector:"tr.odd td.grandtotal",properties:[{name:"font-weight",value:"bold"},{name:"background-color",value:"#C3D9FF"}]},{selector:"tr.even td.grandtotal",properties:[{name:"font-weight",value:"bold"},{name:"background-color",value:"#C3D9FF"}]},{selector:".filtersTitle",properties:[{name:"font-weight",value:"bold"},{name:"color",value:"black"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:".hierarchy",properties:[{name:"font-weight",value:"bold"},{name:"color",value:"blue"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:".separator",properties:[{name:"font-weight",value:"normal"},{name:"color",value:"blue"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:".level",properties:[{name:"font-weight",value:"bold"},{name:"color",value:"red"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]},{selector:".filter",properties:[{name:"font-weight",value:"normal"},{name:"font-family",value:"Arial, serif"},{name:"font-size",value:"9pt"}]}]};var tmpDiv=$("#"+myself.properties.componentHtmlObject+"_eXtmp");var rules=exportStyle.hasOwnProperty("rules")?exportStyle.rules:defaultStyle.rules;$.each(rules,function(i,v){var obj=tmpDiv.find(v.selector);if(obj.length>0){$.each(v.properties,function(j,w){obj.css(w.name,w.value);});}});}
myself.exportToExcel=function(){var html=$("#"+myself.properties.componentHtmlObject).html();var tmpId=myself.properties.componentHtmlObject+"_eXtmp";var tmpObj=$("<div id='"+tmpId+"' style='display:none'>"+html+"</div>");$("#"+myself.properties.componentHtmlObject).after(tmpObj);setExportStyle(myself.properties.exportStyle);tmpObj.find("img").remove();tmpObj.find("div[id$='_fixedHeader']").remove();var tmpHtml=tmpObj.html();tmpObj.remove();window.open("data:application/vnd.ms-excel,"+encodeURIComponent(tmpHtml));}
myself.buildFileMenu=function(){var menu={items:{}};var btfile=Dashboards.getQueryParameter("btfile");var alreadySaved=btfile!==undefined&&btfile!="";if(alreadySaved){menu.items.save={name:$.i18n.prop("menu_item_file_save"),callback:function(){var successCallback=function(){$.prompt($.i18n.prop("save_message_success"),{prefix:"popup",submit:function(v,m,f){$.prompt.close();window.location.reload();}});};var permissionDeniedCallback=function(){$.prompt($.i18n.prop("save_message_permission_denied"),{prefix:"popup",submit:function(v,m,f){$.prompt.close();}});};var errorCallback=function(){$.prompt($.i18n.prop("save_message_error"),{prefix:"popup",submit:function(v,m,f){$.prompt.close();}});};$.prompt($.i18n.prop("save_message_confirm_overwrite"),{buttons:{Ok:true,Cancel:false},prefix:"popup",callback:function(v,m,f){if(v)myself.save(btfile.substring(1),successCallback,permissionDeniedCallback,errorCallback);}});}};}
menu.items.saveAs={name:$.i18n.prop("menu_item_file_save_as"),callback:function(){myself.saveAs();}};return menu;}
myself.saveAs=function(){var selectedFile="";var selectedFolder="";var fileInfo='<div id="container_id" class="folderexplorer" style="height:260px;"></div>'+'               <div style="padding-top:15px;">'+'                   <table style="margin:0px">'+'                       <tr>'+'                           <td style="padding:0px; width:22%">'+'                               <span class="folderexplorerfilelabel" style="font-size:11px; font-weight:bold; left:0px; top:-3px">'+$.i18n.prop("save_as_label_file_name")+' *</span>'+'                           </td>'+'                           <td style="padding:0px">'+'                               <input id="fileInput" type="text" value=""></input>'+'                           </td>'+'                       </tr>'+'                   </table>'+'               </div>';var content="<h2>"+$.i18n.prop("save_as_title")+"</h2><hr/><div>"+fileInfo+"</div>";$.prompt(content,{prefix:"popup",buttons:{Ok:1,Cancel:0},loaded:function(){$('#container_id').fileTree({root:'/',script:bt.helpers.general.getExploreRepositoryServiceUrl(),expandSpeed:1000,collapseSpeed:1000,multiFolder:false,folderClick:function(obj,folder){if($(".selectedFolder").length>0)$(".selectedFolder").attr("class","");$(obj).attr("class","selectedFolder");selectedFolder=folder;$("#fileInput").val("");}},function(file){$("#fileInput").val(file.replace(selectedFolder,""));selectedFile=$("#fileInput").val();});},submit:function(v,m,f){if(v==1){selectedFile=$('#fileInput').val();var validInputs=true;if(selectedFile.indexOf(".")!=-1&&(selectedFile.length<7||selectedFile.lastIndexOf(".btable")!=selectedFile.length-7)){$.prompt($.i18n.prop("save_as_message_invalid_file_extension"),{prefix:"popup"});validInputs=false;}else if(selectedFolder.length==0){$.prompt($.i18n.prop("save_as_message_no_folder_selected"),{prefix:"popup"});validInputs=false;}else if(selectedFile.length==0){$.prompt($.i18n.prop("save_as_message_no_file_name_entered"),{prefix:"popup"});validInputs=false;}
if(validInputs){if(selectedFile.indexOf(".btable")==-1)selectedFile+=".btable";var i18nFileName=[];i18nFileName.push(selectedFile);var filePath=selectedFolder+selectedFile;var successCallback=function(){$.prompt.close();$.prompt($.i18n.prop("save_as_message_success",i18nFileName),{prefix:"popup"});};var successOverwriteCallback=function(){$.prompt.close();$.prompt($.i18n.prop("save_as_message_success_overwrite",i18nFileName),{prefix:"popup"});};var permissionDeniedCallback=function(){$.prompt.close();$.prompt($.i18n.prop("save_as_message_permission_denied",i18nFileName),{prefix:"popup"});};var errorCallback=function(){$.prompt.close();$.prompt($.i18n.prop("save_as_message_error",i18nFileName),{prefix:"popup"});};var fileExists=false;$("li.file.ext_btable a").each(function(i){fileExists=$(this).text()===selectedFile;return!fileExists;});if(fileExists){$.prompt($.i18n.prop("save_as_message_confirm_overwrite",i18nFileName),{buttons:{Ok:true,Cancel:false},prefix:"popup",callback:function(v,m,f){if(v)myself.save(filePath,successOverwriteCallback,permissionDeniedCallback,errorCallback);}});}else{myself.save(filePath,successCallback,permissionDeniedCallback,errorCallback);}}
return false;}}});}
myself.save=function(selectedFile,successCallback,permissionDeniedCallback,errorCallback){var querySetting=myself.query.getSettings();var BTableObj={};BTableObj.catalog=myself.properties.catalog;BTableObj.jndi=myself.properties.jndi;BTableObj.cube=myself.query.getCube();BTableObj.dimensions=myself.query.getDimensions();BTableObj.measures=myself.query.getMeasures();BTableObj.pivotDimensions=myself.query.getPivotDimensions();BTableObj.filters=myself.query.getFilters();BTableObj.measuresOnColumns=querySetting.measuresOnColumns;BTableObj.nonEmptyRows=querySetting.nonEmpty.rows;BTableObj.nonEmptyColumns=querySetting.nonEmpty.columns;BTableObj.grandTotal=querySetting.summary.grandTotal;BTableObj.subTotals=querySetting.summary.subTotals;BTableObj.pivotGrandTotal=querySetting.summary.pivotGrandTotal;BTableObj.pivotSubTotals=querySetting.summary.pivotSubTotals;BTableObj.totalsPosition=querySetting.summary.position;BTableObj.hideSpans=myself.properties.hideSpans;var saveParams={path:selectedFile,btdef:JSON.stringify(BTableObj,"",1)};var $uploadForm=$('<form action="'+bt.helpers.general.getSaveFileServiceUrl()+'" method="post" enctype="multipart/form-data">');$uploadForm.ajaxForm({data:saveParams,success:function(result){if(result){var json=bt.helpers.util.getServiceResultEvaluation(result);if(json.status=="true"){successCallback();}else{if(json.result.toLowerCase().indexOf("access denied")!=-1){permissionDeniedCallback();}else{errorCallback();}}}}});$uploadForm.submit();}
myself.buildOpenMenu=function(){var menu={items:{}};if(typeof top.mantle_openTab!=="undefined"){menu.items.newTab={name:$.i18n.prop("menu_item_open_in_new_tab"),callback:function(key,options){myself.open("NEW_TAB");}};}
menu.items.newWindow={name:$.i18n.prop("menu_item_open_in_new_window"),callback:function(key,options){myself.open("NEW_WINDOW");}};return menu;}
myself.open=function(target){var querySetting=myself.query.getSettings();var BTableObj={};BTableObj.catalog=myself.properties.catalog;BTableObj.jndi=myself.properties.jndi;BTableObj.cube=myself.query.getCube();BTableObj.dimensions=myself.query.getDimensions();BTableObj.measures=myself.query.getMeasures();BTableObj.pivotDimensions=myself.query.getPivotDimensions();BTableObj.filters=myself.query.getFilters();BTableObj.measuresOnColumns=querySetting.measuresOnColumns;BTableObj.nonEmptyRows=querySetting.nonEmpty.rows;BTableObj.nonEmptyColumns=querySetting.nonEmpty.columns;BTableObj.grandTotal=querySetting.summary.grandTotal;BTableObj.subTotals=querySetting.summary.subTotals;BTableObj.pivotGrandTotal=querySetting.summary.pivotGrandTotal;BTableObj.pivotSubTotals=querySetting.summary.pivotSubTotals;BTableObj.totalsPosition=querySetting.summary.position;BTableObj.hideSpans=myself.properties.hideSpans;BTableObj.drillTarget=myself.properties.drillTarget;var urlQuery=getURLQuery();var url=bt.helpers.general.getRenderServiceUrl()+"?";url+="btdef="+encodeURIComponent(JSON.stringify(BTableObj));url+=(urlQuery.hasOwnProperty("debug")&&urlQuery.debug=="true")?"&debug=true":"";if(target=="NEW_TAB")
top.mantle_openTab("BTable","BTable",url);else if(target=="NEW_WINDOW")
window.open(url,"_blank");}
return myself;}
var bt=bt||{};bt.Query=function(properties,olapCube){var defaults={cube:"",dimensions:[],measures:[],pivotDimensions:[],filters:[],measuresOnColumns:true,nonEmpty:{columns:true,rows:true},summary:{grandTotal:true,subTotals:true,pivotGrandTotal:true,pivotSubTotals:true,position:"bottom"},orders:[]};var myself={};var settings=$.extend({},defaults,properties);var history=[];var definition={cube:settings.cube,dimensions:settings.dimensions,measures:settings.measures,pivotDimensions:settings.pivotDimensions,filters:settings.filters,orders:settings.orders}
var normalizeDefinition=function(){var hierarchiesInDimensions=$.map(definition.dimensions,function(e,i){return(e[0].split("].[")[0]+"]").replace("]]","]");});var hierarchiesInPivotDimensions=$.map(definition.pivotDimensions,function(e,i){return(e[0].split("].[")[0]+"]").replace("]]","]");});var newFilters=[];$.each(definition.filters,function(i,f){var filterLevel=f[0];var filterHierarchy=(filterLevel.split("].[")[0]+"]").replace("]]","]");if($.inArray(filterHierarchy,hierarchiesInDimensions)>-1){var filterLevelDepth=olapCube.getLevelDepth(filterLevel);var index=-1;var side="";$.each(definition.dimensions,function(i,d){var dimensionLevel=d[0];if((filterLevel.split("].[")[0]+"]").replace("]]","]")==(dimensionLevel.split("].[")[0]+"]").replace("]]","]")){index=i;dimensionLevelDepth=olapCube.getLevelDepth(dimensionLevel);if(dimensionLevelDepth<filterLevelDepth)
side="right";else
side="left";}});index+=side=="right"?1:0;definition.dimensions.splice(index,0,f);}
else if($.inArray(filterHierarchy,hierarchiesInPivotDimensions)>-1){var filterLevelDepth=olapCube.getLevelDepth(filterLevel);var index=-1;var side="";$.each(definition.pivotDimensions,function(i,d){var dimensionLevel=d[0];if(dimensionLevel!="MEASURES"){if((filterLevel.split("].[")[0]+"]").replace("]]","]")==(dimensionLevel.split("].[")[0]+"]").replace("]]","]")){index=i;dimensionLevelDepth=olapCube.getLevelDepth(dimensionLevel);if(dimensionLevelDepth<filterLevelDepth)
side="right";else
side="left";}}});index+=side=="right"?1:0;definition.pivotDimensions.splice(index,0,f);}
else{newFilters.push(f);}});definition.filters=newFilters;}();myself.saveInHistory=function(){var def=$.extend(true,{},definition);history.push(def);}
myself.saveInHistory();myself.reset=function(){definition=$.extend(true,{},history[0]);initializeFiltersMap(definition.dimensions);initializeFiltersMap(definition.pivotDimensions);initializeFiltersMap(definition.filters);filtersMap.synchronizedByParameters=true;initializeOrdersMap();}
myself.validate=function(olapCube){}
myself.getPlainFilter=function(levelQualifiedName){var result="";var lQn=levelQualifiedName;var hQn=(lQn.split("].[")[0]+"]").replace("]]","]");var boundToDashboard=filtersMap.synchronizedByParameters;var isCalculatedMember=lQn.indexOf("].[")<0;var level=isCalculatedMember?filtersMap.hierarchies[hQn].calculatedMembers:filtersMap.hierarchies[hQn].levels[lQn];if(level.filtered){var filterMode=level.filterMode+(level.uniqueNames?"_un":"");var members=null;if(boundToDashboard&&level.synchronizedByParameters){var filterExpression=level.initialFilterExpression;var param=filterExpression.replace(filterMode+":","");var members=Dashboards.getParameterValue(param);}else{members=level.members;}
result=filterMode+":["+($.isArray(members)?members.join("],["):members)+"]";}
return result;}
var getMdxFilter=function(levelQualifiedName,hierarchyQualifiedName){var mdx="";var lQn=levelQualifiedName;var hQn=!hierarchyQualifiedName?(lQn.split("].[")[0]+"]").replace("]]","]"):hierarchyQualifiedName;var boundToDashboard=filtersMap.synchronizedByParameters;var isCalculatedMember=lQn.indexOf("].[")<0;var level=isCalculatedMember?filtersMap.hierarchies[hQn].calculatedMembers:filtersMap.hierarchies[hQn].levels[lQn];if(level.filtered){var filterMode=level.filterMode;var include=filterMode=="include";var exclude=filterMode=="exclude";var between=filterMode=="between";var uniqueNames=level.uniqueNames;if(uniqueNames)filterMode+="_un";var members=null;if(boundToDashboard&&level.synchronizedByParameters){var filterExpression=level.initialFilterExpression;var param=filterExpression.replace(filterMode+":","");members=Dashboards.getParameterValue(param);}else{members=level.members;}
if($.isArray(members)){members=$.map(members,function(e){return e.replace(/[']/g,"''");});}else{members=members.replace(/[']/g,"''");}
var separator=between?" :":",";if(uniqueNames){mdx=$.isArray(members)?members.join(separator+" "):members;mdx="{"+mdx+"}";}else{if(between){mdx="Filter({"+lQn+".Members}, ("+lQn+".CurrentMember.Name >= \""+members[0]+"\" AND "+lQn+".CurrentMember.Name <= \""+members[1]+"\"))";}else{mdx=$.isArray(members)?members.join("\" OR "+lQn+".CurrentMember.Name = \""):members;mdx="Filter({"+lQn+".Members}, ("+lQn+".CurrentMember.Name = \""+mdx+"\"))";}}
if(exclude)
mdx="Except("+lQn+".Members, "+mdx+")";if(members.length==0||mdx.indexOf(".[]")>-1||mdx.indexOf(".[All]")>-1||mdx.indexOf("\"All\"")>-1)
mdx="";}
return mdx;}
myself.getMdx=function(){var dimensionHierarchies=[];var pivotHierarchies=[];var filterHierarchies=[];var pivotHierarchyBeforeMeasures="";var addLevelToHierarchy=function(levelObj,hierarchyObjs){var hierarchyIndex=$.map(hierarchyObjs,function(hierarchy,index){if(hierarchy.name==levelObj.hierarchy)
return index;});if(hierarchyIndex.length>0){hierarchyObjs[hierarchyIndex[0]].levels.push(levelObj);}else{hierarchyObjs.push({name:levelObj.hierarchy,levels:new Array(levelObj)});}}
$.each(definition.dimensions,function(i,v){var qualifiedName=v[0];var qnParts=qualifiedName.substring(1,qualifiedName.length-1).split("].[");var hierarchy=qnParts[0];var level=qnParts.length<2?"":qnParts[1];addLevelToHierarchy({hierarchy:hierarchy,name:level,qualifiedName:qualifiedName},dimensionHierarchies);});var previousHierarchyName="";$.each(definition.pivotDimensions,function(i,v){var qualifiedName=v[0];if(qualifiedName=="MEASURES"){pivotHierarchyBeforeMeasures=i==0?"NONE":previousHierarchyName;}else{var qnParts=qualifiedName.substring(1,qualifiedName.length-1).split("].[");var hierarchy=qnParts[0];var level=qnParts.length<2?"":qnParts[1];addLevelToHierarchy({hierarchy:hierarchy,name:level,qualifiedName:qualifiedName},pivotHierarchies);previousHierarchyName=hierarchy;}});var invalidHierarchies=$.map(dimensionHierarchies,function(e){return"["+e.name+"]";}).concat($.map(pivotHierarchies,function(e){return"["+e.name+"]";}));for(var key in filtersMap.hierarchies){if($.inArray(key,invalidHierarchies)<0){var hierarchy=filtersMap.hierarchies[key];var levels=hierarchy.levels;$.each(hierarchy.order,function(i,v){if(levels[v].filtered){var qn=v;var qnParts=qn.substring(1,qn.length-1).split("].[");var h=qnParts[0];var l=qnParts.length<2?"":qnParts[1];addLevelToHierarchy({hierarchy:h,name:l,qualifiedName:qn},filterHierarchies);}});}}
var getMdxCrossjoins=function(sets){var mdx="";if(sets.length>0){var _sets=sets.slice();if(_sets.length==1){mdx=_sets[0];}else{mdx="Crossjoin("+_sets.shift()+", "+getMdxCrossjoins(_sets)+")";}}
return mdx;}
var mdx=[];mdx["members"]=[];mdx["sets"]=[];mdx["columns"]="";mdx["rows"]="";mdx["cube"]=definition.cube;mdx["slicer"]="";var mdxSets=[];var mdxTotalMembers=[];var mdxAxis="";$.each(dimensionHierarchies,function(i,hierarchy){var lastLevel=hierarchy.levels[hierarchy.levels.length-1];if(settings.summary.grandTotal||settings.summary.subTotals){if(lastLevel.name==""){mdxTotalMembers.push("["+lastLevel.hierarchy+"_"+lastLevel.name+"_Set]");}else{mdx["members"].push("member ["+hierarchy.name+"].[BT_TOTAL] as 'Aggregate(["+lastLevel.hierarchy+"_"+lastLevel.name+"_Set])'");mdxTotalMembers.push("["+hierarchy.name+"].[BT_TOTAL]");}}
var previousLevelName=[];var previousLevelAllMembers=[];$.each(hierarchy.levels,function(j,level){var mdxFilteredSet=getMdxFilter(level.qualifiedName,"["+hierarchy.name+"]");var mdxNamedSet=mdxFilteredSet==""?"{"+level.qualifiedName+".Members}":mdxFilteredSet;if(j>0){var mdxConditions=[];$.each(previousLevelName,function(k,previousLevelName){if(!previousLevelAllMembers[k])
mdxConditions.push("(Exists(Ancestor(["+level.hierarchy+"].CurrentMember, ["+level.hierarchy+"].["+previousLevelName+"]), ["+level.hierarchy+"_"+previousLevelName+"_Set]).Count > 0))");});if(mdxConditions.length>0){mdxNamedSet="Filter("+mdxNamedSet+", ";mdxNamedSet+="("+mdxConditions.join(" AND ")+")";mdxNamedSet+=")";}}
if(ordersMap.levels.hasOwnProperty(level.qualifiedName)){var order=ordersMap.levels[level.qualifiedName];var by=order.by;if(by=="name"){by=level.qualifiedName+".CurrentMember.Name";}
var direction=order.dir;mdxNamedSet="Order("+mdxNamedSet+", "+by+", "+direction+")";}
mdx["sets"].push("set ["+level.hierarchy+"_"+level.name+"_Set] as '"+mdxNamedSet+"'");previousLevelName.push(level.name);previousLevelAllMembers.push(mdxFilteredSet==""?true:false);});var mdxHierarchySet="["+lastLevel.hierarchy+"_"+lastLevel.name+"_Set]";if(hierarchy.levels.length>1)
mdxHierarchySet="Descendants("+mdxHierarchySet+", "+lastLevel.qualifiedName+", SELF)";if(settings.summary.subTotals&&i>0&&i==dimensionHierarchies.length-1&&!ordersMap.axes.hasOwnProperty("dimensions")){if(settings.summary.position=="top")
mdxHierarchySet="Union(["+hierarchy.name+"].[BT_TOTAL], "+mdxHierarchySet+")";else if(settings.summary.position=="bottom")
mdxHierarchySet="Union("+mdxHierarchySet+", ["+hierarchy.name+"].[BT_TOTAL])";}
mdxSets.push(mdxHierarchySet);});if(settings.summary.subTotals&&!ordersMap.axes.hasOwnProperty("dimensions")&&mdxSets.length>2){var btTotals=mdxTotalMembers.slice();mdxAxis="{?}";var i=0;for(i;i<mdxSets.length-2;i++){btTotals.shift();mdxAxis=mdxAxis.replace("{?}","Crossjoin("+mdxSets[i]+", Union({?}, "+getMdxCrossjoins(btTotals)+"))");}
mdxAxis=mdxAxis.replace("{?}","Crossjoin("+mdxSets[i]+", "+mdxSets[i+1]+")");}else{mdxAxis=getMdxCrossjoins(mdxSets);}
if(ordersMap.axes.hasOwnProperty("dimensions")){var order=ordersMap.axes.dimensions;var by=order.by;if(by.indexOf("[Measures].[")<0)
by=by+".CurrentMember.Name";mdxAxis="Order("+mdxAxis+", "+by+", "+order.dir+")";}
if(settings.summary.grandTotal){if(settings.summary.position=="top")
mdxAxis="Union("+getMdxCrossjoins(mdxTotalMembers)+", "+mdxAxis+")";else if(settings.summary.position=="bottom")
mdxAxis="Union("+mdxAxis+", "+getMdxCrossjoins(mdxTotalMembers)+")";}
if(settings.measuresOnColumns)
mdx["rows"]=mdxAxis;else
mdx["columns"]=mdxAxis;var mdxMeasuresSet="{";$.each(definition.measures,function(i,v){if(i>0)mdxMeasuresSet+=", ";mdxMeasuresSet+=v[0];});mdxMeasuresSet+="}";if(ordersMap.levels.hasOwnProperty("[Measures]")){var order=ordersMap.levels["[Measures]"];var by=order.by;var direction=order.dir;if(by=="name"){mdxMeasuresSet="Order("+mdxMeasuresSet+", [Measures].CurrentMember.Name, "+direction+")";}}
mdx["sets"].push("set [Measures_Set] as '"+mdxMeasuresSet+"'");mdxSets=[];mdxTotalMembers=[];$.each(pivotHierarchies,function(i,hierarchy){var lastLevel=hierarchy.levels[hierarchy.levels.length-1];if(settings.summary.pivotGrandTotal||settings.summary.pivotSubTotals){mdx["members"].push("member ["+hierarchy.name+"].[BT_TOTAL] as 'Aggregate(["+lastLevel.hierarchy+"_"+lastLevel.name+"_Set])'");mdxTotalMembers.push("["+hierarchy.name+"].[BT_TOTAL]");}
var previousLevelName=[];var previousLevelAllMembers=[];$.each(hierarchy.levels,function(j,level){var mdxFilteredSet=getMdxFilter(level.qualifiedName,"["+hierarchy.name+"]");var mdxNamedSet=mdxFilteredSet==""?"{"+level.qualifiedName+".Members}":mdxFilteredSet;if(j>0){var mdxConditions=[];$.each(previousLevelName,function(k,previousLevelName){if(!previousLevelAllMembers[k])
mdxConditions.push("(Exists(Ancestor(["+level.hierarchy+"].CurrentMember, ["+level.hierarchy+"].["+previousLevelName+"]), ["+level.hierarchy+"_"+previousLevelName+"_Set]).Count > 0))");});if(mdxConditions.length>0){mdxNamedSet="Filter("+mdxNamedSet+", ";mdxNamedSet+="("+mdxConditions.join(" AND ")+")";mdxNamedSet+=")";}}
if(ordersMap.levels.hasOwnProperty(level.qualifiedName)){var order=ordersMap.levels[level.qualifiedName];var by=order.by;if(by=="name"){by=level.qualifiedName+".CurrentMember.Name";}
var direction=order.dir;mdxNamedSet="Order("+mdxNamedSet+", "+by+", "+direction+")";}
mdx["sets"].push("set ["+level.hierarchy+"_"+level.name+"_Set] as '"+mdxNamedSet+"'");previousLevelName.push(level.name);previousLevelAllMembers.push(mdxFilteredSet==""?true:false);});var mdxHierarchySet="["+lastLevel.hierarchy+"_"+lastLevel.name+"_Set]";if(hierarchy.levels.length>1)
mdxHierarchySet="Descendants("+mdxHierarchySet+", "+lastLevel.qualifiedName+", SELF)";if(settings.summary.pivotSubTotals&&(i>0||pivotHierarchyBeforeMeasures=="NONE")&&i==pivotHierarchies.length-1&&!ordersMap.axes.hasOwnProperty("measures")){if(settings.summary.position=="top")
mdxHierarchySet="Union(["+hierarchy.name+"].[BT_TOTAL], "+mdxHierarchySet+")";else if(settings.summary.position=="bottom")
mdxHierarchySet="Union("+mdxHierarchySet+", ["+hierarchy.name+"].[BT_TOTAL])";}
mdxSets.push(mdxHierarchySet);});if(pivotHierarchyBeforeMeasures==""){mdxSets.push("[Measures_Set]");mdxTotalMembers.push("[Measures_Set]");}
else{var measuresInsertionIndex=$.map(pivotHierarchies,function(hierarchy,index){if(hierarchy.name==pivotHierarchyBeforeMeasures)
return index+1;});if(measuresInsertionIndex.length==0&&pivotHierarchyBeforeMeasures=="NONE")
measuresInsertionIndex=[0]
mdxSets.splice(measuresInsertionIndex[0],0,"[Measures_Set]");mdxTotalMembers.splice(measuresInsertionIndex[0],0,"[Measures_Set]");}
if(definition.pivotDimensions.length>0){if(settings.summary.pivotSubTotals&&!ordersMap.axes.hasOwnProperty("measures")&&mdxSets.length>2){var btTotals=mdxTotalMembers.slice();mdxAxis="{?}";var i=0;for(i;i<mdxSets.length-2;i++){btTotals.shift();mdxAxis=mdxAxis.replace("{?}","Crossjoin("+mdxSets[i]+", Union({?}, "+getMdxCrossjoins(btTotals)+"))");}
mdxAxis=mdxAxis.replace("{?}","Crossjoin("+mdxSets[i]+", "+mdxSets[i+1]+")");}else{mdxAxis=getMdxCrossjoins(mdxSets);}
if(ordersMap.axes.hasOwnProperty("measures")){var order=ordersMap.axes.measures;var by=order.by;if(by=="name")
by="[Measures]";by+=".CurrentMember.Name";mdxAxis="Order("+mdxAxis+", "+by+", "+order.dir+")";}
if(settings.summary.pivotGrandTotal){if(settings.summary.position=="top")
mdxAxis="Union("+getMdxCrossjoins(mdxTotalMembers)+", "+mdxAxis+")";else if(settings.summary.position=="bottom")
mdxAxis="Union("+mdxAxis+", "+getMdxCrossjoins(mdxTotalMembers)+")";}}else{mdxAxis="[Measures_Set]";if(ordersMap.axes.hasOwnProperty("measures")){var order=ordersMap.axes.measures;var by=order.by;if(by=="name"){by="[Measures].CurrentMember.Name";mdxAxis="Order("+mdxAxis+", "+by+", "+order.dir+")";}}}
if(settings.measuresOnColumns)
mdx["columns"]=mdxAxis;else
mdx["rows"]=mdxAxis;mdxSets=[];mdxTotalMembers=[];$.each(filterHierarchies,function(i,hierarchy){var previousLevelName=[];var previousLevelAllMembers=[];$.each(hierarchy.levels,function(j,level){var mdxFilteredSet=getMdxFilter(level.qualifiedName,"["+hierarchy.name+"]");var mdxNamedSet=mdxFilteredSet==""?"{"+level.qualifiedName+".Members}":mdxFilteredSet;if(j>0){var mdxConditions=[];$.each(previousLevelName,function(k,previousLevelName){if(!previousLevelAllMembers[k])
mdxConditions.push("(Exists(Ancestor(["+level.hierarchy+"].CurrentMember, ["+level.hierarchy+"].["+previousLevelName+"]), ["+level.hierarchy+"_"+previousLevelName+"_Set]).Count > 0))");});if(mdxConditions.length>0){mdxNamedSet="Filter("+mdxNamedSet+", ";mdxNamedSet+="("+mdxConditions.join(" AND ")+")";mdxNamedSet+=")";}}
mdx["sets"].push("set ["+level.hierarchy+"_"+level.name+"_Set] as '"+mdxNamedSet+"'");previousLevelName.push(level.name);previousLevelAllMembers.push(mdxFilteredSet==""?true:false);});if(!(previousLevelAllMembers.length==1&&previousLevelAllMembers[0])){var levelSets=$.map(hierarchy.levels,function(level){return"["+level.hierarchy+"_"+level.name+"_Set]";});var mdxHierarchySet="{"+levelSets[levelSets.length-1]+"}";mdxSets.push(mdxHierarchySet);}});mdx["slicer"]=getMdxCrossjoins(mdxSets);var mdxQuery="with ";mdxQuery+=mdx["sets"].join(" ")+" ";mdxQuery+=mdx["members"].join(" ")+" ";mdxQuery+="select"+(settings.nonEmpty.columns?" NON EMPTY":"")+" "+mdx["columns"]+" on COLUMNS,";mdxQuery+=(settings.nonEmpty.rows?" NON EMPTY":"")+" "+mdx["rows"]+" on ROWS ";mdxQuery+="from ["+mdx["cube"]+"]";mdxQuery+=mdx["slicer"]!=""?" where ("+mdx["slicer"]+")":"";return mdxQuery;}
myself.putMeasuresOnColumns=function(){settings.measuresOnColumns=true;}
myself.putMeasuresOnRows=function(){settings.measuresOnColumns=false;}
myself.hasMeasuresOnColumns=function(){return settings.measuresOnColumns;}
myself.hasPivotDimensions=function(){if(definition.pivotDimensions.length==0||(definition.pivotDimensions.length==1&&definition.pivotDimensions[0][0]=="MEASURES"))
return false;else
return true;}
myself.getDimensionQualifiedNames=function(){return $.map(definition.dimensions,function(i){return i[0]});}
myself.getPivotDimensionQualifiedNames=function(){return $.map(definition.pivotDimensions,function(i){return i[0]});}
myself.getMeasureQualifiedNames=function(){return $.map(definition.measures,function(i){return i[0]});}
myself.getFilterQualifiedNames=function(){return $.map(definition.filters,function(i){return i[0]});}
myself.getCube=function(){return definition.cube;}
myself.getFilters=function(){var filters=[];var invalidHierarchies=$.map(myself.getDimensionQualifiedNames(),function(e){return(e.split("].[")[0]+"]").replace("]]","]");}).concat($.map(myself.getPivotDimensionQualifiedNames(),function(e){return(e.split("].[")[0]+"]").replace("]]","]");}));var boundToDashboard=filtersMap.synchronizedByParameters;for(var key in filtersMap.hierarchies){if($.inArray(key,invalidHierarchies)<0){var hierarchy=filtersMap.hierarchies[key];var levels=hierarchy.levels;$.each(hierarchy.order,function(i,v){var level=levels[v];if(level.filtered){var qn=v;var filterMode=level.filterMode;if(level.uniqueNames)filterMode+="_un";var members=null;if(boundToDashboard&&level.synchronizedByParameters){var filterExpression=level.initialFilterExpression;var param=filterExpression.replace(filterMode+":","");var members=Dashboards.getParameterValue(param);}else{members=level.members;}
if(members.length>0){var plainFilter=filterMode+":["+($.isArray(members)?members.join("],["):members)+"]";var filter=[qn,plainFilter];filters.push(filter);}}});}}
return filters;}
myself.getDimensions=function(){var dimensions=[];$.each(definition.dimensions,function(i,v){var qn=v[0];var arr=[qn,myself.getPlainFilter(qn)];dimensions.push(arr);});return dimensions;}
myself.getPivotDimensions=function(){var pivotDimensions=[];$.each(definition.pivotDimensions,function(i,v){var qn=v[0];var fe=qn=="MEASURES"?"":myself.getPlainFilter(qn);var arr=[qn,fe];pivotDimensions.push(arr);});return pivotDimensions;}
myself.getMeasures=function(){return definition.measures;}
myself.setMeasures=function(measures){definition.measures=measures;}
myself.set=function(properties){$.extend(true,settings,properties);}
myself.getSettings=function(){return settings;}
myself.isRemovable=function(qualifiedName,type){var removable=true;if(type=="D"){removable=definition.dimensions.length>1;if(removable){var hierarchies=_.uniq($.map(myself.getDimensionQualifiedNames(),function(e){return(e.split("].[")[0]+"]").replace("]]","]");}));if(hierarchies.length==1){if(filtersMap.hierarchies[hierarchies[0]].levels[qualifiedName].filtered)
removable=false;}}}
else if(type=="M"){removable=definition.measures.length>1;}
return removable;}
myself.remove=function(qualifiedName,type){var removedElements=undefined;var hierarchy=(qualifiedName.split("].[")[0]+"]").replace("]]","]");var axis=[];var axisQualifiedNames=[];if(type=="D"){axis=definition.dimensions;axisQualifiedNames=myself.getDimensionQualifiedNames();}
else if(type=="M"){axis=definition.measures;axisQualifiedNames=myself.getMeasureQualifiedNames();}
else if(type=="P"){axis=definition.pivotDimensions;axisQualifiedNames=myself.getPivotDimensionQualifiedNames();}
var index=-1;var length=0;if(type!="M"&&filtersMap.hierarchies[hierarchy].levels[qualifiedName].filtered){var hierarchies=$.map(axisQualifiedNames,function(e){return(e.split("].[")[0]+"]").replace("]]","]");});var indexes=[];$.each(hierarchies,function(i,v){if(v==hierarchy)indexes.push(i);});index=indexes[0];length=indexes.length;}else{index=axisQualifiedNames.indexOf(qualifiedName);length=1;}
if(index>=0)
removedElements=axis.splice(index,length);myself.clearSort(qualifiedName,(length>1?true:false));}
myself.add=function(newQualifiedName,targetQualifiedName,position,type){var hierarchy=(newQualifiedName.split("].[")[0]+"]").replace("]]","]");var axis=[];var axisQualifiedNames=[];if(type=="D"){axis=definition.dimensions;axisQualifiedNames=myself.getDimensionQualifiedNames();}
else if(type=="M"){axis=definition.measures;axisQualifiedNames=myself.getMeasureQualifiedNames();}
else if(type=="P"){axis=definition.pivotDimensions;if($.inArray("MEASURES",myself.getPivotDimensionQualifiedNames())<0)
axis.splice(0,0,["MEASURES",""]);axisQualifiedNames=myself.getPivotDimensionQualifiedNames();}
var index=$.inArray(targetQualifiedName,axisQualifiedNames);var hierarchies=$.map(axisQualifiedNames,function(e){return(e.split("].[")[0]+"]").replace("]]","]");});if(type!="M"&&$.inArray(hierarchy,hierarchies)<0){var fmHierarchy=filtersMap.hierarchies[hierarchy];var fmLevels=fmHierarchy.levels;var elementsToInsert=[];$.each(fmHierarchy.order,function(i,v){if(fmLevels[v].filtered||v==newQualifiedName)
elementsToInsert.push("[\""+v+"\", \"\"]");});if(index>=0){if(position==1)
index++;eval("axis.splice(index, 0, "+elementsToInsert.join(", ")+")");}}else{var elementToInsert=[newQualifiedName,""];if(index>=0){if(position==1)
index++;axis.splice(index,0,elementToInsert);}}}
myself.isReplaceable=function(newQualifiedName,oldQualifiedName,type){var replaceable=true;if(type!="M"){var newHierarchy=(newQualifiedName.split("].[")[0]+"]").replace("]]","]");var oldHierarchy=(oldQualifiedName.split("].[")[0]+"]").replace("]]","]");if(newHierarchy==oldHierarchy&&filtersMap.hierarchies[oldHierarchy].levels[oldQualifiedName].filtered)
replaceable=false;}
return replaceable;}
myself.replace=function(newQualifiedName,oldQualifiedName,position,type){var hasNewPosition=position!=null;var closeQualifiedName=hasNewPosition?position.level:oldQualifiedName;var direction=hasNewPosition?position.direction:1;var axis=[];var axisQualifiedNames=[];if(type=="D"){axis=definition.dimensions;axisQualifiedNames=myself.getDimensionQualifiedNames();}
else if(type=="M"){axis=definition.measures;axisQualifiedNames=myself.getMeasureQualifiedNames();}
else if(type=="P"){axis=definition.pivotDimensions;axisQualifiedNames=myself.getPivotDimensionQualifiedNames();}
myself.add(newQualifiedName,closeQualifiedName,direction,type);myself.remove(oldQualifiedName,type);if(type!="M"){var newLevelHierarchy=(newQualifiedName.split("].[")[0]+"]").replace("]]","]");var oldLevelHierarchy=(oldQualifiedName.split("].[")[0]+"]").replace("]]","]");var closeLevelHierarchy=(closeQualifiedName.split("].[")[0]+"]").replace("]]","]");if(closeQualifiedName!=oldQualifiedName&&closeLevelHierarchy==oldLevelHierarchy&&newLevelHierarchy!=oldLevelHierarchy){var headElements=[];var tailElements=[];var newHierarchyElements=[];var oldHierarchyElements=[];var newHierarchyFound=false;$.each(axis,function(i,v){var l=v[0];var h=(l.split("].[")[0]+"]").replace("]]","]");var e="[\""+l+"\", \"\"]";if(h==oldLevelHierarchy){oldHierarchyElements.push(e);}
else if(h==newLevelHierarchy){newHierarchyElements.push(e);newHierarchyFound=true;}
else{if(!newHierarchyFound)
headElements.push(e);else
tailElements.push(e);}});var newAxis=headElements.concat(newHierarchyElements,oldHierarchyElements,tailElements);eval("axis.splice(0, axis.length, "+newAxis.join(", ")+")");}}}
var filtersMap={synchronizedByParameters:true,hierarchies:[]};if(olapCube&&olapCube.getStructure()){var hierarchies=olapCube.getHierarchies();$.each(hierarchies,function(i,v){var levels=[];var order=[];$.each(v.levels,function(j,w){var qualifiedName=w.qualifiedName;levels[qualifiedName]={depth:w.depth,initialFilterExpression:"",synchronizedByParameters:false,filterMode:"",uniqueNames:false,members:[],filtered:false}
order.push(qualifiedName);});filtersMap.hierarchies[v.qualifiedName]={levels:levels,order:order,calculatedMembers:{initialFilterExpression:"",synchronizedByParameters:false,filterMode:"",members:[],filtered:false}}});}
var initializeFiltersMap=function(axis){if(olapCube&&olapCube.getStructure()){$.each(axis,function(i,v){var lvlQn=v[0];var fltExpr=v[1];if(fltExpr!=""){if(lvlQn.indexOf("].[")<0){var hrcQn=lvlQn;var synchronizedByParameters=fltExpr.indexOf("[")<0;var filterMode=synchronizedByParameters?fltExpr.split(":")[0]:fltExpr.split(":[")[0];var membersString=synchronizedByParameters?"":fltExpr.replace(filterMode+":","");var calculatedMembers=filtersMap.hierarchies[hrcQn].calculatedMembers;calculatedMembers.initialFilterExpression=fltExpr;calculatedMembers.synchronizedByParameters=synchronizedByParameters;calculatedMembers.filterMode=filterMode.replace("_un","");calculatedMembers.uniqueNames=filterMode.indexOf("_un")>-1;calculatedMembers.members=synchronizedByParameters?[]:membersString.substring(1,membersString.length-1).split("],[");calculatedMembers.filtered=true;}else{var hrcQn=lvlQn.split("].[")[0]+"]";var levels=filtersMap.hierarchies[hrcQn].levels;var synchronizedByParameters=fltExpr.indexOf("[")<0;var filterMode=synchronizedByParameters?fltExpr.split(":")[0]:fltExpr.split(":[")[0];var membersString=synchronizedByParameters?"":fltExpr.replace(filterMode+":","");var level=filtersMap.hierarchies[hrcQn].levels[lvlQn];level.initialFilterExpression=fltExpr;level.synchronizedByParameters=synchronizedByParameters;level.filterMode=filterMode.replace("_un","");level.uniqueNames=filterMode.indexOf("_un")>-1;level.members=synchronizedByParameters?[]:membersString.substring(1,membersString.length-1).split("],[");level.filtered=true;}}});}}
initializeFiltersMap(definition.dimensions);initializeFiltersMap(definition.pivotDimensions);initializeFiltersMap(definition.filters);myself.getFiltersMap=function(){return filtersMap;}
myself.synchronizeFiltersWithParameters=function(state){filtersMap.synchronizedByParameters=state;}
myself.isSynchronizedByParameters=function(){return filtersMap.synchronizedByParameters;}
myself.setFiltersMap=function(hierarchyQualifiedName,levelQualifiedName,filter){$.extend(filtersMap.hierarchies[hierarchyQualifiedName].levels[levelQualifiedName],filter);}
var ordersMap={axes:{},levels:[]};var initializeOrdersMap=function(){$.each(definition.orders,function(i,v){var arg=v[0];var valueParts=v[1].split("::");var rule={by:valueParts[0],dir:valueParts[1]};if(arg=="D")
ordersMap.axes.dimensions=rule;else if(arg=="M")
ordersMap.axes.measures=rule;else
ordersMap.levels[arg]=rule;});}
initializeOrdersMap();myself.getOrdersMap=function(){return ordersMap;}
myself.getSortDirection=function(target,qualifiedName){var direction="";if(target=="D"){if(ordersMap.axes.hasOwnProperty("dimensions")){var order=ordersMap.axes.dimensions;if(order.by==qualifiedName)
direction=order.dir;}}
else if(target=="M"){if(ordersMap.axes.hasOwnProperty("measures")){var order=ordersMap.axes.measures;if(order.by==qualifiedName)
direction=order.dir;}}
return direction;}
myself.sort=function(target,by,direction){var removeSort=by=="";if(target=="D"){if(removeSort)
delete ordersMap.axes.dimensions;else
ordersMap.axes.dimensions={by:by,dir:direction};}
else if(target=="M"){if(removeSort)
delete ordersMap.axes.measures;else
ordersMap.axes.measures={by:by,dir:direction};}}
myself.clearSort=function(qualifiedName,hierarchyRemoval){var hierarchy=(qualifiedName.split("].[")[0]+"]").replace("]]","]");if(ordersMap.axes.hasOwnProperty("dimensions")&&((!hierarchyRemoval&&ordersMap.axes.dimensions.by==qualifiedName)||(hierarchyRemoval&&ordersMap.axes.dimensions.by.indexOf(hierarchy)==0)))
delete ordersMap.axes.dimensions;else if(ordersMap.axes.hasOwnProperty("measures")&&((!hierarchyRemoval&&ordersMap.axes.measures.by==qualifiedName)||(hierarchyRemoval&&ordersMap.axes.measures.by.indexOf(hierarchy)==0)))
delete ordersMap.axes.measures;if(hierarchyRemoval){for(key in ordersMap.levels){if(key.indexOf(hierarchy)==0)
delete ordersMap.levels[key];}}else{if(ordersMap.levels.hasOwnProperty(qualifiedName))
delete ordersMap.levels[qualifiedName];}}
return myself;}
var bt=bt||{};bt.olap=bt.olap||{};bt.olap.OlapCube=function(spec){var defaults={url:bt.helpers.olap.getServiceUrl(),catalog:"",cube:"",jndi:""};var myself={};myself.options=$.extend({},defaults,spec);var olapUtils=null;var structure=null;var hierarchies=[];var levels=[];var formatStrings=[];var captions={hierarchies:[],levels:[]};myself.initialize=function(){olapUtils=new bt.utils.OlapUtils(myself.options);structure=olapUtils.getCube();$.each(myself.getStructure().dimensions,function(dKey,dValue){$.each(dValue.hierarchies,function(hKey,hValue){hierarchies.push(hValue);captions.hierarchies[hValue.qualifiedName]=hValue.caption;$.each(hValue.levels,function(lKey,lValue){levels.push(lValue);captions.levels[lValue.qualifiedName]=lValue.caption;});});});captions.hierarchies["[Measures]"]="Measures";$.each(myself.getStructure().measures,function(key,value){formatStrings[value.qualifiedName]=value.formatString;captions.levels[value.qualifiedName]=value.caption;});};myself.getStructure=function(){return structure;};myself.getHierarchies=function(){return hierarchies;};myself.getLevels=function(){return levels;};myself.getFormatStrings=function(){return formatStrings;};myself.getCaption=function(qualifiedName){if(qualifiedName.indexOf("].[")<0)
return captions.hierarchies[qualifiedName];else
return captions.levels[qualifiedName];};myself.getFullCaption=function(qualifiedName){var hierarchy=qualifiedName.split("].[")[0]+"]";return captions.hierarchies[hierarchy]+" -> "+captions.levels[qualifiedName];};myself.getQualifiedNameByCaption=function(caption,type){if(type=="L"){for(key in captions.levels){if(captions.levels[key]==caption)
return key;}}
else if(type=="H"){for(key in captions.hierarchies){if(captions.hierarchies[key]==caption)
return key;}}
return null;};myself.getElementName=function(qualifiedName){var result=qualifiedName;$.each(myself.getLevels(),function(key,value){if(value.qualifiedName==qualifiedName){result=value.name;return;}});$.each(myself.getStructure().measures,function(key,value){if(value.qualifiedName==qualifiedName){result=value.name;return;}});return result;};myself.getElementFullName=function(qualifiedName){var result=qualifiedName;$.each(myself.getLevels(),function(key,value){if(value.qualifiedName==qualifiedName){var h=qualifiedName.split("].[")[0].substring(1);var l=value.name;result=h+" -> "+l;return;}});$.each(myself.getStructure().measures,function(key,value){if(value.qualifiedName==qualifiedName){var h=qualifiedName.split("].[")[0].substring(1);var l=value.name;result=h+" -> "+l;return;}});return result;};myself.getElementType=function(qualifiedName){var result=undefined;var found=false;var arr=$.map(myself.getLevels(),function(i){return i.qualifiedName});var idx=$.inArray(qualifiedName,arr);if(idx>=0){result="DIMENSION";found=true;}
if(!found){arr=$.map(myself.getStructure().measures,function(i){return i.qualifiedName});idx=$.inArray(qualifiedName,arr);if(idx>=0){result="MEASURE";}}
return result;};myself.getLevelDepth=function(qualifiedName){var result=1;$.each(myself.getLevels(),function(key,value){if(value.qualifiedName==qualifiedName){result=value.depth;return;}});return result;};myself.getHierarchyLevels=function(hierarchyQualifiedName){var levels=new Array();$.each(hierarchies,function(key,value){if(value.qualifiedName==hierarchyQualifiedName){$.each(value.levels,function(key,value){levels.push(value);});return levels;}});return levels;};myself.getLevelMembers=function(levelQualifiedName){return olapUtils.getLevelMembers({level:levelQualifiedName,cube:myself.options.cube});};myself.initialize();return myself;}
var bt=bt||{};bt.utils=bt.utils||{};bt.utils.OlapUtils=function(spec){var defaults={url:bt.helpers.olap.getServiceUrl(),extraParams:{}};var myself={};myself.options=$.extend({},defaults,spec);var catalog=myself.options.catalog;var cube=myself.options.cube;var cubeStructureCache={};var olapOperations={GET_OLAP_CUBES:bt.helpers.olap.getCubesUrl(),GET_CUBE_STRUCTURE:bt.helpers.olap.getCubeStructureUrl()};myself.getOlapUtilsUrl=function(){return myself.options.url};myself.getCubeStructure=function(_args){var catalog=myself.getSelectedCatalogName(_args);var cube=myself.getSelectedCubeName(_args);var cacheKey=catalog+"::"+cube;if(!catalog||!cube){return null;}
if(cubeStructureCache[cacheKey]){return cubeStructureCache[cacheKey];}
var params={operation:olapOperations.GET_CUBE_STRUCTURE,catalog:catalog,cube:cube};var result=myself.callOlapUtilsSync(params);cubeStructureCache[cacheKey]=result;return result;};myself.getSelectedCatalogName=function(_args){var catalog=$.extend({},myself.options,_args).catalog;return bt.helpers.olap.getNormalizedCatalog(catalog);};myself.getSelectedCubeName=function(_args){return $.extend({},myself.options,_args).cube;};myself.callOlapUtilsSync=function(params){return myself.callOlapUtils(params,undefined,undefined,true);};myself.callOlapUtils=function(params,callback,errorCallback,sync){var myself=this;var ret;$.ajax({type:"GET",url:myself.getOlapUtilsUrl()+params.operation,data:$.extend({},myself.options.extraParams,params),dataType:"json",success:function(json){if(json&&json.status=="true"&&json.result){if(sync){ret=json.result}
else{callback(json.result);}}
else{if(typeof(errorCallback)!='function')errorCallback=alert;return errorCallback(json);}},async:!sync});return ret;};myself.getCube=function(_args){return myself.getCubeStructure(_args);};myself.getLevelMembers=function(_args,callback){var apiUrl=bt.helpers.cda.getServiceUrl();var level=_args.level;var cube=_args.cube;var mdxQuery="with member [Measures].[Unique Name] as '"+level+".CurrentMember.UniqueName' select distinct("+level+".Members) on Rows, {[Measures].[Unique Name]} ON Columns from ["+cube+"]";var params={path:bt.helpers.cda.getFilePath(myself.options.catalog,myself.options.jndi),dataAccessId:"BTableQueryCompact",parammdxQuery:mdxQuery};var result;$.ajax({type:"GET",url:apiUrl,data:params,dataType:"json",success:function(json){if(json&&json.resultset){result=json.resultset}},async:false});var members=[];$.each(result,function(i,v){members.push({name:v[0],qualifiedName:v[1]});});return{members:members};};return myself;}
function getURLQuery(){var query={};var conditions=window.location.search.slice(1).split('&');$.each(conditions,function(i,c){var condition=c.split('=');query[condition[0]]=decodeURIComponent(condition[1]);});return query;}
function getTimer(spec){var defaults={log:true,component:{type:"BTable",name:""},};var myself={};myself.options=$.extend({},defaults,spec);var startDate=null;var prevDate=null;var lastDate=null;var lastElapsedTime=0;var totalElapsedTime=0;myself.start=function(message){startDate=new Date();prevDate=startDate;lastDate=startDate;lastElapsedTime=0;totalElapsedTime=0;if(myself.options.log)
myself.log("START",message);};myself.check=function(message){if(startDate!=null){lastDate=new Date();lastElapsedTime=lastDate.getTime()-prevDate.getTime();totalElapsedTime=lastDate.getTime()-startDate.getTime();prevDate=lastDate;if(myself.options.log)
myself.log("CHECK",message);}else{console.log("You have missed to start timer for component '"+myself.options.component.name+"' !");}};myself.log=function(action,message){var text="TIMER."+action+" ["+myself.options.component.type+": "+myself.options.component.name+"] >> "+message+" @ "+myself.formatDate(lastDate);if(action=="CHECK")
text+=" ("+myself.formatTime(lastElapsedTime)+" since last check, "+myself.formatTime(totalElapsedTime)+" since start)";console.log(text);};myself.formatDate=function(date){var year=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var seconds=date.getSeconds();var milliseconds=date.getMilliseconds();return year+"/"+(month<10?"0":"")+month+"/"+(day<10?"0":"")+day+" "+(hours<10?"0":"")+hours+":"+(minutes<10?"0":"")+minutes+":"+(seconds<10?"0":"")+seconds+"."+(milliseconds<10?"00":(milliseconds<100?"0":""))+milliseconds;}
myself.formatTime=function(milliseconds){var seconds=milliseconds/1000;return seconds+" s";}
return myself;}
function getLocalizedFormattedValue(formatString,valueString){var formattedValueString=valueString;var testZeroValue=function(v){var n=parseFloat(v);return isNaN(n)||n==0;};switch(formatString.toLowerCase()){case"":return valueString;case"none":return valueString;case"general number":formatString="0.00";break;case"currency":formatString="#,##0.00";break;case"fixed":formatString="0,.00####";break;case"standard":formatString="#,##0";break;case"percent":formatString="0.00%";break;case"scientific":formatString="0.00e+00";break;case"yes/no":return testZeroValue(valueString)?"No":"Yes";case"true/false":return testZeroValue(valueString)?"False":"True";case"on/off":return testZeroValue(valueString)?"Off":"On";default:break;}
var formatStringSections=[];var re=new RegExp(/\|[^|]*\|/);var match=re.exec(formatString);if(match==null){var formatExpressions=formatString.split(";");formatStringSections[0]=formatExpressions[0];formatStringSections[1]=formatExpressions[1]===undefined||formatExpressions[1]===""?"-"+formatExpressions[0]:formatExpressions[1];formatStringSections[2]=formatExpressions[2]===undefined||formatExpressions[2]===""?formatExpressions[0]:formatExpressions[2];formatStringSections[3]=formatExpressions[3]===undefined?"":formatExpressions[3];}else{var formatExpression=match[0].substring(1,match[0].length-1).replace(/[-()]/g,"").replace("+","");formatStringSections[0]=formatExpression;formatStringSections[1]="-"+formatExpression;formatStringSections[2]=formatExpression;formatStringSections[3]="";}
var valueNumber=parseFloat(valueString);var selectedFormatSection=formatStringSections[3];if(!isNaN(valueNumber)){if(valueNumber>0)
selectedFormatSection=formatStringSections[0];else if(valueNumber<0)
selectedFormatSection=formatStringSections[1];else if(valueNumber==0)
selectedFormatSection=formatStringSections[2];valueNumber=Math.abs(valueNumber);if(selectedFormatSection.indexOf("%")>-1)
valueNumber=valueNumber*100;}
var scientificFormat=false;var eChar="e";var eSign="+";var eDigits="";var exponent=null;var originalSelectedFormatSection=selectedFormatSection;var originalFormat="";var re1=new RegExp(/[#0,.]*[eE][+-][0#]+/);if(re1.test(selectedFormatSection)){scientificFormat=true;var match1=re1.exec(selectedFormatSection);originalFormat=match1[0];if(originalFormat.indexOf("E")>-1)
eChar="E";if(originalFormat.indexOf("-")>-1)
eSign="-";var eSides=selectedFormatSection.split(eChar+eSign);selectedFormatSection=eSides[0];eDigits=eSides[1];var exponentialParts=(valueNumber.toExponential()+"").split("e");valueNumber=parseFloat(exponentialParts[0]);var exponent=parseInt(exponentialParts[1]);}
var re2=new RegExp(/[#0,.]+/);var match2=re2.exec(selectedFormatSection);var format=match2==null?"":match2[0];if(format!=""){var formatParts=format.split(".");var re3=new RegExp(/[,]+$/);var match3=re3.exec(formatParts[0]);var formatHasScalingFactor=match3!=null;if(formatHasScalingFactor){var divisor=Math.pow(10,match3[0].length*3);valueNumber=valueNumber/divisor;}
var formatWithoutScalingFactor=formatHasScalingFactor?(formatParts[0].replace(re3,"")+(formatParts.length>1?("."+formatParts[1]):"")):format;var re4=new RegExp(/\.[#0]+/);var match4=re4.exec(format);var formatHasDecimals=match4!=null;var formatDecimalsCount=formatHasDecimals?match4[0].length-1:0;var formatMandatoryDecimalsCount=!formatHasDecimals||match4[0].lastIndexOf("0")<0?0:match4[0].lastIndexOf("0");valueNumber=valueNumber.toFixed(formatDecimalsCount);var formattedNumber=valueNumber+"";var numberParts=formattedNumber.split('.');var integerPart=numberParts[0];var decimalPart=numberParts.length>1?numberParts[1]:"";if(formatHasDecimals){var numberDecimalsCount=decimalPart.length;if(numberDecimalsCount<formatMandatoryDecimalsCount){for(var i=numberDecimalsCount;i<formatMandatoryDecimalsCount;i++)
decimalPart+="0";}else{var gap=numberDecimalsCount-formatMandatoryDecimalsCount;while(gap>0){decimalPart=decimalPart.replace(eval(/[0]$/),"");gap--;}}}
var formatHasThousandsSeparators=formatWithoutScalingFactor.indexOf(",")>-1;var formatIntegerPart=formatWithoutScalingFactor.split(".")[0];var reversedFormatIntegerPart=formatIntegerPart.split("").reverse().join("");var formatMandatoryIntegerPartLength=reversedFormatIntegerPart.lastIndexOf("0")<0?0:reversedFormatIntegerPart.lastIndexOf("0")+1;var numberIntegerPartLength=integerPart.length;if(integerPart=="0"&&formatMandatoryIntegerPartLength==0)
integerPart="";else if(numberIntegerPartLength<formatMandatoryIntegerPartLength){for(var i=numberIntegerPartLength;i<formatMandatoryIntegerPartLength;i++)
integerPart="0"+integerPart;}
var separators=getNumberSeparators(navigator.language||navigator.userLanguage);if(formatHasThousandsSeparators){var re5=/(\d+)(\d{3})/;while(re5.test(integerPart))
integerPart=integerPart.replace(re5,'$1'+separators.thousands+'$2');}
formattedNumber=integerPart+(decimalPart.length>0?separators.decimals+decimalPart:"");formattedValueString=formattedNumber.length>0?selectedFormatSection.replace(format,formattedNumber):"";}else{formattedValueString=selectedFormatSection;}
if(scientificFormat){var exponentString=Math.abs(exponent)+"";for(var i=exponentString.length;i<eDigits;i++)
exponentString="0"+exponentString;var signChar="";if(exponent<0)
signChar="-";else{if(eSign=="+")
signChar="+";}
var formattedNumber=formattedValueString+eChar+signChar+exponentString;formattedValueString=originalSelectedFormatSection.replace(originalFormat,formattedNumber);}
return formattedValueString;}
function getNumberSeparators(lang){if(numberSeparatorsCache.hasOwnProperty(lang))
return numberSeparatorsCache[lang];var langParts=lang.split("-");var language=langParts[0].toLowerCase();var country=langParts.length>1?langParts[1].toUpperCase():"";var code=language+(country!=""?"-":"")+country;var separators={thousands:",",decimals:"."};if(format1Locales.indexOf(code)>-1){separators={thousands:",",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
if(format2Locales.indexOf(code)>-1){separators={thousands:".",decimals:","};numberSeparatorsCache[lang]=separators;return separators;}
if(format3Locales.indexOf(code)>-1){separators={thousands:"'",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
if(format4Locales.indexOf(code)>-1){separators={thousands:" ",decimals:","};numberSeparatorsCache[lang]=separators;return separators;}
if(format5Locales.indexOf(code)>-1){separators={thousands:",",decimals:"/"};numberSeparatorsCache[lang]=separators;return separators;}
if(format6Locales.indexOf(code)>-1){separators={thousands:" ",decimals:"-"};numberSeparatorsCache[lang]=separators;return separators;}
if(format7Locales.indexOf(code)>-1){separators={thousands:" ",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format1Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:",",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format2Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:".",decimals:","};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format3Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:"'",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format4Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:" ",decimals:","};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format5Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:",",decimals:"/"};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format6Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:" ",decimals:"-"};numberSeparatorsCache[lang]=separators;return separators;}
if($.map(format7Locales,function(v,i){return v.split("-")[0].toLowerCase();}).indexOf(language)>-1){separators={thousands:" ",decimals:"."};numberSeparatorsCache[lang]=separators;return separators;}
numberSeparatorsCache[lang]=separators;return separators;}
var numberSeparatorsCache={};var format1Locales=["","ar-SA","zh-TW","en-US","he-IL","ja-JP","ko-KR","th-TH","ur-PK","hy-AM","af-ZA","hi-IN","sw-KE","pa-IN","gu-IN","ta-IN","te-IN","kn-IN","mr-IN","sa-IN","kok-IN","syr-SY","dv-MV","ar-IQ","zh-CN","en-GB","es-MX","ar-EG","zh-HK","en-AU","ar-LY","zh-SG","en-CA","es-GT","ar-DZ","zh-MO","en-NZ","ar-MA","en-IE","es-PA","ar-TN","en-ZA","es-DO","ar-OM","en-JM","ar-YE","en-029","ar-SY","en-BZ","es-PE","ar-JO","en-TT","ar-LB","en-ZW","ar-KW","en-PH","ar-AE","ar-BH","ar-QA","es-SV","es-HN","es-NI","es-PR","zu-ZA","xh-ZA","tn-ZA","quz-PE","cy-GB","fil-PH","iu-Latn-CA","mi-NZ","ga-IE","moh-CA","ns-ZA","mt-MT"];var format2Locales=["es","ca-ES","da-DK","de-DE","el-GR","is-IS","it-IT","nl-NL","pt-BR","ro-RO","hr-HR","sq-AL","sv-SE","tr-TR","id-ID","sl-SI","lt-LT","vi-VN","eu-ES","mk-MK","fo-FO","ms-MY","gl-ES","fr-BE","nl-BE","pt-PT","sr-Latn-CS","ms-BN","de-AT","es-ES","sr-Cyrl-CS","de-LU","es-CR","es-VE","es-CO","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","sr-Cyrl-BA","fy-NL","se-SE","sma-SE","hr-BA","bs-Latn-BA","bs-Cyrl-BA","arn-CL","quz-EC","sr-Latn-BA","smj-SE","quz-BO"];var format3Locales=["de-CH","it-CH","fr-CH","de-LI","rm-CH"];var format4Locales=["fr","no","bg-BG","cs-CZ","fi-FI","fr-FR","hu-HU","nb-NO","pl-PL","ru-RU","sk-SK","uk-UA","be-BY","lv-LV","az-Latn-AZ","ka-GE","uz-Latn-UZ","tt-RU","mn-MN","nn-NO","sv-FI","az-Cyrl-AZ","uz-Cyrl-UZ","fr-CA","fr-LU","fr-MC","sma-NO","smn-FI","se-FI","sms-FI","smj-NO","lb-LU","se-NO"];var format5Locales=["fa-IR"];var format6Locales=["kk-KZ","ky-KG",];var format7Locales=["et-EE"];(function($){$.fn.fixHeader=function(){return this.each(function(){var $this=$(this),$t_fixed;var $component=$("#"+$this.attr("id").replace("Table",""));var overflowX=$component.css("overflow-x");var overflowY=$component.css("overflow-y");var hasOverflowX=overflowX=="scroll"||overflowX=="auto";var hasOverflowY=overflowY=="scroll"||overflowY=="auto";var hasFixedWidth=$component.width()<$this.width();var hasFixedHeight=$component.height()<$this.height();function init(){$t_fixed_table=$this.clone();$t_fixed_table.find("tbody").remove().end().css("width",($this.width()+1)+"px");$t_fixed=$("<div></div>");$t_fixed.attr("id",$this.attr("id")+"_fixedHeader").css("width",($component.width()-(hasFixedHeight&&hasOverflowY?getScrollBarWidth():0))+"px").css("position","fixed").css("display","none").insertBefore($this);if(hasFixedHeight&&hasOverflowY)
$t_fixed.css("top",$("#"+$this.attr("id").replace("Table","")).offset().top-$(window).scrollTop());else
$t_fixed.css("top","0");if(hasFixedWidth&&hasOverflowX)
$t_fixed.css("overflow","hidden");$t_fixed.append($t_fixed_table);resizeFixed();}
function resizeFixed(){$t_fixed.find("th").each(function(index){$(this).css("width",$this.find("th").eq(index).width()+"px");});}
function vScrollFixed(){var offset=$(this).scrollTop(),tableOffsetTop=$this.offset().top,tableOffsetBottom=tableOffsetTop+$this.height()-$this.find("thead").height();if(offset<tableOffsetTop||offset>tableOffsetBottom)
$t_fixed.hide();else if(offset>=tableOffsetTop&&offset<=tableOffsetBottom&&$t_fixed.is(":hidden"))
$t_fixed.show();}
function hScrollFixed(){var offsetLeft=$(this).scrollLeft();var tableOffsetLeft=$this.offset().left;if(offsetLeft>0)
$t_fixed.css("left",tableOffsetLeft-offsetLeft);else
$t_fixed.css("left",tableOffsetLeft);}
function vScrollFixedOverflow(){var $filtersPanel=$("#"+$this.attr("id").replace("Table","FiltersPanel"));var offset=$(this).scrollTop(),tableOffsetTop=$this.position().top+$this.find("thead").height()+($filtersPanel.css("display")=="none"?0:$filtersPanel.height()),tableOffsetBottom=tableOffsetTop+($this.height()-$component.height());if(offset<tableOffsetTop||offset>tableOffsetBottom)
$t_fixed.hide();else if(offset>=tableOffsetTop&&offset<=tableOffsetBottom&&$t_fixed.is(":hidden"))
$t_fixed.show();}
function hScrollFixedOverflow(){var offsetLeft=$(this).scrollLeft();var tableOffsetLeft=$this.offset().left;$t_fixed.scrollLeft(offsetLeft);}
function getScrollBarWidth(){var inner=document.createElement('p');inner.style.width="100%";inner.style.height="200px";var outer=document.createElement('div');outer.style.position="absolute";outer.style.top="0px";outer.style.left="0px";outer.style.visibility="hidden";outer.style.width="200px";outer.style.height="150px";outer.style.overflow="hidden";outer.appendChild(inner);document.body.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow='scroll';var w2=inner.offsetWidth;if(w1==w2)w2=outer.clientWidth;document.body.removeChild(outer);return(w1-w2);}
$(window).resize(resizeFixed);if(hasFixedWidth&&hasOverflowX)
$component.scroll(hScrollFixedOverflow);else
$(window).scroll(hScrollFixed);if(hasFixedHeight&&hasOverflowY){$component.scroll(vScrollFixedOverflow);$(window).scroll(function(){$t_fixed.css("top",$component.offset().top-$(window).scrollTop());});}
else
$(window).scroll(vScrollFixed);init();});};})(jQuery);var isMobile={Android:function(){return navigator.userAgent.match(/Android/i);},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i);},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i);},Opera:function(){return navigator.userAgent.match(/Opera Mini/i);},Windows:function(){return navigator.userAgent.match(/IEMobile/i);},any:function(){return(isMobile.Android()||isMobile.BlackBerry()||isMobile.iOS()||isMobile.Opera()||isMobile.Windows());}};
var bt=bt||{};bt.helpers=bt.helpers||{};(function(obj){obj.general={getLangDirPath:function(){return Dashboards.getWebAppPath()+"/content/BTable/resources/components/BTable/lang/";},getImgDirPath:function(){return Dashboards.getWebAppPath()+"/content/BTable/resources/components/BTable/img/";},getRenderServiceUrl:function(){return Dashboards.getWebAppPath()+"/plugin/BTable/api/render";},getExploreRepositoryServiceUrl:function(){return Dashboards.getWebAppPath()+"/plugin/pentaho-cdf-dd/api/resources/explore?fileExtensions=.btable&access=create";},getSaveFileServiceUrl:function(){return Dashboards.getWebAppPath()+"/plugin/BTable/api/file/save";},getReadFileServiceUrl:function(path){return Dashboards.getWebAppPath()+"/plugin/BTable/api/file/read?path="+path;}};obj.util={getServiceResultEvaluation:function(result){return result;}};obj.cda={getFilePath:function(catalog,jndi){return"/system/BTable/resources/datasources/"+catalog.replace("mondrian:/","")+"_"+jndi+".cda";},getServiceUrl:function(){return Dashboards.getWebAppPath()+"/plugin/cda/api/doQuery";}};obj.olap={getServiceUrl:function(){return Dashboards.getWebAppPath()+"/plugin/BTable/api/olap/";},getCubesUrl:function(){return"getCubes";},getCubeStructureUrl:function(){return"getCubeStructure";},getNormalizedCatalog:function(catalog){var normalizedCatalog=catalog;return normalizedCatalog;}};})(bt.helpers);jQuery.i18n.properties({name:'messages',path:bt.helpers.general.getLangDirPath(),mode:'map',callback:function(){}});
(function($,undefined){$.support.htmlMenuitem=('HTMLMenuItemElement'in window);$.support.htmlCommand=('HTMLCommandElement'in window);$.support.eventSelectstart=("onselectstart"in document.documentElement);if(!$.ui||!$.ui.widget){var _cleanData=$.cleanData;$.cleanData=function(elems){for(var i=0,elem;(elem=elems[i])!=null;i++){try{$(elem).triggerHandler("remove");}catch(e){}}
_cleanData(elems);};}
var
$currentTrigger=null,initialized=false,$win=$(window),counter=0,namespaces={},menus={},types={},defaults={selector:null,appendTo:null,trigger:"right",autoHide:false,delay:200,reposition:true,determinePosition:function($menu){if($.ui&&$.ui.position){$menu.css('display','block').position({my:"center top",at:"center bottom",of:this,offset:"0 5",collision:"fit"}).css('display','none');}else{var offset=this.offset();offset.top+=this.outerHeight();offset.left+=this.outerWidth()/2-$menu.outerWidth()/2;$menu.css(offset);}},position:function(opt,x,y){var $this=this,offset;if(!x&&!y){opt.determinePosition.call(this,opt.$menu);return;}else if(x==="maintain"&&y==="maintain"){offset=opt.$menu.position();}else{offset={top:y,left:x};}
var bottom=$win.scrollTop()+$win.height(),right=$win.scrollLeft()+$win.width(),height=opt.$menu.height(),width=opt.$menu.width();if(offset.top+height>bottom){offset.top-=height;}
if(offset.left+width>right){offset.left-=width;}
opt.$menu.css(offset);},positionSubmenu:function($menu){if($.ui&&$.ui.position){$menu.css('display','block').position({my:"left top",at:"right top",of:this,collision:"flipfit fit"}).css('display','');}else{var offset={top:0,left:this.outerWidth()};$menu.css(offset);}},zIndex:1,animation:{duration:50,show:'slideDown',hide:'slideUp'},events:{show:$.noop,hide:$.noop},callback:null,items:{}},hoveract={timer:null,pageX:null,pageY:null},zindex=function($t){var zin=0,$tt=$t;while(true){zin=Math.max(zin,parseInt($tt.css('z-index'),10)||0);$tt=$tt.parent();if(!$tt||!$tt.length||"html body".indexOf($tt.prop('nodeName').toLowerCase())>-1){break;}}
return zin;},handle={abortevent:function(e){e.preventDefault();e.stopImmediatePropagation();},contextmenu:function(e){var $this=$(this);e.preventDefault();e.stopImmediatePropagation();if(e.data.trigger!='right'&&e.originalEvent){return;}
if($this.hasClass('context-menu-active')){return;}
if(!$this.hasClass('context-menu-disabled')){$currentTrigger=$this;if(e.data.build){var built=e.data.build($currentTrigger,e);if(built===false){return;}
e.data=$.extend(true,{},defaults,e.data,built||{});if(!e.data.items||$.isEmptyObject(e.data.items)){if(window.console){(console.error||console.log)("No items specified to show in contextMenu");}
throw new Error('No Items sepcified');}
e.data.$trigger=$currentTrigger;op.create(e.data);}
op.show.call($this,e.data,e.pageX,e.pageY);}},click:function(e){e.preventDefault();e.stopImmediatePropagation();$(this).trigger($.Event("contextmenu",{data:e.data,pageX:e.pageX,pageY:e.pageY}));},mousedown:function(e){var $this=$(this);if($currentTrigger&&$currentTrigger.length&&!$currentTrigger.is($this)){$currentTrigger.data('contextMenu').$menu.trigger('contextmenu:hide');}
if(e.button==2){$currentTrigger=$this.data('contextMenuActive',true);}},mouseup:function(e){var $this=$(this);if($this.data('contextMenuActive')&&$currentTrigger&&$currentTrigger.length&&$currentTrigger.is($this)&&!$this.hasClass('context-menu-disabled')){e.preventDefault();e.stopImmediatePropagation();$currentTrigger=$this;$this.trigger($.Event("contextmenu",{data:e.data,pageX:e.pageX,pageY:e.pageY}));}
$this.removeData('contextMenuActive');},mouseenter:function(e){var $this=$(this),$related=$(e.relatedTarget),$document=$(document);if($related.is('.context-menu-list')||$related.closest('.context-menu-list').length){return;}
if($currentTrigger&&$currentTrigger.length){return;}
hoveract.pageX=e.pageX;hoveract.pageY=e.pageY;hoveract.data=e.data;$document.on('mousemove.contextMenuShow',handle.mousemove);hoveract.timer=setTimeout(function(){hoveract.timer=null;$document.off('mousemove.contextMenuShow');$currentTrigger=$this;$this.trigger($.Event("contextmenu",{data:hoveract.data,pageX:hoveract.pageX,pageY:hoveract.pageY}));},e.data.delay);},mousemove:function(e){hoveract.pageX=e.pageX;hoveract.pageY=e.pageY;},mouseleave:function(e){var $related=$(e.relatedTarget);if($related.is('.context-menu-list')||$related.closest('.context-menu-list').length){return;}
try{clearTimeout(hoveract.timer);}catch(e){}
hoveract.timer=null;},layerClick:function(e){var $this=$(this),root=$this.data('contextMenuRoot'),mouseup=false,button=e.button,x=e.pageX,y=e.pageY,target,offset,selectors;e.preventDefault();e.stopImmediatePropagation();setTimeout(function(){var $window,hideshow,possibleTarget;var triggerAction=((root.trigger=='left'&&button===0)||(root.trigger=='right'&&button===2));if(document.elementFromPoint){root.$layer.hide();target=document.elementFromPoint(x-$win.scrollLeft(),y-$win.scrollTop());root.$layer.show();}
if(root.reposition&&triggerAction){if(document.elementFromPoint){if(root.$trigger.is(target)||root.$trigger.has(target).length){root.position.call(root.$trigger,root,x,y);return;}}else{offset=root.$trigger.offset();$window=$(window);offset.top+=$window.scrollTop();if(offset.top<=e.pageY){offset.left+=$window.scrollLeft();if(offset.left<=e.pageX){offset.bottom=offset.top+root.$trigger.outerHeight();if(offset.bottom>=e.pageY){offset.right=offset.left+root.$trigger.outerWidth();if(offset.right>=e.pageX){root.position.call(root.$trigger,root,x,y);return;}}}}}}
if(target&&triggerAction){root.$trigger.one('contextmenu:hidden',function(){$(target).contextMenu({x:x,y:y});});}
root.$menu.trigger('contextmenu:hide');},50);},keyStop:function(e,opt){if(!opt.isInput){e.preventDefault();}
e.stopPropagation();},key:function(e){var opt=$currentTrigger.data('contextMenu')||{};switch(e.keyCode){case 9:case 38:handle.keyStop(e,opt);if(opt.isInput){if(e.keyCode==9&&e.shiftKey){e.preventDefault();opt.$selected&&opt.$selected.find('input, textarea, select').blur();opt.$menu.trigger('prevcommand');return;}else if(e.keyCode==38&&opt.$selected.find('input, textarea, select').prop('type')=='checkbox'){e.preventDefault();return;}}else if(e.keyCode!=9||e.shiftKey){opt.$menu.trigger('prevcommand');return;}
case 40:handle.keyStop(e,opt);if(opt.isInput){if(e.keyCode==9){e.preventDefault();opt.$selected&&opt.$selected.find('input, textarea, select').blur();opt.$menu.trigger('nextcommand');return;}else if(e.keyCode==40&&opt.$selected.find('input, textarea, select').prop('type')=='checkbox'){e.preventDefault();return;}}else{opt.$menu.trigger('nextcommand');return;}
break;case 37:handle.keyStop(e,opt);if(opt.isInput||!opt.$selected||!opt.$selected.length){break;}
if(!opt.$selected.parent().hasClass('context-menu-root')){var $parent=opt.$selected.parent().parent();opt.$selected.trigger('contextmenu:blur');opt.$selected=$parent;return;}
break;case 39:handle.keyStop(e,opt);if(opt.isInput||!opt.$selected||!opt.$selected.length){break;}
var itemdata=opt.$selected.data('contextMenu')||{};if(itemdata.$menu&&opt.$selected.hasClass('context-menu-submenu')){opt.$selected=null;itemdata.$selected=null;itemdata.$menu.trigger('nextcommand');return;}
break;case 35:case 36:if(opt.$selected&&opt.$selected.find('input, textarea, select').length){return;}else{(opt.$selected&&opt.$selected.parent()||opt.$menu).children(':not(.disabled, .not-selectable)')[e.keyCode==36?'first':'last']().trigger('contextmenu:focus');e.preventDefault();return;}
break;case 13:handle.keyStop(e,opt);if(opt.isInput){if(opt.$selected&&!opt.$selected.is('textarea, select')){e.preventDefault();return;}
break;}
opt.$selected&&opt.$selected.trigger('mouseup');return;case 32:case 33:case 34:handle.keyStop(e,opt);return;case 27:handle.keyStop(e,opt);opt.$menu.trigger('contextmenu:hide');return;default:var k=(String.fromCharCode(e.keyCode)).toUpperCase();if(opt.accesskeys[k]){opt.accesskeys[k].$node.trigger(opt.accesskeys[k].$menu?'contextmenu:focus':'mouseup');return;}
break;}
e.stopPropagation();opt.$selected&&opt.$selected.trigger(e);},prevItem:function(e){e.stopPropagation();var opt=$(this).data('contextMenu')||{};if(opt.$selected){var $s=opt.$selected;opt=opt.$selected.parent().data('contextMenu')||{};opt.$selected=$s;}
var $children=opt.$menu.children(),$prev=!opt.$selected||!opt.$selected.prev().length?$children.last():opt.$selected.prev(),$round=$prev;while($prev.hasClass('disabled')||$prev.hasClass('not-selectable')){if($prev.prev().length){$prev=$prev.prev();}else{$prev=$children.last();}
if($prev.is($round)){return;}}
if(opt.$selected){handle.itemMouseleave.call(opt.$selected.get(0),e);}
handle.itemMouseenter.call($prev.get(0),e);var $input=$prev.find('input, textarea, select');if($input.length){$input.focus();}},nextItem:function(e){e.stopPropagation();var opt=$(this).data('contextMenu')||{};if(opt.$selected){var $s=opt.$selected;opt=opt.$selected.parent().data('contextMenu')||{};opt.$selected=$s;}
var $children=opt.$menu.children(),$next=!opt.$selected||!opt.$selected.next().length?$children.first():opt.$selected.next(),$round=$next;while($next.hasClass('disabled')||$next.hasClass('not-selectable')){if($next.next().length){$next=$next.next();}else{$next=$children.first();}
if($next.is($round)){return;}}
if(opt.$selected){handle.itemMouseleave.call(opt.$selected.get(0),e);}
handle.itemMouseenter.call($next.get(0),e);var $input=$next.find('input, textarea, select');if($input.length){$input.focus();}},focusInput:function(e){var $this=$(this).closest('.context-menu-item'),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.$selected=opt.$selected=$this;root.isInput=opt.isInput=true;},blurInput:function(e){var $this=$(this).closest('.context-menu-item'),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.isInput=opt.isInput=false;},menuMouseenter:function(e){var root=$(this).data().contextMenuRoot;root.hovering=true;},menuMouseleave:function(e){var root=$(this).data().contextMenuRoot;if(root.$layer&&root.$layer.is(e.relatedTarget)){root.hovering=false;}},itemMouseenter:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.hovering=true;if(e&&root.$layer&&root.$layer.is(e.relatedTarget)){e.preventDefault();e.stopImmediatePropagation();}
(opt.$menu?opt:root).$menu.children('.hover').trigger('contextmenu:blur');if($this.hasClass('disabled')||$this.hasClass('not-selectable')){opt.$selected=null;return;}
$this.trigger('contextmenu:focus');},itemMouseleave:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;if(root!==opt&&root.$layer&&root.$layer.is(e.relatedTarget)){root.$selected&&root.$selected.trigger('contextmenu:blur');e.preventDefault();e.stopImmediatePropagation();root.$selected=opt.$selected=opt.$node;return;}
$this.trigger('contextmenu:blur');},itemClick:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot,key=data.contextMenuKey,callback;if(!opt.items[key]||$this.is('.disabled, .context-menu-submenu, .context-menu-separator, .not-selectable')){return;}
e.preventDefault();e.stopImmediatePropagation();if($.isFunction(root.callbacks[key])&&Object.prototype.hasOwnProperty.call(root.callbacks,key)){callback=root.callbacks[key];}else if($.isFunction(root.callback)){callback=root.callback;}else{return;}
if(callback.call(root.$trigger,key,root)!==false){root.$menu.trigger('contextmenu:hide');}else if(root.$menu.parent().length){op.update.call(root.$trigger,root);}},inputClick:function(e){e.stopImmediatePropagation();},hideMenu:function(e,data){var root=$(this).data('contextMenuRoot');op.hide.call(root.$trigger,root,data&&data.force);},focusItem:function(e){e.stopPropagation();var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;$this.addClass('hover').siblings('.hover').trigger('contextmenu:blur');opt.$selected=root.$selected=$this;if(opt.$node){root.positionSubmenu.call(opt.$node,opt.$menu);}},blurItem:function(e){e.stopPropagation();var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;$this.removeClass('hover');opt.$selected=null;}},op={show:function(opt,x,y){var $trigger=$(this),offset,css={};$('#context-menu-layer').trigger('mousedown');opt.$trigger=$trigger;if(opt.events.show.call($trigger,opt)===false){$currentTrigger=null;return;}
op.update.call($trigger,opt);opt.position.call($trigger,opt,x,y);if(opt.zIndex){css.zIndex=zindex($trigger)+opt.zIndex;}
op.layer.call(opt.$menu,opt,css.zIndex);opt.$menu.find('ul').css('zIndex',css.zIndex+1);opt.$menu.css(css)[opt.animation.show](opt.animation.duration,function(){$trigger.trigger('contextmenu:visible');});$trigger.data('contextMenu',opt).addClass("context-menu-active");$(document).off('keydown.contextMenu').on('keydown.contextMenu',handle.key);if(opt.autoHide){$(document).on('mousemove.contextMenuAutoHide',function(e){var pos=$trigger.offset();pos.right=pos.left+$trigger.outerWidth();pos.bottom=pos.top+$trigger.outerHeight();if(opt.$layer&&!opt.hovering&&(!(e.pageX>=pos.left&&e.pageX<=pos.right)||!(e.pageY>=pos.top&&e.pageY<=pos.bottom))){opt.$menu.trigger('contextmenu:hide');}});}},hide:function(opt,force){var $trigger=$(this);if(!opt){opt=$trigger.data('contextMenu')||{};}
if(!force&&opt.events&&opt.events.hide.call($trigger,opt)===false){return;}
$trigger.removeData('contextMenu').removeClass("context-menu-active");if(opt.$layer){setTimeout((function($layer){return function(){$layer.remove();};})(opt.$layer),10);try{delete opt.$layer;}catch(e){opt.$layer=null;}}
$currentTrigger=null;opt.$menu.find('.hover').trigger('contextmenu:blur');opt.$selected=null;$(document).off('.contextMenuAutoHide').off('keydown.contextMenu');opt.$menu&&opt.$menu[opt.animation.hide](opt.animation.duration,function(){if(opt.build){opt.$menu.remove();$.each(opt,function(key,value){switch(key){case'ns':case'selector':case'build':case'trigger':return true;default:opt[key]=undefined;try{delete opt[key];}catch(e){}
return true;}});}
setTimeout(function(){$trigger.trigger('contextmenu:hidden');},10);});},create:function(opt,root){if(root===undefined){root=opt;}
opt.$menu=$('<ul class="context-menu-list"></ul>').addClass(opt.className||"").data({'contextMenu':opt,'contextMenuRoot':root});$.each(['callbacks','commands','inputs'],function(i,k){opt[k]={};if(!root[k]){root[k]={};}});root.accesskeys||(root.accesskeys={});$.each(opt.items,function(key,item){var $t=$('<li class="context-menu-item"></li>').addClass(item.className||""),$label=null,$input=null;$t.on('click',$.noop);item.$node=$t.data({'contextMenu':opt,'contextMenuRoot':root,'contextMenuKey':key});if(item.accesskey){var aks=splitAccesskey(item.accesskey);for(var i=0,ak;ak=aks[i];i++){if(!root.accesskeys[ak]){root.accesskeys[ak]=item;item._name=item.name.replace(new RegExp('('+ak+')','i'),'<span class="context-menu-accesskey">$1</span>');break;}}}
if(typeof item=="string"){$t.addClass('context-menu-separator not-selectable');}else if(item.type&&types[item.type]){types[item.type].call($t,item,opt,root);$.each([opt,root],function(i,k){k.commands[key]=item;if($.isFunction(item.callback)){k.callbacks[key]=item.callback;}});}else{if(item.type=='html'){$t.addClass('context-menu-html not-selectable');}else if(item.type){$label=$('<label></label>').appendTo($t);$('<span></span>').html(item._name||item.name).appendTo($label);$t.addClass('context-menu-input');opt.hasTypes=true;$.each([opt,root],function(i,k){k.commands[key]=item;k.inputs[key]=item;});}else if(item.items){item.type='sub';}
switch(item.type){case'text':$input=$('<input type="text" value="1" name="" value="">').attr('name','context-menu-input-'+key).val(item.value||"").appendTo($label);break;case'textarea':$input=$('<textarea name=""></textarea>').attr('name','context-menu-input-'+key).val(item.value||"").appendTo($label);if(item.height){$input.height(item.height);}
break;case'checkbox':$input=$('<input type="checkbox" value="1" name="" value="">').attr('name','context-menu-input-'+key).val(item.value||"").prop("checked",!!item.selected).prependTo($label);break;case'radio':$input=$('<input type="radio" value="1" name="" value="">').attr('name','context-menu-input-'+item.radio).val(item.value||"").prop("checked",!!item.selected).prependTo($label);break;case'select':$input=$('<select name="">').attr('name','context-menu-input-'+key).appendTo($label);if(item.options){$.each(item.options,function(value,text){$('<option></option>').val(value).text(text).appendTo($input);});$input.val(item.selected);}
break;case'sub':$('<span></span>').html(item._name||item.name).appendTo($t);item.appendTo=item.$node;op.create(item,root);$t.data('contextMenu',item).addClass('context-menu-submenu');item.callback=null;break;case'html':$(item.html).appendTo($t);break;default:$.each([opt,root],function(i,k){k.commands[key]=item;if($.isFunction(item.callback)){k.callbacks[key]=item.callback;}});$('<span></span>').html(item._name||item.name||"").appendTo($t);break;}
if(item.type&&item.type!='sub'&&item.type!='html'){$input.on('focus',handle.focusInput).on('blur',handle.blurInput);if(item.events){$input.on(item.events,opt);}}
if(item.icon){$t.addClass("icon icon-"+item.icon);}}
item.$input=$input;item.$label=$label;$t.appendTo(opt.$menu);if(!opt.hasTypes&&$.support.eventSelectstart){$t.on('selectstart.disableTextSelect',handle.abortevent);}});if(!opt.$node){opt.$menu.css('display','none').addClass('context-menu-root');}
opt.$menu.appendTo(opt.appendTo||document.body);},resize:function($menu,nested){$menu.css({position:'absolute',display:'block'});$menu.data('width',Math.ceil($menu.width())+1);$menu.css({position:'static',minWidth:'0px',maxWidth:'100000px'});$menu.find('> li > ul').each(function(){op.resize($(this),true);});if(!nested){$menu.find('ul').andSelf().css({position:'',display:'',minWidth:'',maxWidth:''}).width(function(){return $(this).data('width');});}},update:function(opt,root){var $trigger=this;if(root===undefined){root=opt;op.resize(opt.$menu);}
opt.$menu.children().each(function(){var $item=$(this),key=$item.data('contextMenuKey'),item=opt.items[key],disabled=($.isFunction(item.disabled)&&item.disabled.call($trigger,key,root))||item.disabled===true;$item[disabled?'addClass':'removeClass']('disabled');if(item.type){$item.find('input, select, textarea').prop('disabled',disabled);switch(item.type){case'text':case'textarea':item.$input.val(item.value||"");break;case'checkbox':case'radio':item.$input.val(item.value||"").prop('checked',!!item.selected);break;case'select':item.$input.val(item.selected||"");break;}}
if(item.$menu){op.update.call($trigger,item,root);}});},layer:function(opt,zIndex){var $layer=opt.$layer=$('<div id="context-menu-layer" style="position:fixed; z-index:'+zIndex+'; top:0; left:0; opacity: 0; filter: alpha(opacity=0); background-color: #000;"></div>').css({height:$win.height(),width:$win.width(),display:'block'}).data('contextMenuRoot',opt).insertBefore(this).on('contextmenu',handle.abortevent).on('mousedown',handle.layerClick);if(!$.support.fixedPosition){$layer.css({'position':'absolute','height':$(document).height()});}
return $layer;}};function splitAccesskey(val){var t=val.split(/\s+/),keys=[];for(var i=0,k;k=t[i];i++){k=k[0].toUpperCase();keys.push(k);}
return keys;}
$.fn.contextMenu=function(operation){if(operation===undefined){this.first().trigger('contextmenu');}else if(operation.x&&operation.y){this.first().trigger($.Event("contextmenu",{pageX:operation.x,pageY:operation.y}));}else if(operation==="hide"){var $menu=this.data('contextMenu').$menu;$menu&&$menu.trigger('contextmenu:hide');}else if(operation==="destroy"){$.contextMenu("destroy",{context:this});}else if($.isPlainObject(operation)){operation.context=this;$.contextMenu("create",operation);}else if(operation){this.removeClass('context-menu-disabled');}else if(!operation){this.addClass('context-menu-disabled');}
return this;};$.contextMenu=function(operation,options){if(typeof operation!='string'){options=operation;operation='create';}
if(typeof options=='string'){options={selector:options};}else if(options===undefined){options={};}
var o=$.extend(true,{},defaults,options||{});var $document=$(document);var $context=$document;var _hasContext=false;if(!o.context||!o.context.length){o.context=document;}else{$context=$(o.context).first();o.context=$context.get(0);_hasContext=o.context!==document;}
switch(operation){case'create':if(!o.selector){throw new Error('No selector specified');}
if(o.selector.match(/.context-menu-(list|item|input)($|\s)/)){throw new Error('Cannot bind to selector "'+o.selector+'" as it contains a reserved className');}
if(!o.build&&(!o.items||$.isEmptyObject(o.items))){throw new Error('No Items sepcified');}
counter++;o.ns='.contextMenu'+counter;if(!_hasContext){namespaces[o.selector]=o.ns;}
menus[o.ns]=o;if(!o.trigger){o.trigger='right';}
if(!initialized){$document.on({'contextmenu:hide.contextMenu':handle.hideMenu,'prevcommand.contextMenu':handle.prevItem,'nextcommand.contextMenu':handle.nextItem,'contextmenu.contextMenu':handle.abortevent,'mouseenter.contextMenu':handle.menuMouseenter,'mouseleave.contextMenu':handle.menuMouseleave},'.context-menu-list').on('mouseup.contextMenu','.context-menu-input',handle.inputClick).on({'mouseup.contextMenu':handle.itemClick,'contextmenu:focus.contextMenu':handle.focusItem,'contextmenu:blur.contextMenu':handle.blurItem,'contextmenu.contextMenu':handle.abortevent,'mouseenter.contextMenu':handle.itemMouseenter,'mouseleave.contextMenu':handle.itemMouseleave},'.context-menu-item');initialized=true;}
$context.on('contextmenu'+o.ns,o.selector,o,handle.contextmenu);if(_hasContext){$context.on('remove'+o.ns,function(){$(this).contextMenu("destroy");});}
switch(o.trigger){case'hover':$context.on('mouseenter'+o.ns,o.selector,o,handle.mouseenter).on('mouseleave'+o.ns,o.selector,o,handle.mouseleave);break;case'left':$context.on('click'+o.ns,o.selector,o,handle.click);break;}
if(!o.build){op.create(o);}
break;case'destroy':var $visibleMenu;if(_hasContext){var context=o.context;$.each(menus,function(ns,o){if(o.context!==context){return true;}
$visibleMenu=$('.context-menu-list').filter(':visible');if($visibleMenu.length&&$visibleMenu.data().contextMenuRoot.$trigger.is($(o.context).find(o.selector))){$visibleMenu.trigger('contextmenu:hide',{force:true});}
try{if(menus[o.ns].$menu){menus[o.ns].$menu.remove();}
delete menus[o.ns];}catch(e){menus[o.ns]=null;}
$(o.context).off(o.ns);return true;});}else if(!o.selector){$document.off('.contextMenu .contextMenuAutoHide');$.each(menus,function(ns,o){$(o.context).off(o.ns);});namespaces={};menus={};counter=0;initialized=false;$('#context-menu-layer, .context-menu-list').remove();}else if(namespaces[o.selector]){$visibleMenu=$('.context-menu-list').filter(':visible');if($visibleMenu.length&&$visibleMenu.data().contextMenuRoot.$trigger.is(o.selector)){$visibleMenu.trigger('contextmenu:hide',{force:true});}
try{if(menus[namespaces[o.selector]].$menu){menus[namespaces[o.selector]].$menu.remove();}
delete menus[namespaces[o.selector]];}catch(e){menus[namespaces[o.selector]]=null;}
$document.off(namespaces[o.selector]);}
break;case'html5':if((!$.support.htmlCommand&&!$.support.htmlMenuitem)||(typeof options=="boolean"&&options)){$('menu[type="context"]').each(function(){if(this.id){$.contextMenu({selector:'[contextmenu='+this.id+']',items:$.contextMenu.fromMenu(this)});}}).css('display','none');}
break;default:throw new Error('Unknown operation "'+operation+'"');}
return this;};$.contextMenu.setInputValues=function(opt,data){if(data===undefined){data={};}
$.each(opt.inputs,function(key,item){switch(item.type){case'text':case'textarea':item.value=data[key]||"";break;case'checkbox':item.selected=data[key]?true:false;break;case'radio':item.selected=(data[item.radio]||"")==item.value?true:false;break;case'select':item.selected=data[key]||"";break;}});};$.contextMenu.getInputValues=function(opt,data){if(data===undefined){data={};}
$.each(opt.inputs,function(key,item){switch(item.type){case'text':case'textarea':case'select':data[key]=item.$input.val();break;case'checkbox':data[key]=item.$input.prop('checked');break;case'radio':if(item.$input.prop('checked')){data[item.radio]=item.value;}
break;}});return data;};function inputLabel(node){return(node.id&&$('label[for="'+node.id+'"]').val())||node.name;}
function menuChildren(items,$children,counter){if(!counter){counter=0;}
$children.each(function(){var $node=$(this),node=this,nodeName=this.nodeName.toLowerCase(),label,item;if(nodeName=='label'&&$node.find('input, textarea, select').length){label=$node.text();$node=$node.children().first();node=$node.get(0);nodeName=node.nodeName.toLowerCase();}
switch(nodeName){case'menu':item={name:$node.attr('label'),items:{}};counter=menuChildren(item.items,$node.children(),counter);break;case'a':case'button':item={name:$node.text(),disabled:!!$node.attr('disabled'),callback:(function(){return function(){$node.click();};})()};break;case'menuitem':case'command':switch($node.attr('type')){case undefined:case'command':case'menuitem':item={name:$node.attr('label'),disabled:!!$node.attr('disabled'),callback:(function(){return function(){$node.click();};})()};break;case'checkbox':item={type:'checkbox',disabled:!!$node.attr('disabled'),name:$node.attr('label'),selected:!!$node.attr('checked')};break;case'radio':item={type:'radio',disabled:!!$node.attr('disabled'),name:$node.attr('label'),radio:$node.attr('radiogroup'),value:$node.attr('id'),selected:!!$node.attr('checked')};break;default:item=undefined;}
break;case'hr':item='-------';break;case'input':switch($node.attr('type')){case'text':item={type:'text',name:label||inputLabel(node),disabled:!!$node.attr('disabled'),value:$node.val()};break;case'checkbox':item={type:'checkbox',name:label||inputLabel(node),disabled:!!$node.attr('disabled'),selected:!!$node.attr('checked')};break;case'radio':item={type:'radio',name:label||inputLabel(node),disabled:!!$node.attr('disabled'),radio:!!$node.attr('name'),value:$node.val(),selected:!!$node.attr('checked')};break;default:item=undefined;break;}
break;case'select':item={type:'select',name:label||inputLabel(node),disabled:!!$node.attr('disabled'),selected:$node.val(),options:{}};$node.children().each(function(){item.options[this.value]=$(this).text();});break;case'textarea':item={type:'textarea',name:label||inputLabel(node),disabled:!!$node.attr('disabled'),value:$node.val()};break;case'label':break;default:item={type:'html',html:$node.clone(true)};break;}
if(item){counter++;items['key'+counter]=item;}});return counter;}
$.contextMenu.fromMenu=function(element){var $this=$(element),items={};menuChildren(items,$this.children());return items;};$.contextMenu.defaults=defaults;$.contextMenu.types=types;$.contextMenu.handle=handle;$.contextMenu.op=op;$.contextMenu.menus=menus;}(jQuery));
(function($,undefined){$.ui=$.ui||{};var cachedScrollbarWidth,max=Math.max,abs=Math.abs,round=Math.round,rhorizontal=/left|center|right/,rvertical=/top|center|bottom/,roffset=/[\+\-]\d+%?/,rposition=/^\w+/,rpercent=/%$/,_position=$.fn.position;function getOffsets(offsets,width,height){return[parseInt(offsets[0],10)*(rpercent.test(offsets[0])?width/100:1),parseInt(offsets[1],10)*(rpercent.test(offsets[1])?height/100:1)];}
function parseCss(element,property){return parseInt($.css(element,property),10)||0;}
function getDimensions(elem){var raw=elem[0];if(raw.nodeType===9){return{width:elem.width(),height:elem.height(),offset:{top:0,left:0}};}
if($.isWindow(raw)){return{width:elem.width(),height:elem.height(),offset:{top:elem.scrollTop(),left:elem.scrollLeft()}};}
if(raw.preventDefault){return{width:0,height:0,offset:{top:raw.pageY,left:raw.pageX}};}
return{width:elem.outerWidth(),height:elem.outerHeight(),offset:elem.offset()};}
$.position={scrollbarWidth:function(){if(cachedScrollbarWidth!==undefined){return cachedScrollbarWidth;}
var w1,w2,div=$("<div style='display:block;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),innerDiv=div.children()[0];$("body").append(div);w1=innerDiv.offsetWidth;div.css("overflow","scroll");w2=innerDiv.offsetWidth;if(w1===w2){w2=div[0].clientWidth;}
div.remove();return(cachedScrollbarWidth=w1-w2);},getScrollInfo:function(within){var overflowX=within.isWindow?"":within.element.css("overflow-x"),overflowY=within.isWindow?"":within.element.css("overflow-y"),hasOverflowX=overflowX==="scroll"||(overflowX==="auto"&&within.width<within.element[0].scrollWidth),hasOverflowY=overflowY==="scroll"||(overflowY==="auto"&&within.height<within.element[0].scrollHeight);return{width:hasOverflowX?$.position.scrollbarWidth():0,height:hasOverflowY?$.position.scrollbarWidth():0};},getWithinInfo:function(element){var withinElement=$(element||window),isWindow=$.isWindow(withinElement[0]);return{element:withinElement,isWindow:isWindow,offset:withinElement.offset()||{left:0,top:0},scrollLeft:withinElement.scrollLeft(),scrollTop:withinElement.scrollTop(),width:isWindow?withinElement.width():withinElement.outerWidth(),height:isWindow?withinElement.height():withinElement.outerHeight()};}};$.fn.position=function(options){if(!options||!options.of){return _position.apply(this,arguments);}
options=$.extend({},options);var atOffset,targetWidth,targetHeight,targetOffset,basePosition,dimensions,target=$(options.of),within=$.position.getWithinInfo(options.within),scrollInfo=$.position.getScrollInfo(within),collision=(options.collision||"flip").split(" "),offsets={};dimensions=getDimensions(target);if(target[0].preventDefault){options.at="left top";}
targetWidth=dimensions.width;targetHeight=dimensions.height;targetOffset=dimensions.offset;basePosition=$.extend({},targetOffset);$.each(["my","at"],function(){var pos=(options[this]||"").split(" "),horizontalOffset,verticalOffset;if(pos.length===1){pos=rhorizontal.test(pos[0])?pos.concat(["center"]):rvertical.test(pos[0])?["center"].concat(pos):["center","center"];}
pos[0]=rhorizontal.test(pos[0])?pos[0]:"center";pos[1]=rvertical.test(pos[1])?pos[1]:"center";horizontalOffset=roffset.exec(pos[0]);verticalOffset=roffset.exec(pos[1]);offsets[this]=[horizontalOffset?horizontalOffset[0]:0,verticalOffset?verticalOffset[0]:0];options[this]=[rposition.exec(pos[0])[0],rposition.exec(pos[1])[0]];});if(collision.length===1){collision[1]=collision[0];}
if(options.at[0]==="right"){basePosition.left+=targetWidth;}else if(options.at[0]==="center"){basePosition.left+=targetWidth/2;}
if(options.at[1]==="bottom"){basePosition.top+=targetHeight;}else if(options.at[1]==="center"){basePosition.top+=targetHeight/2;}
atOffset=getOffsets(offsets.at,targetWidth,targetHeight);basePosition.left+=atOffset[0];basePosition.top+=atOffset[1];return this.each(function(){var collisionPosition,using,elem=$(this),elemWidth=elem.outerWidth(),elemHeight=elem.outerHeight(),marginLeft=parseCss(this,"marginLeft"),marginTop=parseCss(this,"marginTop"),collisionWidth=elemWidth+marginLeft+parseCss(this,"marginRight")+scrollInfo.width,collisionHeight=elemHeight+marginTop+parseCss(this,"marginBottom")+scrollInfo.height,position=$.extend({},basePosition),myOffset=getOffsets(offsets.my,elem.outerWidth(),elem.outerHeight());if(options.my[0]==="right"){position.left-=elemWidth;}else if(options.my[0]==="center"){position.left-=elemWidth/2;}
if(options.my[1]==="bottom"){position.top-=elemHeight;}else if(options.my[1]==="center"){position.top-=elemHeight/2;}
position.left+=myOffset[0];position.top+=myOffset[1];if(!$.support.offsetFractions){position.left=round(position.left);position.top=round(position.top);}
collisionPosition={marginLeft:marginLeft,marginTop:marginTop};$.each(["left","top"],function(i,dir){if($.ui.position[collision[i]]){$.ui.position[collision[i]][dir](position,{targetWidth:targetWidth,targetHeight:targetHeight,elemWidth:elemWidth,elemHeight:elemHeight,collisionPosition:collisionPosition,collisionWidth:collisionWidth,collisionHeight:collisionHeight,offset:[atOffset[0]+myOffset[0],atOffset[1]+myOffset[1]],my:options.my,at:options.at,within:within,elem:elem});}});if(options.using){using=function(props){var left=targetOffset.left-position.left,right=left+targetWidth-elemWidth,top=targetOffset.top-position.top,bottom=top+targetHeight-elemHeight,feedback={target:{element:target,left:targetOffset.left,top:targetOffset.top,width:targetWidth,height:targetHeight},element:{element:elem,left:position.left,top:position.top,width:elemWidth,height:elemHeight},horizontal:right<0?"left":left>0?"right":"center",vertical:bottom<0?"top":top>0?"bottom":"middle"};if(targetWidth<elemWidth&&abs(left+right)<targetWidth){feedback.horizontal="center";}
if(targetHeight<elemHeight&&abs(top+bottom)<targetHeight){feedback.vertical="middle";}
if(max(abs(left),abs(right))>max(abs(top),abs(bottom))){feedback.important="horizontal";}else{feedback.important="vertical";}
options.using.call(this,props,feedback);};}
elem.offset($.extend(position,{using:using}));});};$.ui.position={fit:{left:function(position,data){var within=data.within,withinOffset=within.isWindow?within.scrollLeft:within.offset.left,outerWidth=within.width,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=withinOffset-collisionPosLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-withinOffset,newOverRight;if(data.collisionWidth>outerWidth){if(overLeft>0&&overRight<=0){newOverRight=position.left+overLeft+data.collisionWidth-outerWidth-withinOffset;position.left+=overLeft-newOverRight;}else if(overRight>0&&overLeft<=0){position.left=withinOffset;}else{if(overLeft>overRight){position.left=withinOffset+outerWidth-data.collisionWidth;}else{position.left=withinOffset;}}}else if(overLeft>0){position.left+=overLeft;}else if(overRight>0){position.left-=overRight;}else{position.left=max(position.left-collisionPosLeft,position.left);}},top:function(position,data){var within=data.within,withinOffset=within.isWindow?within.scrollTop:within.offset.top,outerHeight=data.within.height,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=withinOffset-collisionPosTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-withinOffset,newOverBottom;if(data.collisionHeight>outerHeight){if(overTop>0&&overBottom<=0){newOverBottom=position.top+overTop+data.collisionHeight-outerHeight-withinOffset;position.top+=overTop-newOverBottom;}else if(overBottom>0&&overTop<=0){position.top=withinOffset;}else{if(overTop>overBottom){position.top=withinOffset+outerHeight-data.collisionHeight;}else{position.top=withinOffset;}}}else if(overTop>0){position.top+=overTop;}else if(overBottom>0){position.top-=overBottom;}else{position.top=max(position.top-collisionPosTop,position.top);}}},flip:{left:function(position,data){var within=data.within,withinOffset=within.offset.left+within.scrollLeft,outerWidth=within.width,offsetLeft=within.isWindow?within.scrollLeft:within.offset.left,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=collisionPosLeft-offsetLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-offsetLeft,myOffset=data.my[0]==="left"?-data.elemWidth:data.my[0]==="right"?data.elemWidth:0,atOffset=data.at[0]==="left"?data.targetWidth:data.at[0]==="right"?-data.targetWidth:0,offset=-2*data.offset[0],newOverRight,newOverLeft;if(overLeft<0){newOverRight=position.left+myOffset+atOffset+offset+data.collisionWidth-outerWidth-withinOffset;if(newOverRight<0||newOverRight<abs(overLeft)){position.left+=myOffset+atOffset+offset;}}
else if(overRight>0){newOverLeft=position.left-data.collisionPosition.marginLeft+myOffset+atOffset+offset-offsetLeft;if(newOverLeft>0||abs(newOverLeft)<overRight){position.left+=myOffset+atOffset+offset;}}},top:function(position,data){var within=data.within,withinOffset=within.offset.top+within.scrollTop,outerHeight=within.height,offsetTop=within.isWindow?within.scrollTop:within.offset.top,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=collisionPosTop-offsetTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-offsetTop,top=data.my[1]==="top",myOffset=top?-data.elemHeight:data.my[1]==="bottom"?data.elemHeight:0,atOffset=data.at[1]==="top"?data.targetHeight:data.at[1]==="bottom"?-data.targetHeight:0,offset=-2*data.offset[1],newOverTop,newOverBottom;if(overTop<0){newOverBottom=position.top+myOffset+atOffset+offset+data.collisionHeight-outerHeight-withinOffset;if((position.top+myOffset+atOffset+offset)>overTop&&(newOverBottom<0||newOverBottom<abs(overTop))){position.top+=myOffset+atOffset+offset;}}
else if(overBottom>0){newOverTop=position.top-data.collisionPosition.marginTop+myOffset+atOffset+offset-offsetTop;if((position.top+myOffset+atOffset+offset)>overBottom&&(newOverTop>0||abs(newOverTop)<overBottom)){position.top+=myOffset+atOffset+offset;}}}},flipfit:{left:function(){$.ui.position.flip.left.apply(this,arguments);$.ui.position.fit.left.apply(this,arguments);},top:function(){$.ui.position.flip.top.apply(this,arguments);$.ui.position.fit.top.apply(this,arguments);}}};(function(){var testElement,testElementParent,testElementStyle,offsetLeft,i,body=document.getElementsByTagName("body")[0],div=document.createElement("div");testElement=document.createElement(body?"div":"body");testElementStyle={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"};if(body){$.extend(testElementStyle,{position:"absolute",left:"-1000px",top:"-1000px"});}
for(i in testElementStyle){testElement.style[i]=testElementStyle[i];}
testElement.appendChild(div);testElementParent=body||document.documentElement;testElementParent.insertBefore(testElement,testElementParent.firstChild);div.style.cssText="position: absolute; left: 10.7432222px;";offsetLeft=$(div).offset().left;$.support.offsetFractions=offsetLeft>10&&offsetLeft<11;testElement.innerHTML="";testElementParent.removeChild(testElement);})();}(jQuery));
(function($){var rEscape=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;$.widget('ech.multiselectfilter',{options:{label:'Filter:',width:null,placeholder:'Enter keywords',autoReset:false},_create:function(){var opts=this.options;var elem=$(this.element);var instance=(this.instance=(elem.data('echMultiselect')||elem.data("multiselect")||elem.data("ech-multiselect")));var header=(this.header=instance.menu.find('.ui-multiselect-header').addClass('ui-multiselect-hasfilter'));var wrapper=(this.wrapper=$('<div class="ui-multiselect-filter">'+(opts.label.length?opts.label:'')+'<input placeholder="'+opts.placeholder+'" type="search"'+(/\d/.test(opts.width)?'style="width:'+opts.width+'px"':'')+' /></div>').prependTo(this.header));this.inputs=instance.menu.find('input[type="checkbox"], input[type="radio"]');this.input=wrapper.find('input').bind({keydown:function(e){if(e.which===13){e.preventDefault();}},keyup:$.proxy(this._handler,this),click:$.proxy(this._handler,this)});this.updateCache();instance._toggleChecked=function(flag,group){var $inputs=(group&&group.length)?group:this.labels.find('input');var _self=this;var selector=instance._isOpen?':disabled, :hidden':':disabled';$inputs=$inputs.not(selector).each(this._toggleState('checked',flag));this.update();var values=$inputs.map(function(){return this.value;}).get();this.element.find('option').filter(function(){if(!this.disabled&&$.inArray(this.value,values)>-1){_self._toggleState('selected',flag).call(this);}});if($inputs.length){this.element.trigger('change');}};var doc=$(document).bind('multiselectrefresh',$.proxy(function(){this.updateCache();this._handler();},this));if(this.options.autoReset){doc.bind('multiselectclose',$.proxy(this._reset,this));}},_handler:function(e){var term=$.trim(this.input[0].value.toLowerCase()),rows=this.rows,inputs=this.inputs,cache=this.cache;if(!term){rows.show();}else{rows.hide();var regex=new RegExp(term.replace(rEscape,"\\$&"),'gi');this._trigger("filter",e,$.map(cache,function(v,i){if(v.search(regex)!==-1){rows.eq(i).show();return inputs.get(i);}
return null;}));}
this.instance.menu.find(".ui-multiselect-optgroup-label").each(function(){var $this=$(this);var isVisible=$this.nextUntil('.ui-multiselect-optgroup-label').filter(function(){return $.css(this,"display")!=='none';}).length;$this[isVisible?'show':'hide']();});},_reset:function(){this.input.val('').trigger('keyup');},updateCache:function(){this.rows=this.instance.menu.find(".ui-multiselect-checkboxes li:not(.ui-multiselect-optgroup-label)");this.cache=this.element.children().map(function(){var elem=$(this);if(this.tagName.toLowerCase()==="optgroup"){elem=elem.children();}
return elem.map(function(){return this.innerHTML.toLowerCase();}).get();}).get();},widget:function(){return this.wrapper;},destroy:function(){$.Widget.prototype.destroy.call(this);this.input.val('').trigger("keyup");this.wrapper.remove();}});})(jQuery);;(function($){"use strict";var feature={};feature.fileapi=$("<input type='file'/>").get(0).files!==undefined;feature.formdata=window.FormData!==undefined;var hasProp=!!$.fn.prop;$.fn.attr2=function(){if(!hasProp)
return this.attr.apply(this,arguments);var val=this.prop.apply(this,arguments);if((val&&val.jquery)||typeof val==='string')
return val;return this.attr.apply(this,arguments);};$.fn.ajaxSubmit=function(options){if(!this.length){log('ajaxSubmit: skipping submit process - no element selected');return this;}
var method,action,url,$form=this;if(typeof options=='function'){options={success:options};}
else if(options===undefined){options={};}
method=options.type||this.attr2('method');action=options.url||this.attr2('action');url=(typeof action==='string')?$.trim(action):'';url=url||window.location.href||'';if(url){url=(url.match(/^([^#]+)/)||[])[1];}
options=$.extend(true,{url:url,success:$.ajaxSettings.success,type:method||$.ajaxSettings.type,iframeSrc:/^https/i.test(window.location.href||'')?'javascript:false':'about:blank'},options);var veto={};this.trigger('form-pre-serialize',[this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');return this;}
if(options.beforeSerialize&&options.beforeSerialize(this,options)===false){log('ajaxSubmit: submit aborted via beforeSerialize callback');return this;}
var traditional=options.traditional;if(traditional===undefined){traditional=$.ajaxSettings.traditional;}
var elements=[];var qx,a=this.formToArray(options.semantic,elements);if(options.data){options.extraData=options.data;qx=$.param(options.data,traditional);}
if(options.beforeSubmit&&options.beforeSubmit(a,this,options)===false){log('ajaxSubmit: submit aborted via beforeSubmit callback');return this;}
this.trigger('form-submit-validate',[a,this,options,veto]);if(veto.veto){log('ajaxSubmit: submit vetoed via form-submit-validate trigger');return this;}
var q=$.param(a,traditional);if(qx){q=(q?(q+'&'+qx):qx);}
if(options.type.toUpperCase()=='GET'){options.url+=(options.url.indexOf('?')>=0?'&':'?')+q;options.data=null;}
else{options.data=q;}
var callbacks=[];if(options.resetForm){callbacks.push(function(){$form.resetForm();});}
if(options.clearForm){callbacks.push(function(){$form.clearForm(options.includeHidden);});}
if(!options.dataType&&options.target){var oldSuccess=options.success||function(){};callbacks.push(function(data){var fn=options.replaceTarget?'replaceWith':'html';$(options.target)[fn](data).each(oldSuccess,arguments);});}
else if(options.success){callbacks.push(options.success);}
options.success=function(data,status,xhr){var context=options.context||this;for(var i=0,max=callbacks.length;i<max;i++){callbacks[i].apply(context,[data,status,xhr||$form,$form]);}};if(options.error){var oldError=options.error;options.error=function(xhr,status,error){var context=options.context||this;oldError.apply(context,[xhr,status,error,$form]);};}
if(options.complete){var oldComplete=options.complete;options.complete=function(xhr,status){var context=options.context||this;oldComplete.apply(context,[xhr,status,$form]);};}
var fileInputs=$('input[type=file]:enabled:not([value=""])',this);var hasFileInputs=fileInputs.length>0;var mp='multipart/form-data';var multipart=($form.attr('enctype')==mp||$form.attr('encoding')==mp);var fileAPI=feature.fileapi&&feature.formdata;log("fileAPI :"+fileAPI);var shouldUseFrame=(hasFileInputs||multipart)&&!fileAPI;var jqxhr;if(options.iframe!==false&&(options.iframe||shouldUseFrame)){if(options.closeKeepAlive){$.get(options.closeKeepAlive,function(){jqxhr=fileUploadIframe(a);});}
else{jqxhr=fileUploadIframe(a);}}
else if((hasFileInputs||multipart)&&fileAPI){jqxhr=fileUploadXhr(a);}
else{jqxhr=$.ajax(options);}
$form.removeData('jqxhr').data('jqxhr',jqxhr);for(var k=0;k<elements.length;k++)
elements[k]=null;this.trigger('form-submit-notify',[this,options]);return this;function deepSerialize(extraData){var serialized=$.param(extraData,options.traditional).split('&');var len=serialized.length;var result=[];var i,part;for(i=0;i<len;i++){serialized[i]=serialized[i].replace(/\+/g,' ');part=serialized[i].split('=');result.push([decodeURIComponent(part[0]),decodeURIComponent(part[1])]);}
return result;}
function fileUploadXhr(a){var formdata=new FormData();for(var i=0;i<a.length;i++){formdata.append(a[i].name,a[i].value);}
if(options.extraData){var serializedData=deepSerialize(options.extraData);for(i=0;i<serializedData.length;i++)
if(serializedData[i])
formdata.append(serializedData[i][0],serializedData[i][1]);}
options.data=null;var s=$.extend(true,{},$.ajaxSettings,options,{contentType:false,processData:false,cache:false,type:method||'POST'});if(options.uploadProgress){s.xhr=function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(event){var percent=0;var position=event.loaded||event.position;var total=event.total;if(event.lengthComputable){percent=Math.ceil(position/total*100);}
options.uploadProgress(event,position,total,percent);},false);}
return xhr;};}
s.data=null;var beforeSend=s.beforeSend;s.beforeSend=function(xhr,o){o.data=formdata;if(beforeSend)
beforeSend.call(this,xhr,o);};return $.ajax(s);}
function fileUploadIframe(a){var form=$form[0],el,i,s,g,id,$io,io,xhr,sub,n,timedOut,timeoutHandle;var deferred=$.Deferred();deferred.abort=function(status){xhr.abort(status);};if(a){for(i=0;i<elements.length;i++){el=$(elements[i]);if(hasProp)
el.prop('disabled',false);else
el.removeAttr('disabled');}}
s=$.extend(true,{},$.ajaxSettings,options);s.context=s.context||s;id='jqFormIO'+(new Date().getTime());if(s.iframeTarget){$io=$(s.iframeTarget);n=$io.attr2('name');if(!n)
$io.attr2('name',id);else
id=n;}
else{$io=$('<iframe name="'+id+'" src="'+s.iframeSrc+'" />');$io.css({position:'absolute',top:'-1000px',left:'-1000px'});}
io=$io[0];xhr={aborted:0,responseText:null,responseXML:null,status:0,statusText:'n/a',getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(status){var e=(status==='timeout'?'timeout':'aborted');log('aborting upload... '+e);this.aborted=1;try{if(io.contentWindow.document.execCommand){io.contentWindow.document.execCommand('Stop');}}
catch(ignore){}
$io.attr('src',s.iframeSrc);xhr.error=e;if(s.error)
s.error.call(s.context,xhr,e,status);if(g)
$.event.trigger("ajaxError",[xhr,s,e]);if(s.complete)
s.complete.call(s.context,xhr,e);}};g=s.global;if(g&&0===$.active++){$.event.trigger("ajaxStart");}
if(g){$.event.trigger("ajaxSend",[xhr,s]);}
if(s.beforeSend&&s.beforeSend.call(s.context,xhr,s)===false){if(s.global){$.active--;}
deferred.reject();return deferred;}
if(xhr.aborted){deferred.reject();return deferred;}
sub=form.clk;if(sub){n=sub.name;if(n&&!sub.disabled){s.extraData=s.extraData||{};s.extraData[n]=sub.value;if(sub.type=="image"){s.extraData[n+'.x']=form.clk_x;s.extraData[n+'.y']=form.clk_y;}}}
var CLIENT_TIMEOUT_ABORT=1;var SERVER_ABORT=2;function getDoc(frame){var doc=null;try{if(frame.contentWindow){doc=frame.contentWindow.document;}}catch(err){log('cannot get iframe.contentWindow document: '+err);}
if(doc){return doc;}
try{doc=frame.contentDocument?frame.contentDocument:frame.document;}catch(err){log('cannot get iframe.contentDocument: '+err);doc=frame.document;}
return doc;}
var csrf_token=$('meta[name=csrf-token]').attr('content');var csrf_param=$('meta[name=csrf-param]').attr('content');if(csrf_param&&csrf_token){s.extraData=s.extraData||{};s.extraData[csrf_param]=csrf_token;}
function doSubmit(){var t=$form.attr2('target'),a=$form.attr2('action');form.setAttribute('target',id);if(!method){form.setAttribute('method','POST');}
if(a!=s.url){form.setAttribute('action',s.url);}
if(!s.skipEncodingOverride&&(!method||/post/i.test(method))){$form.attr({encoding:'multipart/form-data',enctype:'multipart/form-data'});}
if(s.timeout){timeoutHandle=setTimeout(function(){timedOut=true;cb(CLIENT_TIMEOUT_ABORT);},s.timeout);}
function checkState(){try{var state=getDoc(io).readyState;log('state = '+state);if(state&&state.toLowerCase()=='uninitialized')
setTimeout(checkState,50);}
catch(e){log('Server abort: ',e,' (',e.name,')');cb(SERVER_ABORT);if(timeoutHandle)
clearTimeout(timeoutHandle);timeoutHandle=undefined;}}
var extraInputs=[];try{if(s.extraData){for(var n in s.extraData){if(s.extraData.hasOwnProperty(n)){if($.isPlainObject(s.extraData[n])&&s.extraData[n].hasOwnProperty('name')&&s.extraData[n].hasOwnProperty('value')){extraInputs.push($('<input type="hidden" name="'+s.extraData[n].name+'">').val(s.extraData[n].value).appendTo(form)[0]);}else{extraInputs.push($('<input type="hidden" name="'+n+'">').val(s.extraData[n]).appendTo(form)[0]);}}}}
if(!s.iframeTarget){$io.appendTo('body');if(io.attachEvent)
io.attachEvent('onload',cb);else
io.addEventListener('load',cb,false);}
setTimeout(checkState,15);try{form.submit();}catch(err){var submitFn=document.createElement('form').submit;submitFn.apply(form);}}
finally{form.setAttribute('action',a);if(t){form.setAttribute('target',t);}else{$form.removeAttr('target');}
$(extraInputs).remove();}}
if(s.forceSync){doSubmit();}
else{setTimeout(doSubmit,10);}
var data,doc,domCheckCount=50,callbackProcessed;function cb(e){if(xhr.aborted||callbackProcessed){return;}
doc=getDoc(io);if(!doc){log('cannot access response document');e=SERVER_ABORT;}
if(e===CLIENT_TIMEOUT_ABORT&&xhr){xhr.abort('timeout');deferred.reject(xhr,'timeout');return;}
else if(e==SERVER_ABORT&&xhr){xhr.abort('server abort');deferred.reject(xhr,'error','server abort');return;}
if(!doc||doc.location.href==s.iframeSrc){if(!timedOut)
return;}
if(io.detachEvent)
io.detachEvent('onload',cb);else
io.removeEventListener('load',cb,false);var status='success',errMsg;try{if(timedOut){throw'timeout';}
var isXml=s.dataType=='xml'||doc.XMLDocument||$.isXMLDoc(doc);log('isXml='+isXml);if(!isXml&&window.opera&&(doc.body===null||!doc.body.innerHTML)){if(--domCheckCount){log('requeing onLoad callback, DOM not available');setTimeout(cb,250);return;}}
var docRoot=doc.body?doc.body:doc.documentElement;xhr.responseText=docRoot?docRoot.innerHTML:null;xhr.responseXML=doc.XMLDocument?doc.XMLDocument:doc;if(isXml)
s.dataType='xml';xhr.getResponseHeader=function(header){var headers={'content-type':s.dataType};return headers[header.toLowerCase()];};if(docRoot){xhr.status=Number(docRoot.getAttribute('status'))||xhr.status;xhr.statusText=docRoot.getAttribute('statusText')||xhr.statusText;}
var dt=(s.dataType||'').toLowerCase();var scr=/(json|script|text)/.test(dt);if(scr||s.textarea){var ta=doc.getElementsByTagName('textarea')[0];if(ta){xhr.responseText=ta.value;xhr.status=Number(ta.getAttribute('status'))||xhr.status;xhr.statusText=ta.getAttribute('statusText')||xhr.statusText;}
else if(scr){var pre=doc.getElementsByTagName('pre')[0];var b=doc.getElementsByTagName('body')[0];if(pre){xhr.responseText=pre.textContent?pre.textContent:pre.innerText;}
else if(b){xhr.responseText=b.textContent?b.textContent:b.innerText;}}}
else if(dt=='xml'&&!xhr.responseXML&&xhr.responseText){xhr.responseXML=toXml(xhr.responseText);}
try{data=httpData(xhr,dt,s);}
catch(err){status='parsererror';xhr.error=errMsg=(err||status);}}
catch(err){log('error caught: ',err);status='error';xhr.error=errMsg=(err||status);}
if(xhr.aborted){log('upload aborted');status=null;}
if(xhr.status){status=(xhr.status>=200&&xhr.status<300||xhr.status===304)?'success':'error';}
if(status==='success'){if(s.success)
s.success.call(s.context,data,'success',xhr);deferred.resolve(xhr.responseText,'success',xhr);if(g)
$.event.trigger("ajaxSuccess",[xhr,s]);}
else if(status){if(errMsg===undefined)
errMsg=xhr.statusText;if(s.error)
s.error.call(s.context,xhr,status,errMsg);deferred.reject(xhr,'error',errMsg);if(g)
$.event.trigger("ajaxError",[xhr,s,errMsg]);}
if(g)
$.event.trigger("ajaxComplete",[xhr,s]);if(g&&!--$.active){$.event.trigger("ajaxStop");}
if(s.complete)
s.complete.call(s.context,xhr,status);callbackProcessed=true;if(s.timeout)
clearTimeout(timeoutHandle);setTimeout(function(){if(!s.iframeTarget)
$io.remove();xhr.responseXML=null;},100);}
var toXml=$.parseXML||function(s,doc){if(window.ActiveXObject){doc=new ActiveXObject('Microsoft.XMLDOM');doc.async='false';doc.loadXML(s);}
else{doc=(new DOMParser()).parseFromString(s,'text/xml');}
return(doc&&doc.documentElement&&doc.documentElement.nodeName!='parsererror')?doc:null;};var parseJSON=$.parseJSON||function(s){return window['eval']('('+s+')');};var httpData=function(xhr,type,s){var ct=xhr.getResponseHeader('content-type')||'',xml=type==='xml'||!type&&ct.indexOf('xml')>=0,data=xml?xhr.responseXML:xhr.responseText;if(xml&&data.documentElement.nodeName==='parsererror'){if($.error)
$.error('parsererror');}
if(s&&s.dataFilter){data=s.dataFilter(data,type);}
if(typeof data==='string'){if(type==='json'||!type&&ct.indexOf('json')>=0){data=parseJSON(data);}else if(type==="script"||!type&&ct.indexOf("javascript")>=0){$.globalEval(data);}}
return data;};return deferred;}};$.fn.ajaxForm=function(options){options=options||{};options.delegation=options.delegation&&$.isFunction($.fn.on);if(!options.delegation&&this.length===0){var o={s:this.selector,c:this.context};if(!$.isReady&&o.s){log('DOM not ready, queuing ajaxForm');$(function(){$(o.s,o.c).ajaxForm(options);});return this;}
log('terminating; zero elements found by selector'+($.isReady?'':' (DOM not ready)'));return this;}
if(options.delegation){$(document).off('submit.form-plugin',this.selector,doAjaxSubmit).off('click.form-plugin',this.selector,captureSubmittingElement).on('submit.form-plugin',this.selector,options,doAjaxSubmit).on('click.form-plugin',this.selector,options,captureSubmittingElement);return this;}
return this.ajaxFormUnbind().bind('submit.form-plugin',options,doAjaxSubmit).bind('click.form-plugin',options,captureSubmittingElement);};function doAjaxSubmit(e){var options=e.data;if(!e.isDefaultPrevented()){e.preventDefault();$(this).ajaxSubmit(options);}}
function captureSubmittingElement(e){var target=e.target;var $el=$(target);if(!($el.is("[type=submit],[type=image]"))){var t=$el.closest('[type=submit]');if(t.length===0){return;}
target=t[0];}
var form=this;form.clk=target;if(target.type=='image'){if(e.offsetX!==undefined){form.clk_x=e.offsetX;form.clk_y=e.offsetY;}else if(typeof $.fn.offset=='function'){var offset=$el.offset();form.clk_x=e.pageX-offset.left;form.clk_y=e.pageY-offset.top;}else{form.clk_x=e.pageX-target.offsetLeft;form.clk_y=e.pageY-target.offsetTop;}}
setTimeout(function(){form.clk=form.clk_x=form.clk_y=null;},100);}
$.fn.ajaxFormUnbind=function(){return this.unbind('submit.form-plugin click.form-plugin');};$.fn.formToArray=function(semantic,elements){var a=[];if(this.length===0){return a;}
var form=this[0];var els=semantic?form.getElementsByTagName('*'):form.elements;if(!els){return a;}
var i,j,n,v,el,max,jmax;for(i=0,max=els.length;i<max;i++){el=els[i];n=el.name;if(!n||el.disabled){continue;}
if(semantic&&form.clk&&el.type=="image"){if(form.clk==el){a.push({name:n,value:$(el).val(),type:el.type});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}
continue;}
v=$.fieldValue(el,true);if(v&&v.constructor==Array){if(elements)
elements.push(el);for(j=0,jmax=v.length;j<jmax;j++){a.push({name:n,value:v[j]});}}
else if(feature.fileapi&&el.type=='file'){if(elements)
elements.push(el);var files=el.files;if(files.length){for(j=0;j<files.length;j++){a.push({name:n,value:files[j],type:el.type});}}
else{a.push({name:n,value:'',type:el.type});}}
else if(v!==null&&typeof v!='undefined'){if(elements)
elements.push(el);a.push({name:n,value:v,type:el.type,required:el.required});}}
if(!semantic&&form.clk){var $input=$(form.clk),input=$input[0];n=input.name;if(n&&!input.disabled&&input.type=='image'){a.push({name:n,value:$input.val()});a.push({name:n+'.x',value:form.clk_x},{name:n+'.y',value:form.clk_y});}}
return a;};$.fn.formSerialize=function(semantic){return $.param(this.formToArray(semantic));};$.fn.fieldSerialize=function(successful){var a=[];this.each(function(){var n=this.name;if(!n){return;}
var v=$.fieldValue(this,successful);if(v&&v.constructor==Array){for(var i=0,max=v.length;i<max;i++){a.push({name:n,value:v[i]});}}
else if(v!==null&&typeof v!='undefined'){a.push({name:this.name,value:v});}});return $.param(a);};$.fn.fieldValue=function(successful){for(var val=[],i=0,max=this.length;i<max;i++){var el=this[i];var v=$.fieldValue(el,successful);if(v===null||typeof v=='undefined'||(v.constructor==Array&&!v.length)){continue;}
if(v.constructor==Array)
$.merge(val,v);else
val.push(v);}
return val;};$.fieldValue=function(el,successful){var n=el.name,t=el.type,tag=el.tagName.toLowerCase();if(successful===undefined){successful=true;}
if(successful&&(!n||el.disabled||t=='reset'||t=='button'||(t=='checkbox'||t=='radio')&&!el.checked||(t=='submit'||t=='image')&&el.form&&el.form.clk!=el||tag=='select'&&el.selectedIndex==-1)){return null;}
if(tag=='select'){var index=el.selectedIndex;if(index<0){return null;}
var a=[],ops=el.options;var one=(t=='select-one');var max=(one?index+1:ops.length);for(var i=(one?index:0);i<max;i++){var op=ops[i];if(op.selected){var v=op.value;if(!v){v=(op.attributes&&op.attributes['value']&&!(op.attributes['value'].specified))?op.text:op.value;}
if(one){return v;}
a.push(v);}}
return a;}
return $(el).val();};$.fn.clearForm=function(includeHidden){return this.each(function(){$('input,select,textarea',this).clearFields(includeHidden);});};$.fn.clearFields=$.fn.clearInputs=function(includeHidden){var re=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;return this.each(function(){var t=this.type,tag=this.tagName.toLowerCase();if(re.test(t)||tag=='textarea'){this.value='';}
else if(t=='checkbox'||t=='radio'){this.checked=false;}
else if(tag=='select'){this.selectedIndex=-1;}
else if(t=="file"){if(/MSIE/.test(navigator.userAgent)){$(this).replaceWith($(this).clone(true));}else{$(this).val('');}}
else if(includeHidden){if((includeHidden===true&&/hidden/.test(t))||(typeof includeHidden=='string'&&$(this).is(includeHidden)))
this.value='';}});};$.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=='function'||(typeof this.reset=='object'&&!this.reset.nodeType)){this.reset();}});};$.fn.enable=function(b){if(b===undefined){b=true;}
return this.each(function(){this.disabled=!b;});};$.fn.selected=function(select){if(select===undefined){select=true;}
return this.each(function(){var t=this.type;if(t=='checkbox'||t=='radio'){this.checked=select;}
else if(this.tagName.toLowerCase()=='option'){var $sel=$(this).parent('select');if(select&&$sel[0]&&$sel[0].type=='select-one'){$sel.find('option').selected(false);}
this.selected=select;}});};$.fn.ajaxSubmit.debug=false;function log(){if(!$.fn.ajaxSubmit.debug)
return;var msg='[jquery.form] '+Array.prototype.join.call(arguments,'');if(window.console&&window.console.log){window.console.log(msg);}
else if(window.opera&&window.opera.postError){window.opera.postError(msg);}}})((typeof(jQuery)!='undefined')?jQuery:window.Zepto);
if(jQuery)(function($){$.extend($.fn,{fileTree:function(o,h){if(!o)var o={};if(o.root==undefined)o.root='/';if(o.script==undefined)o.script='jqueryFileTree.php';if(o.folderEvent==undefined)o.folderEvent='click';if(o.expandSpeed==undefined)o.expandSpeed=500;if(o.collapseSpeed==undefined)o.collapseSpeed=500;if(o.expandEasing==undefined)o.expandEasing=null;if(o.collapseEasing==undefined)o.collapseEasing=null;if(o.multiFolder==undefined)o.multiFolder=true;if(o.loadMessage==undefined)o.loadMessage='Loading...';$(this).each(function(){function showTree(c,t){$(c).addClass('wait');$(".jqueryFileTree.start").remove();$.post(o.script,{dir:t},function(data){$(c).find('.start').html('');$(c).removeClass('wait').append(data);if(o.root==t)$(c).find('UL:hidden').show();else $(c).find('UL:hidden').slideDown({duration:o.expandSpeed,easing:o.expandEasing});bindTree(c);});}
function bindTree(t){$(t).find('LI A').bind(o.folderEvent,function(){if($(this).parent().hasClass('directory')){if($(this).parent().hasClass('collapsed')){if(!o.multiFolder){$(this).parent().parent().find('UL').slideUp({duration:o.collapseSpeed,easing:o.collapseEasing});$(this).parent().parent().find('LI.directory').removeClass('expanded').addClass('collapsed');}
$(this).parent().find('UL').remove();showTree($(this).parent(),$(this).attr('rel').match(/.*\//));$(this).parent().removeClass('collapsed').addClass('expanded');}else{$(this).parent().find('UL').slideUp({duration:o.collapseSpeed,easing:o.collapseEasing});$(this).parent().removeClass('expanded').addClass('collapsed');}
if(o.folderClick!=undefined)o.folderClick(this,$(this).attr('rel'));}else{h($(this).attr('rel'));}
return false;});if(o.folderEvent.toLowerCase!='click')$(t).find('LI A').bind('click',function(){return false;});}
$(this).html('<ul class="jqueryFileTree start"><li class="wait">'+o.loadMessage+'<li></ul>');showTree($(this),o.root);});}});})(jQuery);
(function($){$.prompt=function(message,options){options=$.extend({},$.prompt.defaults,options);$.prompt.currentPrefix=options.prefix;var ie6=($.browser.msie&&$.browser.version<7);var $body=$(document.body);var $window=$(window);var msgbox='<div class="'+options.prefix+'box" id="'+options.prefix+'box">';if(options.useiframe&&(($('object, applet').length>0)||ie6)){msgbox+='<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="'+options.prefix+'fade" id="'+options.prefix+'fade"></iframe>';}else{if(ie6){$('select').css('visibility','hidden');}
msgbox+='<div class="'+options.prefix+'fade" id="'+options.prefix+'fade"></div>';}
msgbox+='<div class="'+options.prefix+'" id="'+options.prefix+'"><div class="'+options.prefix+'container"><div class="';msgbox+=options.prefix+'close">X</div><div id="'+options.prefix+'states"></div>';msgbox+='</div></div></div>';var $jqib=$(msgbox).appendTo($body);var $jqi=$jqib.children('#'+options.prefix);var $jqif=$jqib.children('#'+options.prefix+'fade');if(message.constructor==String){message={state0:{html:message,buttons:options.buttons,focus:options.focus,submit:options.submit}};}
var states="";$.each(message,function(statename,stateobj){stateobj=$.extend({},$.prompt.defaults.state,stateobj);message[statename]=stateobj;states+='<div id="'+options.prefix+'_state_'+statename+'" class="'+options.prefix+'_state" style="display:none;"><div class="'+options.prefix+'message">'+stateobj.html+'</div><div class="'+options.prefix+'buttons">';$.each(stateobj.buttons,function(k,v){states+='<button name="'+options.prefix+'_'+statename+'_button'+k+'" id="'+options.prefix+'_'+statename+'_button'+k+'" value="'+v+'">'+k+'</button>';});states+='</div></div>';});$jqi.find('#'+options.prefix+'states').html(states).children('.'+options.prefix+'_state:first').css('display','block');$jqi.find('.'+options.prefix+'buttons:empty').css('display','none');$.each(message,function(statename,stateobj){var $state=$jqi.find('#'+options.prefix+'_state_'+statename);$state.children('.'+options.prefix+'buttons').children('button').click(function(){var msg=$state.children('.'+options.prefix+'message');var clicked=stateobj.buttons[$(this).text()];var forminputs={};$.each($jqi.find('#'+options.prefix+'states :input').serializeArray(),function(i,obj){if(forminputs[obj.name]===undefined){forminputs[obj.name]=obj.value;}else if(typeof forminputs[obj.name]==Array){forminputs[obj.name].push(obj.value);}else{forminputs[obj.name]=[forminputs[obj.name],obj.value];}});var close=stateobj.submit(clicked,msg,forminputs);if(close===undefined||close){removePrompt(true,clicked,msg,forminputs);}});$state.find('.'+options.prefix+'buttons button:eq('+stateobj.focus+')').addClass(options.prefix+'defaultbutton');});var ie6scroll=function(){$jqib.css({top:$window.scrollTop()});};var fadeClicked=function(){if(options.persistent){var i=0;$jqib.addClass(options.prefix+'warning');var intervalid=setInterval(function(){$jqib.toggleClass(options.prefix+'warning');if(i++>1){clearInterval(intervalid);$jqib.removeClass(options.prefix+'warning');}},100);}
else{removePrompt();}};var keyPressEventHandler=function(e){var key=(window.event)?event.keyCode:e.keyCode;if(key==27){removePrompt();}
if(key==9){var $inputels=$(':input:enabled:visible',$jqib);var fwd=!e.shiftKey&&e.target==$inputels[$inputels.length-1];var back=e.shiftKey&&e.target==$inputels[0];if(fwd||back){setTimeout(function(){if(!$inputels)
return;var el=$inputels[back===true?$inputels.length-1:0];if(el)
el.focus();},10);return false;}}};var positionPrompt=function(){$jqib.css({position:(ie6)?"absolute":"fixed",height:$window.height(),width:"100%",top:(ie6)?$window.scrollTop():0,left:0,right:0,bottom:0});$jqif.css({position:"absolute",height:$window.height(),width:"100%",top:0,left:0,right:0,bottom:0});$jqi.css({position:"absolute",top:options.top,left:"50%",marginLeft:(($jqi.outerWidth()/2)*-1)});};var stylePrompt=function(){$jqif.css({zIndex:options.zIndex,display:"none",opacity:options.opacity});$jqi.css({zIndex:options.zIndex+1,display:"none"});$jqib.css({zIndex:options.zIndex});};var removePrompt=function(callCallback,clicked,msg,formvals){$jqi.remove();if(ie6){$body.unbind('scroll',ie6scroll);}
$window.unbind('resize',positionPrompt);$jqif.fadeOut(options.overlayspeed,function(){$jqif.unbind('click',fadeClicked);$jqif.remove();if(callCallback){options.callback(clicked,msg,formvals);}
$jqib.unbind('keypress',keyPressEventHandler);$jqib.remove();if(ie6&&!options.useiframe){$('select').css('visibility','visible');}});};positionPrompt();stylePrompt();if(ie6){$window.scroll(ie6scroll);}
$jqif.click(fadeClicked);$window.resize(positionPrompt);$jqib.bind("keydown keypress",keyPressEventHandler);$jqi.find('.'+options.prefix+'close').click(removePrompt);$jqif.fadeIn(options.overlayspeed);$jqi[options.show](options.promptspeed,options.loaded);$jqi.find('#'+options.prefix+'states .'+options.prefix+'_state:first .'+options.prefix+'defaultbutton').focus();if(options.timeout>0)
setTimeout($.prompt.close,options.timeout);return $jqib;};$.prompt.defaults={prefix:'jqi',buttons:{Ok:true},loaded:function(){},submit:function(){return true;},callback:function(){},opacity:0.6,zIndex:999,overlayspeed:'slow',promptspeed:'fast',show:'fadeIn',focus:0,useiframe:false,top:"15%",persistent:true,timeout:0,state:{html:'',buttons:{Ok:true},focus:0,submit:function(){return true;}}};$.prompt.currentPrefix=$.prompt.defaults.prefix;$.prompt.setDefaults=function(o){$.prompt.defaults=$.extend({},$.prompt.defaults,o);};$.prompt.setStateDefaults=function(o){$.prompt.defaults.state=$.extend({},$.prompt.defaults.state,o);};$.prompt.getStateContent=function(state){return $('#'+$.prompt.currentPrefix+'_state_'+state);};$.prompt.getCurrentState=function(){return $('.'+$.prompt.currentPrefix+'_state:visible');};$.prompt.getCurrentStateName=function(){var stateid=$.prompt.getCurrentState().attr('id');return stateid.replace($.prompt.currentPrefix+'_state_','');};$.prompt.goToState=function(state){$('.'+$.prompt.currentPrefix+'_state').slideUp('slow');$('#'+$.prompt.currentPrefix+'_state_'+state).slideDown('slow',function(){$(this).find('.'+$.prompt.currentPrefix+'defaultbutton').focus();});};$.prompt.nextState=function(){var $next=$('.'+$.prompt.currentPrefix+'_state:visible').next();$('.'+$.prompt.currentPrefix+'_state').slideUp('slow');$next.slideDown('slow',function(){$next.find('.'+$.prompt.currentPrefix+'defaultbutton').focus();});};$.prompt.prevState=function(){var $next=$('.'+$.prompt.currentPrefix+'_state:visible').prev();$('.'+$.prompt.currentPrefix+'_state').slideUp('slow');$next.slideDown('slow',function(){$next.find('.'+$.prompt.currentPrefix+'defaultbutton').focus();});};$.prompt.close=function(){$('#'+$.prompt.currentPrefix+'box').fadeOut('fast',function(){$(this).remove();});};})(jQuery);
if($.fn.dataTableExt!=undefined){$.fn.dataTableExt.oApi.fnLengthChange=function(oSettings,iDisplay)
{oSettings._iDisplayLength=iDisplay;oSettings.oApi._fnCalculateEnd(oSettings);if(oSettings._iDisplayEnd==oSettings.aiDisplay.length)
{oSettings._iDisplayStart=oSettings._iDisplayEnd-oSettings._iDisplayLength;if(oSettings._iDisplayStart<0)
{oSettings._iDisplayStart=0;}}
if(oSettings._iDisplayLength==-1)
{oSettings._iDisplayStart=0;}
oSettings.oApi._fnDraw(oSettings);$('select',oSettings.oFeatures.l).val(iDisplay);};}
var BTableComponent=UnmanagedComponent.extend({ph:undefined,cda:{path:"",dataAccessId:"BTableQuery"},btParamName:undefined,bTable:undefined,headerRows:undefined,getBTable:function(){return this.bTable===undefined?{}:this.bTable;},timer:undefined,init:function(){var componentName=this.name.replace("render_","");this.btParamName=componentName+"MdxQuery";var fileError=false;if(this.file){var filePath=this.file;if(filePath.length>7&&filePath.indexOf(".btable",filePath.length-7)!=-1){var btdefObj=null;$.ajax({type:"GET",url:bt.helpers.general.getReadFileServiceUrl(filePath),data:{},dataType:"json",success:function(json){if(json){btdefObj=json;}},async:false});if(btdefObj!=null){var patches={};$.each(this.filters,function(i,v){patches[v[0]]=v[1];});var applyPatches=function(jsonAxis){var newAxis=[];$.each(jsonAxis,function(i,v){var level=v[0];if(patches.hasOwnProperty(level)){v[1]=patches[level];delete patches[level];}
newAxis.push(v);});return newAxis;}
this.catalog=(this.catalog||!btdefObj.hasOwnProperty("catalog"))?this.catalog:btdefObj.catalog;this.jndi=(this.jndi||!btdefObj.hasOwnProperty("jndi"))?this.jndi:btdefObj.jndi;this.cube=(this.cube||!btdefObj.hasOwnProperty("cube"))?this.cube:btdefObj.cube;this.dimensions=(btdefObj.hasOwnProperty("dimensions"))?applyPatches(btdefObj.dimensions):this.dimensions;this.measures=(btdefObj.hasOwnProperty("measures"))?btdefObj.measures:this.measures;this.pivotDimensions=(btdefObj.hasOwnProperty("pivotDimensions"))?applyPatches(btdefObj.pivotDimensions):this.pivotDimensions;this.filters=(btdefObj.hasOwnProperty("filters"))?applyPatches(btdefObj.filters):this.filters;for(var level in patches){var newFilter=[level,patches[level]];this.filters.push(newFilter);}
if(this.tableSettingsFromFile){this.measuresOnColumns=(btdefObj.hasOwnProperty('measuresOnColumns'))?btdefObj.measuresOnColumns:true;this.nonEmptyRows=(btdefObj.hasOwnProperty('nonEmptyRows'))?btdefObj.nonEmptyRows:true;this.nonEmptyColumns=(btdefObj.hasOwnProperty('nonEmptyColumns'))?btdefObj.nonEmptyColumns:true;this.grandTotal=(btdefObj.hasOwnProperty('grandTotal'))?btdefObj.grandTotal:false;this.subTotals=(btdefObj.hasOwnProperty('subTotals'))?btdefObj.subTotals:false;this.pivotGrandTotal=(btdefObj.hasOwnProperty('pivotGrandTotal'))?btdefObj.pivotGrandTotal:false;this.pivotSubTotals=(btdefObj.hasOwnProperty('pivotSubTotals'))?btdefObj.pivotSubTotals:false;this.totalsPosition=(btdefObj.hasOwnProperty('totalsPosition'))?btdefObj.totalsPosition:"bottom";this.hideSpans=(btdefObj.hasOwnProperty('hideSpans'))?btdefObj.hideSpans:false;}}else{console.error("ERROR       [BTable: "+this.name+"] Initialization with file has failed!"+" Cause: NON-EXISTING FILE or WRONG PATH or ACCESS DENIED or INVALID CONTENT");fileError=true;this.error("BTableComponent can't be initialized with file");}}else{console.error("ERROR       [BTable: "+this.name+"] Initialization with file has failed! File extension must be .btable");fileError=true;this.error("BTableComponent can't be initialized with file");}}
if(!this.catalog||!this.jndi||!this.cube){console.error("ERROR       [BTable: "+this.name+"] Initialization has failed! Catalog, JNDI and cube are required");if(!fileError)this.error("BTableComponent requires Catalog, Jndi and Cube");}
this.bTable=new bt.components.BTable({componentName:this.name,componentHtmlObject:this.htmlObject,catalog:this.catalog,jndi:this.jndi,cube:this.cube,dimensions:this.dimensions,measures:this.measures,filters:this.filters,pivotDimensions:this.pivotDimensions,measuresOnColumns:this.measuresOnColumns,orderBy:this.orderBy,nonEmptyRows:this.nonEmptyRows,nonEmptyColumns:this.nonEmptyColumns,grandTotal:this.grandTotal,subTotals:this.subTotals,pivotGrandTotal:this.pivotGrandTotal,pivotSubTotals:this.pivotSubTotals,hideSpans:this.hideSpans,showFilters:this.showFilters,exportStyle:this.exportStyle?this.exportStyle:{},fixedHeader:this.fixedHeader===undefined?true:this.fixedHeader,drillTarget:this.drillTarget!==undefined?this.drillTarget:((this.drillInPUC===undefined||this.drillInPUC)&&typeof top.mantle_openTab!=="undefined"?"NEW_TAB":"NEW_WINDOW"),renderDashboard:this.renderDashboard===undefined?false:this.renderDashboard});if(!this.bTable.olapCube.getStructure()){console.error("ERROR       [BTable: "+this.name+"] Unable to get the cube structure! Cube name may be incorrect");this.error("");}
$("#"+this.htmlObject).addClass("bTableComponent");},update:function(){if(this.timer==undefined)
this.timer=getTimer({component:{type:"BTable",name:this.name}});this.timer.start("Start component updating");if(!this.preExec()){return;}
if(!this.htmlObject){return this.error("BTableComponent requires an htmlObject");}
if(!this.isInitialized){this.init();this.isInitialized=true;}
this.cda.path=bt.helpers.cda.getFilePath(this.catalog,this.jndi);try{this.block();this.setup();var mdxQuery=this.bTable.query.getMdx();this.timer.check("Query string returned");Dashboards.setParameter(this.btParamName,mdxQuery);this.parameters=[["mdxQuery",this.btParamName]];if(this.chartDefinition.paginateServerside){this.paginatingUpdate();}else{var success=_.bind(function(data){this.rawData=data;this.processTableComponentResponse(data)},this);var handler=this.getSuccessHandler(success);this.queryState.setAjaxOptions({async:true});this.queryState.fetchData(this.parameters,handler);}}catch(e){this.unblock();}},paginatingUpdate:function(){var cd=this.chartDefinition;this.extraOptions=this.extraOptions||[];this.extraOptions.push(["bServerSide",true]);this.extraOptions.push(["bProcessing",true]);this.queryState.setPageSize(parseInt(cd.displayLength||10));this.queryState.setCallback(_.bind(function(values){changedValues=undefined;if((typeof(this.postFetch)=='function')){changedValues=this.postFetch(values);}
if(changedValues!=undefined){values=changedValues;}
this.processTableComponentResponse(values);},this));this.queryState.setParameters(this.parameters);this.queryState.setAjaxOptions({async:true});this.processTableComponentResponse();},setup:function(){var cd=this.chartDefinition;cd.path=this.cda.path;cd.dataAccessId=this.cda.dataAccessId;cd.colSearchable=[];cd.filter=false;cd.info=false;cd.lengthChange=false;cd.paginate=false;cd.paginateServerside=false;cd.paginationType="two_button";cd.sort=false;cd.tableStyle="classic";var myself=this;var mouseButton=isMobile.any()?"left":"right";$("#"+this.htmlObject).contextMenu({selector:'thead th',className:'menu-with-title',trigger:mouseButton,build:function($trigger,e){var target=$(e.target).closest("th").data("btref");return myself.bTable.buildHeaderContextMenu(target);}}).contextMenu({selector:'tbody td.dataTables_empty',className:'menu-with-title',trigger:mouseButton,build:function($trigger,e){return myself.bTable.buildNoDataContextMenu();}}).contextMenu({selector:'tbody td',className:'menu-with-title',trigger:mouseButton,build:function($trigger,e){var state={},target=$(e.target),results=myself.rawData;if(!(target.parents('tbody').length)){return;}else if(target.get(0).tagName!='TD'){target=target.closest('td');}
var position=myself.dataTable.fnGetPosition(target.get(0));state.rawData=myself.rawData;state.tableData=myself.dataTable.fnGetData();state.colIdx=position[2];state.rowIdx=position[0];if(cd.colFormats){state.colFormat=cd.colFormats[state.colIdx];}
state.target=target;return myself.bTable.buildBodyContextMenu(state);}});if(cd==undefined){Dashboards.log("Fatal - No chart definition passed","error");return;}
cd["tableId"]=this.htmlObject+"Table";this.ph=$("#"+this.htmlObject).empty();var croppedCd=$.extend({},cd);croppedCd.drawCallback=undefined;this.queryState=new Query(croppedCd);this.query=this.queryState;var sortBy=this.chartDefinition.sortBy||[],sortOptions=[];for(var i=0;i<sortBy.length;i++){var col=sortBy[i][0];var dir=sortBy[i][1];sortOptions.push(col+(dir=="asc"?"A":"D"));}
this.queryState.setSortBy(sortOptions);},pagingCallback:function(url,params,callback,dataTable){function p(sKey){for(var i=0,iLen=params.length;i<iLen;i++){if(params[i].name==sKey){return params[i].value;}}
return null;}
var sortingCols=p("iSortingCols"),sort=[];if(sortingCols>0){for(var i=0;i<sortingCols;i++){var col=p("iSortCol_"+i);var dir=p("sSortDir_"+i);sort.push(col+(dir=="asc"?"A":"D"));}}
var query=this.queryState,myself=this;query.setSortBy(sort.join(","));query.setPageSize(parseInt(p("iDisplayLength")));query.setPageStartingAt(p("iDisplayStart"));query.fetchData(function(d){if(myself.postFetch){var mod=myself.postFetch(d,dataTable);if(typeof mod!=="undefined"){d=mod;}}
var response={iTotalRecords:d.queryInfo.totalRows,iTotalDisplayRecords:d.queryInfo.totalRows};response.aaData=d.resultset;response.sEcho=p("sEcho");myself.rawData=d;callback(response);});},fnDrawCallback:function(dataTableSettings){var dataTable=dataTableSettings.oInstance,cd=this.chartDefinition,myself=this,handleAddIns=_.bind(this.handleAddIns,this);var measuresLevelColIdx=$.inArray("[Measures].[MeasuresLevel]",cd.colHeaders);var formatStrings=myself.bTable.olapCube.getFormatStrings();var cellFormats=[];if(measuresLevelColIdx<0){$.each(cd.colHeaders,function(i,v){if(cd.colTypes[i]=="numeric"){var measureQn="";$.each(v.substring(1,v.length-1).split("]/["),function(j,w){if(w.indexOf("Measures].[")==0){measureQn="["+w+"]";cellFormats.push(formatStrings[measureQn]);return;}});}else{cellFormats.push("");}});}
this.ph.find("tbody tr").each(function(row,tr){if(dataTable.fnGetPosition(tr)==null){return true;}
$(tr).children("td").each(function(col,td){var foundAddIn=handleAddIns(dataTable,td);if(!foundAddIn&&cd.colFormats){var position=dataTable.fnGetPosition(td),rowIdx=position[0],colIdx=position[2],format=cellFormats.length?cellFormats[colIdx]:(cd.colTypes[colIdx]=="numeric"?formatStrings[myself.bTable.olapCube.getQualifiedNameByCaption(myself.rawData.resultset[rowIdx][measuresLevelColIdx],"L")]:"");value=myself.rawData.resultset[rowIdx][colIdx];if(format&&(typeof value!="undefined"&&value!==null)){$(td).text(getLocalizedFormattedValue(format,value));}}});});if(cd.urlTemplate!=undefined){var td=$("#"+myself.htmlObject+" td:nth-child(1)");td.addClass('cdfClickable');td.bind("click",function(e){var regex=new RegExp("{"+cd.parameterName+"}","g");var f=cd.urlTemplate.replace(regex,$(this).text());eval(f);});}
this.timer.check("Table drawn without spans and formatting");var thead=$("<thead></thead>");for(i=0;i<this.headerRows.length;i++){var lastRow=(i==this.headerRows.length-1)?true:false;var headerRow=this.headerRows[i];var tr=$("<tr></tr>");$.each(headerRow,function(j,col){if(lastRow)col.index=j;var html="";html+="<th data-btref='"+JSON.stringify(col)+"'";html+=(col.colspan==undefined||col.colspan==1)?"":" colspan='"+col.colspan+"'";html+=(col.rowspan==undefined||col.rowspan==1)?"":" rowspan='"+col.rowspan+"'";html+=">"+col.caption+"</th>";var th=$(html);tr.append(th);});thead.append(tr);}
this.ph.find("thead").empty().prepend(thead.html());$("#"+myself.htmlObject+" tbody tr").each(function(){var totalCells=$(this).find("td:contains('BT_TOTAL')");if(totalCells.length>0){var isGrandTotalRow=$(this).find("td:eq(0):contains('BT_TOTAL')").length==1;var tds=$(this).find("td");tds.addClass("subtotal");if(isGrandTotalRow){tds.removeClass("subtotal");tds.addClass("grandtotal");}
totalCells.each(function(i){if(i==0)
$(this).text($.i18n.prop('table_total'));else
$(this).empty();});}});var zippedRows=myself.bTable.getBodyRowspans();$.each(zippedRows,function(i,arr){var position=0;var indexes=$.map(arr,function(e){position+=e.rowspan;return position;});indexes.splice(0,0,0);$("#"+myself.htmlObject+" tbody tr td:nth-child("+(i+1)+")").each(function(k){if($.inArray(k,indexes)<0)
$(this).empty();});});this.timer.check("Table completely drawn");if(typeof cd.drawCallback=='function'){cd.drawCallback.apply(myself,arguments);}},fnInitComplete:function(){$("#"+this.htmlObject).prepend("<div id='"+this.bTable.properties.filtersPanelHtmlObject+"' class='filtersPanel'"+(this.bTable.properties.showFilters?"":" style='display:none'")+"></div>");this.bTable.printFilters();if(this.bTable.properties.fixedHeader)
$("#"+this.htmlObject+" .tableComponent").fixHeader();this.postExec();this.unblock();},handleAddIns:function(dataTable,td){var cd=this.chartDefinition,position=dataTable.fnGetPosition(td),rowIdx=position[0],colIdx=position[2],colType=cd.colTypes[colIdx],addIn=this.getAddIn("colType",colType),state={},target=$(td),results=this.rawData;if(!addIn){return false;}
try{if(!(target.parents('tbody').length)){return;}else if(target.get(0).tagName!='TD'){target=target.closest('td');}
state.rawData=results;state.tableData=dataTable.fnGetData();state.colIdx=colIdx;state.rowIdx=rowIdx;state.series=results.resultset[state.rowIdx][0];state.category=results.metadata[state.colIdx].colName;state.value=results.resultset[state.rowIdx][state.colIdx];if(cd.colFormats){state.colFormat=cd.colFormats[state.colIdx];}
state.target=target;addIn.call(td,state,this.getAddInOptions("colType",addIn.getName()));return true;}catch(e){this.dashboard.error(e);return false;}},processTableComponentResponse:function(json){var myself=this,cd=this.chartDefinition,extraOptions={};this.timer.check("Query result returned");json=myself.bTable.normalizeCdaJson(json);this.ph.trigger('cdfTableComponentProcessResponse');var noResult=json.metadata.length==0;if(!noResult)
myself.bTable.setHeaders(json.metadata.map(function(i){return i.colName}));myself.headerRows=noResult?[]:myself.bTable.getHeaders();cd.colHeaders=noResult?[]:json.metadata.map(function(i){return i.colName});cd.colTypes=noResult?[]:json.metadata.map(function(i){return i.colType.toLowerCase()});cd.colFormats=noResult?[]:json.metadata.map(function(i){return i.colType.toLowerCase()=="numeric"?"%d":"%s"});var dtData0=TableComponent.getDataTableOptions(cd);if(noResult)
dtData0.aoColumns=[{sClass:"column0 string",sTitle:"Empty Result",sType:"string"}];$.each(this.extraOptions?this.extraOptions:{},function(i,e){extraOptions[e[0]]=e[1];});var dtData=$.extend(cd.dataTableOptions,dtData0,extraOptions);dtData.fnDrawCallback=_.bind(this.fnDrawCallback,this);dtData.fnInitComplete=_.bind(this.fnInitComplete,this);if(dtData.bServerSide){var myself=this;dtData.fnServerData=function(u,p,c){myself.pagingCallback(u,p,c,this);};}
if(json){dtData.aaData=json.resultset;}
this.ph.html("<table id='"+this.htmlObject+"Table' class='tableComponent' width='100%'></table>");this.dataTable=$("#"+this.htmlObject+'Table').dataTable(dtData);if(noResult)
$("#"+this.htmlObject+'Table td.dataTables_empty').html($.i18n.prop("table_no_data"));this.dataTable.anOpen=[];myself.ph.find('table').bind('click',function(e){if(typeof cd.clickAction==='function'||myself.expandOnClick){var state={},target=$(e.target),results=myself.rawData;if(!(target.parents('tbody').length)){return;}else if(target.get(0).tagName!='TD'){target=target.closest('td');}
var position=myself.dataTable.fnGetPosition(target.get(0));state.rawData=myself.rawData;state.tableData=myself.dataTable.fnGetData();state.colIdx=position[2];state.rowIdx=position[0];state.series=results.resultset[state.rowIdx][0];state.category=results.metadata[state.colIdx].colName;state.value=results.resultset[state.rowIdx][state.colIdx];state.colFormat=cd.colFormats[state.colIdx];state.target=target;if(myself.expandOnClick){myself.handleExpandOnClick(state);}
if(cd.clickAction){cd.clickAction.call(myself,state);}}});myself.ph.trigger('cdfTableComponentFinishRendering');},handleExpandOnClick:function(event){var myself=this,detailContainerObj=myself.expandContainerObject,activeclass="expandingClass";if(typeof activeclass==='undefined'){activeclass="activeRow";}
var obj=event.target.closest("tr"),a=event.target.closest("a");if(a.hasClass('info')){return;}else{var row=obj.get(0),value=event.series,htmlContent=$("#"+detailContainerObj).html(),anOpen=myself.dataTable.anOpen,i=$.inArray(row,anOpen);if(obj.hasClass(activeclass)){obj.removeClass(activeclass);myself.dataTable.fnClose(row);anOpen.splice(i,1);}else{for(var j=0;j<anOpen.length;j++){$(anOpen[j]).removeClass(activeclass);myself.dataTable.fnClose(anOpen[j]);anOpen.splice(j,1);}
obj.addClass(activeclass);anOpen.push(row);myself.dataTable.fnOpen(row,htmlContent,activeclass);var results=myself.queryState.lastResults();$(myself.expandParameters).each(function f(i,elt){Dashboards.fireChange(elt[1],results.resultset[event.rowIdx][parseInt(elt[0],10)]);});};};$("td.expandingClass").click(function(event){event.stopPropagation();return;});}},{getDataTableOptions:function(options){var dtData={};if(options.tableStyle=="themeroller"){dtData.bJQueryUI=true;}
dtData.bInfo=options.info;dtData.iDisplayLength=options.displayLength;dtData.bLengthChange=options.lengthChange;dtData.bPaginate=options.paginate;dtData.bSort=options.sort;dtData.bFilter=options.filter;dtData.sPaginationType=options.paginationType;dtData.sDom=options.sDom;dtData.aaSorting=options.sortBy;if(typeof options.oLanguage=="string"){dtData.oLanguage=eval("("+options.oLanguage+")");}
else{dtData.oLanguage=options.oLanguage;}
if(options.colHeaders!=undefined){dtData.aoColumns=new Array(options.colHeaders.length);for(var i=0;i<options.colHeaders.length;i++){dtData.aoColumns[i]={}
dtData.aoColumns[i].sClass="column"+i;};$.each(options.colHeaders,function(i,val){dtData.aoColumns[i].sTitle=val;if(val=="")dtData.aoColumns[i].bVisible=false;});if(options.colTypes!=undefined){$.each(options.colTypes,function(i,val){var col=dtData.aoColumns[i];if(val=="hidden")col.bVisible=false;col.sClass+=" "+val;col.sType=val;})};if(options.colFormats!=undefined){};var bAutoWidth=true;if(options.colWidths!=undefined){$.each(options.colWidths,function(i,val){if(val!=null){dtData.aoColumns[i].sWidth=val;bAutoWidth=false;}})};dtData.bAutoWidth=bAutoWidth;if(options.colSortable!=undefined){$.each(options.colSortable,function(i,val){if(val!=null&&(!val||val=="false")){dtData.aoColumns[i].bSortable=false}})};if(options.colSearchable!=undefined){$.each(options.colSearchable,function(i,val){if(val!=null&&(!val||val=="false")){dtData.aoColumns[i].bSearchable=false}})};}
return dtData;}});!function(){var d3={version:"3.4.6"};if(!Date.now)Date.now=function(){return+new Date();};var d3_arraySlice=[].slice,d3_array=function(list){return d3_arraySlice.call(list);};var d3_document=document,d3_documentElement=d3_document.documentElement,d3_window=window;try{d3_array(d3_documentElement.childNodes)[0].nodeType;}catch(e){d3_array=function(list){var i=list.length,array=new Array(i);while(i--)array[i]=list[i];return array;};}
try{d3_document.createElement("div").style.setProperty("opacity",0,"");}catch(error){var d3_element_prototype=d3_window.Element.prototype,d3_element_setAttribute=d3_element_prototype.setAttribute,d3_element_setAttributeNS=d3_element_prototype.setAttributeNS,d3_style_prototype=d3_window.CSSStyleDeclaration.prototype,d3_style_setProperty=d3_style_prototype.setProperty;d3_element_prototype.setAttribute=function(name,value){d3_element_setAttribute.call(this,name,value+"");};d3_element_prototype.setAttributeNS=function(space,local,value){d3_element_setAttributeNS.call(this,space,local,value+"");};d3_style_prototype.setProperty=function(name,value,priority){d3_style_setProperty.call(this,name,value+"",priority);};}
d3.ascending=d3_ascending;function d3_ascending(a,b){return a<b?-1:a>b?1:a>=b?0:NaN;}
d3.descending=function(a,b){return b<a?-1:b>a?1:b>=a?0:NaN;};d3.min=function(array,f){var i=-1,n=array.length,a,b;if(arguments.length===1){while(++i<n&&!((a=array[i])!=null&&a<=a))a=undefined;while(++i<n)if((b=array[i])!=null&&a>b)a=b;}else{while(++i<n&&!((a=f.call(array,array[i],i))!=null&&a<=a))a=undefined;while(++i<n)if((b=f.call(array,array[i],i))!=null&&a>b)a=b;}
return a;};d3.max=function(array,f){var i=-1,n=array.length,a,b;if(arguments.length===1){while(++i<n&&!((a=array[i])!=null&&a<=a))a=undefined;while(++i<n)if((b=array[i])!=null&&b>a)a=b;}else{while(++i<n&&!((a=f.call(array,array[i],i))!=null&&a<=a))a=undefined;while(++i<n)if((b=f.call(array,array[i],i))!=null&&b>a)a=b;}
return a;};d3.extent=function(array,f){var i=-1,n=array.length,a,b,c;if(arguments.length===1){while(++i<n&&!((a=c=array[i])!=null&&a<=a))a=c=undefined;while(++i<n)if((b=array[i])!=null){if(a>b)a=b;if(c<b)c=b;}}else{while(++i<n&&!((a=c=f.call(array,array[i],i))!=null&&a<=a))a=undefined;while(++i<n)if((b=f.call(array,array[i],i))!=null){if(a>b)a=b;if(c<b)c=b;}}
return[a,c];};d3.sum=function(array,f){var s=0,n=array.length,a,i=-1;if(arguments.length===1){while(++i<n)if(!isNaN(a=+array[i]))s+=a;}else{while(++i<n)if(!isNaN(a=+f.call(array,array[i],i)))s+=a;}
return s;};function d3_number(x){return x!=null&&!isNaN(x);}
d3.mean=function(array,f){var s=0,n=array.length,a,i=-1,j=n;if(arguments.length===1){while(++i<n)if(d3_number(a=array[i]))s+=a;else--j;}else{while(++i<n)if(d3_number(a=f.call(array,array[i],i)))s+=a;else--j;}
return j?s/j:undefined;};d3.quantile=function(values,p){var H=(values.length-1)*p+1,h=Math.floor(H),v=+values[h-1],e=H-h;return e?v+e*(values[h]-v):v;};d3.median=function(array,f){if(arguments.length>1)array=array.map(f);array=array.filter(d3_number);return array.length?d3.quantile(array.sort(d3_ascending),.5):undefined;};function d3_bisector(compare){return{left:function(a,x,lo,hi){if(arguments.length<3)lo=0;if(arguments.length<4)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)<0)lo=mid+1;else hi=mid;}
return lo;},right:function(a,x,lo,hi){if(arguments.length<3)lo=0;if(arguments.length<4)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)>0)hi=mid;else lo=mid+1;}
return lo;}};}
var d3_bisect=d3_bisector(d3_ascending);d3.bisectLeft=d3_bisect.left;d3.bisect=d3.bisectRight=d3_bisect.right;d3.bisector=function(f){return d3_bisector(f.length===1?function(d,x){return d3_ascending(f(d),x);}:f);};d3.shuffle=function(array){var m=array.length,t,i;while(m){i=Math.random()*m--|0;t=array[m],array[m]=array[i],array[i]=t;}
return array;};d3.permute=function(array,indexes){var i=indexes.length,permutes=new Array(i);while(i--)permutes[i]=array[indexes[i]];return permutes;};d3.pairs=function(array){var i=0,n=array.length-1,p0,p1=array[0],pairs=new Array(n<0?0:n);while(i<n)pairs[i]=[p0=p1,p1=array[++i]];return pairs;};d3.zip=function(){if(!(n=arguments.length))return[];for(var i=-1,m=d3.min(arguments,d3_zipLength),zips=new Array(m);++i<m;){for(var j=-1,n,zip=zips[i]=new Array(n);++j<n;){zip[j]=arguments[j][i];}}
return zips;};function d3_zipLength(d){return d.length;}
d3.transpose=function(matrix){return d3.zip.apply(d3,matrix);};d3.keys=function(map){var keys=[];for(var key in map)keys.push(key);return keys;};d3.values=function(map){var values=[];for(var key in map)values.push(map[key]);return values;};d3.entries=function(map){var entries=[];for(var key in map)entries.push({key:key,value:map[key]});return entries;};d3.merge=function(arrays){var n=arrays.length,m,i=-1,j=0,merged,array;while(++i<n)j+=arrays[i].length;merged=new Array(j);while(--n>=0){array=arrays[n];m=array.length;while(--m>=0){merged[--j]=array[m];}}
return merged;};var abs=Math.abs;d3.range=function(start,stop,step){if(arguments.length<3){step=1;if(arguments.length<2){stop=start;start=0;}}
if((stop-start)/step===Infinity)throw new Error("infinite range");var range=[],k=d3_range_integerScale(abs(step)),i=-1,j;start*=k,stop*=k,step*=k;if(step<0)while((j=start+step*++i)>stop)range.push(j/k);else while((j=start+step*++i)<stop)range.push(j/k);return range;};function d3_range_integerScale(x){var k=1;while(x*k%1)k*=10;return k;}
function d3_class(ctor,properties){try{for(var key in properties){Object.defineProperty(ctor.prototype,key,{value:properties[key],enumerable:false});}}catch(e){ctor.prototype=properties;}}
d3.map=function(object){var map=new d3_Map();if(object instanceof d3_Map)object.forEach(function(key,value){map.set(key,value);});else for(var key in object)map.set(key,object[key]);return map;};function d3_Map(){}
d3_class(d3_Map,{has:d3_map_has,get:function(key){return this[d3_map_prefix+key];},set:function(key,value){return this[d3_map_prefix+key]=value;},remove:d3_map_remove,keys:d3_map_keys,values:function(){var values=[];this.forEach(function(key,value){values.push(value);});return values;},entries:function(){var entries=[];this.forEach(function(key,value){entries.push({key:key,value:value});});return entries;},size:d3_map_size,empty:d3_map_empty,forEach:function(f){for(var key in this)if(key.charCodeAt(0)===d3_map_prefixCode)f.call(this,key.substring(1),this[key]);}});var d3_map_prefix="\x00",d3_map_prefixCode=d3_map_prefix.charCodeAt(0);function d3_map_has(key){return d3_map_prefix+key in this;}
function d3_map_remove(key){key=d3_map_prefix+key;return key in this&&delete this[key];}
function d3_map_keys(){var keys=[];this.forEach(function(key){keys.push(key);});return keys;}
function d3_map_size(){var size=0;for(var key in this)if(key.charCodeAt(0)===d3_map_prefixCode)++size;return size;}
function d3_map_empty(){for(var key in this)if(key.charCodeAt(0)===d3_map_prefixCode)return false;return true;}
d3.nest=function(){var nest={},keys=[],sortKeys=[],sortValues,rollup;function map(mapType,array,depth){if(depth>=keys.length)return rollup?rollup.call(nest,array):sortValues?array.sort(sortValues):array;var i=-1,n=array.length,key=keys[depth++],keyValue,object,setter,valuesByKey=new d3_Map(),values;while(++i<n){if(values=valuesByKey.get(keyValue=key(object=array[i]))){values.push(object);}else{valuesByKey.set(keyValue,[object]);}}
if(mapType){object=mapType();setter=function(keyValue,values){object.set(keyValue,map(mapType,values,depth));};}else{object={};setter=function(keyValue,values){object[keyValue]=map(mapType,values,depth);};}
valuesByKey.forEach(setter);return object;}
function entries(map,depth){if(depth>=keys.length)return map;var array=[],sortKey=sortKeys[depth++];map.forEach(function(key,keyMap){array.push({key:key,values:entries(keyMap,depth)});});return sortKey?array.sort(function(a,b){return sortKey(a.key,b.key);}):array;}
nest.map=function(array,mapType){return map(mapType,array,0);};nest.entries=function(array){return entries(map(d3.map,array,0),0);};nest.key=function(d){keys.push(d);return nest;};nest.sortKeys=function(order){sortKeys[keys.length-1]=order;return nest;};nest.sortValues=function(order){sortValues=order;return nest;};nest.rollup=function(f){rollup=f;return nest;};return nest;};d3.set=function(array){var set=new d3_Set();if(array)for(var i=0,n=array.length;i<n;++i)set.add(array[i]);return set;};function d3_Set(){}
d3_class(d3_Set,{has:d3_map_has,add:function(value){this[d3_map_prefix+value]=true;return value;},remove:function(value){value=d3_map_prefix+value;return value in this&&delete this[value];},values:d3_map_keys,size:d3_map_size,empty:d3_map_empty,forEach:function(f){for(var value in this)if(value.charCodeAt(0)===d3_map_prefixCode)f.call(this,value.substring(1));}});d3.behavior={};d3.rebind=function(target,source){var i=1,n=arguments.length,method;while(++i<n)target[method=arguments[i]]=d3_rebind(target,source,source[method]);return target;};function d3_rebind(target,source,method){return function(){var value=method.apply(source,arguments);return value===source?target:value;};}
function d3_vendorSymbol(object,name){if(name in object)return name;name=name.charAt(0).toUpperCase()+name.substring(1);for(var i=0,n=d3_vendorPrefixes.length;i<n;++i){var prefixName=d3_vendorPrefixes[i]+name;if(prefixName in object)return prefixName;}}
var d3_vendorPrefixes=["webkit","ms","moz","Moz","o","O"];function d3_noop(){}
d3.dispatch=function(){var dispatch=new d3_dispatch(),i=-1,n=arguments.length;while(++i<n)dispatch[arguments[i]]=d3_dispatch_event(dispatch);return dispatch;};function d3_dispatch(){}
d3_dispatch.prototype.on=function(type,listener){var i=type.indexOf("."),name="";if(i>=0){name=type.substring(i+1);type=type.substring(0,i);}
if(type)return arguments.length<2?this[type].on(name):this[type].on(name,listener);if(arguments.length===2){if(listener==null)for(type in this){if(this.hasOwnProperty(type))this[type].on(name,null);}
return this;}};function d3_dispatch_event(dispatch){var listeners=[],listenerByName=new d3_Map();function event(){var z=listeners,i=-1,n=z.length,l;while(++i<n)if(l=z[i].on)l.apply(this,arguments);return dispatch;}
event.on=function(name,listener){var l=listenerByName.get(name),i;if(arguments.length<2)return l&&l.on;if(l){l.on=null;listeners=listeners.slice(0,i=listeners.indexOf(l)).concat(listeners.slice(i+1));listenerByName.remove(name);}
if(listener)listeners.push(listenerByName.set(name,{on:listener}));return dispatch;};return event;}
d3.event=null;function d3_eventPreventDefault(){d3.event.preventDefault();}
function d3_eventSource(){var e=d3.event,s;while(s=e.sourceEvent)e=s;return e;}
function d3_eventDispatch(target){var dispatch=new d3_dispatch(),i=0,n=arguments.length;while(++i<n)dispatch[arguments[i]]=d3_dispatch_event(dispatch);dispatch.of=function(thiz,argumentz){return function(e1){try{var e0=e1.sourceEvent=d3.event;e1.target=target;d3.event=e1;dispatch[e1.type].apply(thiz,argumentz);}finally{d3.event=e0;}};};return dispatch;}
d3.requote=function(s){return s.replace(d3_requote_re,"\\$&");};var d3_requote_re=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g;var d3_subclass={}.__proto__?function(object,prototype){object.__proto__=prototype;}:function(object,prototype){for(var property in prototype)object[property]=prototype[property];};function d3_selection(groups){d3_subclass(groups,d3_selectionPrototype);return groups;}
var d3_select=function(s,n){return n.querySelector(s);},d3_selectAll=function(s,n){return n.querySelectorAll(s);},d3_selectMatcher=d3_documentElement[d3_vendorSymbol(d3_documentElement,"matchesSelector")],d3_selectMatches=function(n,s){return d3_selectMatcher.call(n,s);};if(typeof Sizzle==="function"){d3_select=function(s,n){return Sizzle(s,n)[0]||null;};d3_selectAll=Sizzle;d3_selectMatches=Sizzle.matchesSelector;}
d3.selection=function(){return d3_selectionRoot;};var d3_selectionPrototype=d3.selection.prototype=[];d3_selectionPrototype.select=function(selector){var subgroups=[],subgroup,subnode,group,node;selector=d3_selection_selector(selector);for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);subgroup.parentNode=(group=this[j]).parentNode;for(var i=-1,n=group.length;++i<n;){if(node=group[i]){subgroup.push(subnode=selector.call(node,node.__data__,i,j));if(subnode&&"__data__"in node)subnode.__data__=node.__data__;}else{subgroup.push(null);}}}
return d3_selection(subgroups);};function d3_selection_selector(selector){return typeof selector==="function"?selector:function(){return d3_select(selector,this);};}
d3_selectionPrototype.selectAll=function(selector){var subgroups=[],subgroup,node;selector=d3_selection_selectorAll(selector);for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i]){subgroups.push(subgroup=d3_array(selector.call(node,node.__data__,i,j)));subgroup.parentNode=node;}}}
return d3_selection(subgroups);};function d3_selection_selectorAll(selector){return typeof selector==="function"?selector:function(){return d3_selectAll(selector,this);};}
var d3_nsPrefix={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};d3.ns={prefix:d3_nsPrefix,qualify:function(name){var i=name.indexOf(":"),prefix=name;if(i>=0){prefix=name.substring(0,i);name=name.substring(i+1);}
return d3_nsPrefix.hasOwnProperty(prefix)?{space:d3_nsPrefix[prefix],local:name}:name;}};d3_selectionPrototype.attr=function(name,value){if(arguments.length<2){if(typeof name==="string"){var node=this.node();name=d3.ns.qualify(name);return name.local?node.getAttributeNS(name.space,name.local):node.getAttribute(name);}
for(value in name)this.each(d3_selection_attr(value,name[value]));return this;}
return this.each(d3_selection_attr(name,value));};function d3_selection_attr(name,value){name=d3.ns.qualify(name);function attrNull(){this.removeAttribute(name);}
function attrNullNS(){this.removeAttributeNS(name.space,name.local);}
function attrConstant(){this.setAttribute(name,value);}
function attrConstantNS(){this.setAttributeNS(name.space,name.local,value);}
function attrFunction(){var x=value.apply(this,arguments);if(x==null)this.removeAttribute(name);else this.setAttribute(name,x);}
function attrFunctionNS(){var x=value.apply(this,arguments);if(x==null)this.removeAttributeNS(name.space,name.local);else this.setAttributeNS(name.space,name.local,x);}
return value==null?name.local?attrNullNS:attrNull:typeof value==="function"?name.local?attrFunctionNS:attrFunction:name.local?attrConstantNS:attrConstant;}
function d3_collapse(s){return s.trim().replace(/\s+/g," ");}
d3_selectionPrototype.classed=function(name,value){if(arguments.length<2){if(typeof name==="string"){var node=this.node(),n=(name=d3_selection_classes(name)).length,i=-1;if(value=node.classList){while(++i<n)if(!value.contains(name[i]))return false;}else{value=node.getAttribute("class");while(++i<n)if(!d3_selection_classedRe(name[i]).test(value))return false;}
return true;}
for(value in name)this.each(d3_selection_classed(value,name[value]));return this;}
return this.each(d3_selection_classed(name,value));};function d3_selection_classedRe(name){return new RegExp("(?:^|\\s+)"+d3.requote(name)+"(?:\\s+|$)","g");}
function d3_selection_classes(name){return name.trim().split(/^|\s+/);}
function d3_selection_classed(name,value){name=d3_selection_classes(name).map(d3_selection_classedName);var n=name.length;function classedConstant(){var i=-1;while(++i<n)name[i](this,value);}
function classedFunction(){var i=-1,x=value.apply(this,arguments);while(++i<n)name[i](this,x);}
return typeof value==="function"?classedFunction:classedConstant;}
function d3_selection_classedName(name){var re=d3_selection_classedRe(name);return function(node,value){if(c=node.classList)return value?c.add(name):c.remove(name);var c=node.getAttribute("class")||"";if(value){re.lastIndex=0;if(!re.test(c))node.setAttribute("class",d3_collapse(c+" "+name));}else{node.setAttribute("class",d3_collapse(c.replace(re," ")));}};}
d3_selectionPrototype.style=function(name,value,priority){var n=arguments.length;if(n<3){if(typeof name!=="string"){if(n<2)value="";for(priority in name)this.each(d3_selection_style(priority,name[priority],value));return this;}
if(n<2)return d3_window.getComputedStyle(this.node(),null).getPropertyValue(name);priority="";}
return this.each(d3_selection_style(name,value,priority));};function d3_selection_style(name,value,priority){function styleNull(){this.style.removeProperty(name);}
function styleConstant(){this.style.setProperty(name,value,priority);}
function styleFunction(){var x=value.apply(this,arguments);if(x==null)this.style.removeProperty(name);else this.style.setProperty(name,x,priority);}
return value==null?styleNull:typeof value==="function"?styleFunction:styleConstant;}
d3_selectionPrototype.property=function(name,value){if(arguments.length<2){if(typeof name==="string")return this.node()[name];for(value in name)this.each(d3_selection_property(value,name[value]));return this;}
return this.each(d3_selection_property(name,value));};function d3_selection_property(name,value){function propertyNull(){delete this[name];}
function propertyConstant(){this[name]=value;}
function propertyFunction(){var x=value.apply(this,arguments);if(x==null)delete this[name];else this[name]=x;}
return value==null?propertyNull:typeof value==="function"?propertyFunction:propertyConstant;}
d3_selectionPrototype.text=function(value){return arguments.length?this.each(typeof value==="function"?function(){var v=value.apply(this,arguments);this.textContent=v==null?"":v;}:value==null?function(){this.textContent="";}:function(){this.textContent=value;}):this.node().textContent;};d3_selectionPrototype.html=function(value){return arguments.length?this.each(typeof value==="function"?function(){var v=value.apply(this,arguments);this.innerHTML=v==null?"":v;}:value==null?function(){this.innerHTML="";}:function(){this.innerHTML=value;}):this.node().innerHTML;};d3_selectionPrototype.append=function(name){name=d3_selection_creator(name);return this.select(function(){return this.appendChild(name.apply(this,arguments));});};function d3_selection_creator(name){return typeof name==="function"?name:(name=d3.ns.qualify(name)).local?function(){return this.ownerDocument.createElementNS(name.space,name.local);}:function(){return this.ownerDocument.createElementNS(this.namespaceURI,name);};}
d3_selectionPrototype.insert=function(name,before){name=d3_selection_creator(name);before=d3_selection_selector(before);return this.select(function(){return this.insertBefore(name.apply(this,arguments),before.apply(this,arguments)||null);});};d3_selectionPrototype.remove=function(){return this.each(function(){var parent=this.parentNode;if(parent)parent.removeChild(this);});};d3_selectionPrototype.data=function(value,key){var i=-1,n=this.length,group,node;if(!arguments.length){value=new Array(n=(group=this[0]).length);while(++i<n){if(node=group[i]){value[i]=node.__data__;}}
return value;}
function bind(group,groupData){var i,n=group.length,m=groupData.length,n0=Math.min(n,m),updateNodes=new Array(m),enterNodes=new Array(m),exitNodes=new Array(n),node,nodeData;if(key){var nodeByKeyValue=new d3_Map(),dataByKeyValue=new d3_Map(),keyValues=[],keyValue;for(i=-1;++i<n;){keyValue=key.call(node=group[i],node.__data__,i);if(nodeByKeyValue.has(keyValue)){exitNodes[i]=node;}else{nodeByKeyValue.set(keyValue,node);}
keyValues.push(keyValue);}
for(i=-1;++i<m;){keyValue=key.call(groupData,nodeData=groupData[i],i);if(node=nodeByKeyValue.get(keyValue)){updateNodes[i]=node;node.__data__=nodeData;}else if(!dataByKeyValue.has(keyValue)){enterNodes[i]=d3_selection_dataNode(nodeData);}
dataByKeyValue.set(keyValue,nodeData);nodeByKeyValue.remove(keyValue);}
for(i=-1;++i<n;){if(nodeByKeyValue.has(keyValues[i])){exitNodes[i]=group[i];}}}else{for(i=-1;++i<n0;){node=group[i];nodeData=groupData[i];if(node){node.__data__=nodeData;updateNodes[i]=node;}else{enterNodes[i]=d3_selection_dataNode(nodeData);}}
for(;i<m;++i){enterNodes[i]=d3_selection_dataNode(groupData[i]);}
for(;i<n;++i){exitNodes[i]=group[i];}}
enterNodes.update=updateNodes;enterNodes.parentNode=updateNodes.parentNode=exitNodes.parentNode=group.parentNode;enter.push(enterNodes);update.push(updateNodes);exit.push(exitNodes);}
var enter=d3_selection_enter([]),update=d3_selection([]),exit=d3_selection([]);if(typeof value==="function"){while(++i<n){bind(group=this[i],value.call(group,group.parentNode.__data__,i));}}else{while(++i<n){bind(group=this[i],value);}}
update.enter=function(){return enter;};update.exit=function(){return exit;};return update;};function d3_selection_dataNode(data){return{__data__:data};}
d3_selectionPrototype.datum=function(value){return arguments.length?this.property("__data__",value):this.property("__data__");};d3_selectionPrototype.filter=function(filter){var subgroups=[],subgroup,group,node;if(typeof filter!=="function")filter=d3_selection_filter(filter);for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);subgroup.parentNode=(group=this[j]).parentNode;for(var i=0,n=group.length;i<n;i++){if((node=group[i])&&filter.call(node,node.__data__,i,j)){subgroup.push(node);}}}
return d3_selection(subgroups);};function d3_selection_filter(selector){return function(){return d3_selectMatches(this,selector);};}
d3_selectionPrototype.order=function(){for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=group.length-1,next=group[i],node;--i>=0;){if(node=group[i]){if(next&&next!==node.nextSibling)next.parentNode.insertBefore(node,next);next=node;}}}
return this;};d3_selectionPrototype.sort=function(comparator){comparator=d3_selection_sortComparator.apply(this,arguments);for(var j=-1,m=this.length;++j<m;)this[j].sort(comparator);return this.order();};function d3_selection_sortComparator(comparator){if(!arguments.length)comparator=d3_ascending;return function(a,b){return a&&b?comparator(a.__data__,b.__data__):!a-!b;};}
d3_selectionPrototype.each=function(callback){return d3_selection_each(this,function(node,i,j){callback.call(node,node.__data__,i,j);});};function d3_selection_each(groups,callback){for(var j=0,m=groups.length;j<m;j++){for(var group=groups[j],i=0,n=group.length,node;i<n;i++){if(node=group[i])callback(node,i,j);}}
return groups;}
d3_selectionPrototype.call=function(callback){var args=d3_array(arguments);callback.apply(args[0]=this,args);return this;};d3_selectionPrototype.empty=function(){return!this.node();};d3_selectionPrototype.node=function(){for(var j=0,m=this.length;j<m;j++){for(var group=this[j],i=0,n=group.length;i<n;i++){var node=group[i];if(node)return node;}}
return null;};d3_selectionPrototype.size=function(){var n=0;this.each(function(){++n;});return n;};function d3_selection_enter(selection){d3_subclass(selection,d3_selection_enterPrototype);return selection;}
var d3_selection_enterPrototype=[];d3.selection.enter=d3_selection_enter;d3.selection.enter.prototype=d3_selection_enterPrototype;d3_selection_enterPrototype.append=d3_selectionPrototype.append;d3_selection_enterPrototype.empty=d3_selectionPrototype.empty;d3_selection_enterPrototype.node=d3_selectionPrototype.node;d3_selection_enterPrototype.call=d3_selectionPrototype.call;d3_selection_enterPrototype.size=d3_selectionPrototype.size;d3_selection_enterPrototype.select=function(selector){var subgroups=[],subgroup,subnode,upgroup,group,node;for(var j=-1,m=this.length;++j<m;){upgroup=(group=this[j]).update;subgroups.push(subgroup=[]);subgroup.parentNode=group.parentNode;for(var i=-1,n=group.length;++i<n;){if(node=group[i]){subgroup.push(upgroup[i]=subnode=selector.call(group.parentNode,node.__data__,i,j));subnode.__data__=node.__data__;}else{subgroup.push(null);}}}
return d3_selection(subgroups);};d3_selection_enterPrototype.insert=function(name,before){if(arguments.length<2)before=d3_selection_enterInsertBefore(this);return d3_selectionPrototype.insert.call(this,name,before);};function d3_selection_enterInsertBefore(enter){var i0,j0;return function(d,i,j){var group=enter[j].update,n=group.length,node;if(j!=j0)j0=j,i0=0;if(i>=i0)i0=i+1;while(!(node=group[i0])&&++i0<n);return node;};}
d3_selectionPrototype.transition=function(){var id=d3_transitionInheritId||++d3_transitionId,subgroups=[],subgroup,node,transition=d3_transitionInherit||{time:Date.now(),ease:d3_ease_cubicInOut,delay:0,duration:250};for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i])d3_transitionNode(node,i,id,transition);subgroup.push(node);}}
return d3_transition(subgroups,id);};d3_selectionPrototype.interrupt=function(){return this.each(d3_selection_interrupt);};function d3_selection_interrupt(){var lock=this.__transition__;if(lock)++lock.active;}
d3.select=function(node){var group=[typeof node==="string"?d3_select(node,d3_document):node];group.parentNode=d3_documentElement;return d3_selection([group]);};d3.selectAll=function(nodes){var group=d3_array(typeof nodes==="string"?d3_selectAll(nodes,d3_document):nodes);group.parentNode=d3_documentElement;return d3_selection([group]);};var d3_selectionRoot=d3.select(d3_documentElement);d3_selectionPrototype.on=function(type,listener,capture){var n=arguments.length;if(n<3){if(typeof type!=="string"){if(n<2)listener=false;for(capture in type)this.each(d3_selection_on(capture,type[capture],listener));return this;}
if(n<2)return(n=this.node()["__on"+type])&&n._;capture=false;}
return this.each(d3_selection_on(type,listener,capture));};function d3_selection_on(type,listener,capture){var name="__on"+type,i=type.indexOf("."),wrap=d3_selection_onListener;if(i>0)type=type.substring(0,i);var filter=d3_selection_onFilters.get(type);if(filter)type=filter,wrap=d3_selection_onFilter;function onRemove(){var l=this[name];if(l){this.removeEventListener(type,l,l.$);delete this[name];}}
function onAdd(){var l=wrap(listener,d3_array(arguments));onRemove.call(this);this.addEventListener(type,this[name]=l,l.$=capture);l._=listener;}
function removeAll(){var re=new RegExp("^__on([^.]+)"+d3.requote(type)+"$"),match;for(var name in this){if(match=name.match(re)){var l=this[name];this.removeEventListener(match[1],l,l.$);delete this[name];}}}
return i?listener?onAdd:onRemove:listener?d3_noop:removeAll;}
var d3_selection_onFilters=d3.map({mouseenter:"mouseover",mouseleave:"mouseout"});d3_selection_onFilters.forEach(function(k){if("on"+k in d3_document)d3_selection_onFilters.remove(k);});function d3_selection_onListener(listener,argumentz){return function(e){var o=d3.event;d3.event=e;argumentz[0]=this.__data__;try{listener.apply(this,argumentz);}finally{d3.event=o;}};}
function d3_selection_onFilter(listener,argumentz){var l=d3_selection_onListener(listener,argumentz);return function(e){var target=this,related=e.relatedTarget;if(!related||related!==target&&!(related.compareDocumentPosition(target)&8)){l.call(target,e);}};}
var d3_event_dragSelect="onselectstart"in d3_document?null:d3_vendorSymbol(d3_documentElement.style,"userSelect"),d3_event_dragId=0;function d3_event_dragSuppress(){var name=".dragsuppress-"+(++d3_event_dragId),click="click"+name,w=d3.select(d3_window).on("touchmove"+name,d3_eventPreventDefault).on("dragstart"+name,d3_eventPreventDefault).on("selectstart"+name,d3_eventPreventDefault);if(d3_event_dragSelect){var style=d3_documentElement.style,select=style[d3_event_dragSelect];style[d3_event_dragSelect]="none";}
return function(suppressClick){w.on(name,null);if(d3_event_dragSelect)style[d3_event_dragSelect]=select;if(suppressClick){function off(){w.on(click,null);}
w.on(click,function(){d3_eventPreventDefault();off();},true);setTimeout(off,0);}};}
d3.mouse=function(container){return d3_mousePoint(container,d3_eventSource());};function d3_mousePoint(container,e){if(e.changedTouches)e=e.changedTouches[0];var svg=container.ownerSVGElement||container;if(svg.createSVGPoint){var point=svg.createSVGPoint();point.x=e.clientX,point.y=e.clientY;point=point.matrixTransform(container.getScreenCTM().inverse());return[point.x,point.y];}
var rect=container.getBoundingClientRect();return[e.clientX-rect.left-container.clientLeft,e.clientY-rect.top-container.clientTop];}
d3.touches=function(container,touches){if(arguments.length<2)touches=d3_eventSource().touches;return touches?d3_array(touches).map(function(touch){var point=d3_mousePoint(container,touch);point.identifier=touch.identifier;return point;}):[];};d3.behavior.drag=function(){var event=d3_eventDispatch(drag,"drag","dragstart","dragend"),origin=null,mousedown=dragstart(d3_noop,d3.mouse,d3_behavior_dragMouseSubject,"mousemove","mouseup"),touchstart=dragstart(d3_behavior_dragTouchId,d3.touch,d3_behavior_dragTouchSubject,"touchmove","touchend");function drag(){this.on("mousedown.drag",mousedown).on("touchstart.drag",touchstart);}
function dragstart(id,position,subject,move,end){return function(){var that=this,target=d3.event.target,parent=that.parentNode,dispatch=event.of(that,arguments),dragged=0,dragId=id(),dragName=".drag"+(dragId==null?"":"-"+dragId),dragOffset,dragSubject=d3.select(subject()).on(move+dragName,moved).on(end+dragName,ended),dragRestore=d3_event_dragSuppress(),position0=position(parent,dragId);if(origin){dragOffset=origin.apply(that,arguments);dragOffset=[dragOffset.x-position0[0],dragOffset.y-position0[1]];}else{dragOffset=[0,0];}
dispatch({type:"dragstart"});function moved(){var position1=position(parent,dragId),dx,dy;if(!position1)return;dx=position1[0]-position0[0];dy=position1[1]-position0[1];dragged|=dx|dy;position0=position1;dispatch({type:"drag",x:position1[0]+dragOffset[0],y:position1[1]+dragOffset[1],dx:dx,dy:dy});}
function ended(){if(!position(parent,dragId))return;dragSubject.on(move+dragName,null).on(end+dragName,null);dragRestore(dragged&&d3.event.target===target);dispatch({type:"dragend"});}};}
drag.origin=function(x){if(!arguments.length)return origin;origin=x;return drag;};return d3.rebind(drag,event,"on");};function d3_behavior_dragTouchId(){return d3.event.changedTouches[0].identifier;}
function d3_behavior_dragTouchSubject(){return d3.event.target;}
function d3_behavior_dragMouseSubject(){return d3_window;}
var π=Math.PI,τ=2*π,halfπ=π/2,ε=1e-6,ε2=ε*ε,d3_radians=π/180,d3_degrees=180/π;function d3_sgn(x){return x>0?1:x<0?-1:0;}
function d3_cross2d(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-a[0]);}
function d3_acos(x){return x>1?0:x<-1?π:Math.acos(x);}
function d3_asin(x){return x>1?halfπ:x<-1?-halfπ:Math.asin(x);}
function d3_sinh(x){return((x=Math.exp(x))-1/x)/2;}
function d3_cosh(x){return((x=Math.exp(x))+1/x)/2;}
function d3_tanh(x){return((x=Math.exp(2*x))-1)/(x+1);}
function d3_haversin(x){return(x=Math.sin(x/2))*x;}
var ρ=Math.SQRT2,ρ2=2,ρ4=4;d3.interpolateZoom=function(p0,p1){var ux0=p0[0],uy0=p0[1],w0=p0[2],ux1=p1[0],uy1=p1[1],w1=p1[2];var dx=ux1-ux0,dy=uy1-uy0,d2=dx*dx+dy*dy,d1=Math.sqrt(d2),b0=(w1*w1-w0*w0+ρ4*d2)/(2*w0*ρ2*d1),b1=(w1*w1-w0*w0-ρ4*d2)/(2*w1*ρ2*d1),r0=Math.log(Math.sqrt(b0*b0+1)-b0),r1=Math.log(Math.sqrt(b1*b1+1)-b1),dr=r1-r0,S=(dr||Math.log(w1/w0))/ρ;function interpolate(t){var s=t*S;if(dr){var coshr0=d3_cosh(r0),u=w0/(ρ2*d1)*(coshr0*d3_tanh(ρ*s+r0)-d3_sinh(r0));return[ux0+u*dx,uy0+u*dy,w0*coshr0/d3_cosh(ρ*s+r0)];}
return[ux0+t*dx,uy0+t*dy,w0*Math.exp(ρ*s)];}
interpolate.duration=S*1e3;return interpolate;};d3.behavior.zoom=function(){var view={x:0,y:0,k:1},translate0,center,size=[960,500],scaleExtent=d3_behavior_zoomInfinity,mousedown="mousedown.zoom",mousemove="mousemove.zoom",mouseup="mouseup.zoom",mousewheelTimer,touchstart="touchstart.zoom",touchtime,event=d3_eventDispatch(zoom,"zoomstart","zoom","zoomend"),x0,x1,y0,y1;function zoom(g){g.on(mousedown,mousedowned).on(d3_behavior_zoomWheel+".zoom",mousewheeled).on(mousemove,mousewheelreset).on("dblclick.zoom",dblclicked).on(touchstart,touchstarted);}
zoom.event=function(g){g.each(function(){var dispatch=event.of(this,arguments),view1=view;if(d3_transitionInheritId){d3.select(this).transition().each("start.zoom",function(){view=this.__chart__||{x:0,y:0,k:1};zoomstarted(dispatch);}).tween("zoom:zoom",function(){var dx=size[0],dy=size[1],cx=dx/2,cy=dy/2,i=d3.interpolateZoom([(cx-view.x)/view.k,(cy-view.y)/view.k,dx/view.k],[(cx-view1.x)/view1.k,(cy-view1.y)/view1.k,dx/view1.k]);return function(t){var l=i(t),k=dx/l[2];this.__chart__=view={x:cx-l[0]*k,y:cy-l[1]*k,k:k};zoomed(dispatch);};}).each("end.zoom",function(){zoomended(dispatch);});}else{this.__chart__=view;zoomstarted(dispatch);zoomed(dispatch);zoomended(dispatch);}});};zoom.translate=function(_){if(!arguments.length)return[view.x,view.y];view={x:+_[0],y:+_[1],k:view.k};rescale();return zoom;};zoom.scale=function(_){if(!arguments.length)return view.k;view={x:view.x,y:view.y,k:+_};rescale();return zoom;};zoom.scaleExtent=function(_){if(!arguments.length)return scaleExtent;scaleExtent=_==null?d3_behavior_zoomInfinity:[+_[0],+_[1]];return zoom;};zoom.center=function(_){if(!arguments.length)return center;center=_&&[+_[0],+_[1]];return zoom;};zoom.size=function(_){if(!arguments.length)return size;size=_&&[+_[0],+_[1]];return zoom;};zoom.x=function(z){if(!arguments.length)return x1;x1=z;x0=z.copy();view={x:0,y:0,k:1};return zoom;};zoom.y=function(z){if(!arguments.length)return y1;y1=z;y0=z.copy();view={x:0,y:0,k:1};return zoom;};function location(p){return[(p[0]-view.x)/view.k,(p[1]-view.y)/view.k];}
function point(l){return[l[0]*view.k+view.x,l[1]*view.k+view.y];}
function scaleTo(s){view.k=Math.max(scaleExtent[0],Math.min(scaleExtent[1],s));}
function translateTo(p,l){l=point(l);view.x+=p[0]-l[0];view.y+=p[1]-l[1];}
function rescale(){if(x1)x1.domain(x0.range().map(function(x){return(x-view.x)/view.k;}).map(x0.invert));if(y1)y1.domain(y0.range().map(function(y){return(y-view.y)/view.k;}).map(y0.invert));}
function zoomstarted(dispatch){dispatch({type:"zoomstart"});}
function zoomed(dispatch){rescale();dispatch({type:"zoom",scale:view.k,translate:[view.x,view.y]});}
function zoomended(dispatch){dispatch({type:"zoomend"});}
function mousedowned(){var that=this,target=d3.event.target,dispatch=event.of(that,arguments),dragged=0,subject=d3.select(d3_window).on(mousemove,moved).on(mouseup,ended),location0=location(d3.mouse(that)),dragRestore=d3_event_dragSuppress();d3_selection_interrupt.call(that);zoomstarted(dispatch);function moved(){dragged=1;translateTo(d3.mouse(that),location0);zoomed(dispatch);}
function ended(){subject.on(mousemove,d3_window===that?mousewheelreset:null).on(mouseup,null);dragRestore(dragged&&d3.event.target===target);zoomended(dispatch);}}
function touchstarted(){var that=this,dispatch=event.of(that,arguments),locations0={},distance0=0,scale0,zoomName=".zoom-"+d3.event.changedTouches[0].identifier,touchmove="touchmove"+zoomName,touchend="touchend"+zoomName,target=d3.select(d3.event.target).on(touchmove,moved).on(touchend,ended),subject=d3.select(that).on(mousedown,null).on(touchstart,started),dragRestore=d3_event_dragSuppress();d3_selection_interrupt.call(that);started();zoomstarted(dispatch);function relocate(){var touches=d3.touches(that);scale0=view.k;touches.forEach(function(t){if(t.identifier in locations0)locations0[t.identifier]=location(t);});return touches;}
function started(){var changed=d3.event.changedTouches;for(var i=0,n=changed.length;i<n;++i){locations0[changed[i].identifier]=null;}
var touches=relocate(),now=Date.now();if(touches.length===1){if(now-touchtime<500){var p=touches[0],l=locations0[p.identifier];scaleTo(view.k*2);translateTo(p,l);d3_eventPreventDefault();zoomed(dispatch);}
touchtime=now;}else if(touches.length>1){var p=touches[0],q=touches[1],dx=p[0]-q[0],dy=p[1]-q[1];distance0=dx*dx+dy*dy;}}
function moved(){var touches=d3.touches(that),p0,l0,p1,l1;for(var i=0,n=touches.length;i<n;++i,l1=null){p1=touches[i];if(l1=locations0[p1.identifier]){if(l0)break;p0=p1,l0=l1;}}
if(l1){var distance1=(distance1=p1[0]-p0[0])*distance1+(distance1=p1[1]-p0[1])*distance1,scale1=distance0&&Math.sqrt(distance1/distance0);p0=[(p0[0]+p1[0])/2,(p0[1]+p1[1])/2];l0=[(l0[0]+l1[0])/2,(l0[1]+l1[1])/2];scaleTo(scale1*scale0);}
touchtime=null;translateTo(p0,l0);zoomed(dispatch);}
function ended(){if(d3.event.touches.length){var changed=d3.event.changedTouches;for(var i=0,n=changed.length;i<n;++i){delete locations0[changed[i].identifier];}
for(var identifier in locations0){return void relocate();}}
target.on(zoomName,null);subject.on(mousedown,mousedowned).on(touchstart,touchstarted);dragRestore();zoomended(dispatch);}}
function mousewheeled(){var dispatch=event.of(this,arguments);if(mousewheelTimer)clearTimeout(mousewheelTimer);else d3_selection_interrupt.call(this),zoomstarted(dispatch);mousewheelTimer=setTimeout(function(){mousewheelTimer=null;zoomended(dispatch);},50);d3_eventPreventDefault();var point=center||d3.mouse(this);if(!translate0)translate0=location(point);scaleTo(Math.pow(2,d3_behavior_zoomDelta()*.002)*view.k);translateTo(point,translate0);zoomed(dispatch);}
function mousewheelreset(){translate0=null;}
function dblclicked(){var dispatch=event.of(this,arguments),p=d3.mouse(this),l=location(p),k=Math.log(view.k)/Math.LN2;zoomstarted(dispatch);scaleTo(Math.pow(2,d3.event.shiftKey?Math.ceil(k)-1:Math.floor(k)+1));translateTo(p,l);zoomed(dispatch);zoomended(dispatch);}
return d3.rebind(zoom,event,"on");};var d3_behavior_zoomInfinity=[0,Infinity];var d3_behavior_zoomDelta,d3_behavior_zoomWheel="onwheel"in d3_document?(d3_behavior_zoomDelta=function(){return-d3.event.deltaY*(d3.event.deltaMode?120:1);},"wheel"):"onmousewheel"in d3_document?(d3_behavior_zoomDelta=function(){return d3.event.wheelDelta;},"mousewheel"):(d3_behavior_zoomDelta=function(){return-d3.event.detail;},"MozMousePixelScroll");function d3_Color(){}
d3_Color.prototype.toString=function(){return this.rgb()+"";};d3.hsl=function(h,s,l){return arguments.length===1?h instanceof d3_Hsl?d3_hsl(h.h,h.s,h.l):d3_rgb_parse(""+h,d3_rgb_hsl,d3_hsl):d3_hsl(+h,+s,+l);};function d3_hsl(h,s,l){return new d3_Hsl(h,s,l);}
function d3_Hsl(h,s,l){this.h=h;this.s=s;this.l=l;}
var d3_hslPrototype=d3_Hsl.prototype=new d3_Color();d3_hslPrototype.brighter=function(k){k=Math.pow(.7,arguments.length?k:1);return d3_hsl(this.h,this.s,this.l/k);};d3_hslPrototype.darker=function(k){k=Math.pow(.7,arguments.length?k:1);return d3_hsl(this.h,this.s,k*this.l);};d3_hslPrototype.rgb=function(){return d3_hsl_rgb(this.h,this.s,this.l);};function d3_hsl_rgb(h,s,l){var m1,m2;h=isNaN(h)?0:(h%=360)<0?h+360:h;s=isNaN(s)?0:s<0?0:s>1?1:s;l=l<0?0:l>1?1:l;m2=l<=.5?l*(1+s):l+s-l*s;m1=2*l-m2;function v(h){if(h>360)h-=360;else if(h<0)h+=360;if(h<60)return m1+(m2-m1)*h/60;if(h<180)return m2;if(h<240)return m1+(m2-m1)*(240-h)/60;return m1;}
function vv(h){return Math.round(v(h)*255);}
return d3_rgb(vv(h+120),vv(h),vv(h-120));}
d3.hcl=function(h,c,l){return arguments.length===1?h instanceof d3_Hcl?d3_hcl(h.h,h.c,h.l):h instanceof d3_Lab?d3_lab_hcl(h.l,h.a,h.b):d3_lab_hcl((h=d3_rgb_lab((h=d3.rgb(h)).r,h.g,h.b)).l,h.a,h.b):d3_hcl(+h,+c,+l);};function d3_hcl(h,c,l){return new d3_Hcl(h,c,l);}
function d3_Hcl(h,c,l){this.h=h;this.c=c;this.l=l;}
var d3_hclPrototype=d3_Hcl.prototype=new d3_Color();d3_hclPrototype.brighter=function(k){return d3_hcl(this.h,this.c,Math.min(100,this.l+d3_lab_K*(arguments.length?k:1)));};d3_hclPrototype.darker=function(k){return d3_hcl(this.h,this.c,Math.max(0,this.l-d3_lab_K*(arguments.length?k:1)));};d3_hclPrototype.rgb=function(){return d3_hcl_lab(this.h,this.c,this.l).rgb();};function d3_hcl_lab(h,c,l){if(isNaN(h))h=0;if(isNaN(c))c=0;return d3_lab(l,Math.cos(h*=d3_radians)*c,Math.sin(h)*c);}
d3.lab=function(l,a,b){return arguments.length===1?l instanceof d3_Lab?d3_lab(l.l,l.a,l.b):l instanceof d3_Hcl?d3_hcl_lab(l.l,l.c,l.h):d3_rgb_lab((l=d3.rgb(l)).r,l.g,l.b):d3_lab(+l,+a,+b);};function d3_lab(l,a,b){return new d3_Lab(l,a,b);}
function d3_Lab(l,a,b){this.l=l;this.a=a;this.b=b;}
var d3_lab_K=18;var d3_lab_X=.95047,d3_lab_Y=1,d3_lab_Z=1.08883;var d3_labPrototype=d3_Lab.prototype=new d3_Color();d3_labPrototype.brighter=function(k){return d3_lab(Math.min(100,this.l+d3_lab_K*(arguments.length?k:1)),this.a,this.b);};d3_labPrototype.darker=function(k){return d3_lab(Math.max(0,this.l-d3_lab_K*(arguments.length?k:1)),this.a,this.b);};d3_labPrototype.rgb=function(){return d3_lab_rgb(this.l,this.a,this.b);};function d3_lab_rgb(l,a,b){var y=(l+16)/116,x=y+a/500,z=y-b/200;x=d3_lab_xyz(x)*d3_lab_X;y=d3_lab_xyz(y)*d3_lab_Y;z=d3_lab_xyz(z)*d3_lab_Z;return d3_rgb(d3_xyz_rgb(3.2404542*x-1.5371385*y-.4985314*z),d3_xyz_rgb(-.969266*x+1.8760108*y+.041556*z),d3_xyz_rgb(.0556434*x-.2040259*y+1.0572252*z));}
function d3_lab_hcl(l,a,b){return l>0?d3_hcl(Math.atan2(b,a)*d3_degrees,Math.sqrt(a*a+b*b),l):d3_hcl(NaN,NaN,l);}
function d3_lab_xyz(x){return x>.206893034?x*x*x:(x-4/29)/7.787037;}
function d3_xyz_lab(x){return x>.008856?Math.pow(x,1/3):7.787037*x+4/29;}
function d3_xyz_rgb(r){return Math.round(255*(r<=.00304?12.92*r:1.055*Math.pow(r,1/2.4)-.055));}
d3.rgb=function(r,g,b){return arguments.length===1?r instanceof d3_Rgb?d3_rgb(r.r,r.g,r.b):d3_rgb_parse(""+r,d3_rgb,d3_hsl_rgb):d3_rgb(~~r,~~g,~~b);};function d3_rgbNumber(value){return d3_rgb(value>>16,value>>8&255,value&255);}
function d3_rgbString(value){return d3_rgbNumber(value)+"";}
function d3_rgb(r,g,b){return new d3_Rgb(r,g,b);}
function d3_Rgb(r,g,b){this.r=r;this.g=g;this.b=b;}
var d3_rgbPrototype=d3_Rgb.prototype=new d3_Color();d3_rgbPrototype.brighter=function(k){k=Math.pow(.7,arguments.length?k:1);var r=this.r,g=this.g,b=this.b,i=30;if(!r&&!g&&!b)return d3_rgb(i,i,i);if(r&&r<i)r=i;if(g&&g<i)g=i;if(b&&b<i)b=i;return d3_rgb(Math.min(255,~~(r/k)),Math.min(255,~~(g/k)),Math.min(255,~~(b/k)));};d3_rgbPrototype.darker=function(k){k=Math.pow(.7,arguments.length?k:1);return d3_rgb(~~(k*this.r),~~(k*this.g),~~(k*this.b));};d3_rgbPrototype.hsl=function(){return d3_rgb_hsl(this.r,this.g,this.b);};d3_rgbPrototype.toString=function(){return"#"+d3_rgb_hex(this.r)+d3_rgb_hex(this.g)+d3_rgb_hex(this.b);};function d3_rgb_hex(v){return v<16?"0"+Math.max(0,v).toString(16):Math.min(255,v).toString(16);}
function d3_rgb_parse(format,rgb,hsl){var r=0,g=0,b=0,m1,m2,color;m1=/([a-z]+)\((.*)\)/i.exec(format);if(m1){m2=m1[2].split(",");switch(m1[1]){case"hsl":{return hsl(parseFloat(m2[0]),parseFloat(m2[1])/100,parseFloat(m2[2])/100);}
case"rgb":{return rgb(d3_rgb_parseNumber(m2[0]),d3_rgb_parseNumber(m2[1]),d3_rgb_parseNumber(m2[2]));}}}
if(color=d3_rgb_names.get(format))return rgb(color.r,color.g,color.b);if(format!=null&&format.charAt(0)==="#"&&!isNaN(color=parseInt(format.substring(1),16))){if(format.length===4){r=(color&3840)>>4;r=r>>4|r;g=color&240;g=g>>4|g;b=color&15;b=b<<4|b;}else if(format.length===7){r=(color&16711680)>>16;g=(color&65280)>>8;b=color&255;}}
return rgb(r,g,b);}
function d3_rgb_hsl(r,g,b){var min=Math.min(r/=255,g/=255,b/=255),max=Math.max(r,g,b),d=max-min,h,s,l=(max+min)/2;if(d){s=l<.5?d/(max+min):d/(2-max-min);if(r==max)h=(g-b)/d+(g<b?6:0);else if(g==max)h=(b-r)/d+2;else h=(r-g)/d+4;h*=60;}else{h=NaN;s=l>0&&l<1?0:h;}
return d3_hsl(h,s,l);}
function d3_rgb_lab(r,g,b){r=d3_rgb_xyz(r);g=d3_rgb_xyz(g);b=d3_rgb_xyz(b);var x=d3_xyz_lab((.4124564*r+.3575761*g+.1804375*b)/d3_lab_X),y=d3_xyz_lab((.2126729*r+.7151522*g+.072175*b)/d3_lab_Y),z=d3_xyz_lab((.0193339*r+.119192*g+.9503041*b)/d3_lab_Z);return d3_lab(116*y-16,500*(x-y),200*(y-z));}
function d3_rgb_xyz(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4);}
function d3_rgb_parseNumber(c){var f=parseFloat(c);return c.charAt(c.length-1)==="%"?Math.round(f*2.55):f;}
var d3_rgb_names=d3.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});d3_rgb_names.forEach(function(key,value){d3_rgb_names.set(key,d3_rgbNumber(value));});function d3_functor(v){return typeof v==="function"?v:function(){return v;};}
d3.functor=d3_functor;function d3_identity(d){return d;}
d3.xhr=d3_xhrType(d3_identity);function d3_xhrType(response){return function(url,mimeType,callback){if(arguments.length===2&&typeof mimeType==="function")callback=mimeType,mimeType=null;return d3_xhr(url,mimeType,response,callback);};}
function d3_xhr(url,mimeType,response,callback){var xhr={},dispatch=d3.dispatch("beforesend","progress","load","error"),headers={},request=new XMLHttpRequest(),responseType=null;if(d3_window.XDomainRequest&&!("withCredentials"in request)&&/^(http(s)?:)?\/\//.test(url))request=new XDomainRequest();"onload"in request?request.onload=request.onerror=respond:request.onreadystatechange=function(){request.readyState>3&&respond();};function respond(){var status=request.status,result;if(!status&&request.responseText||status>=200&&status<300||status===304){try{result=response.call(xhr,request);}catch(e){dispatch.error.call(xhr,e);return;}
dispatch.load.call(xhr,result);}else{dispatch.error.call(xhr,request);}}
request.onprogress=function(event){var o=d3.event;d3.event=event;try{dispatch.progress.call(xhr,request);}finally{d3.event=o;}};xhr.header=function(name,value){name=(name+"").toLowerCase();if(arguments.length<2)return headers[name];if(value==null)delete headers[name];else headers[name]=value+"";return xhr;};xhr.mimeType=function(value){if(!arguments.length)return mimeType;mimeType=value==null?null:value+"";return xhr;};xhr.responseType=function(value){if(!arguments.length)return responseType;responseType=value;return xhr;};xhr.response=function(value){response=value;return xhr;};["get","post"].forEach(function(method){xhr[method]=function(){return xhr.send.apply(xhr,[method].concat(d3_array(arguments)));};});xhr.send=function(method,data,callback){if(arguments.length===2&&typeof data==="function")callback=data,data=null;request.open(method,url,true);if(mimeType!=null&&!("accept"in headers))headers["accept"]=mimeType+",*/*";if(request.setRequestHeader)for(var name in headers)request.setRequestHeader(name,headers[name]);if(mimeType!=null&&request.overrideMimeType)request.overrideMimeType(mimeType);if(responseType!=null)request.responseType=responseType;if(callback!=null)xhr.on("error",callback).on("load",function(request){callback(null,request);});dispatch.beforesend.call(xhr,request);request.send(data==null?null:data);return xhr;};xhr.abort=function(){request.abort();return xhr;};d3.rebind(xhr,dispatch,"on");return callback==null?xhr:xhr.get(d3_xhr_fixCallback(callback));}
function d3_xhr_fixCallback(callback){return callback.length===1?function(error,request){callback(error==null?request:null);}:callback;}
d3.dsv=function(delimiter,mimeType){var reFormat=new RegExp('["'+delimiter+"\n]"),delimiterCode=delimiter.charCodeAt(0);function dsv(url,row,callback){if(arguments.length<3)callback=row,row=null;var xhr=d3_xhr(url,mimeType,row==null?response:typedResponse(row),callback);xhr.row=function(_){return arguments.length?xhr.response((row=_)==null?response:typedResponse(_)):row;};return xhr;}
function response(request){return dsv.parse(request.responseText);}
function typedResponse(f){return function(request){return dsv.parse(request.responseText,f);};}
dsv.parse=function(text,f){var o;return dsv.parseRows(text,function(row,i){if(o)return o(row,i-1);var a=new Function("d","return {"+row.map(function(name,i){return JSON.stringify(name)+": d["+i+"]";}).join(",")+"}");o=f?function(row,i){return f(a(row),i);}:a;});};dsv.parseRows=function(text,f){var EOL={},EOF={},rows=[],N=text.length,I=0,n=0,t,eol;function token(){if(I>=N)return EOF;if(eol)return eol=false,EOL;var j=I;if(text.charCodeAt(j)===34){var i=j;while(i++<N){if(text.charCodeAt(i)===34){if(text.charCodeAt(i+1)!==34)break;++i;}}
I=i+2;var c=text.charCodeAt(i+1);if(c===13){eol=true;if(text.charCodeAt(i+2)===10)++I;}else if(c===10){eol=true;}
return text.substring(j+1,i).replace(/""/g,'"');}
while(I<N){var c=text.charCodeAt(I++),k=1;if(c===10)eol=true;else if(c===13){eol=true;if(text.charCodeAt(I)===10)++I,++k;}else if(c!==delimiterCode)continue;return text.substring(j,I-k);}
return text.substring(j);}
while((t=token())!==EOF){var a=[];while(t!==EOL&&t!==EOF){a.push(t);t=token();}
if(f&&!(a=f(a,n++)))continue;rows.push(a);}
return rows;};dsv.format=function(rows){if(Array.isArray(rows[0]))return dsv.formatRows(rows);var fieldSet=new d3_Set(),fields=[];rows.forEach(function(row){for(var field in row){if(!fieldSet.has(field)){fields.push(fieldSet.add(field));}}});return[fields.map(formatValue).join(delimiter)].concat(rows.map(function(row){return fields.map(function(field){return formatValue(row[field]);}).join(delimiter);})).join("\n");};dsv.formatRows=function(rows){return rows.map(formatRow).join("\n");};function formatRow(row){return row.map(formatValue).join(delimiter);}
function formatValue(text){return reFormat.test(text)?'"'+text.replace(/\"/g,'""')+'"':text;}
return dsv;};d3.csv=d3.dsv(",","text/csv");d3.tsv=d3.dsv(" ","text/tab-separated-values");d3.touch=function(container,touches,identifier){if(arguments.length<3)identifier=touches,touches=d3_eventSource().changedTouches;if(touches)for(var i=0,n=touches.length,touch;i<n;++i){if((touch=touches[i]).identifier===identifier){return d3_mousePoint(container,touch);}}};var d3_timer_queueHead,d3_timer_queueTail,d3_timer_interval,d3_timer_timeout,d3_timer_active,d3_timer_frame=d3_window[d3_vendorSymbol(d3_window,"requestAnimationFrame")]||function(callback){setTimeout(callback,17);};d3.timer=function(callback,delay,then){var n=arguments.length;if(n<2)delay=0;if(n<3)then=Date.now();var time=then+delay,timer={c:callback,t:time,f:false,n:null};if(d3_timer_queueTail)d3_timer_queueTail.n=timer;else d3_timer_queueHead=timer;d3_timer_queueTail=timer;if(!d3_timer_interval){d3_timer_timeout=clearTimeout(d3_timer_timeout);d3_timer_interval=1;d3_timer_frame(d3_timer_step);}};function d3_timer_step(){var now=d3_timer_mark(),delay=d3_timer_sweep()-now;if(delay>24){if(isFinite(delay)){clearTimeout(d3_timer_timeout);d3_timer_timeout=setTimeout(d3_timer_step,delay);}
d3_timer_interval=0;}else{d3_timer_interval=1;d3_timer_frame(d3_timer_step);}}
d3.timer.flush=function(){d3_timer_mark();d3_timer_sweep();};function d3_timer_mark(){var now=Date.now();d3_timer_active=d3_timer_queueHead;while(d3_timer_active){if(now>=d3_timer_active.t)d3_timer_active.f=d3_timer_active.c(now-d3_timer_active.t);d3_timer_active=d3_timer_active.n;}
return now;}
function d3_timer_sweep(){var t0,t1=d3_timer_queueHead,time=Infinity;while(t1){if(t1.f){t1=t0?t0.n=t1.n:d3_timer_queueHead=t1.n;}else{if(t1.t<time)time=t1.t;t1=(t0=t1).n;}}
d3_timer_queueTail=t0;return time;}
function d3_format_precision(x,p){return p-(x?Math.ceil(Math.log(x)/Math.LN10):1);}
d3.round=function(x,n){return n?Math.round(x*(n=Math.pow(10,n)))/n:Math.round(x);};var d3_formatPrefixes=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"].map(d3_formatPrefix);d3.formatPrefix=function(value,precision){var i=0;if(value){if(value<0)value*=-1;if(precision)value=d3.round(value,d3_format_precision(value,precision));i=1+Math.floor(1e-12+Math.log(value)/Math.LN10);i=Math.max(-24,Math.min(24,Math.floor((i-1)/3)*3));}
return d3_formatPrefixes[8+i/3];};function d3_formatPrefix(d,i){var k=Math.pow(10,abs(8-i)*3);return{scale:i>8?function(d){return d/k;}:function(d){return d*k;},symbol:d};}
function d3_locale_numberFormat(locale){var locale_decimal=locale.decimal,locale_thousands=locale.thousands,locale_grouping=locale.grouping,locale_currency=locale.currency,formatGroup=locale_grouping?function(value){var i=value.length,t=[],j=0,g=locale_grouping[0];while(i>0&&g>0){t.push(value.substring(i-=g,i+g));g=locale_grouping[j=(j+1)%locale_grouping.length];}
return t.reverse().join(locale_thousands);}:d3_identity;return function(specifier){var match=d3_format_re.exec(specifier),fill=match[1]||" ",align=match[2]||">",sign=match[3]||"",symbol=match[4]||"",zfill=match[5],width=+match[6],comma=match[7],precision=match[8],type=match[9],scale=1,prefix="",suffix="",integer=false;if(precision)precision=+precision.substring(1);if(zfill||fill==="0"&&align==="="){zfill=fill="0";align="=";if(comma)width-=Math.floor((width-1)/4);}
switch(type){case"n":comma=true;type="g";break;case"%":scale=100;suffix="%";type="f";break;case"p":scale=100;suffix="%";type="r";break;case"b":case"o":case"x":case"X":if(symbol==="#")prefix="0"+type.toLowerCase();case"c":case"d":integer=true;precision=0;break;case"s":scale=-1;type="r";break;}
if(symbol==="$")prefix=locale_currency[0],suffix=locale_currency[1];if(type=="r"&&!precision)type="g";if(precision!=null){if(type=="g")precision=Math.max(1,Math.min(21,precision));else if(type=="e"||type=="f")precision=Math.max(0,Math.min(20,precision));}
type=d3_format_types.get(type)||d3_format_typeDefault;var zcomma=zfill&&comma;return function(value){var fullSuffix=suffix;if(integer&&value%1)return"";var negative=value<0||value===0&&1/value<0?(value=-value,"-"):sign;if(scale<0){var unit=d3.formatPrefix(value,precision);value=unit.scale(value);fullSuffix=unit.symbol+suffix;}else{value*=scale;}
value=type(value,precision);var i=value.lastIndexOf("."),before=i<0?value:value.substring(0,i),after=i<0?"":locale_decimal+value.substring(i+1);if(!zfill&&comma)before=formatGroup(before);var length=prefix.length+before.length+after.length+(zcomma?0:negative.length),padding=length<width?new Array(length=width-length+1).join(fill):"";if(zcomma)before=formatGroup(padding+before);negative+=prefix;value=before+after;return(align==="<"?negative+value+padding:align===">"?padding+negative+value:align==="^"?padding.substring(0,length>>=1)+negative+value+padding.substring(length):negative+(zcomma?value:padding+value))+fullSuffix;};};}
var d3_format_re=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i;var d3_format_types=d3.map({b:function(x){return x.toString(2);},c:function(x){return String.fromCharCode(x);},o:function(x){return x.toString(8);},x:function(x){return x.toString(16);},X:function(x){return x.toString(16).toUpperCase();},g:function(x,p){return x.toPrecision(p);},e:function(x,p){return x.toExponential(p);},f:function(x,p){return x.toFixed(p);},r:function(x,p){return(x=d3.round(x,d3_format_precision(x,p))).toFixed(Math.max(0,Math.min(20,d3_format_precision(x*(1+1e-15),p))));}});function d3_format_typeDefault(x){return x+"";}
var d3_time=d3.time={},d3_date=Date;function d3_date_utc(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0]);}
d3_date_utc.prototype={getDate:function(){return this._.getUTCDate();},getDay:function(){return this._.getUTCDay();},getFullYear:function(){return this._.getUTCFullYear();},getHours:function(){return this._.getUTCHours();},getMilliseconds:function(){return this._.getUTCMilliseconds();},getMinutes:function(){return this._.getUTCMinutes();},getMonth:function(){return this._.getUTCMonth();},getSeconds:function(){return this._.getUTCSeconds();},getTime:function(){return this._.getTime();},getTimezoneOffset:function(){return 0;},valueOf:function(){return this._.valueOf();},setDate:function(){d3_time_prototype.setUTCDate.apply(this._,arguments);},setDay:function(){d3_time_prototype.setUTCDay.apply(this._,arguments);},setFullYear:function(){d3_time_prototype.setUTCFullYear.apply(this._,arguments);},setHours:function(){d3_time_prototype.setUTCHours.apply(this._,arguments);},setMilliseconds:function(){d3_time_prototype.setUTCMilliseconds.apply(this._,arguments);},setMinutes:function(){d3_time_prototype.setUTCMinutes.apply(this._,arguments);},setMonth:function(){d3_time_prototype.setUTCMonth.apply(this._,arguments);},setSeconds:function(){d3_time_prototype.setUTCSeconds.apply(this._,arguments);},setTime:function(){d3_time_prototype.setTime.apply(this._,arguments);}};var d3_time_prototype=Date.prototype;function d3_time_interval(local,step,number){function round(date){var d0=local(date),d1=offset(d0,1);return date-d0<d1-date?d0:d1;}
function ceil(date){step(date=local(new d3_date(date-1)),1);return date;}
function offset(date,k){step(date=new d3_date(+date),k);return date;}
function range(t0,t1,dt){var time=ceil(t0),times=[];if(dt>1){while(time<t1){if(!(number(time)%dt))times.push(new Date(+time));step(time,1);}}else{while(time<t1)times.push(new Date(+time)),step(time,1);}
return times;}
function range_utc(t0,t1,dt){try{d3_date=d3_date_utc;var utc=new d3_date_utc();utc._=t0;return range(utc,t1,dt);}finally{d3_date=Date;}}
local.floor=local;local.round=round;local.ceil=ceil;local.offset=offset;local.range=range;var utc=local.utc=d3_time_interval_utc(local);utc.floor=utc;utc.round=d3_time_interval_utc(round);utc.ceil=d3_time_interval_utc(ceil);utc.offset=d3_time_interval_utc(offset);utc.range=range_utc;return local;}
function d3_time_interval_utc(method){return function(date,k){try{d3_date=d3_date_utc;var utc=new d3_date_utc();utc._=date;return method(utc,k)._;}finally{d3_date=Date;}};}
d3_time.year=d3_time_interval(function(date){date=d3_time.day(date);date.setMonth(0,1);return date;},function(date,offset){date.setFullYear(date.getFullYear()+offset);},function(date){return date.getFullYear();});d3_time.years=d3_time.year.range;d3_time.years.utc=d3_time.year.utc.range;d3_time.day=d3_time_interval(function(date){var day=new d3_date(2e3,0);day.setFullYear(date.getFullYear(),date.getMonth(),date.getDate());return day;},function(date,offset){date.setDate(date.getDate()+offset);},function(date){return date.getDate()-1;});d3_time.days=d3_time.day.range;d3_time.days.utc=d3_time.day.utc.range;d3_time.dayOfYear=function(date){var year=d3_time.year(date);return Math.floor((date-year-(date.getTimezoneOffset()-year.getTimezoneOffset())*6e4)/864e5);};["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].forEach(function(day,i){i=7-i;var interval=d3_time[day]=d3_time_interval(function(date){(date=d3_time.day(date)).setDate(date.getDate()-(date.getDay()+i)%7);return date;},function(date,offset){date.setDate(date.getDate()+Math.floor(offset)*7);},function(date){var day=d3_time.year(date).getDay();return Math.floor((d3_time.dayOfYear(date)+(day+i)%7)/7)-(day!==i);});d3_time[day+"s"]=interval.range;d3_time[day+"s"].utc=interval.utc.range;d3_time[day+"OfYear"]=function(date){var day=d3_time.year(date).getDay();return Math.floor((d3_time.dayOfYear(date)+(day+i)%7)/7);};});d3_time.week=d3_time.sunday;d3_time.weeks=d3_time.sunday.range;d3_time.weeks.utc=d3_time.sunday.utc.range;d3_time.weekOfYear=d3_time.sundayOfYear;function d3_locale_timeFormat(locale){var locale_dateTime=locale.dateTime,locale_date=locale.date,locale_time=locale.time,locale_periods=locale.periods,locale_days=locale.days,locale_shortDays=locale.shortDays,locale_months=locale.months,locale_shortMonths=locale.shortMonths;function d3_time_format(template){var n=template.length;function format(date){var string=[],i=-1,j=0,c,p,f;while(++i<n){if(template.charCodeAt(i)===37){string.push(template.substring(j,i));if((p=d3_time_formatPads[c=template.charAt(++i)])!=null)c=template.charAt(++i);if(f=d3_time_formats[c])c=f(date,p==null?c==="e"?" ":"0":p);string.push(c);j=i+1;}}
string.push(template.substring(j,i));return string.join("");}
format.parse=function(string){var d={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null},i=d3_time_parse(d,template,string,0);if(i!=string.length)return null;if("p"in d)d.H=d.H%12+d.p*12;var localZ=d.Z!=null&&d3_date!==d3_date_utc,date=new(localZ?d3_date_utc:d3_date)();if("j"in d)date.setFullYear(d.y,0,d.j);else if("w"in d&&("W"in d||"U"in d)){date.setFullYear(d.y,0,1);date.setFullYear(d.y,0,"W"in d?(d.w+6)%7+d.W*7-(date.getDay()+5)%7:d.w+d.U*7-(date.getDay()+6)%7);}else date.setFullYear(d.y,d.m,d.d);date.setHours(d.H+Math.floor(d.Z/100),d.M+d.Z%100,d.S,d.L);return localZ?date._:date;};format.toString=function(){return template;};return format;}
function d3_time_parse(date,template,string,j){var c,p,t,i=0,n=template.length,m=string.length;while(i<n){if(j>=m)return-1;c=template.charCodeAt(i++);if(c===37){t=template.charAt(i++);p=d3_time_parsers[t in d3_time_formatPads?template.charAt(i++):t];if(!p||(j=p(date,string,j))<0)return-1;}else if(c!=string.charCodeAt(j++)){return-1;}}
return j;}
d3_time_format.utc=function(template){var local=d3_time_format(template);function format(date){try{d3_date=d3_date_utc;var utc=new d3_date();utc._=date;return local(utc);}finally{d3_date=Date;}}
format.parse=function(string){try{d3_date=d3_date_utc;var date=local.parse(string);return date&&date._;}finally{d3_date=Date;}};format.toString=local.toString;return format;};d3_time_format.multi=d3_time_format.utc.multi=d3_time_formatMulti;var d3_time_periodLookup=d3.map(),d3_time_dayRe=d3_time_formatRe(locale_days),d3_time_dayLookup=d3_time_formatLookup(locale_days),d3_time_dayAbbrevRe=d3_time_formatRe(locale_shortDays),d3_time_dayAbbrevLookup=d3_time_formatLookup(locale_shortDays),d3_time_monthRe=d3_time_formatRe(locale_months),d3_time_monthLookup=d3_time_formatLookup(locale_months),d3_time_monthAbbrevRe=d3_time_formatRe(locale_shortMonths),d3_time_monthAbbrevLookup=d3_time_formatLookup(locale_shortMonths);locale_periods.forEach(function(p,i){d3_time_periodLookup.set(p.toLowerCase(),i);});var d3_time_formats={a:function(d){return locale_shortDays[d.getDay()];},A:function(d){return locale_days[d.getDay()];},b:function(d){return locale_shortMonths[d.getMonth()];},B:function(d){return locale_months[d.getMonth()];},c:d3_time_format(locale_dateTime),d:function(d,p){return d3_time_formatPad(d.getDate(),p,2);},e:function(d,p){return d3_time_formatPad(d.getDate(),p,2);},H:function(d,p){return d3_time_formatPad(d.getHours(),p,2);},I:function(d,p){return d3_time_formatPad(d.getHours()%12||12,p,2);},j:function(d,p){return d3_time_formatPad(1+d3_time.dayOfYear(d),p,3);},L:function(d,p){return d3_time_formatPad(d.getMilliseconds(),p,3);},m:function(d,p){return d3_time_formatPad(d.getMonth()+1,p,2);},M:function(d,p){return d3_time_formatPad(d.getMinutes(),p,2);},p:function(d){return locale_periods[+(d.getHours()>=12)];},S:function(d,p){return d3_time_formatPad(d.getSeconds(),p,2);},U:function(d,p){return d3_time_formatPad(d3_time.sundayOfYear(d),p,2);},w:function(d){return d.getDay();},W:function(d,p){return d3_time_formatPad(d3_time.mondayOfYear(d),p,2);},x:d3_time_format(locale_date),X:d3_time_format(locale_time),y:function(d,p){return d3_time_formatPad(d.getFullYear()%100,p,2);},Y:function(d,p){return d3_time_formatPad(d.getFullYear()%1e4,p,4);},Z:d3_time_zone,"%":function(){return"%";}};var d3_time_parsers={a:d3_time_parseWeekdayAbbrev,A:d3_time_parseWeekday,b:d3_time_parseMonthAbbrev,B:d3_time_parseMonth,c:d3_time_parseLocaleFull,d:d3_time_parseDay,e:d3_time_parseDay,H:d3_time_parseHour24,I:d3_time_parseHour24,j:d3_time_parseDayOfYear,L:d3_time_parseMilliseconds,m:d3_time_parseMonthNumber,M:d3_time_parseMinutes,p:d3_time_parseAmPm,S:d3_time_parseSeconds,U:d3_time_parseWeekNumberSunday,w:d3_time_parseWeekdayNumber,W:d3_time_parseWeekNumberMonday,x:d3_time_parseLocaleDate,X:d3_time_parseLocaleTime,y:d3_time_parseYear,Y:d3_time_parseFullYear,Z:d3_time_parseZone,"%":d3_time_parseLiteralPercent};function d3_time_parseWeekdayAbbrev(date,string,i){d3_time_dayAbbrevRe.lastIndex=0;var n=d3_time_dayAbbrevRe.exec(string.substring(i));return n?(date.w=d3_time_dayAbbrevLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}
function d3_time_parseWeekday(date,string,i){d3_time_dayRe.lastIndex=0;var n=d3_time_dayRe.exec(string.substring(i));return n?(date.w=d3_time_dayLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}
function d3_time_parseMonthAbbrev(date,string,i){d3_time_monthAbbrevRe.lastIndex=0;var n=d3_time_monthAbbrevRe.exec(string.substring(i));return n?(date.m=d3_time_monthAbbrevLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}
function d3_time_parseMonth(date,string,i){d3_time_monthRe.lastIndex=0;var n=d3_time_monthRe.exec(string.substring(i));return n?(date.m=d3_time_monthLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}
function d3_time_parseLocaleFull(date,string,i){return d3_time_parse(date,d3_time_formats.c.toString(),string,i);}
function d3_time_parseLocaleDate(date,string,i){return d3_time_parse(date,d3_time_formats.x.toString(),string,i);}
function d3_time_parseLocaleTime(date,string,i){return d3_time_parse(date,d3_time_formats.X.toString(),string,i);}
function d3_time_parseAmPm(date,string,i){var n=d3_time_periodLookup.get(string.substring(i,i+=2).toLowerCase());return n==null?-1:(date.p=n,i);}
return d3_time_format;}
var d3_time_formatPads={"-":"",_:" ","0":"0"},d3_time_numberRe=/^\s*\d+/,d3_time_percentRe=/^%/;function d3_time_formatPad(value,fill,width){var sign=value<0?"-":"",string=(sign?-value:value)+"",length=string.length;return sign+(length<width?new Array(width-length+1).join(fill)+string:string);}
function d3_time_formatRe(names){return new RegExp("^(?:"+names.map(d3.requote).join("|")+")","i");}
function d3_time_formatLookup(names){var map=new d3_Map(),i=-1,n=names.length;while(++i<n)map.set(names[i].toLowerCase(),i);return map;}
function d3_time_parseWeekdayNumber(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+1));return n?(date.w=+n[0],i+n[0].length):-1;}
function d3_time_parseWeekNumberSunday(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i));return n?(date.U=+n[0],i+n[0].length):-1;}
function d3_time_parseWeekNumberMonday(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i));return n?(date.W=+n[0],i+n[0].length):-1;}
function d3_time_parseFullYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+4));return n?(date.y=+n[0],i+n[0].length):-1;}
function d3_time_parseYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.y=d3_time_expandYear(+n[0]),i+n[0].length):-1;}
function d3_time_parseZone(date,string,i){return/^[+-]\d{4}$/.test(string=string.substring(i,i+5))?(date.Z=-string,i+5):-1;}
function d3_time_expandYear(d){return d+(d>68?1900:2e3);}
function d3_time_parseMonthNumber(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.m=n[0]-1,i+n[0].length):-1;}
function d3_time_parseDay(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.d=+n[0],i+n[0].length):-1;}
function d3_time_parseDayOfYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+3));return n?(date.j=+n[0],i+n[0].length):-1;}
function d3_time_parseHour24(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.H=+n[0],i+n[0].length):-1;}
function d3_time_parseMinutes(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.M=+n[0],i+n[0].length):-1;}
function d3_time_parseSeconds(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+2));return n?(date.S=+n[0],i+n[0].length):-1;}
function d3_time_parseMilliseconds(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.substring(i,i+3));return n?(date.L=+n[0],i+n[0].length):-1;}
function d3_time_zone(d){var z=d.getTimezoneOffset(),zs=z>0?"-":"+",zh=~~(abs(z)/60),zm=abs(z)%60;return zs+d3_time_formatPad(zh,"0",2)+d3_time_formatPad(zm,"0",2);}
function d3_time_parseLiteralPercent(date,string,i){d3_time_percentRe.lastIndex=0;var n=d3_time_percentRe.exec(string.substring(i,i+1));return n?i+n[0].length:-1;}
function d3_time_formatMulti(formats){var n=formats.length,i=-1;while(++i<n)formats[i][0]=this(formats[i][0]);return function(date){var i=0,f=formats[i];while(!f[1](date))f=formats[++i];return f[0](date);};}
d3.locale=function(locale){return{numberFormat:d3_locale_numberFormat(locale),timeFormat:d3_locale_timeFormat(locale)};};var d3_locale_enUS=d3.locale({decimal:".",thousands:",",grouping:[3],currency:["$",""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});d3.format=d3_locale_enUS.numberFormat;d3.geo={};function d3_adder(){}
d3_adder.prototype={s:0,t:0,add:function(y){d3_adderSum(y,this.t,d3_adderTemp);d3_adderSum(d3_adderTemp.s,this.s,this);if(this.s)this.t+=d3_adderTemp.t;else this.s=d3_adderTemp.t;},reset:function(){this.s=this.t=0;},valueOf:function(){return this.s;}};var d3_adderTemp=new d3_adder();function d3_adderSum(a,b,o){var x=o.s=a+b,bv=x-a,av=x-bv;o.t=a-av+(b-bv);}
d3.geo.stream=function(object,listener){if(object&&d3_geo_streamObjectType.hasOwnProperty(object.type)){d3_geo_streamObjectType[object.type](object,listener);}else{d3_geo_streamGeometry(object,listener);}};function d3_geo_streamGeometry(geometry,listener){if(geometry&&d3_geo_streamGeometryType.hasOwnProperty(geometry.type)){d3_geo_streamGeometryType[geometry.type](geometry,listener);}}
var d3_geo_streamObjectType={Feature:function(feature,listener){d3_geo_streamGeometry(feature.geometry,listener);},FeatureCollection:function(object,listener){var features=object.features,i=-1,n=features.length;while(++i<n)d3_geo_streamGeometry(features[i].geometry,listener);}};var d3_geo_streamGeometryType={Sphere:function(object,listener){listener.sphere();},Point:function(object,listener){object=object.coordinates;listener.point(object[0],object[1],object[2]);},MultiPoint:function(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n)object=coordinates[i],listener.point(object[0],object[1],object[2]);},LineString:function(object,listener){d3_geo_streamLine(object.coordinates,listener,0);},MultiLineString:function(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n)d3_geo_streamLine(coordinates[i],listener,0);},Polygon:function(object,listener){d3_geo_streamPolygon(object.coordinates,listener);},MultiPolygon:function(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n)d3_geo_streamPolygon(coordinates[i],listener);},GeometryCollection:function(object,listener){var geometries=object.geometries,i=-1,n=geometries.length;while(++i<n)d3_geo_streamGeometry(geometries[i],listener);}};function d3_geo_streamLine(coordinates,listener,closed){var i=-1,n=coordinates.length-closed,coordinate;listener.lineStart();while(++i<n)coordinate=coordinates[i],listener.point(coordinate[0],coordinate[1],coordinate[2]);listener.lineEnd();}
function d3_geo_streamPolygon(coordinates,listener){var i=-1,n=coordinates.length;listener.polygonStart();while(++i<n)d3_geo_streamLine(coordinates[i],listener,1);listener.polygonEnd();}
d3.geo.area=function(object){d3_geo_areaSum=0;d3.geo.stream(object,d3_geo_area);return d3_geo_areaSum;};var d3_geo_areaSum,d3_geo_areaRingSum=new d3_adder();var d3_geo_area={sphere:function(){d3_geo_areaSum+=4*π;},point:d3_noop,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:function(){d3_geo_areaRingSum.reset();d3_geo_area.lineStart=d3_geo_areaRingStart;},polygonEnd:function(){var area=2*d3_geo_areaRingSum;d3_geo_areaSum+=area<0?4*π+area:area;d3_geo_area.lineStart=d3_geo_area.lineEnd=d3_geo_area.point=d3_noop;}};function d3_geo_areaRingStart(){var λ00,φ00,λ0,cosφ0,sinφ0;d3_geo_area.point=function(λ,φ){d3_geo_area.point=nextPoint;λ0=(λ00=λ)*d3_radians,cosφ0=Math.cos(φ=(φ00=φ)*d3_radians/2+π/4),sinφ0=Math.sin(φ);};function nextPoint(λ,φ){λ*=d3_radians;φ=φ*d3_radians/2+π/4;var dλ=λ-λ0,sdλ=dλ>=0?1:-1,adλ=sdλ*dλ,cosφ=Math.cos(φ),sinφ=Math.sin(φ),k=sinφ0*sinφ,u=cosφ0*cosφ+k*Math.cos(adλ),v=k*sdλ*Math.sin(adλ);d3_geo_areaRingSum.add(Math.atan2(v,u));λ0=λ,cosφ0=cosφ,sinφ0=sinφ;}
d3_geo_area.lineEnd=function(){nextPoint(λ00,φ00);};}
function d3_geo_cartesian(spherical){var λ=spherical[0],φ=spherical[1],cosφ=Math.cos(φ);return[cosφ*Math.cos(λ),cosφ*Math.sin(λ),Math.sin(φ)];}
function d3_geo_cartesianDot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2];}
function d3_geo_cartesianCross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]];}
function d3_geo_cartesianAdd(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];}
function d3_geo_cartesianScale(vector,k){return[vector[0]*k,vector[1]*k,vector[2]*k];}
function d3_geo_cartesianNormalize(d){var l=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]);d[0]/=l;d[1]/=l;d[2]/=l;}
function d3_geo_spherical(cartesian){return[Math.atan2(cartesian[1],cartesian[0]),d3_asin(cartesian[2])];}
function d3_geo_sphericalEqual(a,b){return abs(a[0]-b[0])<ε&&abs(a[1]-b[1])<ε;}
d3.geo.bounds=function(){var λ0,φ0,λ1,φ1,λ_,λ__,φ__,p0,dλSum,ranges,range;var bound={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function(){bound.point=ringPoint;bound.lineStart=ringStart;bound.lineEnd=ringEnd;dλSum=0;d3_geo_area.polygonStart();},polygonEnd:function(){d3_geo_area.polygonEnd();bound.point=point;bound.lineStart=lineStart;bound.lineEnd=lineEnd;if(d3_geo_areaRingSum<0)λ0=-(λ1=180),φ0=-(φ1=90);else if(dλSum>ε)φ1=90;else if(dλSum<-ε)φ0=-90;range[0]=λ0,range[1]=λ1;}};function point(λ,φ){ranges.push(range=[λ0=λ,λ1=λ]);if(φ<φ0)φ0=φ;if(φ>φ1)φ1=φ;}
function linePoint(λ,φ){var p=d3_geo_cartesian([λ*d3_radians,φ*d3_radians]);if(p0){var normal=d3_geo_cartesianCross(p0,p),equatorial=[normal[1],-normal[0],0],inflection=d3_geo_cartesianCross(equatorial,normal);d3_geo_cartesianNormalize(inflection);inflection=d3_geo_spherical(inflection);var dλ=λ-λ_,s=dλ>0?1:-1,λi=inflection[0]*d3_degrees*s,antimeridian=abs(dλ)>180;if(antimeridian^(s*λ_<λi&&λi<s*λ)){var φi=inflection[1]*d3_degrees;if(φi>φ1)φ1=φi;}else if(λi=(λi+360)%360-180,antimeridian^(s*λ_<λi&&λi<s*λ)){var φi=-inflection[1]*d3_degrees;if(φi<φ0)φ0=φi;}else{if(φ<φ0)φ0=φ;if(φ>φ1)φ1=φ;}
if(antimeridian){if(λ<λ_){if(angle(λ0,λ)>angle(λ0,λ1))λ1=λ;}else{if(angle(λ,λ1)>angle(λ0,λ1))λ0=λ;}}else{if(λ1>=λ0){if(λ<λ0)λ0=λ;if(λ>λ1)λ1=λ;}else{if(λ>λ_){if(angle(λ0,λ)>angle(λ0,λ1))λ1=λ;}else{if(angle(λ,λ1)>angle(λ0,λ1))λ0=λ;}}}}else{point(λ,φ);}
p0=p,λ_=λ;}
function lineStart(){bound.point=linePoint;}
function lineEnd(){range[0]=λ0,range[1]=λ1;bound.point=point;p0=null;}
function ringPoint(λ,φ){if(p0){var dλ=λ-λ_;dλSum+=abs(dλ)>180?dλ+(dλ>0?360:-360):dλ;}else λ__=λ,φ__=φ;d3_geo_area.point(λ,φ);linePoint(λ,φ);}
function ringStart(){d3_geo_area.lineStart();}
function ringEnd(){ringPoint(λ__,φ__);d3_geo_area.lineEnd();if(abs(dλSum)>ε)λ0=-(λ1=180);range[0]=λ0,range[1]=λ1;p0=null;}
function angle(λ0,λ1){return(λ1-=λ0)<0?λ1+360:λ1;}
function compareRanges(a,b){return a[0]-b[0];}
function withinRange(x,range){return range[0]<=range[1]?range[0]<=x&&x<=range[1]:x<range[0]||range[1]<x;}
return function(feature){φ1=λ1=-(λ0=φ0=Infinity);ranges=[];d3.geo.stream(feature,bound);var n=ranges.length;if(n){ranges.sort(compareRanges);for(var i=1,a=ranges[0],b,merged=[a];i<n;++i){b=ranges[i];if(withinRange(b[0],a)||withinRange(b[1],a)){if(angle(a[0],b[1])>angle(a[0],a[1]))a[1]=b[1];if(angle(b[0],a[1])>angle(a[0],a[1]))a[0]=b[0];}else{merged.push(a=b);}}
var best=-Infinity,dλ;for(var n=merged.length-1,i=0,a=merged[n],b;i<=n;a=b,++i){b=merged[i];if((dλ=angle(a[1],b[0]))>best)best=dλ,λ0=b[0],λ1=a[1];}}
ranges=range=null;return λ0===Infinity||φ0===Infinity?[[NaN,NaN],[NaN,NaN]]:[[λ0,φ0],[λ1,φ1]];};}();d3.geo.centroid=function(object){d3_geo_centroidW0=d3_geo_centroidW1=d3_geo_centroidX0=d3_geo_centroidY0=d3_geo_centroidZ0=d3_geo_centroidX1=d3_geo_centroidY1=d3_geo_centroidZ1=d3_geo_centroidX2=d3_geo_centroidY2=d3_geo_centroidZ2=0;d3.geo.stream(object,d3_geo_centroid);var x=d3_geo_centroidX2,y=d3_geo_centroidY2,z=d3_geo_centroidZ2,m=x*x+y*y+z*z;if(m<ε2){x=d3_geo_centroidX1,y=d3_geo_centroidY1,z=d3_geo_centroidZ1;if(d3_geo_centroidW1<ε)x=d3_geo_centroidX0,y=d3_geo_centroidY0,z=d3_geo_centroidZ0;m=x*x+y*y+z*z;if(m<ε2)return[NaN,NaN];}
return[Math.atan2(y,x)*d3_degrees,d3_asin(z/Math.sqrt(m))*d3_degrees];};var d3_geo_centroidW0,d3_geo_centroidW1,d3_geo_centroidX0,d3_geo_centroidY0,d3_geo_centroidZ0,d3_geo_centroidX1,d3_geo_centroidY1,d3_geo_centroidZ1,d3_geo_centroidX2,d3_geo_centroidY2,d3_geo_centroidZ2;var d3_geo_centroid={sphere:d3_noop,point:d3_geo_centroidPoint,lineStart:d3_geo_centroidLineStart,lineEnd:d3_geo_centroidLineEnd,polygonStart:function(){d3_geo_centroid.lineStart=d3_geo_centroidRingStart;},polygonEnd:function(){d3_geo_centroid.lineStart=d3_geo_centroidLineStart;}};function d3_geo_centroidPoint(λ,φ){λ*=d3_radians;var cosφ=Math.cos(φ*=d3_radians);d3_geo_centroidPointXYZ(cosφ*Math.cos(λ),cosφ*Math.sin(λ),Math.sin(φ));}
function d3_geo_centroidPointXYZ(x,y,z){++d3_geo_centroidW0;d3_geo_centroidX0+=(x-d3_geo_centroidX0)/d3_geo_centroidW0;d3_geo_centroidY0+=(y-d3_geo_centroidY0)/d3_geo_centroidW0;d3_geo_centroidZ0+=(z-d3_geo_centroidZ0)/d3_geo_centroidW0;}
function d3_geo_centroidLineStart(){var x0,y0,z0;d3_geo_centroid.point=function(λ,φ){λ*=d3_radians;var cosφ=Math.cos(φ*=d3_radians);x0=cosφ*Math.cos(λ);y0=cosφ*Math.sin(λ);z0=Math.sin(φ);d3_geo_centroid.point=nextPoint;d3_geo_centroidPointXYZ(x0,y0,z0);};function nextPoint(λ,φ){λ*=d3_radians;var cosφ=Math.cos(φ*=d3_radians),x=cosφ*Math.cos(λ),y=cosφ*Math.sin(λ),z=Math.sin(φ),w=Math.atan2(Math.sqrt((w=y0*z-z0*y)*w+(w=z0*x-x0*z)*w+(w=x0*y-y0*x)*w),x0*x+y0*y+z0*z);d3_geo_centroidW1+=w;d3_geo_centroidX1+=w*(x0+(x0=x));d3_geo_centroidY1+=w*(y0+(y0=y));d3_geo_centroidZ1+=w*(z0+(z0=z));d3_geo_centroidPointXYZ(x0,y0,z0);}}
function d3_geo_centroidLineEnd(){d3_geo_centroid.point=d3_geo_centroidPoint;}
function d3_geo_centroidRingStart(){var λ00,φ00,x0,y0,z0;d3_geo_centroid.point=function(λ,φ){λ00=λ,φ00=φ;d3_geo_centroid.point=nextPoint;λ*=d3_radians;var cosφ=Math.cos(φ*=d3_radians);x0=cosφ*Math.cos(λ);y0=cosφ*Math.sin(λ);z0=Math.sin(φ);d3_geo_centroidPointXYZ(x0,y0,z0);};d3_geo_centroid.lineEnd=function(){nextPoint(λ00,φ00);d3_geo_centroid.lineEnd=d3_geo_centroidLineEnd;d3_geo_centroid.point=d3_geo_centroidPoint;};function nextPoint(λ,φ){λ*=d3_radians;var cosφ=Math.cos(φ*=d3_radians),x=cosφ*Math.cos(λ),y=cosφ*Math.sin(λ),z=Math.sin(φ),cx=y0*z-z0*y,cy=z0*x-x0*z,cz=x0*y-y0*x,m=Math.sqrt(cx*cx+cy*cy+cz*cz),u=x0*x+y0*y+z0*z,v=m&&-d3_acos(u)/m,w=Math.atan2(m,u);d3_geo_centroidX2+=v*cx;d3_geo_centroidY2+=v*cy;d3_geo_centroidZ2+=v*cz;d3_geo_centroidW1+=w;d3_geo_centroidX1+=w*(x0+(x0=x));d3_geo_centroidY1+=w*(y0+(y0=y));d3_geo_centroidZ1+=w*(z0+(z0=z));d3_geo_centroidPointXYZ(x0,y0,z0);}}
function d3_true(){return true;}
function d3_geo_clipPolygon(segments,compare,clipStartInside,interpolate,listener){var subject=[],clip=[];segments.forEach(function(segment){if((n=segment.length-1)<=0)return;var n,p0=segment[0],p1=segment[n];if(d3_geo_sphericalEqual(p0,p1)){listener.lineStart();for(var i=0;i<n;++i)listener.point((p0=segment[i])[0],p0[1]);listener.lineEnd();return;}
var a=new d3_geo_clipPolygonIntersection(p0,segment,null,true),b=new d3_geo_clipPolygonIntersection(p0,null,a,false);a.o=b;subject.push(a);clip.push(b);a=new d3_geo_clipPolygonIntersection(p1,segment,null,false);b=new d3_geo_clipPolygonIntersection(p1,null,a,true);a.o=b;subject.push(a);clip.push(b);});clip.sort(compare);d3_geo_clipPolygonLinkCircular(subject);d3_geo_clipPolygonLinkCircular(clip);if(!subject.length)return;for(var i=0,entry=clipStartInside,n=clip.length;i<n;++i){clip[i].e=entry=!entry;}
var start=subject[0],points,point;while(1){var current=start,isSubject=true;while(current.v)if((current=current.n)===start)return;points=current.z;listener.lineStart();do{current.v=current.o.v=true;if(current.e){if(isSubject){for(var i=0,n=points.length;i<n;++i)listener.point((point=points[i])[0],point[1]);}else{interpolate(current.x,current.n.x,1,listener);}
current=current.n;}else{if(isSubject){points=current.p.z;for(var i=points.length-1;i>=0;--i)listener.point((point=points[i])[0],point[1]);}else{interpolate(current.x,current.p.x,-1,listener);}
current=current.p;}
current=current.o;points=current.z;isSubject=!isSubject;}while(!current.v);listener.lineEnd();}}
function d3_geo_clipPolygonLinkCircular(array){if(!(n=array.length))return;var n,i=0,a=array[0],b;while(++i<n){a.n=b=array[i];b.p=a;a=b;}
a.n=b=array[0];b.p=a;}
function d3_geo_clipPolygonIntersection(point,points,other,entry){this.x=point;this.z=points;this.o=other;this.e=entry;this.v=false;this.n=this.p=null;}
function d3_geo_clip(pointVisible,clipLine,interpolate,clipStart){return function(rotate,listener){var line=clipLine(listener),rotatedClipStart=rotate.invert(clipStart[0],clipStart[1]);var clip={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function(){clip.point=pointRing;clip.lineStart=ringStart;clip.lineEnd=ringEnd;segments=[];polygon=[];},polygonEnd:function(){clip.point=point;clip.lineStart=lineStart;clip.lineEnd=lineEnd;segments=d3.merge(segments);var clipStartInside=d3_geo_pointInPolygon(rotatedClipStart,polygon);if(segments.length){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;d3_geo_clipPolygon(segments,d3_geo_clipSort,clipStartInside,interpolate,listener);}else if(clipStartInside){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();}
if(polygonStarted)listener.polygonEnd(),polygonStarted=false;segments=polygon=null;},sphere:function(){listener.polygonStart();listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();listener.polygonEnd();}};function point(λ,φ){var point=rotate(λ,φ);if(pointVisible(λ=point[0],φ=point[1]))listener.point(λ,φ);}
function pointLine(λ,φ){var point=rotate(λ,φ);line.point(point[0],point[1]);}
function lineStart(){clip.point=pointLine;line.lineStart();}
function lineEnd(){clip.point=point;line.lineEnd();}
var segments;var buffer=d3_geo_clipBufferListener(),ringListener=clipLine(buffer),polygonStarted=false,polygon,ring;function pointRing(λ,φ){ring.push([λ,φ]);var point=rotate(λ,φ);ringListener.point(point[0],point[1]);}
function ringStart(){ringListener.lineStart();ring=[];}
function ringEnd(){pointRing(ring[0][0],ring[0][1]);ringListener.lineEnd();var clean=ringListener.clean(),ringSegments=buffer.buffer(),segment,n=ringSegments.length;ring.pop();polygon.push(ring);ring=null;if(!n)return;if(clean&1){segment=ringSegments[0];var n=segment.length-1,i=-1,point;if(n>0){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;listener.lineStart();while(++i<n)listener.point((point=segment[i])[0],point[1]);listener.lineEnd();}
return;}
if(n>1&&clean&2)ringSegments.push(ringSegments.pop().concat(ringSegments.shift()));segments.push(ringSegments.filter(d3_geo_clipSegmentLength1));}
return clip;};}
function d3_geo_clipSegmentLength1(segment){return segment.length>1;}
function d3_geo_clipBufferListener(){var lines=[],line;return{lineStart:function(){lines.push(line=[]);},point:function(λ,φ){line.push([λ,φ]);},lineEnd:d3_noop,buffer:function(){var buffer=lines;lines=[];line=null;return buffer;},rejoin:function(){if(lines.length>1)lines.push(lines.pop().concat(lines.shift()));}};}
function d3_geo_clipSort(a,b){return((a=a.x)[0]<0?a[1]-halfπ-ε:halfπ-a[1])-((b=b.x)[0]<0?b[1]-halfπ-ε:halfπ-b[1]);}
function d3_geo_pointInPolygon(point,polygon){var meridian=point[0],parallel=point[1],meridianNormal=[Math.sin(meridian),-Math.cos(meridian),0],polarAngle=0,winding=0;d3_geo_areaRingSum.reset();for(var i=0,n=polygon.length;i<n;++i){var ring=polygon[i],m=ring.length;if(!m)continue;var point0=ring[0],λ0=point0[0],φ0=point0[1]/2+π/4,sinφ0=Math.sin(φ0),cosφ0=Math.cos(φ0),j=1;while(true){if(j===m)j=0;point=ring[j];var λ=point[0],φ=point[1]/2+π/4,sinφ=Math.sin(φ),cosφ=Math.cos(φ),dλ=λ-λ0,sdλ=dλ>=0?1:-1,adλ=sdλ*dλ,antimeridian=adλ>π,k=sinφ0*sinφ;d3_geo_areaRingSum.add(Math.atan2(k*sdλ*Math.sin(adλ),cosφ0*cosφ+k*Math.cos(adλ)));polarAngle+=antimeridian?dλ+sdλ*τ:dλ;if(antimeridian^λ0>=meridian^λ>=meridian){var arc=d3_geo_cartesianCross(d3_geo_cartesian(point0),d3_geo_cartesian(point));d3_geo_cartesianNormalize(arc);var intersection=d3_geo_cartesianCross(meridianNormal,arc);d3_geo_cartesianNormalize(intersection);var φarc=(antimeridian^dλ>=0?-1:1)*d3_asin(intersection[2]);if(parallel>φarc||parallel===φarc&&(arc[0]||arc[1])){winding+=antimeridian^dλ>=0?1:-1;}}
if(!j++)break;λ0=λ,sinφ0=sinφ,cosφ0=cosφ,point0=point;}}
return(polarAngle<-ε||polarAngle<ε&&d3_geo_areaRingSum<0)^winding&1;}
var d3_geo_clipAntimeridian=d3_geo_clip(d3_true,d3_geo_clipAntimeridianLine,d3_geo_clipAntimeridianInterpolate,[-π,-π/2]);function d3_geo_clipAntimeridianLine(listener){var λ0=NaN,φ0=NaN,sλ0=NaN,clean;return{lineStart:function(){listener.lineStart();clean=1;},point:function(λ1,φ1){var sλ1=λ1>0?π:-π,dλ=abs(λ1-λ0);if(abs(dλ-π)<ε){listener.point(λ0,φ0=(φ0+φ1)/2>0?halfπ:-halfπ);listener.point(sλ0,φ0);listener.lineEnd();listener.lineStart();listener.point(sλ1,φ0);listener.point(λ1,φ0);clean=0;}else if(sλ0!==sλ1&&dλ>=π){if(abs(λ0-sλ0)<ε)λ0-=sλ0*ε;if(abs(λ1-sλ1)<ε)λ1-=sλ1*ε;φ0=d3_geo_clipAntimeridianIntersect(λ0,φ0,λ1,φ1);listener.point(sλ0,φ0);listener.lineEnd();listener.lineStart();listener.point(sλ1,φ0);clean=0;}
listener.point(λ0=λ1,φ0=φ1);sλ0=sλ1;},lineEnd:function(){listener.lineEnd();λ0=φ0=NaN;},clean:function(){return 2-clean;}};}
function d3_geo_clipAntimeridianIntersect(λ0,φ0,λ1,φ1){var cosφ0,cosφ1,sinλ0_λ1=Math.sin(λ0-λ1);return abs(sinλ0_λ1)>ε?Math.atan((Math.sin(φ0)*(cosφ1=Math.cos(φ1))*Math.sin(λ1)-Math.sin(φ1)*(cosφ0=Math.cos(φ0))*Math.sin(λ0))/(cosφ0*cosφ1*sinλ0_λ1)):(φ0+φ1)/2;}
function d3_geo_clipAntimeridianInterpolate(from,to,direction,listener){var φ;if(from==null){φ=direction*halfπ;listener.point(-π,φ);listener.point(0,φ);listener.point(π,φ);listener.point(π,0);listener.point(π,-φ);listener.point(0,-φ);listener.point(-π,-φ);listener.point(-π,0);listener.point(-π,φ);}else if(abs(from[0]-to[0])>ε){var s=from[0]<to[0]?π:-π;φ=direction*s/2;listener.point(-s,φ);listener.point(0,φ);listener.point(s,φ);}else{listener.point(to[0],to[1]);}}
function d3_geo_clipCircle(radius){var cr=Math.cos(radius),smallRadius=cr>0,notHemisphere=abs(cr)>ε,interpolate=d3_geo_circleInterpolate(radius,6*d3_radians);return d3_geo_clip(visible,clipLine,interpolate,smallRadius?[0,-radius]:[-π,radius-π]);function visible(λ,φ){return Math.cos(λ)*Math.cos(φ)>cr;}
function clipLine(listener){var point0,c0,v0,v00,clean;return{lineStart:function(){v00=v0=false;clean=1;},point:function(λ,φ){var point1=[λ,φ],point2,v=visible(λ,φ),c=smallRadius?v?0:code(λ,φ):v?code(λ+(λ<0?π:-π),φ):0;if(!point0&&(v00=v0=v))listener.lineStart();if(v!==v0){point2=intersect(point0,point1);if(d3_geo_sphericalEqual(point0,point2)||d3_geo_sphericalEqual(point1,point2)){point1[0]+=ε;point1[1]+=ε;v=visible(point1[0],point1[1]);}}
if(v!==v0){clean=0;if(v){listener.lineStart();point2=intersect(point1,point0);listener.point(point2[0],point2[1]);}else{point2=intersect(point0,point1);listener.point(point2[0],point2[1]);listener.lineEnd();}
point0=point2;}else if(notHemisphere&&point0&&smallRadius^v){var t;if(!(c&c0)&&(t=intersect(point1,point0,true))){clean=0;if(smallRadius){listener.lineStart();listener.point(t[0][0],t[0][1]);listener.point(t[1][0],t[1][1]);listener.lineEnd();}else{listener.point(t[1][0],t[1][1]);listener.lineEnd();listener.lineStart();listener.point(t[0][0],t[0][1]);}}}
if(v&&(!point0||!d3_geo_sphericalEqual(point0,point1))){listener.point(point1[0],point1[1]);}
point0=point1,v0=v,c0=c;},lineEnd:function(){if(v0)listener.lineEnd();point0=null;},clean:function(){return clean|(v00&&v0)<<1;}};}
function intersect(a,b,two){var pa=d3_geo_cartesian(a),pb=d3_geo_cartesian(b);var n1=[1,0,0],n2=d3_geo_cartesianCross(pa,pb),n2n2=d3_geo_cartesianDot(n2,n2),n1n2=n2[0],determinant=n2n2-n1n2*n1n2;if(!determinant)return!two&&a;var c1=cr*n2n2/determinant,c2=-cr*n1n2/determinant,n1xn2=d3_geo_cartesianCross(n1,n2),A=d3_geo_cartesianScale(n1,c1),B=d3_geo_cartesianScale(n2,c2);d3_geo_cartesianAdd(A,B);var u=n1xn2,w=d3_geo_cartesianDot(A,u),uu=d3_geo_cartesianDot(u,u),t2=w*w-uu*(d3_geo_cartesianDot(A,A)-1);if(t2<0)return;var t=Math.sqrt(t2),q=d3_geo_cartesianScale(u,(-w-t)/uu);d3_geo_cartesianAdd(q,A);q=d3_geo_spherical(q);if(!two)return q;var λ0=a[0],λ1=b[0],φ0=a[1],φ1=b[1],z;if(λ1<λ0)z=λ0,λ0=λ1,λ1=z;var δλ=λ1-λ0,polar=abs(δλ-π)<ε,meridian=polar||δλ<ε;if(!polar&&φ1<φ0)z=φ0,φ0=φ1,φ1=z;if(meridian?polar?φ0+φ1>0^q[1]<(abs(q[0]-λ0)<ε?φ0:φ1):φ0<=q[1]&&q[1]<=φ1:δλ>π^(λ0<=q[0]&&q[0]<=λ1)){var q1=d3_geo_cartesianScale(u,(-w+t)/uu);d3_geo_cartesianAdd(q1,A);return[q,d3_geo_spherical(q1)];}}
function code(λ,φ){var r=smallRadius?radius:π-radius,code=0;if(λ<-r)code|=1;else if(λ>r)code|=2;if(φ<-r)code|=4;else if(φ>r)code|=8;return code;}}
function d3_geom_clipLine(x0,y0,x1,y1){return function(line){var a=line.a,b=line.b,ax=a.x,ay=a.y,bx=b.x,by=b.y,t0=0,t1=1,dx=bx-ax,dy=by-ay,r;r=x0-ax;if(!dx&&r>0)return;r/=dx;if(dx<0){if(r<t0)return;if(r<t1)t1=r;}else if(dx>0){if(r>t1)return;if(r>t0)t0=r;}
r=x1-ax;if(!dx&&r<0)return;r/=dx;if(dx<0){if(r>t1)return;if(r>t0)t0=r;}else if(dx>0){if(r<t0)return;if(r<t1)t1=r;}
r=y0-ay;if(!dy&&r>0)return;r/=dy;if(dy<0){if(r<t0)return;if(r<t1)t1=r;}else if(dy>0){if(r>t1)return;if(r>t0)t0=r;}
r=y1-ay;if(!dy&&r<0)return;r/=dy;if(dy<0){if(r>t1)return;if(r>t0)t0=r;}else if(dy>0){if(r<t0)return;if(r<t1)t1=r;}
if(t0>0)line.a={x:ax+t0*dx,y:ay+t0*dy};if(t1<1)line.b={x:ax+t1*dx,y:ay+t1*dy};return line;};}
var d3_geo_clipExtentMAX=1e9;d3.geo.clipExtent=function(){var x0,y0,x1,y1,stream,clip,clipExtent={stream:function(output){if(stream)stream.valid=false;stream=clip(output);stream.valid=true;return stream;},extent:function(_){if(!arguments.length)return[[x0,y0],[x1,y1]];clip=d3_geo_clipExtent(x0=+_[0][0],y0=+_[0][1],x1=+_[1][0],y1=+_[1][1]);if(stream)stream.valid=false,stream=null;return clipExtent;}};return clipExtent.extent([[0,0],[960,500]]);};function d3_geo_clipExtent(x0,y0,x1,y1){return function(listener){var listener_=listener,bufferListener=d3_geo_clipBufferListener(),clipLine=d3_geom_clipLine(x0,y0,x1,y1),segments,polygon,ring;var clip={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function(){listener=bufferListener;segments=[];polygon=[];clean=true;},polygonEnd:function(){listener=listener_;segments=d3.merge(segments);var clipStartInside=insidePolygon([x0,y1]),inside=clean&&clipStartInside,visible=segments.length;if(inside||visible){listener.polygonStart();if(inside){listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();}
if(visible){d3_geo_clipPolygon(segments,compare,clipStartInside,interpolate,listener);}
listener.polygonEnd();}
segments=polygon=ring=null;}};function insidePolygon(p){var wn=0,n=polygon.length,y=p[1];for(var i=0;i<n;++i){for(var j=1,v=polygon[i],m=v.length,a=v[0],b;j<m;++j){b=v[j];if(a[1]<=y){if(b[1]>y&&d3_cross2d(a,b,p)>0)++wn;}else{if(b[1]<=y&&d3_cross2d(a,b,p)<0)--wn;}
a=b;}}
return wn!==0;}
function interpolate(from,to,direction,listener){var a=0,a1=0;if(from==null||(a=corner(from,direction))!==(a1=corner(to,direction))||comparePoints(from,to)<0^direction>0){do{listener.point(a===0||a===3?x0:x1,a>1?y1:y0);}while((a=(a+direction+4)%4)!==a1);}else{listener.point(to[0],to[1]);}}
function pointVisible(x,y){return x0<=x&&x<=x1&&y0<=y&&y<=y1;}
function point(x,y){if(pointVisible(x,y))listener.point(x,y);}
var x__,y__,v__,x_,y_,v_,first,clean;function lineStart(){clip.point=linePoint;if(polygon)polygon.push(ring=[]);first=true;v_=false;x_=y_=NaN;}
function lineEnd(){if(segments){linePoint(x__,y__);if(v__&&v_)bufferListener.rejoin();segments.push(bufferListener.buffer());}
clip.point=point;if(v_)listener.lineEnd();}
function linePoint(x,y){x=Math.max(-d3_geo_clipExtentMAX,Math.min(d3_geo_clipExtentMAX,x));y=Math.max(-d3_geo_clipExtentMAX,Math.min(d3_geo_clipExtentMAX,y));var v=pointVisible(x,y);if(polygon)ring.push([x,y]);if(first){x__=x,y__=y,v__=v;first=false;if(v){listener.lineStart();listener.point(x,y);}}else{if(v&&v_)listener.point(x,y);else{var l={a:{x:x_,y:y_},b:{x:x,y:y}};if(clipLine(l)){if(!v_){listener.lineStart();listener.point(l.a.x,l.a.y);}
listener.point(l.b.x,l.b.y);if(!v)listener.lineEnd();clean=false;}else if(v){listener.lineStart();listener.point(x,y);clean=false;}}}
x_=x,y_=y,v_=v;}
return clip;};function corner(p,direction){return abs(p[0]-x0)<ε?direction>0?0:3:abs(p[0]-x1)<ε?direction>0?2:1:abs(p[1]-y0)<ε?direction>0?1:0:direction>0?3:2;}
function compare(a,b){return comparePoints(a.x,b.x);}
function comparePoints(a,b){var ca=corner(a,1),cb=corner(b,1);return ca!==cb?ca-cb:ca===0?b[1]-a[1]:ca===1?a[0]-b[0]:ca===2?a[1]-b[1]:b[0]-a[0];}}
function d3_geo_compose(a,b){function compose(x,y){return x=a(x,y),b(x[0],x[1]);}
if(a.invert&&b.invert)compose.invert=function(x,y){return x=b.invert(x,y),x&&a.invert(x[0],x[1]);};return compose;}
function d3_geo_conic(projectAt){var φ0=0,φ1=π/3,m=d3_geo_projectionMutator(projectAt),p=m(φ0,φ1);p.parallels=function(_){if(!arguments.length)return[φ0/π*180,φ1/π*180];return m(φ0=_[0]*π/180,φ1=_[1]*π/180);};return p;}
function d3_geo_conicEqualArea(φ0,φ1){var sinφ0=Math.sin(φ0),n=(sinφ0+Math.sin(φ1))/2,C=1+sinφ0*(2*n-sinφ0),ρ0=Math.sqrt(C)/n;function forward(λ,φ){var ρ=Math.sqrt(C-2*n*Math.sin(φ))/n;return[ρ*Math.sin(λ*=n),ρ0-ρ*Math.cos(λ)];}
forward.invert=function(x,y){var ρ0_y=ρ0-y;return[Math.atan2(x,ρ0_y)/n,d3_asin((C-(x*x+ρ0_y*ρ0_y)*n*n)/(2*n))];};return forward;}
(d3.geo.conicEqualArea=function(){return d3_geo_conic(d3_geo_conicEqualArea);}).raw=d3_geo_conicEqualArea;d3.geo.albers=function(){return d3.geo.conicEqualArea().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(1070);};d3.geo.albersUsa=function(){var lower48=d3.geo.albers();var alaska=d3.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]);var hawaii=d3.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]);var point,pointStream={point:function(x,y){point=[x,y];}},lower48Point,alaskaPoint,hawaiiPoint;function albersUsa(coordinates){var x=coordinates[0],y=coordinates[1];point=null;(lower48Point(x,y),point)||(alaskaPoint(x,y),point)||hawaiiPoint(x,y);return point;}
albersUsa.invert=function(coordinates){var k=lower48.scale(),t=lower48.translate(),x=(coordinates[0]-t[0])/k,y=(coordinates[1]-t[1])/k;return(y>=.12&&y<.234&&x>=-.425&&x<-.214?alaska:y>=.166&&y<.234&&x>=-.214&&x<-.115?hawaii:lower48).invert(coordinates);};albersUsa.stream=function(stream){var lower48Stream=lower48.stream(stream),alaskaStream=alaska.stream(stream),hawaiiStream=hawaii.stream(stream);return{point:function(x,y){lower48Stream.point(x,y);alaskaStream.point(x,y);hawaiiStream.point(x,y);},sphere:function(){lower48Stream.sphere();alaskaStream.sphere();hawaiiStream.sphere();},lineStart:function(){lower48Stream.lineStart();alaskaStream.lineStart();hawaiiStream.lineStart();},lineEnd:function(){lower48Stream.lineEnd();alaskaStream.lineEnd();hawaiiStream.lineEnd();},polygonStart:function(){lower48Stream.polygonStart();alaskaStream.polygonStart();hawaiiStream.polygonStart();},polygonEnd:function(){lower48Stream.polygonEnd();alaskaStream.polygonEnd();hawaiiStream.polygonEnd();}};};albersUsa.precision=function(_){if(!arguments.length)return lower48.precision();lower48.precision(_);alaska.precision(_);hawaii.precision(_);return albersUsa;};albersUsa.scale=function(_){if(!arguments.length)return lower48.scale();lower48.scale(_);alaska.scale(_*.35);hawaii.scale(_);return albersUsa.translate(lower48.translate());};albersUsa.translate=function(_){if(!arguments.length)return lower48.translate();var k=lower48.scale(),x=+_[0],y=+_[1];lower48Point=lower48.translate(_).clipExtent([[x-.455*k,y-.238*k],[x+.455*k,y+.238*k]]).stream(pointStream).point;alaskaPoint=alaska.translate([x-.307*k,y+.201*k]).clipExtent([[x-.425*k+ε,y+.12*k+ε],[x-.214*k-ε,y+.234*k-ε]]).stream(pointStream).point;hawaiiPoint=hawaii.translate([x-.205*k,y+.212*k]).clipExtent([[x-.214*k+ε,y+.166*k+ε],[x-.115*k-ε,y+.234*k-ε]]).stream(pointStream).point;return albersUsa;};return albersUsa.scale(1070);};var d3_geo_pathAreaSum,d3_geo_pathAreaPolygon,d3_geo_pathArea={point:d3_noop,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:function(){d3_geo_pathAreaPolygon=0;d3_geo_pathArea.lineStart=d3_geo_pathAreaRingStart;},polygonEnd:function(){d3_geo_pathArea.lineStart=d3_geo_pathArea.lineEnd=d3_geo_pathArea.point=d3_noop;d3_geo_pathAreaSum+=abs(d3_geo_pathAreaPolygon/2);}};function d3_geo_pathAreaRingStart(){var x00,y00,x0,y0;d3_geo_pathArea.point=function(x,y){d3_geo_pathArea.point=nextPoint;x00=x0=x,y00=y0=y;};function nextPoint(x,y){d3_geo_pathAreaPolygon+=y0*x-x0*y;x0=x,y0=y;}
d3_geo_pathArea.lineEnd=function(){nextPoint(x00,y00);};}
var d3_geo_pathBoundsX0,d3_geo_pathBoundsY0,d3_geo_pathBoundsX1,d3_geo_pathBoundsY1;var d3_geo_pathBounds={point:d3_geo_pathBoundsPoint,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:d3_noop,polygonEnd:d3_noop};function d3_geo_pathBoundsPoint(x,y){if(x<d3_geo_pathBoundsX0)d3_geo_pathBoundsX0=x;if(x>d3_geo_pathBoundsX1)d3_geo_pathBoundsX1=x;if(y<d3_geo_pathBoundsY0)d3_geo_pathBoundsY0=y;if(y>d3_geo_pathBoundsY1)d3_geo_pathBoundsY1=y;}
function d3_geo_pathBuffer(){var pointCircle=d3_geo_pathBufferCircle(4.5),buffer=[];var stream={point:point,lineStart:function(){stream.point=pointLineStart;},lineEnd:lineEnd,polygonStart:function(){stream.lineEnd=lineEndPolygon;},polygonEnd:function(){stream.lineEnd=lineEnd;stream.point=point;},pointRadius:function(_){pointCircle=d3_geo_pathBufferCircle(_);return stream;},result:function(){if(buffer.length){var result=buffer.join("");buffer=[];return result;}}};function point(x,y){buffer.push("M",x,",",y,pointCircle);}
function pointLineStart(x,y){buffer.push("M",x,",",y);stream.point=pointLine;}
function pointLine(x,y){buffer.push("L",x,",",y);}
function lineEnd(){stream.point=point;}
function lineEndPolygon(){buffer.push("Z");}
return stream;}
function d3_geo_pathBufferCircle(radius){return"m0,"+radius+"a"+radius+","+radius+" 0 1,1 0,"+-2*radius+"a"+radius+","+radius+" 0 1,1 0,"+2*radius+"z";}
var d3_geo_pathCentroid={point:d3_geo_pathCentroidPoint,lineStart:d3_geo_pathCentroidLineStart,lineEnd:d3_geo_pathCentroidLineEnd,polygonStart:function(){d3_geo_pathCentroid.lineStart=d3_geo_pathCentroidRingStart;},polygonEnd:function(){d3_geo_pathCentroid.point=d3_geo_pathCentroidPoint;d3_geo_pathCentroid.lineStart=d3_geo_pathCentroidLineStart;d3_geo_pathCentroid.lineEnd=d3_geo_pathCentroidLineEnd;}};function d3_geo_pathCentroidPoint(x,y){d3_geo_centroidX0+=x;d3_geo_centroidY0+=y;++d3_geo_centroidZ0;}
function d3_geo_pathCentroidLineStart(){var x0,y0;d3_geo_pathCentroid.point=function(x,y){d3_geo_pathCentroid.point=nextPoint;d3_geo_pathCentroidPoint(x0=x,y0=y);};function nextPoint(x,y){var dx=x-x0,dy=y-y0,z=Math.sqrt(dx*dx+dy*dy);d3_geo_centroidX1+=z*(x0+x)/2;d3_geo_centroidY1+=z*(y0+y)/2;d3_geo_centroidZ1+=z;d3_geo_pathCentroidPoint(x0=x,y0=y);}}
function d3_geo_pathCentroidLineEnd(){d3_geo_pathCentroid.point=d3_geo_pathCentroidPoint;}
function d3_geo_pathCentroidRingStart(){var x00,y00,x0,y0;d3_geo_pathCentroid.point=function(x,y){d3_geo_pathCentroid.point=nextPoint;d3_geo_pathCentroidPoint(x00=x0=x,y00=y0=y);};function nextPoint(x,y){var dx=x-x0,dy=y-y0,z=Math.sqrt(dx*dx+dy*dy);d3_geo_centroidX1+=z*(x0+x)/2;d3_geo_centroidY1+=z*(y0+y)/2;d3_geo_centroidZ1+=z;z=y0*x-x0*y;d3_geo_centroidX2+=z*(x0+x);d3_geo_centroidY2+=z*(y0+y);d3_geo_centroidZ2+=z*3;d3_geo_pathCentroidPoint(x0=x,y0=y);}
d3_geo_pathCentroid.lineEnd=function(){nextPoint(x00,y00);};}
function d3_geo_pathContext(context){var pointRadius=4.5;var stream={point:point,lineStart:function(){stream.point=pointLineStart;},lineEnd:lineEnd,polygonStart:function(){stream.lineEnd=lineEndPolygon;},polygonEnd:function(){stream.lineEnd=lineEnd;stream.point=point;},pointRadius:function(_){pointRadius=_;return stream;},result:d3_noop};function point(x,y){context.moveTo(x,y);context.arc(x,y,pointRadius,0,τ);}
function pointLineStart(x,y){context.moveTo(x,y);stream.point=pointLine;}
function pointLine(x,y){context.lineTo(x,y);}
function lineEnd(){stream.point=point;}
function lineEndPolygon(){context.closePath();}
return stream;}
function d3_geo_resample(project){var δ2=.5,cosMinDistance=Math.cos(30*d3_radians),maxDepth=16;function resample(stream){return(maxDepth?resampleRecursive:resampleNone)(stream);}
function resampleNone(stream){return d3_geo_transformPoint(stream,function(x,y){x=project(x,y);stream.point(x[0],x[1]);});}
function resampleRecursive(stream){var λ00,φ00,x00,y00,a00,b00,c00,λ0,x0,y0,a0,b0,c0;var resample={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function(){stream.polygonStart();resample.lineStart=ringStart;},polygonEnd:function(){stream.polygonEnd();resample.lineStart=lineStart;}};function point(x,y){x=project(x,y);stream.point(x[0],x[1]);}
function lineStart(){x0=NaN;resample.point=linePoint;stream.lineStart();}
function linePoint(λ,φ){var c=d3_geo_cartesian([λ,φ]),p=project(λ,φ);resampleLineTo(x0,y0,λ0,a0,b0,c0,x0=p[0],y0=p[1],λ0=λ,a0=c[0],b0=c[1],c0=c[2],maxDepth,stream);stream.point(x0,y0);}
function lineEnd(){resample.point=point;stream.lineEnd();}
function ringStart(){lineStart();resample.point=ringPoint;resample.lineEnd=ringEnd;}
function ringPoint(λ,φ){linePoint(λ00=λ,φ00=φ),x00=x0,y00=y0,a00=a0,b00=b0,c00=c0;resample.point=linePoint;}
function ringEnd(){resampleLineTo(x0,y0,λ0,a0,b0,c0,x00,y00,λ00,a00,b00,c00,maxDepth,stream);resample.lineEnd=lineEnd;lineEnd();}
return resample;}
function resampleLineTo(x0,y0,λ0,a0,b0,c0,x1,y1,λ1,a1,b1,c1,depth,stream){var dx=x1-x0,dy=y1-y0,d2=dx*dx+dy*dy;if(d2>4*δ2&&depth--){var a=a0+a1,b=b0+b1,c=c0+c1,m=Math.sqrt(a*a+b*b+c*c),φ2=Math.asin(c/=m),λ2=abs(abs(c)-1)<ε||abs(λ0-λ1)<ε?(λ0+λ1)/2:Math.atan2(b,a),p=project(λ2,φ2),x2=p[0],y2=p[1],dx2=x2-x0,dy2=y2-y0,dz=dy*dx2-dx*dy2;if(dz*dz/d2>δ2||abs((dx*dx2+dy*dy2)/d2-.5)>.3||a0*a1+b0*b1+c0*c1<cosMinDistance){resampleLineTo(x0,y0,λ0,a0,b0,c0,x2,y2,λ2,a/=m,b/=m,c,depth,stream);stream.point(x2,y2);resampleLineTo(x2,y2,λ2,a,b,c,x1,y1,λ1,a1,b1,c1,depth,stream);}}}
resample.precision=function(_){if(!arguments.length)return Math.sqrt(δ2);maxDepth=(δ2=_*_)>0&&16;return resample;};return resample;}
d3.geo.path=function(){var pointRadius=4.5,projection,context,projectStream,contextStream,cacheStream;function path(object){if(object){if(typeof pointRadius==="function")contextStream.pointRadius(+pointRadius.apply(this,arguments));if(!cacheStream||!cacheStream.valid)cacheStream=projectStream(contextStream);d3.geo.stream(object,cacheStream);}
return contextStream.result();}
path.area=function(object){d3_geo_pathAreaSum=0;d3.geo.stream(object,projectStream(d3_geo_pathArea));return d3_geo_pathAreaSum;};path.centroid=function(object){d3_geo_centroidX0=d3_geo_centroidY0=d3_geo_centroidZ0=d3_geo_centroidX1=d3_geo_centroidY1=d3_geo_centroidZ1=d3_geo_centroidX2=d3_geo_centroidY2=d3_geo_centroidZ2=0;d3.geo.stream(object,projectStream(d3_geo_pathCentroid));return d3_geo_centroidZ2?[d3_geo_centroidX2/d3_geo_centroidZ2,d3_geo_centroidY2/d3_geo_centroidZ2]:d3_geo_centroidZ1?[d3_geo_centroidX1/d3_geo_centroidZ1,d3_geo_centroidY1/d3_geo_centroidZ1]:d3_geo_centroidZ0?[d3_geo_centroidX0/d3_geo_centroidZ0,d3_geo_centroidY0/d3_geo_centroidZ0]:[NaN,NaN];};path.bounds=function(object){d3_geo_pathBoundsX1=d3_geo_pathBoundsY1=-(d3_geo_pathBoundsX0=d3_geo_pathBoundsY0=Infinity);d3.geo.stream(object,projectStream(d3_geo_pathBounds));return[[d3_geo_pathBoundsX0,d3_geo_pathBoundsY0],[d3_geo_pathBoundsX1,d3_geo_pathBoundsY1]];};path.projection=function(_){if(!arguments.length)return projection;projectStream=(projection=_)?_.stream||d3_geo_pathProjectStream(_):d3_identity;return reset();};path.context=function(_){if(!arguments.length)return context;contextStream=(context=_)==null?new d3_geo_pathBuffer():new d3_geo_pathContext(_);if(typeof pointRadius!=="function")contextStream.pointRadius(pointRadius);return reset();};path.pointRadius=function(_){if(!arguments.length)return pointRadius;pointRadius=typeof _==="function"?_:(contextStream.pointRadius(+_),+_);return path;};function reset(){cacheStream=null;return path;}
return path.projection(d3.geo.albersUsa()).context(null);};function d3_geo_pathProjectStream(project){var resample=d3_geo_resample(function(x,y){return project([x*d3_degrees,y*d3_degrees]);});return function(stream){return d3_geo_projectionRadians(resample(stream));};}
d3.geo.transform=function(methods){return{stream:function(stream){var transform=new d3_geo_transform(stream);for(var k in methods)transform[k]=methods[k];return transform;}};};function d3_geo_transform(stream){this.stream=stream;}
d3_geo_transform.prototype={point:function(x,y){this.stream.point(x,y);},sphere:function(){this.stream.sphere();},lineStart:function(){this.stream.lineStart();},lineEnd:function(){this.stream.lineEnd();},polygonStart:function(){this.stream.polygonStart();},polygonEnd:function(){this.stream.polygonEnd();}};function d3_geo_transformPoint(stream,point){return{point:point,sphere:function(){stream.sphere();},lineStart:function(){stream.lineStart();},lineEnd:function(){stream.lineEnd();},polygonStart:function(){stream.polygonStart();},polygonEnd:function(){stream.polygonEnd();}};}
d3.geo.projection=d3_geo_projection;d3.geo.projectionMutator=d3_geo_projectionMutator;function d3_geo_projection(project){return d3_geo_projectionMutator(function(){return project;})();}
function d3_geo_projectionMutator(projectAt){var project,rotate,projectRotate,projectResample=d3_geo_resample(function(x,y){x=project(x,y);return[x[0]*k+δx,δy-x[1]*k];}),k=150,x=480,y=250,λ=0,φ=0,δλ=0,δφ=0,δγ=0,δx,δy,preclip=d3_geo_clipAntimeridian,postclip=d3_identity,clipAngle=null,clipExtent=null,stream;function projection(point){point=projectRotate(point[0]*d3_radians,point[1]*d3_radians);return[point[0]*k+δx,δy-point[1]*k];}
function invert(point){point=projectRotate.invert((point[0]-δx)/k,(δy-point[1])/k);return point&&[point[0]*d3_degrees,point[1]*d3_degrees];}
projection.stream=function(output){if(stream)stream.valid=false;stream=d3_geo_projectionRadians(preclip(rotate,projectResample(postclip(output))));stream.valid=true;return stream;};projection.clipAngle=function(_){if(!arguments.length)return clipAngle;preclip=_==null?(clipAngle=_,d3_geo_clipAntimeridian):d3_geo_clipCircle((clipAngle=+_)*d3_radians);return invalidate();};projection.clipExtent=function(_){if(!arguments.length)return clipExtent;clipExtent=_;postclip=_?d3_geo_clipExtent(_[0][0],_[0][1],_[1][0],_[1][1]):d3_identity;return invalidate();};projection.scale=function(_){if(!arguments.length)return k;k=+_;return reset();};projection.translate=function(_){if(!arguments.length)return[x,y];x=+_[0];y=+_[1];return reset();};projection.center=function(_){if(!arguments.length)return[λ*d3_degrees,φ*d3_degrees];λ=_[0]%360*d3_radians;φ=_[1]%360*d3_radians;return reset();};projection.rotate=function(_){if(!arguments.length)return[δλ*d3_degrees,δφ*d3_degrees,δγ*d3_degrees];δλ=_[0]%360*d3_radians;δφ=_[1]%360*d3_radians;δγ=_.length>2?_[2]%360*d3_radians:0;return reset();};d3.rebind(projection,projectResample,"precision");function reset(){projectRotate=d3_geo_compose(rotate=d3_geo_rotation(δλ,δφ,δγ),project);var center=project(λ,φ);δx=x-center[0]*k;δy=y+center[1]*k;return invalidate();}
function invalidate(){if(stream)stream.valid=false,stream=null;return projection;}
return function(){project=projectAt.apply(this,arguments);projection.invert=project.invert&&invert;return reset();};}
function d3_geo_projectionRadians(stream){return d3_geo_transformPoint(stream,function(x,y){stream.point(x*d3_radians,y*d3_radians);});}
function d3_geo_equirectangular(λ,φ){return[λ,φ];}
(d3.geo.equirectangular=function(){return d3_geo_projection(d3_geo_equirectangular);}).raw=d3_geo_equirectangular.invert=d3_geo_equirectangular;d3.geo.rotation=function(rotate){rotate=d3_geo_rotation(rotate[0]%360*d3_radians,rotate[1]*d3_radians,rotate.length>2?rotate[2]*d3_radians:0);function forward(coordinates){coordinates=rotate(coordinates[0]*d3_radians,coordinates[1]*d3_radians);return coordinates[0]*=d3_degrees,coordinates[1]*=d3_degrees,coordinates;}
forward.invert=function(coordinates){coordinates=rotate.invert(coordinates[0]*d3_radians,coordinates[1]*d3_radians);return coordinates[0]*=d3_degrees,coordinates[1]*=d3_degrees,coordinates;};return forward;};function d3_geo_identityRotation(λ,φ){return[λ>π?λ-τ:λ<-π?λ+τ:λ,φ];}
d3_geo_identityRotation.invert=d3_geo_equirectangular;function d3_geo_rotation(δλ,δφ,δγ){return δλ?δφ||δγ?d3_geo_compose(d3_geo_rotationλ(δλ),d3_geo_rotationφγ(δφ,δγ)):d3_geo_rotationλ(δλ):δφ||δγ?d3_geo_rotationφγ(δφ,δγ):d3_geo_identityRotation;}
function d3_geo_forwardRotationλ(δλ){return function(λ,φ){return λ+=δλ,[λ>π?λ-τ:λ<-π?λ+τ:λ,φ];};}
function d3_geo_rotationλ(δλ){var rotation=d3_geo_forwardRotationλ(δλ);rotation.invert=d3_geo_forwardRotationλ(-δλ);return rotation;}
function d3_geo_rotationφγ(δφ,δγ){var cosδφ=Math.cos(δφ),sinδφ=Math.sin(δφ),cosδγ=Math.cos(δγ),sinδγ=Math.sin(δγ);function rotation(λ,φ){var cosφ=Math.cos(φ),x=Math.cos(λ)*cosφ,y=Math.sin(λ)*cosφ,z=Math.sin(φ),k=z*cosδφ+x*sinδφ;return[Math.atan2(y*cosδγ-k*sinδγ,x*cosδφ-z*sinδφ),d3_asin(k*cosδγ+y*sinδγ)];}
rotation.invert=function(λ,φ){var cosφ=Math.cos(φ),x=Math.cos(λ)*cosφ,y=Math.sin(λ)*cosφ,z=Math.sin(φ),k=z*cosδγ-y*sinδγ;return[Math.atan2(y*cosδγ+z*sinδγ,x*cosδφ+k*sinδφ),d3_asin(k*cosδφ-x*sinδφ)];};return rotation;}
d3.geo.circle=function(){var origin=[0,0],angle,precision=6,interpolate;function circle(){var center=typeof origin==="function"?origin.apply(this,arguments):origin,rotate=d3_geo_rotation(-center[0]*d3_radians,-center[1]*d3_radians,0).invert,ring=[];interpolate(null,null,1,{point:function(x,y){ring.push(x=rotate(x,y));x[0]*=d3_degrees,x[1]*=d3_degrees;}});return{type:"Polygon",coordinates:[ring]};}
circle.origin=function(x){if(!arguments.length)return origin;origin=x;return circle;};circle.angle=function(x){if(!arguments.length)return angle;interpolate=d3_geo_circleInterpolate((angle=+x)*d3_radians,precision*d3_radians);return circle;};circle.precision=function(_){if(!arguments.length)return precision;interpolate=d3_geo_circleInterpolate(angle*d3_radians,(precision=+_)*d3_radians);return circle;};return circle.angle(90);};function d3_geo_circleInterpolate(radius,precision){var cr=Math.cos(radius),sr=Math.sin(radius);return function(from,to,direction,listener){var step=direction*precision;if(from!=null){from=d3_geo_circleAngle(cr,from);to=d3_geo_circleAngle(cr,to);if(direction>0?from<to:from>to)from+=direction*τ;}else{from=radius+direction*τ;to=radius-.5*step;}
for(var point,t=from;direction>0?t>to:t<to;t-=step){listener.point((point=d3_geo_spherical([cr,-sr*Math.cos(t),-sr*Math.sin(t)]))[0],point[1]);}};}
function d3_geo_circleAngle(cr,point){var a=d3_geo_cartesian(point);a[0]-=cr;d3_geo_cartesianNormalize(a);var angle=d3_acos(-a[1]);return((-a[2]<0?-angle:angle)+2*Math.PI-ε)%(2*Math.PI);}
d3.geo.distance=function(a,b){var Δλ=(b[0]-a[0])*d3_radians,φ0=a[1]*d3_radians,φ1=b[1]*d3_radians,sinΔλ=Math.sin(Δλ),cosΔλ=Math.cos(Δλ),sinφ0=Math.sin(φ0),cosφ0=Math.cos(φ0),sinφ1=Math.sin(φ1),cosφ1=Math.cos(φ1),t;return Math.atan2(Math.sqrt((t=cosφ1*sinΔλ)*t+(t=cosφ0*sinφ1-sinφ0*cosφ1*cosΔλ)*t),sinφ0*sinφ1+cosφ0*cosφ1*cosΔλ);};d3.geo.graticule=function(){var x1,x0,X1,X0,y1,y0,Y1,Y0,dx=10,dy=dx,DX=90,DY=360,x,y,X,Y,precision=2.5;function graticule(){return{type:"MultiLineString",coordinates:lines()};}
function lines(){return d3.range(Math.ceil(X0/DX)*DX,X1,DX).map(X).concat(d3.range(Math.ceil(Y0/DY)*DY,Y1,DY).map(Y)).concat(d3.range(Math.ceil(x0/dx)*dx,x1,dx).filter(function(x){return abs(x%DX)>ε;}).map(x)).concat(d3.range(Math.ceil(y0/dy)*dy,y1,dy).filter(function(y){return abs(y%DY)>ε;}).map(y));}
graticule.lines=function(){return lines().map(function(coordinates){return{type:"LineString",coordinates:coordinates};});};graticule.outline=function(){return{type:"Polygon",coordinates:[X(X0).concat(Y(Y1).slice(1),X(X1).reverse().slice(1),Y(Y0).reverse().slice(1))]};};graticule.extent=function(_){if(!arguments.length)return graticule.minorExtent();return graticule.majorExtent(_).minorExtent(_);};graticule.majorExtent=function(_){if(!arguments.length)return[[X0,Y0],[X1,Y1]];X0=+_[0][0],X1=+_[1][0];Y0=+_[0][1],Y1=+_[1][1];if(X0>X1)_=X0,X0=X1,X1=_;if(Y0>Y1)_=Y0,Y0=Y1,Y1=_;return graticule.precision(precision);};graticule.minorExtent=function(_){if(!arguments.length)return[[x0,y0],[x1,y1]];x0=+_[0][0],x1=+_[1][0];y0=+_[0][1],y1=+_[1][1];if(x0>x1)_=x0,x0=x1,x1=_;if(y0>y1)_=y0,y0=y1,y1=_;return graticule.precision(precision);};graticule.step=function(_){if(!arguments.length)return graticule.minorStep();return graticule.majorStep(_).minorStep(_);};graticule.majorStep=function(_){if(!arguments.length)return[DX,DY];DX=+_[0],DY=+_[1];return graticule;};graticule.minorStep=function(_){if(!arguments.length)return[dx,dy];dx=+_[0],dy=+_[1];return graticule;};graticule.precision=function(_){if(!arguments.length)return precision;precision=+_;x=d3_geo_graticuleX(y0,y1,90);y=d3_geo_graticuleY(x0,x1,precision);X=d3_geo_graticuleX(Y0,Y1,90);Y=d3_geo_graticuleY(X0,X1,precision);return graticule;};return graticule.majorExtent([[-180,-90+ε],[180,90-ε]]).minorExtent([[-180,-80-ε],[180,80+ε]]);};function d3_geo_graticuleX(y0,y1,dy){var y=d3.range(y0,y1-ε,dy).concat(y1);return function(x){return y.map(function(y){return[x,y];});};}
function d3_geo_graticuleY(x0,x1,dx){var x=d3.range(x0,x1-ε,dx).concat(x1);return function(y){return x.map(function(x){return[x,y];});};}
function d3_source(d){return d.source;}
function d3_target(d){return d.target;}
d3.geo.greatArc=function(){var source=d3_source,source_,target=d3_target,target_;function greatArc(){return{type:"LineString",coordinates:[source_||source.apply(this,arguments),target_||target.apply(this,arguments)]};}
greatArc.distance=function(){return d3.geo.distance(source_||source.apply(this,arguments),target_||target.apply(this,arguments));};greatArc.source=function(_){if(!arguments.length)return source;source=_,source_=typeof _==="function"?null:_;return greatArc;};greatArc.target=function(_){if(!arguments.length)return target;target=_,target_=typeof _==="function"?null:_;return greatArc;};greatArc.precision=function(){return arguments.length?greatArc:0;};return greatArc;};d3.geo.interpolate=function(source,target){return d3_geo_interpolate(source[0]*d3_radians,source[1]*d3_radians,target[0]*d3_radians,target[1]*d3_radians);};function d3_geo_interpolate(x0,y0,x1,y1){var cy0=Math.cos(y0),sy0=Math.sin(y0),cy1=Math.cos(y1),sy1=Math.sin(y1),kx0=cy0*Math.cos(x0),ky0=cy0*Math.sin(x0),kx1=cy1*Math.cos(x1),ky1=cy1*Math.sin(x1),d=2*Math.asin(Math.sqrt(d3_haversin(y1-y0)+cy0*cy1*d3_haversin(x1-x0))),k=1/Math.sin(d);var interpolate=d?function(t){var B=Math.sin(t*=d)*k,A=Math.sin(d-t)*k,x=A*kx0+B*kx1,y=A*ky0+B*ky1,z=A*sy0+B*sy1;return[Math.atan2(y,x)*d3_degrees,Math.atan2(z,Math.sqrt(x*x+y*y))*d3_degrees];}:function(){return[x0*d3_degrees,y0*d3_degrees];};interpolate.distance=d;return interpolate;}
d3.geo.length=function(object){d3_geo_lengthSum=0;d3.geo.stream(object,d3_geo_length);return d3_geo_lengthSum;};var d3_geo_lengthSum;var d3_geo_length={sphere:d3_noop,point:d3_noop,lineStart:d3_geo_lengthLineStart,lineEnd:d3_noop,polygonStart:d3_noop,polygonEnd:d3_noop};function d3_geo_lengthLineStart(){var λ0,sinφ0,cosφ0;d3_geo_length.point=function(λ,φ){λ0=λ*d3_radians,sinφ0=Math.sin(φ*=d3_radians),cosφ0=Math.cos(φ);d3_geo_length.point=nextPoint;};d3_geo_length.lineEnd=function(){d3_geo_length.point=d3_geo_length.lineEnd=d3_noop;};function nextPoint(λ,φ){var sinφ=Math.sin(φ*=d3_radians),cosφ=Math.cos(φ),t=abs((λ*=d3_radians)-λ0),cosΔλ=Math.cos(t);d3_geo_lengthSum+=Math.atan2(Math.sqrt((t=cosφ*Math.sin(t))*t+(t=cosφ0*sinφ-sinφ0*cosφ*cosΔλ)*t),sinφ0*sinφ+cosφ0*cosφ*cosΔλ);λ0=λ,sinφ0=sinφ,cosφ0=cosφ;}}
function d3_geo_azimuthal(scale,angle){function azimuthal(λ,φ){var cosλ=Math.cos(λ),cosφ=Math.cos(φ),k=scale(cosλ*cosφ);return[k*cosφ*Math.sin(λ),k*Math.sin(φ)];}
azimuthal.invert=function(x,y){var ρ=Math.sqrt(x*x+y*y),c=angle(ρ),sinc=Math.sin(c),cosc=Math.cos(c);return[Math.atan2(x*sinc,ρ*cosc),Math.asin(ρ&&y*sinc/ρ)];};return azimuthal;}
var d3_geo_azimuthalEqualArea=d3_geo_azimuthal(function(cosλcosφ){return Math.sqrt(2/(1+cosλcosφ));},function(ρ){return 2*Math.asin(ρ/2);});(d3.geo.azimuthalEqualArea=function(){return d3_geo_projection(d3_geo_azimuthalEqualArea);}).raw=d3_geo_azimuthalEqualArea;var d3_geo_azimuthalEquidistant=d3_geo_azimuthal(function(cosλcosφ){var c=Math.acos(cosλcosφ);return c&&c/Math.sin(c);},d3_identity);(d3.geo.azimuthalEquidistant=function(){return d3_geo_projection(d3_geo_azimuthalEquidistant);}).raw=d3_geo_azimuthalEquidistant;function d3_geo_conicConformal(φ0,φ1){var cosφ0=Math.cos(φ0),t=function(φ){return Math.tan(π/4+φ/2);},n=φ0===φ1?Math.sin(φ0):Math.log(cosφ0/Math.cos(φ1))/Math.log(t(φ1)/t(φ0)),F=cosφ0*Math.pow(t(φ0),n)/n;if(!n)return d3_geo_mercator;function forward(λ,φ){if(F>0){if(φ<-halfπ+ε)φ=-halfπ+ε;}else{if(φ>halfπ-ε)φ=halfπ-ε;}
var ρ=F/Math.pow(t(φ),n);return[ρ*Math.sin(n*λ),F-ρ*Math.cos(n*λ)];}
forward.invert=function(x,y){var ρ0_y=F-y,ρ=d3_sgn(n)*Math.sqrt(x*x+ρ0_y*ρ0_y);return[Math.atan2(x,ρ0_y)/n,2*Math.atan(Math.pow(F/ρ,1/n))-halfπ];};return forward;}
(d3.geo.conicConformal=function(){return d3_geo_conic(d3_geo_conicConformal);}).raw=d3_geo_conicConformal;function d3_geo_conicEquidistant(φ0,φ1){var cosφ0=Math.cos(φ0),n=φ0===φ1?Math.sin(φ0):(cosφ0-Math.cos(φ1))/(φ1-φ0),G=cosφ0/n+φ0;if(abs(n)<ε)return d3_geo_equirectangular;function forward(λ,φ){var ρ=G-φ;return[ρ*Math.sin(n*λ),G-ρ*Math.cos(n*λ)];}
forward.invert=function(x,y){var ρ0_y=G-y;return[Math.atan2(x,ρ0_y)/n,G-d3_sgn(n)*Math.sqrt(x*x+ρ0_y*ρ0_y)];};return forward;}
(d3.geo.conicEquidistant=function(){return d3_geo_conic(d3_geo_conicEquidistant);}).raw=d3_geo_conicEquidistant;var d3_geo_gnomonic=d3_geo_azimuthal(function(cosλcosφ){return 1/cosλcosφ;},Math.atan);(d3.geo.gnomonic=function(){return d3_geo_projection(d3_geo_gnomonic);}).raw=d3_geo_gnomonic;function d3_geo_mercator(λ,φ){return[λ,Math.log(Math.tan(π/4+φ/2))];}
d3_geo_mercator.invert=function(x,y){return[x,2*Math.atan(Math.exp(y))-halfπ];};function d3_geo_mercatorProjection(project){var m=d3_geo_projection(project),scale=m.scale,translate=m.translate,clipExtent=m.clipExtent,clipAuto;m.scale=function(){var v=scale.apply(m,arguments);return v===m?clipAuto?m.clipExtent(null):m:v;};m.translate=function(){var v=translate.apply(m,arguments);return v===m?clipAuto?m.clipExtent(null):m:v;};m.clipExtent=function(_){var v=clipExtent.apply(m,arguments);if(v===m){if(clipAuto=_==null){var k=π*scale(),t=translate();clipExtent([[t[0]-k,t[1]-k],[t[0]+k,t[1]+k]]);}}else if(clipAuto){v=null;}
return v;};return m.clipExtent(null);}
(d3.geo.mercator=function(){return d3_geo_mercatorProjection(d3_geo_mercator);}).raw=d3_geo_mercator;var d3_geo_orthographic=d3_geo_azimuthal(function(){return 1;},Math.asin);(d3.geo.orthographic=function(){return d3_geo_projection(d3_geo_orthographic);}).raw=d3_geo_orthographic;var d3_geo_stereographic=d3_geo_azimuthal(function(cosλcosφ){return 1/(1+cosλcosφ);},function(ρ){return 2*Math.atan(ρ);});(d3.geo.stereographic=function(){return d3_geo_projection(d3_geo_stereographic);}).raw=d3_geo_stereographic;function d3_geo_transverseMercator(λ,φ){return[Math.log(Math.tan(π/4+φ/2)),-λ];}
d3_geo_transverseMercator.invert=function(x,y){return[-y,2*Math.atan(Math.exp(x))-halfπ];};(d3.geo.transverseMercator=function(){var projection=d3_geo_mercatorProjection(d3_geo_transverseMercator),center=projection.center,rotate=projection.rotate;projection.center=function(_){return _?center([-_[1],_[0]]):(_=center(),[-_[1],_[0]]);};projection.rotate=function(_){return _?rotate([_[0],_[1],_.length>2?_[2]+90:90]):(_=rotate(),[_[0],_[1],_[2]-90]);};return projection.rotate([0,0]);}).raw=d3_geo_transverseMercator;d3.geom={};function d3_geom_pointX(d){return d[0];}
function d3_geom_pointY(d){return d[1];}
d3.geom.hull=function(vertices){var x=d3_geom_pointX,y=d3_geom_pointY;if(arguments.length)return hull(vertices);function hull(data){if(data.length<3)return[];var fx=d3_functor(x),fy=d3_functor(y),i,n=data.length,points=[],flippedPoints=[];for(i=0;i<n;i++){points.push([+fx.call(this,data[i],i),+fy.call(this,data[i],i),i]);}
points.sort(d3_geom_hullOrder);for(i=0;i<n;i++)flippedPoints.push([points[i][0],-points[i][1]]);var upper=d3_geom_hullUpper(points),lower=d3_geom_hullUpper(flippedPoints);var skipLeft=lower[0]===upper[0],skipRight=lower[lower.length-1]===upper[upper.length-1],polygon=[];for(i=upper.length-1;i>=0;--i)polygon.push(data[points[upper[i]][2]]);for(i=+skipLeft;i<lower.length-skipRight;++i)polygon.push(data[points[lower[i]][2]]);return polygon;}
hull.x=function(_){return arguments.length?(x=_,hull):x;};hull.y=function(_){return arguments.length?(y=_,hull):y;};return hull;};function d3_geom_hullUpper(points){var n=points.length,hull=[0,1],hs=2;for(var i=2;i<n;i++){while(hs>1&&d3_cross2d(points[hull[hs-2]],points[hull[hs-1]],points[i])<=0)--hs;hull[hs++]=i;}
return hull.slice(0,hs);}
function d3_geom_hullOrder(a,b){return a[0]-b[0]||a[1]-b[1];}
d3.geom.polygon=function(coordinates){d3_subclass(coordinates,d3_geom_polygonPrototype);return coordinates;};var d3_geom_polygonPrototype=d3.geom.polygon.prototype=[];d3_geom_polygonPrototype.area=function(){var i=-1,n=this.length,a,b=this[n-1],area=0;while(++i<n){a=b;b=this[i];area+=a[1]*b[0]-a[0]*b[1];}
return area*.5;};d3_geom_polygonPrototype.centroid=function(k){var i=-1,n=this.length,x=0,y=0,a,b=this[n-1],c;if(!arguments.length)k=-1/(6*this.area());while(++i<n){a=b;b=this[i];c=a[0]*b[1]-b[0]*a[1];x+=(a[0]+b[0])*c;y+=(a[1]+b[1])*c;}
return[x*k,y*k];};d3_geom_polygonPrototype.clip=function(subject){var input,closed=d3_geom_polygonClosed(subject),i=-1,n=this.length-d3_geom_polygonClosed(this),j,m,a=this[n-1],b,c,d;while(++i<n){input=subject.slice();subject.length=0;b=this[i];c=input[(m=input.length-closed)-1];j=-1;while(++j<m){d=input[j];if(d3_geom_polygonInside(d,a,b)){if(!d3_geom_polygonInside(c,a,b)){subject.push(d3_geom_polygonIntersect(c,d,a,b));}
subject.push(d);}else if(d3_geom_polygonInside(c,a,b)){subject.push(d3_geom_polygonIntersect(c,d,a,b));}
c=d;}
if(closed)subject.push(subject[0]);a=b;}
return subject;};function d3_geom_polygonInside(p,a,b){return(b[0]-a[0])*(p[1]-a[1])<(b[1]-a[1])*(p[0]-a[0]);}
function d3_geom_polygonIntersect(c,d,a,b){var x1=c[0],x3=a[0],x21=d[0]-x1,x43=b[0]-x3,y1=c[1],y3=a[1],y21=d[1]-y1,y43=b[1]-y3,ua=(x43*(y1-y3)-y43*(x1-x3))/(y43*x21-x43*y21);return[x1+ua*x21,y1+ua*y21];}
function d3_geom_polygonClosed(coordinates){var a=coordinates[0],b=coordinates[coordinates.length-1];return!(a[0]-b[0]||a[1]-b[1]);}
var d3_geom_voronoiEdges,d3_geom_voronoiCells,d3_geom_voronoiBeaches,d3_geom_voronoiBeachPool=[],d3_geom_voronoiFirstCircle,d3_geom_voronoiCircles,d3_geom_voronoiCirclePool=[];function d3_geom_voronoiBeach(){d3_geom_voronoiRedBlackNode(this);this.edge=this.site=this.circle=null;}
function d3_geom_voronoiCreateBeach(site){var beach=d3_geom_voronoiBeachPool.pop()||new d3_geom_voronoiBeach();beach.site=site;return beach;}
function d3_geom_voronoiDetachBeach(beach){d3_geom_voronoiDetachCircle(beach);d3_geom_voronoiBeaches.remove(beach);d3_geom_voronoiBeachPool.push(beach);d3_geom_voronoiRedBlackNode(beach);}
function d3_geom_voronoiRemoveBeach(beach){var circle=beach.circle,x=circle.x,y=circle.cy,vertex={x:x,y:y},previous=beach.P,next=beach.N,disappearing=[beach];d3_geom_voronoiDetachBeach(beach);var lArc=previous;while(lArc.circle&&abs(x-lArc.circle.x)<ε&&abs(y-lArc.circle.cy)<ε){previous=lArc.P;disappearing.unshift(lArc);d3_geom_voronoiDetachBeach(lArc);lArc=previous;}
disappearing.unshift(lArc);d3_geom_voronoiDetachCircle(lArc);var rArc=next;while(rArc.circle&&abs(x-rArc.circle.x)<ε&&abs(y-rArc.circle.cy)<ε){next=rArc.N;disappearing.push(rArc);d3_geom_voronoiDetachBeach(rArc);rArc=next;}
disappearing.push(rArc);d3_geom_voronoiDetachCircle(rArc);var nArcs=disappearing.length,iArc;for(iArc=1;iArc<nArcs;++iArc){rArc=disappearing[iArc];lArc=disappearing[iArc-1];d3_geom_voronoiSetEdgeEnd(rArc.edge,lArc.site,rArc.site,vertex);}
lArc=disappearing[0];rArc=disappearing[nArcs-1];rArc.edge=d3_geom_voronoiCreateEdge(lArc.site,rArc.site,null,vertex);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);}
function d3_geom_voronoiAddBeach(site){var x=site.x,directrix=site.y,lArc,rArc,dxl,dxr,node=d3_geom_voronoiBeaches._;while(node){dxl=d3_geom_voronoiLeftBreakPoint(node,directrix)-x;if(dxl>ε)node=node.L;else{dxr=x-d3_geom_voronoiRightBreakPoint(node,directrix);if(dxr>ε){if(!node.R){lArc=node;break;}
node=node.R;}else{if(dxl>-ε){lArc=node.P;rArc=node;}else if(dxr>-ε){lArc=node;rArc=node.N;}else{lArc=rArc=node;}
break;}}}
var newArc=d3_geom_voronoiCreateBeach(site);d3_geom_voronoiBeaches.insert(lArc,newArc);if(!lArc&&!rArc)return;if(lArc===rArc){d3_geom_voronoiDetachCircle(lArc);rArc=d3_geom_voronoiCreateBeach(lArc.site);d3_geom_voronoiBeaches.insert(newArc,rArc);newArc.edge=rArc.edge=d3_geom_voronoiCreateEdge(lArc.site,newArc.site);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);return;}
if(!rArc){newArc.edge=d3_geom_voronoiCreateEdge(lArc.site,newArc.site);return;}
d3_geom_voronoiDetachCircle(lArc);d3_geom_voronoiDetachCircle(rArc);var lSite=lArc.site,ax=lSite.x,ay=lSite.y,bx=site.x-ax,by=site.y-ay,rSite=rArc.site,cx=rSite.x-ax,cy=rSite.y-ay,d=2*(bx*cy-by*cx),hb=bx*bx+by*by,hc=cx*cx+cy*cy,vertex={x:(cy*hb-by*hc)/d+ax,y:(bx*hc-cx*hb)/d+ay};d3_geom_voronoiSetEdgeEnd(rArc.edge,lSite,rSite,vertex);newArc.edge=d3_geom_voronoiCreateEdge(lSite,site,null,vertex);rArc.edge=d3_geom_voronoiCreateEdge(site,rSite,null,vertex);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);}
function d3_geom_voronoiLeftBreakPoint(arc,directrix){var site=arc.site,rfocx=site.x,rfocy=site.y,pby2=rfocy-directrix;if(!pby2)return rfocx;var lArc=arc.P;if(!lArc)return-Infinity;site=lArc.site;var lfocx=site.x,lfocy=site.y,plby2=lfocy-directrix;if(!plby2)return lfocx;var hl=lfocx-rfocx,aby2=1/pby2-1/plby2,b=hl/plby2;if(aby2)return(-b+Math.sqrt(b*b-2*aby2*(hl*hl/(-2*plby2)-lfocy+plby2/2+rfocy-pby2/2)))/aby2+rfocx;return(rfocx+lfocx)/2;}
function d3_geom_voronoiRightBreakPoint(arc,directrix){var rArc=arc.N;if(rArc)return d3_geom_voronoiLeftBreakPoint(rArc,directrix);var site=arc.site;return site.y===directrix?site.x:Infinity;}
function d3_geom_voronoiCell(site){this.site=site;this.edges=[];}
d3_geom_voronoiCell.prototype.prepare=function(){var halfEdges=this.edges,iHalfEdge=halfEdges.length,edge;while(iHalfEdge--){edge=halfEdges[iHalfEdge].edge;if(!edge.b||!edge.a)halfEdges.splice(iHalfEdge,1);}
halfEdges.sort(d3_geom_voronoiHalfEdgeOrder);return halfEdges.length;};function d3_geom_voronoiCloseCells(extent){var x0=extent[0][0],x1=extent[1][0],y0=extent[0][1],y1=extent[1][1],x2,y2,x3,y3,cells=d3_geom_voronoiCells,iCell=cells.length,cell,iHalfEdge,halfEdges,nHalfEdges,start,end;while(iCell--){cell=cells[iCell];if(!cell||!cell.prepare())continue;halfEdges=cell.edges;nHalfEdges=halfEdges.length;iHalfEdge=0;while(iHalfEdge<nHalfEdges){end=halfEdges[iHalfEdge].end(),x3=end.x,y3=end.y;start=halfEdges[++iHalfEdge%nHalfEdges].start(),x2=start.x,y2=start.y;if(abs(x3-x2)>ε||abs(y3-y2)>ε){halfEdges.splice(iHalfEdge,0,new d3_geom_voronoiHalfEdge(d3_geom_voronoiCreateBorderEdge(cell.site,end,abs(x3-x0)<ε&&y1-y3>ε?{x:x0,y:abs(x2-x0)<ε?y2:y1}:abs(y3-y1)<ε&&x1-x3>ε?{x:abs(y2-y1)<ε?x2:x1,y:y1}:abs(x3-x1)<ε&&y3-y0>ε?{x:x1,y:abs(x2-x1)<ε?y2:y0}:abs(y3-y0)<ε&&x3-x0>ε?{x:abs(y2-y0)<ε?x2:x0,y:y0}:null),cell.site,null));++nHalfEdges;}}}}
function d3_geom_voronoiHalfEdgeOrder(a,b){return b.angle-a.angle;}
function d3_geom_voronoiCircle(){d3_geom_voronoiRedBlackNode(this);this.x=this.y=this.arc=this.site=this.cy=null;}
function d3_geom_voronoiAttachCircle(arc){var lArc=arc.P,rArc=arc.N;if(!lArc||!rArc)return;var lSite=lArc.site,cSite=arc.site,rSite=rArc.site;if(lSite===rSite)return;var bx=cSite.x,by=cSite.y,ax=lSite.x-bx,ay=lSite.y-by,cx=rSite.x-bx,cy=rSite.y-by;var d=2*(ax*cy-ay*cx);if(d>=-ε2)return;var ha=ax*ax+ay*ay,hc=cx*cx+cy*cy,x=(cy*ha-ay*hc)/d,y=(ax*hc-cx*ha)/d,cy=y+by;var circle=d3_geom_voronoiCirclePool.pop()||new d3_geom_voronoiCircle();circle.arc=arc;circle.site=cSite;circle.x=x+bx;circle.y=cy+Math.sqrt(x*x+y*y);circle.cy=cy;arc.circle=circle;var before=null,node=d3_geom_voronoiCircles._;while(node){if(circle.y<node.y||circle.y===node.y&&circle.x<=node.x){if(node.L)node=node.L;else{before=node.P;break;}}else{if(node.R)node=node.R;else{before=node;break;}}}
d3_geom_voronoiCircles.insert(before,circle);if(!before)d3_geom_voronoiFirstCircle=circle;}
function d3_geom_voronoiDetachCircle(arc){var circle=arc.circle;if(circle){if(!circle.P)d3_geom_voronoiFirstCircle=circle.N;d3_geom_voronoiCircles.remove(circle);d3_geom_voronoiCirclePool.push(circle);d3_geom_voronoiRedBlackNode(circle);arc.circle=null;}}
function d3_geom_voronoiClipEdges(extent){var edges=d3_geom_voronoiEdges,clip=d3_geom_clipLine(extent[0][0],extent[0][1],extent[1][0],extent[1][1]),i=edges.length,e;while(i--){e=edges[i];if(!d3_geom_voronoiConnectEdge(e,extent)||!clip(e)||abs(e.a.x-e.b.x)<ε&&abs(e.a.y-e.b.y)<ε){e.a=e.b=null;edges.splice(i,1);}}}
function d3_geom_voronoiConnectEdge(edge,extent){var vb=edge.b;if(vb)return true;var va=edge.a,x0=extent[0][0],x1=extent[1][0],y0=extent[0][1],y1=extent[1][1],lSite=edge.l,rSite=edge.r,lx=lSite.x,ly=lSite.y,rx=rSite.x,ry=rSite.y,fx=(lx+rx)/2,fy=(ly+ry)/2,fm,fb;if(ry===ly){if(fx<x0||fx>=x1)return;if(lx>rx){if(!va)va={x:fx,y:y0};else if(va.y>=y1)return;vb={x:fx,y:y1};}else{if(!va)va={x:fx,y:y1};else if(va.y<y0)return;vb={x:fx,y:y0};}}else{fm=(lx-rx)/(ry-ly);fb=fy-fm*fx;if(fm<-1||fm>1){if(lx>rx){if(!va)va={x:(y0-fb)/fm,y:y0};else if(va.y>=y1)return;vb={x:(y1-fb)/fm,y:y1};}else{if(!va)va={x:(y1-fb)/fm,y:y1};else if(va.y<y0)return;vb={x:(y0-fb)/fm,y:y0};}}else{if(ly<ry){if(!va)va={x:x0,y:fm*x0+fb};else if(va.x>=x1)return;vb={x:x1,y:fm*x1+fb};}else{if(!va)va={x:x1,y:fm*x1+fb};else if(va.x<x0)return;vb={x:x0,y:fm*x0+fb};}}}
edge.a=va;edge.b=vb;return true;}
function d3_geom_voronoiEdge(lSite,rSite){this.l=lSite;this.r=rSite;this.a=this.b=null;}
function d3_geom_voronoiCreateEdge(lSite,rSite,va,vb){var edge=new d3_geom_voronoiEdge(lSite,rSite);d3_geom_voronoiEdges.push(edge);if(va)d3_geom_voronoiSetEdgeEnd(edge,lSite,rSite,va);if(vb)d3_geom_voronoiSetEdgeEnd(edge,rSite,lSite,vb);d3_geom_voronoiCells[lSite.i].edges.push(new d3_geom_voronoiHalfEdge(edge,lSite,rSite));d3_geom_voronoiCells[rSite.i].edges.push(new d3_geom_voronoiHalfEdge(edge,rSite,lSite));return edge;}
function d3_geom_voronoiCreateBorderEdge(lSite,va,vb){var edge=new d3_geom_voronoiEdge(lSite,null);edge.a=va;edge.b=vb;d3_geom_voronoiEdges.push(edge);return edge;}
function d3_geom_voronoiSetEdgeEnd(edge,lSite,rSite,vertex){if(!edge.a&&!edge.b){edge.a=vertex;edge.l=lSite;edge.r=rSite;}else if(edge.l===rSite){edge.b=vertex;}else{edge.a=vertex;}}
function d3_geom_voronoiHalfEdge(edge,lSite,rSite){var va=edge.a,vb=edge.b;this.edge=edge;this.site=lSite;this.angle=rSite?Math.atan2(rSite.y-lSite.y,rSite.x-lSite.x):edge.l===lSite?Math.atan2(vb.x-va.x,va.y-vb.y):Math.atan2(va.x-vb.x,vb.y-va.y);}
d3_geom_voronoiHalfEdge.prototype={start:function(){return this.edge.l===this.site?this.edge.a:this.edge.b;},end:function(){return this.edge.l===this.site?this.edge.b:this.edge.a;}};function d3_geom_voronoiRedBlackTree(){this._=null;}
function d3_geom_voronoiRedBlackNode(node){node.U=node.C=node.L=node.R=node.P=node.N=null;}
d3_geom_voronoiRedBlackTree.prototype={insert:function(after,node){var parent,grandpa,uncle;if(after){node.P=after;node.N=after.N;if(after.N)after.N.P=node;after.N=node;if(after.R){after=after.R;while(after.L)after=after.L;after.L=node;}else{after.R=node;}
parent=after;}else if(this._){after=d3_geom_voronoiRedBlackFirst(this._);node.P=null;node.N=after;after.P=after.L=node;parent=after;}else{node.P=node.N=null;this._=node;parent=null;}
node.L=node.R=null;node.U=parent;node.C=true;after=node;while(parent&&parent.C){grandpa=parent.U;if(parent===grandpa.L){uncle=grandpa.R;if(uncle&&uncle.C){parent.C=uncle.C=false;grandpa.C=true;after=grandpa;}else{if(after===parent.R){d3_geom_voronoiRedBlackRotateLeft(this,parent);after=parent;parent=after.U;}
parent.C=false;grandpa.C=true;d3_geom_voronoiRedBlackRotateRight(this,grandpa);}}else{uncle=grandpa.L;if(uncle&&uncle.C){parent.C=uncle.C=false;grandpa.C=true;after=grandpa;}else{if(after===parent.L){d3_geom_voronoiRedBlackRotateRight(this,parent);after=parent;parent=after.U;}
parent.C=false;grandpa.C=true;d3_geom_voronoiRedBlackRotateLeft(this,grandpa);}}
parent=after.U;}
this._.C=false;},remove:function(node){if(node.N)node.N.P=node.P;if(node.P)node.P.N=node.N;node.N=node.P=null;var parent=node.U,sibling,left=node.L,right=node.R,next,red;if(!left)next=right;else if(!right)next=left;else next=d3_geom_voronoiRedBlackFirst(right);if(parent){if(parent.L===node)parent.L=next;else parent.R=next;}else{this._=next;}
if(left&&right){red=next.C;next.C=node.C;next.L=left;left.U=next;if(next!==right){parent=next.U;next.U=node.U;node=next.R;parent.L=node;next.R=right;right.U=next;}else{next.U=parent;parent=next;node=next.R;}}else{red=node.C;node=next;}
if(node)node.U=parent;if(red)return;if(node&&node.C){node.C=false;return;}
do{if(node===this._)break;if(node===parent.L){sibling=parent.R;if(sibling.C){sibling.C=false;parent.C=true;d3_geom_voronoiRedBlackRotateLeft(this,parent);sibling=parent.R;}
if(sibling.L&&sibling.L.C||sibling.R&&sibling.R.C){if(!sibling.R||!sibling.R.C){sibling.L.C=false;sibling.C=true;d3_geom_voronoiRedBlackRotateRight(this,sibling);sibling=parent.R;}
sibling.C=parent.C;parent.C=sibling.R.C=false;d3_geom_voronoiRedBlackRotateLeft(this,parent);node=this._;break;}}else{sibling=parent.L;if(sibling.C){sibling.C=false;parent.C=true;d3_geom_voronoiRedBlackRotateRight(this,parent);sibling=parent.L;}
if(sibling.L&&sibling.L.C||sibling.R&&sibling.R.C){if(!sibling.L||!sibling.L.C){sibling.R.C=false;sibling.C=true;d3_geom_voronoiRedBlackRotateLeft(this,sibling);sibling=parent.L;}
sibling.C=parent.C;parent.C=sibling.L.C=false;d3_geom_voronoiRedBlackRotateRight(this,parent);node=this._;break;}}
sibling.C=true;node=parent;parent=parent.U;}while(!node.C);if(node)node.C=false;}};function d3_geom_voronoiRedBlackRotateLeft(tree,node){var p=node,q=node.R,parent=p.U;if(parent){if(parent.L===p)parent.L=q;else parent.R=q;}else{tree._=q;}
q.U=parent;p.U=q;p.R=q.L;if(p.R)p.R.U=p;q.L=p;}
function d3_geom_voronoiRedBlackRotateRight(tree,node){var p=node,q=node.L,parent=p.U;if(parent){if(parent.L===p)parent.L=q;else parent.R=q;}else{tree._=q;}
q.U=parent;p.U=q;p.L=q.R;if(p.L)p.L.U=p;q.R=p;}
function d3_geom_voronoiRedBlackFirst(node){while(node.L)node=node.L;return node;}
function d3_geom_voronoi(sites,bbox){var site=sites.sort(d3_geom_voronoiVertexOrder).pop(),x0,y0,circle;d3_geom_voronoiEdges=[];d3_geom_voronoiCells=new Array(sites.length);d3_geom_voronoiBeaches=new d3_geom_voronoiRedBlackTree();d3_geom_voronoiCircles=new d3_geom_voronoiRedBlackTree();while(true){circle=d3_geom_voronoiFirstCircle;if(site&&(!circle||site.y<circle.y||site.y===circle.y&&site.x<circle.x)){if(site.x!==x0||site.y!==y0){d3_geom_voronoiCells[site.i]=new d3_geom_voronoiCell(site);d3_geom_voronoiAddBeach(site);x0=site.x,y0=site.y;}
site=sites.pop();}else if(circle){d3_geom_voronoiRemoveBeach(circle.arc);}else{break;}}
if(bbox)d3_geom_voronoiClipEdges(bbox),d3_geom_voronoiCloseCells(bbox);var diagram={cells:d3_geom_voronoiCells,edges:d3_geom_voronoiEdges};d3_geom_voronoiBeaches=d3_geom_voronoiCircles=d3_geom_voronoiEdges=d3_geom_voronoiCells=null;return diagram;}
function d3_geom_voronoiVertexOrder(a,b){return b.y-a.y||b.x-a.x;}
d3.geom.voronoi=function(points){var x=d3_geom_pointX,y=d3_geom_pointY,fx=x,fy=y,clipExtent=d3_geom_voronoiClipExtent;if(points)return voronoi(points);function voronoi(data){var polygons=new Array(data.length),x0=clipExtent[0][0],y0=clipExtent[0][1],x1=clipExtent[1][0],y1=clipExtent[1][1];d3_geom_voronoi(sites(data),clipExtent).cells.forEach(function(cell,i){var edges=cell.edges,site=cell.site,polygon=polygons[i]=edges.length?edges.map(function(e){var s=e.start();return[s.x,s.y];}):site.x>=x0&&site.x<=x1&&site.y>=y0&&site.y<=y1?[[x0,y1],[x1,y1],[x1,y0],[x0,y0]]:[];polygon.point=data[i];});return polygons;}
function sites(data){return data.map(function(d,i){return{x:Math.round(fx(d,i)/ε)*ε,y:Math.round(fy(d,i)/ε)*ε,i:i};});}
voronoi.links=function(data){return d3_geom_voronoi(sites(data)).edges.filter(function(edge){return edge.l&&edge.r;}).map(function(edge){return{source:data[edge.l.i],target:data[edge.r.i]};});};voronoi.triangles=function(data){var triangles=[];d3_geom_voronoi(sites(data)).cells.forEach(function(cell,i){var site=cell.site,edges=cell.edges.sort(d3_geom_voronoiHalfEdgeOrder),j=-1,m=edges.length,e0,s0,e1=edges[m-1].edge,s1=e1.l===site?e1.r:e1.l;while(++j<m){e0=e1;s0=s1;e1=edges[j].edge;s1=e1.l===site?e1.r:e1.l;if(i<s0.i&&i<s1.i&&d3_geom_voronoiTriangleArea(site,s0,s1)<0){triangles.push([data[i],data[s0.i],data[s1.i]]);}}});return triangles;};voronoi.x=function(_){return arguments.length?(fx=d3_functor(x=_),voronoi):x;};voronoi.y=function(_){return arguments.length?(fy=d3_functor(y=_),voronoi):y;};voronoi.clipExtent=function(_){if(!arguments.length)return clipExtent===d3_geom_voronoiClipExtent?null:clipExtent;clipExtent=_==null?d3_geom_voronoiClipExtent:_;return voronoi;};voronoi.size=function(_){if(!arguments.length)return clipExtent===d3_geom_voronoiClipExtent?null:clipExtent&&clipExtent[1];return voronoi.clipExtent(_&&[[0,0],_]);};return voronoi;};var d3_geom_voronoiClipExtent=[[-1e6,-1e6],[1e6,1e6]];function d3_geom_voronoiTriangleArea(a,b,c){return(a.x-c.x)*(b.y-a.y)-(a.x-b.x)*(c.y-a.y);}
d3.geom.delaunay=function(vertices){return d3.geom.voronoi().triangles(vertices);};d3.geom.quadtree=function(points,x1,y1,x2,y2){var x=d3_geom_pointX,y=d3_geom_pointY,compat;if(compat=arguments.length){x=d3_geom_quadtreeCompatX;y=d3_geom_quadtreeCompatY;if(compat===3){y2=y1;x2=x1;y1=x1=0;}
return quadtree(points);}
function quadtree(data){var d,fx=d3_functor(x),fy=d3_functor(y),xs,ys,i,n,x1_,y1_,x2_,y2_;if(x1!=null){x1_=x1,y1_=y1,x2_=x2,y2_=y2;}else{x2_=y2_=-(x1_=y1_=Infinity);xs=[],ys=[];n=data.length;if(compat)for(i=0;i<n;++i){d=data[i];if(d.x<x1_)x1_=d.x;if(d.y<y1_)y1_=d.y;if(d.x>x2_)x2_=d.x;if(d.y>y2_)y2_=d.y;xs.push(d.x);ys.push(d.y);}else for(i=0;i<n;++i){var x_=+fx(d=data[i],i),y_=+fy(d,i);if(x_<x1_)x1_=x_;if(y_<y1_)y1_=y_;if(x_>x2_)x2_=x_;if(y_>y2_)y2_=y_;xs.push(x_);ys.push(y_);}}
var dx=x2_-x1_,dy=y2_-y1_;if(dx>dy)y2_=y1_+dx;else x2_=x1_+dy;function insert(n,d,x,y,x1,y1,x2,y2){if(isNaN(x)||isNaN(y))return;if(n.leaf){var nx=n.x,ny=n.y;if(nx!=null){if(abs(nx-x)+abs(ny-y)<.01){insertChild(n,d,x,y,x1,y1,x2,y2);}else{var nPoint=n.point;n.x=n.y=n.point=null;insertChild(n,nPoint,nx,ny,x1,y1,x2,y2);insertChild(n,d,x,y,x1,y1,x2,y2);}}else{n.x=x,n.y=y,n.point=d;}}else{insertChild(n,d,x,y,x1,y1,x2,y2);}}
function insertChild(n,d,x,y,x1,y1,x2,y2){var sx=(x1+x2)*.5,sy=(y1+y2)*.5,right=x>=sx,bottom=y>=sy,i=(bottom<<1)+right;n.leaf=false;n=n.nodes[i]||(n.nodes[i]=d3_geom_quadtreeNode());if(right)x1=sx;else x2=sx;if(bottom)y1=sy;else y2=sy;insert(n,d,x,y,x1,y1,x2,y2);}
var root=d3_geom_quadtreeNode();root.add=function(d){insert(root,d,+fx(d,++i),+fy(d,i),x1_,y1_,x2_,y2_);};root.visit=function(f){d3_geom_quadtreeVisit(f,root,x1_,y1_,x2_,y2_);};i=-1;if(x1==null){while(++i<n){insert(root,data[i],xs[i],ys[i],x1_,y1_,x2_,y2_);}
--i;}else data.forEach(root.add);xs=ys=data=d=null;return root;}
quadtree.x=function(_){return arguments.length?(x=_,quadtree):x;};quadtree.y=function(_){return arguments.length?(y=_,quadtree):y;};quadtree.extent=function(_){if(!arguments.length)return x1==null?null:[[x1,y1],[x2,y2]];if(_==null)x1=y1=x2=y2=null;else x1=+_[0][0],y1=+_[0][1],x2=+_[1][0],y2=+_[1][1];return quadtree;};quadtree.size=function(_){if(!arguments.length)return x1==null?null:[x2-x1,y2-y1];if(_==null)x1=y1=x2=y2=null;else x1=y1=0,x2=+_[0],y2=+_[1];return quadtree;};return quadtree;};function d3_geom_quadtreeCompatX(d){return d.x;}
function d3_geom_quadtreeCompatY(d){return d.y;}
function d3_geom_quadtreeNode(){return{leaf:true,nodes:[],point:null,x:null,y:null};}
function d3_geom_quadtreeVisit(f,node,x1,y1,x2,y2){if(!f(node,x1,y1,x2,y2)){var sx=(x1+x2)*.5,sy=(y1+y2)*.5,children=node.nodes;if(children[0])d3_geom_quadtreeVisit(f,children[0],x1,y1,sx,sy);if(children[1])d3_geom_quadtreeVisit(f,children[1],sx,y1,x2,sy);if(children[2])d3_geom_quadtreeVisit(f,children[2],x1,sy,sx,y2);if(children[3])d3_geom_quadtreeVisit(f,children[3],sx,sy,x2,y2);}}
d3.interpolateRgb=d3_interpolateRgb;function d3_interpolateRgb(a,b){a=d3.rgb(a);b=d3.rgb(b);var ar=a.r,ag=a.g,ab=a.b,br=b.r-ar,bg=b.g-ag,bb=b.b-ab;return function(t){return"#"+d3_rgb_hex(Math.round(ar+br*t))+d3_rgb_hex(Math.round(ag+bg*t))+d3_rgb_hex(Math.round(ab+bb*t));};}
d3.interpolateObject=d3_interpolateObject;function d3_interpolateObject(a,b){var i={},c={},k;for(k in a){if(k in b){i[k]=d3_interpolate(a[k],b[k]);}else{c[k]=a[k];}}
for(k in b){if(!(k in a)){c[k]=b[k];}}
return function(t){for(k in i)c[k]=i[k](t);return c;};}
d3.interpolateNumber=d3_interpolateNumber;function d3_interpolateNumber(a,b){b-=a=+a;return function(t){return a+b*t;};}
d3.interpolateString=d3_interpolateString;function d3_interpolateString(a,b){var bi=d3_interpolate_numberA.lastIndex=d3_interpolate_numberB.lastIndex=0,am,bm,bs,i=-1,s=[],q=[];a=a+"",b=b+"";while((am=d3_interpolate_numberA.exec(a))&&(bm=d3_interpolate_numberB.exec(b))){if((bs=bm.index)>bi){bs=b.substring(bi,bs);if(s[i])s[i]+=bs;else s[++i]=bs;}
if((am=am[0])===(bm=bm[0])){if(s[i])s[i]+=bm;else s[++i]=bm;}else{s[++i]=null;q.push({i:i,x:d3_interpolateNumber(am,bm)});}
bi=d3_interpolate_numberB.lastIndex;}
if(bi<b.length){bs=b.substring(bi);if(s[i])s[i]+=bs;else s[++i]=bs;}
return s.length<2?q[0]?(b=q[0].x,function(t){return b(t)+"";}):function(){return b;}:(b=q.length,function(t){for(var i=0,o;i<b;++i)s[(o=q[i]).i]=o.x(t);return s.join("");});}
var d3_interpolate_numberA=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,d3_interpolate_numberB=new RegExp(d3_interpolate_numberA.source,"g");d3.interpolate=d3_interpolate;function d3_interpolate(a,b){var i=d3.interpolators.length,f;while(--i>=0&&!(f=d3.interpolators[i](a,b)));return f;}
d3.interpolators=[function(a,b){var t=typeof b;return(t==="string"?d3_rgb_names.has(b)||/^(#|rgb\(|hsl\()/.test(b)?d3_interpolateRgb:d3_interpolateString:b instanceof d3_Color?d3_interpolateRgb:Array.isArray(b)?d3_interpolateArray:t==="object"&&isNaN(b)?d3_interpolateObject:d3_interpolateNumber)(a,b);}];d3.interpolateArray=d3_interpolateArray;function d3_interpolateArray(a,b){var x=[],c=[],na=a.length,nb=b.length,n0=Math.min(a.length,b.length),i;for(i=0;i<n0;++i)x.push(d3_interpolate(a[i],b[i]));for(;i<na;++i)c[i]=a[i];for(;i<nb;++i)c[i]=b[i];return function(t){for(i=0;i<n0;++i)c[i]=x[i](t);return c;};}
var d3_ease_default=function(){return d3_identity;};var d3_ease=d3.map({linear:d3_ease_default,poly:d3_ease_poly,quad:function(){return d3_ease_quad;},cubic:function(){return d3_ease_cubic;},sin:function(){return d3_ease_sin;},exp:function(){return d3_ease_exp;},circle:function(){return d3_ease_circle;},elastic:d3_ease_elastic,back:d3_ease_back,bounce:function(){return d3_ease_bounce;}});var d3_ease_mode=d3.map({"in":d3_identity,out:d3_ease_reverse,"in-out":d3_ease_reflect,"out-in":function(f){return d3_ease_reflect(d3_ease_reverse(f));}});d3.ease=function(name){var i=name.indexOf("-"),t=i>=0?name.substring(0,i):name,m=i>=0?name.substring(i+1):"in";t=d3_ease.get(t)||d3_ease_default;m=d3_ease_mode.get(m)||d3_identity;return d3_ease_clamp(m(t.apply(null,d3_arraySlice.call(arguments,1))));};function d3_ease_clamp(f){return function(t){return t<=0?0:t>=1?1:f(t);};}
function d3_ease_reverse(f){return function(t){return 1-f(1-t);};}
function d3_ease_reflect(f){return function(t){return.5*(t<.5?f(2*t):2-f(2-2*t));};}
function d3_ease_quad(t){return t*t;}
function d3_ease_cubic(t){return t*t*t;}
function d3_ease_cubicInOut(t){if(t<=0)return 0;if(t>=1)return 1;var t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75);}
function d3_ease_poly(e){return function(t){return Math.pow(t,e);};}
function d3_ease_sin(t){return 1-Math.cos(t*halfπ);}
function d3_ease_exp(t){return Math.pow(2,10*(t-1));}
function d3_ease_circle(t){return 1-Math.sqrt(1-t*t);}
function d3_ease_elastic(a,p){var s;if(arguments.length<2)p=.45;if(arguments.length)s=p/τ*Math.asin(1/a);else a=1,s=p/4;return function(t){return 1+a*Math.pow(2,-10*t)*Math.sin((t-s)*τ/p);};}
function d3_ease_back(s){if(!s)s=1.70158;return function(t){return t*t*((s+1)*t-s);};}
function d3_ease_bounce(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375;}
d3.interpolateHcl=d3_interpolateHcl;function d3_interpolateHcl(a,b){a=d3.hcl(a);b=d3.hcl(b);var ah=a.h,ac=a.c,al=a.l,bh=b.h-ah,bc=b.c-ac,bl=b.l-al;if(isNaN(bc))bc=0,ac=isNaN(ac)?b.c:ac;if(isNaN(bh))bh=0,ah=isNaN(ah)?b.h:ah;else if(bh>180)bh-=360;else if(bh<-180)bh+=360;return function(t){return d3_hcl_lab(ah+bh*t,ac+bc*t,al+bl*t)+"";};}
d3.interpolateHsl=d3_interpolateHsl;function d3_interpolateHsl(a,b){a=d3.hsl(a);b=d3.hsl(b);var ah=a.h,as=a.s,al=a.l,bh=b.h-ah,bs=b.s-as,bl=b.l-al;if(isNaN(bs))bs=0,as=isNaN(as)?b.s:as;if(isNaN(bh))bh=0,ah=isNaN(ah)?b.h:ah;else if(bh>180)bh-=360;else if(bh<-180)bh+=360;return function(t){return d3_hsl_rgb(ah+bh*t,as+bs*t,al+bl*t)+"";};}
d3.interpolateLab=d3_interpolateLab;function d3_interpolateLab(a,b){a=d3.lab(a);b=d3.lab(b);var al=a.l,aa=a.a,ab=a.b,bl=b.l-al,ba=b.a-aa,bb=b.b-ab;return function(t){return d3_lab_rgb(al+bl*t,aa+ba*t,ab+bb*t)+"";};}
d3.interpolateRound=d3_interpolateRound;function d3_interpolateRound(a,b){b-=a;return function(t){return Math.round(a+b*t);};}
d3.transform=function(string){var g=d3_document.createElementNS(d3.ns.prefix.svg,"g");return(d3.transform=function(string){if(string!=null){g.setAttribute("transform",string);var t=g.transform.baseVal.consolidate();}
return new d3_transform(t?t.matrix:d3_transformIdentity);})(string);};function d3_transform(m){var r0=[m.a,m.b],r1=[m.c,m.d],kx=d3_transformNormalize(r0),kz=d3_transformDot(r0,r1),ky=d3_transformNormalize(d3_transformCombine(r1,r0,-kz))||0;if(r0[0]*r1[1]<r1[0]*r0[1]){r0[0]*=-1;r0[1]*=-1;kx*=-1;kz*=-1;}
this.rotate=(kx?Math.atan2(r0[1],r0[0]):Math.atan2(-r1[0],r1[1]))*d3_degrees;this.translate=[m.e,m.f];this.scale=[kx,ky];this.skew=ky?Math.atan2(kz,ky)*d3_degrees:0;}
d3_transform.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")";};function d3_transformDot(a,b){return a[0]*b[0]+a[1]*b[1];}
function d3_transformNormalize(a){var k=Math.sqrt(d3_transformDot(a,a));if(k){a[0]/=k;a[1]/=k;}
return k;}
function d3_transformCombine(a,b,k){a[0]+=k*b[0];a[1]+=k*b[1];return a;}
var d3_transformIdentity={a:1,b:0,c:0,d:1,e:0,f:0};d3.interpolateTransform=d3_interpolateTransform;function d3_interpolateTransform(a,b){var s=[],q=[],n,A=d3.transform(a),B=d3.transform(b),ta=A.translate,tb=B.translate,ra=A.rotate,rb=B.rotate,wa=A.skew,wb=B.skew,ka=A.scale,kb=B.scale;if(ta[0]!=tb[0]||ta[1]!=tb[1]){s.push("translate(",null,",",null,")");q.push({i:1,x:d3_interpolateNumber(ta[0],tb[0])},{i:3,x:d3_interpolateNumber(ta[1],tb[1])});}else if(tb[0]||tb[1]){s.push("translate("+tb+")");}else{s.push("");}
if(ra!=rb){if(ra-rb>180)rb+=360;else if(rb-ra>180)ra+=360;q.push({i:s.push(s.pop()+"rotate(",null,")")-2,x:d3_interpolateNumber(ra,rb)});}else if(rb){s.push(s.pop()+"rotate("+rb+")");}
if(wa!=wb){q.push({i:s.push(s.pop()+"skewX(",null,")")-2,x:d3_interpolateNumber(wa,wb)});}else if(wb){s.push(s.pop()+"skewX("+wb+")");}
if(ka[0]!=kb[0]||ka[1]!=kb[1]){n=s.push(s.pop()+"scale(",null,",",null,")");q.push({i:n-4,x:d3_interpolateNumber(ka[0],kb[0])},{i:n-2,x:d3_interpolateNumber(ka[1],kb[1])});}else if(kb[0]!=1||kb[1]!=1){s.push(s.pop()+"scale("+kb+")");}
n=q.length;return function(t){var i=-1,o;while(++i<n)s[(o=q[i]).i]=o.x(t);return s.join("");};}
function d3_uninterpolateNumber(a,b){b=b-(a=+a)?1/(b-a):0;return function(x){return(x-a)*b;};}
function d3_uninterpolateClamp(a,b){b=b-(a=+a)?1/(b-a):0;return function(x){return Math.max(0,Math.min(1,(x-a)*b));};}
d3.layout={};d3.layout.bundle=function(){return function(links){var paths=[],i=-1,n=links.length;while(++i<n)paths.push(d3_layout_bundlePath(links[i]));return paths;};};function d3_layout_bundlePath(link){var start=link.source,end=link.target,lca=d3_layout_bundleLeastCommonAncestor(start,end),points=[start];while(start!==lca){start=start.parent;points.push(start);}
var k=points.length;while(end!==lca){points.splice(k,0,end);end=end.parent;}
return points;}
function d3_layout_bundleAncestors(node){var ancestors=[],parent=node.parent;while(parent!=null){ancestors.push(node);node=parent;parent=parent.parent;}
ancestors.push(node);return ancestors;}
function d3_layout_bundleLeastCommonAncestor(a,b){if(a===b)return a;var aNodes=d3_layout_bundleAncestors(a),bNodes=d3_layout_bundleAncestors(b),aNode=aNodes.pop(),bNode=bNodes.pop(),sharedNode=null;while(aNode===bNode){sharedNode=aNode;aNode=aNodes.pop();bNode=bNodes.pop();}
return sharedNode;}
d3.layout.chord=function(){var chord={},chords,groups,matrix,n,padding=0,sortGroups,sortSubgroups,sortChords;function relayout(){var subgroups={},groupSums=[],groupIndex=d3.range(n),subgroupIndex=[],k,x,x0,i,j;chords=[];groups=[];k=0,i=-1;while(++i<n){x=0,j=-1;while(++j<n){x+=matrix[i][j];}
groupSums.push(x);subgroupIndex.push(d3.range(n));k+=x;}
if(sortGroups){groupIndex.sort(function(a,b){return sortGroups(groupSums[a],groupSums[b]);});}
if(sortSubgroups){subgroupIndex.forEach(function(d,i){d.sort(function(a,b){return sortSubgroups(matrix[i][a],matrix[i][b]);});});}
k=(τ-padding*n)/k;x=0,i=-1;while(++i<n){x0=x,j=-1;while(++j<n){var di=groupIndex[i],dj=subgroupIndex[di][j],v=matrix[di][dj],a0=x,a1=x+=v*k;subgroups[di+"-"+dj]={index:di,subindex:dj,startAngle:a0,endAngle:a1,value:v};}
groups[di]={index:di,startAngle:x0,endAngle:x,value:(x-x0)/k};x+=padding;}
i=-1;while(++i<n){j=i-1;while(++j<n){var source=subgroups[i+"-"+j],target=subgroups[j+"-"+i];if(source.value||target.value){chords.push(source.value<target.value?{source:target,target:source}:{source:source,target:target});}}}
if(sortChords)resort();}
function resort(){chords.sort(function(a,b){return sortChords((a.source.value+a.target.value)/2,(b.source.value+b.target.value)/2);});}
chord.matrix=function(x){if(!arguments.length)return matrix;n=(matrix=x)&&matrix.length;chords=groups=null;return chord;};chord.padding=function(x){if(!arguments.length)return padding;padding=x;chords=groups=null;return chord;};chord.sortGroups=function(x){if(!arguments.length)return sortGroups;sortGroups=x;chords=groups=null;return chord;};chord.sortSubgroups=function(x){if(!arguments.length)return sortSubgroups;sortSubgroups=x;chords=null;return chord;};chord.sortChords=function(x){if(!arguments.length)return sortChords;sortChords=x;if(chords)resort();return chord;};chord.chords=function(){if(!chords)relayout();return chords;};chord.groups=function(){if(!groups)relayout();return groups;};return chord;};d3.layout.force=function(){var force={},event=d3.dispatch("start","tick","end"),size=[1,1],drag,alpha,friction=.9,linkDistance=d3_layout_forceLinkDistance,linkStrength=d3_layout_forceLinkStrength,charge=-30,chargeDistance2=d3_layout_forceChargeDistance2,gravity=.1,theta2=.64,nodes=[],links=[],distances,strengths,charges;function repulse(node){return function(quad,x1,_,x2){if(quad.point!==node){var dx=quad.cx-node.x,dy=quad.cy-node.y,dw=x2-x1,dn=dx*dx+dy*dy;if(dw*dw/theta2<dn){if(dn<chargeDistance2){var k=quad.charge/dn;node.px-=dx*k;node.py-=dy*k;}
return true;}
if(quad.point&&dn&&dn<chargeDistance2){var k=quad.pointCharge/dn;node.px-=dx*k;node.py-=dy*k;}}
return!quad.charge;};}
force.tick=function(){if((alpha*=.99)<.005){event.end({type:"end",alpha:alpha=0});return true;}
var n=nodes.length,m=links.length,q,i,o,s,t,l,k,x,y;for(i=0;i<m;++i){o=links[i];s=o.source;t=o.target;x=t.x-s.x;y=t.y-s.y;if(l=x*x+y*y){l=alpha*strengths[i]*((l=Math.sqrt(l))-distances[i])/l;x*=l;y*=l;t.x-=x*(k=s.weight/(t.weight+s.weight));t.y-=y*k;s.x+=x*(k=1-k);s.y+=y*k;}}
if(k=alpha*gravity){x=size[0]/2;y=size[1]/2;i=-1;if(k)while(++i<n){o=nodes[i];o.x+=(x-o.x)*k;o.y+=(y-o.y)*k;}}
if(charge){d3_layout_forceAccumulate(q=d3.geom.quadtree(nodes),alpha,charges);i=-1;while(++i<n){if(!(o=nodes[i]).fixed){q.visit(repulse(o));}}}
i=-1;while(++i<n){o=nodes[i];if(o.fixed){o.x=o.px;o.y=o.py;}else{o.x-=(o.px-(o.px=o.x))*friction;o.y-=(o.py-(o.py=o.y))*friction;}}
event.tick({type:"tick",alpha:alpha});};force.nodes=function(x){if(!arguments.length)return nodes;nodes=x;return force;};force.links=function(x){if(!arguments.length)return links;links=x;return force;};force.size=function(x){if(!arguments.length)return size;size=x;return force;};force.linkDistance=function(x){if(!arguments.length)return linkDistance;linkDistance=typeof x==="function"?x:+x;return force;};force.distance=force.linkDistance;force.linkStrength=function(x){if(!arguments.length)return linkStrength;linkStrength=typeof x==="function"?x:+x;return force;};force.friction=function(x){if(!arguments.length)return friction;friction=+x;return force;};force.charge=function(x){if(!arguments.length)return charge;charge=typeof x==="function"?x:+x;return force;};force.chargeDistance=function(x){if(!arguments.length)return Math.sqrt(chargeDistance2);chargeDistance2=x*x;return force;};force.gravity=function(x){if(!arguments.length)return gravity;gravity=+x;return force;};force.theta=function(x){if(!arguments.length)return Math.sqrt(theta2);theta2=x*x;return force;};force.alpha=function(x){if(!arguments.length)return alpha;x=+x;if(alpha){if(x>0)alpha=x;else alpha=0;}else if(x>0){event.start({type:"start",alpha:alpha=x});d3.timer(force.tick);}
return force;};force.start=function(){var i,n=nodes.length,m=links.length,w=size[0],h=size[1],neighbors,o;for(i=0;i<n;++i){(o=nodes[i]).index=i;o.weight=0;}
for(i=0;i<m;++i){o=links[i];if(typeof o.source=="number")o.source=nodes[o.source];if(typeof o.target=="number")o.target=nodes[o.target];++o.source.weight;++o.target.weight;}
for(i=0;i<n;++i){o=nodes[i];if(isNaN(o.x))o.x=position("x",w);if(isNaN(o.y))o.y=position("y",h);if(isNaN(o.px))o.px=o.x;if(isNaN(o.py))o.py=o.y;}
distances=[];if(typeof linkDistance==="function")for(i=0;i<m;++i)distances[i]=+linkDistance.call(this,links[i],i);else for(i=0;i<m;++i)distances[i]=linkDistance;strengths=[];if(typeof linkStrength==="function")for(i=0;i<m;++i)strengths[i]=+linkStrength.call(this,links[i],i);else for(i=0;i<m;++i)strengths[i]=linkStrength;charges=[];if(typeof charge==="function")for(i=0;i<n;++i)charges[i]=+charge.call(this,nodes[i],i);else for(i=0;i<n;++i)charges[i]=charge;function position(dimension,size){if(!neighbors){neighbors=new Array(n);for(j=0;j<n;++j){neighbors[j]=[];}
for(j=0;j<m;++j){var o=links[j];neighbors[o.source.index].push(o.target);neighbors[o.target.index].push(o.source);}}
var candidates=neighbors[i],j=-1,m=candidates.length,x;while(++j<m)if(!isNaN(x=candidates[j][dimension]))return x;return Math.random()*size;}
return force.resume();};force.resume=function(){return force.alpha(.1);};force.stop=function(){return force.alpha(0);};force.drag=function(){if(!drag)drag=d3.behavior.drag().origin(d3_identity).on("dragstart.force",d3_layout_forceDragstart).on("drag.force",dragmove).on("dragend.force",d3_layout_forceDragend);if(!arguments.length)return drag;this.on("mouseover.force",d3_layout_forceMouseover).on("mouseout.force",d3_layout_forceMouseout).call(drag);};function dragmove(d){d.px=d3.event.x,d.py=d3.event.y;force.resume();}
return d3.rebind(force,event,"on");};function d3_layout_forceDragstart(d){d.fixed|=2;}
function d3_layout_forceDragend(d){d.fixed&=~6;}
function d3_layout_forceMouseover(d){d.fixed|=4;d.px=d.x,d.py=d.y;}
function d3_layout_forceMouseout(d){d.fixed&=~4;}
function d3_layout_forceAccumulate(quad,alpha,charges){var cx=0,cy=0;quad.charge=0;if(!quad.leaf){var nodes=quad.nodes,n=nodes.length,i=-1,c;while(++i<n){c=nodes[i];if(c==null)continue;d3_layout_forceAccumulate(c,alpha,charges);quad.charge+=c.charge;cx+=c.charge*c.cx;cy+=c.charge*c.cy;}}
if(quad.point){if(!quad.leaf){quad.point.x+=Math.random()-.5;quad.point.y+=Math.random()-.5;}
var k=alpha*charges[quad.point.index];quad.charge+=quad.pointCharge=k;cx+=k*quad.point.x;cy+=k*quad.point.y;}
quad.cx=cx/quad.charge;quad.cy=cy/quad.charge;}
var d3_layout_forceLinkDistance=20,d3_layout_forceLinkStrength=1,d3_layout_forceChargeDistance2=Infinity;d3.layout.hierarchy=function(){var sort=d3_layout_hierarchySort,children=d3_layout_hierarchyChildren,value=d3_layout_hierarchyValue;function recurse(node,depth,nodes){var childs=children.call(hierarchy,node,depth);node.depth=depth;nodes.push(node);if(childs&&(n=childs.length)){var i=-1,n,c=node.children=new Array(n),v=0,j=depth+1,d;while(++i<n){d=c[i]=recurse(childs[i],j,nodes);d.parent=node;v+=d.value;}
if(sort)c.sort(sort);if(value)node.value=v;}else{delete node.children;if(value){node.value=+value.call(hierarchy,node,depth)||0;}}
return node;}
function revalue(node,depth){var children=node.children,v=0;if(children&&(n=children.length)){var i=-1,n,j=depth+1;while(++i<n)v+=revalue(children[i],j);}else if(value){v=+value.call(hierarchy,node,depth)||0;}
if(value)node.value=v;return v;}
function hierarchy(d){var nodes=[];recurse(d,0,nodes);return nodes;}
hierarchy.sort=function(x){if(!arguments.length)return sort;sort=x;return hierarchy;};hierarchy.children=function(x){if(!arguments.length)return children;children=x;return hierarchy;};hierarchy.value=function(x){if(!arguments.length)return value;value=x;return hierarchy;};hierarchy.revalue=function(root){revalue(root,0);return root;};return hierarchy;};function d3_layout_hierarchyRebind(object,hierarchy){d3.rebind(object,hierarchy,"sort","children","value");object.nodes=object;object.links=d3_layout_hierarchyLinks;return object;}
function d3_layout_hierarchyChildren(d){return d.children;}
function d3_layout_hierarchyValue(d){return d.value;}
function d3_layout_hierarchySort(a,b){return b.value-a.value;}
function d3_layout_hierarchyLinks(nodes){return d3.merge(nodes.map(function(parent){return(parent.children||[]).map(function(child){return{source:parent,target:child};});}));}
d3.layout.partition=function(){var hierarchy=d3.layout.hierarchy(),size=[1,1];function position(node,x,dx,dy){var children=node.children;node.x=x;node.y=node.depth*dy;node.dx=dx;node.dy=dy;if(children&&(n=children.length)){var i=-1,n,c,d;dx=node.value?dx/node.value:0;while(++i<n){position(c=children[i],x,d=c.value*dx,dy);x+=d;}}}
function depth(node){var children=node.children,d=0;if(children&&(n=children.length)){var i=-1,n;while(++i<n)d=Math.max(d,depth(children[i]));}
return 1+d;}
function partition(d,i){var nodes=hierarchy.call(this,d,i);position(nodes[0],0,size[0],size[1]/depth(nodes[0]));return nodes;}
partition.size=function(x){if(!arguments.length)return size;size=x;return partition;};return d3_layout_hierarchyRebind(partition,hierarchy);};d3.layout.pie=function(){var value=Number,sort=d3_layout_pieSortByValue,startAngle=0,endAngle=τ;function pie(data){var values=data.map(function(d,i){return+value.call(pie,d,i);});var a=+(typeof startAngle==="function"?startAngle.apply(this,arguments):startAngle);var k=((typeof endAngle==="function"?endAngle.apply(this,arguments):endAngle)-a)/d3.sum(values);var index=d3.range(data.length);if(sort!=null)index.sort(sort===d3_layout_pieSortByValue?function(i,j){return values[j]-values[i];}:function(i,j){return sort(data[i],data[j]);});var arcs=[];index.forEach(function(i){var d;arcs[i]={data:data[i],value:d=values[i],startAngle:a,endAngle:a+=d*k};});return arcs;}
pie.value=function(x){if(!arguments.length)return value;value=x;return pie;};pie.sort=function(x){if(!arguments.length)return sort;sort=x;return pie;};pie.startAngle=function(x){if(!arguments.length)return startAngle;startAngle=x;return pie;};pie.endAngle=function(x){if(!arguments.length)return endAngle;endAngle=x;return pie;};return pie;};var d3_layout_pieSortByValue={};d3.layout.stack=function(){var values=d3_identity,order=d3_layout_stackOrderDefault,offset=d3_layout_stackOffsetZero,out=d3_layout_stackOut,x=d3_layout_stackX,y=d3_layout_stackY;function stack(data,index){var series=data.map(function(d,i){return values.call(stack,d,i);});var points=series.map(function(d){return d.map(function(v,i){return[x.call(stack,v,i),y.call(stack,v,i)];});});var orders=order.call(stack,points,index);series=d3.permute(series,orders);points=d3.permute(points,orders);var offsets=offset.call(stack,points,index);var n=series.length,m=series[0].length,i,j,o;for(j=0;j<m;++j){out.call(stack,series[0][j],o=offsets[j],points[0][j][1]);for(i=1;i<n;++i){out.call(stack,series[i][j],o+=points[i-1][j][1],points[i][j][1]);}}
return data;}
stack.values=function(x){if(!arguments.length)return values;values=x;return stack;};stack.order=function(x){if(!arguments.length)return order;order=typeof x==="function"?x:d3_layout_stackOrders.get(x)||d3_layout_stackOrderDefault;return stack;};stack.offset=function(x){if(!arguments.length)return offset;offset=typeof x==="function"?x:d3_layout_stackOffsets.get(x)||d3_layout_stackOffsetZero;return stack;};stack.x=function(z){if(!arguments.length)return x;x=z;return stack;};stack.y=function(z){if(!arguments.length)return y;y=z;return stack;};stack.out=function(z){if(!arguments.length)return out;out=z;return stack;};return stack;};function d3_layout_stackX(d){return d.x;}
function d3_layout_stackY(d){return d.y;}
function d3_layout_stackOut(d,y0,y){d.y0=y0;d.y=y;}
var d3_layout_stackOrders=d3.map({"inside-out":function(data){var n=data.length,i,j,max=data.map(d3_layout_stackMaxIndex),sums=data.map(d3_layout_stackReduceSum),index=d3.range(n).sort(function(a,b){return max[a]-max[b];}),top=0,bottom=0,tops=[],bottoms=[];for(i=0;i<n;++i){j=index[i];if(top<bottom){top+=sums[j];tops.push(j);}else{bottom+=sums[j];bottoms.push(j);}}
return bottoms.reverse().concat(tops);},reverse:function(data){return d3.range(data.length).reverse();},"default":d3_layout_stackOrderDefault});var d3_layout_stackOffsets=d3.map({silhouette:function(data){var n=data.length,m=data[0].length,sums=[],max=0,i,j,o,y0=[];for(j=0;j<m;++j){for(i=0,o=0;i<n;i++)o+=data[i][j][1];if(o>max)max=o;sums.push(o);}
for(j=0;j<m;++j){y0[j]=(max-sums[j])/2;}
return y0;},wiggle:function(data){var n=data.length,x=data[0],m=x.length,i,j,k,s1,s2,s3,dx,o,o0,y0=[];y0[0]=o=o0=0;for(j=1;j<m;++j){for(i=0,s1=0;i<n;++i)s1+=data[i][j][1];for(i=0,s2=0,dx=x[j][0]-x[j-1][0];i<n;++i){for(k=0,s3=(data[i][j][1]-data[i][j-1][1])/(2*dx);k<i;++k){s3+=(data[k][j][1]-data[k][j-1][1])/dx;}
s2+=s3*data[i][j][1];}
y0[j]=o-=s1?s2/s1*dx:0;if(o<o0)o0=o;}
for(j=0;j<m;++j)y0[j]-=o0;return y0;},expand:function(data){var n=data.length,m=data[0].length,k=1/n,i,j,o,y0=[];for(j=0;j<m;++j){for(i=0,o=0;i<n;i++)o+=data[i][j][1];if(o)for(i=0;i<n;i++)data[i][j][1]/=o;else for(i=0;i<n;i++)data[i][j][1]=k;}
for(j=0;j<m;++j)y0[j]=0;return y0;},zero:d3_layout_stackOffsetZero});function d3_layout_stackOrderDefault(data){return d3.range(data.length);}
function d3_layout_stackOffsetZero(data){var j=-1,m=data[0].length,y0=[];while(++j<m)y0[j]=0;return y0;}
function d3_layout_stackMaxIndex(array){var i=1,j=0,v=array[0][1],k,n=array.length;for(;i<n;++i){if((k=array[i][1])>v){j=i;v=k;}}
return j;}
function d3_layout_stackReduceSum(d){return d.reduce(d3_layout_stackSum,0);}
function d3_layout_stackSum(p,d){return p+d[1];}
d3.layout.histogram=function(){var frequency=true,valuer=Number,ranger=d3_layout_histogramRange,binner=d3_layout_histogramBinSturges;function histogram(data,i){var bins=[],values=data.map(valuer,this),range=ranger.call(this,values,i),thresholds=binner.call(this,range,values,i),bin,i=-1,n=values.length,m=thresholds.length-1,k=frequency?1:1/n,x;while(++i<m){bin=bins[i]=[];bin.dx=thresholds[i+1]-(bin.x=thresholds[i]);bin.y=0;}
if(m>0){i=-1;while(++i<n){x=values[i];if(x>=range[0]&&x<=range[1]){bin=bins[d3.bisect(thresholds,x,1,m)-1];bin.y+=k;bin.push(data[i]);}}}
return bins;}
histogram.value=function(x){if(!arguments.length)return valuer;valuer=x;return histogram;};histogram.range=function(x){if(!arguments.length)return ranger;ranger=d3_functor(x);return histogram;};histogram.bins=function(x){if(!arguments.length)return binner;binner=typeof x==="number"?function(range){return d3_layout_histogramBinFixed(range,x);}:d3_functor(x);return histogram;};histogram.frequency=function(x){if(!arguments.length)return frequency;frequency=!!x;return histogram;};return histogram;};function d3_layout_histogramBinSturges(range,values){return d3_layout_histogramBinFixed(range,Math.ceil(Math.log(values.length)/Math.LN2+1));}
function d3_layout_histogramBinFixed(range,n){var x=-1,b=+range[0],m=(range[1]-b)/n,f=[];while(++x<=n)f[x]=m*x+b;return f;}
function d3_layout_histogramRange(values){return[d3.min(values),d3.max(values)];}
d3.layout.tree=function(){var hierarchy=d3.layout.hierarchy().sort(null).value(null),separation=d3_layout_treeSeparation,size=[1,1],nodeSize=false;function tree(d,i){var nodes=hierarchy.call(this,d,i),root=nodes[0];function firstWalk(node,previousSibling){var children=node.children,layout=node._tree;if(children&&(n=children.length)){var n,firstChild=children[0],previousChild,ancestor=firstChild,child,i=-1;while(++i<n){child=children[i];firstWalk(child,previousChild);ancestor=apportion(child,previousChild,ancestor);previousChild=child;}
d3_layout_treeShift(node);var midpoint=.5*(firstChild._tree.prelim+child._tree.prelim);if(previousSibling){layout.prelim=previousSibling._tree.prelim+separation(node,previousSibling);layout.mod=layout.prelim-midpoint;}else{layout.prelim=midpoint;}}else{if(previousSibling){layout.prelim=previousSibling._tree.prelim+separation(node,previousSibling);}}}
function secondWalk(node,x){node.x=node._tree.prelim+x;var children=node.children;if(children&&(n=children.length)){var i=-1,n;x+=node._tree.mod;while(++i<n){secondWalk(children[i],x);}}}
function apportion(node,previousSibling,ancestor){if(previousSibling){var vip=node,vop=node,vim=previousSibling,vom=node.parent.children[0],sip=vip._tree.mod,sop=vop._tree.mod,sim=vim._tree.mod,som=vom._tree.mod,shift;while(vim=d3_layout_treeRight(vim),vip=d3_layout_treeLeft(vip),vim&&vip){vom=d3_layout_treeLeft(vom);vop=d3_layout_treeRight(vop);vop._tree.ancestor=node;shift=vim._tree.prelim+sim-vip._tree.prelim-sip+separation(vim,vip);if(shift>0){d3_layout_treeMove(d3_layout_treeAncestor(vim,node,ancestor),node,shift);sip+=shift;sop+=shift;}
sim+=vim._tree.mod;sip+=vip._tree.mod;som+=vom._tree.mod;sop+=vop._tree.mod;}
if(vim&&!d3_layout_treeRight(vop)){vop._tree.thread=vim;vop._tree.mod+=sim-sop;}
if(vip&&!d3_layout_treeLeft(vom)){vom._tree.thread=vip;vom._tree.mod+=sip-som;ancestor=node;}}
return ancestor;}
d3_layout_treeVisitAfter(root,function(node,previousSibling){node._tree={ancestor:node,prelim:0,mod:0,change:0,shift:0,number:previousSibling?previousSibling._tree.number+1:0};});firstWalk(root);secondWalk(root,-root._tree.prelim);var left=d3_layout_treeSearch(root,d3_layout_treeLeftmost),right=d3_layout_treeSearch(root,d3_layout_treeRightmost),deep=d3_layout_treeSearch(root,d3_layout_treeDeepest),x0=left.x-separation(left,right)/2,x1=right.x+separation(right,left)/2,y1=deep.depth||1;d3_layout_treeVisitAfter(root,nodeSize?function(node){node.x*=size[0];node.y=node.depth*size[1];delete node._tree;}:function(node){node.x=(node.x-x0)/(x1-x0)*size[0];node.y=node.depth/y1*size[1];delete node._tree;});return nodes;}
tree.separation=function(x){if(!arguments.length)return separation;separation=x;return tree;};tree.size=function(x){if(!arguments.length)return nodeSize?null:size;nodeSize=(size=x)==null;return tree;};tree.nodeSize=function(x){if(!arguments.length)return nodeSize?size:null;nodeSize=(size=x)!=null;return tree;};return d3_layout_hierarchyRebind(tree,hierarchy);};function d3_layout_treeSeparation(a,b){return a.parent==b.parent?1:2;}
function d3_layout_treeLeft(node){var children=node.children;return children&&children.length?children[0]:node._tree.thread;}
function d3_layout_treeRight(node){var children=node.children,n;return children&&(n=children.length)?children[n-1]:node._tree.thread;}
function d3_layout_treeSearch(node,compare){var children=node.children;if(children&&(n=children.length)){var child,n,i=-1;while(++i<n){if(compare(child=d3_layout_treeSearch(children[i],compare),node)>0){node=child;}}}
return node;}
function d3_layout_treeRightmost(a,b){return a.x-b.x;}
function d3_layout_treeLeftmost(a,b){return b.x-a.x;}
function d3_layout_treeDeepest(a,b){return a.depth-b.depth;}
function d3_layout_treeVisitAfter(node,callback){function visit(node,previousSibling){var children=node.children;if(children&&(n=children.length)){var child,previousChild=null,i=-1,n;while(++i<n){child=children[i];visit(child,previousChild);previousChild=child;}}
callback(node,previousSibling);}
visit(node,null);}
function d3_layout_treeShift(node){var shift=0,change=0,children=node.children,i=children.length,child;while(--i>=0){child=children[i]._tree;child.prelim+=shift;child.mod+=shift;shift+=child.shift+(change+=child.change);}}
function d3_layout_treeMove(ancestor,node,shift){ancestor=ancestor._tree;node=node._tree;var change=shift/(node.number-ancestor.number);ancestor.change+=change;node.change-=change;node.shift+=shift;node.prelim+=shift;node.mod+=shift;}
function d3_layout_treeAncestor(vim,node,ancestor){return vim._tree.ancestor.parent==node.parent?vim._tree.ancestor:ancestor;}
d3.layout.pack=function(){var hierarchy=d3.layout.hierarchy().sort(d3_layout_packSort),padding=0,size=[1,1],radius;function pack(d,i){var nodes=hierarchy.call(this,d,i),root=nodes[0],w=size[0],h=size[1],r=radius==null?Math.sqrt:typeof radius==="function"?radius:function(){return radius;};root.x=root.y=0;d3_layout_treeVisitAfter(root,function(d){d.r=+r(d.value);});d3_layout_treeVisitAfter(root,d3_layout_packSiblings);if(padding){var dr=padding*(radius?1:Math.max(2*root.r/w,2*root.r/h))/2;d3_layout_treeVisitAfter(root,function(d){d.r+=dr;});d3_layout_treeVisitAfter(root,d3_layout_packSiblings);d3_layout_treeVisitAfter(root,function(d){d.r-=dr;});}
d3_layout_packTransform(root,w/2,h/2,radius?1:1/Math.max(2*root.r/w,2*root.r/h));return nodes;}
pack.size=function(_){if(!arguments.length)return size;size=_;return pack;};pack.radius=function(_){if(!arguments.length)return radius;radius=_==null||typeof _==="function"?_:+_;return pack;};pack.padding=function(_){if(!arguments.length)return padding;padding=+_;return pack;};return d3_layout_hierarchyRebind(pack,hierarchy);};function d3_layout_packSort(a,b){return a.value-b.value;}
function d3_layout_packInsert(a,b){var c=a._pack_next;a._pack_next=b;b._pack_prev=a;b._pack_next=c;c._pack_prev=b;}
function d3_layout_packSplice(a,b){a._pack_next=b;b._pack_prev=a;}
function d3_layout_packIntersects(a,b){var dx=b.x-a.x,dy=b.y-a.y,dr=a.r+b.r;return.999*dr*dr>dx*dx+dy*dy;}
function d3_layout_packSiblings(node){if(!(nodes=node.children)||!(n=nodes.length))return;var nodes,xMin=Infinity,xMax=-Infinity,yMin=Infinity,yMax=-Infinity,a,b,c,i,j,k,n;function bound(node){xMin=Math.min(node.x-node.r,xMin);xMax=Math.max(node.x+node.r,xMax);yMin=Math.min(node.y-node.r,yMin);yMax=Math.max(node.y+node.r,yMax);}
nodes.forEach(d3_layout_packLink);a=nodes[0];a.x=-a.r;a.y=0;bound(a);if(n>1){b=nodes[1];b.x=b.r;b.y=0;bound(b);if(n>2){c=nodes[2];d3_layout_packPlace(a,b,c);bound(c);d3_layout_packInsert(a,c);a._pack_prev=c;d3_layout_packInsert(c,b);b=a._pack_next;for(i=3;i<n;i++){d3_layout_packPlace(a,b,c=nodes[i]);var isect=0,s1=1,s2=1;for(j=b._pack_next;j!==b;j=j._pack_next,s1++){if(d3_layout_packIntersects(j,c)){isect=1;break;}}
if(isect==1){for(k=a._pack_prev;k!==j._pack_prev;k=k._pack_prev,s2++){if(d3_layout_packIntersects(k,c)){break;}}}
if(isect){if(s1<s2||s1==s2&&b.r<a.r)d3_layout_packSplice(a,b=j);else d3_layout_packSplice(a=k,b);i--;}else{d3_layout_packInsert(a,c);b=c;bound(c);}}}}
var cx=(xMin+xMax)/2,cy=(yMin+yMax)/2,cr=0;for(i=0;i<n;i++){c=nodes[i];c.x-=cx;c.y-=cy;cr=Math.max(cr,c.r+Math.sqrt(c.x*c.x+c.y*c.y));}
node.r=cr;nodes.forEach(d3_layout_packUnlink);}
function d3_layout_packLink(node){node._pack_next=node._pack_prev=node;}
function d3_layout_packUnlink(node){delete node._pack_next;delete node._pack_prev;}
function d3_layout_packTransform(node,x,y,k){var children=node.children;node.x=x+=k*node.x;node.y=y+=k*node.y;node.r*=k;if(children){var i=-1,n=children.length;while(++i<n)d3_layout_packTransform(children[i],x,y,k);}}
function d3_layout_packPlace(a,b,c){var db=a.r+c.r,dx=b.x-a.x,dy=b.y-a.y;if(db&&(dx||dy)){var da=b.r+c.r,dc=dx*dx+dy*dy;da*=da;db*=db;var x=.5+(db-da)/(2*dc),y=Math.sqrt(Math.max(0,2*da*(db+dc)-(db-=dc)*db-da*da))/(2*dc);c.x=a.x+x*dx+y*dy;c.y=a.y+x*dy-y*dx;}else{c.x=a.x+db;c.y=a.y;}}
d3.layout.cluster=function(){var hierarchy=d3.layout.hierarchy().sort(null).value(null),separation=d3_layout_treeSeparation,size=[1,1],nodeSize=false;function cluster(d,i){var nodes=hierarchy.call(this,d,i),root=nodes[0],previousNode,x=0;d3_layout_treeVisitAfter(root,function(node){var children=node.children;if(children&&children.length){node.x=d3_layout_clusterX(children);node.y=d3_layout_clusterY(children);}else{node.x=previousNode?x+=separation(node,previousNode):0;node.y=0;previousNode=node;}});var left=d3_layout_clusterLeft(root),right=d3_layout_clusterRight(root),x0=left.x-separation(left,right)/2,x1=right.x+separation(right,left)/2;d3_layout_treeVisitAfter(root,nodeSize?function(node){node.x=(node.x-root.x)*size[0];node.y=(root.y-node.y)*size[1];}:function(node){node.x=(node.x-x0)/(x1-x0)*size[0];node.y=(1-(root.y?node.y/root.y:1))*size[1];});return nodes;}
cluster.separation=function(x){if(!arguments.length)return separation;separation=x;return cluster;};cluster.size=function(x){if(!arguments.length)return nodeSize?null:size;nodeSize=(size=x)==null;return cluster;};cluster.nodeSize=function(x){if(!arguments.length)return nodeSize?size:null;nodeSize=(size=x)!=null;return cluster;};return d3_layout_hierarchyRebind(cluster,hierarchy);};function d3_layout_clusterY(children){return 1+d3.max(children,function(child){return child.y;});}
function d3_layout_clusterX(children){return children.reduce(function(x,child){return x+child.x;},0)/children.length;}
function d3_layout_clusterLeft(node){var children=node.children;return children&&children.length?d3_layout_clusterLeft(children[0]):node;}
function d3_layout_clusterRight(node){var children=node.children,n;return children&&(n=children.length)?d3_layout_clusterRight(children[n-1]):node;}
d3.layout.treemap=function(){var hierarchy=d3.layout.hierarchy(),round=Math.round,size=[1,1],padding=null,pad=d3_layout_treemapPadNull,sticky=false,stickies,mode="squarify",ratio=.5*(1+Math.sqrt(5));function scale(children,k){var i=-1,n=children.length,child,area;while(++i<n){area=(child=children[i]).value*(k<0?0:k);child.area=isNaN(area)||area<=0?0:area;}}
function squarify(node){var children=node.children;if(children&&children.length){var rect=pad(node),row=[],remaining=children.slice(),child,best=Infinity,score,u=mode==="slice"?rect.dx:mode==="dice"?rect.dy:mode==="slice-dice"?node.depth&1?rect.dy:rect.dx:Math.min(rect.dx,rect.dy),n;scale(remaining,rect.dx*rect.dy/node.value);row.area=0;while((n=remaining.length)>0){row.push(child=remaining[n-1]);row.area+=child.area;if(mode!=="squarify"||(score=worst(row,u))<=best){remaining.pop();best=score;}else{row.area-=row.pop().area;position(row,u,rect,false);u=Math.min(rect.dx,rect.dy);row.length=row.area=0;best=Infinity;}}
if(row.length){position(row,u,rect,true);row.length=row.area=0;}
children.forEach(squarify);}}
function stickify(node){var children=node.children;if(children&&children.length){var rect=pad(node),remaining=children.slice(),child,row=[];scale(remaining,rect.dx*rect.dy/node.value);row.area=0;while(child=remaining.pop()){row.push(child);row.area+=child.area;if(child.z!=null){position(row,child.z?rect.dx:rect.dy,rect,!remaining.length);row.length=row.area=0;}}
children.forEach(stickify);}}
function worst(row,u){var s=row.area,r,rmax=0,rmin=Infinity,i=-1,n=row.length;while(++i<n){if(!(r=row[i].area))continue;if(r<rmin)rmin=r;if(r>rmax)rmax=r;}
s*=s;u*=u;return s?Math.max(u*rmax*ratio/s,s/(u*rmin*ratio)):Infinity;}
function position(row,u,rect,flush){var i=-1,n=row.length,x=rect.x,y=rect.y,v=u?round(row.area/u):0,o;if(u==rect.dx){if(flush||v>rect.dy)v=rect.dy;while(++i<n){o=row[i];o.x=x;o.y=y;o.dy=v;x+=o.dx=Math.min(rect.x+rect.dx-x,v?round(o.area/v):0);}
o.z=true;o.dx+=rect.x+rect.dx-x;rect.y+=v;rect.dy-=v;}else{if(flush||v>rect.dx)v=rect.dx;while(++i<n){o=row[i];o.x=x;o.y=y;o.dx=v;y+=o.dy=Math.min(rect.y+rect.dy-y,v?round(o.area/v):0);}
o.z=false;o.dy+=rect.y+rect.dy-y;rect.x+=v;rect.dx-=v;}}
function treemap(d){var nodes=stickies||hierarchy(d),root=nodes[0];root.x=0;root.y=0;root.dx=size[0];root.dy=size[1];if(stickies)hierarchy.revalue(root);scale([root],root.dx*root.dy/root.value);(stickies?stickify:squarify)(root);if(sticky)stickies=nodes;return nodes;}
treemap.size=function(x){if(!arguments.length)return size;size=x;return treemap;};treemap.padding=function(x){if(!arguments.length)return padding;function padFunction(node){var p=x.call(treemap,node,node.depth);return p==null?d3_layout_treemapPadNull(node):d3_layout_treemapPad(node,typeof p==="number"?[p,p,p,p]:p);}
function padConstant(node){return d3_layout_treemapPad(node,x);}
var type;pad=(padding=x)==null?d3_layout_treemapPadNull:(type=typeof x)==="function"?padFunction:type==="number"?(x=[x,x,x,x],padConstant):padConstant;return treemap;};treemap.round=function(x){if(!arguments.length)return round!=Number;round=x?Math.round:Number;return treemap;};treemap.sticky=function(x){if(!arguments.length)return sticky;sticky=x;stickies=null;return treemap;};treemap.ratio=function(x){if(!arguments.length)return ratio;ratio=x;return treemap;};treemap.mode=function(x){if(!arguments.length)return mode;mode=x+"";return treemap;};return d3_layout_hierarchyRebind(treemap,hierarchy);};function d3_layout_treemapPadNull(node){return{x:node.x,y:node.y,dx:node.dx,dy:node.dy};}
function d3_layout_treemapPad(node,padding){var x=node.x+padding[3],y=node.y+padding[0],dx=node.dx-padding[1]-padding[3],dy=node.dy-padding[0]-padding[2];if(dx<0){x+=dx/2;dx=0;}
if(dy<0){y+=dy/2;dy=0;}
return{x:x,y:y,dx:dx,dy:dy};}
d3.random={normal:function(µ,σ){var n=arguments.length;if(n<2)σ=1;if(n<1)µ=0;return function(){var x,y,r;do{x=Math.random()*2-1;y=Math.random()*2-1;r=x*x+y*y;}while(!r||r>1);return µ+σ*x*Math.sqrt(-2*Math.log(r)/r);};},logNormal:function(){var random=d3.random.normal.apply(d3,arguments);return function(){return Math.exp(random());};},bates:function(m){var random=d3.random.irwinHall(m);return function(){return random()/m;};},irwinHall:function(m){return function(){for(var s=0,j=0;j<m;j++)s+=Math.random();return s;};}};d3.scale={};function d3_scaleExtent(domain){var start=domain[0],stop=domain[domain.length-1];return start<stop?[start,stop]:[stop,start];}
function d3_scaleRange(scale){return scale.rangeExtent?scale.rangeExtent():d3_scaleExtent(scale.range());}
function d3_scale_bilinear(domain,range,uninterpolate,interpolate){var u=uninterpolate(domain[0],domain[1]),i=interpolate(range[0],range[1]);return function(x){return i(u(x));};}
function d3_scale_nice(domain,nice){var i0=0,i1=domain.length-1,x0=domain[i0],x1=domain[i1],dx;if(x1<x0){dx=i0,i0=i1,i1=dx;dx=x0,x0=x1,x1=dx;}
domain[i0]=nice.floor(x0);domain[i1]=nice.ceil(x1);return domain;}
function d3_scale_niceStep(step){return step?{floor:function(x){return Math.floor(x/step)*step;},ceil:function(x){return Math.ceil(x/step)*step;}}:d3_scale_niceIdentity;}
var d3_scale_niceIdentity={floor:d3_identity,ceil:d3_identity};function d3_scale_polylinear(domain,range,uninterpolate,interpolate){var u=[],i=[],j=0,k=Math.min(domain.length,range.length)-1;if(domain[k]<domain[0]){domain=domain.slice().reverse();range=range.slice().reverse();}
while(++j<=k){u.push(uninterpolate(domain[j-1],domain[j]));i.push(interpolate(range[j-1],range[j]));}
return function(x){var j=d3.bisect(domain,x,1,k)-1;return i[j](u[j](x));};}
d3.scale.linear=function(){return d3_scale_linear([0,1],[0,1],d3_interpolate,false);};function d3_scale_linear(domain,range,interpolate,clamp){var output,input;function rescale(){var linear=Math.min(domain.length,range.length)>2?d3_scale_polylinear:d3_scale_bilinear,uninterpolate=clamp?d3_uninterpolateClamp:d3_uninterpolateNumber;output=linear(domain,range,uninterpolate,interpolate);input=linear(range,domain,uninterpolate,d3_interpolate);return scale;}
function scale(x){return output(x);}
scale.invert=function(y){return input(y);};scale.domain=function(x){if(!arguments.length)return domain;domain=x.map(Number);return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.rangeRound=function(x){return scale.range(x).interpolate(d3_interpolateRound);};scale.clamp=function(x){if(!arguments.length)return clamp;clamp=x;return rescale();};scale.interpolate=function(x){if(!arguments.length)return interpolate;interpolate=x;return rescale();};scale.ticks=function(m){return d3_scale_linearTicks(domain,m);};scale.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};scale.nice=function(m){d3_scale_linearNice(domain,m);return rescale();};scale.copy=function(){return d3_scale_linear(domain,range,interpolate,clamp);};return rescale();}
function d3_scale_linearRebind(scale,linear){return d3.rebind(scale,linear,"range","rangeRound","interpolate","clamp");}
function d3_scale_linearNice(domain,m){return d3_scale_nice(domain,d3_scale_niceStep(d3_scale_linearTickRange(domain,m)[2]));}
function d3_scale_linearTickRange(domain,m){if(m==null)m=10;var extent=d3_scaleExtent(domain),span=extent[1]-extent[0],step=Math.pow(10,Math.floor(Math.log(span/m)/Math.LN10)),err=m/span*step;if(err<=.15)step*=10;else if(err<=.35)step*=5;else if(err<=.75)step*=2;extent[0]=Math.ceil(extent[0]/step)*step;extent[1]=Math.floor(extent[1]/step)*step+step*.5;extent[2]=step;return extent;}
function d3_scale_linearTicks(domain,m){return d3.range.apply(d3,d3_scale_linearTickRange(domain,m));}
function d3_scale_linearTickFormat(domain,m,format){var range=d3_scale_linearTickRange(domain,m);if(format){var match=d3_format_re.exec(format);match.shift();if(match[8]==="s"){var prefix=d3.formatPrefix(Math.max(abs(range[0]),abs(range[1])));if(!match[7])match[7]="."+d3_scale_linearPrecision(prefix.scale(range[2]));match[8]="f";format=d3.format(match.join(""));return function(d){return format(prefix.scale(d))+prefix.symbol;};}
if(!match[7])match[7]="."+d3_scale_linearFormatPrecision(match[8],range);format=match.join("");}else{format=",."+d3_scale_linearPrecision(range[2])+"f";}
return d3.format(format);}
var d3_scale_linearFormatSignificant={s:1,g:1,p:1,r:1,e:1};function d3_scale_linearPrecision(value){return-Math.floor(Math.log(value)/Math.LN10+.01);}
function d3_scale_linearFormatPrecision(type,range){var p=d3_scale_linearPrecision(range[2]);return type in d3_scale_linearFormatSignificant?Math.abs(p-d3_scale_linearPrecision(Math.max(abs(range[0]),abs(range[1]))))+(+(type!=="e")):p-(type==="%")*2;}
d3.scale.log=function(){return d3_scale_log(d3.scale.linear().domain([0,1]),10,true,[1,10]);};function d3_scale_log(linear,base,positive,domain){function log(x){return(positive?Math.log(x<0?0:x):-Math.log(x>0?0:-x))/Math.log(base);}
function pow(x){return positive?Math.pow(base,x):-Math.pow(base,-x);}
function scale(x){return linear(log(x));}
scale.invert=function(x){return pow(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return domain;positive=x[0]>=0;linear.domain((domain=x.map(Number)).map(log));return scale;};scale.base=function(_){if(!arguments.length)return base;base=+_;linear.domain(domain.map(log));return scale;};scale.nice=function(){var niced=d3_scale_nice(domain.map(log),positive?Math:d3_scale_logNiceNegative);linear.domain(niced);domain=niced.map(pow);return scale;};scale.ticks=function(){var extent=d3_scaleExtent(domain),ticks=[],u=extent[0],v=extent[1],i=Math.floor(log(u)),j=Math.ceil(log(v)),n=base%1?2:base;if(isFinite(j-i)){if(positive){for(;i<j;i++)for(var k=1;k<n;k++)ticks.push(pow(i)*k);ticks.push(pow(i));}else{ticks.push(pow(i));for(;i++<j;)for(var k=n-1;k>0;k--)ticks.push(pow(i)*k);}
for(i=0;ticks[i]<u;i++){}
for(j=ticks.length;ticks[j-1]>v;j--){}
ticks=ticks.slice(i,j);}
return ticks;};scale.tickFormat=function(n,format){if(!arguments.length)return d3_scale_logFormat;if(arguments.length<2)format=d3_scale_logFormat;else if(typeof format!=="function")format=d3.format(format);var k=Math.max(.1,n/scale.ticks().length),f=positive?(e=1e-12,Math.ceil):(e=-1e-12,Math.floor),e;return function(d){return d/pow(f(log(d)+e))<=k?format(d):"";};};scale.copy=function(){return d3_scale_log(linear.copy(),base,positive,domain);};return d3_scale_linearRebind(scale,linear);}
var d3_scale_logFormat=d3.format(".0e"),d3_scale_logNiceNegative={floor:function(x){return-Math.ceil(-x);},ceil:function(x){return-Math.floor(-x);}};d3.scale.pow=function(){return d3_scale_pow(d3.scale.linear(),1,[0,1]);};function d3_scale_pow(linear,exponent,domain){var powp=d3_scale_powPow(exponent),powb=d3_scale_powPow(1/exponent);function scale(x){return linear(powp(x));}
scale.invert=function(x){return powb(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return domain;linear.domain((domain=x.map(Number)).map(powp));return scale;};scale.ticks=function(m){return d3_scale_linearTicks(domain,m);};scale.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};scale.nice=function(m){return scale.domain(d3_scale_linearNice(domain,m));};scale.exponent=function(x){if(!arguments.length)return exponent;powp=d3_scale_powPow(exponent=x);powb=d3_scale_powPow(1/exponent);linear.domain(domain.map(powp));return scale;};scale.copy=function(){return d3_scale_pow(linear.copy(),exponent,domain);};return d3_scale_linearRebind(scale,linear);}
function d3_scale_powPow(e){return function(x){return x<0?-Math.pow(-x,e):Math.pow(x,e);};}
d3.scale.sqrt=function(){return d3.scale.pow().exponent(.5);};d3.scale.ordinal=function(){return d3_scale_ordinal([],{t:"range",a:[[]]});};function d3_scale_ordinal(domain,ranger){var index,range,rangeBand;function scale(x){return range[((index.get(x)||(ranger.t==="range"?index.set(x,domain.push(x)):NaN))-1)%range.length];}
function steps(start,step){return d3.range(domain.length).map(function(i){return start+step*i;});}
scale.domain=function(x){if(!arguments.length)return domain;domain=[];index=new d3_Map();var i=-1,n=x.length,xi;while(++i<n)if(!index.has(xi=x[i]))index.set(xi,domain.push(xi));return scale[ranger.t].apply(scale,ranger.a);};scale.range=function(x){if(!arguments.length)return range;range=x;rangeBand=0;ranger={t:"range",a:arguments};return scale;};scale.rangePoints=function(x,padding){if(arguments.length<2)padding=0;var start=x[0],stop=x[1],step=(stop-start)/(Math.max(1,domain.length-1)+padding);range=steps(domain.length<2?(start+stop)/2:start+step*padding/2,step);rangeBand=0;ranger={t:"rangePoints",a:arguments};return scale;};scale.rangeBands=function(x,padding,outerPadding){if(arguments.length<2)padding=0;if(arguments.length<3)outerPadding=padding;var reverse=x[1]<x[0],start=x[reverse-0],stop=x[1-reverse],step=(stop-start)/(domain.length-padding+2*outerPadding);range=steps(start+step*outerPadding,step);if(reverse)range.reverse();rangeBand=step*(1-padding);ranger={t:"rangeBands",a:arguments};return scale;};scale.rangeRoundBands=function(x,padding,outerPadding){if(arguments.length<2)padding=0;if(arguments.length<3)outerPadding=padding;var reverse=x[1]<x[0],start=x[reverse-0],stop=x[1-reverse],step=Math.floor((stop-start)/(domain.length-padding+2*outerPadding)),error=stop-start-(domain.length-padding)*step;range=steps(start+Math.round(error/2),step);if(reverse)range.reverse();rangeBand=Math.round(step*(1-padding));ranger={t:"rangeRoundBands",a:arguments};return scale;};scale.rangeBand=function(){return rangeBand;};scale.rangeExtent=function(){return d3_scaleExtent(ranger.a[0]);};scale.copy=function(){return d3_scale_ordinal(domain,ranger);};return scale.domain(domain);}
d3.scale.category10=function(){return d3.scale.ordinal().range(d3_category10);};d3.scale.category20=function(){return d3.scale.ordinal().range(d3_category20);};d3.scale.category20b=function(){return d3.scale.ordinal().range(d3_category20b);};d3.scale.category20c=function(){return d3.scale.ordinal().range(d3_category20c);};var d3_category10=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(d3_rgbString);var d3_category20=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(d3_rgbString);var d3_category20b=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(d3_rgbString);var d3_category20c=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(d3_rgbString);d3.scale.quantile=function(){return d3_scale_quantile([],[]);};function d3_scale_quantile(domain,range){var thresholds;function rescale(){var k=0,q=range.length;thresholds=[];while(++k<q)thresholds[k-1]=d3.quantile(domain,k/q);return scale;}
function scale(x){if(!isNaN(x=+x))return range[d3.bisect(thresholds,x)];}
scale.domain=function(x){if(!arguments.length)return domain;domain=x.filter(d3_number).sort(d3_ascending);return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.quantiles=function(){return thresholds;};scale.invertExtent=function(y){y=range.indexOf(y);return y<0?[NaN,NaN]:[y>0?thresholds[y-1]:domain[0],y<thresholds.length?thresholds[y]:domain[domain.length-1]];};scale.copy=function(){return d3_scale_quantile(domain,range);};return rescale();}
d3.scale.quantize=function(){return d3_scale_quantize(0,1,[0,1]);};function d3_scale_quantize(x0,x1,range){var kx,i;function scale(x){return range[Math.max(0,Math.min(i,Math.floor(kx*(x-x0))))];}
function rescale(){kx=range.length/(x1-x0);i=range.length-1;return scale;}
scale.domain=function(x){if(!arguments.length)return[x0,x1];x0=+x[0];x1=+x[x.length-1];return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.invertExtent=function(y){y=range.indexOf(y);y=y<0?NaN:y/kx+x0;return[y,y+1/kx];};scale.copy=function(){return d3_scale_quantize(x0,x1,range);};return rescale();}
d3.scale.threshold=function(){return d3_scale_threshold([.5],[0,1]);};function d3_scale_threshold(domain,range){function scale(x){if(x<=x)return range[d3.bisect(domain,x)];}
scale.domain=function(_){if(!arguments.length)return domain;domain=_;return scale;};scale.range=function(_){if(!arguments.length)return range;range=_;return scale;};scale.invertExtent=function(y){y=range.indexOf(y);return[domain[y-1],domain[y]];};scale.copy=function(){return d3_scale_threshold(domain,range);};return scale;}
d3.scale.identity=function(){return d3_scale_identity([0,1]);};function d3_scale_identity(domain){function identity(x){return+x;}
identity.invert=identity;identity.domain=identity.range=function(x){if(!arguments.length)return domain;domain=x.map(identity);return identity;};identity.ticks=function(m){return d3_scale_linearTicks(domain,m);};identity.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};identity.copy=function(){return d3_scale_identity(domain);};return identity;}
d3.svg={};d3.svg.arc=function(){var innerRadius=d3_svg_arcInnerRadius,outerRadius=d3_svg_arcOuterRadius,startAngle=d3_svg_arcStartAngle,endAngle=d3_svg_arcEndAngle;function arc(){var r0=innerRadius.apply(this,arguments),r1=outerRadius.apply(this,arguments),a0=startAngle.apply(this,arguments)+d3_svg_arcOffset,a1=endAngle.apply(this,arguments)+d3_svg_arcOffset,da=(a1<a0&&(da=a0,a0=a1,a1=da),a1-a0),df=da<π?"0":"1",c0=Math.cos(a0),s0=Math.sin(a0),c1=Math.cos(a1),s1=Math.sin(a1);return da>=d3_svg_arcMax?r0?"M0,"+r1+"A"+r1+","+r1+" 0 1,1 0,"+-r1+"A"+r1+","+r1+" 0 1,1 0,"+r1+"M0,"+r0+"A"+r0+","+r0+" 0 1,0 0,"+-r0+"A"+r0+","+r0+" 0 1,0 0,"+r0+"Z":"M0,"+r1+"A"+r1+","+r1+" 0 1,1 0,"+-r1+"A"+r1+","+r1+" 0 1,1 0,"+r1+"Z":r0?"M"+r1*c0+","+r1*s0+"A"+r1+","+r1+" 0 "+df+",1 "+r1*c1+","+r1*s1+"L"+r0*c1+","+r0*s1+"A"+r0+","+r0+" 0 "+df+",0 "+r0*c0+","+r0*s0+"Z":"M"+r1*c0+","+r1*s0+"A"+r1+","+r1+" 0 "+df+",1 "+r1*c1+","+r1*s1+"L0,0"+"Z";}
arc.innerRadius=function(v){if(!arguments.length)return innerRadius;innerRadius=d3_functor(v);return arc;};arc.outerRadius=function(v){if(!arguments.length)return outerRadius;outerRadius=d3_functor(v);return arc;};arc.startAngle=function(v){if(!arguments.length)return startAngle;startAngle=d3_functor(v);return arc;};arc.endAngle=function(v){if(!arguments.length)return endAngle;endAngle=d3_functor(v);return arc;};arc.centroid=function(){var r=(innerRadius.apply(this,arguments)+outerRadius.apply(this,arguments))/2,a=(startAngle.apply(this,arguments)+endAngle.apply(this,arguments))/2+d3_svg_arcOffset;return[Math.cos(a)*r,Math.sin(a)*r];};return arc;};var d3_svg_arcOffset=-halfπ,d3_svg_arcMax=τ-ε;function d3_svg_arcInnerRadius(d){return d.innerRadius;}
function d3_svg_arcOuterRadius(d){return d.outerRadius;}
function d3_svg_arcStartAngle(d){return d.startAngle;}
function d3_svg_arcEndAngle(d){return d.endAngle;}
function d3_svg_line(projection){var x=d3_geom_pointX,y=d3_geom_pointY,defined=d3_true,interpolate=d3_svg_lineLinear,interpolateKey=interpolate.key,tension=.7;function line(data){var segments=[],points=[],i=-1,n=data.length,d,fx=d3_functor(x),fy=d3_functor(y);function segment(){segments.push("M",interpolate(projection(points),tension));}
while(++i<n){if(defined.call(this,d=data[i],i)){points.push([+fx.call(this,d,i),+fy.call(this,d,i)]);}else if(points.length){segment();points=[];}}
if(points.length)segment();return segments.length?segments.join(""):null;}
line.x=function(_){if(!arguments.length)return x;x=_;return line;};line.y=function(_){if(!arguments.length)return y;y=_;return line;};line.defined=function(_){if(!arguments.length)return defined;defined=_;return line;};line.interpolate=function(_){if(!arguments.length)return interpolateKey;if(typeof _==="function")interpolateKey=interpolate=_;else interpolateKey=(interpolate=d3_svg_lineInterpolators.get(_)||d3_svg_lineLinear).key;return line;};line.tension=function(_){if(!arguments.length)return tension;tension=_;return line;};return line;}
d3.svg.line=function(){return d3_svg_line(d3_identity);};var d3_svg_lineInterpolators=d3.map({linear:d3_svg_lineLinear,"linear-closed":d3_svg_lineLinearClosed,step:d3_svg_lineStep,"step-before":d3_svg_lineStepBefore,"step-after":d3_svg_lineStepAfter,basis:d3_svg_lineBasis,"basis-open":d3_svg_lineBasisOpen,"basis-closed":d3_svg_lineBasisClosed,bundle:d3_svg_lineBundle,cardinal:d3_svg_lineCardinal,"cardinal-open":d3_svg_lineCardinalOpen,"cardinal-closed":d3_svg_lineCardinalClosed,monotone:d3_svg_lineMonotone});d3_svg_lineInterpolators.forEach(function(key,value){value.key=key;value.closed=/-closed$/.test(key);});function d3_svg_lineLinear(points){return points.join("L");}
function d3_svg_lineLinearClosed(points){return d3_svg_lineLinear(points)+"Z";}
function d3_svg_lineStep(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n)path.push("H",(p[0]+(p=points[i])[0])/2,"V",p[1]);if(n>1)path.push("H",p[0]);return path.join("");}
function d3_svg_lineStepBefore(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n)path.push("V",(p=points[i])[1],"H",p[0]);return path.join("");}
function d3_svg_lineStepAfter(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n)path.push("H",(p=points[i])[0],"V",p[1]);return path.join("");}
function d3_svg_lineCardinalOpen(points,tension){return points.length<4?d3_svg_lineLinear(points):points[1]+d3_svg_lineHermite(points.slice(1,points.length-1),d3_svg_lineCardinalTangents(points,tension));}
function d3_svg_lineCardinalClosed(points,tension){return points.length<3?d3_svg_lineLinear(points):points[0]+d3_svg_lineHermite((points.push(points[0]),points),d3_svg_lineCardinalTangents([points[points.length-2]].concat(points,[points[1]]),tension));}
function d3_svg_lineCardinal(points,tension){return points.length<3?d3_svg_lineLinear(points):points[0]+d3_svg_lineHermite(points,d3_svg_lineCardinalTangents(points,tension));}
function d3_svg_lineHermite(points,tangents){if(tangents.length<1||points.length!=tangents.length&&points.length!=tangents.length+2){return d3_svg_lineLinear(points);}
var quad=points.length!=tangents.length,path="",p0=points[0],p=points[1],t0=tangents[0],t=t0,pi=1;if(quad){path+="Q"+(p[0]-t0[0]*2/3)+","+(p[1]-t0[1]*2/3)+","+p[0]+","+p[1];p0=points[1];pi=2;}
if(tangents.length>1){t=tangents[1];p=points[pi];pi++;path+="C"+(p0[0]+t0[0])+","+(p0[1]+t0[1])+","+(p[0]-t[0])+","+(p[1]-t[1])+","+p[0]+","+p[1];for(var i=2;i<tangents.length;i++,pi++){p=points[pi];t=tangents[i];path+="S"+(p[0]-t[0])+","+(p[1]-t[1])+","+p[0]+","+p[1];}}
if(quad){var lp=points[pi];path+="Q"+(p[0]+t[0]*2/3)+","+(p[1]+t[1]*2/3)+","+lp[0]+","+lp[1];}
return path;}
function d3_svg_lineCardinalTangents(points,tension){var tangents=[],a=(1-tension)/2,p0,p1=points[0],p2=points[1],i=1,n=points.length;while(++i<n){p0=p1;p1=p2;p2=points[i];tangents.push([a*(p2[0]-p0[0]),a*(p2[1]-p0[1])]);}
return tangents;}
function d3_svg_lineBasis(points){if(points.length<3)return d3_svg_lineLinear(points);var i=1,n=points.length,pi=points[0],x0=pi[0],y0=pi[1],px=[x0,x0,x0,(pi=points[1])[0]],py=[y0,y0,y0,pi[1]],path=[x0,",",y0,"L",d3_svg_lineDot4(d3_svg_lineBasisBezier3,px),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,py)];points.push(points[n-1]);while(++i<=n){pi=points[i];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}
points.pop();path.push("L",pi);return path.join("");}
function d3_svg_lineBasisOpen(points){if(points.length<4)return d3_svg_lineLinear(points);var path=[],i=-1,n=points.length,pi,px=[0],py=[0];while(++i<3){pi=points[i];px.push(pi[0]);py.push(pi[1]);}
path.push(d3_svg_lineDot4(d3_svg_lineBasisBezier3,px)+","+d3_svg_lineDot4(d3_svg_lineBasisBezier3,py));--i;while(++i<n){pi=points[i];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}
return path.join("");}
function d3_svg_lineBasisClosed(points){var path,i=-1,n=points.length,m=n+4,pi,px=[],py=[];while(++i<4){pi=points[i%n];px.push(pi[0]);py.push(pi[1]);}
path=[d3_svg_lineDot4(d3_svg_lineBasisBezier3,px),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,py)];--i;while(++i<m){pi=points[i%n];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}
return path.join("");}
function d3_svg_lineBundle(points,tension){var n=points.length-1;if(n){var x0=points[0][0],y0=points[0][1],dx=points[n][0]-x0,dy=points[n][1]-y0,i=-1,p,t;while(++i<=n){p=points[i];t=i/n;p[0]=tension*p[0]+(1-tension)*(x0+t*dx);p[1]=tension*p[1]+(1-tension)*(y0+t*dy);}}
return d3_svg_lineBasis(points);}
function d3_svg_lineDot4(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3];}
var d3_svg_lineBasisBezier1=[0,2/3,1/3,0],d3_svg_lineBasisBezier2=[0,1/3,2/3,0],d3_svg_lineBasisBezier3=[0,1/6,2/3,1/6];function d3_svg_lineBasisBezier(path,x,y){path.push("C",d3_svg_lineDot4(d3_svg_lineBasisBezier1,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier1,y),",",d3_svg_lineDot4(d3_svg_lineBasisBezier2,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier2,y),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,y));}
function d3_svg_lineSlope(p0,p1){return(p1[1]-p0[1])/(p1[0]-p0[0]);}
function d3_svg_lineFiniteDifferences(points){var i=0,j=points.length-1,m=[],p0=points[0],p1=points[1],d=m[0]=d3_svg_lineSlope(p0,p1);while(++i<j){m[i]=(d+(d=d3_svg_lineSlope(p0=p1,p1=points[i+1])))/2;}
m[i]=d;return m;}
function d3_svg_lineMonotoneTangents(points){var tangents=[],d,a,b,s,m=d3_svg_lineFiniteDifferences(points),i=-1,j=points.length-1;while(++i<j){d=d3_svg_lineSlope(points[i],points[i+1]);if(abs(d)<ε){m[i]=m[i+1]=0;}else{a=m[i]/d;b=m[i+1]/d;s=a*a+b*b;if(s>9){s=d*3/Math.sqrt(s);m[i]=s*a;m[i+1]=s*b;}}}
i=-1;while(++i<=j){s=(points[Math.min(j,i+1)][0]-points[Math.max(0,i-1)][0])/(6*(1+m[i]*m[i]));tangents.push([s||0,m[i]*s||0]);}
return tangents;}
function d3_svg_lineMonotone(points){return points.length<3?d3_svg_lineLinear(points):points[0]+d3_svg_lineHermite(points,d3_svg_lineMonotoneTangents(points));}
d3.svg.line.radial=function(){var line=d3_svg_line(d3_svg_lineRadial);line.radius=line.x,delete line.x;line.angle=line.y,delete line.y;return line;};function d3_svg_lineRadial(points){var point,i=-1,n=points.length,r,a;while(++i<n){point=points[i];r=point[0];a=point[1]+d3_svg_arcOffset;point[0]=r*Math.cos(a);point[1]=r*Math.sin(a);}
return points;}
function d3_svg_area(projection){var x0=d3_geom_pointX,x1=d3_geom_pointX,y0=0,y1=d3_geom_pointY,defined=d3_true,interpolate=d3_svg_lineLinear,interpolateKey=interpolate.key,interpolateReverse=interpolate,L="L",tension=.7;function area(data){var segments=[],points0=[],points1=[],i=-1,n=data.length,d,fx0=d3_functor(x0),fy0=d3_functor(y0),fx1=x0===x1?function(){return x;}:d3_functor(x1),fy1=y0===y1?function(){return y;}:d3_functor(y1),x,y;function segment(){segments.push("M",interpolate(projection(points1),tension),L,interpolateReverse(projection(points0.reverse()),tension),"Z");}
while(++i<n){if(defined.call(this,d=data[i],i)){points0.push([x=+fx0.call(this,d,i),y=+fy0.call(this,d,i)]);points1.push([+fx1.call(this,d,i),+fy1.call(this,d,i)]);}else if(points0.length){segment();points0=[];points1=[];}}
if(points0.length)segment();return segments.length?segments.join(""):null;}
area.x=function(_){if(!arguments.length)return x1;x0=x1=_;return area;};area.x0=function(_){if(!arguments.length)return x0;x0=_;return area;};area.x1=function(_){if(!arguments.length)return x1;x1=_;return area;};area.y=function(_){if(!arguments.length)return y1;y0=y1=_;return area;};area.y0=function(_){if(!arguments.length)return y0;y0=_;return area;};area.y1=function(_){if(!arguments.length)return y1;y1=_;return area;};area.defined=function(_){if(!arguments.length)return defined;defined=_;return area;};area.interpolate=function(_){if(!arguments.length)return interpolateKey;if(typeof _==="function")interpolateKey=interpolate=_;else interpolateKey=(interpolate=d3_svg_lineInterpolators.get(_)||d3_svg_lineLinear).key;interpolateReverse=interpolate.reverse||interpolate;L=interpolate.closed?"M":"L";return area;};area.tension=function(_){if(!arguments.length)return tension;tension=_;return area;};return area;}
d3_svg_lineStepBefore.reverse=d3_svg_lineStepAfter;d3_svg_lineStepAfter.reverse=d3_svg_lineStepBefore;d3.svg.area=function(){return d3_svg_area(d3_identity);};d3.svg.area.radial=function(){var area=d3_svg_area(d3_svg_lineRadial);area.radius=area.x,delete area.x;area.innerRadius=area.x0,delete area.x0;area.outerRadius=area.x1,delete area.x1;area.angle=area.y,delete area.y;area.startAngle=area.y0,delete area.y0;area.endAngle=area.y1,delete area.y1;return area;};d3.svg.chord=function(){var source=d3_source,target=d3_target,radius=d3_svg_chordRadius,startAngle=d3_svg_arcStartAngle,endAngle=d3_svg_arcEndAngle;function chord(d,i){var s=subgroup(this,source,d,i),t=subgroup(this,target,d,i);return"M"+s.p0+arc(s.r,s.p1,s.a1-s.a0)+(equals(s,t)?curve(s.r,s.p1,s.r,s.p0):curve(s.r,s.p1,t.r,t.p0)+arc(t.r,t.p1,t.a1-t.a0)+curve(t.r,t.p1,s.r,s.p0))+"Z";}
function subgroup(self,f,d,i){var subgroup=f.call(self,d,i),r=radius.call(self,subgroup,i),a0=startAngle.call(self,subgroup,i)+d3_svg_arcOffset,a1=endAngle.call(self,subgroup,i)+d3_svg_arcOffset;return{r:r,a0:a0,a1:a1,p0:[r*Math.cos(a0),r*Math.sin(a0)],p1:[r*Math.cos(a1),r*Math.sin(a1)]};}
function equals(a,b){return a.a0==b.a0&&a.a1==b.a1;}
function arc(r,p,a){return"A"+r+","+r+" 0 "+(+(a>π))+",1 "+p;}
function curve(r0,p0,r1,p1){return"Q 0,0 "+p1;}
chord.radius=function(v){if(!arguments.length)return radius;radius=d3_functor(v);return chord;};chord.source=function(v){if(!arguments.length)return source;source=d3_functor(v);return chord;};chord.target=function(v){if(!arguments.length)return target;target=d3_functor(v);return chord;};chord.startAngle=function(v){if(!arguments.length)return startAngle;startAngle=d3_functor(v);return chord;};chord.endAngle=function(v){if(!arguments.length)return endAngle;endAngle=d3_functor(v);return chord;};return chord;};function d3_svg_chordRadius(d){return d.radius;}
d3.svg.diagonal=function(){var source=d3_source,target=d3_target,projection=d3_svg_diagonalProjection;function diagonal(d,i){var p0=source.call(this,d,i),p3=target.call(this,d,i),m=(p0.y+p3.y)/2,p=[p0,{x:p0.x,y:m},{x:p3.x,y:m},p3];p=p.map(projection);return"M"+p[0]+"C"+p[1]+" "+p[2]+" "+p[3];}
diagonal.source=function(x){if(!arguments.length)return source;source=d3_functor(x);return diagonal;};diagonal.target=function(x){if(!arguments.length)return target;target=d3_functor(x);return diagonal;};diagonal.projection=function(x){if(!arguments.length)return projection;projection=x;return diagonal;};return diagonal;};function d3_svg_diagonalProjection(d){return[d.x,d.y];}
d3.svg.diagonal.radial=function(){var diagonal=d3.svg.diagonal(),projection=d3_svg_diagonalProjection,projection_=diagonal.projection;diagonal.projection=function(x){return arguments.length?projection_(d3_svg_diagonalRadialProjection(projection=x)):projection;};return diagonal;};function d3_svg_diagonalRadialProjection(projection){return function(){var d=projection.apply(this,arguments),r=d[0],a=d[1]+d3_svg_arcOffset;return[r*Math.cos(a),r*Math.sin(a)];};}
d3.svg.symbol=function(){var type=d3_svg_symbolType,size=d3_svg_symbolSize;function symbol(d,i){return(d3_svg_symbols.get(type.call(this,d,i))||d3_svg_symbolCircle)(size.call(this,d,i));}
symbol.type=function(x){if(!arguments.length)return type;type=d3_functor(x);return symbol;};symbol.size=function(x){if(!arguments.length)return size;size=d3_functor(x);return symbol;};return symbol;};function d3_svg_symbolSize(){return 64;}
function d3_svg_symbolType(){return"circle";}
function d3_svg_symbolCircle(size){var r=Math.sqrt(size/π);return"M0,"+r+"A"+r+","+r+" 0 1,1 0,"+-r+"A"+r+","+r+" 0 1,1 0,"+r+"Z";}
var d3_svg_symbols=d3.map({circle:d3_svg_symbolCircle,cross:function(size){var r=Math.sqrt(size/5)/2;return"M"+-3*r+","+-r+"H"+-r+"V"+-3*r+"H"+r+"V"+-r+"H"+3*r+"V"+r+"H"+r+"V"+3*r+"H"+-r+"V"+r+"H"+-3*r+"Z";},diamond:function(size){var ry=Math.sqrt(size/(2*d3_svg_symbolTan30)),rx=ry*d3_svg_symbolTan30;return"M0,"+-ry+"L"+rx+",0"+" 0,"+ry+" "+-rx+",0"+"Z";},square:function(size){var r=Math.sqrt(size)/2;return"M"+-r+","+-r+"L"+r+","+-r+" "+r+","+r+" "+-r+","+r+"Z";},"triangle-down":function(size){var rx=Math.sqrt(size/d3_svg_symbolSqrt3),ry=rx*d3_svg_symbolSqrt3/2;return"M0,"+ry+"L"+rx+","+-ry+" "+-rx+","+-ry+"Z";},"triangle-up":function(size){var rx=Math.sqrt(size/d3_svg_symbolSqrt3),ry=rx*d3_svg_symbolSqrt3/2;return"M0,"+-ry+"L"+rx+","+ry+" "+-rx+","+ry+"Z";}});d3.svg.symbolTypes=d3_svg_symbols.keys();var d3_svg_symbolSqrt3=Math.sqrt(3),d3_svg_symbolTan30=Math.tan(30*d3_radians);function d3_transition(groups,id){d3_subclass(groups,d3_transitionPrototype);groups.id=id;return groups;}
var d3_transitionPrototype=[],d3_transitionId=0,d3_transitionInheritId,d3_transitionInherit;d3_transitionPrototype.call=d3_selectionPrototype.call;d3_transitionPrototype.empty=d3_selectionPrototype.empty;d3_transitionPrototype.node=d3_selectionPrototype.node;d3_transitionPrototype.size=d3_selectionPrototype.size;d3.transition=function(selection){return arguments.length?d3_transitionInheritId?selection.transition():selection:d3_selectionRoot.transition();};d3.transition.prototype=d3_transitionPrototype;d3_transitionPrototype.select=function(selector){var id=this.id,subgroups=[],subgroup,subnode,node;selector=d3_selection_selector(selector);for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);for(var group=this[j],i=-1,n=group.length;++i<n;){if((node=group[i])&&(subnode=selector.call(node,node.__data__,i,j))){if("__data__"in node)subnode.__data__=node.__data__;d3_transitionNode(subnode,i,id,node.__transition__[id]);subgroup.push(subnode);}else{subgroup.push(null);}}}
return d3_transition(subgroups,id);};d3_transitionPrototype.selectAll=function(selector){var id=this.id,subgroups=[],subgroup,subnodes,node,subnode,transition;selector=d3_selection_selectorAll(selector);for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i]){transition=node.__transition__[id];subnodes=selector.call(node,node.__data__,i,j);subgroups.push(subgroup=[]);for(var k=-1,o=subnodes.length;++k<o;){if(subnode=subnodes[k])d3_transitionNode(subnode,k,id,transition);subgroup.push(subnode);}}}}
return d3_transition(subgroups,id);};d3_transitionPrototype.filter=function(filter){var subgroups=[],subgroup,group,node;if(typeof filter!=="function")filter=d3_selection_filter(filter);for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);for(var group=this[j],i=0,n=group.length;i<n;i++){if((node=group[i])&&filter.call(node,node.__data__,i,j)){subgroup.push(node);}}}
return d3_transition(subgroups,this.id);};d3_transitionPrototype.tween=function(name,tween){var id=this.id;if(arguments.length<2)return this.node().__transition__[id].tween.get(name);return d3_selection_each(this,tween==null?function(node){node.__transition__[id].tween.remove(name);}:function(node){node.__transition__[id].tween.set(name,tween);});};function d3_transition_tween(groups,name,value,tween){var id=groups.id;return d3_selection_each(groups,typeof value==="function"?function(node,i,j){node.__transition__[id].tween.set(name,tween(value.call(node,node.__data__,i,j)));}:(value=tween(value),function(node){node.__transition__[id].tween.set(name,value);}));}
d3_transitionPrototype.attr=function(nameNS,value){if(arguments.length<2){for(value in nameNS)this.attr(value,nameNS[value]);return this;}
var interpolate=nameNS=="transform"?d3_interpolateTransform:d3_interpolate,name=d3.ns.qualify(nameNS);function attrNull(){this.removeAttribute(name);}
function attrNullNS(){this.removeAttributeNS(name.space,name.local);}
function attrTween(b){return b==null?attrNull:(b+="",function(){var a=this.getAttribute(name),i;return a!==b&&(i=interpolate(a,b),function(t){this.setAttribute(name,i(t));});});}
function attrTweenNS(b){return b==null?attrNullNS:(b+="",function(){var a=this.getAttributeNS(name.space,name.local),i;return a!==b&&(i=interpolate(a,b),function(t){this.setAttributeNS(name.space,name.local,i(t));});});}
return d3_transition_tween(this,"attr."+nameNS,value,name.local?attrTweenNS:attrTween);};d3_transitionPrototype.attrTween=function(nameNS,tween){var name=d3.ns.qualify(nameNS);function attrTween(d,i){var f=tween.call(this,d,i,this.getAttribute(name));return f&&function(t){this.setAttribute(name,f(t));};}
function attrTweenNS(d,i){var f=tween.call(this,d,i,this.getAttributeNS(name.space,name.local));return f&&function(t){this.setAttributeNS(name.space,name.local,f(t));};}
return this.tween("attr."+nameNS,name.local?attrTweenNS:attrTween);};d3_transitionPrototype.style=function(name,value,priority){var n=arguments.length;if(n<3){if(typeof name!=="string"){if(n<2)value="";for(priority in name)this.style(priority,name[priority],value);return this;}
priority="";}
function styleNull(){this.style.removeProperty(name);}
function styleString(b){return b==null?styleNull:(b+="",function(){var a=d3_window.getComputedStyle(this,null).getPropertyValue(name),i;return a!==b&&(i=d3_interpolate(a,b),function(t){this.style.setProperty(name,i(t),priority);});});}
return d3_transition_tween(this,"style."+name,value,styleString);};d3_transitionPrototype.styleTween=function(name,tween,priority){if(arguments.length<3)priority="";function styleTween(d,i){var f=tween.call(this,d,i,d3_window.getComputedStyle(this,null).getPropertyValue(name));return f&&function(t){this.style.setProperty(name,f(t),priority);};}
return this.tween("style."+name,styleTween);};d3_transitionPrototype.text=function(value){return d3_transition_tween(this,"text",value,d3_transition_text);};function d3_transition_text(b){if(b==null)b="";return function(){this.textContent=b;};}
d3_transitionPrototype.remove=function(){return this.each("end.transition",function(){var p;if(this.__transition__.count<2&&(p=this.parentNode))p.removeChild(this);});};d3_transitionPrototype.ease=function(value){var id=this.id;if(arguments.length<1)return this.node().__transition__[id].ease;if(typeof value!=="function")value=d3.ease.apply(d3,arguments);return d3_selection_each(this,function(node){node.__transition__[id].ease=value;});};d3_transitionPrototype.delay=function(value){var id=this.id;if(arguments.length<1)return this.node().__transition__[id].delay;return d3_selection_each(this,typeof value==="function"?function(node,i,j){node.__transition__[id].delay=+value.call(node,node.__data__,i,j);}:(value=+value,function(node){node.__transition__[id].delay=value;}));};d3_transitionPrototype.duration=function(value){var id=this.id;if(arguments.length<1)return this.node().__transition__[id].duration;return d3_selection_each(this,typeof value==="function"?function(node,i,j){node.__transition__[id].duration=Math.max(1,value.call(node,node.__data__,i,j));}:(value=Math.max(1,value),function(node){node.__transition__[id].duration=value;}));};d3_transitionPrototype.each=function(type,listener){var id=this.id;if(arguments.length<2){var inherit=d3_transitionInherit,inheritId=d3_transitionInheritId;d3_transitionInheritId=id;d3_selection_each(this,function(node,i,j){d3_transitionInherit=node.__transition__[id];type.call(node,node.__data__,i,j);});d3_transitionInherit=inherit;d3_transitionInheritId=inheritId;}else{d3_selection_each(this,function(node){var transition=node.__transition__[id];(transition.event||(transition.event=d3.dispatch("start","end"))).on(type,listener);});}
return this;};d3_transitionPrototype.transition=function(){var id0=this.id,id1=++d3_transitionId,subgroups=[],subgroup,group,node,transition;for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);for(var group=this[j],i=0,n=group.length;i<n;i++){if(node=group[i]){transition=Object.create(node.__transition__[id0]);transition.delay+=transition.duration;d3_transitionNode(node,i,id1,transition);}
subgroup.push(node);}}
return d3_transition(subgroups,id1);};function d3_transitionNode(node,i,id,inherit){var lock=node.__transition__||(node.__transition__={active:0,count:0}),transition=lock[id];if(!transition){var time=inherit.time;transition=lock[id]={tween:new d3_Map(),time:time,ease:inherit.ease,delay:inherit.delay,duration:inherit.duration};++lock.count;d3.timer(function(elapsed){var d=node.__data__,ease=transition.ease,delay=transition.delay,duration=transition.duration,timer=d3_timer_active,tweened=[];timer.t=delay+time;if(delay<=elapsed)return start(elapsed-delay);timer.c=start;function start(elapsed){if(lock.active>id)return stop();lock.active=id;transition.event&&transition.event.start.call(node,d,i);transition.tween.forEach(function(key,value){if(value=value.call(node,d,i)){tweened.push(value);}});d3.timer(function(){timer.c=tick(elapsed||1)?d3_true:tick;return 1;},0,time);}
function tick(elapsed){if(lock.active!==id)return stop();var t=elapsed/duration,e=ease(t),n=tweened.length;while(n>0){tweened[--n].call(node,e);}
if(t>=1){transition.event&&transition.event.end.call(node,d,i);return stop();}}
function stop(){if(--lock.count)delete lock[id];else delete node.__transition__;return 1;}},0,time);}}
d3.svg.axis=function(){var scale=d3.scale.linear(),orient=d3_svg_axisDefaultOrient,innerTickSize=6,outerTickSize=6,tickPadding=3,tickArguments_=[10],tickValues=null,tickFormat_;function axis(g){g.each(function(){var g=d3.select(this);var scale0=this.__chart__||scale,scale1=this.__chart__=scale.copy();var ticks=tickValues==null?scale1.ticks?scale1.ticks.apply(scale1,tickArguments_):scale1.domain():tickValues,tickFormat=tickFormat_==null?scale1.tickFormat?scale1.tickFormat.apply(scale1,tickArguments_):d3_identity:tickFormat_,tick=g.selectAll(".tick").data(ticks,scale1),tickEnter=tick.enter().insert("g",".domain").attr("class","tick").style("opacity",ε),tickExit=d3.transition(tick.exit()).style("opacity",ε).remove(),tickUpdate=d3.transition(tick.order()).style("opacity",1),tickTransform;var range=d3_scaleRange(scale1),path=g.selectAll(".domain").data([0]),pathUpdate=(path.enter().append("path").attr("class","domain"),d3.transition(path));tickEnter.append("line");tickEnter.append("text");var lineEnter=tickEnter.select("line"),lineUpdate=tickUpdate.select("line"),text=tick.select("text").text(tickFormat),textEnter=tickEnter.select("text"),textUpdate=tickUpdate.select("text");switch(orient){case"bottom":{tickTransform=d3_svg_axisX;lineEnter.attr("y2",innerTickSize);textEnter.attr("y",Math.max(innerTickSize,0)+tickPadding);lineUpdate.attr("x2",0).attr("y2",innerTickSize);textUpdate.attr("x",0).attr("y",Math.max(innerTickSize,0)+tickPadding);text.attr("dy",".71em").style("text-anchor","middle");pathUpdate.attr("d","M"+range[0]+","+outerTickSize+"V0H"+range[1]+"V"+outerTickSize);break;}
case"top":{tickTransform=d3_svg_axisX;lineEnter.attr("y2",-innerTickSize);textEnter.attr("y",-(Math.max(innerTickSize,0)+tickPadding));lineUpdate.attr("x2",0).attr("y2",-innerTickSize);textUpdate.attr("x",0).attr("y",-(Math.max(innerTickSize,0)+tickPadding));text.attr("dy","0em").style("text-anchor","middle");pathUpdate.attr("d","M"+range[0]+","+-outerTickSize+"V0H"+range[1]+"V"+-outerTickSize);break;}
case"left":{tickTransform=d3_svg_axisY;lineEnter.attr("x2",-innerTickSize);textEnter.attr("x",-(Math.max(innerTickSize,0)+tickPadding));lineUpdate.attr("x2",-innerTickSize).attr("y2",0);textUpdate.attr("x",-(Math.max(innerTickSize,0)+tickPadding)).attr("y",0);text.attr("dy",".32em").style("text-anchor","end");pathUpdate.attr("d","M"+-outerTickSize+","+range[0]+"H0V"+range[1]+"H"+-outerTickSize);break;}
case"right":{tickTransform=d3_svg_axisY;lineEnter.attr("x2",innerTickSize);textEnter.attr("x",Math.max(innerTickSize,0)+tickPadding);lineUpdate.attr("x2",innerTickSize).attr("y2",0);textUpdate.attr("x",Math.max(innerTickSize,0)+tickPadding).attr("y",0);text.attr("dy",".32em").style("text-anchor","start");pathUpdate.attr("d","M"+outerTickSize+","+range[0]+"H0V"+range[1]+"H"+outerTickSize);break;}}
if(scale1.rangeBand){var x=scale1,dx=x.rangeBand()/2;scale0=scale1=function(d){return x(d)+dx;};}else if(scale0.rangeBand){scale0=scale1;}else{tickExit.call(tickTransform,scale1);}
tickEnter.call(tickTransform,scale0);tickUpdate.call(tickTransform,scale1);});}
axis.scale=function(x){if(!arguments.length)return scale;scale=x;return axis;};axis.orient=function(x){if(!arguments.length)return orient;orient=x in d3_svg_axisOrients?x+"":d3_svg_axisDefaultOrient;return axis;};axis.ticks=function(){if(!arguments.length)return tickArguments_;tickArguments_=arguments;return axis;};axis.tickValues=function(x){if(!arguments.length)return tickValues;tickValues=x;return axis;};axis.tickFormat=function(x){if(!arguments.length)return tickFormat_;tickFormat_=x;return axis;};axis.tickSize=function(x){var n=arguments.length;if(!n)return innerTickSize;innerTickSize=+x;outerTickSize=+arguments[n-1];return axis;};axis.innerTickSize=function(x){if(!arguments.length)return innerTickSize;innerTickSize=+x;return axis;};axis.outerTickSize=function(x){if(!arguments.length)return outerTickSize;outerTickSize=+x;return axis;};axis.tickPadding=function(x){if(!arguments.length)return tickPadding;tickPadding=+x;return axis;};axis.tickSubdivide=function(){return arguments.length&&axis;};return axis;};var d3_svg_axisDefaultOrient="bottom",d3_svg_axisOrients={top:1,right:1,bottom:1,left:1};function d3_svg_axisX(selection,x){selection.attr("transform",function(d){return"translate("+x(d)+",0)";});}
function d3_svg_axisY(selection,y){selection.attr("transform",function(d){return"translate(0,"+y(d)+")";});}
d3.svg.brush=function(){var event=d3_eventDispatch(brush,"brushstart","brush","brushend"),x=null,y=null,xExtent=[0,0],yExtent=[0,0],xExtentDomain,yExtentDomain,xClamp=true,yClamp=true,resizes=d3_svg_brushResizes[0];function brush(g){g.each(function(){var g=d3.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",brushstart).on("touchstart.brush",brushstart);var background=g.selectAll(".background").data([0]);background.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair");g.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var resize=g.selectAll(".resize").data(resizes,d3_identity);resize.exit().remove();resize.enter().append("g").attr("class",function(d){return"resize "+d;}).style("cursor",function(d){return d3_svg_brushCursor[d];}).append("rect").attr("x",function(d){return/[ew]$/.test(d)?-3:null;}).attr("y",function(d){return/^[ns]/.test(d)?-3:null;}).attr("width",6).attr("height",6).style("visibility","hidden");resize.style("display",brush.empty()?"none":null);var gUpdate=d3.transition(g),backgroundUpdate=d3.transition(background),range;if(x){range=d3_scaleRange(x);backgroundUpdate.attr("x",range[0]).attr("width",range[1]-range[0]);redrawX(gUpdate);}
if(y){range=d3_scaleRange(y);backgroundUpdate.attr("y",range[0]).attr("height",range[1]-range[0]);redrawY(gUpdate);}
redraw(gUpdate);});}
brush.event=function(g){g.each(function(){var event_=event.of(this,arguments),extent1={x:xExtent,y:yExtent,i:xExtentDomain,j:yExtentDomain},extent0=this.__chart__||extent1;this.__chart__=extent1;if(d3_transitionInheritId){d3.select(this).transition().each("start.brush",function(){xExtentDomain=extent0.i;yExtentDomain=extent0.j;xExtent=extent0.x;yExtent=extent0.y;event_({type:"brushstart"});}).tween("brush:brush",function(){var xi=d3_interpolateArray(xExtent,extent1.x),yi=d3_interpolateArray(yExtent,extent1.y);xExtentDomain=yExtentDomain=null;return function(t){xExtent=extent1.x=xi(t);yExtent=extent1.y=yi(t);event_({type:"brush",mode:"resize"});};}).each("end.brush",function(){xExtentDomain=extent1.i;yExtentDomain=extent1.j;event_({type:"brush",mode:"resize"});event_({type:"brushend"});});}else{event_({type:"brushstart"});event_({type:"brush",mode:"resize"});event_({type:"brushend"});}});};function redraw(g){g.selectAll(".resize").attr("transform",function(d){return"translate("+xExtent[+/e$/.test(d)]+","+yExtent[+/^s/.test(d)]+")";});}
function redrawX(g){g.select(".extent").attr("x",xExtent[0]);g.selectAll(".extent,.n>rect,.s>rect").attr("width",xExtent[1]-xExtent[0]);}
function redrawY(g){g.select(".extent").attr("y",yExtent[0]);g.selectAll(".extent,.e>rect,.w>rect").attr("height",yExtent[1]-yExtent[0]);}
function brushstart(){var target=this,eventTarget=d3.select(d3.event.target),event_=event.of(target,arguments),g=d3.select(target),resizing=eventTarget.datum(),resizingX=!/^(n|s)$/.test(resizing)&&x,resizingY=!/^(e|w)$/.test(resizing)&&y,dragging=eventTarget.classed("extent"),dragRestore=d3_event_dragSuppress(),center,origin=d3.mouse(target),offset;var w=d3.select(d3_window).on("keydown.brush",keydown).on("keyup.brush",keyup);if(d3.event.changedTouches){w.on("touchmove.brush",brushmove).on("touchend.brush",brushend);}else{w.on("mousemove.brush",brushmove).on("mouseup.brush",brushend);}
g.interrupt().selectAll("*").interrupt();if(dragging){origin[0]=xExtent[0]-origin[0];origin[1]=yExtent[0]-origin[1];}else if(resizing){var ex=+/w$/.test(resizing),ey=+/^n/.test(resizing);offset=[xExtent[1-ex]-origin[0],yExtent[1-ey]-origin[1]];origin[0]=xExtent[ex];origin[1]=yExtent[ey];}else if(d3.event.altKey)center=origin.slice();g.style("pointer-events","none").selectAll(".resize").style("display",null);d3.select("body").style("cursor",eventTarget.style("cursor"));event_({type:"brushstart"});brushmove();function keydown(){if(d3.event.keyCode==32){if(!dragging){center=null;origin[0]-=xExtent[1];origin[1]-=yExtent[1];dragging=2;}
d3_eventPreventDefault();}}
function keyup(){if(d3.event.keyCode==32&&dragging==2){origin[0]+=xExtent[1];origin[1]+=yExtent[1];dragging=0;d3_eventPreventDefault();}}
function brushmove(){var point=d3.mouse(target),moved=false;if(offset){point[0]+=offset[0];point[1]+=offset[1];}
if(!dragging){if(d3.event.altKey){if(!center)center=[(xExtent[0]+xExtent[1])/2,(yExtent[0]+yExtent[1])/2];origin[0]=xExtent[+(point[0]<center[0])];origin[1]=yExtent[+(point[1]<center[1])];}else center=null;}
if(resizingX&&move1(point,x,0)){redrawX(g);moved=true;}
if(resizingY&&move1(point,y,1)){redrawY(g);moved=true;}
if(moved){redraw(g);event_({type:"brush",mode:dragging?"move":"resize"});}}
function move1(point,scale,i){var range=d3_scaleRange(scale),r0=range[0],r1=range[1],position=origin[i],extent=i?yExtent:xExtent,size=extent[1]-extent[0],min,max;if(dragging){r0-=position;r1-=size+position;}
min=(i?yClamp:xClamp)?Math.max(r0,Math.min(r1,point[i])):point[i];if(dragging){max=(min+=position)+size;}else{if(center)position=Math.max(r0,Math.min(r1,2*center[i]-min));if(position<min){max=min;min=position;}else{max=position;}}
if(extent[0]!=min||extent[1]!=max){if(i)yExtentDomain=null;else xExtentDomain=null;extent[0]=min;extent[1]=max;return true;}}
function brushend(){brushmove();g.style("pointer-events","all").selectAll(".resize").style("display",brush.empty()?"none":null);d3.select("body").style("cursor",null);w.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null);dragRestore();event_({type:"brushend"});}}
brush.x=function(z){if(!arguments.length)return x;x=z;resizes=d3_svg_brushResizes[!x<<1|!y];return brush;};brush.y=function(z){if(!arguments.length)return y;y=z;resizes=d3_svg_brushResizes[!x<<1|!y];return brush;};brush.clamp=function(z){if(!arguments.length)return x&&y?[xClamp,yClamp]:x?xClamp:y?yClamp:null;if(x&&y)xClamp=!!z[0],yClamp=!!z[1];else if(x)xClamp=!!z;else if(y)yClamp=!!z;return brush;};brush.extent=function(z){var x0,x1,y0,y1,t;if(!arguments.length){if(x){if(xExtentDomain){x0=xExtentDomain[0],x1=xExtentDomain[1];}else{x0=xExtent[0],x1=xExtent[1];if(x.invert)x0=x.invert(x0),x1=x.invert(x1);if(x1<x0)t=x0,x0=x1,x1=t;}}
if(y){if(yExtentDomain){y0=yExtentDomain[0],y1=yExtentDomain[1];}else{y0=yExtent[0],y1=yExtent[1];if(y.invert)y0=y.invert(y0),y1=y.invert(y1);if(y1<y0)t=y0,y0=y1,y1=t;}}
return x&&y?[[x0,y0],[x1,y1]]:x?[x0,x1]:y&&[y0,y1];}
if(x){x0=z[0],x1=z[1];if(y)x0=x0[0],x1=x1[0];xExtentDomain=[x0,x1];if(x.invert)x0=x(x0),x1=x(x1);if(x1<x0)t=x0,x0=x1,x1=t;if(x0!=xExtent[0]||x1!=xExtent[1])xExtent=[x0,x1];}
if(y){y0=z[0],y1=z[1];if(x)y0=y0[1],y1=y1[1];yExtentDomain=[y0,y1];if(y.invert)y0=y(y0),y1=y(y1);if(y1<y0)t=y0,y0=y1,y1=t;if(y0!=yExtent[0]||y1!=yExtent[1])yExtent=[y0,y1];}
return brush;};brush.clear=function(){if(!brush.empty()){xExtent=[0,0],yExtent=[0,0];xExtentDomain=yExtentDomain=null;}
return brush;};brush.empty=function(){return!!x&&xExtent[0]==xExtent[1]||!!y&&yExtent[0]==yExtent[1];};return d3.rebind(brush,event,"on");};var d3_svg_brushCursor={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"};var d3_svg_brushResizes=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]];var d3_time_format=d3_time.format=d3_locale_enUS.timeFormat;var d3_time_formatUtc=d3_time_format.utc;var d3_time_formatIso=d3_time_formatUtc("%Y-%m-%dT%H:%M:%S.%LZ");d3_time_format.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?d3_time_formatIsoNative:d3_time_formatIso;function d3_time_formatIsoNative(date){return date.toISOString();}
d3_time_formatIsoNative.parse=function(string){var date=new Date(string);return isNaN(date)?null:date;};d3_time_formatIsoNative.toString=d3_time_formatIso.toString;d3_time.second=d3_time_interval(function(date){return new d3_date(Math.floor(date/1e3)*1e3);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*1e3);},function(date){return date.getSeconds();});d3_time.seconds=d3_time.second.range;d3_time.seconds.utc=d3_time.second.utc.range;d3_time.minute=d3_time_interval(function(date){return new d3_date(Math.floor(date/6e4)*6e4);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*6e4);},function(date){return date.getMinutes();});d3_time.minutes=d3_time.minute.range;d3_time.minutes.utc=d3_time.minute.utc.range;d3_time.hour=d3_time_interval(function(date){var timezone=date.getTimezoneOffset()/60;return new d3_date((Math.floor(date/36e5-timezone)+timezone)*36e5);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*36e5);},function(date){return date.getHours();});d3_time.hours=d3_time.hour.range;d3_time.hours.utc=d3_time.hour.utc.range;d3_time.month=d3_time_interval(function(date){date=d3_time.day(date);date.setDate(1);return date;},function(date,offset){date.setMonth(date.getMonth()+offset);},function(date){return date.getMonth();});d3_time.months=d3_time.month.range;d3_time.months.utc=d3_time.month.utc.range;function d3_time_scale(linear,methods,format){function scale(x){return linear(x);}
scale.invert=function(x){return d3_time_scaleDate(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return linear.domain().map(d3_time_scaleDate);linear.domain(x);return scale;};function tickMethod(extent,count){var span=extent[1]-extent[0],target=span/count,i=d3.bisect(d3_time_scaleSteps,target);return i==d3_time_scaleSteps.length?[methods.year,d3_scale_linearTickRange(extent.map(function(d){return d/31536e6;}),count)[2]]:!i?[d3_time_scaleMilliseconds,d3_scale_linearTickRange(extent,count)[2]]:methods[target/d3_time_scaleSteps[i-1]<d3_time_scaleSteps[i]/target?i-1:i];}
scale.nice=function(interval,skip){var domain=scale.domain(),extent=d3_scaleExtent(domain),method=interval==null?tickMethod(extent,10):typeof interval==="number"&&tickMethod(extent,interval);if(method)interval=method[0],skip=method[1];function skipped(date){return!isNaN(date)&&!interval.range(date,d3_time_scaleDate(+date+1),skip).length;}
return scale.domain(d3_scale_nice(domain,skip>1?{floor:function(date){while(skipped(date=interval.floor(date)))date=d3_time_scaleDate(date-1);return date;},ceil:function(date){while(skipped(date=interval.ceil(date)))date=d3_time_scaleDate(+date+1);return date;}}:interval));};scale.ticks=function(interval,skip){var extent=d3_scaleExtent(scale.domain()),method=interval==null?tickMethod(extent,10):typeof interval==="number"?tickMethod(extent,interval):!interval.range&&[{range:interval},skip];if(method)interval=method[0],skip=method[1];return interval.range(extent[0],d3_time_scaleDate(+extent[1]+1),skip<1?1:skip);};scale.tickFormat=function(){return format;};scale.copy=function(){return d3_time_scale(linear.copy(),methods,format);};return d3_scale_linearRebind(scale,linear);}
function d3_time_scaleDate(t){return new Date(t);}
var d3_time_scaleSteps=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6];var d3_time_scaleLocalMethods=[[d3_time.second,1],[d3_time.second,5],[d3_time.second,15],[d3_time.second,30],[d3_time.minute,1],[d3_time.minute,5],[d3_time.minute,15],[d3_time.minute,30],[d3_time.hour,1],[d3_time.hour,3],[d3_time.hour,6],[d3_time.hour,12],[d3_time.day,1],[d3_time.day,2],[d3_time.week,1],[d3_time.month,1],[d3_time.month,3],[d3_time.year,1]];var d3_time_scaleLocalFormat=d3_time_format.multi([[".%L",function(d){return d.getMilliseconds();}],[":%S",function(d){return d.getSeconds();}],["%I:%M",function(d){return d.getMinutes();}],["%I %p",function(d){return d.getHours();}],["%a %d",function(d){return d.getDay()&&d.getDate()!=1;}],["%b %d",function(d){return d.getDate()!=1;}],["%B",function(d){return d.getMonth();}],["%Y",d3_true]]);var d3_time_scaleMilliseconds={range:function(start,stop,step){return d3.range(Math.ceil(start/step)*step,+stop,step).map(d3_time_scaleDate);},floor:d3_identity,ceil:d3_identity};d3_time_scaleLocalMethods.year=d3_time.year;d3_time.scale=function(){return d3_time_scale(d3.scale.linear(),d3_time_scaleLocalMethods,d3_time_scaleLocalFormat);};var d3_time_scaleUtcMethods=d3_time_scaleLocalMethods.map(function(m){return[m[0].utc,m[1]];});var d3_time_scaleUtcFormat=d3_time_formatUtc.multi([[".%L",function(d){return d.getUTCMilliseconds();}],[":%S",function(d){return d.getUTCSeconds();}],["%I:%M",function(d){return d.getUTCMinutes();}],["%I %p",function(d){return d.getUTCHours();}],["%a %d",function(d){return d.getUTCDay()&&d.getUTCDate()!=1;}],["%b %d",function(d){return d.getUTCDate()!=1;}],["%B",function(d){return d.getUTCMonth();}],["%Y",d3_true]]);d3_time_scaleUtcMethods.year=d3_time.year.utc;d3_time.scale.utc=function(){return d3_time_scale(d3.scale.linear(),d3_time_scaleUtcMethods,d3_time_scaleUtcFormat);};d3.text=d3_xhrType(function(request){return request.responseText;});d3.json=function(url,callback){return d3_xhr(url,"application/json",d3_json,callback);};function d3_json(request){return JSON.parse(request.responseText);}
d3.html=function(url,callback){return d3_xhr(url,"text/html",d3_html,callback);};function d3_html(request){var range=d3_document.createRange();range.selectNode(d3_document.body);return range.createContextualFragment(request.responseText);}
d3.xml=d3_xhrType(function(request){return request.responseXML;});if(typeof define==="function"&&define.amd){define(d3);}else if(typeof module==="object"&&module.exports){module.exports=d3;}else{this.d3=d3;}}();
var D3ComponentBase=ChartComponent.extend({defaultWidth:600,defaultHeight:400,update:function(){if(this.parameters==undefined){this.parameters=[];};this.renderChart();},render:function(values){this.customfunction.call(this,values);},cdaResultToD3Array:function(d){var result=[];_.each(d.resultset,function(row,o){var line={};_.each(row,function(cell,idx){line[_.findWhere(d.metadata,{colIndex:idx})["colName"]]=cell;});result.push(line);});return result;},getHeight:function(){var $ph=this.placeholder();return this.height?this.height:($ph.height()>0?$ph.height():this.defaultHeight);},getWidth:function(){var $ph=this.placeholder();return this.width?this.width:($ph.width()>0?$ph.width():this.defaultWidth);}});
var D3ScatterplotMatrixComponent=D3ComponentBase.extend({defaultWidth:600,defaultHeight:136,cellSize:17,_defaultTooltipFormat:function(d,v){return d+": "+v;},render:function(data){var width=this.getWidth();var flowers=this.cdaResultToD3Array(data);var padding=10,traits=_.pluck(data.metadata,"colName").splice(1),n=traits.length,size=Math.floor((width-10)/n),padding=10,species=data.metadata[0].colName,traitsMapper={};var height=width+n*20+40;var entries=_.chain(data.resultset).map(function(d){return d[0]}).uniq().value();entries.map(function(d,idx){traitsMapper[d]=idx});var x={},y={};traits.forEach(function(trait){flowers.forEach(function(d){d[trait]=(+d[trait]);});var value=function(d){return d[trait];},domain=[d3.min(flowers,value),d3.max(flowers,value)],range=[padding/2,size-padding/2];x[trait]=d3.scale.linear().domain(domain).range(range);y[trait]=d3.scale.linear().domain(domain).range(range.slice().reverse());});var axis=d3.svg.axis().ticks(5).tickSize(size*n);var brush=d3.svg.brush().on("brushstart",brushstart).on("brush",brush).on("brushend",brushend);var svg=d3.select("#"+this.htmlObject).selectAll("svg")
var svg=d3.select("#"+this.htmlObject).append("svg:svg").attr("class","d3ScatterplotMatrix").attr("width",width).attr("height",height).append("svg:g")
var legend=svg.selectAll("g.legend").data(entries).enter().append("svg:g").attr("class","legend").attr("transform",function(d,i){return"translate(10,"+(i*20+width+40)+")";});legend.append("svg:circle").attr("class",function(d){return"col"+traitsMapper[d]}).attr("r",3);legend.append("svg:text").attr("x",12).attr("dy",".31em").text(function(d){return d;});svg.selectAll("g.x.axis").data(traits).enter().append("svg:g").attr("class","x axis").attr("transform",function(d,i){return"translate("+i*size+",0)";}).each(function(d){d3.select(this).call(axis.scale(x[d]).orient("bottom"));});svg.selectAll("g.y.axis").data(traits).enter().append("svg:g").attr("class","y axis").attr("transform",function(d,i){return"translate(0,"+i*size+")";}).each(function(d){d3.select(this).call(axis.scale(y[d]).orient("right"));});var cell=svg.selectAll("g.cell").data(cross(traits,traits)).enter().append("svg:g").attr("class","cell").attr("transform",function(d){return"translate("+d.i*size+","+d.j*size+")";}).each(plot);cell.filter(function(d){return d.i==d.j;}).append("svg:text").attr("x",padding).attr("y",padding).attr("dy",".71em").text(function(d){return d.x;});function plot(p){var cell=d3.select(this);cell.append("svg:rect").attr("class","frame").attr("x",padding/2).attr("y",padding/2).attr("width",size-padding).attr("height",size-padding);cell.selectAll("circle").data(flowers).enter().append("svg:circle").attr("class",function(d){return"col"+traitsMapper[d[species]]}).attr("cx",function(d){return x[p.x](d[p.x]);}).attr("cy",function(d){return y[p.y](d[p.y]);}).attr("r",3);cell.call(brush.x(x[p.x]).y(y[p.y]));}
function brushstart(p){if(brush.data!==p){cell.call(brush.clear());brush.x(x[p.x]).y(y[p.y]).data=p;}}
function brush(p){var e=brush.extent();svg.selectAll(".cell circle").attr("class",function(d){return e[0][0]<=d[p.x]&&d[p.x]<=e[1][0]&&e[0][1]<=d[p.y]&&d[p.y]<=e[1][1]?"col"+traitsMapper[d[species]]:null;});}
function brushend(){if(brush.empty())svg.selectAll(".cell circle").attr("class",function(d){return"col"+traitsMapper[d[species]];});}
function cross(a,b){var c=[],n=a.length,m=b.length,i,j;for(i=-1;++i<n;)for(j=-1;++j<m;)c.push({x:a[i],i:i,y:b[j],j:j});return c;}}});
function MotionScatterPlot(dataObject,options){if(typeof options!="object")
throw TypeError;var chartSel=options.chartSel||"#chart";var mot=d3.select(chartSel);var _n,bisect,dot,box,overlay,label,svg,xAxis,yAxis,xScale,yScale,radiusScale,colorScale;var yMax=0;var yMin=9999999;var width=options.width||640;var height=options.height||480;var margin=options.margin||{top:19.5,right:19.5,bottom:19.5,left:39.5};var transDuration=options.transDuration||30000;var chartTitle=options.chartTitle||"";var yAxisText=options.yAxisText||"";_setSize([width,height]);function _setData(d){dataObject=d;}
function x(d){return d.income;}
function y(d){return d.lifeExpectancy;}
function radius(d){return d.population;}
function color(d){return d.region;}
function key(d){return d.name;}
function isArray(e){return toString.call(e)==="[object Array]";}
function _setSize(e){if(!isArray(e))return false;width=e[0]-margin.right-margin.left,height=e[1]-margin.top-margin.bottom;}
function _getSize(){return[width,height];}
function _resize(){_setSize(_getWrapperSize());}
function _setMinAndMaxFromDataObject(){_n=dataObject.slice(0);var arrYears=_n.map(function(d){return d.income.slice(0).map(function(v,i){return v[0];})});for(rw=0;rw<arrYears.length;rw++){yMax=(yMax>Math.max.apply(Math,arrYears[rw]))?yMax:Math.max.apply(Math,arrYears[rw]);yMin=(yMin<Math.min.apply(Math,arrYears[rw]))?yMin:Math.min.apply(Math,arrYears[rw]);}}
function _play(){svg.transition().duration(transDuration).ease("linear").tween("year",tweenYear).each("end",enableInteraction);}
function _getWrapperSize(){return[parseInt(mot.attr("width"),10),parseInt(mot.attr("height"),10)]}
function _createElements(){d3.select('svg').remove();xScale=d3.scale.log().domain([300,1e5]).range([0,width]);yScale=d3.scale.linear().domain([10,85]).range([height,0]);radiusScale=d3.scale.sqrt().domain([0,5e8]).range([0,40]);colorScale=d3.scale.category10();xAxis=d3.svg.axis().orient("bottom").scale(xScale).ticks(12,d3.format(",d"));yAxis=d3.svg.axis().scale(yScale).orient("left");svg=mot.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis);svg.append("g").attr("class","y axis").call(yAxis);svg.append("text").attr("class","x label").attr("text-anchor","end").attr("x",width).attr("y",height-6).text(chartTitle);svg.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(yAxisText);label=svg.append("text").attr("class","year label").attr("text-anchor","end").attr("y",height-24).attr("x",width);return this;}
function _init(){_createElements();_setMinAndMaxFromDataObject();label.text(yMin);bisect=d3.bisector(function(d){return d[0];});dot=svg.append("g").attr("class","dots").selectAll(".dot").data(interpolateData(yMin)).enter().append("circle").attr("class","dot").style("fill",function(d){return colorScale(color(d));}).call(position).sort(order);dot.append("title").text(function(d){return d.name;});box=label.node().getBBox();overlay=svg.append("rect").attr("class","overlay").attr("x",box.x).attr("y",box.y).attr("width",box.width).attr("height",box.height).on("mouseover",enableInteraction);return this;}
function position(dot){dot.attr("cx",function(d){return xScale(x(d));}).attr("cy",function(d){return yScale(y(d));}).attr("r",function(d){return radiusScale(radius(d));});}
function order(a,b){return radius(b)-radius(a);}
function enableInteraction(){var yearScale=d3.scale.linear().domain([yMin,yMax]).range([box.x+10,box.x+box.width-10]).clamp(true);svg.transition().duration(0);overlay.on("mouseover",mouseover).on("mouseout",mouseout).on("mousemove",mousemove).on("touchmove",mousemove);function mouseover(){label.classed("active",true);}
function mouseout(){label.classed("active",false);}
function mousemove(){displayYear(yearScale.invert(d3.mouse(this)[0]));}}
function tweenYear(){var year=d3.interpolateNumber(yMin,yMax);return function(t){displayYear(year(t));};}
function displayYear(year){dot.data(interpolateData(year),key).call(position).sort(order);label.text(Math.round(year));}
function interpolateData(year){return dataObject.map(function(d){return{name:d.name,region:d.region,income:interpolateValues(d.income,year),population:interpolateValues(d.population,year),lifeExpectancy:interpolateValues(d.lifeExpectancy,year)};});}
function interpolateValues(values,year){var i=bisect.left(values,year,0,values.length-1),a=values[i];if(i>0){var b=values[i-1],t=(year-a[0])/(b[0]-a[0]);return a[1]*(1-t)+b[1]*t;}
return a[1];}
function _setSelector(sel){chartSel=sel;mot=d3.select(chartSel);}
return{init:_init,setSize:_setSize,getSize:_getSize,play:_play,resize:_resize,setData:_setData,setSelector:_setSelector};}
var motionChart=new MotionScatterPlot([],{});var D3MotionScatterPlotComponent=D3ComponentBase.extend({render:function(data){var dataObject=[];$.each(data,function(i,val){dataObject.push(val);});motionChart.setData(dataObject);motionChart.setSelector("#exampleObj");motionChart.setSize([$("#exampleObj").width(),400,]);motionChart.init().play();}});
var D3CalendarViewComponent=D3ComponentBase.extend({defaultWidth:600,defaultHeight:136,cellSize:17,_defaultTooltipFormat:function(d,v){return d+": "+v;},render:function(data){var minYear=d3.min(data.resultset,function(d){return d[0].substring(0,4)});var maxYear=d3.max(data.resultset,function(d){return d[0].substring(0,4)});var minValue=d3.min(data.resultset,function(d){return d[1]});var maxValue=d3.max(data.resultset,function(d){return d[1]});var cellSize=Math.floor((this.getWidth()-59)/53);var internalHeight=cellSize*7+17;var width=this.getWidth(),height=this.getHeight();var day=d3.time.format("%w"),week=d3.time.format("%U"),format=d3.time.format("%Y-%m-%d");var color=d3.scale.quantize().domain([minValue,maxValue]).range(d3.range(11).map(function(d){return"q"+d+"-11";}));var svg=d3.select("#"+this.htmlObject).selectAll("svg").data(d3.range(minYear,maxYear)).enter().append("svg").attr("width",width).attr("height",internalHeight).attr("class","RdYlGn").append("g").attr("transform","translate("+((width-cellSize*53)/2)+","+(internalHeight-cellSize*7-1)+")");svg.append("text").attr("transform","translate(-6,"+cellSize*3.5+")rotate(-90)").style("text-anchor","middle").text(function(d){return d;});var rect=svg.selectAll(".day").data(function(d){return d3.time.days(new Date(d,0,1),new Date(d+1,0,1));}).enter().append("rect").attr("class","day").attr("width",cellSize).attr("height",cellSize).attr("x",function(d){return week(d)*cellSize;}).attr("y",function(d){return day(d)*cellSize;}).datum(format);rect.append("title").text(function(d){return d;});svg.selectAll(".month").data(function(d){return d3.time.months(new Date(d,0,1),new Date(d+1,0,1));}).enter().append("path").attr("class","month").attr("d",monthPath);var dataIndexed=[];data.resultset.map(function(d){dataIndexed[d[0]]=d[1];});var tooltipFormat=this.tooltipFormat||this._defaultTooltipFormat;rect.filter(function(d){return d in dataIndexed;}).attr("class",function(d){return"day "+color(dataIndexed[d]);}).select("title").text(function(d){return tooltipFormat(d,dataIndexed[d]);});function monthPath(t0){var t1=new Date(t0.getFullYear(),t0.getMonth()+1,0),d0=+day(t0),w0=+week(t0),d1=+day(t1),w1=+week(t1);return"M"+(w0+1)*cellSize+","+d0*cellSize
+"H"+w0*cellSize+"V"+7*cellSize
+"H"+w1*cellSize+"V"+(d1+1)*cellSize
+"H"+(w1+1)*cellSize+"V"+0
+"H"+(w0+1)*cellSize+"Z";}}});
(function(){d3.box=function(){var width=1,height=1,duration=0,domain=null,value=Number,whiskers=boxWhiskers,quartiles=boxQuartiles,tickFormat=null;function box(g){g.each(function(d,i){d=d.map(value).sort(d3.ascending);var g=d3.select(this),n=d.length,min=d[0],max=d[n-1];var quartileData=d.quartiles=quartiles(d);var whiskerIndices=whiskers&&whiskers.call(this,d,i),whiskerData=whiskerIndices&&whiskerIndices.map(function(i){return d[i];});var outlierIndices=whiskerIndices?d3.range(0,whiskerIndices[0]).concat(d3.range(whiskerIndices[1]+1,n)):d3.range(n);var x1=d3.scale.linear().domain(domain&&domain.call(this,d,i)||[min,max]).range([height,0]);var x0=this.__chart__||d3.scale.linear().domain([0,Infinity]).range(x1.range());this.__chart__=x1;var center=g.selectAll("line.center").data(whiskerData?[whiskerData]:[]);center.enter().insert("line","rect").attr("class","center").attr("x1",width/2).attr("y1",function(d){return x0(d[0]);}).attr("x2",width/2).attr("y2",function(d){return x0(d[1]);}).style("opacity",1e-6).transition().duration(duration).style("opacity",1).attr("y1",function(d){return x1(d[0]);}).attr("y2",function(d){return x1(d[1]);});center.transition().duration(duration).style("opacity",1).attr("y1",function(d){return x1(d[0]);}).attr("y2",function(d){return x1(d[1]);});center.exit().transition().duration(duration).style("opacity",1e-6).attr("y1",function(d){return x1(d[0]);}).attr("y2",function(d){return x1(d[1]);}).remove();var box=g.selectAll("rect.box").data([quartileData]);box.enter().append("rect").attr("class","box").attr("x",0).attr("y",function(d){return x0(d[2]);}).attr("width",width).attr("height",function(d){return x0(d[0])-x0(d[2]);}).transition().duration(duration).attr("y",function(d){return x1(d[2]);}).attr("height",function(d){return x1(d[0])-x1(d[2]);});box.transition().duration(duration).attr("y",function(d){return x1(d[2]);}).attr("height",function(d){return x1(d[0])-x1(d[2]);});var medianLine=g.selectAll("line.median").data([quartileData[1]]);medianLine.enter().append("line").attr("class","median").attr("x1",0).attr("y1",x0).attr("x2",width).attr("y2",x0).transition().duration(duration).attr("y1",x1).attr("y2",x1);medianLine.transition().duration(duration).attr("y1",x1).attr("y2",x1);var whisker=g.selectAll("line.whisker").data(whiskerData||[]);whisker.enter().insert("line","circle, text").attr("class","whisker").attr("x1",0).attr("y1",x0).attr("x2",width).attr("y2",x0).style("opacity",1e-6).transition().duration(duration).attr("y1",x1).attr("y2",x1).style("opacity",1);whisker.transition().duration(duration).attr("y1",x1).attr("y2",x1).style("opacity",1);whisker.exit().transition().duration(duration).attr("y1",x1).attr("y2",x1).style("opacity",1e-6).remove();var outlier=g.selectAll("circle.outlier").data(outlierIndices,Number);outlier.enter().insert("circle","text").attr("class","outlier").attr("r",5).attr("cx",width/2).attr("cy",function(i){return x0(d[i]);}).style("opacity",1e-6).transition().duration(duration).attr("cy",function(i){return x1(d[i]);}).style("opacity",1);outlier.transition().duration(duration).attr("cy",function(i){return x1(d[i]);}).style("opacity",1);outlier.exit().transition().duration(duration).attr("cy",function(i){return x1(d[i]);}).style("opacity",1e-6).remove();var format=tickFormat||x1.tickFormat(8);var boxTick=g.selectAll("text.box").data(quartileData);boxTick.enter().append("text").attr("class","box").attr("dy",".3em").attr("dx",function(d,i){return i&1?6:-6}).attr("x",function(d,i){return i&1?width:0}).attr("y",x0).attr("text-anchor",function(d,i){return i&1?"start":"end";}).text(format).transition().duration(duration).attr("y",x1);boxTick.transition().duration(duration).text(format).attr("y",x1);var whiskerTick=g.selectAll("text.whisker").data(whiskerData||[]);whiskerTick.enter().append("text").attr("class","whisker").attr("dy",".3em").attr("dx",6).attr("x",width).attr("y",x0).text(format).style("opacity",1e-6).transition().duration(duration).attr("y",x1).style("opacity",1);whiskerTick.transition().duration(duration).text(format).attr("y",x1).style("opacity",1);whiskerTick.exit().transition().duration(duration).attr("y",x1).style("opacity",1e-6).remove();});d3.timer.flush();}
box.width=function(x){if(!arguments.length)return width;width=x;return box;};box.height=function(x){if(!arguments.length)return height;height=x;return box;};box.tickFormat=function(x){if(!arguments.length)return tickFormat;tickFormat=x;return box;};box.duration=function(x){if(!arguments.length)return duration;duration=x;return box;};box.domain=function(x){if(!arguments.length)return domain;domain=x==null?x:d3.functor(x);return box;};box.value=function(x){if(!arguments.length)return value;value=x;return box;};box.whiskers=function(x){if(!arguments.length)return whiskers;whiskers=x;return box;};box.quartiles=function(x){if(!arguments.length)return quartiles;quartiles=x;return box;};return box;};function boxWhiskers(d){return[0,d.length-1];}
function boxQuartiles(d){return[d3.quantile(d,.25),d3.quantile(d,.5),d3.quantile(d,.75)];}})();
var D3BoxPlotsComponent=D3ComponentBase.extend({defaultMargin:{top:10,right:50,bottom:20,left:50},_defaultTooltipFormat:function(d,v){return d+": "+v;},render:function(data){var width=120-this.defaultMargin.left-this.defaultMargin.right,height=this.boxHeight-this.defaultMargin.top-this.defaultMargin.bottom;var chart=d3.box().whiskers(this.iqr(1.5)).width(width).height(height);var dataset=[];_.each(data.resultset,function(row){dataset.push(row);});var min=Infinity,max=-Infinity;_.each(dataset,function(row){var aux_min=_.min(row);if(aux_min<min)min=aux_min;var aux_max=_.max(row);if(aux_max>max)max=aux_max;});chart.domain([min,max]);var svg=d3.select("#"+this.htmlObject).selectAll("svg").data(dataset).enter().append("svg").attr("class","box").attr("width",width+this.defaultMargin.left+this.defaultMargin.right).attr("height",height+this.defaultMargin.bottom+this.defaultMargin.top).append("g").attr("transform","translate("+this.defaultMargin.left+","+this.defaultMargin.top+")").call(chart);},iqr:function(k){return function(d,i){var q1=d.quartiles[0],q3=d.quartiles[2],iqr=(q3-q1)*k,i=-1,j=d.length;while(d[++i]<q1-iqr);while(d[--j]>q3+iqr);return[i,j];};}});
var D3Component=D3ComponentBase.extend({defaultWidth:600,defaultHeight:400});
var wd=wd||{};wd.cpk=wd.cpk||{};(function(namespace){function _testFile(url,successCallback,errorCallback){successCallback=successCallback||function(){return true;};errorCallback=errorCallback||function(){return true;};$.ajax({url:url,type:'HEAD',error:errorCallback,success:successCallback});}
namespace.models=namespace.models||{};namespace.views=namespace.views||{};namespace.templates=namespace.templates||{};namespace.models.sparklNewPluginCard=Backbone.Model.extend({defaults:{"pluginId":"newPluginId","actionOpts":[]},fireAction:function(action){this.trigger('action:'+action,this.get('pluginId'));}});namespace.models.sparklPluginCard=Backbone.Model.extend({defaults:{"pluginId":"","plugin_name":"","plugin_description":"","author_name":"","company_name":"","company_url":"","creation_date":"","version":"","CPK_version":"","pluginImage":"","actionOpts":[],"imgSrc":"","backgroundColor":"none"},initialize:function(){var pluginId=this.get('pluginId'),imgSrc=Dashboards.getWebAppPath()+'/pentaho/api/repos/'+pluginId+'/static/system/img/pluginLogo___.png';this.set('imgSrc',imgSrc);},fireAction:function(action){this.trigger('action:'+action,this.get('pluginId'));}});namespace.templates.sparklNewPluginCard=Mustache.compile("   <div class='overlay'></div>"+"  <div class='optionsContainer'></div>"+"  <div class='separator'>"+"   <div class='horizontalRectangle'></div>"+"   <div class='verticalRectangle'></div>"+"  </div>");namespace.templates.sparklPluginCard=Mustache.compile("  <div class=descriptionExpandCont>"+"   <div class='cardHeader'>"+"     <div class='nameContainer'>"+"         <span class='name' title='{{plugin_name}}'>{{plugin_name}}</span>"+"       </div>"+"    <div class='id' title='{{pluginId}}'>{{pluginId}}</div>"+"   </div>"+"   <div class='cardBody'>"+"    <div class='imageContainer'>"+"    </div>"+"    <div class='descriptionContainer'>"+"     <div class='header'>Description</div>"+"     <div class='body'>{{plugin_description}}</div>"+"    </div>"+"   </div>"+"  </div>"+"  <div class='cardFooter'>"+"   <div class='optionsContainer'>"+"   </div>"+"  </div>");namespace.views.sparklNewPluginCard=Backbone.View.extend({template:namespace.templates.sparklNewPluginCard,tagName:'div',className:'sparklNewPluginCardContainer',events:{},initialize:function(){},render:function(ph){var that=this;that.$el.html(that.template(that.model.toJSON()));var $optsContainer=that.$el.find('.optionsContainer');_.each(that.model.get('actionOpts'),function(action,idx){$('<div/>').addClass('optionCont').append($('<span/>').text(action.label).addClass('label')).click(function(){that.model.fireAction(action.id);}).appendTo($optsContainer);});that.$el.addClass('numActions-'+that.model.get('actionOpts').length);this.appendView(ph);},appendView:function(ph){if(ph){this.$ph=$(ph);}
if(this.$ph){this.$ph.append(this.$el);}
return this;}});namespace.views.sparklPluginCard=Backbone.View.extend({template:namespace.templates.sparklPluginCard,tagName:'div',className:'sparklPluginCardContainer',events:{"click .optionsIcon":"toggleOptionsExpanded"},initialize:function(){this.model.on('change:imgSrc',function(v){if(v){this.$el.find('img').show();}});},render:function(ph){var self=this;this.$el.html(this.template(this.model.toJSON()));_.each(this.model.get('actionOpts'),function(action){var $optsContainer=self.$el.find('.optionsContainer');var $opt=$("<div/>").text(action.label).attr('id',action.id).addClass('optionCont').addClass(action.classes||"");$optsContainer.append($opt);$opt.click(function(){self.model.fireAction(action.id);self.toggleOptionsExpanded(false);});});var imgSrc=this.model.get('imgSrc'),$container=this.$el.find('.imageContainer'),successCallback=function(){$('<img/>').attr('src',imgSrc).addClass('image').appendTo($container);},errorCallback=function(){var label=self.model.get('plugin_name')||self.model.get('pluginId')||"";$('<div/>').text(label).addClass('imagePlaceholder').appendTo($container);};$container.css('background-color',self.model.get('backgroundColor'));_testFile(imgSrc,successCallback,errorCallback);this.appendView(ph);},appendView:function(ph){if(ph){this.$ph=$(ph);}
if(this.$ph){this.$ph.append(this.$el);}
var $header=this.$el.find('.cardHeader'),$title=$header.find('.name');if($title.width()>$header.width()){$header.addClass('overflow');}
return this;},detachView:function(){this.$el.detach();return this;},toggleOptionsExpanded:function(predicate){var $ph=this.$el.find('.optsExternCont');var pred=_.isUndefined(predicate)?!$ph.hasClass('expanded'):predicate;$ph.toggleClass('expanded',pred);}});})(wd.cpk);
var SparklPluginCardComponent=(function(){function _getHashCode(str){var hash=0,i,char;if(str.length==0)return hash;for(i=0,l=str.length;i<l;i++){char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash|=0;}
return hash;}
var MyClass=UnmanagedComponent.extend({pluginActions:[{id:"action1",label:"Action 1"},{id:"action2",label:"Action 2"}],newPluginActions:[{id:"newAction1",label:"New Action 1"},{id:"newAction2",label:"New Action 2"}],colorPalette:["#e6b313","#ed5825","#ed2556","#0fb63a","#5825ed"],_models:{},_views:{},_newPluginModel:undefined,_newPluginView:undefined,update:function(){$.extend(this.options,this);this.ph=$("#"+this.htmlObject);var callback=_.bind(this.handleJsonResponse,this);this.clean();this.triggerQuery(this.chartDefinition,callback);},clean:function(){_.each(this._models,function(model){model.destroy();});this._views={};this._models={};},handleJsonResponse:function(json){var myself=this;var plugins=_.map(json.resultset,function(rawPlugin){var plugin={};_.each(rawPlugin,function(value,idx){plugin[json.metadata[idx].colName]=value;plugin.actionOpts=myself.pluginActions;});return plugin;});this.redraw(plugins);},getColor:function(str){var idx=Math.abs(_getHashCode(str))%this.colorPalette.length;return this.colorPalette[idx];},redraw:function(plugins){$('#'+this.htmlObject).empty();var cd=this.chartDefinition;var that=this;var newPlugin={};newPlugin.pluginId=Dashboards.getParameterValue('pluginIdParam');newPlugin.actionOpts=this.newPluginActions;if(!that._newPluginModel){that._newPluginModel=new wd.cpk.models.sparklNewPluginCard(newPlugin);}else{that._newPluginModel.set(newPlugin);}
if(!that._newPluginView){that._newPluginView=new wd.cpk.views.sparklNewPluginCard({model:that._newPluginModel,tagName:'div'});}
that._newPluginView.render('#'+that.htmlObject);that.configureListeners(that._newPluginModel,that.newPluginActions);_.each(plugins,function(pluginOpts){pluginOpts.backgroundColor=that.getColor(pluginOpts.pluginId);if(!that._models[pluginOpts.pluginId]){that._models[pluginOpts.pluginId]=new wd.cpk.models.sparklPluginCard(pluginOpts);}else{that._models[pluginOpts.pluginId].set(pluginOpts);}
if(!that._views[pluginOpts.pluginId]){that._views[pluginOpts.pluginId]=new wd.cpk.views.sparklPluginCard({model:that._models[pluginOpts.pluginId],tagName:'div'});}
that.configureListeners(that._models[pluginOpts.pluginId],that.pluginActions);});_.each(this.getSortedViews(),function(v){v.render('#'+that.htmlObject);});},getSortedViews:function(prop,direction){var viewsArray=_.map(this._views,function(el){return el;});if(prop){viewsArray.sort(function(v1,v2){var s1=v1.model.get(prop).toLowerCase(),s2=v2.model.get(prop).toLowerCase();return(s1<s2)?-1:1;});}
return viewsArray;},sortViews:function(prop,direction){var viewsArray=this.getSortedViews(prop,direction);_.each(viewsArray,function(v){v.detachView().appendView();});},configureListeners:function(model,actions){var myself=this;_.each(actions,function(action){if(action.callback){model.off('action:'+action.id);model.on('action:'+action.id,action.callback,this);}});}});return MyClass;})();
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.olap={getServiceUrl:function(){return"/plugin/pentaho-cdf-dd/api/olap/";},getCubesUrl:function(){return"getCubes";},getCubeStructureUrl:function(){return"getCubeStructure";},getPaginatedLevelMembersUrl:function(){return"getPaginatedLevelMembers";},getLevelMembersStructureUrl:function(){return"getLevelMembersStructure";}}
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.repository={getRsourceUrl:function(){return"res";},getBaseSolutionPluginRoot:function(){return"/public/";},getWidgetsLocation:function(){return"/public/cde/widgets/"}}
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.views={getViewsEndpoint:function(){return"/plugin/pentaho-cdf/api/views";},getSaveViewsEndpoint:function(){return getViewsEndpoint()+"/save";},getDeleteViewsEndpoint:function(){return getViewsEndpoint()+"/delete";},getListViewsEndpoint:function(){return getViewsEndpoint()+"/list";},getUrl:function(solution,file,path,view){var newPath=(solution+path+file).replace(/\//g,':').replace(/\+/g,"%20");return webAppPath+"/api/repos/"+newPath+"/generatedContent?view="+view.replace(/\+/g,"%20");}}
wd=wd||{};wd.helpers=wd.helpers||{};wd.helpers.editor={getUrl:function(){return"/plugin/pentaho-cdf-dd/api/editor/getExternalEditor?";}}